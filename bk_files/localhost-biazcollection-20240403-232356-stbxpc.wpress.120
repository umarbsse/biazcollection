k' ),
					'singular_name'         => esc_html__( 'Testimonial', 'jetpack' ),
					'menu_name'             => esc_html__( 'Testimonials', 'jetpack' ),
					'all_items'             => esc_html__( 'All Testimonials', 'jetpack' ),
					'add_new'               => esc_html__( 'Add New', 'jetpack' ),
					'add_new_item'          => esc_html__( 'Add New Testimonial', 'jetpack' ),
					'edit_item'             => esc_html__( 'Edit Testimonial', 'jetpack' ),
					'new_item'              => esc_html__( 'New Testimonial', 'jetpack' ),
					'view_item'             => esc_html__( 'View Testimonial', 'jetpack' ),
					'search_items'          => esc_html__( 'Search Testimonials', 'jetpack' ),
					'not_found'             => esc_html__( 'No Testimonials found', 'jetpack' ),
					'not_found_in_trash'    => esc_html__( 'No Testimonials found in Trash', 'jetpack' ),
					'filter_items_list'     => esc_html__( 'Filter Testimonials list', 'jetpack' ),
					'items_list_navigation' => esc_html__( 'Testimonial list navigation', 'jetpack' ),
					'items_list'            => esc_html__( 'Testimonials list', 'jetpack' ),
				),
				'supports'        => array(
					'title',
					'editor',
					'thumbnail',
					'page-attributes',
					'revisions',
					'excerpt',
					'newspack_blocks',
				),
				'rewrite'         => array(
					'slug'       => 'testimonial',
					'with_front' => false,
					'feeds'      => false,
					'pages'      => true,
				),
				'public'          => true,
				'show_ui'         => true,
				'menu_position'   => 20, // below Pages
				'menu_icon'       => 'dashicons-testimonial',
				'capability_type' => 'page',
				'map_meta_cap'    => true,
				'has_archive'     => true,
				'query_var'       => 'testimonial',
				'show_in_rest'    => true,
			)
		);
	}

	/**
	 * Update messages for the Testimonial admin.
	 *
	 * @param array $messages Existing post update messages.
	 * @return array Updated `$messages`.
	 */
	public function updated_messages( $messages ) {
		global $post;

		$messages[ self::CUSTOM_POST_TYPE ] = array(
			0  => '', // Unused. Messages start at index 1.
			1  => sprintf(
				/* Translators: link to Testimonial item's page. */
				__( 'Testimonial updated. <a href="%s">View testimonial</a>', 'jetpack' ),
				esc_url( get_permalink( $post->ID ) )
			),
			2  => esc_html__( 'Custom field updated.', 'jetpack' ),
			3  => esc_html__( 'Custom field deleted.', 'jetpack' ),
			4  => esc_html__( 'Testimonial updated.', 'jetpack' ),
			5  => isset( $_GET['revision'] ) // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Copying core message handling.
				? sprintf(
					/* translators: %s: date and time of the revision */
					esc_html__( 'Testimonial restored to revision from %s', 'jetpack' ),
					wp_post_revision_title( (int) $_GET['revision'], false ) // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Copying core message handling.
				)
				: false,
			6  => sprintf(
				/* Translators: link to Testimonial item's page. */
				__( 'Testimonial published. <a href="%s">View testimonial</a>', 'jetpack' ),
				esc_url( get_permalink( $post->ID ) )
			),
			7  => esc_html__( 'Testimonial saved.', 'jetpack' ),
			8  => sprintf(
				/* Translators: link to Testimonial item's page. */
				__( 'Testimonial submitted. <a target="_blank" href="%s">Preview testimonial</a>', 'jetpack' ),
				esc_url( add_query_arg( 'preview', 'true', get_permalink( $post->ID ) ) )
			),
			9  => sprintf(
				/* Translators: 1: Publishing date and time. 2. Link to testimonial's item page. */
				__( 'Testimonial scheduled for: <strong>%1$s</strong>. <a target="_blank" href="%2$s">Preview testimonial</a>', 'jetpack' ),
				// translators: Publish box date format, see https://php.net/date
				date_i18n( __( 'M j, Y @ G:i', 'jetpack' ), strtotime( $post->post_date ) ),
				esc_url( get_permalink( $post->ID ) )
			),
			10 => sprintf(
				/* Translators: link to Testimonial item's page. */
				__( 'Testimonial draft updated. <a target="_blank" href="%s">Preview testimonial</a>', 'jetpack' ),
				esc_url( add_query_arg( 'preview', 'true', get_permalink( $post->ID ) ) )
			),
		);

		return $messages;
	}

	/**
	 * Change ‘Enter Title Here’ text for the Testimonial.
	 *
	 * @param string $title Placeholder text. Default 'Add title'.
	 * @return string Replacement title.
	 */
	public function change_default_title( $title ) {
		if ( self::CUSTOM_POST_TYPE === get_post_type() ) {
			$title = esc_html__( "Enter the customer's name here", 'jetpack' );
		}

		return $title;
	}

	/**
	 * Change ‘Title’ column label on all Testimonials page.
	 *
	 * @param array $columns An array of column names.
	 * @return array Updated array.
	 */
	public function edit_title_column_label( $columns ) {
		$columns['title'] = esc_html__( 'Customer Name', 'jetpack' );

		return $columns;
	}

	/**
	 * Follow CPT reading setting on CPT archive page
	 *
	 * @param WP_Query $query A WP_Query instance.
	 */
	public function query_reading_setting( $query ) {
		if ( ! is_admin()
			&& $query->is_main_query()
			&& $query->is_post_type_archive( self::CUSTOM_POST_TYPE )
		) {
			$query->set( 'posts_per_page', get_option( self::OPTION_READING_SETTING, '10' ) );
		}
	}

	/**
	 * If Infinite Scroll is set to 'click', use our custom reading setting instead of core's `posts_per_page`.
	 *
	 * @param array $settings Array of Infinite Scroll settings.
	 * @return array Updated `$settings`.
	 */
	public function infinite_scroll_click_posts_per_page( $settings ) {
		global $wp_query;

		if ( ! is_admin() && true === $settings['click_handle'] && $wp_query->is_post_type_archive( self::CUSTOM_POST_TYPE ) ) {
			$settings['posts_per_page'] = get_option( self::OPTION_READING_SETTING, $settings['posts_per_page'] ); // phpcs:ignore WordPress.WP.PostsPerPage.posts_per_page_posts_per_page
		}

		return $settings;
	}

	/**
	 * Add CPT to Dotcom sitemap
	 *
	 * @param array $post_types Array of post types included in sitemap.
	 * @return array Updated `$post_types`.
	 */
	public function add_to_sitemap( $post_types ) {
		$post_types[] = self::CUSTOM_POST_TYPE;

		return $post_types;
	}

	/**
	 * Count the number of published testimonials.
	 *
	 * @return int
	 */
	private function count_testimonials() {
		$testimonials = get_transient( 'jetpack-testimonial-count-cache' );

		if ( false === $testimonials ) {
			$testimonials = (int) wp_count_posts( self::CUSTOM_POST_TYPE )->publish;

			if ( ! empty( $testimonials ) ) {
				set_transient( 'jetpack-testimonial-count-cache', $testimonials, 60 * 60 * 12 );
			}
		}

		return $testimonials;
	}

	/**
	 * Adds a submenu link to the Customizer.
	 */
	public function add_customize_page() {
		add_submenu_page(
			'edit.php?post_type=' . self::CUSTOM_POST_TYPE,
			esc_html__( 'Customize Testimonials Archive', 'jetpack' ),
			esc_html__( 'Customize', 'jetpack' ),
			'edit_theme_options',
			add_query_arg(
				array(
					'url'                => rawurlencode( home_url( '/testimonial/' ) ),
					'autofocus[section]' => 'jetpack_testimonials',
				),
				'customize.php'
			)
		);
	}

	/**
	 * Adds testimonial section to the Customizer.
	 *
	 * @param WP_Customize_Manager $wp_customize Customizer instance.
	 */
	public function customize_register( $wp_customize ) {
		jetpack_testimonial_custom_control_classes();

		$wp_customize->add_section(
			'jetpack_testimonials',
			array(
				'title'          => esc_html__( 'Testimonials', 'jetpack' ),
				'theme_supports' => self::CUSTOM_POST_TYPE,
				'priority'       => 130,
			)
		);

		$wp_customize->add_setting(
			'jetpack_testimonials[page-title]',
			array(
				'default'              => esc_html__( 'Testimonials', 'jetpack' ),
				'sanitize_callback'    => array( 'Jetpack_Testimonial_Title_Control', 'sanitize_content' ),
				'sanitize_js_callback' => array( 'Jetpack_Testimonial_Title_Control', 'sanitize_content' ),
			)
		);
		$wp_customize->add_control(
			'jetpack_testimonials[page-title]',
			array(
				'section' => 'jetpack_testimonials',
				'label'   => esc_html__( 'Testimonial Archive Title', 'jetpack' ),
				'type'    => 'text',
			)
		);

		$wp_customize->add_setting(
			'jetpack_testimonials[page-content]',
			array(
				'default'              => '',
				'sanitize_callback'    => array( 'Jetpack_Testimonial_Textarea_Control', 'sanitize_content' ),
				'sanitize_js_callback' => array( 'Jetpack_Testimonial_Textarea_Control', 'sanitize_content' ),
			)
		);
		$wp_customize->add_control(
			new Jetpack_Testimonial_Textarea_Control(
				$wp_customize,
				'jetpack_testimonials[page-content]',
				array(
					'section'  => 'jetpack_testimonials',
					'settings' => 'jetpack_testimonials[page-content]',
					'label'    => esc_html__( 'Testimonial Archive Content', 'jetpack' ),
				)
			)
		);

		$wp_customize->add_setting(
			'jetpack_testimonials[featured-image]',
			array(
				'default'              => '',
				'sanitize_callback'    => 'attachment_url_to_postid',
				'sanitize_js_callback' => 'attachment_url_to_postid',
				'theme_supports'       => 'post-thumbnails',
			)
		);
		$wp_customize->add_control(
			new WP_Customize_Image_Control(
				$wp_customize,
				'jetpack_testimonials[featured-image]',
				array(
					'section' => 'jetpack_testimonials',
					'label'   => esc_html__( 'Testimonial Archive Featured Image', 'jetpack' ),
				)
			)
		);

		// The featured image control doesn't display properly in the Customizer unless we coerce
		// it back into a URL sooner, since that's what WP_Customize_Upload_Control::to_json() expects
		if ( is_admin() ) {
			add_filter( 'theme_mod_jetpack_testimonials', array( $this, 'coerce_testimonial_image_to_url' ) );
		}
	}

	/**
	 * Add Featured image to theme mod if necessary.
	 *
	 * @param array $opt The value of the current theme modification.
	 * @return array Updated `$opt`.
	 */
	public function coerce_testimonial_image_to_url( $opt ) {
		if ( ! $opt || ! is_array( $opt ) ) {
			return $opt;
		}
		if ( ! isset( $opt['featured-image'] ) || ! is_scalar( $opt['featured-image'] ) ) {
			return $opt;
		}
		$url = wp_get_attachment_url( $opt['featured-image'] );
		if ( $url ) {
			$opt['featured-image'] = $url;
		}
		return $opt;
	}

	/**
	 * Our [testimonial] shortcode.
	 * Prints Testimonial data styled to look good on *any* theme.
	 *
	 * @param array $atts Shortcode attributes.
	 *
	 * @return string HTML from `self::jetpack_testimonial_shortcode_html()`.
	 */
	public static function jetpack_testimonial_shortcode( $atts ) {
		// Default attributes.
		$atts = shortcode_atts(
			array(
				'display_content' => true, // Can be false, true, or full.
				'image'           => true,
				'columns'         => 1,
				'showposts'       => -1,
				'order'           => 'asc',
				'orderby'         => 'menu_order,date',
			),
			$atts,
			'testimonial'
		);

		// A little sanitization.
		if (
			$atts['display_content']
			&& 'true' != $atts['display_content'] // phpcs:ignore Universal.Operators.StrictComparisons.LooseNotEqual
			&& 'full' !== $atts['display_content']
		) {
			$atts['display_content'] = false;
		}

		if ( $atts['image'] && 'true' != $atts['image'] ) { // phpcs:ignore Universal.Operators.StrictComparisons.LooseNotEqual
			$atts['image'] = false;
		}

		$atts['columns'] = absint( $atts['columns'] );

		$atts['showposts'] = (int) $atts['showposts'];

		if ( $atts['order'] ) {
			$atts['order'] = urldecode( $atts['order'] );
			$atts['order'] = strtoupper( $atts['order'] );
			if ( 'DESC' !== $atts['order'] ) {
				$atts['order'] = 'ASC';
			}
		}

		if ( $atts['orderby'] ) {
			$atts['orderby'] = urldecode( $atts['orderby'] );
			$atts['orderby'] = strtolower( $atts['orderby'] );
			$allowed_keys    = array( 'author', 'date', 'title', 'menu_order', 'rand' );

			$parsed = array();
			foreach ( explode( ',', $atts['orderby'] ) as $orderby ) {
				if ( ! in_array( $orderby, $allowed_keys, true ) ) {
					continue;
				}
				$parsed[] = $orderby;
			}

			if ( empty( $parsed ) ) {
				unset( $atts['orderby'] );
			} else {
				$atts['orderby'] = implode( ' ', $parsed );
			}
		}

		// enqueue shortcode styles when shortcode is used
		if ( ! wp_style_is( 'jetpack-testimonial-style', 'enqueued' ) ) {
			wp_enqueue_style( 'jetpack-testimonial-style', plugins_url( 'css/testimonial-shortcode.css', __FILE__ ), array(), '20140326' );
		}

		return self::jetpack_testimonial_shortcode_html( $atts );
	}

	/**
	 * The Testimonial shortcode loop.
	 *
	 * @param array $atts Shortcode attributes.
	 *
	 * @return string html
	 */
	private static function jetpack_testimonial_shortcode_html( $atts ) {
		// Default query arguments
		$defaults = array(
			'order'          => $atts['order'],
			'orderby'        => $atts['orderby'],
			'posts_per_page' => $atts['showposts'],
		);

		$args              = wp_parse_args( $atts, $defaults );
		$args['post_type'] = self::CUSTOM_POST_TYPE; // Force this post type
		$query             = new WP_Query( $args );

		$testimonial_index_number = 0;

		ob_start();

		// If we have testimonials, create the html
		if ( $query->have_posts() ) {

			?>
			<div class="jetpack-testimonial-shortcode column-<?php echo esc_attr( $atts['columns'] ); ?>">
				<?php
				// Construct the loop...
				while ( $query->have_posts() ) {
					$query->the_post();
					$post_id = get_the_ID();
					?>
					<div class="testimonial-entry <?php echo esc_attr( self::get_testimonial_class( $testimonial_index_number, $atts['columns'], has_post_thumbnail( $post_id ) ) ); ?>">
						<?php
						// The content
						if ( false !== $atts['display_content'] ) {
							if ( 'full' === $atts['display_content'] ) {
								?>
								<div class="testimonial-entry-content"><?php the_content(); ?></div>
								<?php
							} else {
								?>
								<div class="testimonial-entry-content"><?php the_excerpt(); ?></div>
								<?php
							}
						}
						?>
						<span class="testimonial-entry-title">&#8213; <a href="<?php echo esc_url( get_permalink() ); ?>" title="<?php echo esc_attr( the_title_attribute() ); ?>"><?php the_title(); ?></a></span>
						<?php
						// Featured image
						if ( false !== $atts['image'] ) :
							echo self::get_testimonial_thumbnail_link( $post_id ); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- escaped in method.
						endif;
						?>
					</div><!-- close .testimonial-entry -->
					<?php
					++$testimonial_index_number;
				} // end of while loop

				wp_reset_postdata();
				?>
			</div><!-- close .jetpack-testimonial-shortcode -->
			<?php
		} else {
			?>
			<p><em><?php esc_html_e( 'Your Testimonial Archive currently has no entries. You can start creating them on your dashboard.', 'jetpack' ); ?></p></em>
			<?php
		}
		$html = ob_get_clean();

		// Return the HTML block
		return $html;
	}

	/**
	 * Individual testimonial class
	 *
	 * @param int  $testimonial_index_number iterator count the number of columns up starting from 0.
	 * @param int  $columns number of columns to display the content in.
	 * @param bool $image has a thumbnail or not.
	 *
	 * @return string
	 */
	private static function get_testimonial_class( $testimonial_index_number, $columns, $image ) {
		$class = array();

		$class[] = 'testimonial-entry-column-' . $columns;

		if ( $columns > 1 ) {
			if ( ( $testimonial_index_number % 2 ) === 0 ) {
				$class[] = 'testimonial-entry-mobile-first-item-row';
			} else {
				$class[] = 'testimonial-entry-mobile-last-item-row';
			}
		}

		// add first and last classes to first and last items in a row
		if ( ( $testimonial_index_number % $columns ) === 0 ) {
			$class[] = 'testimonial-entry-first-item-row';
		} elseif ( ( $testimonial_index_number % $columns ) === ( $columns - 1 ) ) {
			$class[] = 'testimonial-entry-last-item-row';
		}

		// add class if testimonial has a featured image
		if ( false !== $image ) {
			$class[] = 'has-testimonial-thumbnail';
		}

		/**
		 * Filter the class applied to testimonial div in the testimonial
		 *
		 * @module custom-content-types
		 *
		 * @since 3.4.0
		 *
		 * @param string $class class name of the div.
		 * @param int $testimonial_index_number iterator count the number of columns up starting from 0.
		 * @param int $columns number of columns to display the content in.
		 * @param boolean $image has a thumbnail or not.
		 */
		return apply_filters( 'testimonial-entry-post-class', implode( ' ', $class ), $testimonial_index_number, $columns, $image ); // phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores
	}

	/**
	 * Display the featured image if it's available
	 *
	 * @param int $post_id Post ID.
	 *
	 * @return string html
	 */
	private static function get_testimonial_thumbnail_link( $post_id ) {
		if ( has_post_thumbnail( $post_id ) ) {
			/**
			 * Change the thumbnail size for the Testimonial CPT.
			 *
			 * @module custom-content-types
			 *
			 * @since 3.4.0
			 *
			 * @param string|array $var Either a registered size keyword or size array.
			 */
			return '<a class="testimonial-featured-image" href="' . esc_url( get_permalink( $post_id ) ) . '">' . get_the_post_thumbnail( $post_id, apply_filters( 'jetpack_testimonial_thumbnail_size', 'thumbnail' ) ) . '</a>';
		}
	}
}

/**
 * Additional Testimonial customizer options.
 */
function jetpack_testimonial_custom_control_classes() {
	/**
	 * Clean the title parameter.
	 */
	class Jetpack_Testimonial_Title_Control extends WP_Customize_Control {
		/**
		 * Sanitize content passed to control.
		 *
		 * @param string $value Control value.
		 * @return string Sanitized value.
		 */
		public static function sanitize_content( $value ) {
			if ( '' != $value ) { // phpcs:ignore Universal.Operators.StrictComparisons.LooseNotEqual
				$value = trim( convert_chars( wptexturize( $value ) ) );
			}

			return $value;
		}
	}

	/**
	 * Clean textarea content.
	 */
	class Jetpack_Testimonial_Textarea_Control extends WP_Customize_Control {
		/**
		 * Control type.
		 *
		 * @var string
		 */
		public $type = 'textarea';

		/**
		 * Render the control's content.
		 */
		public function render_content() {
			?>
			<label>
				<span class="customize-control-title"><?php echo esc_html( $this->label ); ?></span>
				<textarea rows="5" style="width:100%;" <?php $this->link(); ?>><?php echo esc_textarea( $this->value() ); ?></textarea>
			</label>
			<?php
		}

		/**
		 * Sanitize content passed to control.
		 *
		 * @param string $value Control value.
		 * @return string Sanitized value.
		 */
		public static function sanitize_content( $value ) {
			if ( ! empty( $value ) ) {
				/** This filter is already documented in core. wp-includes/post-template.php */
				$value = apply_filters( 'the_content', $value );
			}

			$value = preg_replace( '@<div id="jp-post-flair"([^>]+)?>(.+)?</div>@is', '', $value ); // Strip WPCOM and Jetpack post flair if included in content

			return $value;
		}
	}
}

add_action( 'init', array( 'Jetpack_Testimonial', 'init' ) );

// Check on plugin activation if theme supports CPT
register_activation_hook( __FILE__, array( 'Jetpack_Testimonial', 'activation_post_type_support' ) );
add_action( 'jetpack_activate_module_custom-content-types', array( 'Jetpack_Testimonial', 'activation_post_type_support' ) );
enhanced-distribution.php                                                                                                                                                                                                                                      2461          1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Enhanced Distribution
 * Module Description: Increase reach and traffic.
 * Sort Order: 5
 * First Introduced: 1.2
 * Requires Connection: Yes
 * Auto Activate: Public
 * Module Tags: Writing
 * Feature: Engagement
 * Additional Search Queries: google, seo, firehose, search, broadcast, broadcasting, creator
 *
 * @package automattic/jetpack
 */

/**
 * In case it's active prior to upgrading to '1.9'.
 */
function jetpack_enhanced_distribution_before_activate_default_modules() {
	$old_version         = Jetpack_Options::get_option( 'old_version' );
	list( $old_version ) = explode( ':', $old_version );

	if ( version_compare( $old_version, '1.9-something', '>=' ) ) {
		return;
	}

	Jetpack::check_privacy( __FILE__ );
}

add_action( 'jetpack_before_activate_default_modules', 'jetpack_enhanced_distribution_before_activate_default_modules' );

if ( isset( $_GET['get_freshly_pressed_data'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended
	/**
	 * If a request has ?get_freshly_pressed_data=true appended
	 * to the end, then let's provide the necessary data back via JSON.
	 */
	function jetpack_get_freshly_pressed_data() {
		if ( is_single() ) {
			wp_send_json_success(
				array(
					'blog_id' => Jetpack_Options::get_option( 'id' ),
					'post_id' => get_the_ID(),
				)
			);
		} else {
			wp_send_json_error(
				array(
					'message' => 'Not Singular',
				)
			);
		}
	}
	add_action( 'template_redirect', 'jetpack_get_freshly_pressed_data' );
}

add_action( 'rss_head', 'jetpack_enhanced_distribution_feed_id' );
add_action( 'rss_item', 'jetpack_enhanced_distribution_post_id' );
add_action( 'rss2_head', 'jetpack_enhanced_distribution_feed_id' );
add_action( 'rss2_item', 'jetpack_enhanced_distribution_post_id' );

/**
 * Output feed identifier based on blog ID.
 */
function jetpack_enhanced_distribution_feed_id() {
	$id = (int) Jetpack_Options::get_option( 'id' );
	if ( $id > 0 ) {
		$output = sprintf( '<site xmlns="com-wordpress:feed-additions:1">%d</site>', $id );
		echo $output; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}
}

/**
 * Output feed item identifier based on current post ID.
 */
function jetpack_enhanced_distribution_post_id() {
	$id = (int) get_the_ID();
	if ( $id ) {
		$output = sprintf( '<post-id xmlns="com-wordpress:feed-additions:1">%d</post-id>', $id );
		echo $output; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}
}
class.jetpack-geo-location.php                                                                                                                                                                                                                                 12611         1711191384  plugins/jetpack/modules/geo-location                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName

/**
 * Adds support for geo-location features.
 *
 * All Jetpack sites can support geo-location features.  Users can tag posts with geo-location data
 * using the UI provided by Calypso.  That information will be included in RSS feeds, meta tags during
 * wp_head, and in the Geo microformat following post content.
 *
 * If your theme declares support for "geo-location", you'll also get a small icon and location label
 * visible to users at the bottom of single posts and pages.
 *
 * To declare support in your theme, call `add_theme_support( 'jetpack-geo-location' )`.
 *
 * Once you've added theme support, you can rely on the standard HTML output generated in the
 * the_content_location_display() method of this class.  Or, you can use the "geo_location_display"
 * filter to generate custom HTML for your particular theme.  Your filter function will receive an
 * the default HTML as its first argument and an array containing the geo-location information as
 * its second argument in the following format:
 *
 * array(
 *     'is_public'    => boolean,
 *     'latitude'     => float,
 *     'longitude'    => float,
 *     'label'        => string,
 *     'is_populated' => boolean
 * )
 *
 * Add your filter with:
 *
 * add_filter( 'jetpack_geo_location_display', 'your_filter_function_name', 10, 2);
 */
class Jetpack_Geo_Location {
	/**
	 * Jetpack_Geo_Location singleton instance.
	 *
	 * @var Jetpack_Geo_Location|null
	 */
	private static $instance;

	/**
	 * Whether dashicons are enqueued.
	 *
	 * @since 6.6.0
	 *
	 * @var bool
	 */
	private static $style_enqueued = false;

	/**
	 * Jetpack_Geo_Location instance init.
	 */
	public static function init() {
		if ( self::$instance === null ) {
			self::$instance = new Jetpack_Geo_Location();
		}

		return self::$instance;
	}

	/**
	 * This is mostly just used for testing purposes.
	 */
	public static function reset_instance() {
		self::$instance = null;
	}

	/**
	 * Jetpack_Geo_Location class constructor.
	 */
	public function __construct() {
		add_action( 'init', array( $this, 'wordpress_init' ) );
		add_action( 'wp_head', array( $this, 'wp_head' ) );
		add_filter( 'the_content', array( $this, 'the_content_microformat' ) );

		$this->register_rss_hooks();
	}

	/**
	 * Register support for the geo-location feature on pages and posts.  Register the meta
	 * fields managed by this plugin so that they are properly sanitized during save.
	 */
	public function wordpress_init() {
		// Only render location label after post content, if the theme claims to support "geo-location".
		if ( current_theme_supports( 'jetpack-geo-location' ) ) {
			add_filter( 'the_content', array( $this, 'the_content_location_display' ), 15, 1 );
		}

		add_post_type_support( 'post', 'geo-location' );
		add_post_type_support( 'page', 'geo-location' );

		register_meta(
			'post',
			'geo_public',
			array(
				'sanitize_callback' => array( $this, 'sanitize_public' ),
				'type'              => 'boolean',
				'single'            => true,
			)
		);

		register_meta(
			'post',
			'geo_latitude',
			array(
				'sanitize_callback' => array( $this, 'sanitize_coordinate' ),
				'type'              => 'float',
				'single'            => true,
			)
		);

		register_meta(
			'post',
			'geo_longitude',
			array(
				'sanitize_callback' => array( $this, 'sanitize_coordinate' ),
				'type'              => 'float',
				'single'            => true,
			)
		);

		register_meta(
			'post',
			'geo_address',
			array(
				'sanitize_callback' => 'sanitize_text_field',
				'type'              => 'string',
				'single'            => true,
			)
		);
	}

	/**
	 * Filter "public" input to always be either 1 or 0.
	 *
	 * @param mixed $public Value to normalize.
	 *
	 * @return int
	 */
	public function sanitize_public( $public ) {
		return absint( $public ) ? 1 : 0;
	}

	/**
	 * Filter geo coordinates and normalize them to floats with 7 digits of precision.
	 *
	 * @param mixed $coordinate Latitude or longitude coordinate.
	 *
	 * @return float|null
	 */
	public function sanitize_coordinate( $coordinate ) {
		if ( ! $coordinate ) {
			return null;
		}

		return round( (float) $coordinate, 7 );
	}

	/**
	 * Render geo.position and ICBM meta tags with public geo meta values when rendering
	 * a single post.
	 */
	public function wp_head() {
		if ( ! is_single() ) {
			return;
		}

		$meta_values = $this->get_meta_values( $this->get_post_id() );

		if ( ! $meta_values['is_public'] ) {
			return;
		}

		if ( ! self::$style_enqueued ) {
			// only enqueue scripts and styles when needed.
			self::enqueue_scripts();
			self::$style_enqueued = true;
		}

		echo "\n<!-- Jetpack Geo-location Tags -->\n";

		if ( $meta_values['label'] ) {
			printf(
				'<meta name="geo.placename" content="%s" />',
				esc_attr( $meta_values['label'] )
			);
		}

		printf(
			'<meta name="geo.position" content="%s;%s" />' . PHP_EOL,
			esc_attr( $meta_values['latitude'] ),
			esc_attr( $meta_values['longitude'] )
		);

		printf(
			'<meta name="ICBM" content="%s, %s" />' . PHP_EOL,
			esc_attr( $meta_values['latitude'] ),
			esc_attr( $meta_values['longitude'] )
		);

		echo "\n<!-- End Jetpack Geo-location Tags -->\n";
	}

	/**
	 * Append public meta values in the Geo microformat (https://en.wikipedia.org/wiki/Geo_(microformat)
	 * to the supplied content.
	 *
	 * Note that we cannot render the microformat in the context of an excerpt because tags are stripped
	 * in that context, making our microformat data visible.
	 *
	 * @param string $content Current post content.
	 *
	 * @return string
	 */
	public function the_content_microformat( $content ) {
		if ( is_feed() || $this->is_currently_excerpt_filter() ) {
			return $content;
		}

		$meta_values = $this->get_meta_values( $this->get_post_id() );

		if ( ! $meta_values['is_public'] ) {
			return $content;
		}

		$microformat = sprintf(
			'<div id="geo-post-%d" class="geo geo-post" style="display: none">',
			esc_attr( $this->get_post_id() )
		);

		$microformat .= sprintf(
			'<span class="latitude">%s</span>',
			esc_html( $meta_values['latitude'] )
		);

		$microformat .= sprintf(
			'<span class="longitude">%s</span>',
			esc_html( $meta_values['longitude'] )
		);

		$microformat .= '</div>';

		return $content . $microformat;
	}

	/**
	 * Register a range of hooks for integrating geo data with various feeds.
	 */
	public function register_rss_hooks() {
		add_action( 'rss2_ns', array( $this, 'rss_namespace' ) );
		add_action( 'atom_ns', array( $this, 'rss_namespace' ) );
		add_action( 'rdf_ns', array( $this, 'rss_namespace' ) );
		add_action( 'rss_item', array( $this, 'rss_item' ) );
		add_action( 'rss2_item', array( $this, 'rss_item' ) );
		add_action( 'atom_entry', array( $this, 'rss_item' ) );
		add_action( 'rdf_item', array( $this, 'rss_item' ) );
	}

	/**
	 * Add the georss namespace during RSS generation.
	 */
	public function rss_namespace() {
		echo PHP_EOL . "\t" . 'xmlns:georss="http://www.georss.org/georss"';
		echo PHP_EOL . "\t" . 'xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"';
		echo PHP_EOL . "\t";
	}

	/**
	 * Output georss data for RSS items, assuming we have data for the currently rendered post and
	 * that data as marked as public.
	 */
	public function rss_item() {
		$meta_values = $this->get_meta_values( $this->get_post_id() );

		if ( ! $meta_values['is_public'] ) {
			return;
		}

		printf(
			"\t<georss:point>%s %s</georss:point>\n",
			ent2ncr( esc_html( $meta_values['latitude'] ) ),
			ent2ncr( esc_html( $meta_values['longitude'] ) )
		);

		printf( "\t\t<geo:lat>%s</geo:lat>\n", ent2ncr( esc_html( $meta_values['latitude'] ) ) );
		printf( "\t\t<geo:long>%s</geo:long>\n", ent2ncr( esc_html( $meta_values['longitude'] ) ) );
	}

	/**
	 * Enqueue CSS for rendering post flair with geo-location.
	 */
	private static function enqueue_scripts() {
		wp_enqueue_style( 'dashicons' );
	}

	/**
	 * If we're rendering a single post and public geo-location data is available for it,
	 * include the human-friendly location label in the output.
	 *
	 * @param string $content Current post content.
	 *
	 * @return string
	 */
	public function the_content_location_display( $content ) {
		if ( ! is_single() ) {
			return $content;
		}

		return $content . $this->get_location_label();
	}

	/**
	 * Get the HTML for displaying a label representing the location associated with the
	 * supplied post ID.  If no post ID is given, we'll use the global $post variable, if
	 * it is available.
	 *
	 * @param integer|null $post_id Post ID.
	 *
	 * @return string
	 */
	public function get_location_label( $post_id = null ) {
		$meta_values = $this->get_meta_values( $post_id ? $post_id : $this->get_post_id() );

		if ( ! $meta_values['is_public'] ) {
			return '';
		}

		// If the location has not been labeled, do not show the location.
		if ( ! $meta_values['label'] ) {
			return '';
		}

		$html  = '<div class="post-geo-location-label geo-chip">';
		$html .= '<span class="dashicons dashicons-location" style="vertical-align: text-top;"></span> ';
		$html .= esc_html( $meta_values['label'] );
		$html .= '</div>';

		/**
		 * Allow modification or replacement of the default geo-location display HTML.
		 *
		 * @module geo-location
		 *
		 * @param array $html The default HTML for displaying a geo-location label.
		 * @param array $geo_data An array containing "latitude", "longitude" and "label".
		 */
		$html = apply_filters( 'jetpack_geo_location_display', $html, $meta_values );

		return $html;
	}

	/**
	 * Get the ID of the current global post object, if available.  Otherwise, return null.
	 *
	 * This isolates the access of the global scope to this single method, making it easier to
	 * safeguard against unexpected missing $post objects in other hook functions.
	 *
	 * @return int|null
	 */
	public function get_post_id() {
		global $post;

		if ( ! isset( $post ) || ! $post || ! is_object( $post ) || ! isset( $post->ID ) ) {
			return null;
		}

		return $post->ID;
	}

	/**
	 * Retrieve geo-location post_meta data for the specified post ID.
	 *
	 * This method always returns an array with the following structure:
	 *
	 * array(is_public => bool, latitude => float, longitude => float, label => string, is_populated => bool)
	 *
	 * So, regardless of whether your post actually has values in postmeta for the geo-location fields,
	 * you can be sure that you can reference those array keys in calling code without having to juggle
	 * isset(), array_key_exists(), etc.
	 *
	 * Mocking this method during testing can also be useful for testing output and logic in various
	 * hook functions.
	 *
	 * @param integer $post_id Post ID.
	 *
	 * @return array A predictably structured array representing the meta values for the supplied post ID.
	 */
	public function get_meta_values( $post_id ) {
		$meta_values = array(
			'is_public'    => (bool) $this->sanitize_public( $this->get_meta_value( $post_id, 'public' ) ),
			'latitude'     => $this->sanitize_coordinate( $this->get_meta_value( $post_id, 'latitude' ) ),
			'longitude'    => $this->sanitize_coordinate( $this->get_meta_value( $post_id, 'longitude' ) ),
			'label'        => trim( (string) $this->get_meta_value( $post_id, 'address' ) ),
			'is_populated' => false,
		);

		if ( $meta_values['latitude'] && $meta_values['longitude'] && $meta_values['label'] ) {
			$meta_values['is_populated'] = true;
		}

		return $meta_values;
	}

	/**
	 * This function wraps get_post_meta() to enable us to keep the "geo_" prefix isolated to a single
	 * location in the code and to assist in mocking during testing.
	 *
	 * @param integer $post_id Post ID.
	 * @param string  $meta_field_name The meta field to retrieve.
	 *
	 * @return mixed
	 */
	public function get_meta_value( $post_id, $meta_field_name ) {
		if ( ! $post_id ) {
			return null;
		}

		return get_post_meta( $post_id, 'geo_' . $meta_field_name, true );
	}

	/**
	 * Check to see if the current filter is the get_the_excerpt filter.
	 *
	 * Just checking current_filter() here is not adequate because current_filter() only looks
	 * at the last element in the $wp_current_filter array.  In the context of rendering an
	 * excerpt, however, both get_the_excerpt and the_content are present in that array.
	 *
	 * @return bool
	 */
	public function is_currently_excerpt_filter() {
		if ( ! isset( $GLOBALS['wp_current_filter'] ) ) {
			return false;
		}

		$current_filters = (array) $GLOBALS['wp_current_filter'];

		return in_array( 'get_the_excerpt', $current_filters, true );
	}
}

Jetpack_Geo_Location::init();
geo-location.php                                                                                                                                                                                                                                               2496          1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module: geo-location
 *
 * @package automattic/jetpack
 */

/**
 * Adds support for geo-location features.
 */

require_once __DIR__ . '/geo-location/class.jetpack-geo-location.php';

/**
 * Geo-location shortcode callback for display of location data associated with a post.
 *
 * Usage with current global $post:
 * [geo-location]
 *
 * Usage with specific post ID:
 * [geo-location post=5]
 *
 * @param array $attributes Shortcode attributes.
 */
function jetpack_geo_shortcode( $attributes ) {
	$attributes = shortcode_atts(
		array(
			'post' => null,
			'id'   => null,
		),
		$attributes
	);
	return jetpack_geo_get_location( $attributes['post'] ? $attributes['post'] : $attributes['id'] );
}
add_shortcode( 'geo-location', 'jetpack_geo_shortcode' );

/**
 * Get the geo-location data associated with the supplied post ID, if it's available
 * and marked as being available for public display.  The returned array will contain
 * "latitude", "longitude" and "label" keys.
 *
 * If you do not supply a value for $post_id, the global $post will be used, if
 * available.
 *
 * @param integer|null $post_id Post ID.
 *
 * @return array|null
 */
function jetpack_geo_get_data( $post_id = null ) {
	$geo = Jetpack_Geo_Location::init();

	if ( ! $post_id ) {
		$post_id = $geo->get_post_id();
	}

	$meta_values = $geo->get_meta_values( $post_id );

	if ( ! $meta_values['is_public'] || ! $meta_values['is_populated'] ) {
		return null;
	}

	return array(
		'latitude'  => $meta_values['latitude'],
		'longitude' => $meta_values['longitude'],
		'label'     => $meta_values['label'],
	);
}

/**
 * Display the label HTML for the geo-location information associated with the supplied
 * post ID.
 *
 * If you do not supply a value for $post_id, the global $post will be used, if
 * available.
 *
 * @param integer|null $post_id Post ID.
 *
 * @return void
 */
function jetpack_geo_display_location( $post_id = null ) {
	echo jetpack_geo_get_location( $post_id ); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- Escaped in `Jetpack_Geo_Location::get_location_label`.
}

/**
 * Return the label HTML for the geo-location information associated with the supplied
 * post ID.
 *
 * If you do not supply a value for $post_id, the global $post will be used, if
 * available.
 *
 * @param integer|null $post_id Post ID.
 *
 * @return string
 */
function jetpack_geo_get_location( $post_id = null ) {
	return Jetpack_Geo_Location::init()->get_location_label( $post_id );
}
class-jetpack-google-amp-analytics.php                                                                                                                                                                                                                         4463          1711191384  plugins/jetpack/modules/google-analytics/classes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Add support for Google Analytics e-commerce events for AMP pages.
 *
 * @package automattic/jetpack
 */

/**
 * Bail if accessed directly
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Jetpack_Google_AMP_Analytics class.
 */
class Jetpack_Google_AMP_Analytics {
	/**
	 * Constructor method.
	 */
	public function __construct() {
		$this->maybe_load_hooks();
	}

	/**
	 * Maybe load the hooks.
	 * Checks if its AMP request, if WooCommerce is available, if DNT is disabled, if there's tracking code and if tracking is enabled.
	 */
	public function maybe_load_hooks() {
		if ( ! class_exists( 'Jetpack_AMP_Support' ) || ! Jetpack_AMP_Support::is_amp_request() ) {
			return;
		}

		if ( ! class_exists( 'WooCommerce' ) ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::has_tracking_code() ) {
			return;
		}

		if ( Jetpack_Google_Analytics_Utils::is_dnt_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_add_to_cart_is_enabled() ) {
			return;
		}

		add_action( 'woocommerce_add_to_cart', array( $this, 'amp_add_to_cart' ), 10, 6 );
		add_action( 'woocommerce_thankyou', array( $this, 'amp_after_purchase' ), 10, 1 );
		add_action( 'wp_footer', array( $this, 'amp_send_ga_events' ) );
	}

	/**
	 * Generate a GA event when adding an item to the cart.
	 *
	 * @param string $cart_item_key Cart item key.
	 * @param string $product_id Product ID.
	 * @param int    $quantity Product quantity.
	 * @param int    $variation_id Product variation ID.
	 * @param object $variation Product variation.
	 * @param object $cart_item_data Cart item data.
	 */
	public function amp_add_to_cart( $cart_item_key, $product_id, $quantity, $variation_id, $variation, $cart_item_data ) { // phpcs:ignore VariableAnalysis.CodeAnalysis.VariableAnalysis.UnusedVariable
		$product = wc_get_product( $product_id );
		if ( $product ) {
			$product_sku  = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );
			$product_name = $product->get_name();

			$events   = WC()->session->get( 'wc_ga_events' );
			$events[] = array(
				'type'      => 'add',
				'ga_params' => array(
					'pa'    => 'add',
					'pr1id' => sanitize_text_field( $product_sku ),
					'pr1nm' => sanitize_text_field( $product_name ),
					'pr1qt' => absint( $quantity ),
				),
			);
			WC()->session->set( 'wc_ga_events', $events );
		}
	}

	/**
	 * Generate a GA event when removing an item to the cart.
	 *
	 * @param int $order_id The Order ID.
	 */
	public function amp_after_purchase( $order_id ) {
		$events      = WC()->session->get( 'wc_ga_events' );
		$order       = wc_get_order( $order_id );
		$order_total = $order->get_total();
		$order_tax   = $order->get_total_tax();

		$i     = 1;
		$event = array(
			'type'      => 'purchase',
			'ga_params' => array(
				'pa' => 'purchase',
				'ti' => absint( $order_id ),
				'tr' => (float) $order_total,
				'tt' => (float) $order_tax,
			),
		);
		foreach ( $order->get_items() as $item ) {
			$product = $item->get_product();
			if ( $product ) {
				$event['ga_params'][ 'pr' . $i . 'id' ] = sanitize_text_field( Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product ) );
				$event['ga_params'][ 'pr' . $i . 'nm' ] = sanitize_text_field( $item->get_name() );
				$event['ga_params'][ 'pr' . $i . 'qt' ] = absint( $item->get_quantity() );
				++$i;
			}
		}

		$events[] = $event;
		WC()->session->set( 'wc_ga_events', $events );
	}

	/**
	 * Send the stored events to GA.
	 */
	public function amp_send_ga_events() {
		if ( ! isset( $_SERVER['REQUEST_METHOD'] ) || 'GET' !== strtoupper( $_SERVER['REQUEST_METHOD'] ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized, WordPress.Security.ValidatedSanitizedInput.MissingUnslash -- Simple comparison
			return;
		}

		$events = WC()->session->get( 'wc_ga_events' );
		if ( ! is_array( $events ) ) {
			return;
		}

		foreach ( $events as $event ) {
			?>
			<amp-analytics type='googleanalytics'>
				<script type='application/json'>
				{
					"vars": {
						"account": "<?php echo esc_html( Jetpack_Google_Analytics_Options::get_tracking_code() ); ?>"
					},
					"triggers": {
						"trackPageview": {
							"on": "visible",
							"request": "pageview",
							"extraUrlParams": <?php echo wp_json_encode( $event['ga_params'] ); ?>
						}
					}
				}
				</script>
			</amp-analytics>
			<?php

			array_shift( $events );
		}
		WC()->session->set( 'wc_ga_events', $events );
	}
}
wp-google-analytics-legacy.php                                                                                                                                                                                                                                 11566         1711191384  plugins/jetpack/modules/google-analytics/classes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName

/**
 * Jetpack_Google_Analytics_Legacy hooks and enqueues support for ga.js
 * https://developers.google.com/analytics/devguides/collection/gajs/
 *
 * @author Aaron D. Campbell (original)
 * @author allendav
 */

/**
 * Bail if accessed directly
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Jetpack_Google_Analytics_Legacy hooks and enqueues support for ga.js
 */
class Jetpack_Google_Analytics_Legacy {
	/**
	 * Jetpack_Google_Analytics_Legacy constructor.
	 */
	public function __construct() {
		add_filter( 'jetpack_wga_classic_custom_vars', array( $this, 'jetpack_wga_classic_anonymize_ip' ) );
		add_filter( 'jetpack_wga_classic_custom_vars', array( $this, 'jetpack_wga_classic_track_purchases' ) );
		add_action( 'wp_head', array( $this, 'insert_code' ), 999 );
		add_action( 'wp_footer', array( $this, 'jetpack_wga_classic_track_add_to_cart' ) );
	}

	/**
	 * Used to generate a tracking URL
	 * Called exclusively by insert_code
	 *
	 * @param array $track - Must have ['data'] and ['code'].
	 * @return string - Tracking URL
	 */
	private function get_url( $track ) {
		$site_url = ( is_ssl() ? 'https://' : 'http://' ) . sanitize_text_field( wp_unslash( isset( $_SERVER['HTTP_HOST'] ) ? $_SERVER['HTTP_HOST'] : '' ) );
		foreach ( $track as $k => $value ) {
			if ( strpos( strtolower( $value ), strtolower( $site_url ) ) === 0 ) {
				$track[ $k ] = substr( $track[ $k ], strlen( $site_url ) );
			}
			if ( 'data' === $k ) {
				$track[ $k ] = preg_replace( '/^https?:\/\/|^\/+/i', '', $track[ $k ] );
			}

			// This way we don't lose search data.
			if ( 'data' === $k && 'search' === $track['code'] ) {
				$track[ $k ] = rawurlencode( $track[ $k ] );
			} else {
				$track[ $k ] = preg_replace( '/[^a-z0-9\.\/\+\?=-]+/i', '_', $track[ $k ] );
			}

			$track[ $k ] = trim( $track[ $k ], '_' );
		}
		$char = ( strpos( $track['data'], '?' ) === false ) ? '?' : '&amp;';
		return str_replace( "'", "\'", "/{$track['code']}/{$track['data']}{$char}referer=" . rawurlencode( isset( $_SERVER['HTTP_REFERER'] ) ? esc_url_raw( wp_unslash( $_SERVER['HTTP_REFERER'] ) ) : '' ) );
	}

	/**
	 * This injects the Google Analytics code into the footer of the page.
	 * Called exclusively by wp_head action
	 */
	public function insert_code() {
		$tracking_id = Jetpack_Google_Analytics_Options::get_tracking_code();
		if ( empty( $tracking_id ) ) {
			echo "<!-- Your Google Analytics Plugin is missing the tracking ID -->\r\n";
			return;
		}

		// If we're in the admin_area or DNT is honored and enabled, return without inserting code.
		if (
			is_admin()
			|| Jetpack_Google_Analytics_Utils::is_dnt_enabled()
		) {
			return;
		}

		if ( class_exists( Jetpack_AMP_Support::class ) && Jetpack_AMP_Support::is_amp_request() ) {
			// For Reader mode — legacy.
			add_filter( 'amp_post_template_analytics', 'Jetpack_Google_Analytics::amp_analytics_entries', 1000 );
			// For Standard and Transitional modes.
			add_filter( 'amp_analytics_entries', 'Jetpack_Google_Analytics::amp_analytics_entries', 1000 );
			return;
		}

		if ( str_starts_with( $tracking_id, 'G-' ) ) {
			$this->render_gtag_code( $tracking_id );
		} else {
			$this->render_ga_code( $tracking_id );
		}
	}

	/**
	 * Renders legacy ga.js code.
	 *
	 * @param string $tracking_id Google Analytics measurement ID.
	 */
	private function render_ga_code( $tracking_id ) {
		$custom_vars = array(
			"_gaq.push(['_setAccount', '{$tracking_id}']);",
		);

		$track = array();
		if ( is_404() ) {
			// This is a 404 and we are supposed to track them.
			$custom_vars[] = "_gaq.push(['_trackEvent', '404', document.location.href, document.referrer]);";
		} elseif (
			is_search()
			&& isset( $_REQUEST['s'] ) // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Function renders client-side JS, no site actions.
		) {
			// Set track for searches, if it's a search, and we are supposed to.
			$track['data'] = sanitize_text_field( wp_unslash( $_REQUEST['s'] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Function renders client-side JS, no site actions.
			$track['code'] = 'search';
		}

		if ( ! empty( $track ) ) {
			$track['url'] = $this->get_url( $track );
			// adjust the code that we output, account for both types of tracking.
			$track['url']  = esc_js( str_replace( '&', '&amp;', $track['url'] ) );
			$custom_vars[] = "_gaq.push(['_trackPageview','{$track['url']}']);";
		} else {
			$custom_vars[] = "_gaq.push(['_trackPageview']);";
		}

		/**
		 * Allow for additional elements to be added to the classic Google Analytics queue (_gaq) array
		 *
		 * @since 5.4.0
		 *
		 * @param array $custom_vars Array of classic Google Analytics queue elements
		 */
		$custom_vars = apply_filters( 'jetpack_wga_classic_custom_vars', $custom_vars );

		// Ref: https://developers.google.com/analytics/devguides/collection/gajs/gaTrackingEcommerce#Example
		printf(
			"<!-- Jetpack Google Analytics -->
			<script type='text/javascript'>
				var _gaq = _gaq || [];
				%s
				(function() {
					var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
					ga.src = ('https:' === document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
					var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
				})();
			</script>
			<!-- End Jetpack Google Analytics -->\r\n",
			implode( "\r\n", $custom_vars ) // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- Additional elements added to the classic Google Analytics script.
		);
	}

	/**
	 * Renders new gtag code.
	 *
	 * @param string $tracking_id Google Analytics measurement ID.
	 */
	private function render_gtag_code( $tracking_id ) {
		/**
		 * Allow for additional elements to be added to the Global Site Tags array.
		 *
		 * @since 9.2.0
		 *
		 * @param array $universal_commands Array of gtag function calls.
		 */
		$universal_commands = apply_filters( 'jetpack_gtag_universal_commands', array() );
		$custom_vars        = array();
		if ( is_404() ) {
			$custom_vars[] = array(
				'event',
				'exception',
				array(
					'description' => '404',
					'fatal'       => false,
				),
			);
		}
		// phpcs:disable WordPress.WP.EnqueuedResources.NonEnqueuedScript
		?>
		<!-- Jetpack Google Analytics -->
		<script async src='https://www.googletagmanager.com/gtag/js?id=<?php echo esc_attr( $tracking_id ); ?>'></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() { dataLayer.push( arguments ); }
			gtag( 'js', new Date() );
			gtag( 'config', <?php echo wp_json_encode( $tracking_id ); ?> );
			<?php
			foreach ( $universal_commands as $command ) {
				echo 'gtag( ' . implode( ', ', array_map( 'wp_json_encode', $command ) ) . " );\n";
			}
			foreach ( $custom_vars as $var ) {
				echo 'gtag( ' . implode( ', ', array_map( 'wp_json_encode', $var ) ) . " );\n";
			}
			?>
		</script>
		<!-- End Jetpack Google Analytics -->
		<?php
		// phpcs:enable
	}

	/**
	 * Used to filter in the anonymize IP snippet to the custom vars array for classic analytics
	 * Ref https://developers.google.com/analytics/devguides/collection/gajs/methods/gaJSApi_gat#_gat._anonymizelp
	 *
	 * @param array $custom_vars Custom vars to be filtered.
	 * @return array Possibly updated custom vars.
	 */
	public function jetpack_wga_classic_anonymize_ip( $custom_vars ) {
		if ( Jetpack_Google_Analytics_Options::anonymize_ip_is_enabled() ) {
			array_push( $custom_vars, "_gaq.push(['_gat._anonymizeIp']);" );
		}

		return $custom_vars;
	}

	/**
	 * Used to filter in the order details to the custom vars array for classic analytics
	 *
	 * @param array $custom_vars Custom vars to be filtered.
	 * @return array Possibly updated custom vars.
	 */
	public function jetpack_wga_classic_track_purchases( $custom_vars ) {
		global $wp;

		if ( ! class_exists( 'WooCommerce' ) ) {
			return $custom_vars;
		}

		if ( ! Jetpack_Google_Analytics_Options::has_tracking_code() ) {
			return;
		}

		// Ref: https://developers.google.com/analytics/devguides/collection/gajs/gaTrackingEcommerce#Example
		if ( ! Jetpack_Google_Analytics_Options::track_purchases_is_enabled() ) {
			return $custom_vars;
		}

		$minimum_woocommerce_active = class_exists( 'WooCommerce' ) && version_compare( WC_VERSION, '3.0', '>=' );
		if ( $minimum_woocommerce_active && is_order_received_page() ) {
			$order_id = isset( $wp->query_vars['order-received'] ) ? $wp->query_vars['order-received'] : 0;
			if ( 0 < $order_id && 1 !== (int) get_post_meta( $order_id, '_ga_tracked', true ) ) {
				$order = new WC_Order( $order_id );

				/**
				 * [ '_add_Trans', '123', 'Site Title', '21.00', '1.00', '5.00', 'Snohomish', 'WA', 'USA' ]
				 */
				array_push(
					$custom_vars,
					sprintf(
						'_gaq.push( %s );',
						wp_json_encode(
							array(
								'_addTrans',
								(string) $order->get_order_number(),
								get_bloginfo( 'name' ),
								(string) $order->get_total(),
								(string) $order->get_total_tax(),
								(string) $order->get_total_shipping(),
								(string) $order->get_billing_city(),
								(string) $order->get_billing_state(),
								(string) $order->get_billing_country(),
							)
						)
					)
				);

				// Order items
				if ( $order->get_items() ) {
					foreach ( $order->get_items() as $item ) {
						$product           = $order->get_product_from_item( $item );
						$product_sku_or_id = $product->get_sku() ? $product->get_sku() : $product->get_id();

						array_push(
							$custom_vars,
							sprintf(
								'_gaq.push( %s );',
								wp_json_encode(
									array(
										'_addItem',
										(string) $order->get_order_number(),
										(string) $product_sku_or_id,
										$item['name'],
										Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
										(string) $order->get_item_total( $item ),
										(string) $item['qty'],
									)
								)
							)
						);
					}
				} // get_items

				// Mark the order as tracked
				update_post_meta( $order_id, '_ga_tracked', 1 );
				array_push( $custom_vars, "_gaq.push(['_trackTrans']);" );
			} // order not yet tracked
		} // is order received page

		return $custom_vars;
	}

	/**
	 * Used to add footer javascript to track user clicking on add-to-cart buttons
	 * on single views (.single_add_to_cart_button) and list views (.add_to_cart_button)
	 */
	public function jetpack_wga_classic_track_add_to_cart() {
		if ( ! class_exists( 'WooCommerce' ) ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::has_tracking_code() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_add_to_cart_is_enabled() ) {
			return;
		}

		if ( is_product() ) { // product page
			global $product;
			$product_sku_or_id = $product->get_sku() ? $product->get_sku() : '#' . $product->get_id();
			wc_enqueue_js(
				"$( '.single_add_to_cart_button' ).click( function() {
					_gaq.push(['_trackEvent', 'Products', 'Add to Cart', '#" . esc_js( $product_sku_or_id ) . "']);
				} );"
			);
		} elseif ( is_woocommerce() ) { // any other page that uses templates (like product lists, archives, etc)
			wc_enqueue_js(
				"$( '.add_to_cart_button:not(.product_type_variable, .product_type_grouped)' ).click( function() {
					var label = $( this ).data( 'product_sku' ) ? $( this ).data( 'product_sku' ) : '#' + $( this ).data( 'product_id' );
					_gaq.push(['_trackEvent', 'Products', 'Add to Cart', label]);
				} );"
			);
		}
	}
}
wp-google-analytics-options.php                                                                                                                                                                                                                                3341          1711191384  plugins/jetpack/modules/google-analytics/classes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileNames
/**
 * Jetpack_Google_Analytics_Options provides a single interface to module options
 *
 * @author allendav
 */

/**
 * Bail if accessed directly
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Jetpack_Google_Analytics_Options main class.
 */
class Jetpack_Google_Analytics_Options {
	/**
	 * Get the Google Analytics tracking ID.
	 *
	 * @param string $option_name Nested 'jetpack_wga' option value to retrieve.
	 * @param mixed  $default Default value if $option is not set.
	 * @return mixed Option value or `$default`.
	 */
	public static function get_option( $option_name, $default = false ) {
		$o = get_option( 'jetpack_wga' );
		return isset( $o[ $option_name ] ) ? $o[ $option_name ] : $default;
	}

	/**
	 * Get the analytics tracking code.
	 *
	 * @return string
	 */
	public static function get_tracking_code() {
		return self::get_option( 'code', '' );
	}

	/**
	 * Check if the tracking code is set.
	 *
	 * @return bool
	 */
	public static function has_tracking_code() {
		$code = self::get_tracking_code();
		return ! empty( $code );
	}

	/**
	 * Get the 'anonymize_ip' option used by both legacy and universal analytics.
	 *
	 * @return bool
	 */
	public static function anonymize_ip_is_enabled() {
		return (bool) self::get_option( 'anonymize_ip' );
	}

	/**
	 * Get the 'honor_dnt' option used by both legacy and universal analytics.
	 *
	 * @return bool
	 */
	public static function honor_dnt_is_enabled() {
		return (bool) static::get_option( 'honor_dnt' );
	}

	/**
	 * Get the 'ec_track_purchases' eCommerce option used by both legacy and universal analytics
	 *
	 * @return bool
	 */
	public static function track_purchases_is_enabled() {
		return (bool) self::get_option( 'ec_track_purchases' );
	}

	/**
	 * Get the 'ec_track_add_to_cart' analytics option.
	 *
	 * @return bool
	 */
	public static function track_add_to_cart_is_enabled() {
		return (bool) self::get_option( 'ec_track_add_to_cart' );
	}

	/**
	 * Get the 'enh_ec_tracking' analytics option.
	 *
	 * @return bool
	 */
	public static function enhanced_ecommerce_tracking_is_enabled() {
		return (bool) self::get_option( 'enh_ec_tracking' );
	}

	/**
	 * Get the 'enh_ec_track_remove_from_cart' analytics option.
	 *
	 * @return bool
	 */
	public static function track_remove_from_cart_is_enabled() {
		return (bool) self::get_option( 'enh_ec_track_remove_from_cart' );
	}

	/**
	 * Get the 'enh_ec_track_prod_impression' analytics option.
	 *
	 * @return bool
	 */
	public static function track_product_impressions_is_enabled() {
		return (bool) self::get_option( 'enh_ec_track_prod_impression' );
	}

	/**
	 * Get the 'enh_ec_track_prod_click' analytics option.
	 *
	 * @return bool
	 */
	public static function track_product_clicks_is_enabled() {
		return (bool) self::get_option( 'enh_ec_track_prod_click' );
	}

	/**
	 * Get the 'enh_ec_track_prod_detail_view' analytics option.
	 *
	 * @return bool
	 */
	public static function track_product_detail_view_is_enabled() {
		return (bool) self::get_option( 'enh_ec_track_prod_detail_view' );
	}

	/**
	 * Get the 'enh_ec_track_checkout_started' analytics option.
	 *
	 * @return bool
	 */
	public static function track_checkout_started_is_enabled() {
		return (bool) self::get_option( 'enh_ec_track_checkout_started' );
	}
}
wp-google-analytics-universal.php                                                                                                                                                                                                                              18162         1711191384  plugins/jetpack/modules/google-analytics/classes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * Jetpack_Google_Analytics_Universal hooks and and enqueues support for analytics.js
 * https://developers.google.com/analytics/devguides/collection/analyticsjs/
 * https://developers.google.com/analytics/devguides/collection/analyticsjs/enhanced-ecommerce
 *
 * @author allendav
 */

/**
 * Bail if accessed directly
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Jetpack_Google_Analytics_Universal main class.
 */
class Jetpack_Google_Analytics_Universal {
	/**
	 * Jetpack_Google_Analytics_Universal constructor.
	 */
	public function __construct() {
		add_filter( 'jetpack_wga_universal_commands', array( $this, 'maybe_anonymize_ip' ) );
		add_filter( 'jetpack_wga_universal_commands', array( $this, 'maybe_track_purchases' ) );

		add_action( 'wp_head', array( $this, 'wp_head' ), 999999 );

		add_action( 'woocommerce_after_add_to_cart_button', array( $this, 'add_to_cart' ) );
		add_action( 'wp_footer', array( $this, 'loop_add_to_cart' ) );
		add_action( 'woocommerce_after_cart', array( $this, 'remove_from_cart' ) );
		add_action( 'woocommerce_after_mini_cart', array( $this, 'remove_from_cart' ) );
		add_filter( 'woocommerce_cart_item_remove_link', array( $this, 'remove_from_cart_attributes' ), 10, 2 );
		add_action( 'woocommerce_after_shop_loop_item', array( $this, 'listing_impression' ) );
		add_action( 'woocommerce_after_shop_loop_item', array( $this, 'listing_click' ) );
		add_action( 'woocommerce_after_single_product', array( $this, 'product_detail' ) );
		add_action( 'woocommerce_after_checkout_form', array( $this, 'checkout_process' ) );

		// we need to send a pageview command last - so we use priority 24 to add
		// this command's JavaScript just before wc_print_js is called (pri 25)
		add_action( 'wp_footer', array( $this, 'send_pageview_in_footer' ), 24 );
	}

	/**
	 * Hook for the `wp_head` action to output the analytics code.
	 */
	public function wp_head() {
		$tracking_code = Jetpack_Google_Analytics_Options::get_tracking_code();
		if ( empty( $tracking_code ) ) {
			echo "<!-- No tracking ID configured for Jetpack Google Analytics -->\r\n";
			return;
		}

		// If we're in the admin_area or DNT is honored and enabled, return without inserting code.
		if (
			is_admin()
			|| Jetpack_Google_Analytics_Utils::is_dnt_enabled()
		) {
			return;
		}

		if ( class_exists( Jetpack_AMP_Support::class ) && Jetpack_AMP_Support::is_amp_request() ) {
			// For Reader mode — legacy.
			add_filter( 'amp_post_template_analytics', 'Jetpack_Google_Analytics::amp_analytics_entries', 1000 );
			// For Standard and Transitional modes.
			add_filter( 'amp_analytics_entries', 'Jetpack_Google_Analytics::amp_analytics_entries', 1000 );
			return;
		}

		/**
		 * Allow for additional elements to be added to the universal Google Analytics queue (ga) array
		 *
		 * @since 5.6.0
		 *
		 * @param array $custom_vars Array of universal Google Analytics queue elements
		 */
		$universal_commands = apply_filters( 'jetpack_wga_universal_commands', array() );

		// phpcs:disable WordPress.WP.EnqueuedResources.NonEnqueuedScript -- Script is added to wp_head.
		$async_code = "
			<!-- Jetpack Google Analytics -->
			<script>
				window.ga = window.ga || function(){ ( ga.q = ga.q || [] ).push( arguments ) }; ga.l=+new Date;
				ga( 'create', '%tracking_id%', 'auto' );
				ga( 'require', 'ec' );
				%universal_commands%
			</script>
			<script async src='https://www.google-analytics.com/analytics.js'></script>
			<!-- End Jetpack Google Analytics -->
		"; // phpcs:enable WordPress.WP.EnqueuedResources.NonEnqueuedScript
		$async_code = str_replace( '%tracking_id%', $tracking_code, $async_code );

		$universal_commands_string = implode( "\r\n", $universal_commands );
		$async_code                = str_replace( '%universal_commands%', $universal_commands_string, $async_code );

		echo "$async_code\r\n"; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * Check if the 'anonymize_ip' option should be added to the universal Google Analytics queue (ga) commands.
	 *
	 * @param array $command_array Array of commands.
	 * @return array `$command_array` with the additional command conditionally added.
	 */
	public function maybe_anonymize_ip( $command_array ) {
		if ( Jetpack_Google_Analytics_Options::anonymize_ip_is_enabled() ) {
			array_push( $command_array, "ga( 'set', 'anonymizeIp', true );" );
		}

		return $command_array;
	}

	/**
	 * Process purchase tracking options for the universal Google Analytics queue (ga) commands.
	 *
	 * May also update post meta to indicate the order has been tracked.
	 *
	 * @param array $command_array Array of commands.
	 * @return array `$command_array` with additional commands conditionally added.
	 */
	public function maybe_track_purchases( $command_array ) {
		global $wp;

		if ( ! Jetpack_Google_Analytics_Options::track_purchases_is_enabled() ) {
			return $command_array;
		}

		if ( ! class_exists( 'WooCommerce' ) ) {
			return $command_array;
		}

		$minimum_woocommerce_active = class_exists( 'WooCommerce' ) && version_compare( WC_VERSION, '3.0', '>=' );
		if ( ! $minimum_woocommerce_active ) {
			return $command_array;
		}

		if ( ! is_order_received_page() ) {
			return $command_array;
		}

		$order_id = isset( $wp->query_vars['order-received'] ) ? $wp->query_vars['order-received'] : 0;
		if ( 0 === (int) $order_id ) {
			return $command_array;
		}

		$hpos_enabled =
			class_exists( 'Automattic\WooCommerce\Utilities\OrderUtil' )
			&& \Automattic\WooCommerce\Utilities\OrderUtil::custom_orders_table_usage_is_enabled();
		if ( $hpos_enabled ) {
			return $this->maybe_track_hpos_purchases( $command_array );
		}

		// A 1 indicates we've already tracked this order - don't do it again
		if ( 1 === (int) get_post_meta( $order_id, '_ga_tracked', true ) ) {
			return $command_array;
		}

		$order          = new WC_Order( $order_id );
		$order_currency = $order->get_currency();
		$command        = "ga( 'set', '&cu', '" . esc_js( $order_currency ) . "' );";
		array_push( $command_array, $command );

		// Order items
		if ( $order->get_items() ) {
			foreach ( $order->get_items() as $item ) {
				$product           = $order->get_product_from_item( $item );
				$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

				$item_details = array(
					'id'       => $product_sku_or_id,
					'name'     => $item['name'],
					'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
					'price'    => $order->get_item_total( $item ),
					'quantity' => $item['qty'],
				);
				$command      = "ga( 'ec:addProduct', " . wp_json_encode( $item_details ) . ' );';
				array_push( $command_array, $command );
			}
		}

		// Order summary
		$summary = array(
			'id'          => $order->get_order_number(),
			'affiliation' => get_bloginfo( 'name' ),
			'revenue'     => $order->get_total(),
			'tax'         => $order->get_total_tax(),
			'shipping'    => $order->get_total_shipping(),
		);
		$command = "ga( 'ec:setAction', 'purchase', " . wp_json_encode( $summary ) . ' );';
		array_push( $command_array, $command );

		update_post_meta( $order_id, '_ga_tracked', 1 );

		return $command_array;
	}

	/**
	 * Process purchase tracking options for the universal Google Analytics queue (ga) commands.
	 *
	 * May also update post meta to indicate the order has been tracked.
	 *
	 * This method is different from maybe_track_purchases in HPOS support.
	 *
	 * @see https://github.com/woocommerce/woocommerce/wiki/High-Performance-Order-Storage-Upgrade-Recipe-Book
	 *
	 * @since 13.1
	 * @param array $command_array Array of commands.
	 * @return array `$command_array` with additional commands conditionally added.
	 */
	public function maybe_track_hpos_purchases( $command_array ) {
		global $wp;

		$order_id = isset( $wp->query_vars['order-received'] ) ? $wp->query_vars['order-received'] : 0;
		if ( 0 === (int) $order_id ) {
			return $command_array;
		}
		$order = wc_get_order( $order_id );

		if ( false === $order ) {
			return $command_array;
		}

		// A 1 indicates we've already tracked this order - don't do it again
		if ( 1 === (int) $order->get_meta( '_ga_tracked', true ) ) {
			return $command_array;
		}

		$order_currency = $order->get_currency();
		$command        = "ga( 'set', '&cu', '" . esc_js( $order_currency ) . "' );";
		array_push( $command_array, $command );

		// Order items
		if ( $order->get_items() ) {
			foreach ( $order->get_items() as $item ) {
				$product           = $order->get_product_from_item( $item );
				$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

				$item_details = array(
					'id'       => $product_sku_or_id,
					'name'     => $item['name'],
					'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
					'price'    => $order->get_item_total( $item ),
					'quantity' => $item['qty'],
				);
				$command      = "ga( 'ec:addProduct', " . wp_json_encode( $item_details ) . ' );';
				array_push( $command_array, $command );
			}
		}

		// Order summary
		$summary = array(
			'id'          => $order->get_order_number(),
			'affiliation' => get_bloginfo( 'name' ),
			'revenue'     => $order->get_total(),
			'tax'         => $order->get_total_tax(),
			'shipping'    => $order->get_shipping_total(),
		);
		$command = "ga( 'ec:setAction', 'purchase', " . wp_json_encode( $summary ) . ' );';
		array_push( $command_array, $command );

		$order->update_meta_data( '_ga_tracked', 1 );
		$order->save();

		return $command_array;
	}

	/**
	 * Enqueue add-to-cart click tracking script, if enabled.
	 */
	public function add_to_cart() {
		if ( ! Jetpack_Google_Analytics_Options::track_add_to_cart_is_enabled() ) {
			return;
		}

		if ( ! is_single() ) {
			return;
		}

		global $product;

		$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );
		$selector          = '.single_add_to_cart_button';

		wc_enqueue_js(
			"$( '" . esc_js( $selector ) . "' ).click( function() {
				var productDetails = {
					'id': '" . esc_js( $product_sku_or_id ) . "',
					'name' : '" . esc_js( $product->get_title() ) . "',
					'quantity': $( 'input.qty' ).val() ? $( 'input.qty' ).val() : '1',
				};
				ga( 'ec:addProduct', productDetails );
				ga( 'ec:setAction', 'add' );
				ga( 'send', 'event', 'UX', 'click', 'add to cart' );
			} );"
		);
	}

	/**
	 * Enqueue add-to-cart click tracking script for looped product views, if enabled.
	 */
	public function loop_add_to_cart() {
		if ( ! Jetpack_Google_Analytics_Options::track_add_to_cart_is_enabled() ) {
			return;
		}

		if ( ! class_exists( 'WooCommerce' ) ) {
			return;
		}

		$minimum_woocommerce_active = class_exists( 'WooCommerce' ) && version_compare( WC_VERSION, '3.0', '>=' );
		if ( ! $minimum_woocommerce_active ) {
			return;
		}

		$selector = '.add_to_cart_button:not(.product_type_variable, .product_type_grouped)';

		wc_enqueue_js(
			"$( '" . esc_js( $selector ) . "' ).click( function() {
				var productSku = $( this ).data( 'product_sku' );
				var productID = $( this ).data( 'product_id' );
				var productDetails = {
					'id': productSku ? productSku : '#' + productID,
					'quantity': $( this ).data( 'quantity' ),
				};
				ga( 'ec:addProduct', productDetails );
				ga( 'ec:setAction', 'add' );
				ga( 'send', 'event', 'UX', 'click', 'add to cart' );
			} );"
		);
	}

	/**
	 * Enqueue remove-from-cart click tracking script, if enabled.
	 */
	public function remove_from_cart() {
		if ( ! Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_remove_from_cart_is_enabled() ) {
			return;
		}

		// We listen at div.woocommerce because the cart 'form' contents get forcibly
		// updated and subsequent removals from cart would then not have this click
		// handler attached
		wc_enqueue_js(
			"$( 'div.woocommerce' ).on( 'click', 'a.remove', function() {
				var productSku = $( this ).data( 'product_sku' );
				var productID = $( this ).data( 'product_id' );
				var quantity = $( this ).parent().parent().find( '.qty' ).val()
				var productDetails = {
					'id': productSku ? productSku : '#' + productID,
					'quantity': quantity ? quantity : '1',
				};
				ga( 'ec:addProduct', productDetails );
				ga( 'ec:setAction', 'remove' );
				ga( 'send', 'event', 'UX', 'click', 'remove from cart' );
			} );"
		);
	}

	/**
	 * Adds the product ID and SKU to the remove product link (for use by remove_from_cart above) if not present
	 *
	 * @param string $url Full HTML a tag of the link to remove an item from the cart.
	 * @param string $key Unique Key ID for a cart item.
	 */
	public function remove_from_cart_attributes( $url, $key ) {
		if ( str_contains( $url, 'data-product_id' ) ) {
			return $url;
		}

		$item    = WC()->cart->get_cart_item( $key );
		$product = $item['data'];

		$new_attributes = sprintf(
			'" data-product_id="%1$s" data-product_sku="%2$s">',
			esc_attr( $product->get_id() ),
			esc_attr( $product->get_sku() )
		);

		$url = str_replace( '">', $new_attributes, $url );
		return $url;
	}

	/**
	 * Enqueue listing impression tracking script, if enabled.
	 */
	public function listing_impression() {
		if ( ! Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_product_impressions_is_enabled() ) {
			return;
		}

		if ( isset( $_GET['s'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- No site actions, just GA options being set.
			$list = 'Search Results';
		} else {
			$list = 'Product List';
		}

		global $product, $woocommerce_loop;
		$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

		$item_details = array(
			'id'       => $product_sku_or_id,
			'name'     => $product->get_title(),
			'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
			'list'     => $list,
			'position' => $woocommerce_loop['loop'],
		);
		wc_enqueue_js( "ga( 'ec:addImpression', " . wp_json_encode( $item_details ) . ' );' );
	}

	/**
	 * Enqueue listing click tracking script, if enabled.
	 */
	public function listing_click() {
		if ( ! Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_product_clicks_is_enabled() ) {
			return;
		}

		if ( isset( $_GET['s'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- No site actions, just GA options being set.
			$list = 'Search Results';
		} else {
			$list = 'Product List';
		}

		global $product, $woocommerce_loop;
		$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

		$selector = '.products .post-' . esc_js( $product->get_id() ) . ' a';

		$item_details = array(
			'id'       => $product_sku_or_id,
			'name'     => $product->get_title(),
			'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
			'position' => $woocommerce_loop['loop'],
		);

		wc_enqueue_js(
			"$( '" . esc_js( $selector ) . "' ).click( function() {
				if ( true === $( this ).hasClass( 'add_to_cart_button' ) ) {
					return;
				}

				ga( 'ec:addProduct', " . wp_json_encode( $item_details ) . " );
				ga( 'ec:setAction', 'click', { list: '" . esc_js( $list ) . "' } );
				ga( 'send', 'event', 'UX', 'click', { list: '" . esc_js( $list ) . "' } );
			} );"
		);
	}

	/**
	 * Enqueue product detail view tracking script, if enabled.
	 */
	public function product_detail() {
		if ( ! Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_product_detail_view_is_enabled() ) {
			return;
		}

		global $product;
		$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

		$item_details = array(
			'id'       => $product_sku_or_id,
			'name'     => $product->get_title(),
			'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
			'price'    => $product->get_price(),
		);
		wc_enqueue_js(
			"ga( 'ec:addProduct', " . wp_json_encode( $item_details ) . ' );' .
			"ga( 'ec:setAction', 'detail' );"
		);
	}

	/**
	 * Enqueue post-checkout tracking script, if enabled.
	 */
	public function checkout_process() {
		if ( ! Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			return;
		}

		if ( ! Jetpack_Google_Analytics_Options::track_checkout_started_is_enabled() ) {
			return;
		}

		$universal_commands = array();
		$cart               = WC()->cart->get_cart();

		foreach ( $cart as $cart_item_key => $cart_item ) {
			/**
			* This filter is already documented in woocommerce/templates/cart/cart.php
			*/
			$product           = apply_filters( 'woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key );
			$product_sku_or_id = Jetpack_Google_Analytics_Utils::get_product_sku_or_id( $product );

			$item_details = array(
				'id'       => $product_sku_or_id,
				'name'     => $product->get_title(),
				'category' => Jetpack_Google_Analytics_Utils::get_product_categories_concatenated( $product ),
				'price'    => $product->get_price(),
				'quantity' => $cart_item['quantity'],
			);

			array_push( $universal_commands, "ga( 'ec:addProduct', " . wp_json_encode( $item_details ) . ' );' );
		}

		array_push( $universal_commands, "ga( 'ec:setAction','checkout' );" );

		wc_enqueue_js( implode( "\r\n", $universal_commands ) );
	}

	/**
	 * Enqueue pageview event in footer of all pages.
	 *
	 * Action hook added with later priority to come after all of the above tracking.
	 */
	public function send_pageview_in_footer() {
		if ( ! Jetpack_Google_Analytics_Options::has_tracking_code() ) {
			return;
		}

		if ( is_admin() ) {
			return;
		}

		if ( ! class_exists( 'WooCommerce' ) ) {
			return;
		}

		wc_enqueue_js( "ga( 'send', 'pageview' );" );
	}
}
wp-google-analytics-utils.php                                                                                                                                                                                                                                  2337          1711191384  plugins/jetpack/modules/google-analytics/classes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * Jetpack_Google_Analytics_Options provides a single interface to module options
 *
 * @author allendav
 */

/**
 * Bail if accessed directly
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Jetpack_Google_Analytics_Utils main class.
 */
class Jetpack_Google_Analytics_Utils {
	/**
	 * Gets product categories or varation attributes as a formatted concatenated string
	 *
	 * @param WC_Product $product Product to get categories/variations for.
	 * @return string
	 */
	public static function get_product_categories_concatenated( $product ) {
		if ( ! class_exists( 'WooCommerce' ) ) {
			return '';
		}

		if ( ! $product ) {
			return '';
		}

		$variation_data = $product->is_type( 'variation' ) ? wc_get_product_variation_attributes( $product->get_id() ) : '';
		if ( is_array( $variation_data ) && ! empty( $variation_data ) ) {
			$line = wc_get_formatted_variation( $variation_data, true );
		} else {
			$out        = array();
			$categories = get_the_terms( $product->get_id(), 'product_cat' );
			if ( $categories ) {
				foreach ( $categories as $category ) {
					$out[] = $category->name;
				}
			}
			$line = implode( '/', $out );
		}
		return $line;
	}

	/**
	 * Gets a product's SKU with fallback to just ID. IDs are prepended with a hash symbol.
	 *
	 * @param WC_Product $product Product to get SKU/ID for.
	 * @return string
	 */
	public static function get_product_sku_or_id( $product ) {
		if ( ! class_exists( 'WooCommerce' ) ) {
			return '';
		}

		if ( ! $product ) {
			return '';
		}

		return $product->get_sku() ? $product->get_sku() : '#' . $product->get_id();
	}

	/**
	 * Checks if filter is set and dnt is enabled.
	 *
	 * @return bool
	 */
	public static function is_dnt_enabled() {
		/**
		 * Filter the option which decides honor DNT or not.
		 *
		 * @module google-analytics
		 * @since 11.3
		 *
		 * @param bool $honor_dnt Honors DNT for clients who don't want to be tracked. Set to true to enable.
		 */
		if ( false === apply_filters( 'jetpack_honor_dnt_header_for_wga', Jetpack_Google_Analytics_Options::honor_dnt_is_enabled() ) ) {
			return false;
		}

		foreach ( $_SERVER as $name => $value ) {
			if ( 'http_dnt' === strtolower( $name ) && 1 === (int) $value ) {
				return true;
			}
		}

		return false;
	}
}
wp-google-analytics.php                                                                                                                                                                                                                                        4381          1711191384  plugins/jetpack/modules/google-analytics                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName

/*
	Copyright 2006 Aaron D. Campbell (email : wp_plugins@xavisys.com)

	This program is free software; you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation; either version 2 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

require_once __DIR__ . '/classes/wp-google-analytics-utils.php';
require_once __DIR__ . '/classes/wp-google-analytics-options.php';
require_once __DIR__ . '/classes/wp-google-analytics-legacy.php';
require_once __DIR__ . '/classes/wp-google-analytics-universal.php';
require_once __DIR__ . '/classes/class-jetpack-google-amp-analytics.php';

/**
 * Jetpack_Google_Analytics is the class that handles ALL of the plugin functionality.
 * It helps us avoid name collisions
 * https://codex.wordpress.org/Writing_a_Plugin#Avoiding_Function_Name_Collisions
 */
class Jetpack_Google_Analytics {

	/**
	 * Jetpack_Google_Analytics singleton instance.
	 *
	 * @var Jetpack_Google_Analytics
	 */
	public static $instance = false;

	/**
	 * Property to hold concrete analytics implementation that does the work (universal or legacy).
	 *
	 * @var Static
	 */
	public static $analytics = false;

	/**
	 * This is our constructor, which is private to force the use of get_instance()
	 *
	 * @return void
	 */
	private function __construct() {
		// At this time, we only leverage universal analytics when enhanced ecommerce is selected and WooCommerce is active.
		// Otherwise, don't bother emitting the tracking ID or fetching analytics.js
		if ( class_exists( 'WooCommerce' ) && Jetpack_Google_Analytics_Options::enhanced_ecommerce_tracking_is_enabled() ) {
			self::$analytics = new Jetpack_Google_Analytics_Universal();
			new Jetpack_Google_AMP_Analytics();
		} else {
			self::$analytics = new Jetpack_Google_Analytics_Legacy();
		}
	}

	/**
	 * Function to instantiate our class and make it a singleton
	 */
	public static function get_instance() {
		if ( ! self::$instance ) {
			self::$instance = new self();
		}

		return self::$instance;
	}

	/**
	 * Add amp-analytics tags.
	 *
	 * @param array $analytics_entries An associative array of the analytics entries.
	 *
	 * @return array
	 */
	public static function amp_analytics_entries( $analytics_entries ) {
		if ( ! is_array( $analytics_entries ) ) {
			$analytics_entries = array();
		}

		$amp_tracking_codes = static::get_amp_tracking_codes( $analytics_entries );
		$jetpack_account    = Jetpack_Google_Analytics_Options::get_tracking_code();

		// Bypass tracking codes already set on AMP plugin.
		if ( in_array( $jetpack_account, $amp_tracking_codes, true ) ) {
			return $analytics_entries;
		}

		$config_data = wp_json_encode(
			array(
				'vars'     => array(
					'account' => Jetpack_Google_Analytics_Options::get_tracking_code(),
				),
				'triggers' => array(
					'trackPageview' => array(
						'on'      => 'visible',
						'request' => 'pageview',
					),
				),
			)
		);

		// Generate a hash string to uniquely identify this entry.
		$entry_id = substr( md5( 'googleanalytics' . $config_data ), 0, 12 );

		$analytics_entries[ $entry_id ] = array(
			'type'   => 'googleanalytics',
			'config' => $config_data,
		);

		return $analytics_entries;
	}

	/**
	 * Get AMP tracking codes.
	 *
	 * @param array $analytics_entries The codes available for AMP.
	 *
	 * @return array
	 */
	protected static function get_amp_tracking_codes( $analytics_entries ) {
		$entries  = array_column( $analytics_entries, 'config' );
		$accounts = array();

		foreach ( $entries as $entry ) {
			$entry = json_decode( $entry );

			if ( ! empty( $entry->vars->account ) ) {
				$accounts[] = $entry->vars->account;
			}
		}

		return $accounts;
	}
}

global $jetpack_google_analytics;
$jetpack_google_analytics = Jetpack_Google_Analytics::get_instance();
google-analytics.php                                                                                                                                                                                                                                           501           1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Google Analytics
 * Module Description: Set up Google Analytics without touching a line of code.
 * First Introduced: 4.5
 * Sort Order: 37
 * Requires Connection: Yes
 * Auto Activate: No
 * Feature: Engagement
 * Additional Search Queries: webmaster, google, analytics, console
 * Plans: business, premium, security, complete
 *
 * @package automattic/jetpack
 */

// Load main Jetpack_Google_Analytics class.
require __DIR__ . '/google-analytics/wp-google-analytics.php';
class-jetpack-google-font-face.php                                                                                                                                                                                                                             7115          1711191384  plugins/jetpack/modules/google-fonts/current                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Jetpack_Google_Font_Face class
 *
 * @package automattic/jetpack
 */

/**
 * Jetpack Google Font Face disables Font Face hooks in Core that prints **ALL** font faces.
 * Instead, it collects fonts that are used in global styles or block-level settings and
 * print those fonts in use.
 */
class Jetpack_Google_Font_Face {
	/**
	 * The fonts that are used in global styles or block-level settings.
	 *
	 * @var array
	 */
	private $fonts_in_use = array();

	/**
	 * The constructor.
	 */
	public function __construct() {
		// Turns off hooks to print fonts
		add_action( 'wp_loaded', array( $this, 'wp_loaded' ) );
		add_action( 'current_screen', array( $this, 'current_screen' ), 10 );

		// Collect and print fonts in use
		add_action( 'wp_head', array( $this, 'print_font_faces' ), 50 );
		add_filter( 'pre_render_block', array( $this, 'collect_block_fonts' ), 10, 2 );
	}

	/**
	 * Turn off hooks to print fonts on frontend
	 */
	public function wp_loaded() {
		remove_action( 'wp_head', 'wp_print_fonts', 50 );
		remove_action( 'wp_head', 'wp_print_font_faces', 50 );
	}

	/**
	 * Turn off hooks to print fonts on wp-admin, except for GB editor pages.
	 */
	public function current_screen() {
		remove_action( 'admin_print_styles', 'wp_print_fonts', 50 );

		if ( ! $this->is_block_editor() ) {
			remove_action( 'admin_print_styles', 'wp_print_font_faces', 50 );
		}
	}

	/**
	 * Print fonts that are used in global styles or block-level settings.
	 */
	public function print_font_faces() {
		$fonts             = WP_Font_Face_Resolver::get_fonts_from_theme_json();
		$font_slug_aliases = $this->get_font_slug_aliases();
		$fonts_to_print    = array();

		$this->collect_global_styles_fonts();
		$fonts_in_use = array_values( array_unique( $this->fonts_in_use, SORT_STRING ) );
		$fonts_in_use = array_map(
			function ( $font_slug ) use ( $font_slug_aliases ) {
				return $font_slug_aliases[ $font_slug ] ?? $font_slug;
			},
			$this->fonts_in_use
		);

		foreach ( $fonts as $font_faces ) {
			$font_family = $font_faces[0]['font-family'] ?? '';
			if ( in_array( $this->format_font( $font_family ), $fonts_in_use, true ) ) {
				$fonts_to_print[ $font_family ] = $font_faces;
			}
		}

		if ( ! empty( $fonts_to_print ) ) {
			wp_print_font_faces( $fonts_to_print );
		}
	}

	/**
	 * Collect fonts used for global styles settings.
	 */
	public function collect_global_styles_fonts() {
		$global_styles = wp_get_global_styles();

		$global_styles_font_slug = $this->get_font_slug_from_setting( $global_styles );
		if ( $global_styles_font_slug ) {
			$this->add_font( $global_styles_font_slug );
		}

		if ( isset( $global_styles['blocks'] ) ) {
			foreach ( $global_styles['blocks'] as $setting ) {
				$font_slug = $this->get_font_slug_from_setting( $setting );

				if ( $font_slug ) {
					$this->add_font( $font_slug );
				}
			}
		}

		if ( isset( $global_styles['elements'] ) ) {
			foreach ( $global_styles['elements'] as $setting ) {
				$font_slug = $this->get_font_slug_from_setting( $setting );

				if ( $font_slug ) {
					$this->add_font( $font_slug );
				}
			}
		}
	}

	/**
	 * Collect fonts used for block-level settings.
	 *
	 * @filter pre_render_block
	 *
	 * @param string|null $content The pre-rendered content. Default null.
	 * @param array       $parsed_block The block being rendered.
	 */
	public function collect_block_fonts( $content, $parsed_block ) {
		if ( ! is_admin() && isset( $parsed_block['attrs']['fontFamily'] ) ) {
			$block_font_family = $parsed_block['attrs']['fontFamily'];
			$this->add_font( $block_font_family );
		}

		return $content;
	}

	/**
	 * Add the specify font to the fonts_in_use list.
	 *
	 * @param string $font_slug The font slug.
	 */
	public function add_font( $font_slug ) {
		$this->fonts_in_use[] = $this->format_font( $font_slug );
	}

	/**
	 * Format the given font slug.
	 *
	 * @example "ABeeZee" formats to "abeezee"
	 * @example "ADLaM Display" formats to "adlam-display"
	 * @param string $font_slug The font slug.
	 * @return string The formatted font slug.
	 */
	public function format_font( $font_slug ) {
		return _wp_to_kebab_case( strtolower( $font_slug ) );
	}

	/**
	 * Get the font slug aliases that maps the font slug to the font family if they are different.
	 *
	 * The font definition may define an alias slug name, so we have to add the map from the slug name to the font family.
	 * See https://github.com/WordPress/twentytwentyfour/blob/df92472089ede6fae5924c124a93c843b84e8cbd/theme.json#L215.
	 */
	public function get_font_slug_aliases() {
		$font_slug_aliases = array();

		$theme_json = WP_Theme_JSON_Resolver::get_theme_data();
		$raw_data   = $theme_json->get_data();
		if ( ! empty( $raw_data['settings']['typography']['fontFamilies'] ) ) {
			foreach ( $raw_data['settings']['typography']['fontFamilies'] as $font ) {
				$font_family_name = $this->format_font( $this->get_font_family_name( $font ) );
				$font_slug        = $font['slug'] ?? '';
				if ( $font_slug && $font_slug !== $font_family_name && ! array_key_exists( $font_slug, $font_slug_aliases ) ) {
					$font_slug_aliases[ $font_slug ] = $font_family_name;
				}
			}
		}

		return $font_slug_aliases;
	}

	/**
	 * Get the font family name from a font.
	 *
	 * @param array $font The font definition object.
	 */
	public static function get_font_family_name( $font ) {
		$font_family = $font['fontFamily'];
		if ( str_contains( $font_family, ',' ) ) {
			$font_family = explode( ',', $font_family )[0];
		}

		return trim( $font_family, "\"'" );
	}

	/**
	 * Get the font family slug from a settings array.
	 *
	 * @param array $setting The settings object.
	 *
	 * @return string|null
	 */
	public function get_font_slug_from_setting( $setting ) {
		if ( ! isset( $setting['typography']['fontFamily'] ) ) {
			return null;
		}

		$font_family = $setting['typography']['fontFamily'];

		// The font family may be a reference to a path to the value stored at that location,
		// e.g.: { "ref": "styles.elements.heading.typography.fontFamily" }.
		// Ignore it as we also get the value stored at that location from the setting.
		if ( ! is_string( $font_family ) ) {
			return null;
		}

		// Full string: var(--wp--preset--font-family--slug).
		// We do not care about the origin of the font, only its slug.
		preg_match( '/font-family--(?P<slug>.+)\)$/', $font_family, $matches );

		if ( isset( $matches['slug'] ) ) {
			return $matches['slug'];
		}

		// Full string: var:preset|font-family|slug
		// We do not care about the origin of the font, only its slug.
		preg_match( '/font-family\|(?P<slug>.+)$/', $font_family, $matches );

		if ( isset( $matches['slug'] ) ) {
			return $matches['slug'];
		}

		return $font_family;
	}

	/**
	 * Check if the current screen is the block editor.
	 *
	 * @return bool
	 */
	public function is_block_editor() {
		if ( function_exists( 'get_current_screen' ) ) {
			$current_screen = get_current_screen();
			if ( ! empty( $current_screen ) && method_exists( $current_screen, 'is_block_editor' ) && $current_screen->is_block_editor() ) {
				return true;
			}
		}

		return false;
	}
}
load-google-fonts.php                                                                                                                                                                                                                                          7142          1711191384  plugins/jetpack/modules/google-fonts/current                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Load the google fonts by the new Font Library. See pNEWy-hhx-p2.
 *
 * @package automattic/jetpack
 */

if ( ! class_exists( 'Jetpack_Google_Font_Face' ) ) {
	/**
	 * Load Jetpack Google Font Face
	 */
	require_once __DIR__ . '/class-jetpack-google-font-face.php';
}

/**
 * Gets the Google Fonts data
 *
 * @return object[] The collection data of the Google Fonts.
 */
function jetpack_get_google_fonts_data() {
	$default_google_fonts_api_url        = 'https://fonts.gstatic.com';
	$jetpack_google_fonts_collection_url = 'https://s0.wp.com/i/font-collections/jetpack-google-fonts.json';
	$cache_key                           = 'jetpack_google_fonts_' . md5( $jetpack_google_fonts_collection_url );
	$data                                = get_transient( $cache_key );
	if ( $data === false ) {
		$response = wp_remote_get( $jetpack_google_fonts_collection_url );
		if ( is_wp_error( $response ) || wp_remote_retrieve_response_code( $response ) !== 200 ) {
			return null;
		}

		$data = json_decode( wp_remote_retrieve_body( $response ), true );
		if ( $data === null ) {
			return null;
		}

		set_transient( $cache_key, $data, DAY_IN_SECONDS );
	}

	// Replace the google fonts api url if the custom one is provided.
	$custom_google_fonts_api_url = \esc_url(
		/** This filter is documented in projects/packages/google-fonts-provider/src/class-google-fonts-provider.php */
		apply_filters( 'jetpack_google_fonts_api_url', $default_google_fonts_api_url )
	);
	if ( $custom_google_fonts_api_url !== $default_google_fonts_api_url ) {
		foreach ( $data['fontFamilies'] as &$font_family ) {
			foreach ( $font_family['fontFace'] as &$font_face ) {
				$font_face['src'] = str_replace(
					$default_google_fonts_api_url,
					$custom_google_fonts_api_url,
					$font_face['src']
				);
			}
		}
	}

	if ( is_array( $data ) && is_array( $data['fontFamilies'] ) ) {
		return $data;
	}
}

/**
 * Gets the map of the available Google Fonts
 *
 * @param object[] $google_fonts_data The collection data of the Google Fonts.
 * @return object[] The map of the the available Google Fonts.
 */
function jetpack_get_available_google_fonts_map( $google_fonts_data ) {
	$jetpack_google_fonts_list = array_map(
		function ( $font_family ) {
			return $font_family['name'];
		},
		$google_fonts_data['fontFamilies']
	);

	/** This filter is documented in modules/google-fonts/wordpress-6.3/load-google-fonts.php */
	$google_font_list           = apply_filters( 'jetpack_google_fonts_list', $jetpack_google_fonts_list );
	$available_google_fonts_map = array();

	foreach ( $google_font_list as $google_font ) {
		$available_google_fonts_map[ $google_font ] = true;
	}

	return $available_google_fonts_map;
}

/**
 * Gets the font families of the active theme
 *
 * @return object[] The font families of the active theme.
 */
function jetpack_get_theme_fonts_map() {
	if ( ! class_exists( 'WP_Theme_JSON_Resolver' ) ) {
		return array();
	}

	$theme_json = WP_Theme_JSON_Resolver::get_theme_data();
	$raw_data   = $theme_json->get_data();
	if ( empty( $raw_data['settings']['typography']['fontFamilies'] ) ) {
		return array();
	}

	$theme_fonts_map = array();
	foreach ( $raw_data['settings']['typography']['fontFamilies'] as $font_family ) {
		$font_family_name = $font_family['name'] ?? Jetpack_Google_Font_Face::get_font_family_name( $font_family );
		if ( $font_family_name ) {
			$theme_fonts_map[ $font_family_name ] = true;
		}
	}

	return $theme_fonts_map;
}

/**
 * Register google fonts to the theme json data
 *
 * @param WP_Theme_JSON_Data $theme_json The theme json data of core.
 * @return WP_Theme_JSON_Data The theme json data with registered google fonts.
 */
function jetpack_register_google_fonts_to_theme_json( $theme_json ) {
	$google_fonts_data = jetpack_get_google_fonts_data();
	if ( ! $google_fonts_data ) {
		return $theme_json;
	}

	$available_google_fonts_map = jetpack_get_available_google_fonts_map( $google_fonts_data );
	$theme_fonts_map            = jetpack_get_theme_fonts_map();
	$google_fonts_families      = array_values(
		array_filter(
			$google_fonts_data['fontFamilies'],
			function ( $google_fonts_family ) use ( $available_google_fonts_map, $theme_fonts_map ) {
				$name = $google_fonts_family['name'];

				// Filter out the fonts that are provided by the active theme.
				if ( isset( $theme_fonts_map[ $name ] ) && $theme_fonts_map[ $name ] ) {
					return false;
				}

				return $available_google_fonts_map[ $name ] ?? false;
			}
		)
	);

	$raw_data = $theme_json->get_data();
	$origin   = 'default';
	if ( empty( $raw_data['settings']['typography']['fontFamilies'][ $origin ] ) ) {
		$raw_data['settings']['typography']['fontFamilies'][ $origin ] = array();
	}

	foreach ( $google_fonts_families as $font_family ) {
		$raw_data['settings']['typography']['fontFamilies'][ $origin ][] = $font_family;
	}

	$theme_json_class = get_class( $theme_json );
	return new $theme_json_class( $raw_data, $origin );
}

add_filter( 'wp_theme_json_data_default', 'jetpack_register_google_fonts_to_theme_json' );

/**
 * Filter out the deprecated font families that are from the jetpack-google-fonts provider.
 *
 * @param object[] $font_families The font families.
 * @return object[] The filtered font families.
 */
function jetpack_google_fonts_filter_out_deprecated_font_data( $font_families ) {
	return array_values(
		array_filter(
			$font_families,
			function ( $font_family ) {
				$has_deprecated_google_fonts_data = false;

				if ( isset( $font_family['fontFace'] ) ) {
					foreach ( $font_family['fontFace'] as $font_face ) {
						$provider = $font_face['provider'] ?? '';
						if ( $provider === 'jetpack-google-fonts' ) {
							$has_deprecated_google_fonts_data = true;
							break;
						}
					}
				}

				return ! $has_deprecated_google_fonts_data;
			}
		)
	);
}

/**
 * Unregister the deprecated jetpack-google-fonts provider from theme json data that were stored
 * before we moved to the Font Library.
 *
 * @param WP_Theme_JSON_Data $theme_json The theme json data.
 * @return WP_Theme_JSON_Data The filtered theme json data.
 */
function jetpack_unregister_deprecated_google_fonts_from_theme_json_data( $theme_json ) {
	$raw_data = $theme_json->get_data();
	$origin   = 'theme';
	if ( empty( $raw_data['settings']['typography']['fontFamilies'][ $origin ] ) ) {
		return $theme_json;
	}

	// Filter out the font definitions that are from the jetpack-google-fonts provider.
	$raw_data['settings']['typography']['fontFamilies'][ $origin ] = jetpack_google_fonts_filter_out_deprecated_font_data(
		$raw_data['settings']['typography']['fontFamilies'][ $origin ]
	);

	$theme_json_class = get_class( $theme_json );
	return new $theme_json_class( $raw_data, 'custom' );
}

add_filter( 'wp_theme_json_data_theme', 'jetpack_unregister_deprecated_google_fonts_from_theme_json_data' );
add_filter( 'wp_theme_json_data_user', 'jetpack_unregister_deprecated_google_fonts_from_theme_json_data' );

// Initialize Jetpack Google Font Face to avoid printing **ALL** google fonts provided by this module.
// See p1700040028362329-slack-C4GAQ900P and p7DVsv-jib-p2
new Jetpack_Google_Font_Face();
load.php                                                                                                                                                                                                                                                       630           1711191384  plugins/jetpack/modules/google-fonts                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Load the google fonts based on the current WordPress version.
 *
 * @package automattic/jetpack
 */

add_action(
	'plugins_loaded',
	function () {
		if ( class_exists( 'WP_Font_Face' ) ) {
			// WordPress 6.5 or above with the new Font Library.
			require_once __DIR__ . '/current/load-google-fonts.php';
		} elseif ( class_exists( 'WP_Fonts' ) || class_exists( 'WP_Webfonts' ) ) {
			// Gutenberg Fonts API compatible.
			require_once __DIR__ . '/wordpress-6.3/load-google-fonts.php';
		}
	},
	// Ensure the action is loaded after the late_initialization.
	// See projects/plugins/jetpack/class.jetpack.php.
	999
);
constants.php                                                                                                                                                                                                                                                  899           1711191384  plugins/jetpack/modules/google-fonts/wordpress-6.3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * Define the constants of the Jetpack Google Fonts module.
 *
 * @package automattic/jetpack
 */

/**
 * Curated list of Google Fonts
 * See p9Jlb4-22P-p2
 */
const JETPACK_GOOGLE_FONTS_LIST = array(
	'Albert Sans',
	'Alegreya',
	'Arvo',
	'Bodoni Moda',
	'Cabin',
	'Chivo',
	'Commissioner',
	'Cormorant',
	'Courier Prime',
	'Crimson Pro',
	'DM Mono',
	'DM Sans',
	'Domine',
	'EB Garamond',
	'Epilogue',
	'Figtree',
	'Fira Sans',
	'Fraunces',
	'IBM Plex Mono',
	'IBM Plex Sans',
	'Inter',
	'Josefin Sans',
	'Jost',
	'Libre Baskerville',
	'Libre Franklin',
	'Literata',
	'Lora',
	'Merriweather',
	'Montserrat',
	'Newsreader',
	'Nunito',
	'Open Sans',
	'Overpass',
	'Petrona',
	'Piazzolla',
	'Playfair Display',
	'Plus Jakarta Sans',
	'Poppins',
	'Raleway',
	'Roboto Slab',
	'Roboto',
	'Rubik',
	'Sora',
	'Source Sans Pro',
	'Source Serif Pro',
	'Space Mono',
	'Texturina',
	'Work Sans',
);
load-google-fonts.php                                                                                                                                                                                                                                          2787          1711191384  plugins/jetpack/modules/google-fonts/wordpress-6.3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * Load the google fonts by wp_register_fonts or wp_register_webfonts.
 *
 * @package automattic/jetpack
 */

/**
 * Load the constants.
 */
require_once __DIR__ . '/constants.php';

/**
 * Register a curated selection of Google Fonts.
 *
 * @return void
 */
function jetpack_add_google_fonts_provider() {
	if ( ! function_exists( 'wp_register_webfont_provider' ) || ! function_exists( 'wp_register_webfonts' ) ) {
		return;
	}

	wp_register_webfont_provider( 'jetpack-google-fonts', '\Automattic\Jetpack\Fonts\Google_Fonts_Provider' );

	/**
	 * Curated list of Google Fonts.
	 *
	 * @module google-fonts
	 *
	 * @since 10.8
	 *
	 * @param array $fonts_to_register Array of Google Font names to register.
	 */
	$fonts_to_register = apply_filters( 'jetpack_google_fonts_list', JETPACK_GOOGLE_FONTS_LIST );

	foreach ( $fonts_to_register as $font_family ) {
		$fonts = array();

		$font_italic = array(
			'font-family'  => $font_family,
			'font-weight'  => '100 900',
			'font-style'   => 'normal',
			'font-display' => 'fallback',
			'provider'     => 'jetpack-google-fonts',
		);

		$font_normal = array(
			'font-family'  => $font_family,
			'font-weight'  => '100 900',
			'font-style'   => 'italic',
			'font-display' => 'fallback',
			'provider'     => 'jetpack-google-fonts',
		);

		// New WP Fonts API format since Gutenberg 14.9 requires keyed array
		// See https://github.com/Automattic/jetpack/issues/28063
		// Remove conditional once this experimental API makes it to WP Core, and after another core release.
		if ( class_exists( 'WP_Fonts' ) ) {
			$fonts = array(
				$font_family => array( $font_normal, $font_italic ),
			);
		} elseif ( class_exists( 'WP_Webfonts' ) ) {
			$fonts = array( $font_normal, $font_italic );
		}

		// New fonts register function since Gutenberg 15.0 or 15.1
		// See https://github.com/Automattic/jetpack/issues/28063#issuecomment-1387090575
		// Remove conditional once this experimental API makes it to WP Core, and after another core release.
		if ( function_exists( 'wp_register_fonts' ) ) {
			wp_register_fonts( $fonts );
		} else {
			wp_register_webfonts( $fonts );
		}
	}
}
add_action( 'after_setup_theme', 'jetpack_add_google_fonts_provider' );

add_filter( 'wp_resource_hints', '\Automattic\Jetpack\Fonts\Utils::font_source_resource_hint', 10, 2 );
add_filter( 'pre_render_block', '\Automattic\Jetpack\Fonts\Introspectors\Blocks::enqueue_block_fonts', 10, 2 );
// The priority for the next hook is is set to 22 because it needs to run after Gutenberg's
// re-registration (at priority 22) of the core blocks it de-registers (at the default priority 10),
// otherwise Gutenberg caches an incorrect state.
add_action( 'init', '\Automattic\Jetpack\Fonts\Introspectors\Global_Styles::enqueue_global_styles_fonts', 22 );
google-fonts.php                                                                                                                                                                                                                                               533           1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Google Fonts (Beta)
 * Module Description: A selection of Google fonts for block enabled themes. This feature is still being developed.
 * Sort Order: 1
 * Recommendation Order: 2
 * First Introduced: 10.8.0
 * Requires Connection: No
 * Auto Activate: No
 * Module Tags: Fonts, Recommended
 * Feature: Writing
 * Additional Search Queries: fonts, webfonts, typography, creator
 *
 * @package automattic/jetpack
 */

/**
 * Load the Google Fonts module.
 */
require_once __DIR__ . '/google-fonts/load.php';
gravatar-hovercards-amp.css                                                                                                                                                                                                                                    47            1711191384  plugins/jetpack/modules/gravatar                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .comment-author figcaption {
	display: none;
}
gravatar-hovercards.php                                                                                                                                                                                                                                        12087         1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Gravatar Hovercards
 * Module Description: Enable pop-up business cards over commenters’ Gravatars.
 * Sort Order: 11
 * Recommendation Order: 13
 * First Introduced: 1.1
 * Requires Connection: No
 * Auto Activate: No
 * Module Tags: Social, Appearance
 * Feature: Appearance
 * Additional Search Queries: gravatar, hovercards
 *
 * @package automattic/jetpack
 */

define( 'GROFILES__CACHE_BUSTER', gmdate( 'YW' ) );

/**
 * Actions that are run on init.
 */
function grofiles_hovercards_init() {
	add_filter( 'get_avatar', 'grofiles_get_avatar', 10, 2 );
	add_action( 'wp_enqueue_scripts', 'grofiles_attach_cards' );
	add_action( 'wp_footer', 'grofiles_extra_data' );
	add_action( 'admin_init', 'grofiles_add_settings' );

	add_action( 'load-index.php', 'grofiles_admin_cards' );
	add_action( 'load-users.php', 'grofiles_admin_cards' );
	add_action( 'load-edit-comments.php', 'grofiles_admin_cards' );
	add_action( 'load-options-discussion.php', 'grofiles_admin_cards_forced' );

	add_filter( 'jetpack_module_configuration_url_gravatar-hovercards', 'gravatar_hovercards_configuration_url' );

	add_filter( 'get_comment_author_url', 'grofiles_amp_comment_author_url', 10, 2 );
}

/**
 * Set configuration page URL.
 */
function gravatar_hovercards_configuration_url() {
	return admin_url( 'options-discussion.php#show_avatars' );
}

add_action( 'jetpack_modules_loaded', 'grofiles_hovercards_init' );

/* Hovercard Settings */

/**
 * Adds Gravatar Hovercard setting
 *
 * @todo - always print HTML, hide via CSS/JS if !show_avatars
 */
function grofiles_add_settings() {
	if ( ! get_option( 'show_avatars' ) ) {
		return;
	}

	add_settings_field( 'gravatar_disable_hovercards', __( 'Gravatar Hovercards', 'jetpack' ), 'grofiles_setting_callback', 'discussion', 'avatars' );
	register_setting( 'discussion', 'gravatar_disable_hovercards', 'grofiles_hovercard_option_sanitize' );
}

/**
 * HTML for Gravatar Hovercard setting
 */
function grofiles_setting_callback() {
	global $current_user;

	$option = get_option( 'gravatar_disable_hovercards' );
	printf(
		"<label id='gravatar-hovercard-options'><input %s name='gravatar_disable_hovercards' id='gravatar_disable_hovercards' type='checkbox' value='enabled' class='code'/>%s</label>",
		checked( $option, 'enabled', false ),
		esc_html__( 'View people\'s profiles when you mouse over their Gravatars', 'jetpack' )
	);

	?>
<style type="text/css">
#grav-profile-example img {
	float: left;
}
#grav-profile-example span {
	padding: 0 1em;
}
</style>
<script type="text/javascript">
// <![CDATA[
jQuery( function($) {
	var tr = $( '#gravatar_disable_hovercards' ).change( function() {
		if ( $( this ).is( ':checked' ) ) {
			$( '#grav-profile-example' ).slideDown( 'fast' );
		} else {
			$( '#grav-profile-example' ).slideUp( 'fast' );
		}
	} ).parents( 'tr' );
	var ftr = tr.parents( 'table' ).find( 'tr:first' );
	if ( ftr.length && !ftr.find( '#gravatar_disable_hovercards' ).length ) {
		ftr.after( tr );
	}
} );
// ]]>
</script>
	<p id="grav-profile-example" class="hide-if-no-js"
		<?php
		if ( 'disabled' === $option ) {
			echo ' style="display:none"';}
		?>
		>
		<?php echo get_avatar( $current_user->ID, 64 ); ?> <span><?php esc_html_e( 'Put your mouse over your Gravatar to check out your profile.', 'jetpack' ); ?> <br class="clear" /></span></p>
	<?php
}

/**
 * Sanitation filter for Gravatar Hovercard setting
 *
 * @param string $val Disabled or enabled.
 */
function grofiles_hovercard_option_sanitize( $val ) {
	if ( 'disabled' === $val ) {
		return $val;
	}

	return $val ? 'enabled' : 'disabled';
}

/* Hovercard Display */

/**
 * Stores the gravatars' users that need extra profile data attached.
 *
 * Getter/Setter
 *
 * @param int|string|null $author Setter: User ID or email address.  Getter: null.
 *
 * @return mixed Setter: void.  Getter: array of user IDs and email addresses.
 */
function grofiles_gravatars_to_append( $author = null ) {
	static $authors = array();

	// Get.
	if ( $author === null ) {
		return array_keys( $authors );
	}

	// Set.

	if ( is_numeric( $author ) ) {
		$author = (int) $author;
	}

	$authors[ $author ] = true;
}

/**
 * In AMP, override the comment URL to allow for interactivity without
 * navigating to a new page
 *
 * @param string $url The comment author's URL.
 * @param int    $id  The comment ID.
 *
 * @return string The adjusted URL
 */
function grofiles_amp_comment_author_url( $url, $id ) {
	if ( 'comment' === get_comment_type( $id ) && class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request() ) {
		// @todo Disabling the comment author link in this way is not ideal since clicking the link does not cause the lightbox to open in the same way as clicking the gravatar. Likely get_comment_author_url_link should be used instead so that the href attribute can be replaced with an `on` attribute that activates the gallery.
		return '#!';
	}

	return $url;
}

/**
 * Stores the user ID or email address for each gravatar generated.
 *
 * Attached to the 'get_avatar' filter.
 *
 * @param string $avatar The <img/> element of the avatar.
 * @param mixed  $author User ID, email address, user login, comment object, user object, post object.
 *
 * @return string The <img/> element of the avatar.
 */
function grofiles_get_avatar( $avatar, $author ) {
	$is_amp = class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request();

	if ( is_numeric( $author ) ) {
		grofiles_gravatars_to_append( $author );
	} elseif ( is_string( $author ) ) {
		if ( str_contains( $author, '@' ) ) {
			grofiles_gravatars_to_append( $author );
		} else {
			$user = get_user_by( 'slug', $author );
			if ( $user ) {
				grofiles_gravatars_to_append( $user->ID );
			}
		}
	} elseif ( isset( $author->comment_type ) ) {
		if ( $is_amp ) {
			if ( 1 === preg_match( '/avatar\/([a-zA-Z0-9]+)\?/', $avatar, $email_hash ) ) {
				$email_hash  = $email_hash[1];
				$cache_group = 'gravatar_profiles_';
				$cache_key   = 'gravatar_profile_' . $email_hash;

				$response_body = wp_cache_get( $cache_key, $cache_group );
				if ( false === $response_body ) {
					$response = wp_remote_get( esc_url_raw( 'https://gravatar.com/' . $email_hash . '.json' ) );
					if ( is_array( $response ) && ! is_wp_error( $response ) ) {
						$response_body = json_decode( $response['body'] );
						wp_cache_set( $cache_key, $response_body, $cache_group, 60 * MINUTE_IN_SECONDS );
					}
				}

				$profile      = isset( $response_body->entry[0] ) ? $response_body->entry[0] : null;
				$display_name = isset( $profile->displayName ) ? $profile->displayName : ''; // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				$location     = isset( $profile->currentLocation ) ? $profile->currentLocation : ''; // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				$description  = isset( $profile->aboutMe ) ? $profile->aboutMe : ''; // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase

				$avatar = '
					<figure data-amp-lightbox="true">
						' . $avatar . '
						<figcaption>
							' . esc_html( $display_name ) . ( ! empty( $location ) ? ' – ' . esc_html( $location ) : '' ) . ( ! empty( $description ) ? ' – ' . esc_html( $description ) : '' ) . '
						</figcaption>
					</figure>
				';
			}

			return $avatar;
		}

		if ( '' !== $author->comment_type && 'comment' !== $author->comment_type ) {
			return $avatar;
		}
		if ( $author->user_id ) {
			grofiles_gravatars_to_append( $author->user_id );
		} else {
			grofiles_gravatars_to_append( $author->comment_author_email );
		}
	} elseif ( isset( $author->user_login ) ) {
		grofiles_gravatars_to_append( $author->ID );
	} elseif ( isset( $author->post_author ) ) {
		grofiles_gravatars_to_append( $author->post_author );
	}

	return $avatar;
}

/**
 * Loads Gravatar Hovercard script.
 *
 * @todo is_singular() only?
 */
function grofiles_attach_cards() {

	// Is the display of Avatars disabled?
	if ( ! get_option( 'show_avatars' ) ) {
		return;
	}

	// Is the display of Gravatar Hovercards disabled?
	if ( 'disabled' === Jetpack_Options::get_option_and_ensure_autoload( 'gravatar_disable_hovercards', '0' ) ) {
		return;
	}

	if ( class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request() ) {
		wp_enqueue_style( 'gravatar-hovercard-style', plugins_url( '/gravatar/gravatar-hovercards-amp.css', __FILE__ ), array(), JETPACK__VERSION );
	} else {
		wp_enqueue_script( 'grofiles-cards', 'https://secure.gravatar.com/js/gprofiles.js', array(), GROFILES__CACHE_BUSTER, true );
		wp_enqueue_script( 'wpgroho', plugins_url( 'wpgroho.js', __FILE__ ), array( 'grofiles-cards' ), JETPACK__VERSION, true );
		if ( is_user_logged_in() ) {
			$cu      = wp_get_current_user();
			$my_hash = md5( $cu->user_email );
		} elseif ( ! empty( $_COOKIE[ 'comment_author_email_' . COOKIEHASH ] ) ) {
			$my_hash = md5( filter_var( wp_unslash( $_COOKIE[ 'comment_author_email_' . COOKIEHASH ] ) ) );
		} else {
			$my_hash = '';
		}
		wp_localize_script( 'wpgroho', 'WPGroHo', compact( 'my_hash' ) );
	}
}
/**
 * Add hovercards on Discussion settings panel.
 */
function grofiles_attach_cards_forced() {
	add_filter( 'pre_option_gravatar_disable_hovercards', 'grofiles_force_gravatar_enable_hovercards' );
	grofiles_attach_cards();
}
/**
 * Set hovercards as enabled on Discussion settings panel.
 */
function grofiles_force_gravatar_enable_hovercards() {
	return 'enabled';
}
/**
 * Add script to admin footer on Discussion settings panel.
 */
function grofiles_admin_cards_forced() {
	add_action( 'admin_footer', 'grofiles_attach_cards_forced' );
}
/**
 * Add script to admin footer.
 */
function grofiles_admin_cards() {
	add_action( 'admin_footer', 'grofiles_attach_cards' );
}
/**
 * Dequeue the FE assets when there are no gravatars on the page to be displayed.
 */
function grofiles_extra_data() {
	$authors = grofiles_gravatars_to_append();

	if ( ! $authors ) {
		wp_dequeue_script( 'grofiles-cards' );
		wp_dequeue_script( 'wpgroho' );
	} else {
		?>
	<div style="display:none">
		<?php
		foreach ( $authors as $author ) {
			grofiles_hovercards_data_html( $author );
		}
		?>
	</div>
		<?php
	}
}

/**
 * Echoes the data from grofiles_hovercards_data() as HTML elements.
 *
 * @since 5.5.0 Add support for a passed WP_User object
 *
 * @param int|string|WP_User $author User ID, email address, or a WP_User object.
 */
function grofiles_hovercards_data_html( $author ) {
	$data = grofiles_hovercards_data( $author );
	$hash = '';
	if ( is_numeric( $author ) ) {
		$user = get_userdata( $author );
		if ( $user ) {
			$hash = md5( $user->user_email );
		}
	} elseif ( is_email( $author ) ) {
		$hash = md5( $author );
	} elseif ( is_a( $author, 'WP_User' ) ) {
		$hash = md5( $author->user_email );
	}

	if ( ! $hash ) {
		return;
	}
	?>
	<div class="grofile-hash-map-<?php echo esc_attr( $hash ); ?>">
	<?php	foreach ( $data as $key => $value ) : ?>
		<span class="<?php echo esc_attr( $key ); ?>"><?php echo esc_html( $value ); ?></span>
<?php	endforeach; ?>
	</div>
	<?php
}

/* API */

/**
 * Returns the PHP callbacks for data sources.
 *
 * 'grofiles_hovercards_data_callbacks' filter
 *
 * @return array( data_key => data_callback, ... )
 */
function grofiles_hovercards_data_callbacks() {
	/**
	 * Filter the Gravatar Hovercard PHP callbacks.
	 *
	 * @module gravatar-hovercards
	 *
	 * @since 1.1.0
	 *
	 * @param array $args Array of data callbacks.
	 */
	return apply_filters( 'grofiles_hovercards_data_callbacks', array() );
}

/**
 * Keyed JSON object containing all profile data provided by registered callbacks
 *
 * @param int|strung $author User ID or email address.
 *
 * @return array( data_key => data, ... )
 */
function grofiles_hovercards_data( $author ) {
	$r = array();
	foreach ( grofiles_hovercards_data_callbacks() as $key => $callback ) {
		if ( ! is_callable( $callback ) ) {
			continue;
		}
		$data = call_user_func( $callback, $author, $key );
		if ( $data !== null ) {
			$r[ $key ] = $data;
		}
	}

	return $r;
}
infinity-customizer.js                                                                                                                                                                                                                                         2000          1711191384  plugins/jetpack/modules/infinite-scroll                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* globals wp */
( function ( $ ) {
	/**
	 * Ready, set, go!
	 */
	$( document ).ready( function () {
		// Integrate with Selective Refresh in the Customizer.
		if ( 'undefined' !== typeof wp && wp.customize && wp.customize.selectiveRefresh ) {
			/**
			 * Handle rendering of selective refresh partials.
			 *
			 * Make sure that when a partial is rendered, the Jetpack post-load event
			 * will be triggered so that any dynamic elements will be re-constructed,
			 * such as ME.js elements, Photon replacements, social sharing, and more.
			 * Note that this is applying here not strictly to posts being loaded.
			 * If a widget contains a ME.js element and it is previewed via selective
			 * refresh, the post-load would get triggered allowing any dynamic elements
			 * therein to also be re-constructed.
			 *
			 * @param {wp.customize.selectiveRefresh.Placement} placement
			 */
			wp.customize.selectiveRefresh.bind( 'partial-content-rendered', function ( placement ) {
				var content;
				if ( 'string' === typeof placement.addedContent ) {
					content = placement.addedContent;
				} else if ( placement.container ) {
					content = $( placement.container ).html();
				}

				if ( content ) {
					$( document.body ).trigger( 'post-load', { html: content } );
				}
			} );

			/*
			 * Add partials for posts added via infinite scroll.
			 *
			 * This is unnecessary when MutationObserver is supported by the browser
			 * since then this will be handled by Selective Refresh in core.
			 */
			if ( 'undefined' === typeof MutationObserver ) {
				$( document.body ).on( 'post-load', function ( e, response ) {
					var rootElement = null;
					if ( response.html && -1 !== response.html.indexOf( 'data-customize-partial' ) ) {
						if ( window.infiniteScroll.settings.id ) {
							rootElement = $( '#' + window.infiniteScroll.settings.id );
						}
						wp.customize.selectiveRefresh.addPartials( rootElement );
					}
				} );
			}
		}
	} );
} )( jQuery ); // Close closure
infinity.css                                                                                                                                                                                                                                                   5729          1711191384  plugins/jetpack/modules/infinite-scroll                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* =Infinity Styles
-------------------------------------------------------------- */

.infinite-loader {
	color: #000;
	display: block;
	height: 28px;
	text-align: center;
}
#infinite-handle span {
	background: #333;
	border-radius: 1px;
	color: #f0f0f1;
	cursor: pointer;
	font-size: 13px;
	padding: 6px 16px;
}

/**
 * CSS Spinner Styles
 */
@keyframes spinner-inner {
	0% { opacity: 1 }
	100% { opacity: 0 }
}
.infinite-loader .spinner-inner div {
	left: 47px;
	top: 24px;
	position: absolute;
	animation: spinner-inner linear 1s infinite;
	background: #000000;
	outline: 1px solid white;
	width: 6px;
	height: 12px;
	border-radius: 3px / 6px;
	transform-origin: 3px 26px;
}
.infinite-loader .spinner-inner div:nth-child(1) {
	transform: rotate(0deg);
	animation-delay: -0.9166666666666666s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(2) {
	transform: rotate(30deg);
	animation-delay: -0.8333333333333334s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(3) {
	transform: rotate(60deg);
	animation-delay: -0.75s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(4) {
	transform: rotate(90deg);
	animation-delay: -0.6666666666666666s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(5) {
	transform: rotate(120deg);
	animation-delay: -0.5833333333333334s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(6) {
	transform: rotate(150deg);
	animation-delay: -0.5s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(7) {
	transform: rotate(180deg);
	animation-delay: -0.4166666666666667s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(8) {
	transform: rotate(210deg);
	animation-delay: -0.3333333333333333s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(9) {
	transform: rotate(240deg);
	animation-delay: -0.25s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(10) {
	transform: rotate(270deg);
	animation-delay: -0.16666666666666666s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(11) {
	transform: rotate(300deg);
	animation-delay: -0.08333333333333333s;
	background: #000000;
}
.infinite-loader .spinner-inner div:nth-child(12) {
	transform: rotate(330deg);
	animation-delay: 0s;
	background: #000000;
}
.infinite-loader .spinner {
	width: 28px;
	height: 28px;
	display: inline-block;
	overflow: hidden;
	background: none;
}
.infinite-loader .spinner-inner {
	width: 100%;
	height: 100%;
	position: relative;
	transform: translateZ(0) scale(0.28);
	backface-visibility: hidden;
	transform-origin: 0 0; /* see note above */
}
.infinite-loader .spinner-inner div {
	box-sizing: content-box;
}

/**
 * Using a highly-specific rule to make sure that all button styles
 * will be reset
 */
#infinite-handle span button,
#infinite-handle span button:hover,
#infinite-handle span button:focus {
	display: inline;
	position: static;
	padding: 0;
	margin: 0;
	border: none;
	line-height: inherit;
	background: transparent;
	color: inherit;
	cursor: inherit;
	font-size: inherit;
	font-weight: inherit;
	font-family: inherit;
}

/**
 * This is used to avoid unnecessary inner button spacing in Firefox
 */
#infinite-handle span button::-moz-focus-inner {
	margin: 0;
	padding: 0;
	border: none;
}

/**
 * For smaller viewports, remove the down-arrow icon and turn
 * the button into a block element, spanning the content's full width.
 */
@media (max-width: 800px) {
	#infinite-handle span:before {
		display: none;
	}
	#infinite-handle span {
		display: block;
	}
}

/**
 * Footer
 */
#infinite-footer {
	position: fixed;
		bottom: -50px;
		left: 0;
	width: 100%;
}
#infinite-footer a {
	text-decoration: none;
}
#infinite-footer .blog-info a:hover,
#infinite-footer .blog-credits a:hover {
	color: #444;
	text-decoration: underline;
}
#infinite-footer .container {
	background: rgba( 255, 255, 255, 0.8 );
	border-color: #ccc;
	border-color: rgba( 0, 0, 0, 0.1 );
	border-style: solid;
	border-width: 1px 0 0;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	margin: 0 auto;
	overflow: hidden;
	padding: 1px 20px;
	width: 780px;
}
#infinite-footer .blog-info,
#infinite-footer .blog-credits {
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	box-sizing: border-box;
	line-height: 25px;
}
#infinite-footer .blog-info {
	float: left;
	overflow: hidden;
	text-align: left;
	text-overflow: ellipsis;
	white-space: nowrap;
	width: 40%;
}
#infinite-footer .blog-credits {
	font-weight: normal;
	float: right;
	width: 60%;
}
#infinite-footer .blog-info a {
	color: #111;
	font-size: 14px;
	font-weight: bold;
}
#infinite-footer .blog-credits {
	color: #888;
	font-size: 12px;
	text-align: right;
}
#infinite-footer .blog-credits a {
	color: #646970;
}

/**
 * Hooks to infinity-end body class to restore footer
 */
.infinity-end.neverending #infinite-footer {
	display: none;
}

/**
 * Responsive structure for the footer
 */
@media (max-width: 640px) {
	#infinite-footer .container {
		-moz-box-sizing: border-box;
		-webkit-box-sizing: border-box;
		box-sizing: border-box;
		width: 100%;
	}
	#infinite-footer .blog-info {
		width: 30%;
	}
	#infinite-footer .blog-credits {
		width: 70%;
	}
	#infinite-footer .blog-info a,
	#infinite-footer .blog-credits {
		font-size: 10px;
	}
}

/**
 * No fixed footer on small viewports
 */
@media ( max-width: 640px ) {
	#infinite-footer {
		position: static;
	}
}

/**
 * Hide infinite aria feedback visually
 */
#infinite-aria {
	position: absolute;
	overflow: hidden;
	clip: rect(0 0 0 0);
	height: 1px; width: 1px;
	margin: -1px; padding: 0; border: 0;
}

/**
 * Hide focus on infinite wrappers
 */
.infinite-wrap:focus {
	outline: 0 !important;
}
infinity.js                                                                                                                                                                                                                                                    27255         1711191384  plugins/jetpack/modules/infinite-scroll                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* globals infiniteScroll, _wpmejsSettings, ga, _gaq, WPCOM_sharing_counts, MediaElementPlayer */
( function () {
	// Open closure.
	// Local vars.
	var Scroller, ajaxurl, stats, type, text, totop, loading_text;

	// IE requires special handling
	var isIE = -1 != navigator.userAgent.search( 'MSIE' );
	if ( isIE ) {
		var IEVersion = navigator.userAgent.match( /MSIE\s?(\d+)\.?\d*;/ );
		IEVersion = parseInt( IEVersion[ 1 ] );
	}

	// HTTP ajaxurl when site is HTTPS causes Access-Control-Allow-Origin failure in Desktop and iOS Safari
	if ( 'https:' == document.location.protocol ) {
		infiniteScroll.settings.ajaxurl = infiniteScroll.settings.ajaxurl.replace(
			'http://',
			'https://'
		);
	}

	/**
	 * Loads new posts when users scroll near the bottom of the page.
	 */
	Scroller = function ( settings ) {
		var self = this;

		// Initialize our variables
		this.id = settings.id;
		this.body = document.body;
		this.window = window;
		this.element = document.getElementById( settings.id );
		this.wrapperClass = settings.wrapper_class;
		this.ready = true;
		this.disabled = false;
		this.page = 1;
		this.offset = settings.offset;
		this.currentday = settings.currentday;
		this.order = settings.order;
		this.throttle = false;
		this.click_handle = settings.click_handle;
		this.google_analytics = settings.google_analytics;
		this.history = settings.history;
		this.origURL = window.location.href;

		// Handle element
		this.handle = document.createElement( 'div' );
		this.handle.setAttribute( 'id', 'infinite-handle' );
		this.handle.innerHTML = '<span><button>' + text.replace( '\\', '' ) + '</button></span>';

		// Footer settings
		this.footer = {
			el: document.getElementById( 'infinite-footer' ),
			wrap: settings.footer,
		};

		// Bind methods used as callbacks
		this.checkViewportOnLoadBound = self.checkViewportOnLoad.bind( this );

		// Core's native MediaElement.js implementation needs special handling
		this.wpMediaelement = null;

		// We have two type of infinite scroll
		// cases 'scroll' and 'click'

		if ( type == 'scroll' ) {
			// Bind refresh to the scroll event
			// Throttle to check for such case every 300ms

			// On event the case becomes a fact
			this.window.addEventListener( 'scroll', function () {
				self.throttle = true;
			} );

			// Go back top method
			self.gotop();

			setInterval( function () {
				if ( self.throttle ) {
					// Once the case is the case, the action occurs and the fact is no more
					self.throttle = false;
					// Reveal or hide footer
					self.thefooter();
					// Fire the refresh
					self.refresh();
					self.determineURL(); // determine the url
				}
			}, 250 );

			// Ensure that enough posts are loaded to fill the initial viewport, to compensate for short posts and large displays.
			self.ensureFilledViewport();
			this.body.addEventListener( 'is.post-load', self.checkViewportOnLoadBound );
		} else if ( type == 'click' ) {
			if ( this.click_handle ) {
				this.element.appendChild( this.handle );
			}

			this.handle.addEventListener( 'click', function () {
				// Handle the handle
				if ( self.click_handle ) {
					self.handle.parentNode.removeChild( self.handle );
				}

				// Fire the refresh
				self.refresh();
			} );
		}

		// Initialize any Core audio or video players loaded via IS
		this.body.addEventListener( 'is.post-load', self.initializeMejs );
	};

	/**
	 * Normalize the access to the document scrollTop value.
	 */
	Scroller.prototype.getScrollTop = function () {
		return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
	};

	/**
	 * Polyfill jQuery.extend.
	 */
	Scroller.prototype.extend = function ( out ) {
		out = out || {};

		for ( var i = 1; i < arguments.length; i++ ) {
			if ( ! arguments[ i ] ) {
				continue;
			}

			for ( var key in arguments[ i ] ) {
				if ( arguments[ i ].hasOwnProperty( key ) ) {
					out[ key ] = arguments[ i ][ key ];
				}
			}
		}
		return out;
	};

	/**
	 * Check whether we should fetch any additional posts.
	 */
	Scroller.prototype.check = function () {
		var wrapperMeasurements = this.measure( this.element, [ this.wrapperClass ] );

		// Fetch more posts when we're less than 2 screens away from the bottom.
		return wrapperMeasurements.bottom < 2 * this.window.innerHeight;
	};

	/**
	 * Renders the results from a successful response.
	 */
	Scroller.prototype.render = function ( response ) {
		var childrenToAppend = Array.prototype.slice.call( response.fragment.childNodes );
		this.body.classList.add( 'infinity-success' );

		// Render the retrieved nodes.
		while ( childrenToAppend.length > 0 ) {
			var currentNode = childrenToAppend.shift();
			this.element.appendChild( currentNode );
		}

		this.trigger( this.body, 'is.post-load', {
			jqueryEventName: 'post-load',
			data: response,
		} );

		this.ready = true;
	};

	/**
	 * Returns the object used to query for new posts.
	 */
	Scroller.prototype.query = function () {
		return {
			page: this.page + this.offset, // Load the next page.
			currentday: this.currentday,
			order: this.order,
			scripts: window.infiniteScroll.settings.scripts,
			styles: window.infiniteScroll.settings.styles,
			query_args: window.infiniteScroll.settings.query_args,
			query_before: window.infiniteScroll.settings.query_before,
			last_post_date: window.infiniteScroll.settings.last_post_date,
		};
	};

	Scroller.prototype.animate = function ( cb, duration ) {
		var start = performance.now();

		requestAnimationFrame( function animate( time ) {
			var timeFraction = Math.min( 1, ( time - start ) / duration );
			cb( timeFraction );

			if ( timeFraction < 1 ) {
				requestAnimationFrame( animate );
			}
		} );
	};

	/**
	 * Scroll back to top.
	 */
	Scroller.prototype.gotop = function () {
		var blog = document.getElementById( 'infinity-blog-title' );
		var self = this;

		if ( ! blog ) {
			return;
		}

		blog.setAttribute( 'title', totop );
		blog.addEventListener( 'click', function ( e ) {
			var sourceScroll = self.window.pageYOffset;
			e.preventDefault();

			self.animate( function ( progress ) {
				var currentScroll = sourceScroll - sourceScroll * progress;
				document.documentElement.scrollTop = document.body.scrollTop = currentScroll;
			}, 200 );
		} );
	};

	/**
	 * The infinite footer.
	 */
	Scroller.prototype.thefooter = function () {
		var self = this,
			pageWrapper,
			footerContainer,
			width,
			sourceBottom,
			targetBottom,
			footerEnabled = this.footer && this.footer.el;

		if ( ! footerEnabled ) {
			return;
		}

		// Check if we have an id for the page wrapper
		if ( 'string' === typeof this.footer.wrap ) {
			try {
				pageWrapper = document.getElementById( this.footer.wrap );
				width = pageWrapper.getBoundingClientRect();
				width = width.width;
			} catch ( err ) {
				width = 0;
			}

			// Make the footer match the width of the page
			if ( width > 479 ) {
				footerContainer = this.footer.el.querySelector( '.container' );
				if ( footerContainer ) {
					footerContainer.style.width = width + 'px';
				}
			}
		}

		// Reveal footer
		sourceBottom = parseInt( self.footer.el.style.bottom || -50, 10 );
		targetBottom = this.window.pageYOffset >= 350 ? 0 : -50;

		if ( sourceBottom !== targetBottom ) {
			self.animate( function ( progress ) {
				var currentBottom = sourceBottom + ( targetBottom - sourceBottom ) * progress;
				self.footer.el.style.bottom = currentBottom + 'px';

				if ( 1 === progress ) {
					sourceBottom = targetBottom;
				}
			}, 200 );
		}
	};

	/**
	 * Recursively convert a JS object into URL encoded data.
	 */
	Scroller.prototype.urlEncodeJSON = function ( obj, prefix ) {
		var params = [],
			encodedKey,
			newPrefix;

		for ( var key in obj ) {
			encodedKey = encodeURIComponent( key );
			newPrefix = prefix ? prefix + '[' + encodedKey + ']' : encodedKey;

			if ( 'object' === typeof obj[ key ] ) {
				if ( ! Array.isArray( obj[ key ] ) || obj[ key ].length > 0 ) {
					params.push( this.urlEncodeJSON( obj[ key ], newPrefix ) );
				} else {
					// Explicitly expose empty arrays with no values
					params.push( newPrefix + '[]=' );
				}
			} else {
				params.push( newPrefix + '=' + encodeURIComponent( obj[ key ] ) );
			}
		}
		return params.join( '&' );
	};

	/**
	 * Controls the flow of the refresh. Don't mess.
	 */
	Scroller.prototype.refresh = function () {
		var self = this,
			query,
			xhr,
			loader,
			customized;

		// If we're disabled, ready, or don't pass the check, bail.
		if ( this.disabled || ! this.ready || ! this.check() ) {
			return;
		}

		// Let's get going -- set ready to false to prevent
		// multiple refreshes from occurring at once.
		this.ready = false;

		// Create a loader element to show it's working.
		if ( this.click_handle ) {
			if ( ! loader ) {
				document.getElementById( 'infinite-aria' ).textContent = loading_text;
				loader = document.createElement( 'div' );
				loader.classList.add( 'infinite-loader' );
				loader.setAttribute( 'role', 'progress' );
				loader.innerHTML =
					'<div class="spinner"><div class="spinner-inner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>';
			}
			this.element.appendChild( loader );
		}

		// Generate our query vars.
		query = self.extend(
			{
				action: 'infinite_scroll',
			},
			this.query()
		);

		// Inject Customizer state.
		if ( 'undefined' !== typeof wp && wp.customize && wp.customize.settings.theme ) {
			customized = {};
			query.wp_customize = 'on';
			query.theme = wp.customize.settings.theme.stylesheet;
			wp.customize.each( function ( setting ) {
				if ( setting._dirty ) {
					customized[ setting.id ] = setting();
				}
			} );
			query.customized = JSON.stringify( customized );
			query.nonce = wp.customize.settings.nonce.preview;
		}

		// Fire the ajax request.
		xhr = new XMLHttpRequest();
		xhr.open( 'POST', infiniteScroll.settings.ajaxurl, true );
		xhr.setRequestHeader( 'X-Requested-With', 'XMLHttpRequest' );
		xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8' );
		xhr.send( self.urlEncodeJSON( query ) );

		// Allow refreshes to occur again if an error is triggered.
		xhr.onerror = function () {
			if ( self.click_handle && loader.parentNode ) {
				loader.parentNode.removeChild( loader );
			}

			self.ready = true;
		};

		// Success handler
		xhr.onload = function () {
			var response = JSON.parse( xhr.responseText ),
				httpCheck = xhr.status >= 200 && xhr.status < 300,
				responseCheck = 'undefined' !== typeof response.html;

			if ( ! response || ! httpCheck || ! responseCheck ) {
				if ( self.click_handle && loader.parentNode ) {
					loader.parentNode.removeChild( loader );
				}
				return;
			}

			// On success, let's hide the loader circle.
			if ( self.click_handle && loader.parentNode ) {
				loader.parentNode.removeChild( loader );
			}

			// If additional scripts are required by the incoming set of posts, parse them
			if ( response.scripts && Array.isArray( response.scripts ) ) {
				response.scripts.forEach( function ( item ) {
					var elementToAppendTo = item.footer ? 'body' : 'head';

					// Add script handle to list of those already parsed
					window.infiniteScroll.settings.scripts.push( item.handle );

					// Output extra data, if present
					if ( item.extra_data ) {
						self.appendInlineScript( item.extra_data, elementToAppendTo );
					}

					if ( item.before_handle ) {
						self.appendInlineScript( item.before_handle, elementToAppendTo );
					}

					// Build script tag and append to DOM in requested location
					var script = document.createElement( 'script' );
					script.type = 'text/javascript';
					script.src = item.src;
					script.id = item.handle;

					// Dynamically loaded scripts are async by default.
					// We don't want that, it breaks stuff, e.g. wp-mediaelement init.
					script.async = false;

					if ( item.after_handle ) {
						script.onload = function () {
							self.appendInlineScript( item.after_handle, elementToAppendTo );
						};
					}

					// If MediaElement.js is loaded in by item set of posts, don't initialize the players a second time as it breaks them all
					if ( 'wp-mediaelement' === item.handle ) {
						self.body.removeEventListener( 'is.post-load', self.initializeMejs );
					}

					if ( 'wp-mediaelement' === item.handle && 'undefined' === typeof mejs ) {
						self.wpMediaelement = {};
						self.wpMediaelement.tag = script;
						self.wpMediaelement.element = elementToAppendTo;
						setTimeout( self.maybeLoadMejs.bind( self ), 250 );
					} else {
						document.getElementsByTagName( elementToAppendTo )[ 0 ].appendChild( script );
					}
				} );
			}

			// If additional stylesheets are required by the incoming set of posts, parse them
			if ( response.styles && Array.isArray( response.styles ) ) {
				response.styles.forEach( function ( item ) {
					// Add stylesheet handle to list of those already parsed
					window.infiniteScroll.settings.styles.push( item.handle );

					// Build link tag
					var style = document.createElement( 'link' );
					style.rel = 'stylesheet';
					style.href = item.src;
					style.id = item.handle + '-css';

					// Destroy link tag if a conditional statement is present and either the browser isn't IE, or the conditional doesn't evaluate true
					if (
						item.conditional &&
						( ! isIE || ! eval( item.conditional.replace( /%ver/g, IEVersion ) ) )
					) {
						style = false;
					}

					// Append link tag if necessary
					if ( style ) {
						document.getElementsByTagName( 'head' )[ 0 ].appendChild( style );
					}
				} );
			}

			// Convert the response.html to a fragment element.
			// Using a div instead of DocumentFragment, because the latter doesn't support innerHTML.
			response.fragment = document.createElement( 'div' );
			response.fragment.innerHTML = response.html;

			// Increment the page number
			self.page++;

			// Record pageview in WP Stats, if available.
			if ( stats ) {
				new Image().src =
					document.location.protocol +
					'//pixel.wp.com/g.gif?' +
					stats +
					'&post=0&baba=' +
					Math.random();
			}

			// Add new posts to the postflair object
			if ( 'object' === typeof response.postflair && 'object' === typeof WPCOM_sharing_counts ) {
				WPCOM_sharing_counts = self.extend( WPCOM_sharing_counts, response.postflair ); // eslint-disable-line no-global-assign
			}

			// Render the results
			self.render.call( self, response );

			// If 'click' type and there are still posts to fetch, add back the handle
			if ( type == 'click' ) {
				// add focus to new posts, only in button mode as we know where page focus currently is and only if we have a wrapper
				if ( infiniteScroll.settings.wrapper ) {
					document
						.querySelector(
							'#infinite-view-' + ( self.page + self.offset - 1 ) + ' a:first-of-type'
						)
						.focus( {
							preventScroll: true,
						} );
				}

				if ( response.lastbatch ) {
					if ( self.click_handle ) {
						// Update body classes
						self.body.classList.add( 'infinity-end' );
						self.body.classList.remove( 'infinity-success' );
					} else {
						self.trigger( this.body, 'infinite-scroll-posts-end' );
					}
				} else {
					if ( self.click_handle ) {
						self.element.appendChild( self.handle );
					} else {
						self.trigger( this.body, 'infinite-scroll-posts-more' );
					}
				}
			} else if ( response.lastbatch ) {
				self.disabled = true;

				self.body.classList.add( 'infinity-end' );
				self.body.classList.remove( 'infinity-success' );
			}

			// Update currentday to the latest value returned from the server
			if ( response.currentday ) {
				self.currentday = response.currentday;
			}

			// Fire Google Analytics pageview
			if ( self.google_analytics ) {
				var ga_url = self.history.path.replace( /%d/, self.page );
				if ( 'object' === typeof _gaq ) {
					_gaq.push( [ '_trackPageview', ga_url ] );
				}
				if ( 'function' === typeof ga ) {
					ga( 'send', 'pageview', ga_url );
				}
			}
		};

		return xhr;
	};

	/**
	 * Given JavaScript blob and the name of a parent tag, this helper function will
	 * generate a script tag, insert the JavaScript blob, and append it to the parent.
	 *
	 * It's important to note that the JavaScript blob will be evaluated immediately. If
	 * you need a parent script to load first, use that script element's onload handler.
	 *
	 * @param {string} script    The blob of JavaScript to run.
	 * @param {string} parentTag The tag name of the parent element.
	 */
	Scroller.prototype.appendInlineScript = function ( script, parentTag ) {
		var element = document.createElement( 'script' ),
			scriptContent = document.createTextNode( '//<![CDATA[ \n' + script + '\n//]]>' );

		element.type = 'text/javascript';
		element.appendChild( scriptContent );

		document.getElementsByTagName( parentTag )[ 0 ].appendChild( element );
	};

	/**
	 * Core's native media player uses MediaElement.js
	 * The library's size is sufficient that it may not be loaded in time for Core's helper to invoke it, so we need to delay until `mejs` exists.
	 */
	Scroller.prototype.maybeLoadMejs = function () {
		if ( null === this.wpMediaelement ) {
			return;
		}

		if ( 'undefined' === typeof mejs ) {
			setTimeout( this.maybeLoadMejs.bind( this ), 250 );
		} else {
			document
				.getElementsByTagName( this.wpMediaelement.element )[ 0 ]
				.appendChild( this.wpMediaelement.tag );
			this.wpMediaelement = null;

			// Ensure any subsequent IS loads initialize the players
			this.body.addEventListener( 'is.post-load', this.initializeMejs );
		}
	};

	/**
	 * Initialize the MediaElement.js player for any posts not previously initialized
	 */
	Scroller.prototype.initializeMejs = function ( e ) {
		// Are there media players in the incoming set of posts?
		if (
			! e.detail ||
			! e.detail.html ||
			( -1 === e.detail.html.indexOf( 'wp-audio-shortcode' ) &&
				-1 === e.detail.html.indexOf( 'wp-video-shortcode' ) )
		) {
			return;
		}

		// Don't bother if mejs isn't loaded for some reason
		if ( 'undefined' === typeof mejs ) {
			return;
		}

		// Adapted from wp-includes/js/mediaelement/wp-mediaelement.js
		// Modified to not initialize already-initialized players, as Mejs doesn't handle that well
		var settings = {};
		var audioVideoElements;

		if ( typeof _wpmejsSettings !== 'undefined' ) {
			settings.pluginPath = _wpmejsSettings.pluginPath;
		}

		settings.success = function ( mejs ) {
			var autoplay = mejs.attributes.autoplay && 'false' !== mejs.attributes.autoplay;
			if ( 'flash' === mejs.pluginType && autoplay ) {
				mejs.addEventListener(
					'canplay',
					function () {
						mejs.play();
					},
					false
				);
			}
		};

		audioVideoElements = document.querySelectorAll( '.wp-audio-shortcode, .wp-video-shortcode' );
		audioVideoElements = Array.prototype.slice.call( audioVideoElements );

		// Only process already unprocessed shortcodes.
		audioVideoElements = audioVideoElements.filter( function ( el ) {
			while ( el.parentNode ) {
				if ( el.classList.contains( 'mejs-container' ) ) {
					return false;
				}
				el = el.parentNode;
			}
			return true;
		} );

		for ( var i = 0; i < audioVideoElements.length; i++ ) {
			new MediaElementPlayer( audioVideoElements[ i ], settings );
		}
	};

	/**
	 * Get element measurements relative to the viewport.
	 *
	 * @returns {object}
	 */
	Scroller.prototype.measure = function ( element, expandClasses ) {
		expandClasses = expandClasses || [];

		var childrenToTest = Array.prototype.slice.call( element.children );
		var currentChild,
			minTop = Number.MAX_VALUE,
			maxBottom = 0,
			currentChildRect,
			i;

		while ( childrenToTest.length > 0 ) {
			currentChild = childrenToTest.shift();

			for ( i = 0; i < expandClasses.length; i++ ) {
				// Expand (= measure) child elements of nodes with class names from expandClasses.
				if ( currentChild.classList.contains( expandClasses[ i ] ) ) {
					childrenToTest = childrenToTest.concat(
						Array.prototype.slice.call( currentChild.children )
					);
					break;
				}
			}
			currentChildRect = currentChild.getBoundingClientRect();

			minTop = Math.min( minTop, currentChildRect.top );
			maxBottom = Math.max( maxBottom, currentChildRect.bottom );
		}

		var viewportMiddle = Math.round( window.innerHeight / 2 );

		// isActive = does the middle of the viewport cross the element?
		var isActive = minTop <= viewportMiddle && maxBottom >= viewportMiddle;

		/**
		 * Factor = percentage of viewport above the middle line occupied by the element.
		 *
		 * Negative factors are assigned for elements below the middle line. That's on purpose
		 * to only allow "page 2" to change the URL once it's in the middle of the viewport.
		 */
		var factor = ( Math.min( maxBottom, viewportMiddle ) - Math.max( minTop, 0 ) ) / viewportMiddle;

		return {
			top: minTop,
			bottom: maxBottom,
			height: maxBottom - minTop,
			factor: factor,
			isActive: isActive,
		};
	};

	/**
	 * Trigger IS to load additional posts if the initial posts don't fill the window.
	 *
	 * On large displays, or when posts are very short, the viewport may not be filled with posts,
	 * so we overcome this by loading additional posts when IS initializes.
	 */
	Scroller.prototype.ensureFilledViewport = function () {
		var self = this,
			windowHeight = self.window.innerHeight,
			wrapperMeasurements = self.measure( self.element, [ self.wrapperClass ] );

		// Only load more posts once. This prevents infinite loops when there are no more posts.
		self.body.removeEventListener( 'is.post-load', self.checkViewportOnLoadBound );

		// Load more posts if space permits, otherwise stop checking for a full viewport.
		if ( wrapperMeasurements.bottom !== 0 && wrapperMeasurements.bottom < windowHeight ) {
			self.ready = true;
			self.refresh();
		}
	};

	/**
	 * Event handler for ensureFilledViewport(), tied to the post-load trigger.
	 * Necessary to ensure that the variable `this` contains the scroller when used in ensureFilledViewport(). Since this function is tied to an event, `this` becomes the DOM element the event is tied to.
	 */
	Scroller.prototype.checkViewportOnLoad = function () {
		this.ensureFilledViewport();
	};

	function fullscreenState() {
		return document.fullscreenElement ||
			document.mozFullScreenElement ||
			document.webkitFullscreenElement ||
			document.msFullscreenElement
			? 1
			: 0;
	}

	var previousFullScrenState = fullscreenState();

	/**
	 * Identify archive page that corresponds to majority of posts shown in the current browser window.
	 */
	Scroller.prototype.determineURL = function () {
		var self = this,
			pageNum = -1,
			currentFullScreenState = fullscreenState(),
			wrapperEls,
			maxFactor = 0;

		// xor - check if the state has changed
		if ( previousFullScrenState ^ currentFullScreenState ) {
			// If we just switched to/from fullscreen,
			// don't do the div clearing/caching or the
			// URL setting. Doing so can break video playback
			// if the video goes to fullscreen.

			previousFullScrenState = currentFullScreenState;
			return;
		}
		previousFullScrenState = currentFullScreenState;
		wrapperEls = document.querySelectorAll( '.' + self.wrapperClass );

		for ( var i = 0; i < wrapperEls.length; i++ ) {
			var setMeasurements = self.measure( wrapperEls[ i ] );

			// If it exists, pick a set that is crossed by the middle of the viewport.
			if ( setMeasurements.isActive ) {
				pageNum = parseInt( wrapperEls[ i ].dataset.pageNum, 10 );
				break;
			}

			// If there is such a set, pick the one that occupies the most space
			// above the middle of the viewport.
			if ( setMeasurements.factor > maxFactor ) {
				pageNum = parseInt( wrapperEls[ i ].dataset.pageNum, 10 );
				maxFactor = setMeasurements.factor;
			}

			// Otherwise default to -1
		}

		self.updateURL( pageNum );
	};

	/**
	 * Update address bar to reflect archive page URL for a given page number.
	 * Checks if URL is different to prevent pollution of browser history.
	 */
	Scroller.prototype.updateURL = function ( page ) {
		// IE only supports pushState() in v10 and above, so don't bother if those conditions aren't met.
		if ( ! window.history.pushState ) {
			return;
		}
		var self = this,
			pageSlug = self.origURL;

		if ( -1 !== page ) {
			pageSlug =
				window.location.protocol +
				'//' +
				self.history.host +
				self.history.path.replace( /%d/, page ) +
				self.history.parameters;
		}

		if ( window.location.href != pageSlug ) {
			history.pushState( null, null, pageSlug );
		}
	};

	/**
	 * Pause scrolling.
	 */
	Scroller.prototype.pause = function () {
		this.disabled = true;
	};

	/**
	 * Resume scrolling.
	 */
	Scroller.prototype.resume = function () {
		this.disabled = false;
	};

	/**
	 * Emits custom JS events.
	 *
	 * @param {Node}   el
	 * @param {string} eventName
	 * @param {*}      data
	 */
	Scroller.prototype.trigger = function ( el, eventName, opts ) {
		opts = opts || {};

		/**
		 * Emit the event in a jQuery way for backwards compatibility where necessary.
		 */
		if ( opts.jqueryEventName && 'undefined' !== typeof jQuery ) {
			jQuery( el ).trigger( opts.jqueryEventName, opts.data || null );
		}

		/**
		 * Emit the event in a standard way.
		 */
		var e;
		try {
			e = new CustomEvent( eventName, {
				bubbles: true,
				cancelable: true,
				detail: opts.data || null,
			} );
		} catch ( err ) {
			e = document.createEvent( 'CustomEvent' );
			e.initCustomEvent( eventName, true, true, opts.data || null );
		}
		el.dispatchEvent( e );
	};

	/**
	 * Ready, set, go!
	 */
	var jetpackInfinityModule = function () {
		var bodyClasses = infiniteScroll.settings.body_class.split( ' ' );

		// Check for our variables
		if ( 'object' !== typeof infiniteScroll ) {
			return;
		}

		bodyClasses.forEach( function ( className ) {
			if ( className ) {
				document.body.classList.add( className );
			}
		} );

		// Set ajaxurl (for brevity)
		ajaxurl = infiniteScroll.settings.ajaxurl;

		// Set stats, used for tracking stats
		stats = infiniteScroll.settings.stats;

		// Define what type of infinity we have, grab text for click-handle
		type = infiniteScroll.settings.type;
		text = infiniteScroll.settings.text;
		totop = infiniteScroll.settings.totop;

		// aria text
		loading_text = infiniteScroll.settings.loading_text;

		// Initialize the scroller (with the ID of the element from the theme)
		infiniteScroll.scroller = new Scroller( infiniteScroll.settings );

		/**
		 * Monitor user scroll activity to update URL to correspond to archive page for current set of IS posts
		 */
		if ( type == 'click' ) {
			var timer = null;
			window.addEventListener( 'scroll', function () {
				// run the real scroll handler once every 250 ms.
				if ( timer ) {
					return;
				}
				timer = setTimeout( function () {
					infiniteScroll.scroller.determineURL();
					timer = null;
				}, 250 );
			} );
		}
	};

	/**
	 * Ready, set, go!
	 */
	if ( document.readyState === 'interactive' || document.readyState === 'complete' ) {
		jetpackInfinityModule();
	} else {
		document.addEventListener( 'DOMContentLoaded', jetpackInfinityModule );
	}
} )(); // Close closure
infinity.php                                                                                                                                                                                                                                                   69197         1711191384  plugins/jetpack/modules/infinite-scroll                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName

// phpcs:disable Universal.Files.SeparateFunctionsFromOO.Mixed -- TODO: Move classes to appropriately-named class files.

use Automattic\Jetpack\Assets;
use Automattic\Jetpack\Redirect;

/*
Plugin Name: The Neverending Home Page.
Plugin URI: https://automattic.com/
Description: Adds infinite scrolling support to the front-end blog post view for themes, pulling the next set of posts automatically into view when the reader approaches the bottom of the page.
Version: 1.1
Author: Automattic
Author URI: https://automattic.com/
License: GNU General Public License v2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html
Text Domain: jetpack
*/

/**
 * Class: The_Neverending_Home_Page relies on add_theme_support, expects specific
 * styling from each theme; including fixed footer.
 */
class The_Neverending_Home_Page {
	/**
	* Maximum allowed number of posts per page in $_REQUEST.
	*/
	const MAX_ALLOWED_POSTS_PER_PAGE_ΙΝ_REQUEST = 5000;

	/**
	 * Register actions and filters, plus parse IS settings
	 *
	 * @uses add_action, add_filter, self::get_settings
	 */
	public function __construct() {
		add_action( 'pre_get_posts', array( $this, 'posts_per_page_query' ) );
		add_action( 'admin_init', array( $this, 'settings_api_init' ) );
		add_action( 'template_redirect', array( $this, 'action_template_redirect' ) );
		add_action( 'customize_preview_init', array( $this, 'init_customizer_assets' ) );
		add_action( 'template_redirect', array( $this, 'ajax_response' ) );
		add_action( 'custom_ajax_infinite_scroll', array( $this, 'query' ) );
		add_filter( 'infinite_scroll_query_args', array( $this, 'inject_query_args' ) );
		add_filter( 'infinite_scroll_allowed_vars', array( $this, 'allowed_query_vars' ) );
		add_action( 'the_post', array( $this, 'preserve_more_tag' ) );
		add_action( 'wp_footer', array( $this, 'footer' ) );
		add_filter( 'infinite_scroll_additional_scripts', array( $this, 'add_mejs_config' ) );

		// Plugin compatibility
		add_filter( 'grunion_contact_form_redirect_url', array( $this, 'filter_grunion_redirect_url' ) );

		// AMP compatibility
		// needs to happen after parse_query so that Jetpack_AMP_Support::is_amp_request() is ready.
		add_action( 'wp', array( $this, 'amp_load_hooks' ) );

		// Parse IS settings from theme
		self::get_settings();
	}

	/**
	 * Initialize our static variables
	 */

	/**
	 * The time.
	 *
	 * @var null - I don't think this is used?
	 */
	public static $the_time = null;

	/**
	 * Settings.
	 *
	 * Don't access directly, instead use self::get_settings().
	 *
	 * @var array
	 */
	public static $settings = null;

	/**
	 * The enabled option name.
	 *
	 * @var string
	 */
	public static $option_name_enabled = 'infinite_scroll';

	/**
	 * Parse IS settings provided by theme
	 *
	 * @uses get_theme_support, infinite_scroll_has_footer_widgets, sanitize_title, add_action, get_option, wp_parse_args, is_active_sidebar
	 * @return object
	 */
	public static function get_settings() {
		if ( self::$settings === null ) {
			$css_pattern = '#[^A-Z\d\-_]#i';

			$defaults = array(
				'type'            => 'scroll', // scroll | click
				'requested_type'  => 'scroll', // store the original type for use when logic overrides it
				'footer_widgets'  => false, // true | false | sidebar_id | array of sidebar_ids -- last two are checked with is_active_sidebar
				'container'       => 'content', // container html id
				'wrapper'         => true, // true | false | html class -- the html class.
				'render'          => false, // optional function, otherwise the `content` template part will be used
				'footer'          => true, // boolean to enable or disable the infinite footer | string to provide an html id to derive footer width from
				'footer_callback' => false, // function to be called to render the IS footer, in place of the default
				'posts_per_page'  => false, // phpcs:ignore WordPress.WP.PostsPerPage.posts_per_page_posts_per_page -- int | false to set based on IS type
				'click_handle'    => true, // boolean to enable or disable rendering the click handler div. If type is click and this is false, page must include its own trigger with the HTML ID `infinite-handle`.
			);
			$settings = $defaults;
			// Validate settings passed through add_theme_support()
			$_settings = get_theme_support( 'infinite-scroll' );

			if ( is_array( $_settings ) ) {
				// Preferred implementation, where theme provides an array of options
				if ( isset( $_settings[0] ) && is_array( $_settings[0] ) ) {
					foreach ( $_settings[0] as $key => $value ) {
						switch ( $key ) {
							case 'type':
								if ( in_array( $value, array( 'scroll', 'click' ), true ) ) {
									$settings['requested_type'] = $value;
									$settings[ $key ]           = $settings['requested_type'];
								}

								break;

							case 'footer_widgets':
								if ( is_string( $value ) ) {
									$settings[ $key ] = sanitize_title( $value );
								} elseif ( is_array( $value ) ) {
									$settings[ $key ] = array_map( 'sanitize_title', $value );
								} elseif ( is_bool( $value ) ) {
									$settings[ $key ] = $value;
								}

								break;

							case 'container':
							case 'wrapper':
								if ( 'wrapper' === $key && is_bool( $value ) ) {
									$settings[ $key ] = $value;
								} else {
									$value = preg_replace( $css_pattern, '', $value );

									if ( ! empty( $value ) ) {
										$settings[ $key ] = $value;
									}
								}

								break;

							case 'render':
								if ( false !== $value && is_callable( $value ) ) {
									$settings[ $key ] = $value;
								}

								break;

							case 'footer':
								if ( is_bool( $value ) ) {
									$settings[ $key ] = $value;
								} elseif ( is_string( $value ) ) {
									$value = preg_replace( $css_pattern, '', $value );

									if ( ! empty( $value ) ) {
										$settings[ $key ] = $value;
									}
								}

								break;

							case 'footer_callback':
								if ( is_callable( $value ) ) {
									$settings[ $key ] = $value;
								} else {
									$settings[ $key ] = false;
								}

								break;

							case 'posts_per_page':
								if ( is_numeric( $value ) ) {
									$settings[ $key ] = (int) $value;
								}

								break;

							case 'click_handle':
								if ( is_bool( $value ) ) {
									$settings[ $key ] = $value;
								}

								break;

							default:
								break;
						}
					}
				} elseif ( is_string( $_settings[0] ) ) {
					// Checks below are for backwards compatibility

					// Container to append new posts to
					$settings['container'] = preg_replace( $css_pattern, '', $_settings[0] );

					// Wrap IS elements?
					if ( isset( $_settings[1] ) ) {
						$settings['wrapper'] = (bool) $_settings[1];
					}
				}
			}

			// Always ensure all values are present in the final array
			$settings = wp_parse_args( $settings, $defaults );

			// Check if a legacy `infinite_scroll_has_footer_widgets()` function is defined and override the footer_widgets parameter's value.
			// Otherwise, if a widget area ID or array of IDs was provided in the footer_widgets parameter, check if any contains any widgets.
			// It is safe to use `is_active_sidebar()` before the sidebar is registered as this function doesn't check for a sidebar's existence when determining if it contains any widgets.
			if ( function_exists( 'infinite_scroll_has_footer_widgets' ) ) {
				$settings['footer_widgets'] = (bool) infinite_scroll_has_footer_widgets();
			} elseif ( is_array( $settings['footer_widgets'] ) ) {
				$sidebar_ids                = $settings['footer_widgets'];
				$settings['footer_widgets'] = false;

				foreach ( $sidebar_ids as $sidebar_id ) {
					if ( is_active_sidebar( $sidebar_id ) ) {
						$settings['footer_widgets'] = true;
						break;
					}
				}

				unset( $sidebar_ids );
				unset( $sidebar_id );
			} elseif ( is_string( $settings['footer_widgets'] ) ) {
				$settings['footer_widgets'] = (bool) is_active_sidebar( $settings['footer_widgets'] );
			}

			/**
			 * Filter Infinite Scroll's `footer_widgets` parameter.
			 *
			 * @module infinite-scroll
			 *
			 * @since 2.0.0
			 *
			 * @param bool $settings['footer_widgets'] Does the current theme have Footer Widgets.
			 */
			$settings['footer_widgets'] = apply_filters( 'infinite_scroll_has_footer_widgets', $settings['footer_widgets'] );

			// Finally, after all of the sidebar checks and filtering, ensure that a boolean value is present, otherwise set to default of `false`.
			if ( ! is_bool( $settings['footer_widgets'] ) ) {
				$settings['footer_widgets'] = false;
			}

			// Ensure that IS is enabled and no footer widgets exist if the IS type isn't already "click".
			if ( 'click' !== $settings['type'] ) {
				// Check the setting status
				$disabled = '' === get_option( self::$option_name_enabled ) ? true : false;

				// Footer content or Reading option check
				if ( $settings['footer_widgets'] || $disabled ) {
					$settings['type'] = 'click';
				}
			}

			// Force display of the click handler and attendant bits when the type isn't `click`
			if ( 'click' !== $settings['type'] ) {
				$settings['click_handle'] = true;
			}

			// Store final settings in a class static to avoid reparsing
			/**
			 * Filter the array of Infinite Scroll settings.
			 *
			 * @module infinite-scroll
			 *
			 * @since 2.0.0
			 *
			 * @param array $settings Array of Infinite Scroll settings.
			 */
			self::$settings = apply_filters( 'infinite_scroll_settings', $settings );
		}

		/** This filter is already documented in modules/infinite-scroll/infinity.php */
		return (object) apply_filters( 'infinite_scroll_settings', self::$settings );
	}

	/**
	 * Number of posts per page.
	 *
	 * @uses self::wp_query, self::get_settings, apply_filters
	 * @return int
	 */
	public static function posts_per_page() {
		$posts_per_page             = self::get_settings()->posts_per_page ? self::get_settings()->posts_per_page : self::wp_query()->get( 'posts_per_page' );
		$posts_per_page_core_option = get_option( 'posts_per_page' );

		// If Infinite Scroll is set to click, and if the site owner changed posts_per_page, let's use that.
		if (
			'click' === self::get_settings()->type
				&& ( '10' !== $posts_per_page_core_option )
		) {
			$posts_per_page = $posts_per_page_core_option;
		}

		// Take JS query into consideration here.
		$posts_per_page_in_request = isset( $_REQUEST['query_args']['posts_per_page'] ) ? (int) $_REQUEST['query_args']['posts_per_page'] : 0; // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		if ( $posts_per_page_in_request > 0 &&
			self::MAX_ALLOWED_POSTS_PER_PAGE_ΙΝ_REQUEST >= $posts_per_page_in_request
		) {
			$posts_per_page = $posts_per_page_in_request;
		}

		/**
		 * Filter the number of posts per page.
		 *
		 * @module infinite-scroll
		 *
		 * @since 6.0.0
		 *
		 * @param int $posts_per_page The number of posts to display per page.
		 */
		return (int) apply_filters( 'infinite_scroll_posts_per_page', $posts_per_page );
	}

	/**
	 * Retrieve the query used with Infinite Scroll
	 *
	 * @global $wp_the_query
	 * @uses apply_filters
	 * @return object
	 */
	public static function wp_query() {
		global $wp_the_query;
		/**
		 * Filter the Infinite Scroll query object.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.2.1
		 *
		 * @param WP_Query $wp_the_query WP Query.
		 */
		return apply_filters( 'infinite_scroll_query_object', $wp_the_query );
	}

	/**
	 * Has infinite scroll been triggered?
	 */
	public static function got_infinity() {
		/**
		 * Filter the parameter used to check if Infinite Scroll has been triggered.
		 *
		 * @module infinite-scroll
		 *
		 * @since 3.9.0
		 *
		 * @param bool isset( $_GET[ 'infinity' ] ) Return true if the "infinity" parameter is set.
		 */
		return apply_filters( 'infinite_scroll_got_infinity', isset( $_GET['infinity'] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no changes made to the site.
	}

	/**
	 * Is this guaranteed to be the last batch of posts?
	 */
	public static function is_last_batch() {
		/**
		 * Override whether or not this is the last batch for a request
		 *
		 * @module infinite-scroll
		 *
		 * @since 4.8.0
		 *
		 * @param bool|null null                 Bool if value should be overridden, null to determine from query
		 * @param object    self::wp_query()     WP_Query object for current request
		 * @param object    self::get_settings() Infinite Scroll settings
		 */
		$override = apply_filters( 'infinite_scroll_is_last_batch', null, self::wp_query(), self::get_settings() ); // phpcs:ignore WordPress.WP.ClassNameCase.Incorrect -- False positive.
		if ( is_bool( $override ) ) {
			return $override;
		}

		$entries        = (int) self::wp_query()->found_posts;
		$posts_per_page = self::posts_per_page();

		// This is to cope with an issue in certain themes or setups where posts are returned but found_posts is 0.
		if ( 0 === $entries ) {
			return (bool) ( ! is_countable( self::wp_query()->posts ) || ( count( self::wp_query()->posts ) < $posts_per_page ) );
		}
		$paged = max( 1, self::wp_query()->get( 'paged' ) );

		// Are there enough posts for more than the first page?
		if ( $entries <= $posts_per_page ) {
			return true;
		}

		// Calculate entries left after a certain number of pages
		if ( $paged && $paged > 1 ) {
			$entries -= $posts_per_page * $paged;
		}

		// Are there some entries left to display?
		return $entries <= 0;
	}

	/**
	 * The more tag will be ignored by default if the blog page isn't our homepage.
	 * Let's force the $more global to false.
	 *
	 * @param array $array - the_post array.
	 * @return array
	 */
	public function preserve_more_tag( $array ) {
		global $more;

		if ( self::got_infinity() ) {
			$more = 0; // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited -- 0 = show content up to the more tag. Add more link.
		}

		return $array;
	}

	/**
	 * Add a checkbox field to Settings > Reading
	 * for enabling infinite scroll.
	 *
	 * Only show if the current theme supports infinity.
	 *
	 * @uses current_theme_supports, add_settings_field, __, register_setting
	 * @action admin_init
	 * @return null
	 */
	public function settings_api_init() {
		if ( ! current_theme_supports( 'infinite-scroll' ) ) {
			return;
		}

		if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
			// This setting is no longer configurable in wp-admin on WordPress.com -- leave a pointer
			add_settings_field(
				self::$option_name_enabled,
				'<span id="infinite-scroll-options">' . esc_html__( 'Infinite Scroll Behavior', 'jetpack' ) . '</span>',
				array( $this, 'infinite_setting_html_calypso_placeholder' ),
				'reading'
			);
			return;
		}

		// Add the setting field [infinite_scroll] and place it in Settings > Reading
		add_settings_field( self::$option_name_enabled, '<span id="infinite-scroll-options">' . esc_html__( 'Infinite Scroll Behavior', 'jetpack' ) . '</span>', array( $this, 'infinite_setting_html' ), 'reading' );
		register_setting( 'reading', self::$option_name_enabled, 'esc_attr' );
	}

	/**
	 * Render the redirect link to the infinite scroll settings in Calypso.
	 */
	public function infinite_setting_html_calypso_placeholder() {
		$details     = get_blog_details();
		$writing_url = Redirect::get_url( 'calypso-settings-writing', array( 'site' => $details->domain ) );
		echo '<span>' . sprintf(
			/* translators: Variables are the enclosing link to the settings page */
			esc_html__( 'This option has moved. You can now manage it %1$shere%2$s.', 'jetpack' ),
			'<a href="' . esc_url( $writing_url ) . '">',
			'</a>'
		) . '</span>';
	}

	/**
	 * HTML code to display a checkbox true/false option
	 * for the infinite_scroll setting.
	 */
	public function infinite_setting_html() {

		// If the blog has footer widgets, show a notice instead of the checkbox
		if ( self::get_settings()->footer_widgets || 'click' === self::get_settings()->requested_type ) {
			echo '<label><em>' . esc_html__( 'We&rsquo;ve changed this option to a click-to-scroll version for you since you have footer widgets in Appearance &rarr; Widgets, or your theme uses click-to-scroll as the default behavior.', 'jetpack' ) . '</em></label>';
		} else {
			echo '<label><input name="infinite_scroll" type="checkbox" value="1" ' . checked( 1, '' !== get_option( self::$option_name_enabled ), false ) . ' /> ' . esc_html__( 'Check to load posts as you scroll. Uncheck to show clickable button to load posts', 'jetpack' ) . '</label>';
			// translators: the number of posts to show on each page load.
			echo '<p class="description">' . esc_html( sprintf( _n( 'Shows %s post on each load.', 'Shows %s posts on each load.', self::posts_per_page(), 'jetpack' ), number_format_i18n( self::posts_per_page() ) ) ) . '</p>';
		}
	}

	/**
	 * Does the legwork to determine whether the feature is enabled.
	 *
	 * @uses current_theme_supports, self::archive_supports_infinity, self::get_settings, add_filter, wp_enqueue_script, plugins_url, wp_enqueue_style, add_action
	 * @action template_redirect
	 * @return null
	 */
	public function action_template_redirect() {
		// Check that we support infinite scroll, and are on the home page.
		if ( ! current_theme_supports( 'infinite-scroll' ) || ! self::archive_supports_infinity() ) {
			return;
		}

		$id = self::get_settings()->container;

		// Check that we have an id.
		if ( empty( $id ) ) {
			return;
		}

		// AMP infinite scroll functionality will start on amp_load_hooks().
		if ( class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request() ) {
			return;
		}

		// Add our scripts.
		wp_register_script(
			'the-neverending-homepage',
			Assets::get_file_url_for_environment(
				'_inc/build/infinite-scroll/infinity.min.js',
				'modules/infinite-scroll/infinity.js'
			),
			array(),
			JETPACK__VERSION . '-is5.0.1', // Added for ability to cachebust on WP.com.
			true
		);

		// Add our default styles.
		wp_register_style( 'the-neverending-homepage', plugins_url( 'infinity.css', __FILE__ ), array(), '20140422' );

		// Make sure there are enough posts for IS
		if ( self::is_last_batch() ) {
			return;
		}

		// Add our scripts.
		wp_enqueue_script( 'the-neverending-homepage' );

		// Add our default styles.
		wp_enqueue_style( 'the-neverending-homepage' );

		add_action( 'wp_footer', array( $this, 'action_wp_footer_settings' ), 2 );

		add_action( 'wp_footer', array( $this, 'action_wp_footer' ), 21 ); // Core prints footer scripts at priority 20, so we just need to be one later than that

		add_filter( 'infinite_scroll_results', array( $this, 'filter_infinite_scroll_results' ), 10, 3 );
	}

	/**
	 * Initialize the Customizer logic separately from the main JS.
	 *
	 * @since 8.4.0
	 */
	public function init_customizer_assets() {
		// Add our scripts.
		wp_register_script(
			'the-neverending-homepage-customizer',
			Assets::get_file_url_for_environment(
				'_inc/build/infinite-scroll/infinity-customizer.min.js',
				'modules/infinite-scroll/infinity-customizer.js'
			),
			array( 'jquery', 'customize-base' ),
			JETPACK__VERSION . '-is5.0.0', // Added for ability to cachebust on WP.com.
			true
		);

		wp_enqueue_script( 'the-neverending-homepage-customizer' );
	}

	/**
	 * Returns classes to be added to <body>. If it's enabled, 'infinite-scroll'. If set to continuous scroll, adds 'neverending' too.
	 *
	 * @since 4.7.0 No longer added as a 'body_class' filter but passed to JS environment and added using JS.
	 *
	 * @return string
	 */
	public function body_class() {
		$classes = '';
		// Do not add infinity-scroll class if disabled through the Reading page
		$disabled = '' === get_option( self::$option_name_enabled ) ? true : false;
		if ( ! $disabled || 'click' === self::get_settings()->type ) {
			$classes = 'infinite-scroll';

			if ( 'scroll' === self::get_settings()->type ) {
				$classes .= ' neverending';
			}
		}

		return $classes;
	}

	/**
	 * In case IS is activated on search page, we have to exclude initially loaded posts which match the keyword by title, not the content as they are displayed before content-matching ones
	 *
	 * @uses self::wp_query
	 * @uses self::get_last_post_date
	 * @uses self::has_only_title_matching_posts
	 * @return array
	 */
	public function get_excluded_posts() {

		$excluded_posts = array();
		// loop through posts returned by wp_query call
		foreach ( self::wp_query()->get_posts() as $post ) {

			$orderby   = isset( self::wp_query()->query_vars['orderby'] ) ? self::wp_query()->query_vars['orderby'] : '';
			$post_date = ( ! empty( $post->post_date ) ? $post->post_date : false );
			if ( 'modified' === $orderby || false === $post_date ) {
				$post_date = $post->post_modified;
			}

			// in case all posts initially displayed match the keyword by title we add em all to excluded posts array
			// else, we add only posts which are older than last_post_date param as newer are natually excluded by last_post_date condition in the SQL query
			if ( self::has_only_title_matching_posts() || $post_date <= self::get_last_post_date() ) {
				array_push( $excluded_posts, $post->ID );
			}
		}
		return $excluded_posts;
	}

	/**
	 * In case IS is active on search, we have to exclude posts matched by title rather than by post_content in order to prevent dupes on next pages
	 *
	 * @uses self::wp_query
	 * @uses self::get_excluded_posts
	 * @return array
	 */
	public function get_query_vars() {

		$query_vars = self::wp_query()->query_vars;
		// applies to search page only
		if ( true === self::wp_query()->is_search() ) {
			// set post__not_in array in query_vars in case it does not exists
			if ( false === isset( $query_vars['post__not_in'] ) ) {
				$query_vars['post__not_in'] = array();
			}
			// get excluded posts
			$excluded = self::get_excluded_posts();
			// merge them with other post__not_in posts (eg.: sticky posts)
			$query_vars['post__not_in'] = array_merge( $query_vars['post__not_in'], $excluded );
		}
		return $query_vars;
	}

	/**
	 * This function checks whether all posts returned by initial wp_query match the keyword by title
	 * The code used in this function is borrowed from WP_Query class where it is used to construct like conditions for keywords
	 *
	 * @uses self::wp_query
	 * @return bool
	 */
	public function has_only_title_matching_posts() {

		// apply following logic for search page results only
		if ( false === self::wp_query()->is_search() ) {
			return false;
		}

		// grab the last posts in the stack as if the last one is title-matching the rest is title-matching as well
		$post = end( self::wp_query()->posts );

		// code inspired by WP_Query class
		if ( preg_match_all( '/".*?("|$)|((?<=[\t ",+])|^)[^\t ",+]+/', self::wp_query()->get( 's' ), $matches ) ) {
			$search_terms = self::wp_query()->query_vars['search_terms'];
			// if the search string has only short terms or stopwords, or is 10+ terms long, match it as sentence
			if ( empty( $search_terms ) || ! is_countable( $search_terms ) || count( $search_terms ) > 9 ) {
				$search_terms = array( self::wp_query()->get( 's' ) );
			}
		} else {
			$search_terms = array( self::wp_query()->get( 's' ) );
		}

		// actual testing. As search query combines multiple keywords with AND, it's enough to check if any of the keywords is present in the title
		$term = current( $search_terms );
		if ( ! empty( $term ) && str_contains( $post->post_title, $term ) ) {
			return true;
		}

		return false;
	}

	/**
	 * Grab the timestamp for the initial query's last post.
	 *
	 * This takes into account the query's 'orderby' parameter and returns
	 * false if the posts are not ordered by date.
	 *
	 * @uses self::got_infinity
	 * @uses self::has_only_title_matching_posts
	 * @uses self::wp_query
	 * @return string 'Y-m-d H:i:s' or false
	 */
	public function get_last_post_date() {
		if ( self::got_infinity() ) {
			return;
		}

		if ( ! self::wp_query()->have_posts() ) {
			return null;
		}

		// In case there are only title-matching posts in the initial WP_Query result, we don't want to use the last_post_date param yet
		if ( true === self::has_only_title_matching_posts() ) {
			return false;
		}

		$post      = end( self::wp_query()->posts );
		$orderby   = isset( self::wp_query()->query_vars['orderby'] ) ?
			self::wp_query()->query_vars['orderby'] : '';
		$post_date = ( ! empty( $post->post_date ) ? $post->post_date : false );
		switch ( $orderby ) {
			case 'modified':
				return $post->post_modified;
			case 'date':
			case '':
				return $post_date;
			default:
				return false;
		}
	}

	/**
	 * Returns the appropriate `wp_posts` table field for a given query's
	 * 'orderby' parameter, if applicable.
	 *
	 * @param object $query - an optional query object.
	 * @uses self::wp_query
	 * @return string or false
	 */
	public function get_query_sort_field( $query = null ) {
		if ( empty( $query ) ) {
			$query = self::wp_query();
		}

		$orderby = isset( $query->query_vars['orderby'] ) ? $query->query_vars['orderby'] : '';

		switch ( $orderby ) {
			case 'modified':
				return 'post_modified';
			case 'date':
			case '':
				return 'post_date';
			default:
				return false;
		}
	}

	/**
	 * Create a where clause that will make sure post queries return posts
	 * in the correct order, without duplicates, if a new post is added
	 * and we're sorting by post date.
	 *
	 * @global $wpdb
	 * @param string $where - the where clause.
	 * @param object $query - the query.
	 * @uses apply_filters
	 * @filter posts_where
	 * @return string
	 */
	public function query_time_filter( $where, $query ) {
		if ( self::got_infinity() ) {
			global $wpdb;

			$sort_field = self::get_query_sort_field( $query );

			if ( 'post_date' !== $sort_field || 'DESC' !== $_REQUEST['query_args']['order'] ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotValidated -- no changes made to the site.
				return $where;
			}

			$query_before = sanitize_text_field( wp_unslash( $_REQUEST['query_before'] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotValidated -- no changes made to the site.

			if ( empty( $query_before ) ) {
				return $where;
			}

			// Construct the date query using our timestamp
			$clause = $wpdb->prepare( " AND {$wpdb->posts}.post_date <= %s", $query_before );

			/**
			 * Filter Infinite Scroll's SQL date query making sure post queries
			 * will always return results prior to (descending sort)
			 * or before (ascending sort) the last post date.
			 *
			 * @module infinite-scroll
			 *
			 * @param string $clause SQL Date query.
			 * @param object $query Query.
			 * @param string $operator @deprecated Query operator.
			 * @param string $last_post_date @deprecated Last Post Date timestamp.
			 */
			$operator       = 'ASC' === $_REQUEST['query_args']['order'] ? '>' : '<'; // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotValidated -- no changes to the site.
			$last_post_date = sanitize_text_field( wp_unslash( $_REQUEST['last_post_date'] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotValidated -- no changes to the site.
			$where         .= apply_filters( 'infinite_scroll_posts_where', $clause, $query, $operator, $last_post_date );
		}

		return $where;
	}

	/**
	 * Let's overwrite the default post_per_page setting to always display a fixed amount.
	 *
	 * @param object $query - the query.
	 * @uses is_admin, self::archive_supports_infinity, self::get_settings
	 */
	public function posts_per_page_query( $query ) {
		if ( ! is_admin() && self::archive_supports_infinity() && $query->is_main_query() ) {
			$query->set( 'posts_per_page', self::posts_per_page() );
		}
	}

	/**
	 * Check if the IS output should be wrapped in a div.
	 * Setting value can be a boolean or a string specifying the class applied to the div.
	 *
	 * @uses self::get_settings
	 * @return bool
	 */
	public function has_wrapper() {
		return (bool) self::get_settings()->wrapper;
	}

	/**
	 * Returns the Ajax url
	 *
	 * @global $wp
	 * @uses home_url, add_query_arg, apply_filters
	 * @return string
	 */
	public function ajax_url() {
		$base_url = set_url_scheme( home_url( '/' ) );

		$ajaxurl = add_query_arg( array( 'infinity' => 'scrolling' ), $base_url );

		/**
		 * Filter the Infinite Scroll Ajax URL.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 *
		 * @param string $ajaxurl Infinite Scroll Ajax URL.
		 */
		return apply_filters( 'infinite_scroll_ajax_url', $ajaxurl );
	}

	/**
	 * Our own Ajax response, avoiding calling admin-ajax
	 */
	public function ajax_response() {
		// Only proceed if the url query has a key of "Infinity"
		if ( ! self::got_infinity() ) {
			return false;
		}

		// This should already be defined below, but make sure.
		if ( ! defined( 'DOING_AJAX' ) ) {
			define( 'DOING_AJAX', true );
		}

		@header( 'Content-Type: text/html; charset=' . get_option( 'blog_charset' ) ); // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
		send_nosniff_header();

		/**
		 * Fires at the end of the Infinite Scroll Ajax response.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 */
		do_action( 'custom_ajax_infinite_scroll' );
		die( '0' );
	}

	/**
	 * Alias for renamed class method.
	 *
	 * Previously, JS settings object was unnecessarily output in the document head.
	 * When the hook was changed, the method name no longer made sense.
	 */
	public function action_wp_head() {
		$this->action_wp_footer_settings();
	}

	/**
	 * Prints the relevant infinite scroll settings in JS.
	 *
	 * @global $wp_rewrite
	 * @uses self::get_settings, esc_js, esc_url_raw, self::has_wrapper, __, apply_filters, do_action, self::get_query_vars
	 * @action wp_footer
	 */
	public function action_wp_footer_settings() {
		global $wp_rewrite;
		global $currentday;

		// Default click handle text
		$click_handle_text = __( 'Older posts', 'jetpack' );

		// If a single CPT is displayed, use its plural name instead of "posts"
		// Could be empty (posts) or an array of multiple post types.
		// In the latter two cases cases, the default text is used, leaving the `infinite_scroll_js_settings` filter for further customization.
		$post_type = self::wp_query()->get( 'post_type' );

		// If it's a taxonomy, try to change the button text.
		if ( is_tax() ) {
			// Get current taxonomy slug.
			$taxonomy_slug = self::wp_query()->get( 'taxonomy' );

			// Get taxonomy settings.
			$taxonomy = get_taxonomy( $taxonomy_slug );

			// Check if the taxonomy is attached to one post type only and use its plural name.
			// If not, use "Posts" without confusing the users.
			if (
				is_a( $taxonomy, 'WP_Taxonomy' )
				&& is_countable( $taxonomy->object_type )
				&& count( $taxonomy->object_type ) < 2
			) {
				$post_type = $taxonomy->object_type[0];
			}
		}

		if ( is_string( $post_type ) && ! empty( $post_type ) ) {
			$post_type = get_post_type_object( $post_type );

			if ( is_object( $post_type ) && ! is_wp_error( $post_type ) ) {
				if ( isset( $post_type->labels->name ) ) {
					$cpt_text = $post_type->labels->name;
				} elseif ( isset( $post_type->label ) ) {
					$cpt_text = $post_type->label;
				}

				if ( isset( $cpt_text ) ) {
					/* translators: %s is the name of a custom post type */
					$click_handle_text = sprintf( __( 'More %s', 'jetpack' ), $cpt_text );
					unset( $cpt_text );
				}
			}
		}

		unset( $post_type );

		// Base JS settings
		$js_settings = array(
			'id'               => self::get_settings()->container,
			'ajaxurl'          => esc_url_raw( self::ajax_url() ),
			'type'             => esc_js( self::get_settings()->type ),
			'wrapper'          => self::has_wrapper(),
			'wrapper_class'    => is_string( self::get_settings()->wrapper ) ? esc_js( self::get_settings()->wrapper ) : 'infinite-wrap',
			'footer'           => is_string( self::get_settings()->footer ) ? esc_js( self::get_settings()->footer ) : self::get_settings()->footer,
			'click_handle'     => esc_js( self::get_settings()->click_handle ),
			'text'             => esc_js( $click_handle_text ),
			'totop'            => esc_js( __( 'Scroll back to top', 'jetpack' ) ),
			'currentday'       => $currentday,
			'order'            => 'DESC',
			'scripts'          => array(),
			'styles'           => array(),
			'google_analytics' => false,
			'offset'           => max( 1, self::wp_query()->get( 'paged' ) ), // Pass through the current page so we can use that to offset the first load.
			'history'          => array(
				'host'                 => preg_replace( '#^http(s)?://#i', '', untrailingslashit( esc_url( get_home_url() ) ) ),
				'path'                 => self::get_request_path(),
				'use_trailing_slashes' => $wp_rewrite->use_trailing_slashes,
				'parameters'           => self::get_request_parameters(),
			),
			'query_args'       => self::get_query_vars(),
			'query_before'     => current_time( 'mysql' ),
			'last_post_date'   => self::get_last_post_date(),
			'body_class'       => self::body_class(),
			'loading_text'     => esc_js( __( 'Loading new page', 'jetpack' ) ),
		);

		// Optional order param
		if ( isset( $_REQUEST['order'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no changes made to the site.
			$order = strtoupper( sanitize_text_field( wp_unslash( $_REQUEST['order'] ) ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no changes made to the site.

			if ( in_array( $order, array( 'ASC', 'DESC' ), true ) ) {
				$js_settings['order'] = $order;
			}
		}

		/**
		 * Filter the Infinite Scroll JS settings outputted in the head.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 *
		 * @param array $js_settings Infinite Scroll JS settings.
		 */
		$js_settings = apply_filters( 'infinite_scroll_js_settings', $js_settings );

		/**
		 * Fires before Infinite Scroll outputs inline JavaScript in the head.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 */
		do_action( 'infinite_scroll_wp_head' );

		?>
		<script type="text/javascript">
		var infiniteScroll = <?php echo wp_json_encode( array( 'settings' => $js_settings ), JSON_HEX_TAG ); ?>;
		</script>
		<?php
	}

	// phpcs:disable WordPress.WP.GlobalVariablesOverride.Prohibited

	/**
	 * Build path data for current request.
	 * Used for Google Analytics and pushState history tracking.
	 *
	 * @global $wp_rewrite
	 * @global $wp
	 * @uses user_trailingslashit, sanitize_text_field, add_query_arg
	 * @return string|bool
	 */
	private function get_request_path() {
		global $wp_rewrite;

		if ( $wp_rewrite->using_permalinks() ) {
			global $wp;

			// If called too early, bail
			if ( ! isset( $wp->request ) ) {
				return false;
			}

			// Determine path for paginated version of current request
			if ( preg_match( '#' . preg_quote( $wp_rewrite->pagination_base, '#' ) . '/\d+/?$#i', $wp->request ) ) {
				$path = preg_replace( '#' . preg_quote( $wp_rewrite->pagination_base, '#' ) . '/\d+$#i', $wp_rewrite->pagination_base . '/%d', $wp->request );
			} else {
				$path = $wp->request . '/' . $wp_rewrite->pagination_base . '/%d';
			}

			// Slashes everywhere we need them
			if ( ! str_starts_with( $path, '/' ) ) {
				$path = '/' . $path;
			}

			$path = user_trailingslashit( $path );
		} else {
			// Clean up raw $_REQUEST input
			$path = array_map( 'sanitize_text_field', wp_unslash( $_REQUEST ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- seems this is used for Google Analytics and browser history tracking.
			$path = array_filter( $path );

			$path['paged'] = '%d';

			$path = add_query_arg( $path, '/' );
		}

		return empty( $path ) ? false : $path;
	}

	/**
	 * Return query string for current request, prefixed with '?'.
	 *
	 * @return string
	 */
	private function get_request_parameters() {
		$uri = isset( $_SERVER['REQUEST_URI'] ) ? sanitize_text_field( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
		$uri = preg_replace( '/^[^?]*(\?.*$)/', '$1', $uri, 1, $count );
		if ( $count !== 1 ) {
			return '';
		}
		return $uri;
	}

	/**
	 * Provide IS with a list of the scripts and stylesheets already present on the page.
	 * Since posts may contain require additional assets that haven't been loaded, this data will be used to track the additional assets.
	 *
	 * @global $wp_scripts, $wp_styles
	 * @action wp_footer
	 */
	public function action_wp_footer() {
		global $wp_scripts, $wp_styles;

		$scripts = is_a( $wp_scripts, 'WP_Scripts' ) ? $wp_scripts->done : array();
		/**
		 * Filter the list of scripts already present on the page.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.1.2
		 *
		 * @param array $scripts Array of scripts present on the page.
		 */
		$scripts = apply_filters( 'infinite_scroll_existing_scripts', $scripts );

		$styles = is_a( $wp_styles, 'WP_Styles' ) ? $wp_styles->done : array();
		/**
		 * Filter the list of styles already present on the page.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.1.2
		 *
		 * @param array $styles Array of styles present on the page.
		 */
		$styles = apply_filters( 'infinite_scroll_existing_stylesheets', $styles );

		?>
		<script type="text/javascript">
			(function() {
				var extend = function(out) {
					out = out || {};

					for (var i = 1; i < arguments.length; i++) {
						if (!arguments[i])
						continue;

						for (var key in arguments[i]) {
						if (arguments[i].hasOwnProperty(key))
							out[key] = arguments[i][key];
						}
					}

					return out;
				};
				extend( window.infiniteScroll.settings.scripts, <?php echo wp_json_encode( $scripts ); ?> );
				extend( window.infiniteScroll.settings.styles, <?php echo wp_json_encode( $styles ); ?> );
			})();
		</script>
		<?php
		$aria_live = 'assertive';
		if ( 'scroll' === self::get_settings()->type ) {
			$aria_live = 'polite';
		}
		?>
		<span id="infinite-aria" aria-live="<?php echo esc_attr( $aria_live ); ?>"></span>
		<?php
	}

	/**
	 * Identify additional scripts required by the latest set of IS posts and provide the necessary data to the IS response handler.
	 *
	 * @param array $results - the results.
	 * @param array $query_args - Array of Query arguments.
	 * @param array $wp_query - the WP query.
	 * @global $wp_scripts
	 * @uses sanitize_text_field, add_query_arg
	 * @filter infinite_scroll_results
	 * @return array
	 */
	public function filter_infinite_scroll_results( $results, $query_args, $wp_query ) {
		// Don't bother unless there are posts to display
		if ( 'success' !== $results['type'] ) {
			return $results;
		}

		// Parse and sanitize the script handles already output
		$initial_scripts = isset( $_REQUEST['scripts'] ) && is_array( $_REQUEST['scripts'] ) ? array_map( 'sanitize_text_field', wp_unslash( $_REQUEST['scripts'] ) ) : false; // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no site changes made.

		if ( is_array( $initial_scripts ) ) {
			global $wp_scripts;

			// Identify new scripts needed by the latest set of IS posts
			$new_scripts = array_filter(
				$wp_scripts->done,
				function ( $script_name ) use ( $initial_scripts ) {
					// Jetpack block scripts should always be sent, even if they've been
					// sent before. These scripts only run once on when loaded, they don't
					// watch for new blocks being added.
					if ( str_starts_with( $script_name, 'jetpack-block-' ) ) {
						return true;
					}

					return ! in_array( $script_name, $initial_scripts, true );
				}
			);

			// If new scripts are needed, extract relevant data from $wp_scripts
			if ( ! empty( $new_scripts ) ) {
				$results['scripts'] = array();

				foreach ( $new_scripts as $handle ) {
					// Abort if somehow the handle doesn't correspond to a registered script
					// or if the script doesn't have `src` set.
					$script_not_registered = ! isset( $wp_scripts->registered[ $handle ] );
					$empty_src             = empty( $wp_scripts->registered[ $handle ]->src );
					if ( $script_not_registered || $empty_src ) {
						continue;
					}

					$before_handle = $wp_scripts->get_inline_script_data( $handle, 'before' );
					$after_handle  = $wp_scripts->get_inline_script_data( $handle, 'after' );

					// Provide basic script data
					$script_data = array(
						'handle'        => $handle,
						'footer'        => ( is_array( $wp_scripts->in_footer ) && in_array( $handle, $wp_scripts->in_footer, true ) ),
						'extra_data'    => $wp_scripts->print_extra_script( $handle, false ),
						'before_handle' => $before_handle,
						'after_handle'  => $after_handle,
					);

					// Base source
					$src = $wp_scripts->registered[ $handle ]->src;

					// Take base_url into account
					if ( strpos( $src, 'http' ) !== 0 ) {
						$src = $wp_scripts->base_url . $src;
					}

					// Version and additional arguments
					if ( null === $wp_scripts->registered[ $handle ]->ver ) {
						$ver = '';
					} else {
						$ver = $wp_scripts->registered[ $handle ]->ver ? $wp_scripts->registered[ $handle ]->ver : $wp_scripts->default_version;
					}

					if ( isset( $wp_scripts->args[ $handle ] ) ) {
						$ver = $ver ? $ver . '&amp;' . $wp_scripts->args[ $handle ] : $wp_scripts->args[ $handle ];
					}

					// Full script source with version info
					$script_data['src'] = add_query_arg( 'ver', $ver, $src );

					// Add script to data that will be returned to IS JS
					array_push( $results['scripts'], $script_data );
				}
			}
		}

		// Expose additional script data to filters, but only include in final `$results` array if needed.
		if ( ! isset( $results['scripts'] ) ) {
			$results['scripts'] = array();
		}

		/**
		 * Filter the additional scripts required by the latest set of IS posts.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.1.2
		 *
		 * @param array $results['scripts'] Additional scripts required by the latest set of IS posts.
		 * @param array|bool $initial_scripts Set of scripts loaded on each page.
		 * @param array $results Array of Infinite Scroll results.
		 * @param array $query_args Array of Query arguments.
		 * @param WP_Query $wp_query WP Query.
		 */
		$results['scripts'] = apply_filters(
			'infinite_scroll_additional_scripts',
			$results['scripts'],
			$initial_scripts,
			$results,
			$query_args,
			$wp_query
		);

		if ( empty( $results['scripts'] ) ) {
			unset( $results['scripts'] );
		}

		// Parse and sanitize the style handles already output
		$initial_styles = isset( $_REQUEST['styles'] ) && is_array( $_REQUEST['styles'] ) ? array_map( 'sanitize_text_field', wp_unslash( $_REQUEST['styles'] ) ) : false; // phpcs:ignore WordPress.Security.NonceVerification.Recommended

		if ( is_array( $initial_styles ) ) {
			global $wp_styles;

			// Identify new styles needed by the latest set of IS posts
			$new_styles = array_diff( $wp_styles->done, $initial_styles );

			// If new styles are needed, extract relevant data from $wp_styles
			if ( ! empty( $new_styles ) ) {
				$results['styles'] = array();

				foreach ( $new_styles as $handle ) {
					// Abort if somehow the handle doesn't correspond to a registered stylesheet
					if ( ! isset( $wp_styles->registered[ $handle ] ) ) {
						continue;
					}

					// Provide basic style data
					$style_data = array(
						'handle' => $handle,
						'media'  => 'all',
					);

					// Base source
					$src = $wp_styles->registered[ $handle ]->src;

					// Take base_url into account
					if ( strpos( $src, 'http' ) !== 0 ) {
						$src = $wp_styles->base_url . $src;
					}

					// Version and additional arguments
					if ( null === $wp_styles->registered[ $handle ]->ver ) {
						$ver = '';
					} else {
						$ver = $wp_styles->registered[ $handle ]->ver ? $wp_styles->registered[ $handle ]->ver : $wp_styles->default_version;
					}

					if ( isset( $wp_styles->args[ $handle ] ) ) {
						$ver = $ver ? $ver . '&amp;' . $wp_styles->args[ $handle ] : $wp_styles->args[ $handle ];
					}

					// Full stylesheet source with version info
					$style_data['src'] = add_query_arg( 'ver', $ver, $src );

					// Parse stylesheet's conditional comments if present, converting to logic executable in JS
					if ( isset( $wp_styles->registered[ $handle ]->extra['conditional'] ) && $wp_styles->registered[ $handle ]->extra['conditional'] ) {
						// First, convert conditional comment operators to standard logical operators. %ver is replaced in JS with the IE version
						$style_data['conditional'] = str_replace(
							array(
								'lte',
								'lt',
								'gte',
								'gt',
							),
							array(
								'%ver <=',
								'%ver <',
								'%ver >=',
								'%ver >',
							),
							$wp_styles->registered[ $handle ]->extra['conditional']
						);

						// Next, replace any !IE checks. These shouldn't be present since WP's conditional stylesheet implementation doesn't support them, but someone could be _doing_it_wrong().
						$style_data['conditional'] = preg_replace( '#!\s*IE(\s*\d+){0}#i', '1==2', $style_data['conditional'] );

						// Lastly, remove the IE strings
						$style_data['conditional'] = str_replace( 'IE', '', $style_data['conditional'] );
					}

					// Parse requested media context for stylesheet
					if ( isset( $wp_styles->registered[ $handle ]->args ) ) {
						$style_data['media'] = esc_attr( $wp_styles->registered[ $handle ]->args );
					}

					// Add stylesheet to data that will be returned to IS JS
					array_push( $results['styles'], $style_data );
				}
			}
		}

		// Expose additional stylesheet data to filters, but only include in final `$results` array if needed.
		if ( ! isset( $results['styles'] ) ) {
			$results['styles'] = array();
		}

		/**
		 * Filter the additional styles required by the latest set of IS posts.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.1.2
		 *
		 * @param array $results['styles'] Additional styles required by the latest set of IS posts.
		 * @param array|bool $initial_styles Set of styles loaded on each page.
		 * @param array $results Array of Infinite Scroll results.
		 * @param array $query_args Array of Query arguments.
		 * @param WP_Query $wp_query WP Query.
		 */
		$results['styles'] = apply_filters(
			'infinite_scroll_additional_stylesheets',
			$results['styles'],
			$initial_styles,
			$results,
			$query_args,
			$wp_query
		);

		if ( empty( $results['styles'] ) ) {
			unset( $results['styles'] );
		}

		// Lastly, return the IS results array
		return $results;
	}

	/**
	 * Runs the query and returns the results via JSON.
	 * Triggered by an AJAX request.
	 *
	 * @global $wp_query
	 * @global $wp_the_query
	 * @uses current_theme_supports, get_option, self::wp_query, current_user_can, apply_filters, self::get_settings, add_filter, WP_Query, remove_filter, have_posts, wp_head, do_action, add_action, this::render, this::has_wrapper, esc_attr, wp_footer, sharing_register_post_for_share_counts, get_the_id
	 */
	public function query() {
		if ( ! isset( $_REQUEST['page'] ) || ! current_theme_supports( 'infinite-scroll' ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no changes to the site.
			die;
		}

		// @todo see if we should validate this nonce since we use it to form a query.
		$page = (int) $_REQUEST['page']; // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- we're casting this to an int and not making changes to the site.

		// Sanitize and set $previousday. Expected format: dd.mm.yy
		if ( isset( $_REQUEST['currentday'] ) && preg_match( '/^\d{2}\.\d{2}\.\d{2}$/', $_REQUEST['currentday'] ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput, WordPress.Security.NonceVerification.Recommended -- manually validating, no changes to site
			global $previousday;
			$previousday = $_REQUEST['currentday']; // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput
		}

		$post_status = array( 'publish' );
		if ( current_user_can( 'read_private_posts' ) ) {
			array_push( $post_status, 'private' );
		}

		$order = isset( $_REQUEST['order'] ) && in_array( $_REQUEST['order'], array( 'ASC', 'DESC' ), true ) ? sanitize_text_field( wp_unslash( $_REQUEST['order'] ) ) : 'DESC'; // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no changes made to the site.

		$query_args = array_merge(
			self::wp_query()->query_vars,
			array(
				'paged'          => $page,
				'post_status'    => $post_status,
				'posts_per_page' => self::posts_per_page(), // phpcs:ignore WordPress.WP.PostsPerPage.posts_per_page_posts_per_page
				'order'          => $order,
			)
		);

		// 4.0 ?s= compatibility, see https://core.trac.wordpress.org/ticket/11330#comment:50
		if ( empty( $query_args['s'] ) && ! isset( self::wp_query()->query['s'] ) ) {
			unset( $query_args['s'] );
		}

		// By default, don't query for a specific page of a paged post object.
		// This argument can come from merging self::wp_query() into $query_args above.
		// Since IS is only used on archives, we should always display the first page of any paged content.
		unset( $query_args['page'] );

		/**
		 * Filter the array of main query arguments.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.1
		 *
		 * @param array $query_args Array of Query arguments.
		 */
		$query_args = apply_filters( 'infinite_scroll_query_args', $query_args );

		add_filter( 'posts_where', array( $this, 'query_time_filter' ), 10, 2 );

		$infinite_scroll_query   = new WP_Query();
		$GLOBALS['wp_the_query'] = $infinite_scroll_query;
		$GLOBALS['wp_query']     = $infinite_scroll_query;

		$infinite_scroll_query->query( $query_args );

		remove_filter( 'posts_where', array( $this, 'query_time_filter' ), 10, 2 );

		$results = array();

		if ( have_posts() ) {
			// Fire wp_head to ensure that all necessary scripts are enqueued. Output isn't used, but scripts are extracted in self::action_wp_footer.
			ob_start();
			wp_head();
			while ( ob_get_length() ) {
				ob_end_clean();
			}

			$results['type'] = 'success';

			/**
			 * Fires when rendering Infinite Scroll posts.
			 *
			 * @module infinite-scroll
			 *
			 * @since 2.0.0
			 */
			do_action( 'infinite_scroll_render' );
			$results['html'] = ob_get_clean();
			if ( empty( $results['html'] ) ) {
				/**
				 * Gather renderer callbacks. These will be called in order and allow multiple callbacks to be queued. Once content is found, no futher callbacks will run.
				 *
				 * @module infinite-scroll
				 *
				 * @since 6.0.0
				 */
				$callbacks = apply_filters(
					'infinite_scroll_render_callbacks',
					array( self::get_settings()->render ) // This is the setting callback e.g. from add theme support.
				);

				// Append fallback callback. That rhymes.
				$callbacks[] = array( $this, 'render' );

				foreach ( $callbacks as $callback ) {
					if ( false !== $callback && is_callable( $callback ) ) {
						rewind_posts();
						ob_start();
						add_action( 'infinite_scroll_render', $callback );

						/**
						 * This action is already documented above.
						 * See https://github.com/Automattic/jetpack/pull/16317/
						 * for more details as to why it was introduced.
						 */
						do_action( 'infinite_scroll_render' );

						$results['html'] = ob_get_clean();
						remove_action( 'infinite_scroll_render', $callback );
					}
					if ( ! empty( $results['html'] ) ) {
						break;
					}
				}
			}

			// If primary and fallback rendering methods fail, prevent further IS rendering attempts. Otherwise, wrap the output if requested.
			if ( empty( $results['html'] ) ) {
				unset( $results['html'] );
				/**
				 * Fires when Infinite Scoll doesn't render any posts.
				 *
				 * @module infinite-scroll
				 *
				 * @since 2.0.0
				 */
				do_action( 'infinite_scroll_empty' );
				$results['type'] = 'empty';
			} elseif ( $this->has_wrapper() ) {
				$wrapper_classes  = is_string( self::get_settings()->wrapper ) ? self::get_settings()->wrapper : 'infinite-wrap';
				$wrapper_classes .= ' infinite-view-' . $page;
				$wrapper_classes  = trim( $wrapper_classes );
				$aria_label       = sprintf(
					/* translators: %1$s is the page count */
					__( 'Page: %1$d.', 'jetpack' ),
					$page
				);

				$results['html'] = '<div class="' . esc_attr( $wrapper_classes ) . '" id="infinite-view-' . $page . '" data-page-num="' . $page . '" role="region" aria-label="' . esc_attr( $aria_label ) . '">' . $results['html'] . '</div>';
			}

			// Fire wp_footer to ensure that all necessary scripts are enqueued. Output isn't used, but scripts are extracted in self::action_wp_footer.
			ob_start();
			wp_footer();
			while ( ob_get_length() ) {
				ob_end_clean();
			}

			if ( 'success' === $results['type'] ) {
				global $currentday;
				$results['lastbatch']  = self::is_last_batch();
				$results['currentday'] = $currentday;
			}

			// Loop through posts to capture sharing data for new posts loaded via Infinite Scroll
			if ( 'success' === $results['type'] && function_exists( 'sharing_register_post_for_share_counts' ) ) {
				global $jetpack_sharing_counts;

				while ( have_posts() ) {
					the_post();

					sharing_register_post_for_share_counts( get_the_ID() );
				}

				$results['postflair'] = array_flip( $jetpack_sharing_counts );
			}
		} else {
			/** This action is already documented in modules/infinite-scroll/infinity.php */
			do_action( 'infinite_scroll_empty' );
			$results['type'] = 'empty';
		}

		wp_send_json(
			/**
			 * Filter the Infinite Scroll results.
			 *
			 * @module infinite-scroll
			 *
			 * @since 2.0.0
			 *
			 * @param array $results Array of Infinite Scroll results.
			 * @param array $query_args Array of main query arguments.
			 * @param WP_Query $wp_query WP Query.
			 */
			apply_filters( 'infinite_scroll_results', $results, $query_args, self::wp_query() )
		);
	}

	/**
	 * Update the $allowed_vars array with the standard WP public and private
	 * query vars, as well as taxonomy vars
	 *
	 * @global $wp
	 * @param array $allowed_vars - the allowed variables array.
	 * @filter infinite_scroll_allowed_vars
	 * @return array
	 */
	public function allowed_query_vars( $allowed_vars ) {
		global $wp;

		$allowed_vars += $wp->public_query_vars;
		$allowed_vars += $wp->private_query_vars;
		$allowed_vars += $this->get_taxonomy_vars();

		foreach ( array_keys( $allowed_vars, 'paged', true ) as $key ) {
			unset( $allowed_vars[ $key ] );
		}

		return array_unique( $allowed_vars );
	}

	/**
	 * Returns an array of stock and custom taxonomy query vars
	 *
	 * @global $wp_taxonomies
	 * @return array
	 */
	public function get_taxonomy_vars() {
		global $wp_taxonomies;

		$taxonomy_vars = array();
		foreach ( $wp_taxonomies as $t ) {
			if ( $t->query_var ) {
				$taxonomy_vars[] = $t->query_var;
			}
		}

		// still needed?
		$taxonomy_vars[] = 'tag_id';

		return $taxonomy_vars;
	}

	/**
	 * Update the $query_args array with the parameters provided via AJAX/GET.
	 *
	 * @param array $query_args - the query args.
	 * @filter infinite_scroll_query_args
	 * @return array
	 */
	public function inject_query_args( $query_args ) {
		/**
		 * Filter the array of allowed Infinite Scroll query arguments.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.6.0
		 *
		 * @param array $args Array of allowed Infinite Scroll query arguments.
		 * @param array $query_args Array of query arguments.
		 */
		$allowed_vars = apply_filters( 'infinite_scroll_allowed_vars', array(), $query_args );

		$query_args = array_merge(
			$query_args,
			array(
				'suppress_filters' => false,
			)
		);

		if ( isset( $_REQUEST['query_args'] ) && is_array( $_REQUEST['query_args'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- no site changes.
			foreach ( wp_unslash( $_REQUEST['query_args'] ) as $var => $value ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized -- no site changes, sanitized below.
				if ( in_array( $var, $allowed_vars, true ) && ! empty( $value ) ) {
					$query_args[ $var ] = filter_var( $value );
				}
			}
		}

		return $query_args;
	}

	/**
	 * Rendering fallback used when themes don't specify their own handler.
	 *
	 * @uses have_posts, the_post, get_template_part, get_post_format
	 * @action infinite_scroll_render
	 */
	public function render() {
		while ( have_posts() ) {
			the_post();

			get_template_part( 'content', get_post_format() );
		}
	}

	/**
	 * Allow plugins to filter what archives Infinite Scroll supports
	 *
	 * @uses current_theme_supports, is_home, is_archive, apply_filters, self::get_settings
	 * @return bool
	 */
	public static function archive_supports_infinity() {
		$supported = current_theme_supports( 'infinite-scroll' ) && ( is_home() || is_archive() || is_search() );

		// Disable when previewing a non-active theme in the customizer
		if ( is_customize_preview() && ! $GLOBALS['wp_customize']->is_theme_active() ) {
			return false;
		}

		/**
		 * Allow plugins to filter what archives Infinite Scroll supports.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 *
		 * @param bool $supported Does the Archive page support Infinite Scroll.
		 * @param object self::get_settings() IS settings provided by theme.
		 */
		return (bool) apply_filters( 'infinite_scroll_archive_supported', $supported, self::get_settings() );
	}

	/**
	 * The Infinite Blog Footer
	 *
	 * @uses self::get_settings, self::archive_supports_infinity, self::default_footer
	 * @return string or null
	 */
	public function footer() {
		if ( class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request() ) {
			return;
		}

		// Bail if theme requested footer not show
		if ( false === self::get_settings()->footer ) {
			return;
		}

		// We only need the new footer for the 'scroll' type
		if ( 'scroll' !== self::get_settings()->type || ! self::archive_supports_infinity() ) {
			return;
		}

		if ( self::is_last_batch() ) {
			return;
		}

		// Display a footer, either user-specified or a default
		if ( false !== self::get_settings()->footer_callback && is_callable( self::get_settings()->footer_callback ) ) {
			call_user_func( self::get_settings()->footer_callback, self::get_settings() );
		} else {
			self::default_footer();
		}
	}

	/**
	 * Render default IS footer
	 *
	 * @uses __, wp_get_theme, apply_filters, home_url, esc_attr, get_bloginfo, bloginfo
	 */
	private function default_footer() {
		if ( '' !== get_privacy_policy_url() ) {
			$credits = get_the_privacy_policy_link() . '<span role="separator" aria-hidden="true"> / </span>';
		} else {
			$credits = '';
		}
		$credits .= sprintf(
			'<a href="https://wordpress.org/" rel="noopener noreferrer" target="_blank" rel="generator">%1$s</a> ',
			__( 'Proudly powered by WordPress', 'jetpack' )
		);
		$credits .= sprintf(
			/* translators: %1$s is the name of a theme */
			__( 'Theme: %1$s.', 'jetpack' ),
			wp_get_theme()->Name
		);
		/**
		 * Filter Infinite Scroll's credit text.
		 *
		 * @module infinite-scroll
		 *
		 * @since 2.0.0
		 *
		 * @param string $credits Infinite Scroll credits.
		 */
		$credits = apply_filters( 'infinite_scroll_credit', $credits );

		?>
		<div id="infinite-footer">
			<div class="container">
				<div class="blog-info">
					<a id="infinity-blog-title" href="<?php echo esc_url( home_url( '/' ) ); ?>" rel="home">
						<?php bloginfo( 'name' ); ?>
					</a>
				</div>
				<div class="blog-credits">
					<?php echo $credits; //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped ?>
				</div>
			</div>
		</div><!-- #infinite-footer -->
		<?php
	}

	/**
	 * Ensure that IS doesn't interfere with Grunion by stripping IS query arguments from the Grunion redirect URL.
	 * When arguments are present, Grunion redirects to the IS AJAX endpoint.
	 *
	 * @param string $url - the Grunion redirect URL.
	 * @uses remove_query_arg
	 * @filter grunion_contact_form_redirect_url
	 * @return string
	 */
	public function filter_grunion_redirect_url( $url ) {
		// Remove IS query args, if present
		if ( str_contains( $url, 'infinity=scrolling' ) ) {
			$url = remove_query_arg(
				array(
					'infinity',
					'action',
					'page',
					'order',
					'scripts',
					'styles',
				),
				$url
			);
		}

		return $url;
	}

	/**
	 * When the MediaElement is loaded in dynamically, we need to enforce that
	 * its settings are added to the page as well.
	 *
	 * @param array $scripts_data New scripts exposed to the infinite scroll.
	 *
	 * @since 8.4.0
	 */
	public function add_mejs_config( $scripts_data ) {
		foreach ( $scripts_data as $key => $data ) {
			if ( 'mediaelement-core' === $data['handle'] ) {
				$mejs_settings = array(
					'pluginPath'  => includes_url( 'js/mediaelement/', 'relative' ),
					'classPrefix' => 'mejs-',
					'stretching'  => 'responsive',
				);

				$scripts_data[ $key ]['extra_data'] = sprintf(
					'window.%s = %s',
					'_wpmejsSettings',
					wp_json_encode( apply_filters( 'mejs_settings', $mejs_settings ) )
				);
			}
		}
		return $scripts_data;
	}

	/**
	 * Determines whether the legacy AMP Reader post templates are being used.
	 *
	 * @return bool
	 */
	private function is_exempted_amp_page() {
		if ( is_singular( 'web-story' ) ) {
			// Ensure that <amp-next-page> is not injected after <amp-story> as generated by the Web Stories plugin.
			return true;
		}
		if ( function_exists( 'amp_is_legacy' ) ) {
			// Available since AMP v2.0, this will return false if a theme like Twenty Twenty is selected as the Reader theme.
			return amp_is_legacy();
		}
		if ( method_exists( 'AMP_Options_Manager', 'get_option' ) ) {
			// In versions prior to v2.0, checking the template mode as being 'reader' is sufficient.
			return 'reader' === AMP_Options_Manager::get_option( 'theme_support' );
		}
		return false;
	}

	/**
	 * Load AMP specific hooks.
	 *
	 * @return void
	 */
	public function amp_load_hooks() {
		if ( $this->is_exempted_amp_page() ) {
			return;
		}

		if ( class_exists( 'Jetpack_AMP_Support' ) && Jetpack_AMP_Support::is_amp_request() ) {
			$template = self::get_settings()->render;

			add_filter( 'jetpack_infinite_scroll_load_scripts_and_styles', '__return_false' );

			add_action( 'template_redirect', array( $this, 'amp_start_output_buffering' ), 0 );
			add_action( 'shutdown', array( $this, 'amp_output_buffer' ), 1 );

			if ( is_string( $template ) && strpos( $template, '::' ) === false && is_callable( "amp_{$template}_hooks" ) ) {
				call_user_func( "amp_{$template}_hooks" );
			}

			// Warms up the amp next page markup.
			// This should be done outside the output buffering callback started in the template_redirect.
			$this->amp_get_footer_template();
		}
	}

	/**
	 * Start the AMP output buffering.
	 *
	 * @return void
	 */
	public function amp_start_output_buffering() {
		ob_start( array( $this, 'amp_finish_output_buffering' ) );
	}

	/**
	 * Flush the AMP output buffer.
	 *
	 * @return void
	 */
	public function amp_output_buffer() {
		if ( ob_get_contents() ) {
			ob_end_flush();
		}
	}

	/**
	 * Filter the AMP output buffer contents.
	 *
	 * @param string $buffer Contents of the output buffer.
	 *
	 * @return string|false
	 */
	public function amp_finish_output_buffering( $buffer ) {
		// Hide WordPress admin bar on next page load.
		$buffer = preg_replace(
			'/id="wpadminbar"/',
			'$0 next-page-hide',
			$buffer
		);

		/**
		 * Get the theme footers.
		 *
		 * @module infinite-scroll
		 *
		 * @since 9.0.0
		 *
		 * @param array  array() An array to store multiple markup entries to be added to the footer.
		 * @param string $buffer The contents of the output buffer.
		 */
		$footers = apply_filters( 'jetpack_amp_infinite_footers', array(), $buffer );

		/**
		 * Filter the output buffer.
		 * Themes can leverage this hook to add custom markup on next page load.
		 *
		 * @module infinite-scroll
		 *
		 * @since 9.0.0
		 *
		 * @param string $buffer The contents of the output buffer.
		 */
		$buffer = apply_filters( 'jetpack_amp_infinite_output', $buffer );

		// Add the amp next page markup.
		$buffer = preg_replace(
			'~</body>~',
			$this->amp_get_footer_template( $footers ) . '$0',
			$buffer
		);

		return $buffer;
	}

	/**
	 * Get AMP next page markup with the custom footers.
	 *
	 * @param string[] $footers The theme footers.
	 *
	 * @return string
	 */
	protected function amp_get_footer_template( $footers = array() ) {
		static $template = null;

		if ( null === $template ) {
			$template = $this->amp_footer_template();
		}

		if ( empty( $footers ) ) {
			return $template;
		}

		return preg_replace(
			'/%%footer%%/',
			implode( '', $footers ),
			$template
		);
	}

	/**
	 * AMP Next Page markup.
	 *
	 * @return string
	 */
	protected function amp_footer_template() {
		ob_start();
		?>
<amp-next-page max-pages="<?php echo esc_attr( static::amp_get_max_pages() ); ?>">
	<script type="application/json">
		[
			<?php echo wp_json_encode( $this->amp_next_page() ); ?>
		]
	</script>
	<div separator>
		<?php
		echo wp_kses_post(
			/**
			 * AMP infinite scroll separator.
			 *
			 * @module infinite-scroll
			 *
			 * @since 9.0.0
			 *
			 * @param string '' The markup for the next page separator.
			 */
			apply_filters( 'jetpack_amp_infinite_separator', '' )
		);
		?>
	</div>
	<div recommendation-box class="recommendation-box">
		<template type="amp-mustache">
			{{#pages}}
			<?php
			echo wp_kses_post(
				/**
				 * AMP infinite scroll older posts markup.
				 *
				 * @module infinite-scroll
				 *
				 * @since 9.0.0
				 *
				 * @param string '' The markup for the older posts/next page.
				 */
				apply_filters( 'jetpack_amp_infinite_older_posts', '' )
			);
			?>
			{{/pages}}
		</template>
	</div>
	<div footer>
		%%footer%%
	</div>
</amp-next-page>
		<?php
		return ob_get_clean();
	}

	/**
	 * Get the AMP next page information.
	 *
	 * @return array
	 */
	protected function amp_next_page() {
		$title = '';
		$url   = '';
		$image = '';

		if ( ! static::amp_is_last_page() ) {
			$title = sprintf(
				'%s - %s %d - %s',
				wp_title( '', false ),
				__( 'Page', 'jetpack' ),
				max( get_query_var( 'paged', 1 ), 1 ) + 1,
				get_bloginfo( 'name' )
			);
			$url   = get_next_posts_page_link();
		}

		$next_page = array(
			'title' => $title,
			'url'   => $url,
			'image' => $image,
		);

		/**
		 * The next page settings.
		 * An array containing:
		 *  - title => The title to be featured on the browser tab.
		 *  - url   => The URL of next page.
		 *  - image => The image URL. A required AMP setting, not in use currently. Themes are welcome to leverage.
		 *
		 * @module infinite-scroll
		 *
		 * @since 9.0.0
		 *
		 * @param array $next_page The contents of the output buffer.
		 */
		return apply_filters( 'jetpack_amp_infinite_next_page_data', $next_page );
	}

	/**
	 * Get the number of pages left.
	 *
	 * @return int
	 */
	protected static function amp_get_max_pages() {
		global $wp_query;

		return (int) $wp_query->max_num_pages - $wp_query->query_vars['paged'];
	}

	/**
	 * Is the last page.
	 *
	 * @return bool
	 */
	protected static function amp_is_last_page() {
		return 0 === static::amp_get_max_pages();
	}
}

/**
 * Initialize The_Neverending_Home_Page
 */
function the_neverending_home_page_init() {
	if ( ! current_theme_supports( 'infinite-scroll' ) ) {
		return;
	}

	new The_Neverending_Home_Page();
}
add_action( 'init', 'the_neverending_home_page_init', 20 );

/**
 * Check whether the current theme is infinite-scroll aware.
 * If so, include the files which add theme support.
 */
function the_neverending_home_page_theme_support() {
	if (
			defined( 'IS_WPCOM' ) && IS_WPCOM &&
			defined( 'REST_API_REQUEST' ) && REST_API_REQUEST &&
			! doing_action( 'restapi_theme_after_setup_theme' )
	) {
		// Don't source theme compat files until we're in the site's context
		return;
	}
	$theme_name = get_stylesheet();

	/**
	 * Filter the path to the Infinite Scroll compatibility file.
	 *
	 * @module infinite-scroll
	 *
	 * @since 2.0.0
	 *
	 * @param string $str IS compatibility file path.
	 * @param string $theme_name Theme name.
	 */
	$customization_file = apply_filters( 'infinite_scroll_customization_file', __DIR__ . "/themes/{$theme_name}.php", $theme_name );

	if ( is_readable( $customization_file ) ) {
		require_once $customization_file;
	}
}
add_action( 'after_setup_theme', 'the_neverending_home_page_theme_support', 5 );

/**
 * Early accommodation of the Infinite Scroll AJAX request
 */
if ( The_Neverending_Home_Page::got_infinity() ) {
	/**
	 * If we're sure this is an AJAX request (i.e. the HTTP_X_REQUESTED_WITH header says so),
	 * indicate it as early as possible for actions like init
	 */
	if ( ! defined( 'DOING_AJAX' ) &&
		isset( $_SERVER['HTTP_X_REQUESTED_WITH'] ) &&
		strtoupper( sanitize_text_field( wp_unslash( $_SERVER['HTTP_X_REQUESTED_WITH'] ) ) ) === 'XMLHTTPREQUEST'
	) {
		define( 'DOING_AJAX', true );
	}

	// Don't load the admin bar when doing the AJAX response.
	show_admin_bar( false );
}
twentyeleven.css                                                                                                                                                                                                                                               993           1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* =Infinity Styles
-------------------------------------------------------------- */
.infinite-scroll #main:after {
	clear: both;
	content: '';
	display: block;
}
.infinite-scroll #content {
	margin-bottom: 40px;
}
.infinite-scroll.neverending #content {
	margin-bottom: 70px;
}
.infinite-scroll .infinite-wrap {
	border-top: none;
	padding-top: 0;
}
.infinite-scroll .infinite-wrap .hentry:last-child {
	border-bottom: 1px solid #dcdcde;
}
.infinite-scroll .infinite-wrap:last-of-type .hentry:last-child {
	border-bottom: none;
}

/**
 * Elements to hide:
 * (footer widgets, post navigation, regular footer)
 */
.infinite-scroll.neverending #colophon #supplementary,
.infinite-scroll #nav-below,
.infinite-scroll.neverending #colophon {
	display: none;
}

/* Hooks to infinity-end body class to restore footer */
.infinity-end.neverending #colophon {
	display: block;
}

/* For responsive CSS */
@media (max-width: 800px) {
	.infinite-scroll #infinite-handle {
		padding-bottom: 40px;
	}
}
twentyeleven.php                                                                                                                                                                                                                                               1493          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for @Twenty Eleven and enqueue relevant styles.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinity scroll
 */
function jetpack_twentyeleven_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'content',
			'footer'         => 'page',
			'footer_widgets' => jetpack_twentyeleven_has_footer_widgets(),
		)
	);
}
add_action( 'init', 'jetpack_twentyeleven_infinite_scroll_init' );

/**
 * Enqueue CSS stylesheet with theme styles for infinity.
 */
function jetpack_twentyeleven_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		// Add theme specific styles.
		wp_enqueue_style( 'infinity-twentyeleven', plugins_url( 'twentyeleven.css', __FILE__ ), array( 'the-neverending-homepage' ), '20121002' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentyeleven_infinite_scroll_enqueue_styles', 25 );

/**
 * Do we have footer widgets?
 */
function jetpack_twentyeleven_has_footer_widgets() {
	// Are any of the "Footer Area" sidebars active?
	if ( is_active_sidebar( 'sidebar-3' ) || is_active_sidebar( 'sidebar-4' ) || is_active_sidebar( 'sidebar-5' ) ) {
		return true;
	}

	// If we're on mobile and the Main Sidebar has widgets, it falls below the content, so we have footer widgets.
	if ( function_exists( 'jetpack_is_mobile' ) && jetpack_is_mobile() && is_active_sidebar( 'sidebar-1' ) ) {
		return true;
	}

	return false;
}
twentyfifteen-rtl.css                                                                                                                                                                                                                                          3652          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /**
 * Infinite Scroll
 */

.infinite-scroll .pagination,
.infinite-scroll.neverending .site-footer {
	display: none;
}

.infinity-end.neverending .site-footer {
	display: block;
}

/* Spinner */
.infinite-loader {
	clear: both;
	height: 24px;
	margin: 24px 0;
}

.infinite-loader .spinner {
	top: 50% !important;
	right: 50% !important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin: 7.6923%;
	text-align: center;
}

#infinite-handle span {
	background-color: #333;
	font-family: "Noto Sans", sans-serif;
	font-size: 12px;
	font-size: 1.2rem;
	font-weight: 700;
	letter-spacing: 0.04em;
	line-height: normal;
	padding: 0.7917em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background-color: #707070;
	background-color: rgba(51, 51, 51, 0.7);
	color: #fff;
}

/* Footer */
#infinite-footer {
	display: none;
	z-index: 999;
}

#infinite-footer .container {
	background-color: #fff;
	background-color: rgba(255, 255, 255, 0.5);
	border-color: #eaeaea;
	border-color: rgba(51, 51, 51, 0.1);
	padding: 0 0.8em;
	width: 100% !important;
}

#infinite-footer .blog-info {
	font-family: "Noto Sans", sans-serif;
}

#infinite-footer .blog-info,
#infinite-footer .blog-credits {
	height: 24px;
	line-height: 24px;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits {
	font-size: 12px;
	font-size: 1.2rem;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	color: #333;
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits,
#infinite-footer .blog-credits a {
	color: #707070;
	color: rgba(51, 51, 51, 0.7);
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	text-decoration: none;
}

@media screen and (min-width: 38.75em) {
	.infinite-loader {
		margin: 7.6923% 0;
	}

	.infinite-wrap {
		margin-top: 7.6923%;
	}

	#infinite-handle {
		margin-bottom: 0;
	}
}

@media screen and (min-width: 46.25em) {
	#infinite-handle span {
		display: block;
		font-size: 14px;
		font-size: 1.4rem;
		padding: 0.8214em
	}
}

@media screen and (min-width: 55em) {
	#infinite-handle span {
		font-size: 16px;
		font-size: 1.6rem;
		padding: 0.8125em;
	}
}

@media screen and (min-width: 59.6875em) {
	.infinite-loader {
		margin: 8.3333% 0;
	}

	.infinite-wrap {
		margin-top: 8.3333%;
	}

	#infinite-handle {
		margin: 8.3333% 8.3333% 0;
	}

	#infinite-handle span {
		display: inline-block;
		font-size: 12px;
		font-size: 1.2rem;
		padding: 0.7917em 1.5833em;
	}

	#infinite-footer {
		display: block;
		position: fixed;
	}
}

@media screen and (min-width: 68.75em) {
	#infinite-handle span {
		display: inline-block;
		font-size: 14px;
		font-size: 1.4rem;
		padding: 0.8214em 1.5714em;
	}

	#infinite-footer .container {
		padding: 0 0.8235em;
	}

	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		height: 27px;
		line-height: 27px;
	}

	#infinite-footer .blog-info a {
		font-size: 14px;
		font-size: 1.4rem;
	}

	#infinite-footer .blog-credits {
		font-size: 12px;
		font-size: 1.2rem;
	}
}

@media screen and (min-width: 77.5em) {
	#infinite-handle span {
		font-size: 16px;
		font-size: 1.6rem;
		padding: 0.8125em 1.625em;
	}

	#infinite-footer .container {
		padding: 0 0.8421em;
	}

	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		height: 32px;
		line-height: 32px;
	}

	#infinite-footer .blog-info a {
		font-size: 16px;
		font-size: 1.6rem;
	}

	#infinite-footer .blog-credits {
		font-size: 13px;
		font-size: 1.3rem;
	}
}
twentyfifteen.css                                                                                                                                                                                                                                              3651          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /**
 * Infinite Scroll
 */

.infinite-scroll .pagination,
.infinite-scroll.neverending .site-footer {
	display: none;
}

.infinity-end.neverending .site-footer {
	display: block;
}

/* Spinner */
.infinite-loader {
	clear: both;
	height: 24px;
	margin: 24px 0;
}

.infinite-loader .spinner {
	top: 50% !important;
	left: 50% !important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin: 7.6923%;
	text-align: center;
}

#infinite-handle span {
	background-color: #333;
	font-family: "Noto Sans", sans-serif;
	font-size: 12px;
	font-size: 1.2rem;
	font-weight: 700;
	letter-spacing: 0.04em;
	line-height: normal;
	padding: 0.7917em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background-color: #707070;
	background-color: rgba(51, 51, 51, 0.7);
	color: #fff;
}

/* Footer */
#infinite-footer {
	display: none;
	z-index: 999;
}

#infinite-footer .container {
	background-color: #fff;
	background-color: rgba(255, 255, 255, 0.5);
	border-color: #eaeaea;
	border-color: rgba(51, 51, 51, 0.1);
	padding: 0 0.8em;
	width: 100% !important;
}

#infinite-footer .blog-info {
	font-family: "Noto Sans", sans-serif;
}

#infinite-footer .blog-info,
#infinite-footer .blog-credits {
	height: 24px;
	line-height: 24px;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits {
	font-size: 12px;
	font-size: 1.2rem;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	color: #333;
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits,
#infinite-footer .blog-credits a {
	color: #707070;
	color: rgba(51, 51, 51, 0.7);
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	text-decoration: none;
}

@media screen and (min-width: 38.75em) {
	.infinite-loader {
		margin: 7.6923% 0;
	}

	.infinite-wrap {
		margin-top: 7.6923%;
	}

	#infinite-handle {
		margin-bottom: 0;
	}
}

@media screen and (min-width: 46.25em) {
	#infinite-handle span {
		display: block;
		font-size: 14px;
		font-size: 1.4rem;
		padding: 0.8214em
	}
}

@media screen and (min-width: 55em) {
	#infinite-handle span {
		font-size: 16px;
		font-size: 1.6rem;
		padding: 0.8125em;
	}
}

@media screen and (min-width: 59.6875em) {
	.infinite-loader {
		margin: 8.3333% 0;
	}

	.infinite-wrap {
		margin-top: 8.3333%;
	}

	#infinite-handle {
		margin: 8.3333% 8.3333% 0;
	}

	#infinite-handle span {
		display: inline-block;
		font-size: 12px;
		font-size: 1.2rem;
		padding: 0.7917em 1.5833em;
	}

	#infinite-footer {
		display: block;
		position: fixed;
	}
}

@media screen and (min-width: 68.75em) {
	#infinite-handle span {
		display: inline-block;
		font-size: 14px;
		font-size: 1.4rem;
		padding: 0.8214em 1.5714em;
	}

	#infinite-footer .container {
		padding: 0 0.8235em;
	}

	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		height: 27px;
		line-height: 27px;
	}

	#infinite-footer .blog-info a {
		font-size: 14px;
		font-size: 1.4rem;
	}

	#infinite-footer .blog-credits {
		font-size: 12px;
		font-size: 1.2rem;
	}
}

@media screen and (min-width: 77.5em) {
	#infinite-handle span {
		font-size: 16px;
		font-size: 1.6rem;
		padding: 0.8125em 1.625em;
	}

	#infinite-footer .container {
		padding: 0 0.8421em;
	}

	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		height: 32px;
		line-height: 32px;
	}

	#infinite-footer .blog-info a {
		font-size: 16px;
		font-size: 1.6rem;
	}

	#infinite-footer .blog-credits {
		font-size: 13px;
		font-size: 1.3rem;
	}
}
twentyfifteen.php                                                                                                                                                                                                                                              915           1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Fifteen.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentyfifteen_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container' => 'main',
			'footer'    => 'page',
		)
	);
}
add_action( 'after_setup_theme', 'jetpack_twentyfifteen_infinite_scroll_init' );

/**
 * Enqueue CSS stylesheet with theme styles for Infinite Scroll.
 */
function jetpack_twentyfifteen_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		wp_enqueue_style( 'infinity-twentyfifteen', plugins_url( 'twentyfifteen.css', __FILE__ ), array( 'the-neverending-homepage' ), '20141022' );
		wp_style_add_data( 'infinity-twentyfifteen', 'rtl', 'replace' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentyfifteen_infinite_scroll_enqueue_styles', 25 );
twentyfourteen.css                                                                                                                                                                                                                                             1904          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* Spinner */

.infinite-loader {
	height: 36px;
	padding: 24px 0;
}

.infinite-loader .spinner {
	margin: 0 auto;
	top: 18px !important;
	left: 0 !important;
}

.rtl .infinite-loader .spinner {
	right: 0 !important;
	left: auto !important;
}

/* Click-to-load */

#infinite-handle {
	padding: 24px 0;
	text-align: center;
}

#infinite-handle span {
	background: #24890d;
	border-radius: 2px;
	display: inline-block;
	color: #fff;
	font-size: 12px;
	font-weight: 700;
	line-height: 1;
	padding: 12px 30px;
	text-transform: uppercase;
}

#infinite-handle span:hover {
	background-color: #41a62a;
}

#infinite-handle span:active {
	background-color: #55d737;
}

/* Footer */

#infinite-footer {
	z-index: 2;
}

#infinite-footer .container {
	margin: 0;
	padding: 4px 20px;
}

#infinite-footer .blog-info a {
	color: #2b2b2b;
}

#infinite-footer .blog-credits,
#infinite-footer .blog-credits a {
	color: #767676;
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-credits a:hover {
	color: #41a62a;
	text-decoration: none;
}

/* Elements to hide: post navigation, normal footer. */

.infinite-scroll .paging-navigation,
.infinite-scroll.neverending #colophon {
	display: none;
}

@media (max-width: 640px) {
	#infinite-footer {
		display: none;
	}
}

/* Hooks to infinity-end body class to restore footer. */

.infinity-end.neverending #colophon {
	display: block;
}

/* Reset top margin adjustment for subsequent posts added by Infinite Scroll */
.full-width .site-content .infinite-wrap .hentry.has-post-thumbnail:first-child {
	margin-top: 0;
}

@media screen and (min-width: 401px) {
	.infinite-loader,
	#infinite-handle {
		padding: 0 0 48px;
	}

	.list-view .site-content .infinite-wrap .hentry:first-of-type {
		border-top: 1px solid rgba(0, 0, 0, 0.1);
		padding-top: 48px;
	}

	.list-view .site-content .infinite-wrap .hentry.has-post-thumbnail {
		border-top: 0;
		padding-top: 0;
	}
}twentyfourteen.php                                                                                                                                                                                                                                             1642          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Fourteen.
 *
 * @package jetpack
 */

use Automattic\Jetpack\Device_Detection\User_Agent_Info;

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentyfourteen_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'content',
			'footer'         => 'page',
			'footer_widgets' => jetpack_twentyfourteen_has_footer_widgets(),
		)
	);
}
add_action( 'after_setup_theme', 'jetpack_twentyfourteen_infinite_scroll_init' );

/**
 * Switch to the "click to load" type IS with the following cases
 * 1. Viewed from iPad and the primary sidebar is active.
 * 2. Viewed from mobile and either the primary or the content sidebar is active.
 * 3. The footer widget is active.
 *
 * @return bool
 */
function jetpack_twentyfourteen_has_footer_widgets() {
	if ( function_exists( 'jetpack_is_mobile' ) ) {
		if ( ( User_Agent_Info::is_ipad() && is_active_sidebar( 'sidebar-1' ) )
			|| ( jetpack_is_mobile( '', true ) && ( is_active_sidebar( 'sidebar-1' ) || is_active_sidebar( 'sidebar-2' ) ) )
			|| is_active_sidebar( 'sidebar-3' ) ) {

			return true;
		}
	}

	return false;
}

/**
 * Enqueue CSS stylesheet with theme styles for Infinite Scroll.
 */
function jetpack_twentyfourteen_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		wp_enqueue_style( 'infinity-twentyfourteen', plugins_url( 'twentyfourteen.css', __FILE__ ), array( 'the-neverending-homepage' ), '20131118' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentyfourteen_infinite_scroll_enqueue_styles', 25 );
twentyseventeen-rtl.css                                                                                                                                                                                                                                        3294          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .infinite-scroll .pagination {
	display: none;
}

.infinite-wrap > article:before,
.infinite-wrap > article:after {
	content: "";
	display: table;
}

.infinite-wrap > article:after {
	clear: both;
}

.infinite-wrap > article {
	padding-bottom: 2em;
}

/* Spinner */
.site-main .infinite-loader {
	clear: both;
	color: currentColor;
	height: 42px;
	margin-bottom: 3.5em;
}

.blog:not(.has-sidebar) .infinite-loader {
	width: 100%;
}

.site-main .infinite-loader .spinner {
	right: 50%!important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin: 0 7.6923% 2em;
	text-align: center;
}

/* Style "Load More" button */
.site-main #infinite-handle span {
	background: #1a1a1a;
	border-radius: 2px;
	color: #fff;
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background: #767676;
}

/* Style "Load More" button when dark color scheme is used */
.colors-dark .site-main #infinite-handle span {
	background: #f8f8f8;
	border-radius: 2px;
	color: #222;
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

.colors-dark #infinite-handle span:hover,
.colors-dark #infinite-handle span:focus {
	background: #bbb;
	columns: #222;
}

/* Style Infinite Footer */
#infinite-footer {
	position: fixed !important;
}

#infinite-footer .container {
	background-color: #fff;
	border-color: #d1d1d1;
	padding: 0 7.6923%;
}

#infinite-footer .blog-info,
#infinite-footer .blog-credits {
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	text-align: center;
	width: auto;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits,
#infinite-footer .blog-credits a {
	color: #222222;
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	color: #767676;
	text-decoration: none;
}

.infinite-scroll #navigation,
.infinite-scroll.neverending .jetpack-mobile-link,
.infinite-scroll.neverending .site-footer {
	display: none;
}

/* Shows the footer & mobile link again in case all posts have been loaded */
.infinity-end.neverending .jetpack-mobile-link,
.infinity-end.neverending .site-footer {
	display: block;
}

@media screen and (min-width: 44.375em) {
	#infinite-handle {
		margin: 0 0 1em 0;
		text-align: center;
	}

	.has-sidebar #infinite-handle {
		text-align: right;
	}

	.site-main #infinite-handle span {
		display: inline-block;
	}
}

@media screen and (min-width: 48em) {
	.infinite-wrap > article {
		padding-bottom: 4em;
	}
}

@media screen and (min-width: 48em) {
	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		line-height: 35px;
	}

	#infinite-footer .blog-info {
		font-size: 1.1rem;
	}

	#infinite-footer .blog-credits {
		font-size: 0.9rem;
	}

	.blog:not(.has-sidebar) .infinite-loader {
		float: left;
		width: 58%;
	}

	.site-main .infinite-loader .spinner {
		margin-right: -17px;
	}
}
twentyseventeen.css                                                                                                                                                                                                                                            3292          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .infinite-scroll .pagination {
	display: none;
}

.infinite-wrap > article:before,
.infinite-wrap > article:after {
	content: "";
	display: table;
}

.infinite-wrap > article:after {
	clear: both;
}

.infinite-wrap > article {
	padding-bottom: 2em;
}

/* Spinner */
.site-main .infinite-loader {
	clear: both;
	color: currentColor;
	height: 42px;
	margin-bottom: 3.5em;
}

.blog:not(.has-sidebar) .infinite-loader {
	width: 100%;
}

.site-main .infinite-loader .spinner {
	left: 50%!important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin: 0 7.6923% 2em;
	text-align: center;
}

/* Style "Load More" button */
.site-main #infinite-handle span {
	background: #1a1a1a;
	border-radius: 2px;
	color: #fff;
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background: #767676;
}

/* Style "Load More" button when dark color scheme is used */
.colors-dark .site-main #infinite-handle span {
	background: #f8f8f8;
	border-radius: 2px;
	color: #222;
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

.colors-dark #infinite-handle span:hover,
.colors-dark #infinite-handle span:focus {
	background: #bbb;
	columns: #222;
}

/* Style Infinite Footer */
#infinite-footer {
	position: fixed !important;
}

#infinite-footer .container {
	background-color: #fff;
	border-color: #d1d1d1;
	padding: 0 7.6923%;
}

#infinite-footer .blog-info,
#infinite-footer .blog-credits {
	font-family: "Libre Franklin", "Helvetica Neue", helvetica, arial, sans-serif;
	text-align: center;
	width: auto;
}

#infinite-footer .blog-info a,
#infinite-footer .blog-credits,
#infinite-footer .blog-credits a {
	color: #222222;
}

#infinite-footer .blog-info a:hover,
#infinite-footer .blog-info a:focus,
#infinite-footer .blog-credits a:hover,
#infinite-footer .blog-credits a:focus {
	color: #767676;
	text-decoration: none;
}

.infinite-scroll #navigation,
.infinite-scroll.neverending .jetpack-mobile-link,
.infinite-scroll.neverending .site-footer {
	display: none;
}

/* Shows the footer & mobile link again in case all posts have been loaded */
.infinity-end.neverending .jetpack-mobile-link,
.infinity-end.neverending .site-footer {
	display: block;
}

@media screen and (min-width: 44.375em) {
	#infinite-handle {
		margin: 0 0 1em 0;
		text-align: center;
	}

	.has-sidebar #infinite-handle {
		text-align: left;
	}

	.site-main #infinite-handle span {
		display: inline-block;
	}
}

@media screen and (min-width: 48em) {
	.infinite-wrap > article {
		padding-bottom: 4em;
	}
}

@media screen and (min-width: 48em) {
	#infinite-footer .blog-info,
	#infinite-footer .blog-credits {
		line-height: 35px;
	}

	#infinite-footer .blog-info {
		font-size: 1.1rem;
	}

	#infinite-footer .blog-credits {
		font-size: 0.9rem;
	}

	.blog:not(.has-sidebar) .infinite-loader {
		float: right;
		width: 58%;
	}

	.site-main .infinite-loader .spinner {
		margin-left: -17px;
	}
}
twentyseventeen.php                                                                                                                                                                                                                                            1712          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Seventeen.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentyseventeen_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'main',
			'render'         => 'jetpack_twentyseventeen_infinite_scroll_render',
			'footer'         => 'content',
			'footer_widgets' => jetpack_twentyseventeen_has_footer_widgets(),
		)
	);
}
add_action( 'init', 'jetpack_twentyseventeen_infinite_scroll_init' );

/**
 * Custom render function for Infinite Scroll.
 */
function jetpack_twentyseventeen_infinite_scroll_render() {
	while ( have_posts() ) {
		the_post();
		if ( is_search() ) {
			get_template_part( 'template-parts/post/content', 'search' );
		} else {
			get_template_part( 'template-parts/post/content', get_post_format() );
		}
	}
}

/**
 * Custom function to check for the presence of footer widgets or the social links menu
 */
function jetpack_twentyseventeen_has_footer_widgets() {
	if ( is_active_sidebar( 'sidebar-2' ) ||
		is_active_sidebar( 'sidebar-3' ) ||
		has_nav_menu( 'social' ) ) {

		return true;
	}

	return false;
}

/**
 * Enqueue CSS stylesheet with theme styles for Infinite Scroll.
 */
function jetpack_twentyseventeen_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		wp_enqueue_style( 'infinity-twentyseventeen', plugins_url( 'twentyseventeen.css', __FILE__ ), array( 'the-neverending-homepage' ), '20161219' );
		wp_style_add_data( 'infinity-twentyseventeen', 'rtl', 'replace' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentyseventeen_infinite_scroll_enqueue_styles', 25 );
twentysixteen-rtl.css                                                                                                                                                                                                                                          2911          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .infinite-scroll .pagination {
	display: none;
}

.infinite-wrap > article:before,
.infinite-wrap > article:after {
	content: "";
	display: table;
}

.infinite-wrap > article:after {
	clear: both;
}

.infinite-wrap > article {
	margin-bottom: 3.5em;
}

/* Spinner */
.site-main .infinite-loader {
	clear: both;
	color: currentColor;
	height: 42px;
	margin-bottom: 3.5em;
}

.infinite-loader .spinner {
	right: 50% !important;
	top: 50% !important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin-right: 7.6923%;
	margin-left: 7.6923%;
	text-align: center;
}

.site-main #infinite-handle span {
	background: #1a1a1a;
	border-radius: 2px;
	color: #fff;
	font-family: Montserrat, "Helvetica Neue", sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background: #007acc;
}

#infinite-handle button:focus {
	outline-offset: 0.375em;
}

/* Footer */
body #infinite-footer {
	display: none;
	z-index: 999;
}

body #infinite-footer .container {
	background-color: #fff;
	background-color: rgba(255, 255, 255, 0.8);
	border-color: #d1d1d1;
	padding: 0 7.6923%;
	width: 100% !important;
}

body #infinite-footer .blog-info {
	font-family: Montserrat, "Helvetica Neue", sans-serif;
	height: 2.1875em;
	line-height: 2.1875em;
}

body #infinite-footer .blog-info a {
	color: #1a1a1a;
	font-size: inherit
}

body #infinite-footer .blog-credits {
	font-size: 13px;
	font-size: 0.8125rem;
	height: 2.692307692em;
	line-height: 2.692307692em;
}

body #infinite-footer .blog-credits,
body #infinite-footer .blog-credits a {
	color: #686868;
}

body #infinite-footer .blog-info a:hover,
body #infinite-footer .blog-info a:focus,
body #infinite-footer .blog-credits a:hover,
body #infinite-footer .blog-credits a:focus {
	color: #007acc;
	text-decoration: none;
}

@media screen and (min-width: 44.375em) {
	.infinite-wrap > article,
	.site-main .infinite-loader {
		margin-bottom: 5.25em;
	}

	.infinite-loader .spinner {
		right: 7.6923% !important;
		margin-right: 12px;
	}

	#infinite-handle {
		text-align: right;
	}

	.site-main #infinite-handle span {
		display: inline-block;
	}

	body #infinite-footer .container {
		padding: 0 0.761904762em;
		width: -webkit-calc(100% - 42px) !important;
		width: calc(100% - 42px) !important;
	}

	body:not(.custom-background-image) #infinite-footer {
		bottom: 21px !important;
	}
}

@media screen and (min-width: 56.875em) {
	.infinite-loader .spinner {
		right: 0 !important;
	}

	#infinite-handle {
		margin: 0;
	}

	.no-sidebar .infinite-loader .spinner {
		right: 50% !important;
		margin: 0;
	}

	.no-sidebar #infinite-handle {
		text-align: center;
	}
}

@media screen and (min-width: 61.5625em) {
	.infinite-wrap > article,
	.site-main .infinite-loader {
		margin-bottom: 7.0em;
	}
}
twentysixteen.css                                                                                                                                                                                                                                              2905          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .infinite-scroll .pagination {
	display: none;
}

.infinite-wrap > article:before,
.infinite-wrap > article:after {
	content: "";
	display: table;
}

.infinite-wrap > article:after {
	clear: both;
}

.infinite-wrap > article {
	margin-bottom: 3.5em;
}

/* Spinner */
.site-main .infinite-loader {
	clear: both;
	color: currentColor;
	height: 42px;
	margin-bottom: 3.5em;
}

.infinite-loader .spinner {
	left: 50% !important;
	top: 50% !important;
}

/* Click-to-load */
#infinite-handle {
	clear: both;
	margin-right: 7.6923%;
	margin-left: 7.6923%;
	text-align: center;
}

.site-main #infinite-handle span {
	background: #1a1a1a;
	border-radius: 2px;
	color: #fff;
	font-family: Montserrat, "Helvetica Neue", sans-serif;
	font-size: inherit;
	font-weight: 700;
	letter-spacing: 0.046875em;
	line-height: 1;
	padding: 0.84375em 0.875em 0.78125em;
	text-transform: uppercase;
}

#infinite-handle span:hover,
#infinite-handle span:focus {
	background: #007acc;
}

#infinite-handle button:focus {
	outline-offset: 0.375em;
}

/* Footer */
body #infinite-footer {
	display: none;
	z-index: 999;
}

body #infinite-footer .container {
	background-color: #fff;
	background-color: rgba(255, 255, 255, 0.8);
	border-color: #d1d1d1;
	padding: 0 7.6923%;
	width: 100% !important;
}

body #infinite-footer .blog-info {
	font-family: Montserrat, "Helvetica Neue", sans-serif;
	height: 2.1875em;
	line-height: 2.1875em;
}

body #infinite-footer .blog-info a {
	color: #1a1a1a;
	font-size: inherit
}

body #infinite-footer .blog-credits {
	font-size: 13px;
	font-size: 0.8125rem;
	height: 2.692307692em;
	line-height: 2.692307692em;
}

body #infinite-footer .blog-credits,
body #infinite-footer .blog-credits a {
	color: #686868;
}

body #infinite-footer .blog-info a:hover,
body #infinite-footer .blog-info a:focus,
body #infinite-footer .blog-credits a:hover,
body #infinite-footer .blog-credits a:focus {
	color: #007acc;
	text-decoration: none;
}

@media screen and (min-width: 44.375em) {
	.infinite-wrap > article,
	.site-main .infinite-loader {
		margin-bottom: 5.25em;
	}

	.infinite-loader .spinner {
		left: 7.6923% !important;
		margin-left: 12px;
	}

	#infinite-handle {
		text-align: left;
	}

	.site-main #infinite-handle span {
		display: inline-block;
	}

	body #infinite-footer .container {
		padding: 0 0.761904762em;
		width: -webkit-calc(100% - 42px) !important;
		width: calc(100% - 42px) !important;
	}

	body:not(.custom-background-image) #infinite-footer {
		bottom: 21px !important;
	}
}

@media screen and (min-width: 56.875em) {
	.infinite-loader .spinner {
		left: 0 !important;
	}

	#infinite-handle {
		margin: 0;
	}

	.no-sidebar .infinite-loader .spinner {
		left: 50% !important;
		margin: 0;
	}

	.no-sidebar #infinite-handle {
		text-align: center;
	}
}

@media screen and (min-width: 61.5625em) {
	.infinite-wrap > article,
	.site-main .infinite-loader {
		margin-bottom: 7.0em;
	}
}
twentysixteen.php                                                                                                                                                                                                                                              1310          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Sixteen.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentysixteen_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container' => 'main',
			'render'    => 'jetpack_twentysixteen_infinite_scroll_render',
			'footer'    => 'content',
		)
	);
}
add_action( 'after_setup_theme', 'jetpack_twentysixteen_infinite_scroll_init' );

/**
 * Custom render function for Infinite Scroll.
 */
function jetpack_twentysixteen_infinite_scroll_render() {
	while ( have_posts() ) {
		the_post();
		if ( is_search() ) {
			get_template_part( 'template-parts/content', 'search' );
		} else {
			get_template_part( 'template-parts/content', get_post_format() );
		}
	}
}

/**
 * Enqueue CSS stylesheet with theme styles for Infinite Scroll.
 */
function jetpack_twentysixteen_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		wp_enqueue_style( 'infinity-twentysixteen', plugins_url( 'twentysixteen.css', __FILE__ ), array( 'the-neverending-homepage' ), '20151102' );
		wp_style_add_data( 'infinity-twentysixteen', 'rtl', 'replace' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentysixteen_infinite_scroll_enqueue_styles', 25 );
twentyten.css                                                                                                                                                                                                                                                  601           1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* =Infinity Styles
-------------------------------------------------------------- */
.infinite-scroll #wrapper {
	margin-bottom: 40px;
}
.infinite-scroll #content {
	margin-bottom: 50px;
}
.infinite-scroll #content .infinite-wrap {
	padding-top: 0;
	border-top: 0;
}
/* Elements to hide */
.infinite-scroll #nav-above,
.infinite-scroll #nav-below,
.infinite-scroll.neverending #footer {
	display: none;
}
/* Restore the footer when IS is finished */
.infinity-end.neverending #footer {
	display: block;
}
#infinite-footer .blog-info a {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}twentyten.php                                                                                                                                                                                                                                                  1575          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for @Twenty Ten and enqueue relevant styles.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinity scroll
 */
function jetpack_twentyten_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'content',
			'render'         => 'jetpack_twentyten_infinite_scroll_render',
			'footer'         => 'wrapper',
			'footer_widgets' => jetpack_twentyten_has_footer_widgets(),
		)
	);
}
add_action( 'init', 'jetpack_twentyten_infinite_scroll_init' );

/**
 * Set the code to be rendered on for calling posts,
 * hooked to template parts when possible.
 *
 * Note: must define a loop.
 */
function jetpack_twentyten_infinite_scroll_render() {
	get_template_part( 'loop' );
}

/**
 * Enqueue CSS stylesheet with theme styles for infinity.
 */
function jetpack_twentyten_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		// Add theme specific styles.
		wp_enqueue_style( 'infinity-twentyten', plugins_url( 'twentyten.css', __FILE__ ), array( 'the-neverending-homepage' ), '20121002' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentyten_infinite_scroll_enqueue_styles', 25 );

/**
 * Do we have footer widgets?
 */
function jetpack_twentyten_has_footer_widgets() {
	if ( is_active_sidebar( 'first-footer-widget-area' ) ||
		is_active_sidebar( 'second-footer-widget-area' ) ||
		is_active_sidebar( 'third-footer-widget-area' ) ||
		is_active_sidebar( 'fourth-footer-widget-area' ) ) {

		return true;
	}

	return false;
}
twentythirteen.css                                                                                                                                                                                                                                             2235          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* =Infinite Scroll
-------------------------------------------------------------- */

.infinite-wrap {
	border-top: 0;
}

/* Spinner */
.infinite-loader {
	background-color: #e8e5ce;
	padding: 40px 0;
}
.infinite-loader .spinner {
	margin: 0 auto;
	width: 34px;
	height: 34px;
}
.sidebar .infinite-loader .spinner {
	padding-right: 376px;
}
.rtl.sidebar .infinite-loader .spinner {
	padding-left: 376px;
	padding-right: 0;
}

/* Click-to-load */
#infinite-handle {
	background-color: #e8e5ce;
	padding: 40px 0;
	text-align: center;
}
.sidebar #infinite-handle {
	padding-right: 376px;
}
.rtl.sidebar #infinite-handle {
	padding-left: 376px;
	padding-right: 0;
}
#infinite-handle span {
	background: #e05d22; /* Old browsers */
	background: -webkit-linear-gradient(top, #e05d22 0%, #d94412 100%); /* Chrome 10+, Safari 5.1+ */
	background:   linear-gradient(to bottom, #e05d22 0%, #d94412 100%); /* W3C */
	border: none;
	border-bottom: 3px solid #b93207;
	border-radius: 2px;
	display: inline-block;
	color: #fff;
	font-size: 100%;
	padding: 11px 24px 10px;
	text-decoration: none;
}
#infinite-handle span:hover {
	background: #ed6a31; /* Old browsers */
	background: -webkit-linear-gradient(top, #ed6a31 0%, #e55627 100%); /* Chrome 10+, Safari 5.1+ */
	background:   linear-gradient(to bottom, #ed6a31 0%, #e55627 100%); /* W3C */
	outline: none;
}
#infinite-handle span:active {
	background: #d94412; /* Old browsers */
	background: -webkit-linear-gradient(top, #d94412 0%, #e05d22 100%); /* Chrome 10+, Safari 5.1+ */
	background:   linear-gradient(to bottom, #d94412 0%, #e05d22 100%); /* W3C */
	border: none;
	border-top: 3px solid #b93207;
	padding: 10px 24px 11px;
}

/* Elements to hide: post navigation, normal footer. */
.infinite-scroll .paging-navigation,
.infinite-scroll.neverending #colophon {
	display: none;
}

/* Hooks to infinity-end body class to restore footer. */
.infinity-end.neverending #colophon {
	display: block;
}

/* For small viewports. */
@media (max-width: 999px) {
	.sidebar .infinite-loader .spinner,
	.rtl.sidebar .infinite-loader .spinner {
		padding-right: 0;
		padding-left: 0;
	}
	.infinite-scroll #infinite-handle,
	.rtl.sidebar #infinite-handle {
		padding-right: 0;
		padding-left: 0;
	}
}twentythirteen.php                                                                                                                                                                                                                                             913           1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Thirteen.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentythirteen_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'content',
			'footer'         => 'page',
			'footer_widgets' => array( 'sidebar-1' ),
		)
	);
}
add_action( 'after_setup_theme', 'jetpack_twentythirteen_infinite_scroll_init' );

/**
 * Enqueue CSS stylesheet with theme styles for Infinite Scroll.
 */
function jetpack_twentythirteen_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		wp_enqueue_style( 'infinity-twentythirteen', plugins_url( 'twentythirteen.css', __FILE__ ), array( 'the-neverending-homepage' ), '20130409' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentythirteen_infinite_scroll_enqueue_styles', 25 );
twentytwelve.css                                                                                                                                                                                                                                               721           1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* =Infinity Styles
-------------------------------------------------------------- */
.infinite-scroll .site-content:after {
	clear: both;
	content: '';
	display: block;
}
.infinite-wrap {
	border-top: 0;
}
.infinite-scroll.neverending .site-content {
	margin-bottom: 48px;
	margin-bottom: 3.428571429rem;
}

/* Elements to hide: post navigation, regular footer */
.infinite-scroll #nav-below,
.infinite-scroll.neverending #colophon {
	display: none;
}

/* Hooks to infinity-end body class to restore footer */
.infinity-end.neverending #colophon {
	display: block;
}

/* For responsive CSS */
@media (max-width: 599px) {
	.infinite-scroll #infinite-handle {
		padding-bottom: 48px;
		padding-bottom: 3.428571429rem;
	}
}twentytwelve.php                                                                                                                                                                                                                                               1347          1711191384  plugins/jetpack/modules/infinite-scroll/themes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Infinite Scroll Theme Assets
 *
 * Register support for Twenty Twelve and enqueue relevant styles.
 *
 * @package jetpack
 */

/**
 * Add theme support for infinite scroll
 */
function jetpack_twentytwelve_infinite_scroll_init() {
	add_theme_support(
		'infinite-scroll',
		array(
			'container'      => 'content',
			'footer'         => 'page',
			'footer_widgets' => jetpack_twentytwelve_has_footer_widgets(),
		)
	);
}
add_action( 'after_setup_theme', 'jetpack_twentytwelve_infinite_scroll_init' );

/**
 * Enqueue CSS stylesheet with theme styles for infinity.
 */
function jetpack_twentytwelve_infinite_scroll_enqueue_styles() {
	if ( wp_script_is( 'the-neverending-homepage' ) ) {
		// Add theme specific styles.
		wp_enqueue_style( 'infinity-twentytwelve', plugins_url( 'twentytwelve.css', __FILE__ ), array( 'the-neverending-homepage' ), '20120817' );
	}
}
add_action( 'wp_enqueue_scripts', 'jetpack_twentytwelve_infinite_scroll_enqueue_styles', 25 );

/**
 * Do we have footer widgets?
 */
function jetpack_twentytwelve_has_footer_widgets() {
	if ( function_exists( 'jetpack_is_mobile' ) && jetpack_is_mobile() ) {
		if ( is_front_page() && ( is_active_sidebar( 'sidebar-2' ) || is_active_sidebar( 'sidebar-3' ) ) ) {
			return true;
		} elseif ( is_active_sidebar( 'sidebar-1' ) ) {
			return true;
		}
	}

	return false;
}
infinite-scroll.php                                                                                                                                                                                                                                            8386          1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * Module Name: Infinite Scroll
 * Module Description: Automatically load new content when a visitor scrolls
 * Sort Order: 26
 * First Introduced: 2.0
 * Requires Connection: No
 * Auto Activate: No
 * Module Tags: Appearance
 * Feature: Appearance
 * Additional Search Queries: scroll, infinite, infinite scroll
 */

use Automattic\Jetpack\Current_Plan as Jetpack_Plan;
use Automattic\Jetpack\Stats\Options as Stats_Options;

/**
 * Jetpack-specific elements of Infinite Scroll
 */
class Jetpack_Infinite_Scroll_Extras {
	/**
	 * Class variable singleton.
	 *
	 * @var Jetpack_Infinite_Scroll_Extras
	 */
	private static $instance = null;

	/**
	 * Option names.
	 *
	 * @var string
	 */
	private $option_name_google_analytics = 'infinite_scroll_google_analytics';

	/**
	 * Singleton implementation
	 *
	 * @return object
	 */
	public static function instance() {
		if ( ! self::$instance instanceof Jetpack_Infinite_Scroll_Extras ) {
			self::$instance = new Jetpack_Infinite_Scroll_Extras();
		}

		return self::$instance;
	}

	/**
	 * Register actions and filters
	 *
	 * @uses add_action, add_filter
	 */
	private function __construct() {
		add_action( 'jetpack_modules_loaded', array( $this, 'action_jetpack_modules_loaded' ) );

		add_action( 'admin_init', array( $this, 'action_admin_init' ), 11 );

		add_action( 'after_setup_theme', array( $this, 'action_after_setup_theme' ), 5 );

		add_filter( 'infinite_scroll_js_settings', array( $this, 'filter_infinite_scroll_js_settings' ) );

		add_action( 'wp_enqueue_scripts', array( $this, 'action_wp_enqueue_scripts' ) );
	}

	/**
	 * Enable "Configure" button on module card
	 *
	 * @uses Jetpack::enable_module_configurable
	 * @action jetpack_modules_loaded
	 */
	public function action_jetpack_modules_loaded() {
		Jetpack::enable_module_configurable( __FILE__ );
	}

	/**
	 * Register Google Analytics setting
	 *
	 * @uses add_settings_field, __, register_setting
	 * @action admin_init
	 */
	public function action_admin_init() {
		if ( ! Jetpack_Plan::supports( 'google-analytics' ) ) {
			return;
		}

		add_settings_field( $this->option_name_google_analytics, '<span id="infinite-scroll-google-analytics">' . __( 'Use Google Analytics with Infinite Scroll', 'jetpack' ) . '</span>', array( $this, 'setting_google_analytics' ), 'reading' );
		register_setting( 'reading', $this->option_name_google_analytics, array( $this, 'sanitize_boolean_value' ) );
	}

	/**
	 * Render Google Analytics option
	 *
	 * @uses checked, get_option, __
	 */
	public function setting_google_analytics() {
		echo '<label><input name="infinite_scroll_google_analytics" type="checkbox" value="1" ' . checked( true, (bool) get_option( $this->option_name_google_analytics, false ), false ) . ' /> ' . esc_html__( 'Track each scroll load (7 posts by default) as a page view in Google Analytics', 'jetpack' ) . '</label>';
		echo '<p class="description">' . esc_html__( 'Check the box above to record each new set of posts loaded via Infinite Scroll as a page view in Google Analytics.', 'jetpack' ) . '</p>';
	}

	/**
	 * Sanitize value as a boolean
	 *
	 * @param mixed $value - the value we're sanitizing.
	 * @return bool
	 */
	public function sanitize_boolean_value( $value ) {
		return (bool) $value;
	}

	/**
	 * Load theme's infinite scroll annotation file, if present in the IS plugin.
	 * The `setup_theme` action is used because the annotation files should be using `after_setup_theme` to register support for IS.
	 *
	 * As released in Jetpack 2.0, a child theme's parent wasn't checked for in the plugin's bundled support, hence the convoluted way the parent is checked for now.
	 *
	 * @uses is_admin, wp_get_theme, apply_filters
	 * @action setup_theme
	 * @return null
	 */
	public function action_after_setup_theme() {
		$theme = wp_get_theme();

		if ( ! $theme instanceof WP_Theme && ! is_array( $theme ) ) {
			return;
		}

		/** This filter is already documented in modules/infinite-scroll/infinity.php */
		$customization_file = apply_filters( 'infinite_scroll_customization_file', __DIR__ . "/infinite-scroll/themes/{$theme['Stylesheet']}.php", $theme['Stylesheet'] );

		if ( is_readable( $customization_file ) ) {
			require_once $customization_file;
		} elseif ( ! empty( $theme['Template'] ) ) {
			$customization_file = __DIR__ . "/infinite-scroll/themes/{$theme['Template']}.php";

			if ( is_readable( $customization_file ) ) {
				require_once $customization_file;
			}
		}
	}

	/**
	 * Modify Infinite Scroll configuration information
	 *
	 * @uses Jetpack::get_active_modules, is_user_logged_in, stats_get_options, Jetpack_Options::get_option, get_option, JETPACK__API_VERSION, JETPACK__VERSION
	 * @filter infinite_scroll_js_settings
	 *
	 * @param array $settings - the settings.
	 * @return array
	 */
	public function filter_infinite_scroll_js_settings( $settings ) {
		// Provide WP Stats info for tracking Infinite Scroll loads
		// Abort if Stats module isn't active
		if ( in_array( 'stats', Jetpack::get_active_modules(), true ) ) {
			// Abort if user is logged in but logged-in users shouldn't be tracked.
			if ( is_user_logged_in() ) {
				$stats_options        = Stats_Options::get_options();
				$track_loggedin_users = isset( $stats_options['count_roles'] ) ? (bool) $stats_options['count_roles'] : false;

				if ( ! $track_loggedin_users ) {
					return $settings;
				}
			}

			// We made it this far, so gather the data needed to track IS views
			$settings['stats'] = 'blog=' . Jetpack_Options::get_option( 'id' ) . '&host=' . wp_parse_url( get_option( 'home' ), PHP_URL_HOST ) . '&v=ext&j=' . JETPACK__API_VERSION . ':' . JETPACK__VERSION;

			// Pagetype parameter
			$settings['stats'] .= '&x_pagetype=infinite';
			if ( 'click' === $settings['type'] ) {
				$settings['stats'] .= '-click';
			}

			$settings['stats'] .= '-jetpack';
		}

		// Check if Google Analytics tracking is requested.
		$settings['google_analytics'] = Jetpack_Plan::supports( 'google-analytics' ) && Jetpack_Options::get_option_and_ensure_autoload( $this->option_name_google_analytics, 0 );

		return $settings;
	}

	/**
	 * Always load certain scripts when IS is enabled, as they can't be loaded after `document.ready` fires, meaning they can't leverage IS's script loader.
	 *
	 * @global $videopress
	 * @uses do_action()
	 * @uses apply_filters()
	 * @uses wp_enqueue_style()
	 * @uses wp_enqueue_script()
	 * @action wp_enqueue_scripts
	 * @return null
	 */
	public function action_wp_enqueue_scripts() {
		// Do not load scripts and styles on singular pages and static pages
		$load_scripts_and_styles = ! ( is_singular() || is_page() );
		if (
			/**
			 * Allow plugins to enqueue all Infinite Scroll scripts and styles on singular pages as well.
			 *
			 *  @module infinite-scroll
			 *
			 * @since 3.1.0
			 *
			 * @param bool $load_scripts_and_styles Should scripts and styles be loaded on singular pahes and static pages. Default to false.
			 */
			! apply_filters( 'jetpack_infinite_scroll_load_scripts_and_styles', $load_scripts_and_styles )
		) {
			return;
		}

		// VideoPress stand-alone plugin
		global $videopress;
		if ( ! empty( $videopress ) && The_Neverending_Home_Page::archive_supports_infinity() && is_a( $videopress, 'VideoPress' ) && method_exists( $videopress, 'enqueue_scripts' ) ) {
			$videopress->enqueue_scripts();
		}

		// VideoPress Jetpack module
		if ( Jetpack::is_module_active( 'videopress' ) ) {
			wp_enqueue_script( 'videopress' );
		}

		// Fire the post_gallery action early so Carousel scripts are present.
		if ( Jetpack::is_module_active( 'carousel' ) ) {
			/** This filter is already documented in core/wp-includes/media.php */
			do_action( 'post_gallery', '', '', 0 );
		}

		// Always enqueue Tiled Gallery scripts when both IS and Tiled Galleries are enabled
		if ( Jetpack::is_module_active( 'tiled-gallery' ) ) {
			Jetpack_Tiled_Gallery::default_scripts_and_styles();
		}
	}
}
Jetpack_Infinite_Scroll_Extras::instance();

/**
 * Load main IS file
 */
require_once __DIR__ . '/infinite-scroll/infinity.php';

/**
 * Remove the IS annotation loading function bundled with the IS plugin in favor of the Jetpack-specific version in Jetpack_Infinite_Scroll_Extras::action_after_setup_theme();
 */
remove_action( 'after_setup_theme', 'the_neverending_home_page_theme_support', 5 );
json-api.php                                                                                                                                                                                                                                                   484           1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: JSON API
 * Module Description: Allow applications to securely access your content.
 * Sort Order: 19
 * First Introduced: 1.9
 * Requires Connection: Yes
 * Auto Activate: Public
 * Module Tags: Writing, Developers
 * Feature: General
 * Additional Search Queries: api, rest, develop, developers, json, klout, oauth
 *
 * @package automattic/jetpack
 */

// Nothing fires here. Module status is checked on the WP.com-side to allow third-party applications.
latex.php                                                                                                                                                                                                                                                      4720          1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Beautiful Math
 * Module Description: Use the LaTeX markup language to write mathematical equations and formulas
 * Sort Order: 12
 * First Introduced: 1.1
 * Requires Connection: No
 * Auto Activate: No
 * Module Tags: Writing
 * Feature: Writing
 * Additional Search Queries: latex, math, equation, equations, formula, code
 *
 * @package automattic/jetpack
 */

/**
 * LaTeX support.
 *
 * Backward compatibility requires support for both "[latex][/latex]", and
 * "$latex $" shortcodes.
 *
 * $latex e^{\i \pi} + 1 = 0$  ->  [latex]e^{\i \pi} + 1 = 0[/latex]
 * $latex [a, b]$              ->  [latex][a, b][/latex]
 */

/**
 * Markup LaTeX content.
 *
 * @param string $content Post or comment contents to markup.
 */
function latex_markup( $content ) {
	$textarr = wp_html_split( $content );

	$regex = '%
		\$latex(?:=\s*|\s+)
		((?:
			[^$]+ # Not a dollar
		|
			(?<=(?<!\\\\)\\\\)\$ # Dollar preceded by exactly one slash
		)+)
		(?<!\\\\)\$ # Dollar preceded by zero slashes
	%ix';

	foreach ( $textarr as &$element ) {
		if ( '' === $element || '<' === $element[0] ) {
			continue;
		}

		if ( false === stripos( $element, '$latex' ) ) {
			continue;
		}

		$element = preg_replace_callback( $regex, 'latex_src', $element );
	}

	return implode( '', $textarr );
}

/**
 * Process LaTeX string to rendered image.
 *
 * @param array $matches Matched regex results.
 */
function latex_src( $matches ) {
	$latex = $matches[1];

	$bg = latex_get_default_color( 'bg' );
	$fg = latex_get_default_color( 'text', '000' );
	$s  = 0;

	$latex = latex_entity_decode( $latex );
	if ( preg_match( '/.+(&fg=[0-9a-f]{6}).*/i', $latex, $fg_matches ) ) {
		$fg    = substr( $fg_matches[1], 4 );
		$latex = str_replace( $fg_matches[1], '', $latex );
	}
	if ( preg_match( '/.+(&bg=[0-9a-f]{6}).*/i', $latex, $bg_matches ) ) {
		$bg    = substr( $bg_matches[1], 4 );
		$latex = str_replace( $bg_matches[1], '', $latex );
	}
	if ( preg_match( '/.+(&s=[0-9-]{1,2}).*/i', $latex, $s_matches ) ) {
		$s     = (int) substr( $s_matches[1], 3 );
		$latex = str_replace( $s_matches[1], '', $latex );
	}

	return latex_render( $latex, $fg, $bg, $s );
}

/**
 * Get the default color for an attribute.
 *
 * @param string $color Attribute to color (e.g. bg).
 * @param string $default_color Default fallback color to use.
 */
function latex_get_default_color( $color, $default_color = 'ffffff' ) {
	global $themecolors;
	return isset( $themecolors[ $color ] ) ? $themecolors[ $color ] : $default_color;
}

/**
 * Decode special characters in a LaTeX string.
 *
 * @param string $latex Character encoded content.
 */
function latex_entity_decode( $latex ) {
	return str_replace( array( '&lt;', '&gt;', '&quot;', '&#039;', '&#038;', '&amp;', "\n", "\r" ), array( '<', '>', '"', "'", '&', '&', ' ', ' ' ), $latex );
}

/**
 * Returns the URL for the server-side rendered image of LaTeX.
 *
 * @param string $latex LaTeX string.
 * @param string $fg Foreground color.
 * @param string $bg Background color.
 * @param int    $s Matches.
 *
 * @return string Image URL for the rendered LaTeX.
 */
function latex_render( $latex, $fg, $bg, $s = 0 ) {
	$url = add_query_arg(
		urlencode_deep(
			array(
				'latex' => $latex,
				'bg'    => $bg,
				'fg'    => $fg,
				's'     => $s,
				'c'     => '20201002', // cache buster. Added 2020-10-02 after server migration caused faulty rendering.
			)
		),
		( is_ssl() ? 'https://' : 'http://' ) . 's0.wp.com/latex.php'
	);

	$alt = str_replace( '\\', '&#92;', esc_attr( $latex ) );

	return sprintf(
		'<img src="%1$s" alt="%2$s" class="latex" />',
		esc_url( $url ),
		$alt
	);
}

/**
 * The shortcode way. The attributes are the same as the old ones - 'fg' and 'bg', instead of foreground
 * and background, and 's' is for the font size.
 *
 * Example: [latex s=4 bg=00f fg=ff0]\LaTeX[/latex]
 *
 * @param array  $atts Shortcode attributes.
 * @param string $content Content to format.
 */
function latex_shortcode( $atts, $content = '' ) {
	$attr = shortcode_atts(
		array(
			's'  => 0,
			'bg' => latex_get_default_color( 'bg' ),
			'fg' => latex_get_default_color( 'text', '000' ),
		),
		$atts,
		'latex'
	);

	return latex_render( latex_entity_decode( $content ), $attr['fg'], $attr['bg'], $attr['s'] );
}

/**
 * LaTeX needs to be untexturized.
 *
 * @param array $shortcodes Array of shortcodes not to texturize.
 */
function latex_no_texturize( $shortcodes ) {
	$shortcodes[] = 'latex';
	return $shortcodes;
}
add_filter( 'no_texturize_shortcodes', 'latex_no_texturize' );

add_filter( 'the_content', 'latex_markup', 9 ); // Before wptexturize.
add_filter( 'comment_text', 'latex_markup', 9 ); // Before wptexturize.
add_shortcode( 'latex', 'latex_shortcode' );
jetpack-likes-master-iframe.php                                                                                                                                                                                                                                1854          1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Jetpack likes iframe.
 *
 * @package jetpack
 */

/**
 * This function needs to get loaded after the like scripts get added to the page.
 */
function jetpack_likes_master_iframe() {
	$version = gmdate( 'Ymd' );

	$_locale = get_locale();

	if ( ! defined( 'JETPACK__GLOTPRESS_LOCALES_PATH' ) || ! file_exists( JETPACK__GLOTPRESS_LOCALES_PATH ) ) {
		return false;
	}

	require_once JETPACK__GLOTPRESS_LOCALES_PATH;

	$gp_locale = GP_Locales::by_field( 'wp_locale', $_locale );
	$_locale   = isset( $gp_locale->slug ) ? $gp_locale->slug : '';

	$likes_locale = ( '' === $_locale || 'en' === $_locale ) ? '' : '&amp;lang=' . strtolower( $_locale );
	/** This filter is documented in projects/plugins/jetpack/modules/likes.php */
	$new_layout       = apply_filters( 'likes_new_layout', true ) ? '&amp;n=1' : '';
	$new_layout_class = $new_layout ? 'wpl-new-layout' : '';

	$src = sprintf(
		'https://widgets.wp.com/likes/master.html?ver=%1$s#ver=%1$s%2$s%3$s',
		$version,
		$likes_locale,
		$new_layout
	);

	if ( $new_layout ) {
		// The span content is replaced by queuehandler when showOtherGravatars is called.
		$likers_text = wp_kses( '<span>%d</span>', array( 'span' => array() ) );
	} else {
		/* translators: The value of %d is not available at the time of output */
		$likers_text = wp_kses( __( '<span>%d</span> bloggers like this:', 'jetpack' ), array( 'span' => array() ) );
	}
	?>
	<iframe src='<?php echo esc_url( $src ); ?>' scrolling='no' id='likes-master' name='likes-master' style='display:none;'></iframe>
	<div id='likes-other-gravatars' class='<?php echo esc_attr( $new_layout_class ); ?>' role="dialog" aria-hidden="true" tabindex="-1"><div class="likes-text"><?php echo $likers_text; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped ?></div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
	<?php
}
jetpack-likes-settings.php                                                                                                                                                                                                                                     25286         1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName

use Automattic\Jetpack\Sync\Settings;

/**
 * Jetpack likes settings class.
 */
class Jetpack_Likes_Settings {

	/**
	 * False if running on WPCOM Simple
	 *
	 * @var bool
	 */
	public $in_jetpack;

	/**
	 * Constructor function.
	 */
	public function __construct() {
		$this->in_jetpack = ! ( defined( 'IS_WPCOM' ) && IS_WPCOM );
	}

	/**
	 * Replaces the "Sharing" title for the post screen metabox with "Likes and Shares"
	 */
	public function add_likes_to_sharing_meta_box_title() {
		return __( 'Likes and Shares', 'jetpack' );
	}

	/**
	 * Adds a metabox to the post screen if the sharing one doesn't currently exist.
	 */
	public function add_meta_box() {
		if (
			/**
			 * Allow disabling of the Likes metabox on the post editor screen.
			 *
			 * @module likes
			 *
			 * @since 2.2.0
			 *
			 * @param bool false Should the Likes metabox be disabled? Default to false.
			 */
		apply_filters( 'post_flair_disable', false )
		) {
			return;
		}

		$post_types = get_post_types( array( 'public' => true ) );
		/**
		 * Filters the Likes metabox title.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param string Likes metabox title. Default to "Likes".
		 */
		$title = apply_filters( 'likes_meta_box_title', __( 'Likes', 'jetpack' ) );
		foreach ( $post_types as $post_type ) {
			add_meta_box( 'likes_meta', $title, array( $this, 'meta_box_content' ), $post_type, 'side', 'default', array( '__back_compat_meta_box' => true ) );
		}
	}

	/**
	 * Shows the likes option in the post screen metabox.
	 *
	 * @param object $post - the post object.
	 */
	public function meta_box_content( $post ) {
		$post_id         = ! empty( $post->ID ) ? (int) $post->ID : get_the_ID();
		$checked         = true;
		$disabled        = ! $this->is_enabled_sitewide();
		$switched_status = get_post_meta( $post_id, 'switch_like_status', true );

		if ( $disabled && empty( $switched_status ) || ! $disabled && $switched_status === '0' ) {
			$checked = false;
		}

		/**
		 * Fires before the Likes meta box content in the post editor.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param WP_Post|array|null $post Post data.
		 */
		do_action( 'start_likes_meta_box_content', $post );
		?>

		<p>
			<label for="wpl_enable_post_likes">
				<input type="checkbox" name="wpl_enable_post_likes" id="wpl_enable_post_likes" value="1" <?php checked( $checked ); ?>>
				<?php esc_html_e( 'Show likes.', 'jetpack' ); ?>
			</label>
			<input type="hidden" name="wpl_like_status_hidden" value="1" />
			<?php wp_nonce_field( 'likes-and-shares', '_likesharenonce' ); ?>
		</p> 
		<?php
		/**
		 * Fires after the Likes meta box content in the post editor.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param WP_Post|array|null $post Post data.
		 */
		do_action( 'end_likes_meta_box_content', $post );
	}

	/**
	 * Returns the current state of the "WordPress.com Likes are" option.
	 *
	 * @return boolean true if enabled sitewide, false if not
	 */
	public function is_enabled_sitewide() {
		/**
		 * Filters whether Likes are enabled by default on all posts.
		 * true if enabled sitewide, false if not.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $option Are Likes enabled sitewide.
		 */
		return (bool) apply_filters( 'wpl_is_enabled_sitewide', ! Jetpack_Options::get_option_and_ensure_autoload( 'disabled_likes', 0 ) );
	}

	/**
	 * Handle meta box saving.
	 *
	 * @param int $post_id - the post ID.
	 */
	public function meta_box_save( $post_id ) {
		if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
			return $post_id;
		}

		if ( empty( $_POST['wpl_like_status_hidden'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing -- we're not changing anything on the site.
			return $post_id;
		}

		if ( ! isset( $_POST['_likesharenonce'] ) || ! wp_verify_nonce( $_POST['_likesharenonce'], 'likes-and-shares' ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput -- WordPress core doesn't unslash or verify nonces either.
			return $post_id;
		}

		// Record sharing disable. Only needs to be done for WPCOM.
		if ( ! $this->in_jetpack ) {
			if ( isset( $_POST['post_type'] ) && in_array( $_POST['post_type'], get_post_types( array( 'public' => true ) ), true ) ) {
				if ( ! isset( $_POST['wpl_enable_post_sharing'] ) ) {
					update_post_meta( $post_id, 'sharing_disabled', 1 );
				} else {
					delete_post_meta( $post_id, 'sharing_disabled' );
				}
			}
		}

		if ( 'post' === $_POST['post_type'] ) {
			if ( ! current_user_can( 'edit_post', $post_id ) ) {
				return $post_id;
			}
		}

		// Record a change in like status for this post - only if it contradicts the
		// site like setting. If it doesn't contradict, then we delete the new individual status.
		if ( ! $this->is_enabled_sitewide() && ! empty( $_POST['wpl_enable_post_likes'] ) ) {
			// Likes turned on for individual posts. User wants to add the button to a single post.
			update_post_meta( $post_id, 'switch_like_status', 1 );
		} elseif ( $this->is_enabled_sitewide() && empty( $_POST['wpl_enable_post_likes'] ) ) {
			// Likes turned on for all posts. User wants to remove the button from a single post.
			update_post_meta( $post_id, 'switch_like_status', 0 );
		} elseif (
		( ! $this->is_enabled_sitewide() && empty( $_POST['wpl_enable_post_likes'] ) ) ||
		( $this->is_enabled_sitewide() && ! empty( $_POST['wpl_enable_post_likes'] ) )
		) {
			// User wants to update the likes button status for an individual post, but the new status
			// is the same as if they're asking for the default behavior according to the current Likes setting.
			// So we delete the meta.
			delete_post_meta( $post_id, 'switch_like_status' );
		}

		return $post_id;
	}

	/**
	 * WordPress.com: Metabox option for sharing (sharedaddy will handle this on the JP blog).
	 *
	 * @param object $post - the post object.
	 */
	public function sharing_meta_box_content( $post ) {
		$post_id  = ! empty( $post->ID ) ? (int) $post->ID : get_the_ID();
		$disabled = get_post_meta( $post_id, 'sharing_disabled', true );
		?>
		<p>
			<label for="wpl_enable_post_sharing">
				<input type="checkbox" name="wpl_enable_post_sharing" id="wpl_enable_post_sharing" value="1" <?php checked( ! $disabled ); ?>>
				<?php esc_html_e( 'Show sharing buttons.', 'jetpack' ); ?>
			</label>
			<input type="hidden" name="wpl_sharing_status_hidden" value="1" />
		</p> 
		<?php
	}

	/**
	 * Adds the 'sharing' menu to the settings menu.
	 * Only ran if sharedaddy and publicize are not already active.
	 *
	 * @deprecated 13.2
	 */
	public function sharing_menu() {
		add_submenu_page( 'options-general.php', esc_html__( 'Sharing Settings', 'jetpack' ), esc_html__( 'Sharing', 'jetpack' ), 'manage_options', 'sharing', array( $this, 'sharing_page' ) );
	}

	/**
	 * Provides a sharing page with the sharing_global_options hook
	 * so we can display the setting.
	 * Only ran if sharedaddy and publicize are not already active.
	 *
	 * @deprecated 13.2
	 */
	public function sharing_page() {
		$this->updated_message();
		?>
		<div class="wrap">
			<div class="icon32" id="icon-options-general"><br /></div>
			<h1><?php esc_html_e( 'Sharing Settings', 'jetpack' ); ?></h1>
			<?php
			/** This action is documented in modules/sharedaddy/sharing.php */
			do_action( 'pre_admin_screen_sharing' );
			?>
			<?php $this->sharing_block(); ?>
		</div> 
		<?php
	}

	/**
	 * Returns the settings have been saved message.
	 *
	 * @deprecated 13.2
	 */
	public function updated_message() {
		// phpcs:ignore WordPress.Security.NonceVerification.Recommended -- ignoring since we are just displaying that the settings have been saved and not making  any other changes to the site.
		if ( isset( $_GET['update'] ) && 'saved' === $_GET['update'] ) {
			echo '<div class="updated"><p>' . esc_html__( 'Settings have been saved', 'jetpack' ) . '</p></div>';
		}
	}

	/**
	 * Returns just the "sharing buttons" w/ like option block, so it can be inserted into different sharing page contexts
	 *
	 * @deprecated 13.2
	 */
	public function sharing_block() {
		?>
		<h2><?php esc_html_e( 'Sharing Buttons', 'jetpack' ); ?></h2>
		<form method="post" action="">
			<table class="form-table">
				<tbody>
				<?php
				/** This action is documented in modules/sharedaddy/sharing.php */
				do_action( 'sharing_global_options' );
				?>
				</tbody>
			</table>

			<p class="submit">
			<input type="submit" name="submit" class="button-primary" value="<?php esc_attr_e( 'Save Changes', 'jetpack' ); ?>" />
			<?php wp_nonce_field( 'sharing-options' ); ?>
		</form> 
		<?php
	}

	/**
	 * Are likes enabled for this post?
	 *
	 * @param int $post_id - the post ID.
	 * @return bool
	 */
	public function is_post_likeable( $post_id = 0 ) {
		$post = get_post( $post_id );
		if ( ! $post || is_wp_error( $post ) ) {
			return false;
		}

		$sitewide_likes_enabled = (bool) $this->is_enabled_sitewide();
		$post_likes_switched    = get_post_meta( $post->ID, 'switch_like_status', true );

		/*
		 * On WPCOM, headstart was inserting bad data for post_likes_switched.
		 * it was wrapping the boolean value in an array. The array is always truthy regardless of its contents.
		 * There was another bug where truthy values were ignored if the global like setting was false.
		 * So in effect, the values for headstart never had an inpact.
		 * Delete the $post_likes_switched flag in this case in order to keep the behaviour as it was.
		 */
		if ( is_array( $post_likes_switched ) ) {
			$post_likes_switched = null;
		}

		/*
		 * on WPCOM, we need to look at post edit date so we don't break old posts
		 * if post edit date predates this code, stick with the former (buggy) behavior
		 * see: p7DVsv-64H-p2
		 */
		$last_modified_time = strtotime( $post->post_modified_gmt );

		$behavior_was_changed_at = strtotime( '2019-02-22 00:40:42' );

		if ( $this->in_jetpack || $last_modified_time > $behavior_was_changed_at ) {
			/*
			 * the new and improved behavior on Jetpack and recent WPCOM posts:
			 * $post_likes_switched is empty to follow site setting,
			 * 0 if we want likes disabled, 1 if we want likes enabled.
			 */
			return $post_likes_switched || ( $sitewide_likes_enabled && $post_likes_switched !== '0' );
		}

		// implicit else (old behavior): $post_likes_switched simply inverts the global setting.
		return ( (bool) $post_likes_switched ) xor $sitewide_likes_enabled;
	}

	/**
	 * Is the like button itself visible (as opposed to the reblog button)
	 *
	 * If called from within The Loop or if called with a $post_id set, then the post will be checked.
	 * Otherwise the sitewide setting will be used.
	 *
	 * @param int $post_id The ID of the post being rendered. Defaults to the current post if called from within The Loop.
	 * @return bool
	 */
	public function is_likes_button_visible( $post_id = 0 ) {
		if ( in_the_loop() || $post_id ) {
			// If in The Loop, is_post_likeable will check the current post.
			return $this->is_post_likeable( $post_id );
		} else {
			// Otherwise, check and see if likes are enabled sitewide.
			return $this->is_enabled_sitewide();
		}
	}

	/**
	 * Are likes visible in this context?
	 *
	 * Some of this code was taken and modified from sharing_display() to ensure
	 * similar logic and filters apply here, too.
	 */
	public function is_likes_visible() {
		if ( Settings::is_syncing() ) {
			return false;
		}

		return $this->is_likes_button_visible() && $this->is_likes_module_enabled();
	}

	/**
	 * Apply filters to determine if the likes module itself is enabled
	 *
	 * @return bool
	 */
	public function is_likes_module_enabled() {
		global $wp_current_filter; // Used to apply 'sharing_show' filter.

		$post    = get_post();
		$enabled = true;

		// Never show on feeds or previews.
		if ( is_feed() || is_preview() ) {
			$enabled = false;
			// Not a feed or preview, so what is it?
		} else {
			if ( post_password_required() ) {
				$enabled = false;
			}

			if ( in_array( 'get_the_excerpt', (array) $wp_current_filter, true ) ) {
				$enabled = false;
			}
			// Sharing Setting Overrides ****************************************
			// Single post including custom post types.
			if ( is_single() ) {
				if ( ! $this->is_single_post_enabled( ( $post instanceof WP_Post ) ? $post->post_type : 'post' ) ) {
					$enabled = false;
				}

				// Single page.
			} elseif ( is_page() && ! is_front_page() ) {
				if ( ! $this->is_single_page_enabled() ) {
					$enabled = false;
				}

				// Attachment.
			} elseif ( is_attachment() ) {
				if ( ! $this->is_attachment_enabled() ) {
					$enabled = false;
				}

				// All other loops.
			} elseif ( ! $this->is_index_enabled() ) {
				$enabled = false;
			}
		}

		if ( $post instanceof WP_Post ) {
			// Check that the post is a public, published post.
			if ( 'attachment' === $post->post_type ) {
				$post_status = get_post_status( $post->post_parent );
			} else {
				$post_status = $post->post_status;
			}
			if ( 'publish' !== $post_status ) {
				$enabled = false;
			}
		}

		// Run through the sharing filters.
		/** This filter is documented in modules/sharedaddy/sharing-service.php */
		$enabled = apply_filters( 'sharing_show', $enabled, $post );

		/**
		 * Filters whether the Likes should be visible or not.
		 * Allows overwriting the options set in Settings > Sharing.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $enabled Should the Likes be visible?
		 */
		return (bool) apply_filters( 'wpl_is_likes_visible', $enabled );
	}

	/**
	 * Are Post Likes enabled on single posts?
	 *
	 * @param string $post_type custom post type identifier.
	 * @return bool
	 */
	public function is_single_post_enabled( $post_type = 'post' ) {
		$options = $this->get_options();
		return (bool) apply_filters(
		/**
		 * Filters whether Likes should be enabled on single posts.
		 *
		 * The dynamic part of the filter, {$post_type}, allows you to specific the post type where Likes should be enabled.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $enabled Are Post Likes enabled on single posts?
		 */
			"wpl_is_single_{$post_type}_disabled",
			(bool) in_array( $post_type, $options['show'], true )
		);
	}

	/**
	 * Get the 'disabled_likes' option from the DB of the current blog.
	 *
	 * @return array
	 */
	public function get_options() {
		$setting             = array();
		$setting['disabled'] = get_option( 'disabled_likes' );
		$sharing             = get_option( 'sharing-options', array() );

		// Default visibility settings
		if ( ! isset( $sharing['global']['show'] ) ) {
			$sharing['global']['show'] = array( 'post', 'page' );

			// Scalar check
		} elseif ( is_scalar( $sharing['global']['show'] ) ) {
			switch ( $sharing['global']['show'] ) {
				case 'posts':
					$sharing['global']['show'] = array( 'post', 'page' );
					break;
				case 'index':
					$sharing['global']['show'] = array( 'index' );
					break;
				case 'posts-index':
					$sharing['global']['show'] = array( 'post', 'page', 'index' );
					break;
			}
		}

		// Ensure it's always an array (even if not previously empty or scalar)
		$setting['show'] = ! empty( $sharing['global']['show'] ) ? (array) $sharing['global']['show'] : array();

		/**
		 * Filters where the Likes are displayed.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param array $setting Array of Likes display settings.
		 */
		return apply_filters( 'wpl_get_options', $setting );
	}

	/**
	 * Are Post Likes enabled on archive/front/search pages?
	 *
	 * @return bool
	 */
	public function is_index_enabled() {
		$options = $this->get_options();
		/**
		 * Filters whether Likes should be enabled on archive/front/search pages.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $enabled Are Post Likes enabled on archive/front/search pages?
		 */
		return (bool) apply_filters( 'wpl_is_index_disabled', (bool) in_array( 'index', $options['show'], true ) );
	}

	/**
	 * Are Post Likes enabled on single pages?
	 *
	 * @return bool
	 */
	public function is_single_page_enabled() {
		$options = $this->get_options();
		/**
		 * Filters whether Likes should be enabled on single pages.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $enabled Are Post Likes enabled on single pages?
		 */
		return (bool) apply_filters( 'wpl_is_single_page_disabled', (bool) in_array( 'page', $options['show'], true ) );
	}

	/**
	 * Are Media Likes enabled on single pages?
	 *
	 * @return bool
	 */
	public function is_attachment_enabled() {
		$options = $this->get_options();
		/**
		 * Filters whether Likes should be enabled on attachment pages.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $enabled Are Post Likes enabled on attachment pages?
		 */
		return (bool) apply_filters( 'wpl_is_attachment_disabled', (bool) in_array( 'attachment', $options['show'], true ) );
	}

	/**
	 * The actual options block to be inserted into the sharing page.
	 */
	public function admin_settings_init() {
		?>
		<tr>
			<th scope="row">
				<label><?php esc_html_e( 'WordPress.com Likes are', 'jetpack' ); ?></label>
			</th>
			<td>
				<div>
					<label>
						<input type="radio" class="code" name="wpl_default" value="on" <?php checked( $this->is_enabled_sitewide(), true ); ?> />
						<?php esc_html_e( 'On for all posts', 'jetpack' ); ?>
					</label>
				</div>
				<div>
					<label>
						<input type="radio" class="code" name="wpl_default" value="off" <?php checked( $this->is_enabled_sitewide(), false ); ?> />
						<?php esc_html_e( 'Turned on per post', 'jetpack' ); ?>
					</label>
					<div>
			</td>
		</tr>
		<?php if ( ! $this->in_jetpack ) : ?>
			<tr>
				<th scope="row">
					<label><?php esc_html_e( 'WordPress.com Reblog Button', 'jetpack' ); ?></label>
				</th>
				<td>
					<div>
						<label>
							<input type="radio" class="code" name="jetpack_reblogs_enabled" value="on" <?php checked( $this->reblogs_enabled_sitewide(), true ); ?> />
							<?php esc_html_e( 'Show the Reblog button on posts', 'jetpack' ); ?>
						</label>
					</div>
					<div>
						<label>
							<input type="radio" class="code" name="jetpack_reblogs_enabled" value="off" <?php checked( $this->reblogs_enabled_sitewide(), false ); ?> />
							<?php esc_html_e( 'Don\'t show the Reblog button on posts', 'jetpack' ); ?>
						</label>
					</div>
				</td>
			</tr>
			<!-- WPCOM only: Comment Likes -->
			<?php if ( ! $this->in_jetpack ) : ?>
				<tr>
					<th scope="row">
						<label><?php esc_html_e( 'Comment Likes are', 'jetpack' ); ?></label>
					</th>
					<td>
						<div>
							<label>
								<input type="checkbox" class="code" name="jetpack_comment_likes_enabled" value="1" <?php checked( $this->is_comments_enabled(), true ); ?> />
								<?php esc_html_e( 'On for all comments', 'jetpack' ); ?>
							</label>
						</div>
					</td>
				</tr>
			<?php endif; ?>
		<?php endif; ?>
		</tbody> <?php // closes the tbody attached to sharing_show_buttons_on_row_start... ?>
		<?php
	}

	/**
	 * Returns the current state of the "WordPress.com Reblogs are" option.
	 *
	 * @return bool true if enabled sitewide, false if not
	 */
	public function reblogs_enabled_sitewide() {
		/**
		 * Filters whether Reblogs are enabled by default on all posts.
		 * true if enabled sitewide, false if not.
		 *
		 * @module likes
		 *
		 * @since 3.0.0
		 *
		 * @param bool $option Are Reblogs enabled sitewide.
		 */
		return (bool) apply_filters( 'wpl_reblogging_enabled_sitewide', ! get_option( 'disabled_reblogs' ) );
	}

	/**
	 * Used for WPCOM ONLY. Comment likes are in their own module in Jetpack.
	 * Returns if comment likes are enabled. Defaults to 'off'
	 *
	 * @return boolean true if we should show comment likes, false if not
	 */
	public function is_comments_enabled() {
		/**
		 * Filters whether Comment Likes are enabled.
		 * true if enabled, false if not.
		 *
		 * @module comment-likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool $option Are Comment Likes enabled sitewide.
		 */
		return (bool) apply_filters( 'jetpack_comment_likes_enabled', get_option( 'jetpack_comment_likes_enabled', false ) );
	}

	/**
	 * Saves the setting in the database.
	 */
	public function admin_settings_callback() {
		if ( ! isset( $_POST['_wpnonce'] ) || ! wp_verify_nonce( $_POST['_wpnonce'], 'sharing-options' ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput -- WordPress core doesn't unslash or verify nonces either.
			return;
		}

		// We're looking for these, and doing a dance to set some stats and save
		// them together in array option.
		if ( ! empty( $_POST['wpl_default'] ) ) {
			$new_state = sanitize_text_field( wp_unslash( $_POST['wpl_default'] ) );
		} else {
			$new_state = 'on';
		}

		if ( ! empty( $_POST['jetpack_reblogs_enabled'] ) ) {
			$reblogs_new_state = sanitize_text_field( wp_unslash( $_POST['jetpack_reblogs_enabled'] ) );
		} else {
			$reblogs_new_state = 'on';
		}

		// Checked (enabled)
		switch ( $new_state ) {
			case 'off':
				update_option( 'disabled_likes', 1 );
				break;
			case 'on':
			default:
				delete_option( 'disabled_likes' );
				break;
		}

		switch ( $reblogs_new_state ) {
			case 'off':
				update_option( 'disabled_reblogs', 1 );
				break;
			case 'on':
			default:
				delete_option( 'disabled_reblogs' );
				break;
		}

		// WPCOM only: Comment Likes
		if ( ! $this->in_jetpack ) {
			if ( ! empty( $_POST['jetpack_comment_likes_enabled'] ) ) {
				$new_comments_state = sanitize_text_field( wp_unslash( $_POST['jetpack_comment_likes_enabled'] ) );
			} else {
				$new_comments_state = false;
			}
			switch ( (bool) $new_comments_state ) {
				case true:
					update_option( 'jetpack_comment_likes_enabled', 1 );
					break;
				case false:
				default:
					update_option( 'jetpack_comment_likes_enabled', 0 );
					break;
			}
		}
	}

	/**
	 * Adds the admin update hook so we can save settings even if Sharedaddy is not enabled.
	 */
	public function process_update_requests_if_sharedaddy_not_loaded() {
		if ( isset( $_GET['page'] ) && ( $_GET['page'] === 'sharing.php' || $_GET['page'] === 'sharing' ) ) {
			if ( isset( $_POST['_wpnonce'] ) && wp_verify_nonce( $_POST['_wpnonce'], 'sharing-options' ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput -- WordPress core doesn't unslash or verify nonces either.
				/** This action is documented in modules/sharedaddy/sharing.php */
				do_action( 'sharing_admin_update' );
				wp_safe_redirect( admin_url( 'options-general.php?page=sharing&update=saved' ) );
				die();
			}
		}
	}

	/**
	 * If sharedaddy is not loaded, we don't have the "Show buttons on" yet, so we need to add that since it affects likes too.
	 */
	public function admin_settings_showbuttonon_init() {
		/** This action is documented in modules/sharedaddy/sharing.php */
		echo apply_filters( 'sharing_show_buttons_on_row_start', '<tr valign="top">' ); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
		?>
		<th scope="row"><label><?php esc_html_e( 'Show buttons on', 'jetpack' ); ?></label></th>
		<td>
			<?php
			$br    = false;
			$shows = array_values( get_post_types( array( 'public' => true ) ) );
			array_unshift( $shows, 'index' );
			$global = $this->get_options();
			foreach ( $shows as $show ) :
				if ( 'index' === $show ) {
					$label = __( 'Front Page, Archive Pages, and Search Results', 'jetpack' );
				} else {
					$post_type_object = get_post_type_object( $show );
					$label            = $post_type_object->labels->name;
				}

				if ( $br ) {
					echo '<br />';
				}
				?>
				<label><input type="checkbox"<?php checked( in_array( $show, $global['show'], true ) ); ?> name="show[]" value="<?php echo esc_attr( $show ); ?>" /> <?php echo esc_html( $label ); ?></label>
				<?php
				$br = true;
				endforeach;
			?>
		</td>
		<?php
		/** This action is documented in modules/sharedaddy/sharing.php */
		echo apply_filters( 'sharing_show_buttons_on_row_end', '</tr>' ); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * If sharedaddy is not loaded, we still need to save the the settings of the "Show buttons on" option.
	 */
	public function admin_settings_showbuttonon_callback() {
		$options = get_option( 'sharing-options' );
		if ( ! is_array( $options ) ) {
			$options = array();
		}

		$shows   = array_values( get_post_types( array( 'public' => true ) ) );
		$shows[] = 'index';
		// phpcs:ignore WordPress.Security.NonceVerification.Missing -- triggered due to the 'sharing_admin_update' action, but the code in sharing.php checks for the nonce before firing the action.
		$data = $_POST;

		if ( isset( $data['show'] ) ) {
			if ( is_scalar( $data['show'] ) ) {
				switch ( $data['show'] ) {
					case 'posts':
						$data['show'] = array( 'post', 'page' );
						break;
					case 'index':
						$data['show'] = array( 'index' );
						break;
					case 'posts-index':
						$data['show'] = array( 'post', 'page', 'index' );
						break;
				}
			}

			$data['show'] = array_intersect( $data['show'], $shows );
			if ( $data['show'] ) {
				$options['global']['show'] = $data['show'];
			}
		} else {
			$options['global']['show'] = array();
		}

		update_option( 'sharing-options', $options );
	}
}
post-count-jetpack.js                                                                                                                                                                                                                                          506           1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   window.wpPostLikeCount = window.wpPostLikeCount || {};

( function ( $ ) {
	window.wpPostLikeCount = jQuery.extend( window.wpPostLikeCount, {
		request: function ( options ) {
			return $.ajax( {
				type: 'GET',
				url: window.wpPostLikeCount.jsonAPIbase + options.path,
				dataType: 'jsonp',
				data: options.data,
				success: function ( response ) {
					options.success( response );
				},
				error: function ( response ) {
					options.error( response );
				},
			} );
		},
	} );
} )( jQuery );
post-count.js                                                                                                                                                                                                                                                  1737          1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   window.wpPostLikeCount = window.wpPostLikeCount || {};

( function ( $ ) {
	window.wpPostLikeCount = jQuery.extend( window.wpPostLikeCount, {
		jsonAPIbase: 'https://public-api.wordpress.com/rest/v1',
		APIqueue: [],

		wpPostLikeCount: function () {
			$( '.post-like-count' ).each( function () {
				var post_id = $( this ).attr( 'data-post-id' );
				var blog_id = $( this ).attr( 'data-blog-id' );
				window.wpPostLikeCount.APIqueue.push(
					'/sites/' + blog_id + '/posts/' + post_id + '/likes'
				);
			} );
			window.wpPostLikeCount.getCounts();
		},

		showCount: function ( post_id, count ) {
			if ( count > 0 ) {
				$( '#post-like-count-' + post_id )
					.find( '.comment-count' )
					.hide();
				$( '#post-like-count-' + post_id )
					.find( '.comment-count' )
					.text( count );
				$( '#post-like-count-' + post_id )
					.find( '.comment-count' )
					.fadeIn();
			}
		},

		getCounts: function () {
			var batchRequest = {
				path: '/batch',
				data: '',
				success: function ( response ) {
					for ( var path in response ) {
						if ( ! response[ path ].error_data ) {
							var urlPieces = path.split( '/' ); // pieces[4] = post id;
							var post_id = urlPieces[ 4 ];
							window.wpPostLikeCount.showCount( post_id, response[ path ].found );
						}
					}
				},
				error: function (/*response*/) {},
			};

			var amp = '';
			for ( var i = 0; i < window.wpPostLikeCount.APIqueue.length; i++ ) {
				if ( i > 0 ) {
					amp = '&';
				}
				batchRequest.data += amp + 'urls[]=' + window.wpPostLikeCount.APIqueue[ i ];
			}

			window.wpPostLikeCount.request( batchRequest );
		},
	} );
} )( jQuery );

jQuery( document ).ready( function (/*$*/) {
	window.wpPostLikeCount.wpPostLikeCount();
} );
queuehandler.js                                                                                                                                                                                                                                                16724         1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /* global wpcom_reblog */

var jetpackLikesWidgetBatch = [];
var jetpackLikesMasterReady = false;

// Due to performance problems on pages with a large number of widget iframes that need to be loaded,
// we are limiting the processing at any instant to unloaded widgets that are currently in viewport,
// plus this constant that will allow processing of widgets above and bellow the current fold.
// This aim of it is to improve the UX and hide the transition from unloaded to loaded state from users.
var jetpackLikesLookAhead = 2000; // pixels

// Keeps track of loaded comment likes widget so we can unload them when they are scrolled out of view.
var jetpackCommentLikesLoadedWidgets = [];

var jetpackLikesDocReadyPromise = new Promise( resolve => {
	if ( document.readyState !== 'loading' ) {
		resolve();
	} else {
		window.addEventListener( 'DOMContentLoaded', () => resolve() );
	}
} );

function JetpackLikesPostMessage( message, target ) {
	if ( typeof message === 'string' ) {
		try {
			message = JSON.parse( message );
		} catch ( e ) {
			return;
		}
	}

	if ( target && typeof target.postMessage === 'function' ) {
		try {
			target.postMessage(
				JSON.stringify( {
					type: 'likesMessage',
					data: message,
				} ),
				'*'
			);
		} catch ( e ) {
			return;
		}
	}
}

function JetpackLikesBatchHandler() {
	const requests = [];
	document.querySelectorAll( 'div.jetpack-likes-widget-unloaded' ).forEach( widget => {
		if ( jetpackLikesWidgetBatch.indexOf( widget.id ) > -1 ) {
			return;
		}

		if ( ! jetpackIsScrolledIntoView( widget ) ) {
			return;
		}

		jetpackLikesWidgetBatch.push( widget.id );

		var regex = /like-(post|comment)-wrapper-(\d+)-(\d+)-(\w+)/,
			match = regex.exec( widget.id ),
			info;

		if ( ! match || match.length !== 5 ) {
			return;
		}

		info = {
			blog_id: match[ 2 ],
			width: widget.width,
		};

		if ( 'post' === match[ 1 ] ) {
			info.post_id = match[ 3 ];
		} else if ( 'comment' === match[ 1 ] ) {
			info.comment_id = match[ 3 ];
		}

		info.obj_id = match[ 4 ];

		requests.push( info );
	} );

	if ( requests.length > 0 ) {
		JetpackLikesPostMessage(
			{ event: 'initialBatch', requests: requests },
			window.frames[ 'likes-master' ]
		);
	}
}

function JetpackLikesMessageListener( event ) {
	let message = event && event.data;
	if ( typeof message === 'string' ) {
		try {
			message = JSON.parse( message );
		} catch ( err ) {
			return;
		}
	}

	const type = message && message.type;
	const data = message && message.data;

	if ( type !== 'likesMessage' || typeof data.event === 'undefined' ) {
		return;
	}

	// We only allow messages from one origin
	const allowedOrigin = 'https://widgets.wp.com';
	if ( allowedOrigin !== event.origin ) {
		return;
	}

	switch ( data.event ) {
		case 'masterReady':
			jetpackLikesDocReadyPromise.then( () => {
				jetpackLikesMasterReady = true;

				const stylesData = {
					event: 'injectStyles',
				};
				const sdTextColor = document.querySelector( '.sd-text-color' );
				const sdLinkColor = document.querySelector( '.sd-link-color' );
				const sdTextColorStyles = ( sdTextColor && getComputedStyle( sdTextColor ) ) || {};
				const sdLinkColorStyles = ( sdLinkColor && getComputedStyle( sdLinkColor ) ) || {};

				if ( document.querySelectorAll( 'iframe.admin-bar-likes-widget' ).length > 0 ) {
					JetpackLikesPostMessage( { event: 'adminBarEnabled' }, window.frames[ 'likes-master' ] );

					const bgSource = document.querySelector(
						'#wpadminbar .quicklinks li#wp-admin-bar-wpl-like > a'
					);

					const wpAdminBar = document.querySelector( '#wpadminbar' );

					stylesData.adminBarStyles = {
						background: bgSource && getComputedStyle( bgSource ).background,
						isRtl: wpAdminBar && getComputedStyle( wpAdminBar ).direction === 'rtl',
					};
				}

				// enable reblogs if we're on a single post page
				if ( document.body.classList.contains( 'single' ) ) {
					JetpackLikesPostMessage( { event: 'reblogsEnabled' }, window.frames[ 'likes-master' ] );
				}

				stylesData.textStyles = {
					color: sdTextColorStyles[ 'color' ],
					fontFamily: sdTextColorStyles[ 'font-family' ],
					fontSize: sdTextColorStyles[ 'font-size' ],
					direction: sdTextColorStyles[ 'direction' ],
					fontWeight: sdTextColorStyles[ 'font-weight' ],
					fontStyle: sdTextColorStyles[ 'font-style' ],
					textDecoration: sdTextColorStyles[ 'text-decoration' ],
				};

				stylesData.linkStyles = {
					color: sdLinkColorStyles[ 'color' ],
					fontFamily: sdLinkColorStyles[ 'font-family' ],
					fontSize: sdLinkColorStyles[ 'font-size' ],
					textDecoration: sdLinkColorStyles[ 'text-decoration' ],
					fontWeight: sdLinkColorStyles[ 'font-weight' ],
					fontStyle: sdLinkColorStyles[ 'font-style' ],
				};

				JetpackLikesPostMessage( stylesData, window.frames[ 'likes-master' ] );

				JetpackLikesBatchHandler();
			} );

			break;

		case 'showLikeWidget': {
			const placeholder = document.querySelector( `#${ data.id } .likes-widget-placeholder` );
			if ( placeholder ) {
				placeholder.style.display = 'none';
			}
			break;
		}

		case 'showCommentLikeWidget': {
			const placeholder = document.querySelector( `#${ data.id } .likes-widget-placeholder` );
			if ( placeholder ) {
				placeholder.style.display = 'none';
			}
			break;
		}

		case 'killCommentLikes':
			// If kill switch for comment likes is enabled remove all widgets wrappers and `Loading...` placeholders.
			document
				.querySelectorAll( '.jetpack-comment-likes-widget-wrapper' )
				.forEach( wrapper => wrapper.remove() );
			break;

		case 'clickReblogFlair':
			if ( wpcom_reblog && typeof wpcom_reblog.toggle_reblog_box_flair === 'function' ) {
				wpcom_reblog.toggle_reblog_box_flair( data.obj_id );
			}
			break;

		case 'hideOtherGravatars': {
			hideLikersPopover();
			break;
		}

		case 'showOtherGravatars': {
			const container = document.querySelector( '#likes-other-gravatars' );

			if ( ! container ) {
				break;
			}

			const newLayout = container.classList.contains( 'wpl-new-layout' );

			const list = container.querySelector( 'ul' );

			container.style.display = 'none';
			list.innerHTML = '';

			if ( newLayout ) {
				container
					.querySelectorAll( '.likes-text span' )
					.forEach( item => ( item.textContent = data.totalLikesLabel ) );
			} else {
				container
					.querySelectorAll( '.likes-text span' )
					.forEach( item => ( item.textContent = data.total ) );
			}

			( data.likers || [] ).forEach( async ( liker, index ) => {
				if ( liker.profile_URL.substr( 0, 4 ) !== 'http' ) {
					// We only display gravatars with http or https schema
					return;
				}

				const element = document.createElement( 'li' );
				list.append( element );

				if ( newLayout ) {
					element.innerHTML = `
					<a href="${ encodeURI( liker.profile_URL ) }" rel="nofollow" target="_parent" class="wpl-liker">
						<img src="${ encodeURI( liker.avatar_URL ) }"
							alt=""
							style="width: 28px; height: 28px;" />
						<span></span>
					</a>
				`;
				} else {
					element.innerHTML = `
					<a href="${ encodeURI( liker.profile_URL ) }" rel="nofollow" target="_parent" class="wpl-liker">
						<img src="${ encodeURI( liker.avatar_URL ) }"
							alt=""
							style="width: 30px; height: 30px; padding-right: 3px;" />
					</a>
				`;
				}

				// Add some extra attributes through native methods, to ensure strings are sanitized.
				element.classList.add( liker.css_class );
				element.querySelector( 'img' ).alt = data.avatarAltTitle.replace( '%s', liker.name );

				if ( newLayout ) {
					element.querySelector( 'span' ).innerText = liker.name;
				}

				if ( index === data.likers.length - 1 ) {
					element.addEventListener( 'keydown', e => {
						if ( e.key === 'Tab' && ! e.shiftKey ) {
							e.preventDefault();
							hideLikersPopover();

							JetpackLikesPostMessage(
								{ event: 'focusLikesCount', parent: data.parent },
								window.frames[ 'likes-master' ]
							);
						}
					} );
				}
			} );

			const positionPopup = function () {
				const containerStyle = getComputedStyle( container );
				const isRtl = containerStyle.direction === 'rtl';

				const el = document.querySelector( `*[name='${ data.parent }']` );
				const rect = el.getBoundingClientRect();
				const win = el.ownerDocument.defaultView;
				const offset = {
					top: rect.top + win.pageYOffset,
					left: rect.left + win.pageXOffset,
				};

				let containerLeft = 0;
				if ( newLayout ) {
					container.style.top = offset.top + data.position.top - 1 + 'px';

					if ( isRtl ) {
						const visibleAvatarsCount = data && data.likers ? Math.min( data.likers.length, 5 ) : 0;
						// 24px is the width of the avatar + 4px is the padding between avatars
						containerLeft = offset.left + data.position.left + 24 * visibleAvatarsCount + 4;
						container.style.transform = 'translateX(-100%)';
					} else {
						containerLeft = offset.left + data.position.left;
					}
					container.style.left = containerLeft + 'px';
				} else {
					container.style.left = offset.left + data.position.left - 10 + 'px';
					container.style.top = offset.top + data.position.top - 33 + 'px';
				}

				// Container width - padding
				const initContainerWidth = data.width - 20;
				const rowLength = Math.floor( initContainerWidth / 37 );
				// # of rows + (avatar + avatar padding) + text above + container padding
				let height = Math.ceil( data.likers.length / rowLength ) * 37 + 17 + 22;
				if ( height > 204 ) {
					height = 204;
				}

				if ( ! newLayout ) {
					// Avatars + padding
					const containerWidth = rowLength * 37 + 13;
					container.style.height = height + 'px';
					container.style.width = containerWidth + 'px';

					const listWidth = rowLength * 37;
					list.style.width = listWidth + 'px';
				}

				// If the popup is overflows viewport width, we should show it on the next line
				if ( newLayout ) {
					// Push it offscreen to calculated rendered width
					container.style.left = '-9999px';
					container.style.display = 'block';

					// If the popup exceeds the viewport width,
					// flip the position of the popup.
					const containerWidth = container.offsetWidth;
					const containerRight = containerLeft + containerWidth;
					if ( containerRight > win.innerWidth ) {
						containerLeft = rect.right - containerWidth;
					}

					// Set the container left
					container.style.left = containerLeft + 'px';
				} else {
					container.style.display = 'block';
				}
				container.setAttribute( 'aria-hidden', 'false' );
			};

			positionPopup();
			container.focus();

			const debounce = function ( func, wait ) {
				var timeout;
				return function () {
					var context = this;
					var args = arguments;
					clearTimeout( timeout );
					timeout = setTimeout( function () {
						func.apply( context, args );
					}, wait );
				};
			};

			const debouncedPositionPopup = debounce( positionPopup, 100 );

			// Keep a reference of this function in the element itself
			// so that we can destroy it later
			container.__resizeHandler = debouncedPositionPopup;

			// When window is resized, resize the popup.
			window.addEventListener( 'resize', debouncedPositionPopup );

			container.focus();
		}
	}
}

window.addEventListener( 'message', JetpackLikesMessageListener );

function hideLikersPopover() {
	const container = document.querySelector( '#likes-other-gravatars' );

	if ( container ) {
		container.style.display = 'none';
		container.setAttribute( 'aria-hidden', 'true' );

		// Remove the resize event listener and cleanup.
		const resizeHandler = container.__resizeHandler;
		if ( resizeHandler ) {
			window.removeEventListener( 'resize', resizeHandler );
			delete container.__resizeHandler;
		}
	}
}

document.addEventListener( 'click', hideLikersPopover );

function JetpackLikesWidgetQueueHandler() {
	var wrapperID;

	if ( ! jetpackLikesMasterReady ) {
		setTimeout( JetpackLikesWidgetQueueHandler, 500 );
		return;
	}

	// Restore widgets to initial unloaded state when they are scrolled out of view.
	jetpackUnloadScrolledOutWidgets();

	var unloadedWidgetsInView = jetpackGetUnloadedWidgetsInView();

	if ( unloadedWidgetsInView.length > 0 ) {
		// Grab any unloaded widgets for a batch request
		JetpackLikesBatchHandler();
	}

	for ( var i = 0, length = unloadedWidgetsInView.length; i <= length - 1; i++ ) {
		wrapperID = unloadedWidgetsInView[ i ].id;

		if ( ! wrapperID ) {
			continue;
		}

		jetpackLoadLikeWidgetIframe( wrapperID );
	}
}

function jetpackLoadLikeWidgetIframe( wrapperID ) {
	if ( typeof wrapperID === 'undefined' ) {
		return;
	}

	const wrapper = document.querySelector( '#' + wrapperID );
	wrapper.querySelectorAll( 'iframe' ).forEach( iFrame => iFrame.remove() );

	const placeholder = wrapper.querySelector( '.likes-widget-placeholder' );

	// Post like iframe
	if ( placeholder && placeholder.classList.contains( 'post-likes-widget-placeholder' ) ) {
		const postLikesFrame = document.createElement( 'iframe' );

		postLikesFrame.classList.add( 'post-likes-widget', 'jetpack-likes-widget' );
		postLikesFrame.name = wrapper.dataset.name;
		postLikesFrame.src = wrapper.dataset.src;
		postLikesFrame.height = '55px';
		postLikesFrame.width = '100%';
		postLikesFrame.frameBorder = '0';
		postLikesFrame.scrolling = 'no';
		postLikesFrame.title = wrapper.dataset.title;

		placeholder.after( postLikesFrame );
	}

	// Comment like iframe
	if ( placeholder.classList.contains( 'comment-likes-widget-placeholder' ) ) {
		const commentLikesFrame = document.createElement( 'iframe' );

		commentLikesFrame.class = 'comment-likes-widget-frame jetpack-likes-widget-frame';
		commentLikesFrame.name = wrapper.dataset.name;
		commentLikesFrame.src = wrapper.dataset.src;
		commentLikesFrame.height = '18px';
		commentLikesFrame.width = '100%';
		commentLikesFrame.frameBorder = '0';
		commentLikesFrame.scrolling = 'no';

		wrapper.querySelector( '.comment-like-feedback' ).after( commentLikesFrame );

		jetpackCommentLikesLoadedWidgets.push( commentLikesFrame );
	}

	wrapper.classList.remove( 'jetpack-likes-widget-unloaded' );
	wrapper.classList.add( 'jetpack-likes-widget-loading' );

	wrapper.querySelector( 'iframe' ).addEventListener( 'load', e => {
		JetpackLikesPostMessage(
			{ event: 'loadLikeWidget', name: e.target.name, width: e.target.width },
			window.frames[ 'likes-master' ]
		);

		wrapper.classList.remove( 'jetpack-likes-widget-loading' );
		wrapper.classList.add( 'jetpack-likes-widget-loaded' );
	} );
}

function jetpackGetUnloadedWidgetsInView() {
	const unloadedWidgets = document.querySelectorAll( 'div.jetpack-likes-widget-unloaded' );

	return [ ...unloadedWidgets ].filter( item => jetpackIsScrolledIntoView( item ) );
}

function jetpackIsScrolledIntoView( element ) {
	const top = element.getBoundingClientRect().top;
	const bottom = element.getBoundingClientRect().bottom;

	// Allow some slack above and bellow the fold with jetpackLikesLookAhead,
	// with the aim of hiding the transition from unloaded to loaded widget from users.
	return top + jetpackLikesLookAhead >= 0 && bottom <= window.innerHeight + jetpackLikesLookAhead;
}

function jetpackUnloadScrolledOutWidgets() {
	for ( let i = jetpackCommentLikesLoadedWidgets.length - 1; i >= 0; i-- ) {
		const currentWidgetIframe = jetpackCommentLikesLoadedWidgets[ i ];

		if ( ! jetpackIsScrolledIntoView( currentWidgetIframe ) ) {
			const widgetWrapper =
				currentWidgetIframe &&
				currentWidgetIframe.parentElement &&
				currentWidgetIframe.parentElement.parentElement;

			// Restore parent class to 'unloaded' so this widget can be picked up by queue manager again if needed.
			widgetWrapper.classList.remove( 'jetpack-likes-widget-loaded' );
			widgetWrapper.classList.remove( 'jetpack-likes-widget-loading' );
			widgetWrapper.classList.add( 'jetpack-likes-widget-unloaded' );

			// Bring back the loading placeholder into view.
			widgetWrapper
				.querySelectorAll( '.comment-likes-widget-placeholder' )
				.forEach( item => ( item.style.display = 'block' ) );

			// Remove it from the list of loaded widgets.
			jetpackCommentLikesLoadedWidgets.splice( i, 1 );

			// Remove comment like widget iFrame.
			currentWidgetIframe.remove();
		}
	}
}

var jetpackWidgetsDelayedExec = function ( after, fn ) {
	var timer;
	return function () {
		clearTimeout( timer );
		timer = setTimeout( fn, after );
	};
};

var jetpackOnScrollStopped = jetpackWidgetsDelayedExec( 250, JetpackLikesWidgetQueueHandler );

// Load initial batch of widgets, prior to any scrolling events.
JetpackLikesWidgetQueueHandler();

// Add event listener to execute queue handler after scroll.
window.addEventListener( 'scroll', jetpackOnScrollStopped, true );
style.css                                                                                                                                                                                                                                                      5619          1711191384  plugins/jetpack/modules/likes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /**
 * Like Button toolbar button, loading text & container styles
 */

/* Master container */
#jp-post-flair {
	padding-top: .5em;
}

/* Overall Sharedaddy block title */
div.sharedaddy,
#content div.sharedaddy,
#main div.sharedaddy {
	clear: both;
}

div.sharedaddy h3.sd-title {
	margin: 0 0 1em 0;
	display: inline-block;
	line-height: 1.2;
	font-size: 9pt;
	font-weight: bold;
}

div.sharedaddy h3.sd-title:before {
	content: "";
	display: block;
	width: 100%;
	min-width: 30px;
	border-top: 1px solid #dcdcde;
	margin-bottom: 1em;
}


/* Toolbar */
#wpadminbar li#wp-admin-bar-admin-bar-likes-widget {
	width: 61px;
	overflow: hidden;
}

#wpadminbar iframe.admin-bar-likes-widget {
	width: 61px;
	height: 28px;
	min-height: 28px;
	border-width: 0px;
	position: absolute;
	top: 0;
}

div.jetpack-likes-widget-wrapper {
	width: 100%;
	min-height: 50px;	/* Previous height, 60px */
	position: relative; /* Need to abs position placeholder and iframe so there isn't a jarring jump */
}

div.jetpack-likes-widget-wrapper .sd-link-color {
	font-size: 12px;
}

div.jetpack-comment-likes-widget-wrapper {
	width: 100%;
	position: relative;
	min-height: 31px;
}

div.jetpack-comment-likes-widget-wrapper iframe {
	margin-bottom: 0;
}

#likes-other-gravatars {
	display: none;
	position: absolute;
	padding: 10px 10px 12px 10px;
	background-color: #2e4453;
	border-width: 0;
	box-shadow: 0 0 10px #2e4453;
	box-shadow: 0 0 10px rgba(46,68,83,.6);
	min-width: 130px;
	z-index: 1000;
}

#likes-other-gravatars.wpl-new-layout {
	display: none;
	position: absolute;
	padding: 9px 12px 10px 12px;
	background-color: #fff;
	border: solid 1px #dcdcde;
	border-radius: 4px;
	box-shadow: none;
	min-width: 220px;
	max-height: 240px;
	height: auto;
	overflow: auto;
	z-index: 1000;
}

#likes-other-gravatars * {
	line-height: normal;
}

#likes-other-gravatars .likes-text {
	color: white;
	font-size: 12px;
	padding-bottom: 8px;
}

#likes-other-gravatars.wpl-new-layout .likes-text {
	color: #101517;
	font-size: 12px;
	font-weight: 500;
	padding-bottom: 8px;
}

#likes-other-gravatars ul,
#likes-other-gravatars li {
	margin: 0;
	padding: 0;
	text-indent: 0;
	list-style-type: none;
}

#likes-other-gravatars li::before {
	content: "";
}

#likes-other-gravatars ul.wpl-avatars {
	overflow: auto;
	display: block;
	max-height: 190px;
}

#likes-other-gravatars ul.wpl-avatars li {
	width: 32px;
	height: 32px;
	float: left;
	margin: 0 5px 5px 0;
}

#likes-other-gravatars.wpl-new-layout ul.wpl-avatars li {
	width: 196px;
	height: 28px;
	float: none;
	margin: 0 0 4px 0;
}

#likes-other-gravatars ul.wpl-avatars li a {
	margin: 0 2px 0 0;
	border-bottom: none !important;
	display: block;
}

#likes-other-gravatars.wpl-new-layout ul.wpl-avatars li a {
	margin: 0 2px 0 0;
	border-bottom: none !important;
	display: flex;
	align-items: center;
	gap: 8px;
	text-decoration: none;
}

#likes-other-gravatars.wpl-new-layout ul.wpl-avatars li a span {
	font-size: 12px;
	color: #2C3338;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

#likes-other-gravatars ul.wpl-avatars li a img {
	background: none;
	border: none;
	margin: 0 !important;
	padding: 0 !important;
	position: static;
	box-sizing: border-box;
}

#likes-other-gravatars.wpl-new-layout ul.wpl-avatars li a img {
	background: none;
	border: none;
	border-radius: 50%;
	margin: 0 !important;
	padding: 1px !important;
	position: static;
}

div.sd-box {
	border-top: 1px solid #dcdcde;
	border-top: 1px solid rgba(0,0,0,.13);
}

.entry-content .post-likes-widget, .post-likes-widget,
.comment-likes-widget {
	margin: 0;
	border-width: 0;
	display: block;
}

/* Loading text */
.post-likes-widget-placeholder,
.comment-likes-widget-placeholder {
	margin: 0;
	border-width: 0;
	position: relative;
}

.comment-likes-widget-placeholder {
	height: 18px;
	position: absolute;
	display: flex;
	font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
}

.comment-likes-widget-placeholder::before {
	color: #2EA2CC;
	width: 16px;
	height: 16px;
	content: '';
	display: inline-block;
	position: relative;
	top: 3px;
	padding-right: 5px;
	background-repeat: no-repeat;
	background-size: 16px 16px;
	background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect x='0' fill='none' width='24' height='24'/%3E%3Cg%3E%3Cpath fill='%232EA2CC' d='M12 2l2.582 6.953L22 9.257l-5.822 4.602L18.18 21 12 16.89 5.82 21l2.002-7.14L2 9.256l7.418-.304'/%3E%3C/g%3E%3C/svg%3E");
}

.post-likes-widget-placeholder .button {
	display: none;	/* Let's not show a dummy like button, let's just make a great button experience once it's loaded */
}

.post-likes-widget-placeholder .button span {
}

.post-likes-widget-placeholder .loading,
.comment-likes-widget-placeholder .loading {
	color: #999;
	font-size: 12px;
}

.comment-likes-widget-placeholder .loading {
	padding-left: 5px;
	margin-top: 4px;
	align-self: center;
	color: #4E4E4E;
}

/* Like Special cases (display on it's own) */
div.sharedaddy.sd-like-enabled .sd-like h3 {
	display: none;
}

div.sharedaddy.sd-like-enabled .sd-like .post-likes-widget {
	width: 100%;
	float: none;
	position: absolute; /* Need to abs position placeholder and iframe so there isn't a jarring jump */
	top: 0;
}

.comment-likes-widget {
	width: 100%;
}


/* Make ratings block. @todo: make !important unnecessary by removing inline style */
.pd-rating,
.cs-rating {
	display: block !important;
}


/* Hide G+ title */
.sd-gplus .sd-title {
	display: none;
}

@media print {
	.jetpack-likes-widget-wrapper {
		display: none;
	}
}
likes.php                                                                                                                                                                                                                                                      21925         1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php //phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * Module Name: Likes
 * Module Description: Give visitors an easy way to show they appreciate your content.
 * First Introduced: 2.2
 * Sort Order: 23
 * Requires Connection: Yes
 * Auto Activate: No
 * Module Tags: Social
 * Feature: Engagement
 * Additional Search Queries: like, likes, wordpress.com
 *
 * @package automattic/jetpack
 */
/**
 * NOTE: While the front-end behavior currently varies, try to keep the data
 * model here the same as on wpcom to facilitate Simple→Atomic moves and
 * possible future work to recombine the front-ends.
 */

// phpcs:disable Universal.Files.SeparateFunctionsFromOO.Mixed -- TODO: Move classes to appropriately-named class files.

use Automattic\Jetpack\Assets;

Assets::add_resource_hint(
	array(
		'//widgets.wp.com',
		'//s0.wp.com',
		'//0.gravatar.com',
		'//1.gravatar.com',
		'//2.gravatar.com',
	),
	'dns-prefetch'
);

require_once __DIR__ . '/likes/jetpack-likes-master-iframe.php';
require_once __DIR__ . '/likes/jetpack-likes-settings.php';

/**
 * Jetpack Like Class
 */
class Jetpack_Likes {

	/**
	 * Jetpack_Likes_Settings object
	 *
	 * @var Jetpack_Likes_Settings
	 */
	public $settings;

	/**
	 * Initialize class
	 */
	public static function init() {
		static $instance = null;

		if ( ! $instance ) {
			$instance = new Jetpack_Likes();
		}

		return $instance;
	}

	/**
	 * Constructs Likes class
	 */
	public function __construct() {
		$this->settings = new Jetpack_Likes_Settings();

		// We need to run on wp hook rather than init because we check is_amp_endpoint()
		// when bootstrapping hooks.
		add_action( 'wp', array( $this, 'action_init' ), 99 );

		add_action( 'admin_init', array( $this, 'admin_init' ) );

		add_action( 'jetpack_activate_module_likes', array( $this, 'set_social_notifications_like' ) );
		add_action( 'jetpack_deactivate_module_likes', array( $this, 'delete_social_notifications_like' ) );

		Jetpack::enable_module_configurable( __FILE__ );
		add_filter( 'jetpack_module_configuration_url_likes', array( $this, 'jetpack_likes_configuration_url' ) );
		add_action( 'admin_print_scripts-settings_page_sharing', array( $this, 'load_jp_css' ) );
		add_filter( 'sharing_show_buttons_on_row_start', array( $this, 'configuration_target_area' ) );

		$active = Jetpack::get_active_modules();

		if ( in_array( 'publicize', $active, true ) && ! in_array( 'sharedaddy', $active, true ) ) {
			// we have a sharing page but not the global options area.
			add_action( 'pre_admin_screen_sharing', array( $this->settings, 'sharing_block' ), 20 );
			add_action( 'pre_admin_screen_sharing', array( $this->settings, 'updated_message' ), -10 );
		}

		if ( ! in_array( 'sharedaddy', $active, true ) ) {
			add_action( 'admin_init', array( $this->settings, 'process_update_requests_if_sharedaddy_not_loaded' ) );
			add_action( 'sharing_global_options', array( $this->settings, 'admin_settings_showbuttonon_init' ), 19 );
			add_action( 'sharing_admin_update', array( $this->settings, 'admin_settings_showbuttonon_callback' ), 19 );
			add_action( 'admin_init', array( $this->settings, 'add_meta_box' ) );
		} else {
			add_filter( 'sharing_meta_box_title', array( $this->settings, 'add_likes_to_sharing_meta_box_title' ) );
			add_action( 'start_sharing_meta_box_content', array( $this->settings, 'meta_box_content' ) );
		}

		add_action( 'admin_init', array( $this, 'admin_discussion_likes_settings_init' ) ); // Likes notifications.

		add_action( 'admin_bar_menu', array( $this, 'admin_bar_likes' ), 60 );

		add_action( 'wp_enqueue_scripts', array( $this, 'load_styles_register_scripts' ) );

		add_action( 'save_post', array( $this->settings, 'meta_box_save' ) );
		add_action( 'edit_attachment', array( $this->settings, 'meta_box_save' ) );
		add_action( 'sharing_global_options', array( $this->settings, 'admin_settings_init' ), 20 );
		add_action( 'sharing_admin_update', array( $this->settings, 'admin_settings_callback' ), 20 );
	}

	/**
	 * Set the social_notifications_like option to `on` when the Likes module is activated.
	 *
	 * @since 3.7.0
	 */
	public function set_social_notifications_like() {
		update_option( 'social_notifications_like', 'on' );
	}

	/**
	 * Delete the social_notifications_like option that was set to `on` on module activation.
	 *
	 * @since 3.7.0
	 */
	public function delete_social_notifications_like() {
		delete_option( 'social_notifications_like' );
	}

	/**
	 * Overrides default configuration url
	 *
	 * @uses admin_url
	 * @return string module settings URL
	 */
	public function jetpack_likes_configuration_url() {
		return admin_url( 'options-general.php?page=sharing#likes' );
	}

	/**
	 * Loads Jetpack's CSS on the sharing page so we can use .jetpack-targetable
	 */
	public function load_jp_css() {
		/**
		* Do we really need `admin_styles`? With the new admin UI, it's breaking some bits.
		* Jetpack::init()->admin_styles();
		*/
	}

	/**
	 * Load scripts and styles for front end.
	 */
	public function load_styles_register_scripts() {
		wp_enqueue_style( 'jetpack_likes', plugins_url( 'likes/style.css', __FILE__ ), array(), JETPACK__VERSION );
		wp_register_script(
			'jetpack_likes_queuehandler',
			Assets::get_file_url_for_environment(
				'_inc/build/likes/queuehandler.min.js',
				'modules/likes/queuehandler.js'
			),
			array(),
			JETPACK__VERSION,
			true
		);
	}

	/**
	 * Adds in the jetpack-targetable class so when we visit sharing#likes our like settings get highlighted by a yellow box
	 *
	 * @param string $html row heading for the sharedaddy "which page" setting.
	 * @return string $html with the jetpack-targetable class and likes id. tbody gets closed after the like settings
	 */
	public function configuration_target_area( $html = '' ) {
		$html = "<tbody id='likes' class='jetpack-targetable'>" . $html;
		return $html;
	}

	/**
	 * Options to be added to the discussion page (see also admin_settings_init, etc below for Sharing settings page)
	 */
	public function admin_discussion_likes_settings_init() {
		// Add a temporary section, until we can move the setting out of there and with the rest of the email notification settings.
		add_settings_section( 'likes-notifications', __( 'Likes Notifications', 'jetpack' ), array( $this, 'admin_discussion_likes_settings_section' ), 'discussion' );
		add_settings_field( 'social-notifications', __( 'Email me whenever', 'jetpack' ), array( $this, 'admin_discussion_likes_settings_field' ), 'discussion', 'likes-notifications' );
		// Register the setting.
		register_setting( 'discussion', 'social_notifications_like', array( $this, 'admin_discussion_likes_settings_validate' ) );
	}

	/** Add email notification options to WordPress discussion settings */
	public function admin_discussion_likes_settings_section() {
		// Atypical usage here.  We emit jquery to move likes notification checkbox to be with the rest of the email notification settings.
		?>
	<script type="text/javascript">
	jQuery( function( $ )  {
		var table = $( '#social_notifications_like' ).parents( 'table:first' ),
			header = table.prevAll( 'h2:first' ),
			newParent = $( '#moderation_notify' ).parent( 'label' ).parent();

		if ( !table.length || !header.length || !newParent.length ) {
			return;
		}

		newParent.append( '<br/>' ).append( table.end().parent( 'label' ).siblings().andSelf() );
		header.remove();
		table.remove();
	} );
	</script>
		<?php
	}

	/** Check if email notifications for likes is on or off.
	 *
	 * @param string $option - which option we're checking (social_notifications_like).
	 */
	public function admin_likes_get_option( $option ) {
		$option_setting = get_option( $option, 'on' );

		return (int) ( 'on' === $option_setting );
	}

	/** Display email notification for likes setting in WordPress' discussion settings. */
	public function admin_discussion_likes_settings_field() {
		$like = $this->admin_likes_get_option( 'social_notifications_like' );
		?>
		<label><input type="checkbox" id="social_notifications_like" name="social_notifications_like" value="1" <?php checked( $like ); ?> /> <?php esc_html_e( 'Someone likes one of my posts', 'jetpack' ); ?></label>
		<?php
	}

	/**
	 * Validate email notification settings.
	 *
	 * @param string $input - determines if checbox is on or off.
	 */
	public function admin_discussion_likes_settings_validate( $input ) {
		// If it's not set (was unchecked during form submission) or was set to off (during option update), return 'off'.
		if ( ! $input || 'off' === $input ) {
			return 'off';
		}
		// Otherwise return 'on'.
		return 'on';
	}

	/** Initialize admin settings */
	public function admin_init() {
		add_filter( 'manage_posts_columns', array( $this, 'add_like_count_column' ) );
		add_filter( 'manage_pages_columns', array( $this, 'add_like_count_column' ) );
		add_action( 'manage_posts_custom_column', array( $this, 'likes_edit_column' ), 10, 2 );
		add_action( 'manage_pages_custom_column', array( $this, 'likes_edit_column' ), 10, 2 );
		add_action( 'admin_print_styles-edit.php', array( $this, 'load_admin_css' ) );
		add_action( 'admin_print_scripts-edit.php', array( $this, 'enqueue_admin_scripts' ) );
	}

	/** Initialize action */
	public function action_init() {
		/*
		 * Only check if the module is enabled here because
		 * we are not currently in The Loop and do not yet have access to check
		 * the switch_like_status post meta flag for the post to be loaded.
		 */
		if ( is_admin() || ! $this->settings->is_likes_module_enabled() ) {
			return;
		}

		if ( ( defined( 'XMLRPC_REQUEST' ) && XMLRPC_REQUEST ) ||
			( defined( 'APP_REQUEST' ) && APP_REQUEST ) ||
			( defined( 'REST_API_REQUEST' ) && REST_API_REQUEST ) ||
			( defined( 'COOKIE_AUTH_REQUEST' ) && COOKIE_AUTH_REQUEST ) ||
			( defined( 'JABBER_SERVER' ) && JABBER_SERVER ) ) {
			return;
		}

		if (
			class_exists( 'Jetpack_AMP_Support' )
			&& Jetpack_AMP_Support::is_amp_request()
		) {
			return;
		}

		add_filter( 'the_content', array( $this, 'post_likes' ), 30, 1 );
		add_filter( 'the_excerpt', array( $this, 'post_likes' ), 30, 1 );
	}

	/**
	 * Load the CSS needed for the wp-admin area.
	 */
	public function load_admin_css() {
		?>
		<style type="text/css">
			.vers img { display: none; }
			.metabox-prefs .vers img { display: inline; }
			.fixed .column-likes { width: 5.5em; padding: 8px 0; text-align: left; }
			.fixed .column-stats { width: 5em; }
			.fixed .column-likes .post-com-count {
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
				display: inline-block;
				padding: 0 8px;
				height: 2em;
				margin-top: 5px;
				-webkit-border-radius: 5px;
				border-radius: 5px;
				background-color: #787c82;
				color: #FFF;
				font-size: 11px;
				line-height: 21px;
			}
			.fixed .column-likes .post-com-count::after { border: none !important; }
			.fixed .column-likes .post-com-count:hover { background-color: #2271b1; }
			.fixed .column-likes .vers:before {
				font: normal 20px/1 dashicons;
				content: '\f155';
				speak: none;
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
			@media screen and (max-width: 782px) {
				.fixed .column-likes {
					display: none;
				}
			}
		</style>
		<?php
	}

	/**
	 * Load the JS required for loading the like counts.
	 */
	public function enqueue_admin_scripts() {
		if ( empty( $_GET['post_type'] ) || 'post' === $_GET['post_type'] || 'page' === $_GET['post_type'] ) { //phpcs:ignore WordPress.Security.NonceVerification.Recommended
			wp_enqueue_script(
				'likes-post-count',
				Assets::get_file_url_for_environment(
					'_inc/build/likes/post-count.min.js',
					'modules/likes/post-count.js'
				),
				array( 'jquery' ),
				JETPACK__VERSION,
				$in_footer = false
			);
			wp_enqueue_script(
				'likes-post-count-jetpack',
				Assets::get_file_url_for_environment(
					'_inc/build/likes/post-count-jetpack.min.js',
					'modules/likes/post-count-jetpack.js'
				),
				array( 'jquery', 'likes-post-count' ),
				JETPACK__VERSION,
				$in_footer = false
			);
		}
	}

	/**
	 * Add "Likes" column data to the post edit table in wp-admin.
	 *
	 * @param string $column_name - name of the column.
	 * @param int    $post_id - the post id.
	 */
	public function likes_edit_column( $column_name, $post_id ) {
		if ( 'likes' === $column_name ) {

			$blog_id = Jetpack_Options::get_option( 'id' );

			$permalink = get_permalink( get_the_ID() );
			?>
			<a title="" data-post-id="<?php echo (int) $post_id; ?>" class="post-com-count post-like-count" id="post-like-count-<?php echo (int) $post_id; ?>" data-blog-id="<?php echo (int) $blog_id; ?>" href="<?php echo esc_url( $permalink ); ?>#like-<?php echo (int) $post_id; ?>">
				<span class="comment-count">0</span>
			</a>
			<?php
		}
	}

	/**
	 * Add a "Likes" column header to the post edit table in wp-admin.
	 *
	 * @param array $columns - array of columns in wp-admin.
	 */
	public function add_like_count_column( $columns ) {
		$date = $columns['date'];
		unset( $columns['date'] );

		$columns['likes'] = '<span class="vers"><img title="' . esc_attr__( 'Likes', 'jetpack' ) . '" alt="' . esc_attr__( 'Likes', 'jetpack' ) . '" src="//s0.wordpress.com/i/like-grey-icon.png" /><span class="screen-reader-text">' . __( 'Likes', 'jetpack' ) . '</span></span>';
		$columns['date']  = $date;

		return $columns;
	}

	/**
	 * Append like button to content.
	 *
	 * @param string $content - content of the page.
	 */
	public function post_likes( $content ) {
		global $wp_current_filter;
		$post_id = get_the_ID();

		if ( ! is_numeric( $post_id ) || ! $this->settings->is_likes_visible() ) {
			return $content;
		}

		// Do not output Likes on requests for ActivityPub requests.
		if (
			function_exists( '\Activitypub\is_activitypub_request' )
			&& \Activitypub\is_activitypub_request()
		) {
			return $content;
		}

		// Ensure we don't display like button on post excerpts that are hooked inside the post content
		if ( in_array( 'the_excerpt', (array) $wp_current_filter, true ) &&
			in_array( 'the_content', (array) $wp_current_filter, true ) ) {
			return $content;
		}

		$blog_id   = Jetpack_Options::get_option( 'id' );
		$url       = home_url();
		$url_parts = wp_parse_url( $url );
		$domain    = $url_parts['host'];

		// Make sure to include the scripts before the iframe otherwise weird things happen.
		add_action( 'wp_footer', 'jetpack_likes_master_iframe', 21 );

		/**
		* If the same post appears more then once on a page the page goes crazy
		* we need a slightly more unique id / name for the widget wrapper.
		*/
		$uniqid = uniqid();
		/**
		 * Enable an alternate Likes layout.
		 *
		 * @since 12.9
		 *
		 * @module likes
		 *
		 * @param bool $new_layout Enable the new Likes layout. False by default.
		 */
		$new_layout = apply_filters( 'likes_new_layout', true ) ? '&amp;n=1' : '';

		$src      = sprintf( 'https://widgets.wp.com/likes/?ver=%1$s#blog_id=%2$d&amp;post_id=%3$d&amp;origin=%4$s&amp;obj_id=%2$d-%3$d-%5$s%6$s', rawurlencode( JETPACK__VERSION ), $blog_id, $post_id, $domain, $uniqid, $new_layout );
		$name     = sprintf( 'like-post-frame-%1$d-%2$d-%3$s', $blog_id, $post_id, $uniqid );
		$wrapper  = sprintf( 'like-post-wrapper-%1$d-%2$d-%3$s', $blog_id, $post_id, $uniqid );
		$headline = sprintf(
			/** This filter is already documented in modules/sharedaddy/sharing-service.php */
			apply_filters( 'jetpack_sharing_headline_html', '<h3 class="sd-title">%s</h3>', esc_html__( 'Like this:', 'jetpack' ), 'likes' ),
			esc_html__( 'Like this:', 'jetpack' )
		);

		$title = esc_html__( 'Like or Reblog', 'jetpack' );

		$html  = "<div class='sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded' id='$wrapper' data-src='$src' data-name='$name' data-title='$title'>";
		$html .= $headline;
		$html .= "<div class='likes-widget-placeholder post-likes-widget-placeholder' style='height: 55px;'><span class='button'><span>" . esc_html__( 'Like', 'jetpack' ) . '</span></span> <span class="loading">' . esc_html__( 'Loading...', 'jetpack' ) . '</span></div>';
		$html .= "<span class='sd-text-color'></span><a class='sd-link-color'></a>";
		$html .= '</div>';

		// Let's make sure that the script is enqueued.
		wp_enqueue_script( 'jetpack_likes_queuehandler' );

		return $content . $html;
	}

	/** Checks if admin bar is visible.*/
	public function is_admin_bar_button_visible() {
		global $wp_admin_bar;

		if ( ! is_object( $wp_admin_bar ) ) {
			return false;
		}

		if ( ( ! is_singular( 'post' ) && ! is_attachment() && ! is_page() ) ) {
			return false;
		}

		if ( ! $this->settings->is_likes_visible() ) {
			return false;
		}

		if ( ! $this->settings->is_post_likeable() ) {
			return false;
		}

		/**
		 * Filters whether the Like button is enabled in the admin bar.
		 *
		 * @module likes
		 *
		 * @since 2.2.0
		 *
		 * @param bool true Should the Like button be visible in the Admin bar. Default to true.
		 */
		return (bool) apply_filters( 'jetpack_admin_bar_likes_enabled', true );
	}

	/** Adds like section in admin bar. */
	public function admin_bar_likes() {
		global $wp_admin_bar;

		$post_id = get_the_ID();

		if ( ! is_numeric( $post_id ) || ! $this->is_admin_bar_button_visible() ) {
			return;
		}

		$protocol = 'http';
		if ( is_ssl() ) {
			$protocol = 'https';
		}
		$blog_id   = Jetpack_Options::get_option( 'id' );
		$url       = home_url();
		$url_parts = wp_parse_url( $url );
		$domain    = $url_parts['host'];

		// Make sure to include the scripts before the iframe otherwise weird things happen.
		add_action( 'wp_footer', 'jetpack_likes_master_iframe', 21 );

		$src = sprintf( 'https://widgets.wp.com/likes/?ver=%1$s#blog_id=%3$d&amp;post_id=%4$d&amp;origin=%2$s://%5$s', rawurlencode( JETPACK__VERSION ), $protocol, $blog_id, $post_id, $domain );

		$html = "<iframe class='admin-bar-likes-widget jetpack-likes-widget' scrolling='no' frameBorder='0' name='admin-bar-likes-widget' src='$src'></iframe>";

		$node = array(
			'id'   => 'admin-bar-likes-widget',
			'meta' => array(
				'html' => $html,
			),
		);

		$wp_admin_bar->add_node( $node );
	}
}

/**
 * Callback to get the value for the jetpack_likes_enabled field.
 *
 * Warning: this behavior is somewhat complicated!
 * When the switch_like_status post_meta is unset, we follow the global setting in Sharing.
 * When it is set to 0, we disable likes on the post, regardless of the global setting.
 * When it is set to 1, we enable likes on the post, regardless of the global setting.
 *
 * @param array $post - post data we're checking.
 */
function jetpack_post_likes_get_value( array $post ) {
	$post_likes_switched = get_post_meta( $post['id'], 'switch_like_status', true );

	/** This filter is documented in modules/jetpack-likes-settings.php */
	$sitewide_likes_enabled = (bool) apply_filters( 'wpl_is_enabled_sitewide', ! get_option( 'disabled_likes' ) );

	// An empty string: post meta was not set, so go with the global setting.
	if ( '' === $post_likes_switched ) {
		return $sitewide_likes_enabled;
	} elseif ( '0' === $post_likes_switched ) { // User overrode the global setting to disable likes.
		return false;
	} elseif ( '1' === $post_likes_switched ) { // User overrode the global setting to enable likes.
		return true;
	}
	// No default fallback, let's stay explicit.
}

/**
 * Callback to set switch_like_status post_meta when jetpack_likes_enabled is updated.
 *
 * Warning: this behavior is somewhat complicated!
 * When the switch_like_status post_meta is unset, we follow the global setting in Sharing.
 * When it is set to 0, we disable likes on the post, regardless of the global setting.
 * When it is set to 1, we enable likes on the post, regardless of the global setting.
 *
 * @param bool   $enable_post_likes - checks if post likes are enabled.
 * @param object $post_object - object containing post data.
 */
function jetpack_post_likes_update_value( $enable_post_likes, $post_object ) {
	/** This filter is documented in modules/jetpack-likes-settings.php */
	$sitewide_likes_enabled = (bool) apply_filters( 'wpl_is_enabled_sitewide', ! get_option( 'disabled_likes' ) );

	$should_switch_status = $enable_post_likes !== $sitewide_likes_enabled;

	if ( $should_switch_status ) {
		// Set the meta to 0 if the user wants to disable likes, 1 if user wants to enable.
		$switch_like_status = ( $enable_post_likes ? 1 : 0 );
		return update_post_meta( $post_object->ID, 'switch_like_status', $switch_like_status );
	} else {
		// Unset the meta otherwise.
		return delete_post_meta( $post_object->ID, 'switch_like_status' );
	}
}

/**
 * Add Likes post_meta to the REST API Post response.
 *
 * @action rest_api_init
 * @uses register_rest_field
 * @link https://developer.wordpress.org/rest-api/extending-the-rest-api/modifying-responses/
 */
function jetpack_post_likes_register_rest_field() {
	$post_types = get_post_types( array( 'public' => true ) );
	foreach ( $post_types as $post_type ) {
		register_rest_field(
			$post_type,
			'jetpack_likes_enabled',
			array(
				'get_callback'    => 'jetpack_post_likes_get_value',
				'update_callback' => 'jetpack_post_likes_update_value',
				'schema'          => array(
					'description' => __( 'Are Likes enabled?', 'jetpack' ),
					'type'        => 'boolean',
				),
			)
		);

		/**
		 * Ensures all public internal post-types support `likes`
		 * This feature support flag is used by the REST API and Gutenberg.
		 */
		add_post_type_support( $post_type, 'jetpack-post-likes' );
	}
}

// Add Likes post_meta to the REST API Post response.
add_action( 'rest_api_init', 'jetpack_post_likes_register_rest_field' );

// Some CPTs (e.g. Jetpack portfolios and testimonials) get registered with
// restapi_theme_init because they depend on theme support, so let's also hook to that.
add_action( 'restapi_theme_init', 'jetpack_post_likes_register_rest_field', 20 );

Jetpack_Likes::init();
easy-markdown.php                                                                                                                                                                                                                                              30392         1711191384  plugins/jetpack/modules/markdown                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php //phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * Plugin URI: https://automattic.com/
 * Plugin Name: Easy Markdown
 * Description: Write in Markdown, publish in WordPress
 * Version: 0.1
 * Author: Matt Wiebe
 * Author URI: https://automattic.com/
 * Text Domain: jetpack
 *
 * @package automattic/jetpack
 */

/**
 * Copyright (c) Automattic. All rights reserved.
 *
 * Released under the GPL license
 * https://www.opensource.org/licenses/gpl-license.php
 *
 * This is an add-on for WordPress
 * https://wordpress.org/
 *
 * **********************************************************************
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * **********************************************************************
 */

/**
 * WPCom_Markdown class.
 */
class WPCom_Markdown {

	const POST_OPTION       = 'wpcom_publish_posts_with_markdown';
	const COMMENT_OPTION    = 'wpcom_publish_comments_with_markdown';
	const POST_TYPE_SUPPORT = 'wpcom-markdown';
	const IS_MD_META        = '_wpcom_is_markdown';

	/**
	 * Our markdown parser.
	 *
	 * @var WPCom_GHF_Markdown_Parser
	 */
	private static $parser;

	/**
	 * An instance of the markdown class.
	 *
	 * @var WPCom_Markdown
	 */
	private static $instance;

	/**
	 * To ensure that our munged posts over xml-rpc are removed from the cache.
	 *
	 * @var array
	 */
	public $posts_to_uncache = array();

	/**
	 * Posts and parents to monitor.
	 *
	 * @var array
	 */
	private $monitoring = array(
		'post'   => array(),
		'parent' => array(),
	);

	/**
	 * Yay singletons!
	 *
	 * @return object WPCom_Markdown instance
	 */
	public static function get_instance() {
		if ( ! self::$instance ) {
			self::$instance = new self();
		}
		return self::$instance;
	}

	/**
	 * Kicks things off on `init` action
	 */
	public function load() {
		$this->add_default_post_type_support();
		$this->maybe_load_actions_and_filters();
		if ( defined( 'REST_API_REQUEST' ) && REST_API_REQUEST ) {
			add_action( 'switch_blog', array( $this, 'maybe_load_actions_and_filters' ), 10, 2 );
		}
		add_action( 'admin_init', array( $this, 'register_setting' ) );
		add_action( 'admin_init', array( $this, 'maybe_unload_for_bulk_edit' ) );
		if ( current_theme_supports( 'o2' ) || class_exists( 'P2' ) ) {
			$this->add_o2_helpers();
		}
	}

	/**
	 * If we're in a bulk edit session, unload so that we don't lose our markdown metadata
	 */
	public function maybe_unload_for_bulk_edit() {
		if ( isset( $_REQUEST['bulk_edit'] ) && $this->is_posting_enabled() ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended
			$this->unload_markdown_for_posts();
		}
	}

	/**
	 * Called on init and fires on switch_blog to decide if our actions and filters
	 * should be running.
	 *
	 * @param int|null $new_blog_id New blog ID.
	 * @param int|null $old_blog_id Old blog ID.
	 * @return null
	 */
	public function maybe_load_actions_and_filters( $new_blog_id = null, $old_blog_id = null ) {

		// When WP sites are being installed, the options table is not available yet.
		if ( function_exists( 'wp_installing' ) && wp_installing() ) {
			return;
		}

		// If this is a switch_to_blog call, and the blog isn't changing, we'll already be loaded.
		if ( $new_blog_id && $new_blog_id === $old_blog_id ) {
			return;
		}

		if ( $this->is_posting_enabled() ) {
			$this->load_markdown_for_posts();
		} else {
			$this->unload_markdown_for_posts();
		}

		if ( $this->is_commenting_enabled() ) {
			$this->load_markdown_for_comments();
		} else {
			$this->unload_markdown_for_comments();
		}
	}

	/**
	 * Set up hooks for enabling Markdown conversion on posts
	 */
	public function load_markdown_for_posts() {
		add_filter( 'wp_kses_allowed_html', array( $this, 'wp_kses_allowed_html' ), 10, 2 );
		add_action( 'after_wp_tiny_mce', array( $this, 'after_wp_tiny_mce' ) );
		add_action( 'wp_insert_post', array( $this, 'wp_insert_post' ) );
		add_filter( 'wp_insert_post_data', array( $this, 'wp_insert_post_data' ), 10, 2 );
		add_filter( 'edit_post_content', array( $this, 'edit_post_content' ), 10, 2 );
		add_filter( 'edit_post_content_filtered', array( $this, 'edit_post_content_filtered' ), 10, 2 );
		add_action( 'wp_restore_post_revision', array( $this, 'wp_restore_post_revision' ), 10, 2 );
		add_filter( '_wp_post_revision_fields', array( $this, 'wp_post_revision_fields' ) );
		add_action( 'xmlrpc_call', array( $this, 'xmlrpc_actions' ) );
		add_filter( 'content_save_pre', array( $this, 'preserve_code_blocks' ), 1 );
		if ( defined( 'XMLRPC_REQUEST' ) && XMLRPC_REQUEST ) {
			$this->check_for_early_methods();
		}
	}

	/**
	 * Removes hooks to disable Markdown conversion on posts
	 */
	public function unload_markdown_for_posts() {
		remove_filter( 'wp_kses_allowed_html', array( $this, 'wp_kses_allowed_html' ) );
		remove_action( 'after_wp_tiny_mce', array( $this, 'after_wp_tiny_mce' ) );
		remove_action( 'wp_insert_post', array( $this, 'wp_insert_post' ) );
		remove_filter( 'wp_insert_post_data', array( $this, 'wp_insert_post_data' ), 10, 2 );
		remove_filter( 'edit_post_content', array( $this, 'edit_post_content' ), 10, 2 );
		remove_filter( 'edit_post_content_filtered', array( $this, 'edit_post_content_filtered' ), 10, 2 );
		remove_action( 'wp_restore_post_revision', array( $this, 'wp_restore_post_revision' ), 10, 2 );
		remove_filter( '_wp_post_revision_fields', array( $this, 'wp_post_revision_fields' ) );
		remove_action( 'xmlrpc_call', array( $this, 'xmlrpc_actions' ) );
		remove_filter( 'content_save_pre', array( $this, 'preserve_code_blocks' ), 1 );
	}

	/**
	 * Set up hooks for enabling Markdown conversion on comments
	 */
	protected function load_markdown_for_comments() {
		// Use priority 9 so that Markdown runs before KSES, which can clean up
		// any munged HTML.
		add_filter( 'pre_comment_content', array( $this, 'pre_comment_content' ), 9 );
	}

	/**
	 * Removes hooks to disable Markdown conversion
	 */
	protected function unload_markdown_for_comments() {
		remove_filter( 'pre_comment_content', array( $this, 'pre_comment_content' ), 9 );
	}

	/**
	 * The o2 plugin does some of what we do. Let's take precedence.
	 */
	public function add_o2_helpers() {
		if ( $this->is_posting_enabled() ) {
			add_filter( 'content_save_pre', array( $this, 'o2_escape_lists' ), 1 );
		}

		add_filter( 'o2_preview_post', array( $this, 'o2_preview_post' ) );
		add_filter( 'o2_preview_comment', array( $this, 'o2_preview_comment' ) );

		add_filter( 'wpcom_markdown_transform_pre', array( $this, 'o2_unescape_lists' ) );
		add_filter( 'wpcom_untransformed_content', array( $this, 'o2_unescape_lists' ) );
	}

	/**
	 * If Markdown is enabled for posts on this blog, filter the text for o2 previews
	 *
	 * @param  string $text Post text.
	 * @return string       Post text transformed through the magic of Markdown
	 */
	public function o2_preview_post( $text ) {
		if ( $this->is_posting_enabled() ) {
			$text = $this->transform( $text, array( 'unslash' => false ) );
		}
		return $text;
	}

	/**
	 * If Markdown is enabled for comments on this blog, filter the text for o2 previews
	 *
	 * @param  string $text Comment text.
	 * @return string       Comment text transformed through the magic of Markdown
	 */
	public function o2_preview_comment( $text ) {
		if ( $this->is_commenting_enabled() ) {
			$text = $this->transform( $text, array( 'unslash' => false ) );
		}
		return $text;
	}

	/**
	 * Escapes lists so that o2 doesn't trounce them
	 *
	 * @param  string $text Post/comment text.
	 * @return string       Text escaped with HTML entity for asterisk.
	 */
	public function o2_escape_lists( $text ) {
		return preg_replace( '/^\\* /um', '&#42; ', $text );
	}

	/**
	 * Unescapes the token we inserted on o2_escape_lists
	 *
	 * @param  string $text Post/comment text with HTML entities for asterisks.
	 * @return string       Text with the HTML entity removed
	 */
	public function o2_unescape_lists( $text ) {
		return preg_replace( '/^[&]\#042; /um', '* ', $text );
	}

	/**
	 * Preserve code blocks from being munged by KSES before they have a chance
	 *
	 * @param  string $text post content.
	 * @return string       post content with code blocks escaped.
	 */
	public function preserve_code_blocks( $text ) {
		return $this->get_parser()->codeblock_preserve( $text );
	}

	/**
	 * Remove KSES if it's there. Store the result to manually invoke later if needed.
	 */
	public function maybe_remove_kses() {
		// Filters return true if they existed before you removed them.
		if ( $this->is_posting_enabled() ) {
			$this->kses = remove_filter( 'content_filtered_save_pre', 'wp_filter_post_kses' ) && remove_filter( 'content_save_pre', 'wp_filter_post_kses' );
		}
	}

	/**
	 * Add our Writing and Discussion settings.
	 */
	public function register_setting() {
		add_settings_field( self::POST_OPTION, __( 'Markdown', 'jetpack' ), array( $this, 'post_field' ), 'writing' );
		register_setting( 'writing', self::POST_OPTION, array( $this, 'sanitize_setting' ) );
		add_settings_field( self::COMMENT_OPTION, __( 'Markdown', 'jetpack' ), array( $this, 'comment_field' ), 'discussion' );
		register_setting( 'discussion', self::COMMENT_OPTION, array( $this, 'sanitize_setting' ) );
	}

	/**
	 * Sanitize setting. Don't really want to store "on" value, so we'll store "1" instead!
	 *
	 * @param  string $input Value received by settings API via $_POST.
	 * @return bool          Cast to boolean.
	 */
	public function sanitize_setting( $input ) {
		return (bool) $input;
	}

	/**
	 * Prints HTML for the Writing setting
	 */
	public function post_field() {
		printf(
			'<label><input name="%1$s" id="%1$s" type="checkbox"%2$s /> %3$s</label><p class="description">%4$s</p>',
			esc_attr( self::POST_OPTION ),
			checked( $this->is_posting_enabled(), true, false ),
			esc_html__( 'Use Markdown for posts and pages.', 'jetpack' ),
			sprintf( '<a href="%s">%s</a>', esc_url( $this->get_support_url() ), esc_html__( 'Learn more about Markdown.', 'jetpack' ) )
		);
	}

	/**
	 * Prints HTML for the Discussion setting
	 */
	public function comment_field() {
		printf(
			'<label><input name="%1$s" id="%1$s" type="checkbox"%2$s /> %3$s</label><p class="description">%4$s</p>',
			esc_attr( self::COMMENT_OPTION ),
			checked( $this->is_commenting_enabled(), true, false ),
			esc_html__( 'Use Markdown for comments.', 'jetpack' ),
			sprintf( '<a href="%s">%s</a>', esc_url( $this->get_support_url() ), esc_html__( 'Learn more about Markdown.', 'jetpack' ) )
		);
	}

	/**
	 * Get the support url for Markdown
	 *
	 * @uses   apply_filters
	 * @return string support url
	 */
	protected function get_support_url() {
		/**
		 * Filter the Markdown support URL.
		 *
		 * @module markdown
		 *
		 * @since 2.8.0
		 *
		 * @param string $url Markdown support URL.
		 */
		return apply_filters( 'easy_markdown_support_url', 'https://en.support.wordpress.com/markdown-quick-reference/' );
	}

	/**
	 * Is Mardown conversion for posts enabled?
	 *
	 * @return boolean
	 */
	public function is_posting_enabled() {
		return (bool) Jetpack_Options::get_option_and_ensure_autoload( self::POST_OPTION, '' );
	}

	/**
	 * Is Markdown conversion for comments enabled?
	 *
	 * @return boolean
	 */
	public function is_commenting_enabled() {
		return (bool) Jetpack_Options::get_option_and_ensure_autoload( self::COMMENT_OPTION, '' );
	}

	/**
	 * Check if a $post_id has Markdown enabled
	 *
	 * @param  int $post_id A post ID.
	 * @return boolean
	 */
	public function is_markdown( $post_id ) {
		return get_metadata( 'post', $post_id, self::IS_MD_META, true );
	}

	/**
	 * Set Markdown as enabled on a post_id. We skip over update_postmeta so we
	 * can sneakily set metadata on post revisions, which we need.
	 *
	 * @param int $post_id A post ID.
	 * @return bool  The metadata was successfully set.
	 */
	protected function set_as_markdown( $post_id ) {
		return update_metadata( 'post', $post_id, self::IS_MD_META, true );
	}

	/**
	 * Get our Markdown parser object, optionally requiring all of our needed classes and
	 * instantiating our parser.
	 *
	 * @return object WPCom_GHF_Markdown_Parser instance.
	 */
	public function get_parser() {

		if ( ! self::$parser ) {
			require_once JETPACK__PLUGIN_DIR . '/_inc/lib/markdown.php';
			self::$parser = new WPCom_GHF_Markdown_Parser();
		}

		return self::$parser;
	}

	/**
	 * We don't want Markdown conversion all over the place.
	 */
	public function add_default_post_type_support() {
		add_post_type_support( 'post', self::POST_TYPE_SUPPORT );
		add_post_type_support( 'page', self::POST_TYPE_SUPPORT );
		add_post_type_support( 'revision', self::POST_TYPE_SUPPORT );
	}

	/**
	 * Figure out the post type of the post screen we're on
	 *
	 * @deprecated since 10.8
	 * @return string Current post_type
	 */
	protected function get_post_screen_post_type() {
		_deprecated_function( __METHOD__, 'jetpack-10.8', '' );

		global $pagenow;
		$post_type = filter_input( INPUT_GET, 'post_type', FILTER_UNSAFE_RAW );
		$post_id   = filter_input( INPUT_GET, 'post', FILTER_SANITIZE_NUMBER_INT );

		if ( 'post-new.php' === $pagenow ) {
			return ! empty( $post_type ) ? $post_type : 'post';
		}

		if ( $post_id ) {
			$post_type = get_post_type( $post_id );
		}

		return ! empty( $post_type ) ? $post_type : 'post';
	}

	/**
	 * Swap post_content and post_content_filtered for editing
	 *
	 * @param  string $content Post content.
	 * @param  int    $id         post ID.
	 * @return string          Swapped content
	 */
	public function edit_post_content( $content, $id ) {
		if ( $this->is_markdown( $id ) ) {
			$post = get_post( $id );
			if ( $post && ! empty( $post->post_content_filtered ) ) {
				$post = $this->swap_for_editing( $post );
				return $post->post_content;
			}
		}
		return $content;
	}

	/**
	 * Swap post_content_filtered and post_content for editing
	 *
	 * @param  string $content Post content_filtered.
	 * @param  int    $id         post ID.
	 * @return string          Swapped content
	 */
	public function edit_post_content_filtered( $content, $id ) {
		// if markdown was disabled, let's turn this off.
		if ( ! $this->is_posting_enabled() && $this->is_markdown( $id ) ) {
			$post = get_post( $id );
			if ( $post && ! empty( $post->post_content_filtered ) ) {
				$content = '';
			}
		}
		return $content;
	}

	/**
	 * Some tags are allowed to have a 'markdown' attribute, allowing them to contain Markdown.
	 * We need to tell KSES about those tags.
	 *
	 * @param  array  $tags     List of tags that KSES allows.
	 * @param  string $context The context that KSES is allowing these tags.
	 * @return array           The tags that KSES allows, with our extra 'markdown' parameter where necessary.
	 */
	public function wp_kses_allowed_html( $tags, $context ) {
		if ( 'post' !== $context ) {
			return $tags;
		}

		$re = '/' . $this->get_parser()->contain_span_tags_re . '/';
		foreach ( $tags as $tag => $attributes ) {
			if ( preg_match( $re, $tag ) ) {
				$attributes['markdown'] = true;
				$tags[ $tag ]           = $attributes;
			}
		}

		return $tags;
	}

	/**
	 * TinyMCE needs to know not to strip the 'markdown' attribute. Unfortunately, it doesn't
	 * really offer a nice API for allowed attributes, so we have to manually add it
	 * to the schema instead.
	 */
	public function after_wp_tiny_mce() {
		?>
<script type="text/javascript">
jQuery( function() {
	( 'undefined' !== typeof tinymce ) && tinymce.on( 'AddEditor', function( event ) {
		event.editor.on( 'BeforeSetContent', function( event ) {
			var editor = event.target;
			Object.keys( editor.schema.elements ).forEach( function( key, index ) {
				editor.schema.elements[ key ].attributes['markdown'] = {};
				editor.schema.elements[ key ].attributesOrder.push( 'markdown' );
			} );
		} );
	}, true );
} );
</script>
		<?php
	}

	/**
	 * Magic happens here. Markdown is converted and stored on post_content. Original Markdown is stored
	 * in post_content_filtered so that we can continue editing as Markdown.
	 *
	 * @param  array $post_data  The post data that will be inserted into the DB. Slashed.
	 * @param  array $postarr    All the stuff that was in $_POST.
	 * @return array             $post_data with post_content and post_content_filtered modified
	 */
	public function wp_insert_post_data( $post_data, $postarr ) {
		// $post_data array is slashed!
		$post_id = isset( $postarr['ID'] ) ? $postarr['ID'] : false;
		// bail early if markdown is disabled or this post type is unsupported.
		if ( ! $this->is_posting_enabled() || ! post_type_supports( $post_data['post_type'], self::POST_TYPE_SUPPORT ) ) {
			// it's disabled, but maybe this *was* a markdown post before.
			if ( $this->is_markdown( $post_id ) && ! empty( $post_data['post_content_filtered'] ) ) {
				$post_data['post_content_filtered'] = '';
			}
			// we have no context to determine supported post types in the `post_content_pre` hook,
			// which already ran to sanitize code blocks. Undo that.
			$post_data['post_content'] = $this->get_parser()->codeblock_restore( $post_data['post_content'] );
			return $post_data;
		}
		// rejigger post_content and post_content_filtered
		// revisions are already in the right place, except when we're restoring, but that's taken care of elsewhere
		// also prevent quick edit feature from overriding already-saved markdown (issue https://github.com/Automattic/jetpack/issues/636).
		if ( 'revision' !== $post_data['post_type'] && ! isset( $_POST['_inline_edit'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing
			/**
			 * Filter the original post content passed to Markdown.
			 *
			 * @module markdown
			 *
			 * @since 2.8.0
			 *
			 * @param string $post_data['post_content'] Untransformed post content.
			 */
			$post_data['post_content_filtered'] = apply_filters( 'wpcom_untransformed_content', $post_data['post_content'] );
			$post_data['post_content']          = $this->transform( $post_data['post_content'], array( 'id' => $post_id ) );
			/** This filter is already documented in core/wp-includes/default-filters.php */
			$post_data['post_content'] = apply_filters( 'content_save_pre', $post_data['post_content'] );
		} elseif ( str_starts_with( $post_data['post_name'], $post_data['post_parent'] . '-autosave' ) ) {
			// autosaves for previews are weird.
			/** This filter is already documented in modules/markdown/easy-markdown.php */
			$post_data['post_content_filtered'] = apply_filters( 'wpcom_untransformed_content', $post_data['post_content'] );
			$post_data['post_content']          = $this->transform( $post_data['post_content'], array( 'id' => $post_data['post_parent'] ) );
			/** This filter is already documented in core/wp-includes/default-filters.php */
			$post_data['post_content'] = apply_filters( 'content_save_pre', $post_data['post_content'] );
		}

		// set as markdown on the wp_insert_post hook later.
		if ( $post_id ) {
			$this->monitoring['post'][ $post_id ] = true;
		} else {
			$this->monitoring['content'] = wp_unslash( $post_data['post_content'] );
		}
		if ( 'revision' === $postarr['post_type'] && $this->is_markdown( $postarr['post_parent'] ) ) {
			$this->monitoring['parent'][ $postarr['post_parent'] ] = true;
		}

		return $post_data;
	}

	/**
	 * Calls on wp_insert_post action, after wp_insert_post_data. This way we can
	 * still set postmeta on our revisions after it's all been deleted.
	 *
	 * @param  int $post_id The post ID that has just been added/updated.
	 */
	public function wp_insert_post( $post_id ) {
		$post_parent = get_post_field( 'post_parent', $post_id );
		// this didn't have an ID yet. Compare the content that was just saved.
		if ( isset( $this->monitoring['content'] ) && get_post_field( 'post_content', $post_id ) === $this->monitoring['content'] ) {
			unset( $this->monitoring['content'] );
			$this->set_as_markdown( $post_id );
		}
		if ( isset( $this->monitoring['post'][ $post_id ] ) ) {
			unset( $this->monitoring['post'][ $post_id ] );
			$this->set_as_markdown( $post_id );
		} elseif ( isset( $this->monitoring['parent'][ $post_parent ] ) ) {
			unset( $this->monitoring['parent'][ $post_parent ] );
			$this->set_as_markdown( $post_id );
		}
	}

	/**
	 * Run a comment through Markdown. Easy peasy.
	 *
	 * @param  string $content - the content.
	 * @return string
	 */
	public function pre_comment_content( $content ) {
		return $this->transform(
			$content,
			array(
				'id' => $this->comment_hash( $content ),
			)
		);
	}

	/**
	 * Return a comment hash.
	 *
	 * @param string $content - the content of the comment.
	 */
	protected function comment_hash( $content ) {
		return 'c-' . substr( md5( $content ), 0, 8 );
	}

	/**
	 * Markdown conversion. Some DRYness for repetitive tasks.
	 *
	 * @param  string $text  Content to be run through Markdown.
	 * @param  array  $args  Arguments, with keys:
	 *                       id: provide a string to prefix footnotes with a unique identifier
	 *                       unslash: when true, expects and returns slashed data
	 *                       decode_code_blocks: when true, assume that text in fenced code blocks is already
	 *                         HTML encoded and should be decoded before being passed to Markdown, which does
	 *                         its own encoding.
	 * @return string        Markdown-processed content
	 */
	public function transform( $text, $args = array() ) {
		// If this contains Gutenberg content, let's keep it intact.
		if ( has_blocks( $text ) ) {
			return $text;
		}

		$args = wp_parse_args(
			$args,
			array(
				'id'                 => false,
				'unslash'            => true,
				'decode_code_blocks' => ! $this->get_parser()->use_code_shortcode,
			)
		);
		// probably need to unslash.
		if ( $args['unslash'] ) {
			$text = wp_unslash( $text );
		}

		/**
		 * Filter the content to be run through Markdown, before it's transformed by Markdown.
		 *
		 * @module markdown
		 *
		 * @since 2.8.0
		 *
		 * @param string $text Content to be run through Markdown
		 * @param array $args Array of Markdown options.
		 */
		$text = apply_filters( 'wpcom_markdown_transform_pre', $text, $args );
		// ensure our paragraphs are separated.
		$text = str_replace( array( '</p><p>', "</p>\n<p>" ), "</p>\n\n<p>", $text );
		// visual editor likes to add <p>s. Buh-bye.
		$text = $this->get_parser()->unp( $text );
		// sometimes we get an encoded > at start of line, breaking blockquotes.
		$text = preg_replace( '/^&gt;/m', '>', $text );
		// prefixes are because we need to namespace footnotes by post_id.
		$this->get_parser()->fn_id_prefix = $args['id'] ? $args['id'] . '-' : '';
		// If we're not using the code shortcode, prevent over-encoding.
		if ( $args['decode_code_blocks'] ) {
			$text = $this->get_parser()->codeblock_restore( $text );
		}
		// Transform it!
		$text = $this->get_parser()->transform( $text );
		// Fix footnotes - kses doesn't like the : IDs it supplies.
		$text = preg_replace( '/((id|href)="#?fn(ref)?):/', '$1-', $text );
		// Markdown inserts extra spaces to make itself work. Buh-bye.
		$text = rtrim( $text );
		/**
		 * Filter the content to be run through Markdown, after it was transformed by Markdown.
		 *
		 * @module markdown
		 *
		 * @since 2.8.0
		 *
		 * @param string $text Content to be run through Markdown
		 * @param array $args Array of Markdown options.
		 */
		$text = apply_filters( 'wpcom_markdown_transform_post', $text, $args );

		// probably need to re-slash.
		if ( $args['unslash'] ) {
			$text = wp_slash( $text );
		}

		return $text;
	}

	/**
	 * Shows Markdown in the Revisions screen, and ensures that post_content_filtered
	 * is maintained on revisions
	 *
	 * @param array $fields  Post fields pertinent to revisions.
	 */
	public function wp_post_revision_fields( $fields ) {
		$fields['post_content_filtered'] = __( 'Markdown content', 'jetpack' );
		return $fields;
	}

	/**
	 * Do some song and dance to keep all post_content and post_content_filtered content
	 * in the expected place when a post revision is restored.
	 *
	 * @param  int $post_id        The post ID have a restore done to it.
	 * @param  int $revision_id    The revision ID being restored.
	 */
	public function wp_restore_post_revision( $post_id, $revision_id ) {
		if ( $this->is_markdown( $revision_id ) ) {
			$revision             = get_post( $revision_id, ARRAY_A );
			$post                 = get_post( $post_id, ARRAY_A );
			$post['post_content'] = $revision['post_content_filtered']; // Yes, we put it in post_content, because our wp_insert_post_data() expects that.
			// set this flag so we can restore the post_content_filtered on the last revision later.
			$this->monitoring['restore'] = true;
			// let's not make a revision of our fixing update.
			add_filter( 'wp_revisions_to_keep', '__return_false', 99 );
			wp_update_post( $post );
			$this->fix_latest_revision_on_restore( $post_id );
			remove_filter( 'wp_revisions_to_keep', '__return_false', 99 );
		}
	}

	/**
	 * We need to ensure the last revision has Markdown, not HTML in its post_content_filtered
	 * column after a restore.
	 *
	 * @param  int $post_id The post ID that was just restored.
	 */
	protected function fix_latest_revision_on_restore( $post_id ) {
		global $wpdb;
		$post                                 = get_post( $post_id );
		$last_revision                        = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->posts WHERE post_type = 'revision' AND post_parent = %d ORDER BY ID DESC", $post->ID ) );
		$last_revision->post_content_filtered = $post->post_content_filtered;
		wp_insert_post( (array) $last_revision );
	}

	/**
	 * Kicks off magic for an XML-RPC session. We want to keep editing Markdown
	 * and publishing HTML.
	 *
	 * @param  string $xmlrpc_method The current XML-RPC method.
	 */
	public function xmlrpc_actions( $xmlrpc_method ) {
		switch ( $xmlrpc_method ) {
			case 'metaWeblog.getRecentPosts':
			case 'wp.getPosts':
			case 'wp.getPages':
				add_action( 'parse_query', array( $this, 'make_filterable' ), 10, 1 );
				break;
			case 'wp.getPost':
				$this->prime_post_cache();
				break;
		}
	}

	/**
	 * Function metaWeblog.getPost and wp.getPage fire xmlrpc_call action *after* get_post() is called.
	 * So, we have to detect those methods and prime the post cache early.
	 *
	 * @return null
	 */
	protected function check_for_early_methods() {
		$raw_post_data = file_get_contents( 'php://input' );
		if ( ! str_contains( $raw_post_data, 'metaWeblog.getPost' )
			&& ! str_contains( $raw_post_data, 'wp.getPage' ) ) {
			return;
		}
		include_once ABSPATH . WPINC . '/class-IXR.php';
		$message = new IXR_Message( $raw_post_data );
		$message->parse();
		$post_id_position = 'metaWeblog.getPost' === $message->methodName ? 0 : 1; // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
		$this->prime_post_cache( $message->params[ $post_id_position ] );
	}

	/**
	 * Prime the post cache with swapped post_content. This is a sneaky way of getting around
	 * the fact that there are no good hooks to call on the *.getPost xmlrpc methods.
	 *
	 * @param bool $post_id - the post ID that we're priming.
	 */
	private function prime_post_cache( $post_id = false ) {
		global $wp_xmlrpc_server;
		if ( ! $post_id ) {
			$post_id = $wp_xmlrpc_server->message->params[3];
		}

		// prime the post cache.
		if ( $this->is_markdown( $post_id ) ) {
			$post = get_post( $post_id );
			if ( ! empty( $post->post_content_filtered ) ) {
				wp_cache_delete( $post->ID, 'posts' );
				$post = $this->swap_for_editing( $post );
				wp_cache_add( $post->ID, $post, 'posts' );
				$this->posts_to_uncache[] = $post_id;
			}
		}
		// uncache munged posts if using a persistent object cache.
		if ( wp_using_ext_object_cache() ) {
			add_action( 'shutdown', array( $this, 'uncache_munged_posts' ) );
		}
	}

	/**
	 * Swaps `post_content_filtered` back to `post_content` for editing purposes.
	 *
	 * @param  object $post WP_Post object.
	 * @return object WP_Post object with swapped `post_content_filtered` and `post_content`.
	 */
	protected function swap_for_editing( $post ) {
		$markdown = $post->post_content_filtered;
		// unencode encoded code blocks.
		$markdown = $this->get_parser()->codeblock_restore( $markdown );
		// restore beginning of line blockquotes.
		$markdown                    = preg_replace( '/^&gt; /m', '> ', $markdown );
		$post->post_content_filtered = $post->post_content;
		$post->post_content          = $markdown;
		return $post;
	}

	/**
	 * We munge the post cache to serve proper markdown content to XML-RPC clients.
	 * Uncache these after the XML-RPC session ends.
	 */
	public function uncache_munged_posts() {
		// $this context gets lost in testing sometimes. Weird.
		foreach ( self::get_instance()->posts_to_uncache as $post_id ) {
			wp_cache_delete( $post_id, 'posts' );
		}
	}

	/**
	 * Since *.(get)?[Rr]ecentPosts calls get_posts with suppress filters on, we need to
	 * turn them back on so that we can swap things for editing.
	 *
	 * @param object $wp_query WP_Query object.
	 */
	public function make_filterable( $wp_query ) {
		$wp_query->set( 'suppress_filters', false );
		add_action( 'the_posts', array( $this, 'the_posts' ), 10, 2 );
	}

	/**
	 * Swaps post_content and post_content_filtered for editing.
	 *
	 * @param array $posts Posts returned by the just-completed query.
	 * @return array Modified $posts
	 */
	public function the_posts( $posts ) {
		foreach ( $posts as $key => $post ) {
			if ( $this->is_markdown( $post->ID ) && ! empty( $posts[ $key ]->post_content_filtered ) ) {
				$markdown                             = $posts[ $key ]->post_content_filtered;
				$posts[ $key ]->post_content_filtered = $posts[ $key ]->post_content;
				$posts[ $key ]->post_content          = $markdown;
			}
		}
		return $posts;
	}

	/**
	 * Singleton silence is golden
	 */
	private function __construct() {}
}

add_action( 'init', array( WPCom_Markdown::get_instance(), 'load' ) );
markdown.php                                                                                                                                                                                                                                                   1007          1711191384  plugins/jetpack/modules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Module Name: Markdown
 * Module Description: Write posts or pages in plain-text Markdown syntax
 * Sort Order: 31
 * First Introduced: 2.8
 * Requires Connection: No
 * Auto Activate: No
 * Module Tags: Writing
 * Feature: Writing
 * Additional Search Queries: md, markdown
 *
 * @package automattic/jetpack
 */

// Require the markdown class file.
require __DIR__ . '/markdown/easy-markdown.php';

/**
 * Remove checkbox set in modules/markdown/easy-markdown.php.
 * We don't just remove the register_setting call there because the checkbox is
 * needed on WordPress.com, where the file is sync'ed verbatim.
 */
function jetpack_markdown_posting_always_on() {
	// why oh why isn't there a remove_settings_field?
	global $wp_settings_fields;
	if ( isset( $wp_settings_fields['writing']['default'][ WPCom_Markdown::POST_OPTION ] ) ) {
		unset( $wp_settings_fields['writing']['default'][ WPCom_Markdown::POST_OPTION ] );
	}
}
add_action( 'admin_init', 'jetpack_markdown_posting_always_on', 11 );
class-admin-color-schemes.php                                                                                                                                                                                                                                  5215          1711191384  plugins/jetpack/modules/masterbar/admin-color-schemes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Unifies admin color scheme selection across WP.com sites.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Unifies admin color scheme selection across WP.com sites.
 */
class Admin_Color_Schemes {

	/**
	 * Admin_Color_Schemes constructor.
	 */
	public function __construct() {
		add_action( 'admin_init', array( $this, 'register_admin_color_schemes' ) );
		add_action( 'rest_api_init', array( $this, 'register_admin_color_meta' ) );
		add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_core_color_schemes_overrides' ) );
	}

	/**
	 * Makes admin_color available in users REST API endpoint.
	 */
	public function register_admin_color_meta() {
		register_meta(
			'user',
			'admin_color',
			array(
				'auth_callback' => array( $this, 'update_admin_color_permissions_check' ),
				'description'   => __( 'Slug of the admin color scheme.', 'jetpack' ),
				'single'        => true,
				'show_in_rest'  => array(
					'schema' => array( 'default' => 'fresh' ),
				),
				'type'          => 'string',
			)
		);
	}

	/**
	 * Permission callback to edit the `admin_color` user meta.
	 *
	 * @param bool   $allowed   Whether the given user is allowed to edit this meta value.
	 * @param string $meta_key  Meta key. In this case `admin_color`.
	 * @param int    $object_id Queried user ID.
	 * @return bool
	 */
	public function update_admin_color_permissions_check( $allowed, $meta_key, $object_id ) { // phpcs:ignore Generic.CodeAnalysis.UnusedFunctionParameter, VariableAnalysis.CodeAnalysis.VariableAnalysis.UnusedVariable
		return current_user_can( 'edit_user', $object_id );
	}

	/**
	 * Get the admin color scheme URL based on the environment
	 *
	 * @param string $color_scheme  The color scheme to get the URL for.
	 * @return string
	 */
	public function get_admin_color_scheme_url( $color_scheme ) {
		return plugins_url( '_inc/build/masterbar/admin-color-schemes/colors/' . $color_scheme . '/colors.css', JETPACK__PLUGIN_FILE );
	}

	/**
	 * Registers new admin color schemes
	 */
	public function register_admin_color_schemes() {

		wp_admin_css_color(
			'aquatic',
			__( 'Aquatic', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'aquatic' ),
			array( '#135e96', '#007e65', '#043959', '#c5d9ed' ),
			array(
				'base'    => '#c5d9ed',
				'focus'   => '#fff',
				'current' => '#01263a',
			)
		);

		wp_admin_css_color(
			'classic-blue',
			__( 'Classic Blue', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'classic-blue' ),
			array( '#135e96', '#b26200', '#dcdcde', '#646970' ),
			array(
				'base'    => '#646970',
				'focus'   => '#2271b1',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'classic-bright',
			__( 'Classic Bright', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'classic-bright' ),
			array( '#135e96', '#c9256e', '#ffffff', '#e9eff5' ),
			array(
				'base'    => '#646970',
				'focus'   => '#1d2327',
				'current' => '#0a4b78',
			)
		);

		wp_admin_css_color(
			'classic-dark',
			__( 'Classic Dark', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'classic-dark' ),
			array( '#101517', '#c9356e', '#32373c', '#0073aa' ),
			array(
				'base'    => '#a2aab2',
				'focus'   => '#00b9eb',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'contrast',
			__( 'Contrast', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'contrast' ),
			array( '#101517', '#ffffff', '#32373c', '#b4b9be' ),
			array(
				'base'    => '#1d2327',
				'focus'   => '#fff',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'nightfall',
			__( 'Nightfall', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'nightfall' ),
			array( '#00131c', '#043959', '#2271b1', '#9ec2e6' ),
			array(
				'base'    => '#9ec2e6',
				'focus'   => '#fff',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'powder-snow',
			__( 'Powder Snow', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'powder-snow' ),
			array( '#101517', '#2271b1', '#dcdcde', '#646970' ),
			array(
				'base'    => '#646970',
				'focus'   => '#135e96',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'sakura',
			__( 'Sakura', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'sakura' ),
			array( '#005042', '#f2ceda', '#2271b1', '#8c1749' ),
			array(
				'base'    => '#8c1749',
				'focus'   => '#4f092a',
				'current' => '#fff',
			)
		);

		wp_admin_css_color(
			'sunset',
			__( 'Sunset', 'jetpack' ),
			$this->get_admin_color_scheme_url( 'sunset' ),
			array( '#691c1c', '#b26200', '#f0c930', '#facfd2' ),
			array(
				'base'    => '#facfd2',
				'focus'   => '#fff',
				'current' => '#4f3500',
			)
		);
	}

	/**
	 * Enqueues current color-scheme overrides for core color schemes
	 */
	public function enqueue_core_color_schemes_overrides() {
		$core_color_schemes = array( 'blue', 'coffee', 'ectoplasm', 'fresh', 'light', 'midnight', 'modern', 'ocean', 'sunrise' );
		$color_scheme       = get_user_option( 'admin_color' );
		if ( in_array( $color_scheme, $core_color_schemes, true ) ) {
			wp_enqueue_style(
				'jetpack-core-color-schemes-overrides',
				$this->get_admin_color_scheme_url( $color_scheme ),
				array(),
				JETPACK__VERSION
			);
		}
	}
}
admin-menu-nav-unification-rtl.css                                                                                                                                                                                                                             2338          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /*
 * Styles for the nav-unification prototype (see pbAPfg-O2)
 * TODO: depending on project outcome move or delete styles
 */
#wpadminbar #wp-admin-bar-notes #wpnt-notes-unread-count.wpn-unread {
  top: 50%;
  right: 50%;
  transform: translate(10px, -13px);
}

#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar {
  transform: translateX(-1px);
}

#wpadminbar #wp-admin-bar-notes.active .noticon-bell:before {
  background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cmVjdCB4PSIwIiBmaWxsPSJub25lIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiLz48Zz48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNNi4xNCAxNC45N2wyLjgyOCAyLjgyN2MtLjM2Mi4zNjItLjg2Mi41ODYtMS40MTQuNTg2LTEuMTA1IDAtMi0uODk1LTItMiAwLS41NTIuMjI0LTEuMDUyLjU4Ni0xLjQxNHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRjMi4zNC0yLjM0IDYuMTM1LTIuMzQgOC40NzUgMHMyLjM0IDYuMTM1IDAgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N2wuMTU3IDEuMXoiLz48L2c+PC9zdmc+) !important;
}

#wpadminbar > #wp-toolbar .wpnt-show span.noticon,
#wpadminbar #wp-admin-bar-notes.wpnt-show .noticon {
  color: #ffffff;
}

#wpadminbar .quicklinks ul#wp-admin-bar-root-default {
  padding-right: 0 !important;
}

#wpadminbar #wp-admin-bar-menu-toggle {
  display: none;
}

@media screen and (max-width: 782px) {
  #wpadminbar #wp-toolbar > ul > li {
    display: block;
  }
  #wpadminbar .ab-top-menu > li > .ab-item {
    box-sizing: border-box;
    line-height: 32px;
  }
  #wpadminbar #wp-admin-bar-ab-new-post > .ab-item {
    box-sizing: inherit !important;
  }
  #wpadminbar #wp-admin-bar-my-account > .ab-item {
    padding: 7px 15px;
    width: auto;
  }
  #wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
    display: block;
    left: auto;
    right: auto;
    position: static;
    margin-top: 3px;
    top: 13px;
  }
  /* Hide debug bar. */
  #wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-debug-bar {
    display: none;
  }
}
@media screen and (max-width: 480px) {
  #wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a {
    width: auto;
  }
  #wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
    margin-top: 12px;
  }
}
admin-menu-nav-unification-rtl.min.css                                                                                                                                                                                                                         1775          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #wpadminbar #wp-admin-bar-notes #wpnt-notes-unread-count.wpn-unread{right:50%;top:50%;transform:translate(10px,-13px)}#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar{transform:translateX(-1px)}#wpadminbar #wp-admin-bar-notes.active .noticon-bell:before{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGgyNHYyNEgweiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Im02LjE0IDE0Ljk3IDIuODI4IDIuODI3YTIgMiAwIDEgMS0yLjgyOC0yLjgyOHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRhNS45OTMgNS45OTMgMCAwIDEgOC40NzUgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N3oiLz48L3N2Zz4=)!important}#wpadminbar #wp-admin-bar-notes.wpnt-show .noticon,#wpadminbar>#wp-toolbar .wpnt-show span.noticon{color:#fff}#wpadminbar .quicklinks ul#wp-admin-bar-root-default{padding-right:0!important}#wpadminbar #wp-admin-bar-menu-toggle{display:none}@media screen and (max-width:782px){#wpadminbar #wp-toolbar>ul>li{display:block}#wpadminbar .ab-top-menu>li>.ab-item{box-sizing:border-box;line-height:32px}#wpadminbar #wp-admin-bar-ab-new-post>.ab-item{box-sizing:inherit!important}#wpadminbar #wp-admin-bar-my-account>.ab-item{padding:7px 15px;width:auto}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a img{display:block;left:auto;margin-top:3px;position:static;right:auto;top:13px}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-debug-bar{display:none}}@media screen and (max-width:480px){#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a{width:auto}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a img{margin-top:12px}}admin-menu-nav-unification.css                                                                                                                                                                                                                                 2296          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /*
 * Styles for the nav-unification prototype (see pbAPfg-O2)
 * TODO: depending on project outcome move or delete styles
 */
#wpadminbar #wp-admin-bar-notes #wpnt-notes-unread-count.wpn-unread {
	top: 50%;
	left: 50%;
	transform: translate( -10px, -13px );

}

#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar {
	transform: translateX( 1px );
}

#wpadminbar #wp-admin-bar-notes.active .noticon-bell:before {
	background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cmVjdCB4PSIwIiBmaWxsPSJub25lIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiLz48Zz48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNNi4xNCAxNC45N2wyLjgyOCAyLjgyN2MtLjM2Mi4zNjItLjg2Mi41ODYtMS40MTQuNTg2LTEuMTA1IDAtMi0uODk1LTItMiAwLS41NTIuMjI0LTEuMDUyLjU4Ni0xLjQxNHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRjMi4zNC0yLjM0IDYuMTM1LTIuMzQgOC40NzUgMHMyLjM0IDYuMTM1IDAgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N2wuMTU3IDEuMXoiLz48L2c+PC9zdmc+") !important;
}

#wpadminbar > #wp-toolbar .wpnt-show span.noticon,
#wpadminbar #wp-admin-bar-notes.wpnt-show .noticon {
	color: #ffffff;
}

#wpadminbar .quicklinks ul#wp-admin-bar-root-default {
	padding-left: 0 !important;
}

#wpadminbar #wp-admin-bar-menu-toggle {
	display: none;
}

@media screen and (max-width: 782px) {
	#wpadminbar #wp-toolbar > ul > li {
		display: block;
	}

	#wpadminbar .ab-top-menu > li > .ab-item {
		box-sizing: border-box;
		line-height: 32px;
	}

	#wpadminbar #wp-admin-bar-ab-new-post > .ab-item {
		box-sizing: inherit !important;
	}

	#wpadminbar #wp-admin-bar-my-account > .ab-item {
		padding: 7px 15px;
		width: auto;
	}

	#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
		display: block;
		right: auto;
		left: auto;
		position: static;
		margin-top: 3px;
		top: 13px;
	}

	/* Hide debug bar. */
	#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-debug-bar {
		display: none;
	}
}

@media screen and  (max-width: 480px) {
	#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a {
		width: auto;
	}

	#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
		margin-top: 12px;
	}
}
admin-menu-nav-unification.min.css                                                                                                                                                                                                                             1773          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #wpadminbar #wp-admin-bar-notes #wpnt-notes-unread-count.wpn-unread{left:50%;top:50%;transform:translate(-10px,-13px)}#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar{transform:translateX(1px)}#wpadminbar #wp-admin-bar-notes.active .noticon-bell:before{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGgyNHYyNEgweiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Im02LjE0IDE0Ljk3IDIuODI4IDIuODI3YTIgMiAwIDEgMS0yLjgyOC0yLjgyOHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRhNS45OTMgNS45OTMgMCAwIDEgOC40NzUgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N3oiLz48L3N2Zz4=)!important}#wpadminbar #wp-admin-bar-notes.wpnt-show .noticon,#wpadminbar>#wp-toolbar .wpnt-show span.noticon{color:#fff}#wpadminbar .quicklinks ul#wp-admin-bar-root-default{padding-left:0!important}#wpadminbar #wp-admin-bar-menu-toggle{display:none}@media screen and (max-width:782px){#wpadminbar #wp-toolbar>ul>li{display:block}#wpadminbar .ab-top-menu>li>.ab-item{box-sizing:border-box;line-height:32px}#wpadminbar #wp-admin-bar-ab-new-post>.ab-item{box-sizing:inherit!important}#wpadminbar #wp-admin-bar-my-account>.ab-item{padding:7px 15px;width:auto}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a img{display:block;left:auto;margin-top:3px;position:static;right:auto;top:13px}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-debug-bar{display:none}}@media screen and (max-width:480px){#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a{width:auto}#wpadminbar #wp-toolbar.quicklinks li#wp-admin-bar-my-account.with-avatar>a img{margin-top:12px}}admin-menu-rtl.css                                                                                                                                                                                                                                             11144         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #adminmenu {
  margin: 0;
}

/**
 * Menu width
 */
#wpcontent,
#wpfooter {
  margin-right: 272px;
}

#adminmenuback,
#adminmenuwrap,
#adminmenu,
#adminmenu .wp-submenu {
  width: 272px;
}

#adminmenu .wp-submenu {
  right: 272px;
}

#adminmenu .wp-not-current-submenu .wp-submenu,
.folded #adminmenu .wp-has-current-submenu .wp-submenu {
  min-width: 272px;
}

/**
 * Fixes Gutenberg in not fullscreen mode.
 */
@media (min-width: 783px) {
  .interface-interface-skeleton,
  .edit-post-layout .components-editor-notices__snackbar {
    right: 272px;
  }
}
@media (min-width: 961px) {
  body:not(.folded).auto-fold .interface-interface-skeleton,
  .auto-fold .edit-post-layout .components-editor-notices__snackbar,
  .components-snackbar-list.edit-widgets-notices__snackbar,
  .jp-dialogue-modern-full__container {
    right: 272px;
  }
  .global-notices {
    max-width: calc(100% - 48px - 272px);
  }
}
/**
 * Jetpack logo
 */
#adminmenu [class*=activity-log] .wp-menu-image img {
  padding-top: 7px;
}

/**
 * Site Card
 */
#adminmenu .toplevel_page_site-card .wp-menu-name {
  margin-right: 40px; /* icon width (32) + padding (8). */
  padding: 0;
}

#adminmenu li.toplevel_page_site-card a {
  padding: 10px 8px 10px 0;
}

/**
 * Site Notices
 */
#adminmenu a.toplevel_page_site-notices:hover,
#adminmenu a.toplevel_page_site-notices:focus,
#adminmenu li.toplevel_page_site-notices:hover,
#adminmenu li.toplevel_page_site-notices:focus {
  background-color: inherit !important;
  color: inherit !important;
}

#adminmenu li.toplevel_page_site-notices .wp-menu-image {
  display: none;
}

#adminmenu .toplevel_page_site-notices .wp-menu-image {
  border-radius: 2px;
  background-color: #fff;
}

#adminmenu .toplevel_page_site-notices .wp-menu-image:before {
  content: "\f534";
  font-family: "dashicons";
  font-size: 20px;
  line-height: 20px;
  background-color: #a7aaad;
  color: white;
  border-radius: 50%;
  margin: 5px;
  padding: 0;
}

#adminmenu .toplevel_page_site-notices:hover .wp-menu-image:before {
  color: #fff;
}

#adminmenu .toplevel_page_site-notices .upsell_banner {
  display: flex;
  flex-grow: 1;
  flex-wrap: nowrap;
  align-items: center;
  justify-content: space-between;
  position: relative;
  width: 100%;
  padding: 7px 12px;
  right: -28px;
  border-radius: 2px;
  font-size: 12px;
  line-height: 1.4;
  -webkit-hyphens: none;
          hyphens: none;
}

#adminmenu .toplevel_page_site-notices .upsell_banner .banner__info {
  margin-left: 12px;
}

#adminmenu .toplevel_page_site-notices .upsell_banner .button {
  font-size: 12px;
  line-height: 12px;
  padding: 0 7px;
  border: 0;
  min-height: 26px;
}

#adminmenu .toplevel_page_site-notices .upsell_banner svg.dismissible-card__close-icon {
  height: 24px;
  width: 24px;
  margin-right: 10px;
}

@media screen and (min-width: 782px) {
  .folded #adminmenu .toplevel_page_site-notices .wp-menu-image {
    display: block;
    width: 30px;
  }
  .folded #adminmenu .toplevel_page_site-notices {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}
@media screen and (min-width: 782px) and (max-width: 960px) {
  .auto-fold #adminmenu .toplevel_page_site-notices .wp-menu-image {
    display: block;
    width: 30px;
  }
  .auto-fold #adminmenu .toplevel_page_site-notices {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}
/* Prevent box-shadow at the top of the sidebar */
#adminmenu .site-switcher:hover,
#adminmenu .toplevel_page_site-card:hover,
#adminmenu .toplevel_page_site-notices:hover {
  box-shadow: none;
}

/**
 * Site icon inline-styles for height and width are defined in set_site_icon_inline_styles
 */
#adminmenu .toplevel_page_site-card .wp-menu-image {
  background-image: none;
  background-position: center;
  background-repeat: no-repeat;
  background-size: 18px 18px;
  transform: translateZ(0);
  transition-property: background-image, background-color;
  transition-duration: 0.2s;
}

#adminmenu a.toplevel_page_site-card:hover,
#adminmenu li.toplevel_page_site-card:hover {
  background-color: inherit;
}

#adminmenu .toplevel_page_site-card img {
  opacity: initial;
}

#adminmenu .toplevel_page_site-card.has-site-icon img {
  padding: 0;
}

#adminmenu .toplevel_page_site-card:hover div.wp-menu-image,
#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image {
  background-image: url("data:image/svg+xml,%3Csvg class=%27gridicon gridicons-house%27 height=%2724%27 width=%2724%27 xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27%3E%3Cg%3E%3Cpath fill=%27%23fff%27 d=%27M22 9L12 1 2 9v2h2v10h5v-4c0-1.657 1.343-3 3-3s3 1.343 3 3v4h5V11h2V9z%27/%3E%3C/g%3E%3C/svg%3E%0A");
}

#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image {
  background-color: #c3c4c7;
  height: 32px;
  width: 32px;
}

#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image img {
  width: 18px;
  height: 18px;
  padding: 7px;
}

#adminmenu .toplevel_page_site-card:hover div.wp-menu-image img,
#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image img {
  display: none;
}

.site__info .site__title {
  display: block;
  font-size: 14px;
  font-weight: 400;
  line-height: 1.3;
}

.site__info .site__domain {
  display: block;
  max-width: 95%;
  font-size: 12px;
  line-height: 1.4;
  margin-top: 2px;
}

.site__info .site__title,
.site__info .site__domain {
  overflow: hidden;
  white-space: nowrap;
}

.site__info .site__title::after,
.site__info .site__domain::after {
  content: "";
  display: block;
  position: absolute;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  pointer-events: none;
  top: 0;
  bottom: 0;
  left: 0;
  right: auto;
  width: 20%;
  height: auto;
}

.site__info > .site__badge {
  font-size: 12px;
  border-radius: 12px;
  clear: both;
  display: inline-block;
  margin-top: 6px;
  margin-left: 3px;
  padding: 1px 10px;
}

.site__info > .site__badge.site__badge-staging {
  background-color: #f0c930;
  color: #4f3500;
}

/**
 * Inline text in a menu title
 */
.inline-text {
  display: block !important;
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0.8;
}

/**
 * Stats
 */
[class*="toplevel_page_https://wordpress.com/stats/day"] .sidebar-unified__sparkline {
  float: left;
  margin-left: 8px;
}

/**
 * Folded State
 */
.folded #adminmenu a.menu-top {
  height: 31px;
}

.folded #adminmenu li.toplevel_page_site-card a {
  padding-right: 0;
}

/* Auto-folding of the admin menu */
@media only screen and (max-width: 960px) {
  #adminmenu,
  #adminmenuwrap,
  #adminmenuback {
    width: 272px;
  }
  .auto-fold #adminmenu a[class*=toplevel_page_http].wp-first-item {
    height: auto;
  }
  .wp-responsive-open #adminmenu a.menu-top {
    height: auto;
  }
  .auto-fold #adminmenu div.wp-menu-image {
    width: 36px;
  }
}
@media screen and (min-width: 782px) and (max-width: 960px) {
  .auto-fold #adminmenu a.menu-top {
    height: 34px;
  }
  .auto-fold #adminmenu li.toplevel_page_site-card a {
    height: 36px;
    padding-right: 1px;
  }
}
@media screen and (max-width: 782px) {
  #adminmenu li.menu-top .wp-submenu > li > a,
  .auto-fold #adminmenu li.menu-top .wp-submenu > li > a {
    padding-right: 42px;
  }
  .wp-responsive-open #wpbody {
    left: inherit;
  }
  .wp-responsive-open #wpcontent {
    margin-right: 272px;
  }
  .auto-fold #adminmenu, .auto-fold #adminmenuback, .auto-fold #adminmenuwrap {
    width: 272px;
  }
  .auto-fold #adminmenu a.site-switcher,
  #adminmenu a.site-switcher {
    font-size: 14px;
  }
}
@media only screen and (max-width: 660px) {
  #adminmenuback,
  #adminmenuwrap,
  #adminmenu,
  #adminmenu .wp-submenu,
  .auto-fold #adminmenu,
  .auto-fold #adminmenuback,
  .auto-fold #adminmenuwrap {
    width: 100%;
    z-index: 171;
  }
  .wp-responsive-open #wpcontent {
    margin-right: 0;
  }
  ul#adminmenu a.wp-has-current-submenu:after,
  ul#adminmenu > li.current > a.current:after,
  ul#adminmenu li:hover a.wp-has-current-submenu:after,
  .auto-fold ul#adminmenu li:hover a.wp-has-current-submenu:after {
    display: none;
  }
  .auto-fold #adminmenu li.toplevel_page_site-card a {
    padding: 18px 12px 18px 0;
  }
}
/* Dashboard Switcher */
#view-link-wrap {
  float: right;
  margin: 0 6px 0 0;
}

.screen-options-tab__wrapper {
  position: relative;
}

.screen-options-tab__dropdown {
  background-color: #fff;
  border: 1px solid var(--color-neutral-5);
  border-radius: 4px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1019607843);
  padding: 3px;
  position: absolute;
  left: 20px;
  top: 37px;
  width: 215px;
  z-index: 9999;
}

@media screen and (max-width: 782px) {
  .screen-options-tab__dropdown {
    left: 10px;
    top: 47px;
  }
}
@media screen and (max-width: 600px) {
  .screen-options-tab__dropdown {
    top: 93px;
  }
}
.screen-switcher:not(:hover) .screen-switcher__button:nth-child(2) > strong {
  color: var(--wp-admin-theme-color);
}

.screen-switcher__button, a.screen-switcher__button {
  background: transparent;
  border: 1px solid rgba(0, 0, 0, 0);
  border-radius: 4px;
  color: var(--color-text);
  cursor: pointer;
  display: inline-block;
  font-size: 0.75rem;
  line-height: normal;
  text-decoration: none;
  padding: 8px;
  text-align: right;
}

.screen-switcher__button:nth-child(2), a.screen-switcher__button:nth-child(2) {
  border-color: var(--wp-admin-theme-color);
  margin-bottom: 4px;
}

.screen-switcher__button:last-child, a.screen-switcher__button:last-child {
  margin-bottom: 0;
}

.screen-switcher__button strong, a.screen-switcher__button strong {
  display: block;
  font-size: 13px;
  margin-bottom: 4px;
}

.screen-switcher__button:focus > strong, .screen-switcher__button:hover > strong, a.screen-switcher__button:focus > strong, a.screen-switcher__button:hover > strong {
  color: var(--wp-admin-theme-color);
}

/** Add new site button **/
#adminmenu {
  display: flex;
  flex-direction: column;
}

#adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] {
  order: 99999;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] {
  padding: 8px;
  width: auto;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a {
  background: transparent;
  border-color: var(--transparent-button-text-color, currentcolor);
  display: flex;
  justify-content: center;
  margin-top: auto;
  background: transparent;
  border-style: solid;
  border-width: 1px;
  cursor: pointer;
  margin: 0;
  outline: 0;
  overflow: hidden;
  text-align: center;
  text-overflow: ellipsis;
  text-decoration: none;
  vertical-align: top;
  box-sizing: border-box;
  font-size: 14px;
  line-height: 22px;
  border-radius: 2px;
  padding: 8px 14px;
  -webkit-appearance: none;
          appearance: none;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a:hover {
  box-shadow: none;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-name {
  padding: 0;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-image {
  display: none;
}
admin-menu-rtl.min.css                                                                                                                                                                                                                                         8969          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #adminmenu{margin:0}#wpcontent,#wpfooter{margin-right:272px}#adminmenu,#adminmenu .wp-submenu,#adminmenuback,#adminmenuwrap{width:272px}#adminmenu .wp-submenu{right:272px}#adminmenu .wp-not-current-submenu .wp-submenu,.folded #adminmenu .wp-has-current-submenu .wp-submenu{min-width:272px}@media (min-width:783px){.edit-post-layout .components-editor-notices__snackbar,.interface-interface-skeleton{right:272px}}@media (min-width:961px){.auto-fold .edit-post-layout .components-editor-notices__snackbar,.components-snackbar-list.edit-widgets-notices__snackbar,.jp-dialogue-modern-full__container,body:not(.folded).auto-fold .interface-interface-skeleton{right:272px}.global-notices{max-width:calc(100% - 320px)}}#adminmenu [class*=activity-log] .wp-menu-image img{padding-top:7px}#adminmenu .toplevel_page_site-card .wp-menu-name{margin-right:40px;padding:0}#adminmenu li.toplevel_page_site-card a{padding:10px 8px 10px 0}#adminmenu a.toplevel_page_site-notices:focus,#adminmenu a.toplevel_page_site-notices:hover,#adminmenu li.toplevel_page_site-notices:focus,#adminmenu li.toplevel_page_site-notices:hover{background-color:inherit!important;color:inherit!important}#adminmenu li.toplevel_page_site-notices .wp-menu-image{display:none}#adminmenu .toplevel_page_site-notices .wp-menu-image{background-color:#fff;border-radius:2px}#adminmenu .toplevel_page_site-notices .wp-menu-image:before{background-color:#a7aaad;border-radius:50%;color:#fff;content:"\f534";font-family:dashicons;font-size:20px;line-height:20px;margin:5px;padding:0}#adminmenu .toplevel_page_site-notices:hover .wp-menu-image:before{color:#fff}#adminmenu .toplevel_page_site-notices .upsell_banner{align-items:center;border-radius:2px;display:flex;flex-grow:1;flex-wrap:nowrap;font-size:12px;-webkit-hyphens:none;hyphens:none;justify-content:space-between;line-height:1.4;padding:7px 12px;position:relative;right:-28px;width:100%}#adminmenu .toplevel_page_site-notices .upsell_banner .banner__info{margin-left:12px}#adminmenu .toplevel_page_site-notices .upsell_banner .button{border:0;font-size:12px;line-height:12px;min-height:26px;padding:0 7px}#adminmenu .toplevel_page_site-notices .upsell_banner svg.dismissible-card__close-icon{height:24px;margin-right:10px;width:24px}@media screen and (min-width:782px){.folded #adminmenu .toplevel_page_site-notices .wp-menu-image{display:block;width:30px}.folded #adminmenu .toplevel_page_site-notices{align-items:center;display:flex;height:50px;justify-content:center}}@media screen and (min-width:782px) and (max-width:960px){.auto-fold #adminmenu .toplevel_page_site-notices .wp-menu-image{display:block;width:30px}.auto-fold #adminmenu .toplevel_page_site-notices{align-items:center;display:flex;height:50px;justify-content:center}}#adminmenu .site-switcher:hover,#adminmenu .toplevel_page_site-card:hover,#adminmenu .toplevel_page_site-notices:hover{box-shadow:none}#adminmenu .toplevel_page_site-card .wp-menu-image{background-image:none;background-position:50%;background-repeat:no-repeat;background-size:18px 18px;transform:translateZ(0);transition-duration:.2s;transition-property:background-image,background-color}#adminmenu a.toplevel_page_site-card:hover,#adminmenu li.toplevel_page_site-card:hover{background-color:inherit}#adminmenu .toplevel_page_site-card img{opacity:1}#adminmenu .toplevel_page_site-card.has-site-icon img{padding:0}#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image,#adminmenu .toplevel_page_site-card:hover div.wp-menu-image{background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' class='gridicon gridicons-house'%3E%3Cpath fill='%23fff' d='M22 9 12 1 2 9v2h2v10h5v-4a3 3 0 1 1 6 0v4h5V11h2z'/%3E%3C/svg%3E")}#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image{background-color:#c3c4c7;height:32px;width:32px}#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image img{height:18px;padding:7px;width:18px}#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image img,#adminmenu .toplevel_page_site-card:hover div.wp-menu-image img{display:none}.site__info .site__title{display:block;font-size:14px;font-weight:400;line-height:1.3}.site__info .site__domain{display:block;font-size:12px;line-height:1.4;margin-top:2px;max-width:95%}.site__info .site__domain,.site__info .site__title{overflow:hidden;white-space:nowrap}.site__info .site__domain:after,.site__info .site__title:after{content:"";display:block;position:absolute;-webkit-touch-callout:none;bottom:0;height:auto;left:0;pointer-events:none;right:auto;top:0;-webkit-user-select:none;user-select:none;width:20%}.site__info>.site__badge{border-radius:12px;clear:both;display:inline-block;font-size:12px;margin-left:3px;margin-top:6px;padding:1px 10px}.site__info>.site__badge.site__badge-staging{background-color:#f0c930;color:#4f3500}.inline-text{display:block!important;left:20px;opacity:.8;position:absolute;top:50%;transform:translateY(-50%)}[class*="toplevel_page_https://wordpress.com/stats/day"] .sidebar-unified__sparkline{float:left;margin-left:8px}.folded #adminmenu a.menu-top{height:31px}.folded #adminmenu li.toplevel_page_site-card a{padding-right:0}@media only screen and (max-width:960px){#adminmenu,#adminmenuback,#adminmenuwrap{width:272px}.auto-fold #adminmenu a[class*=toplevel_page_http].wp-first-item,.wp-responsive-open #adminmenu a.menu-top{height:auto}.auto-fold #adminmenu div.wp-menu-image{width:36px}}@media screen and (min-width:782px) and (max-width:960px){.auto-fold #adminmenu a.menu-top{height:34px}.auto-fold #adminmenu li.toplevel_page_site-card a{height:36px;padding-right:1px}}@media screen and (max-width:782px){#adminmenu li.menu-top .wp-submenu>li>a,.auto-fold #adminmenu li.menu-top .wp-submenu>li>a{padding-right:42px}.wp-responsive-open #wpbody{left:inherit}.wp-responsive-open #wpcontent{margin-right:272px}.auto-fold #adminmenu,.auto-fold #adminmenuback,.auto-fold #adminmenuwrap{width:272px}#adminmenu a.site-switcher,.auto-fold #adminmenu a.site-switcher{font-size:14px}}@media only screen and (max-width:660px){#adminmenu,#adminmenu .wp-submenu,#adminmenuback,#adminmenuwrap,.auto-fold #adminmenu,.auto-fold #adminmenuback,.auto-fold #adminmenuwrap{width:100%;z-index:171}.wp-responsive-open #wpcontent{margin-right:0}.auto-fold ul#adminmenu li:hover a.wp-has-current-submenu:after,ul#adminmenu a.wp-has-current-submenu:after,ul#adminmenu li:hover a.wp-has-current-submenu:after,ul#adminmenu>li.current>a.current:after{display:none}.auto-fold #adminmenu li.toplevel_page_site-card a{padding:18px 12px 18px 0}}#view-link-wrap{float:right;margin:0 6px 0 0}.screen-options-tab__wrapper{position:relative}.screen-options-tab__dropdown{background-color:#fff;border:1px solid var(--color-neutral-5);border-radius:4px;box-shadow:0 4px 10px rgba(0,0,0,.102);left:20px;padding:3px;position:absolute;top:37px;width:215px;z-index:9999}@media screen and (max-width:782px){.screen-options-tab__dropdown{left:10px;top:47px}}@media screen and (max-width:600px){.screen-options-tab__dropdown{top:93px}}.screen-switcher:not(:hover) .screen-switcher__button:nth-child(2)>strong{color:var(--wp-admin-theme-color)}.screen-switcher__button,a.screen-switcher__button{background:transparent;border:1px solid transparent;border-radius:4px;color:var(--color-text);cursor:pointer;display:inline-block;font-size:.75rem;line-height:normal;padding:8px;text-align:right;text-decoration:none}.screen-switcher__button:nth-child(2),a.screen-switcher__button:nth-child(2){border-color:var(--wp-admin-theme-color);margin-bottom:4px}.screen-switcher__button:last-child,a.screen-switcher__button:last-child{margin-bottom:0}.screen-switcher__button strong,a.screen-switcher__button strong{display:block;font-size:13px;margin-bottom:4px}.screen-switcher__button:focus>strong,.screen-switcher__button:hover>strong,a.screen-switcher__button:focus>strong,a.screen-switcher__button:hover>strong{color:var(--wp-admin-theme-color)}#adminmenu{display:flex;flex-direction:column}#adminmenu .menu-top[class*="/start?ref=calypso-sidebar"]{order:99999}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"]{padding:8px;width:auto}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a{-webkit-appearance:none;appearance:none;background:transparent;border-color:var(--transparent-button-text-color,currentcolor);border-radius:2px;border-style:solid;border-width:1px;box-sizing:border-box;cursor:pointer;display:flex;font-size:14px;justify-content:center;line-height:22px;margin:0;outline:0;overflow:hidden;padding:8px 14px;text-align:center;text-decoration:none;text-overflow:ellipsis;vertical-align:top}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a:hover{box-shadow:none}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-name{padding:0}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-image{display:none}admin-menu.css                                                                                                                                                                                                                                                 10709         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #adminmenu {
	margin: 0;
}

/**
 * Menu width
 */
#wpcontent,
#wpfooter {
	margin-left: 272px;
}

#adminmenuback,
#adminmenuwrap,
#adminmenu,
#adminmenu .wp-submenu {
	width: 272px;
}

#adminmenu .wp-submenu {
	left: 272px;
}

#adminmenu .wp-not-current-submenu .wp-submenu,
.folded #adminmenu .wp-has-current-submenu .wp-submenu {
	min-width: 272px;
}

/**
 * Fixes Gutenberg in not fullscreen mode.
 */
 @media (min-width: 783px) {
	.interface-interface-skeleton,
	.edit-post-layout .components-editor-notices__snackbar {
		left: 272px;
	}
}

@media (min-width: 961px) {
	body:not(.folded).auto-fold .interface-interface-skeleton,
	.auto-fold .edit-post-layout .components-editor-notices__snackbar,
	.components-snackbar-list.edit-widgets-notices__snackbar,
	.jp-dialogue-modern-full__container {
		left: 272px;
	}

	.global-notices {
		max-width: calc( 100% - 48px - 272px );
	}
}

/**
 * Jetpack logo
 */
#adminmenu [class*="activity-log"] .wp-menu-image img {
	padding-top: 7px;
}

/**
 * Site Card
 */
#adminmenu .toplevel_page_site-card .wp-menu-name {
	margin-left: 40px; /* icon width (32) + padding (8). */
	padding: 0;
}

#adminmenu li.toplevel_page_site-card a {
	padding: 10px 0 10px 8px;
}

/**
 * Site Notices
 */
#adminmenu a.toplevel_page_site-notices:hover,
#adminmenu a.toplevel_page_site-notices:focus,
#adminmenu li.toplevel_page_site-notices:hover,
#adminmenu li.toplevel_page_site-notices:focus {
	background-color: inherit !important;
	color: inherit !important;
}

#adminmenu li.toplevel_page_site-notices .wp-menu-image {
	display: none;
}

#adminmenu .toplevel_page_site-notices .wp-menu-image {
	border-radius: 2px;
	background-color: #fff;
}

#adminmenu .toplevel_page_site-notices .wp-menu-image:before {
	content: '\f534';
	font-family: 'dashicons';
	font-size: 20px;
	line-height: 20px;
	background-color: #a7aaad;
	color: white;
	border-radius: 50%;
	margin: 5px;
	padding: 0;
}

#adminmenu .toplevel_page_site-notices:hover .wp-menu-image:before {
	color: #fff;
}

#adminmenu .toplevel_page_site-notices .upsell_banner {
	display: flex;
	flex-grow: 1;
	flex-wrap: nowrap;
	align-items: center;
	justify-content: space-between;
	position: relative;
	width: 100%;
	padding: 7px 12px;
	left: -28px;
	border-radius: 2px;
	font-size: 12px;
	line-height: 1.4;
	hyphens: none;
}

#adminmenu .toplevel_page_site-notices .upsell_banner .banner__info {
	margin-right: 12px;
}

#adminmenu .toplevel_page_site-notices .upsell_banner .button {
	font-size: 12px;
	line-height: 12px;
	padding: 0 7px;
	border: 0;
	min-height: 26px;
}

#adminmenu .toplevel_page_site-notices .upsell_banner svg.dismissible-card__close-icon {
	height: 24px;
	width: 24px;
	margin-left: 10px;
}

@media screen and (min-width: 782px) {
	.folded #adminmenu .toplevel_page_site-notices .wp-menu-image {
		display: block;
		width: 30px;
	}

	.folded #adminmenu .toplevel_page_site-notices {
		height: 50px;
		display: flex;
		align-items: center;
		justify-content: center;
	}
}

@media screen and (min-width: 782px) and (max-width: 960px){
	.auto-fold #adminmenu .toplevel_page_site-notices .wp-menu-image {
		display: block;
		width: 30px;
	}

	.auto-fold #adminmenu .toplevel_page_site-notices {
		height: 50px;
		display: flex;
		align-items: center;
		justify-content: center;
	}
}

/* Prevent box-shadow at the top of the sidebar */
#adminmenu .site-switcher:hover,
#adminmenu .toplevel_page_site-card:hover,
#adminmenu .toplevel_page_site-notices:hover {
	box-shadow: none;
}

/**
 * Site icon inline-styles for height and width are defined in set_site_icon_inline_styles
 */
#adminmenu .toplevel_page_site-card .wp-menu-image {
	background-image: none;
	background-position: center;
	background-repeat: no-repeat;
	background-size: 18px 18px;
	transform: translateZ(0);
	transition-property: background-image,background-color;
	transition-duration: .2s;
}

#adminmenu a.toplevel_page_site-card:hover,
#adminmenu li.toplevel_page_site-card:hover {
	background-color: inherit;
}

#adminmenu .toplevel_page_site-card img {
	opacity: initial;
}

#adminmenu .toplevel_page_site-card.has-site-icon img {
	padding: 0;
}

#adminmenu .toplevel_page_site-card:hover div.wp-menu-image,
#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image {
	background-image: url("data:image/svg+xml,%3Csvg class='gridicon gridicons-house' height='24' width='24' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cg%3E%3Cpath fill='%23fff' d='M22 9L12 1 2 9v2h2v10h5v-4c0-1.657 1.343-3 3-3s3 1.343 3 3v4h5V11h2V9z'/%3E%3C/g%3E%3C/svg%3E%0A");
}

#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image {
	background-color: #c3c4c7;
	height: 32px;
	width: 32px;
}

#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image img {
	width: 18px;
	height: 18px;
	padding: 7px;
}

#adminmenu .toplevel_page_site-card:hover div.wp-menu-image img,
#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image img {
	display: none;
}

.site__info .site__title {
	display: block;
	font-size: 14px;
	font-weight: 400;
	line-height: 1.3;
}

.site__info .site__domain {
	display: block;
	max-width: 95%;
	font-size: 12px;
	line-height: 1.4;
	margin-top: 2px;
}

.site__info .site__title,
.site__info .site__domain {
	overflow: hidden;
	white-space: nowrap;
}
.site__info .site__title::after,
.site__info .site__domain::after {
	content: "";
	display: block;
	position: absolute;
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	user-select: none;
	pointer-events: none;
	top: 0;
	bottom: 0;
	right: 0;
	left: auto;
	width: 20%;
	height: auto;
}

.site__info > .site__badge {
	font-size: 12px;
	border-radius: 12px;
	clear: both;
	display: inline-block;
	margin-top: 6px;
	margin-right: 3px;
	padding: 1px 10px;
}

.site__info > .site__badge.site__badge-staging {
	background-color: #f0c930;
	color: #4f3500;
}

/**
 * Inline text in a menu title
 */
.inline-text {
	display: block !important;
	position: absolute;
	right: 20px;
	top: 50%;
	transform: translateY( -50% );
	opacity: 0.8;
}

/**
 * Stats
 */
[class*="toplevel_page_https://wordpress.com/stats/day"] .sidebar-unified__sparkline {
	float: right;
	margin-right: 8px;
}

/**
 * Folded State
 */
.folded #adminmenu a.menu-top {
	height: 31px;
}

.folded #adminmenu li.toplevel_page_site-card a {
	padding-left: 0;
}

/* Auto-folding of the admin menu */
@media only screen and (max-width: 960px) {
	#adminmenu,
	#adminmenuwrap,
	#adminmenuback {
		width: 272px;
	}

	.auto-fold #adminmenu a[class*="toplevel_page_http"].wp-first-item {
		height: auto;
	}

	.wp-responsive-open #adminmenu a.menu-top {
		height: auto;
	}

	.auto-fold #adminmenu div.wp-menu-image {
		width: 36px;
	}
}

@media screen and (min-width: 782px) and (max-width: 960px) {
	.auto-fold #adminmenu a.menu-top {
		height: 34px;
	}

	.auto-fold #adminmenu li.toplevel_page_site-card a {
		height: 36px;
		padding-left: 1px;
	}
}

@media screen and (max-width: 782px) {
	#adminmenu li.menu-top .wp-submenu>li>a,
	.auto-fold #adminmenu li.menu-top .wp-submenu>li>a {
		padding-left: 42px;
	}

	.wp-responsive-open #wpbody {
		right: inherit;
	}

	.wp-responsive-open #wpcontent {
		margin-left: 272px;
	}

	.auto-fold #adminmenu, .auto-fold #adminmenuback, .auto-fold #adminmenuwrap {
		width: 272px;
	}

	.auto-fold #adminmenu a.site-switcher,
	#adminmenu a.site-switcher {
		font-size: 14px;
	}
}

@media only screen and (max-width: 660px) {
	#adminmenuback,
	#adminmenuwrap,
	#adminmenu,
	#adminmenu .wp-submenu,
	.auto-fold #adminmenu,
	.auto-fold #adminmenuback,
	.auto-fold #adminmenuwrap {
		width: 100%;
		z-index: 171;
	}

	.wp-responsive-open #wpcontent {
		margin-left: 0;
	}

	ul#adminmenu a.wp-has-current-submenu:after,
	ul#adminmenu>li.current>a.current:after,
	ul#adminmenu li:hover a.wp-has-current-submenu:after,
	.auto-fold ul#adminmenu li:hover a.wp-has-current-submenu:after {
		display: none;
	}

	.auto-fold #adminmenu li.toplevel_page_site-card a {
		padding: 18px 0 18px 12px;
	}
}

/* Dashboard Switcher */
#view-link-wrap {
	float: left;
	margin: 0 0 0 6px;
}

.screen-options-tab__wrapper {
	position:relative
}

.screen-options-tab__dropdown {
	background-color: #fff;
	border: 1px solid var(--color-neutral-5);
	border-radius: 4px;
	box-shadow: 0 4px 10px #0000001a;
	padding: 3px;
	position: absolute;
	right: 20px;
	top: 37px;
	width:215px;
	z-index: 9999;
}

@media screen and  (max-width: 782px) {
	.screen-options-tab__dropdown {
		right: 10px;
		top: 47px;
	}
}

@media screen and  (max-width: 600px) {
	.screen-options-tab__dropdown {
		top: 93px;
	}
}

.screen-switcher:not(:hover) .screen-switcher__button:nth-child(2) > strong {
	color:var(--wp-admin-theme-color)
}

.screen-switcher__button, a.screen-switcher__button {
	background: transparent;
	border: 1px solid #0000;
	border-radius: 4px;
	color: var(--color-text);
	cursor: pointer;
	display: inline-block;
	font-size: .75rem;
	line-height: normal;
	text-decoration: none;
	padding: 8px;
	text-align:left
}

.screen-switcher__button:nth-child(2), a.screen-switcher__button:nth-child(2) {
	border-color: var(--wp-admin-theme-color);
	margin-bottom:4px
}

.screen-switcher__button:last-child, a.screen-switcher__button:last-child {
	margin-bottom:0
}

.screen-switcher__button strong, a.screen-switcher__button strong {
	display: block;
	font-size: 13px;
	margin-bottom:4px
}

.screen-switcher__button:focus > strong, .screen-switcher__button:hover > strong, a.screen-switcher__button:focus > strong, a.screen-switcher__button:hover > strong {
	color:var(--wp-admin-theme-color)
}

/** Add new site button **/
#adminmenu {
	display: flex;
	flex-direction: column;
}
#adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] {
	order: 99999;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] {
	padding: 8px;
	width: auto;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a {
	background: transparent;
	border-color: var(--transparent-button-text-color, currentcolor);
	display: flex;
	justify-content: center;
	margin-top: auto;
	background: transparent;
	border-style: solid;
	border-width: 1px;
	cursor: pointer;
	margin: 0;
	outline: 0;
	overflow: hidden;
	text-align: center;
	text-overflow: ellipsis;
	text-decoration: none;
	vertical-align: top;
	box-sizing: border-box;
	font-size: 14px;
	line-height: 22px;
	border-radius: 2px;
	padding: 8px 14px;
	appearance: none;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a:hover {
	box-shadow: none;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-name {
	padding: 0;
}

body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-image {
	display: none;
}
admin-menu.js                                                                                                                                                                                                                                                  5917          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /* global ajaxurl, jetpackAdminMenu */

( function ( $ ) {
	function init() {
		var adminbar = document.querySelector( '#wpadminbar' );
		var wpwrap = document.querySelector( '#wpwrap' );
		var adminMenu = document.querySelector( '#adminmenu' );
		var dismissClass = 'dismissible-card__close-icon';

		if ( ! adminbar ) {
			return;
		}

		function setAriaExpanded( value ) {
			var anchors = adminbar.querySelectorAll( '#wp-admin-bar-blog a' );
			for ( var i = 0; i < anchors.length; i++ ) {
				anchors[ i ].setAttribute( 'aria-expanded', value );
			}
		}

		setFocusOnActiveMenuItem();
		setAriaExpanded( 'false' );

		var adminbarBlog = adminbar.querySelector( '#wp-admin-bar-blog.my-sites > a' );

		// Toggle sidebar when toggle is clicked.
		if ( adminbarBlog && ! document.body.classList.contains( 'wpcom-admin-interface' ) ) {
			// We need to remove an event listener and attribute from the my sites button to prevent default behavior of the wp-responsive-overlay.
			$( '#wp-admin-bar-blog.my-sites > a' ).off( 'click.wp-responsive' );
			adminbarBlog.removeAttribute( 'aria-haspopup' );
			// Toggle the sidebar when the 'My Sites' button is clicked in a mobile view.
			adminbarBlog.addEventListener( 'click', toggleSidebar );
			// Detect a click outside the sidebar and close it if its open.
			document.addEventListener( 'click', closeSidebarWhenClickedOutside );
		}

		function closeSidebarWhenClickedOutside( event ) {
			const isClickOnToggle = !! event.target.closest( '#wp-admin-bar-blog > a' );
			const isClickInsideMenu = document.getElementById( 'adminmenu' ).contains( event.target );
			const sidebarIsOpen = wpwrap.classList.contains( 'wp-responsive-open' );
			const shouldCloseSidebar = sidebarIsOpen && ! isClickOnToggle && ! isClickInsideMenu;
			if ( shouldCloseSidebar ) {
				toggleSidebar( event );
			}
		}

		function toggleSidebar( event ) {
			// Prevent the menu toggle from being triggered when the screen is not in mobile view.
			// This allows the toggle to function as a link to the site's dashboard the same way it works in Calypso.
			if ( $( window ).width() > 782 ) {
				event.stopImmediatePropagation(); // Prevent propagation to conflicting event handlers.
				return true;
			}

			event.preventDefault();

			// Remove event handlers from the original toggle as its hidden and conflicts with the new toggle.
			$( '#wp-admin-bar-menu-toggle' ).off( 'click.wp-responsive' );

			// Close any open toolbar submenus.
			var hovers = adminbar.querySelectorAll( '.hover' );

			const hoverLength = hovers.length;
			for ( var i = 0; i < hoverLength; i++ ) {
				hovers[ i ].classList.remove( 'hover' );
			}
			wpwrap.classList.toggle( 'wp-responsive-open' );
			if ( wpwrap.classList.contains( 'wp-responsive-open' ) ) {
				setAriaExpanded( 'true' );
				var first = document.querySelector( '#adminmenu a' );
				if ( first ) {
					first.focus();
				}
			} else {
				setAriaExpanded( 'false' );
			}
		}

		if ( adminMenu ) {
			var collapseButton = adminMenu.querySelector( '#collapse-button' );
			// Nav-Unification feature:
			// Saves the sidebar state in server when "Collapse menu" is clicked.
			// This is needed so that we update WPCOM for this preference in real-time.
			if ( collapseButton ) {
				collapseButton.addEventListener( 'click', function ( event ) {
					// Let's the core event listener be triggered first.
					setTimeout( function () {
						saveSidebarIsExpanded( event.target.parentNode.getAttribute( 'aria-expanded' ) );
					}, 50 );
				} );
			}

			adminMenu.addEventListener( 'click', function ( event ) {
				if (
					event.target.classList.contains( dismissClass ) ||
					event.target.closest( '.' + dismissClass )
				) {
					event.preventDefault();

					const siteNotice = document.getElementById( 'toplevel_page_site-notices' );
					if ( siteNotice ) {
						siteNotice.style.display = 'none';
					}

					const jitmDismissButton = event.target;

					makeAjaxRequest(
						'POST',
						ajaxurl,
						'application/x-www-form-urlencoded; charset=UTF-8',
						'id=' +
							encodeURIComponent( jitmDismissButton.dataset.feature_id ) +
							'&feature_class=' +
							encodeURIComponent( jitmDismissButton.dataset.feature_class ) +
							'&action=jitm_dismiss' +
							'&_ajax_nonce=' +
							jetpackAdminMenu.jitmDismissNonce
					);
				}
			} );

			makeAjaxRequest(
				'GET',
				ajaxurl + '?action=upsell_nudge_jitm&_ajax_nonce=' + jetpackAdminMenu.upsellNudgeJitm,
				undefined,
				null,
				function ( xhr ) {
					try {
						if ( xhr.readyState === XMLHttpRequest.DONE ) {
							if ( xhr.status === 200 && xhr.responseText ) {
								adminMenu
									.querySelector( '#toplevel_page_site_card' )
									.insertAdjacentHTML( 'afterend', xhr.responseText );
							}
						}
					} catch ( error ) {
						// On failure, we just won't display an upsell nudge
					}
				}
			);
		}
	}

	function makeAjaxRequest( method, url, contentType, body = null, callback = null ) {
		var xhr = new XMLHttpRequest();
		xhr.open( method, url, true );
		xhr.setRequestHeader( 'X-Requested-With', 'XMLHttpRequest' );
		if ( contentType ) {
			xhr.setRequestHeader( 'Content-Type', contentType );
		}
		xhr.withCredentials = true;
		if ( callback ) {
			xhr.onreadystatechange = function () {
				callback( xhr );
			};
		}
		xhr.send( body );
	}

	function saveSidebarIsExpanded( expanded ) {
		makeAjaxRequest(
			'POST',
			ajaxurl,
			'application/x-www-form-urlencoded; charset=UTF-8',
			'action=sidebar_state&expanded=' + expanded
		);
	}

	function setFocusOnActiveMenuItem() {
		var currentMenuItem = document.querySelector( '.wp-submenu .current > a' );

		if ( ! currentMenuItem ) {
			return;
		}

		currentMenuItem.focus( { preventScroll: true } );
	}

	if ( document.readyState === 'loading' ) {
		document.addEventListener( 'DOMContentLoaded', init );
	} else {
		init();
	}
} )( jQuery );
admin-menu.min.css                                                                                                                                                                                                                                             8963          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #adminmenu{margin:0}#wpcontent,#wpfooter{margin-left:272px}#adminmenu,#adminmenu .wp-submenu,#adminmenuback,#adminmenuwrap{width:272px}#adminmenu .wp-submenu{left:272px}#adminmenu .wp-not-current-submenu .wp-submenu,.folded #adminmenu .wp-has-current-submenu .wp-submenu{min-width:272px}@media (min-width:783px){.edit-post-layout .components-editor-notices__snackbar,.interface-interface-skeleton{left:272px}}@media (min-width:961px){.auto-fold .edit-post-layout .components-editor-notices__snackbar,.components-snackbar-list.edit-widgets-notices__snackbar,.jp-dialogue-modern-full__container,body:not(.folded).auto-fold .interface-interface-skeleton{left:272px}.global-notices{max-width:calc(100% - 320px)}}#adminmenu [class*=activity-log] .wp-menu-image img{padding-top:7px}#adminmenu .toplevel_page_site-card .wp-menu-name{margin-left:40px;padding:0}#adminmenu li.toplevel_page_site-card a{padding:10px 0 10px 8px}#adminmenu a.toplevel_page_site-notices:focus,#adminmenu a.toplevel_page_site-notices:hover,#adminmenu li.toplevel_page_site-notices:focus,#adminmenu li.toplevel_page_site-notices:hover{background-color:inherit!important;color:inherit!important}#adminmenu li.toplevel_page_site-notices .wp-menu-image{display:none}#adminmenu .toplevel_page_site-notices .wp-menu-image{background-color:#fff;border-radius:2px}#adminmenu .toplevel_page_site-notices .wp-menu-image:before{background-color:#a7aaad;border-radius:50%;color:#fff;content:"\f534";font-family:dashicons;font-size:20px;line-height:20px;margin:5px;padding:0}#adminmenu .toplevel_page_site-notices:hover .wp-menu-image:before{color:#fff}#adminmenu .toplevel_page_site-notices .upsell_banner{align-items:center;border-radius:2px;display:flex;flex-grow:1;flex-wrap:nowrap;font-size:12px;-webkit-hyphens:none;hyphens:none;justify-content:space-between;left:-28px;line-height:1.4;padding:7px 12px;position:relative;width:100%}#adminmenu .toplevel_page_site-notices .upsell_banner .banner__info{margin-right:12px}#adminmenu .toplevel_page_site-notices .upsell_banner .button{border:0;font-size:12px;line-height:12px;min-height:26px;padding:0 7px}#adminmenu .toplevel_page_site-notices .upsell_banner svg.dismissible-card__close-icon{height:24px;margin-left:10px;width:24px}@media screen and (min-width:782px){.folded #adminmenu .toplevel_page_site-notices .wp-menu-image{display:block;width:30px}.folded #adminmenu .toplevel_page_site-notices{align-items:center;display:flex;height:50px;justify-content:center}}@media screen and (min-width:782px) and (max-width:960px){.auto-fold #adminmenu .toplevel_page_site-notices .wp-menu-image{display:block;width:30px}.auto-fold #adminmenu .toplevel_page_site-notices{align-items:center;display:flex;height:50px;justify-content:center}}#adminmenu .site-switcher:hover,#adminmenu .toplevel_page_site-card:hover,#adminmenu .toplevel_page_site-notices:hover{box-shadow:none}#adminmenu .toplevel_page_site-card .wp-menu-image{background-image:none;background-position:50%;background-repeat:no-repeat;background-size:18px 18px;transform:translateZ(0);transition-duration:.2s;transition-property:background-image,background-color}#adminmenu a.toplevel_page_site-card:hover,#adminmenu li.toplevel_page_site-card:hover{background-color:inherit}#adminmenu .toplevel_page_site-card img{opacity:1}#adminmenu .toplevel_page_site-card.has-site-icon img{padding:0}#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image,#adminmenu .toplevel_page_site-card:hover div.wp-menu-image{background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' class='gridicon gridicons-house'%3E%3Cpath fill='%23fff' d='M22 9 12 1 2 9v2h2v10h5v-4a3 3 0 1 1 6 0v4h5V11h2z'/%3E%3C/svg%3E")}#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image{background-color:#c3c4c7;height:32px;width:32px}#adminmenu .toplevel_page_site-card:not(.has-site-icon) .wp-menu-image img{height:18px;padding:7px;width:18px}#adminmenu .toplevel_page_site-card a:focus div.wp-menu-image img,#adminmenu .toplevel_page_site-card:hover div.wp-menu-image img{display:none}.site__info .site__title{display:block;font-size:14px;font-weight:400;line-height:1.3}.site__info .site__domain{display:block;font-size:12px;line-height:1.4;margin-top:2px;max-width:95%}.site__info .site__domain,.site__info .site__title{overflow:hidden;white-space:nowrap}.site__info .site__domain:after,.site__info .site__title:after{content:"";display:block;position:absolute;-webkit-touch-callout:none;bottom:0;height:auto;left:auto;pointer-events:none;right:0;top:0;-webkit-user-select:none;user-select:none;width:20%}.site__info>.site__badge{border-radius:12px;clear:both;display:inline-block;font-size:12px;margin-right:3px;margin-top:6px;padding:1px 10px}.site__info>.site__badge.site__badge-staging{background-color:#f0c930;color:#4f3500}.inline-text{display:block!important;opacity:.8;position:absolute;right:20px;top:50%;transform:translateY(-50%)}[class*="toplevel_page_https://wordpress.com/stats/day"] .sidebar-unified__sparkline{float:right;margin-right:8px}.folded #adminmenu a.menu-top{height:31px}.folded #adminmenu li.toplevel_page_site-card a{padding-left:0}@media only screen and (max-width:960px){#adminmenu,#adminmenuback,#adminmenuwrap{width:272px}.auto-fold #adminmenu a[class*=toplevel_page_http].wp-first-item,.wp-responsive-open #adminmenu a.menu-top{height:auto}.auto-fold #adminmenu div.wp-menu-image{width:36px}}@media screen and (min-width:782px) and (max-width:960px){.auto-fold #adminmenu a.menu-top{height:34px}.auto-fold #adminmenu li.toplevel_page_site-card a{height:36px;padding-left:1px}}@media screen and (max-width:782px){#adminmenu li.menu-top .wp-submenu>li>a,.auto-fold #adminmenu li.menu-top .wp-submenu>li>a{padding-left:42px}.wp-responsive-open #wpbody{right:inherit}.wp-responsive-open #wpcontent{margin-left:272px}.auto-fold #adminmenu,.auto-fold #adminmenuback,.auto-fold #adminmenuwrap{width:272px}#adminmenu a.site-switcher,.auto-fold #adminmenu a.site-switcher{font-size:14px}}@media only screen and (max-width:660px){#adminmenu,#adminmenu .wp-submenu,#adminmenuback,#adminmenuwrap,.auto-fold #adminmenu,.auto-fold #adminmenuback,.auto-fold #adminmenuwrap{width:100%;z-index:171}.wp-responsive-open #wpcontent{margin-left:0}.auto-fold ul#adminmenu li:hover a.wp-has-current-submenu:after,ul#adminmenu a.wp-has-current-submenu:after,ul#adminmenu li:hover a.wp-has-current-submenu:after,ul#adminmenu>li.current>a.current:after{display:none}.auto-fold #adminmenu li.toplevel_page_site-card a{padding:18px 0 18px 12px}}#view-link-wrap{float:left;margin:0 0 0 6px}.screen-options-tab__wrapper{position:relative}.screen-options-tab__dropdown{background-color:#fff;border:1px solid var(--color-neutral-5);border-radius:4px;box-shadow:0 4px 10px rgba(0,0,0,.102);padding:3px;position:absolute;right:20px;top:37px;width:215px;z-index:9999}@media screen and (max-width:782px){.screen-options-tab__dropdown{right:10px;top:47px}}@media screen and (max-width:600px){.screen-options-tab__dropdown{top:93px}}.screen-switcher:not(:hover) .screen-switcher__button:nth-child(2)>strong{color:var(--wp-admin-theme-color)}.screen-switcher__button,a.screen-switcher__button{background:transparent;border:1px solid transparent;border-radius:4px;color:var(--color-text);cursor:pointer;display:inline-block;font-size:.75rem;line-height:normal;padding:8px;text-align:left;text-decoration:none}.screen-switcher__button:nth-child(2),a.screen-switcher__button:nth-child(2){border-color:var(--wp-admin-theme-color);margin-bottom:4px}.screen-switcher__button:last-child,a.screen-switcher__button:last-child{margin-bottom:0}.screen-switcher__button strong,a.screen-switcher__button strong{display:block;font-size:13px;margin-bottom:4px}.screen-switcher__button:focus>strong,.screen-switcher__button:hover>strong,a.screen-switcher__button:focus>strong,a.screen-switcher__button:hover>strong{color:var(--wp-admin-theme-color)}#adminmenu{display:flex;flex-direction:column}#adminmenu .menu-top[class*="/start?ref=calypso-sidebar"]{order:99999}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"]{padding:8px;width:auto}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a{-webkit-appearance:none;appearance:none;background:transparent;border-color:var(--transparent-button-text-color,currentcolor);border-radius:2px;border-style:solid;border-width:1px;box-sizing:border-box;cursor:pointer;display:flex;font-size:14px;justify-content:center;line-height:22px;margin:0;outline:0;overflow:hidden;padding:8px 14px;text-align:center;text-decoration:none;text-overflow:ellipsis;vertical-align:top}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a:hover{box-shadow:none}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-name{padding:0}body:not(.folded) #adminmenu .menu-top[class*="/start?ref=calypso-sidebar"] a .wp-menu-image{display:none}class-admin-menu.php                                                                                                                                                                                                                                           22018         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Admin Menu file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Assets\Logo;
use Automattic\Jetpack\Redirect;

require_once __DIR__ . '/class-base-admin-menu.php';

/**
 * Class Admin_Menu.
 */
class Admin_Menu extends Base_Admin_Menu {

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		// Remove separators.
		remove_menu_page( 'separator1' );
		$this->add_stats_menu();
		$this->add_upgrades_menu();
		$this->add_posts_menu();
		$this->add_media_menu();
		$this->add_page_menu();
		$this->add_testimonials_menu();
		$this->add_portfolio_menu();
		$this->add_comments_menu();
		$this->add_appearance_menu();
		$this->add_plugins_menu();
		$this->add_users_menu();
		$this->add_tools_menu();
		$this->add_options_menu();
		$this->add_jetpack_menu();

		// Remove Links Manager menu since its usage is discouraged. https://github.com/Automattic/wp-calypso/issues/51188.
		// @see https://core.trac.wordpress.org/ticket/21307#comment:73.
		if ( $this->should_disable_links_manager() ) {
			remove_menu_page( 'link-manager.php' );
		}

		ksort( $GLOBALS['menu'] );
	}

	/**
	 * Get the preferred view for the given screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param bool   $fallback_global_preference (Optional) Whether the global preference for all screens should be used
	 *                                           as fallback if there is no specific preference for the given screen.
	 *                                           Default: true.
	 * @return string
	 */
	public function get_preferred_view( $screen, $fallback_global_preference = true ) {
		$force_default_view = in_array( $screen, array( 'users.php', 'options-general.php' ), true );
		$use_wp_admin       = $this->use_wp_admin_interface();

		// When no preferred view has been set for "Users > All Users" or "Settings > General", keep the previous
		// behavior that forced the default view regardless of the global preference.
		// This behavior is overriden by the wpcom_admin_interface option when it is set to wp-admin.
		if ( ! $use_wp_admin && $fallback_global_preference && $force_default_view ) {
			$preferred_view = parent::get_preferred_view( $screen, false );
			if ( self::UNKNOWN_VIEW === $preferred_view ) {
				return self::DEFAULT_VIEW;
			}
			return $preferred_view;
		}

		return parent::get_preferred_view( $screen, $fallback_global_preference );
	}

	/**
	 * Check if Links Manager is being used.
	 */
	public function should_disable_links_manager() {
		// The max ID number of the auto-generated links.
		// See /wp-content/mu-plugins/wpcom-wp-install-defaults.php in WP.com.
		$max_default_id = 10;

		// We are only checking the latest entry link_id so are limiting the query to 1.
		$link_manager_links = get_bookmarks(
			array(
				'orderby'        => 'link_id',
				'order'          => 'DESC',
				'limit'          => 1,
				'hide_invisible' => 0,
			)
		);

		// Ordered links by ID descending, check if the first ID is more than $max_default_id.
		if ( is_countable( $link_manager_links ) && count( $link_manager_links ) > 0 && $link_manager_links[0]->link_id > $max_default_id ) {
			return false;
		}

		return true;
	}

	/**
	 * Adds My Home menu.
	 */
	public function add_my_home_menu() {

		if ( self::DEFAULT_VIEW !== $this->get_preferred_view( 'index.php' ) ) {
			return;
		}

		$this->update_menu( 'index.php', 'https://wordpress.com/home/' . $this->domain, __( 'My Home', 'jetpack' ), 'read', 'dashicons-admin-home' );
	}

	/**
	 * Adds My Mailboxes menu.
	 */
	public function add_my_mailboxes_menu() {
		add_menu_page( __( 'My Mailboxes', 'jetpack' ), __( 'My Mailboxes', 'jetpack' ), 'manage_options', 'https://wordpress.com/mailboxes/' . $this->domain, null, 'dashicons-email', '4.64424' );
	}

	/**
	 * Adds Stats menu.
	 */
	public function add_stats_menu() {
		add_menu_page( __( 'Stats', 'jetpack' ), __( 'Stats', 'jetpack' ), 'view_stats', 'https://wordpress.com/stats/day/' . $this->domain, null, 'dashicons-chart-bar', 3 );
	}

	/**
	 * Adds Upgrades menu.
	 *
	 * @param string $plan The current WPCOM plan of the blog.
	 */
	public function add_upgrades_menu( $plan = null ) {
		global $menu;

		$menu_exists = false;
		foreach ( $menu as $item ) {
			if ( 'paid-upgrades.php' === $item[2] ) {
				$menu_exists = true;
				break;
			}
		}

		if ( ! $menu_exists ) {
			if ( $plan ) {
				// Add display:none as a default for cases when CSS is not loaded.
				$site_upgrades = '%1$s<span class="inline-text" style="display:none">%2$s</span>';
				$site_upgrades = sprintf(
					$site_upgrades,
					__( 'Upgrades', 'jetpack' ),
					// phpcs:ignore WordPress.WP.I18n.NonSingularStringLiteralText
					__( $plan, 'jetpack' )
				);
			} else {
				$site_upgrades = __( 'Upgrades', 'jetpack' );
			}

			add_menu_page( __( 'Upgrades', 'jetpack' ), $site_upgrades, 'manage_options', 'paid-upgrades.php', null, 'dashicons-cart', 4 );
		}

		add_submenu_page( 'paid-upgrades.php', __( 'Plans', 'jetpack' ), __( 'Plans', 'jetpack' ), 'manage_options', 'https://wordpress.com/plans/' . $this->domain, null, 1 );
		add_submenu_page( 'paid-upgrades.php', __( 'Purchases', 'jetpack' ), __( 'Purchases', 'jetpack' ), 'manage_options', 'https://wordpress.com/purchases/subscriptions/' . $this->domain, null, 2 );

		if ( ! $menu_exists ) {
			// Remove the submenu auto-created by Core.
			$this->hide_submenu_page( 'paid-upgrades.php', 'paid-upgrades.php' );
		}
	}

	/**
	 * Adds Posts menu.
	 */
	public function add_posts_menu() {
		$submenus_to_update = array();

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'edit.php' ) ) {
			$submenus_to_update['edit.php']     = 'https://wordpress.com/posts/' . $this->domain;
			$submenus_to_update['post-new.php'] = 'https://wordpress.com/post/' . $this->domain;
			$this->update_submenus( 'edit.php', $submenus_to_update );
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'edit-tags.php?taxonomy=category' ) ) {
			$this->update_submenus( 'edit.php', array( 'edit-tags.php?taxonomy=category' => 'https://wordpress.com/settings/taxonomies/category/' . $this->domain ) );
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'edit-tags.php?taxonomy=post_tag' ) ) {
			$this->update_submenus( 'edit.php', array( 'edit-tags.php?taxonomy=post_tag' => 'https://wordpress.com/settings/taxonomies/post_tag/' . $this->domain ) );
		}
	}

	/**
	 * Adds Media menu.
	 */
	public function add_media_menu() {
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'upload.php' ) ) {
			return;
		}

		$this->hide_submenu_page( 'upload.php', 'media-new.php' );

		$this->update_menu( 'upload.php', 'https://wordpress.com/media/' . $this->domain );
	}

	/**
	 * Adds Page menu.
	 */
	public function add_page_menu() {
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'edit.php?post_type=page' ) ) {
			return;
		}

		$submenus_to_update = array(
			'edit.php?post_type=page'     => 'https://wordpress.com/pages/' . $this->domain,
			'post-new.php?post_type=page' => 'https://wordpress.com/page/' . $this->domain,
		);
		$this->update_submenus( 'edit.php?post_type=page', $submenus_to_update );
	}

	/**
	 * Adds Testimonials menu.
	 */
	public function add_testimonials_menu() {
		$this->add_custom_post_type_menu( 'jetpack-testimonial' );
	}

	/**
	 * Adds Portfolio menu.
	 */
	public function add_portfolio_menu() {
		$this->add_custom_post_type_menu( 'jetpack-portfolio' );
	}

	/**
	 * Adds a custom post type menu.
	 *
	 * @param string $post_type Custom post type.
	 */
	public function add_custom_post_type_menu( $post_type ) {
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'edit.php?post_type=' . $post_type ) ) {
			return;
		}

		$submenus_to_update = array(
			'edit.php?post_type=' . $post_type     => 'https://wordpress.com/types/' . $post_type . '/' . $this->domain,
			'post-new.php?post_type=' . $post_type => 'https://wordpress.com/edit/' . $post_type . '/' . $this->domain,
		);
		$this->update_submenus( 'edit.php?post_type=' . $post_type, $submenus_to_update );
	}

	/**
	 * Adds Comments menu.
	 */
	public function add_comments_menu() {
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'edit-comments.php' ) ) {
			return;
		}

		$this->update_menu( 'edit-comments.php', 'https://wordpress.com/comments/all/' . $this->domain );
	}

	/**
	 * Adds Appearance menu.
	 *
	 * @return string The Customizer URL.
	 */
	public function add_appearance_menu() {
		$request_uri                     = isset( $_SERVER['REQUEST_URI'] ) ? esc_url_raw( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
		$default_customize_slug          = add_query_arg( 'return', rawurlencode( remove_query_arg( wp_removable_query_args(), $request_uri ) ), 'customize.php' );
		$default_customize_header_slug_1 = add_query_arg( array( 'autofocus' => array( 'control' => 'header_image' ) ), $default_customize_slug );
		// TODO: Remove WPCom_Theme_Customizer::modify_header_menu_links() and WPcom_Custom_Header::modify_admin_menu_links().
		$default_customize_header_slug_2     = admin_url( 'themes.php?page=custom-header' );
		$default_customize_background_slug_1 = add_query_arg( array( 'autofocus' => array( 'control' => 'background_image' ) ), $default_customize_slug );
		// TODO: Remove Colors_Manager::modify_header_menu_links() and Colors_Manager_Common::modify_header_menu_links().
		$default_customize_background_slug_2 = add_query_arg( array( 'autofocus' => array( 'section' => 'colors_manager_tool' ) ), admin_url( 'customize.php' ) );

		if ( $this->is_api_request ) {
			// In case this is an api request we will have to add the 'return' querystring via JS.
			$customize_url = 'customize.php';
		} else {
			$customize_url = $default_customize_slug;
		}

		$submenus_to_update = array(
			$default_customize_slug              => $customize_url,
			$default_customize_header_slug_1     => add_query_arg( array( 'autofocus' => array( 'control' => 'header_image' ) ), $customize_url ),
			$default_customize_header_slug_2     => add_query_arg( array( 'autofocus' => array( 'control' => 'header_image' ) ), $customize_url ),
			$default_customize_background_slug_1 => add_query_arg( array( 'autofocus' => array( 'section' => 'colors_manager_tool' ) ), $customize_url ),
			$default_customize_background_slug_2 => add_query_arg( array( 'autofocus' => array( 'section' => 'colors_manager_tool' ) ), $customize_url ),
		);

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'themes.php' ) || self::CLASSIC_VIEW === $this->get_preferred_view( 'themes.php' ) ) {
			$submenus_to_update['themes.php'] = 'https://wordpress.com/themes/' . $this->domain;
		}

		$this->update_submenus( 'themes.php', $submenus_to_update );

		$this->hide_submenu_page( 'themes.php', 'custom-header' );
		$this->hide_submenu_page( 'themes.php', 'custom-background' );

		return $customize_url;
	}

	/**
	 * Adds Plugins menu.
	 */
	public function add_plugins_menu() {
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'plugins.php' ) ) {
			return;
		}
		$this->hide_submenu_page( 'plugins.php', 'plugin-install.php' );
		$this->hide_submenu_page( 'plugins.php', 'plugin-editor.php' );

		$this->update_menu( 'plugins.php', 'https://wordpress.com/plugins/' . $this->domain );
	}

	/**
	 * Adds Users menu.
	 */
	public function add_users_menu() {
		$submenus_to_update = array(
			'profile.php' => 'https://wordpress.com/me',
		);

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'users.php' ) ) {
			$submenus_to_update['users.php']    = 'https://wordpress.com/people/team/' . $this->domain;
			$submenus_to_update['user-new.php'] = 'https://wordpress.com/people/new/' . $this->domain;
		}

		$slug = current_user_can( 'list_users' ) ? 'users.php' : 'profile.php';
		$this->update_submenus( $slug, $submenus_to_update );
		add_submenu_page( $slug, esc_attr__( 'Account Settings', 'jetpack' ), __( 'Account Settings', 'jetpack' ), 'read', 'https://wordpress.com/me/account' );
	}

	/**
	 * Adds Tools menu.
	 */
	public function add_tools_menu() {
		$submenus_to_update = array();
		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'import.php' ) ) {
			$submenus_to_update['import.php'] = 'https://wordpress.com/import/' . $this->domain;
		}
		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'export.php' ) ) {
			$submenus_to_update['export.php'] = 'https://wordpress.com/export/' . $this->domain;
		}
		$this->update_submenus( 'tools.php', $submenus_to_update );

		$this->hide_submenu_page( 'tools.php', 'tools.php' );
		$this->hide_submenu_page( 'tools.php', 'delete-blog' );

		add_submenu_page( 'tools.php', esc_attr__( 'Marketing', 'jetpack' ), __( 'Marketing', 'jetpack' ), 'publish_posts', 'https://wordpress.com/marketing/tools/' . $this->domain, null, 0 );
		add_submenu_page( 'tools.php', esc_attr__( 'Monetize', 'jetpack' ), __( 'Monetize', 'jetpack' ), 'manage_options', 'https://wordpress.com/earn/' . $this->domain, null, 1 );
	}

	/**
	 * Adds Settings menu.
	 */
	public function add_options_menu() {
		$submenus_to_update = array();

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'options-general.php' ) ) {
			$this->hide_submenu_page( 'options-general.php', 'sharing' );
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'options-general.php' ) ) {
			$submenus_to_update['options-general.php'] = 'https://wordpress.com/settings/general/' . $this->domain;
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'options-writing.php' ) ) {
			$submenus_to_update['options-writing.php'] = 'https://wordpress.com/settings/writing/' . $this->domain;
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'options-reading.php' )
		) {
			$submenus_to_update['options-reading.php'] = 'https://wordpress.com/settings/reading/' . $this->domain;
		}

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'options-discussion.php' ) ) {
			$submenus_to_update['options-discussion.php'] = 'https://wordpress.com/settings/discussion/' . $this->domain;
		}

		$this->update_submenus( 'options-general.php', $submenus_to_update );

		add_submenu_page( 'options-general.php', esc_attr__( 'Newsletter', 'jetpack' ), __( 'Newsletter', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/newsletter/' . $this->domain, null, 7 );
		add_submenu_page( 'options-general.php', esc_attr__( 'Podcasting', 'jetpack' ), __( 'Podcasting', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/podcasting/' . $this->domain, null, 8 );
		add_submenu_page( 'options-general.php', esc_attr__( 'Performance', 'jetpack' ), __( 'Performance', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/performance/' . $this->domain, null, 9 );
	}

	/**
	 * Create Jetpack menu.
	 *
	 * @param int  $position  Menu position.
	 * @param bool $separator Whether to add a separator before the menu.
	 */
	public function create_jetpack_menu( $position = 50, $separator = true ) {
		if ( $separator ) {
			$this->add_admin_menu_separator( $position, 'manage_options' );
			++$position;
		}

		$icon            = ( new Logo() )->get_base64_logo();
		$is_menu_updated = $this->update_menu( 'jetpack', null, null, null, $icon, $position );
		if ( ! $is_menu_updated ) {
			add_menu_page( esc_attr__( 'Jetpack', 'jetpack' ), __( 'Jetpack', 'jetpack' ), 'manage_options', 'jetpack', null, $icon, $position );
		}

		add_submenu_page( 'jetpack', esc_attr__( 'Activity Log', 'jetpack' ), __( 'Activity Log', 'jetpack' ), 'manage_options', 'https://wordpress.com/activity-log/' . $this->domain, null, 2 );
		add_submenu_page( 'jetpack', esc_attr__( 'Backup', 'jetpack' ), __( 'Backup', 'jetpack' ), 'manage_options', 'https://wordpress.com/backup/' . $this->domain, null, 3 );

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'jetpack' ) ) {
			$this->hide_submenu_page( 'jetpack', 'jetpack#/settings' );
			$this->hide_submenu_page( 'jetpack', 'stats' );
			$this->hide_submenu_page( 'jetpack', esc_url( Redirect::get_url( 'calypso-backups' ) ) );
			$this->hide_submenu_page( 'jetpack', esc_url( Redirect::get_url( 'calypso-scanner' ) ) );
		}

		if ( ! $is_menu_updated ) {
			// Remove the submenu auto-created by Core just to be sure that there no issues on non-admin roles.
			remove_submenu_page( 'jetpack', 'jetpack' );
		}
	}

	/**
	 * Adds Jetpack menu.
	 */
	public function add_jetpack_menu() {
		$this->create_jetpack_menu();
	}

	/**
	 * Add the calypso /woocommerce-installation/ menu item.
	 *
	 * @param array $current_plan The site's plan if they have one. This is passed from WPcom_Admin_Menu to prevent
	 * redundant database queries.
	 */
	public function add_woocommerce_installation_menu( $current_plan = null ) {
		/**
		 * Whether to show the WordPress.com WooCommerce Installation menu.
		 *
		 * @use add_filter( 'jetpack_show_wpcom_woocommerce_installation_menu', '__return_true' );
		 * @module masterbar
		 * @since 10.3.0
		 * @param bool $jetpack_show_wpcom_woocommerce_installation_menu Load the WordPress.com WooCommerce Installation menu item. Default to false.
		 * @param array $current_plan Data about the current site's plan.
		 */
		if ( apply_filters( 'jetpack_show_wpcom_woocommerce_installation_menu', false, $current_plan ) ) {
			$this->add_admin_menu_separator( 54, 'activate_plugins' );

			$icon_url = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGZpbGw9IiNhMmFhYjIiIGQ9Ik02MTIuMTkyIDQyNi4zMzZjMC02Ljg5Ni0zLjEzNi01MS42LTI4LTUxLjYtMzcuMzYgMC00Ni43MDQgNzIuMjU2LTQ2LjcwNCA4Mi42MjQgMCAzLjQwOCAzLjE1MiA1OC40OTYgMjguMDMyIDU4LjQ5NiAzNC4xOTItLjAzMiA0Ni42NzItNzIuMjg4IDQ2LjY3Mi04OS41MnptMjAyLjE5MiAwYzAtNi44OTYtMy4xNTItNTEuNi0yOC4wMzItNTEuNi0zNy4yOCAwLTQ2LjYwOCA3Mi4yNTYtNDYuNjA4IDgyLjYyNCAwIDMuNDA4IDMuMDcyIDU4LjQ5NiAyNy45NTIgNTguNDk2IDM0LjE5Mi0uMDMyIDQ2LjY4OC03Mi4yODggNDYuNjg4LTg5LjUyek0xNDEuMjk2Ljc2OGMtNjguMjI0IDAtMTIzLjUwNCA1NS40ODgtMTIzLjUwNCAxMjMuOTJ2NjUwLjcyYzAgNjguNDMyIDU1LjI5NiAxMjMuOTIgMTIzLjUwNCAxMjMuOTJoMzM5LjgwOGwxMjMuNTA0IDEyMy45MzZWODk5LjMyOGgyNzguMDQ4YzY4LjIyNCAwIDEyMy41Mi01NS40NzIgMTIzLjUyLTEyMy45MnYtNjUwLjcyYzAtNjguNDMyLTU1LjI5Ni0xMjMuOTItMTIzLjUyLTEyMy45MmgtNzQxLjM2em01MjYuODY0IDQyMi4xNmMwIDU1LjA4OC0zMS4wODggMTU0Ljg4LTEwMi42NCAxNTQuODgtNi4yMDggMC0xOC40OTYtMy42MTYtMjUuNDI0LTYuMDE2LTMyLjUxMi0xMS4xNjgtNTAuMTkyLTQ5LjY5Ni01Mi4zNTItNjYuMjU2IDAgMC0zLjA3Mi0xNy43OTItMy4wNzItNDAuNzUyIDAtMjIuOTkyIDMuMDcyLTQ1LjMyOCAzLjA3Mi00NS4zMjggMTUuNTUyLTc1LjcyOCA0My41NTItMTA2LjczNiA5Ni40NDgtMTA2LjczNiA1OS4wNzItLjAzMiA4My45NjggNTguNTI4IDgzLjk2OCAxMTAuMjA4ek00ODYuNDk2IDMwMi40YzAgMy4zOTItNDMuNTUyIDE0MS4xNjgtNDMuNTUyIDIxMy40MjR2NzUuNzEyYy0yLjU5MiAxMi4wOC00LjE2IDI0LjE0NC0yMS44MjQgMjQuMTQ0LTQ2LjYwOCAwLTg4Ljg4LTE1MS40NzItOTIuMDE2LTE2MS44NC02LjIwOCA2Ljg5Ni02Mi4yNCAxNjEuODQtOTYuNDQ4IDE2MS44NC0yNC44NjQgMC00My41NTItMTEzLjY0OC00Ni42MDgtMTIzLjkzNkMxNzYuNzA0IDQzNi42NzIgMTYwIDMzNC4yMjQgMTYwIDMyNy4zMjhjMC0yMC42NzIgMS4xNTItMzguNzM2IDI2LjA0OC0zOC43MzYgNi4yMDggMCAyMS42IDYuMDY0IDIzLjcxMiAxNy4xNjggMTEuNjQ4IDYyLjAzMiAxNi42ODggMTIwLjUxMiAyOS4xNjggMTg1Ljk2OCAxLjg1NiAyLjkyOCAxLjUwNCA3LjAwOCA0LjU2IDEwLjQzMiAzLjE1Mi0xMC4yODggNjYuOTI4LTE2OC43ODQgOTQuOTYtMTY4Ljc4NCAyMi41NDQgMCAzMC40IDQ0LjU5MiAzMy41MzYgNjEuODI0IDYuMjA4IDIwLjY1NiAxMy4wODggNTUuMjE2IDIyLjQxNiA4Mi43NTIgMC0xMy43NzYgMTIuNDgtMjAzLjEyIDY1LjM5Mi0yMDMuMTIgMTguNTkyLjAzMiAyNi43MDQgNi45MjggMjYuNzA0IDI3LjU2OHpNODcwLjMyIDQyMi45MjhjMCA1NS4wODgtMzEuMDg4IDE1NC44OC0xMDIuNjQgMTU0Ljg4LTYuMTkyIDAtMTguNDQ4LTMuNjE2LTI1LjQyNC02LjAxNi0zMi40MzItMTEuMTY4LTUwLjE3Ni00OS42OTYtNTIuMjg4LTY2LjI1NiAwIDAtMy44ODgtMTcuOTItMy44ODgtNDAuODk2czMuODg4LTQ1LjE4NCAzLjg4OC00NS4xODRjMTUuNTUyLTc1LjcyOCA0My40ODgtMTA2LjczNiA5Ni4zODQtMTA2LjczNiA1OS4xMDQtLjAzMiA4My45NjggNTguNTI4IDgzLjk2OCAxMTAuMjA4eiIvPjwvc3ZnPg==';
			$menu_url = 'https://wordpress.com/woocommerce-installation/' . $this->domain;

			// Only show the menu if the user has the capability to activate_plugins.
			add_menu_page( esc_attr__( 'WooCommerce', 'jetpack' ), esc_attr__( 'WooCommerce', 'jetpack' ), 'activate_plugins', $menu_url, null, $icon_url, 55 );
		}
	}

	/**
	 * AJAX handler for retrieving the upsell nudge.
	 */
	public function wp_ajax_upsell_nudge_jitm() {
		check_ajax_referer( 'upsell_nudge_jitm' );

		$nudge = $this->get_upsell_nudge();
		if ( ! $nudge ) {
			wp_die();
		}

		$link = $nudge['link'];
		if ( str_starts_with( $link, '/' ) ) {
			$link = 'https://wordpress.com' . $link;
		}
		?>
		<li class="wp-not-current-submenu menu-top menu-icon-generic toplevel_page_site-notices" id="toplevel_page_site-notices">
			<a href="<?php echo esc_url( $link ); ?>" class="wp-not-current-submenu menu-top menu-icon-generic toplevel_page_site-notices">
				<div class="wp-menu-arrow">
					<div></div>
				</div>
				<div class="wp-menu-image dashicons-before dashicons-admin-generic" aria-hidden="true"><br></div>
				<div class="wp-menu-name">
					<div class="upsell_banner">
						<div class="banner__info">
							<div class="banner__title">
								<?php echo wp_kses( $nudge['content'], array() ); ?>
							</div>
						</div>
						<div class="banner__action">
							<button type="button" class="button">
								<?php echo wp_kses( $nudge['cta'], array() ); ?>
							</button>
						</div>
						<?php if ( $nudge['dismissible'] ) : ?>
							<svg xmlns="http://www.w3.org/2000/svg" data-feature_class="<?php echo esc_attr( $nudge['feature_class'] ); ?>" data-feature_id="<?php echo esc_attr( $nudge['id'] ); ?>" viewBox="0 0 24 24" class="gridicon gridicons-cross dismissible-card__close-icon" height="24" width="24"><g><path d="M18.36 19.78L12 13.41l-6.36 6.37-1.42-1.42L10.59 12 4.22 5.64l1.42-1.42L12 10.59l6.36-6.36 1.41 1.41L13.41 12l6.36 6.36z"></path></g></svg>
						<?php endif; ?>
					</div>
				</div>
			</a>
		</li>
		<?php
		wp_die();
	}

	/**
	 * Returns the first available upsell nudge.
	 * Needs to be implemented separately for each child menu class.
	 * Empty by default.
	 *
	 * @return array
	 */
	public function get_upsell_nudge() {
		return array();
	}
}
class-atomic-admin-menu.php                                                                                                                                                                                                                                    20014         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Atomic Admin Menu file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Connection\Client;
use Automattic\Jetpack\Current_Plan as Jetpack_Plan;
use Automattic\Jetpack\Redirect;
use Automattic\Jetpack\Status;

require_once __DIR__ . '/class-admin-menu.php';

/**
 * Class Atomic_Admin_Menu.
 */
class Atomic_Admin_Menu extends Admin_Menu {

	/**
	 * Atomic_Admin_Menu constructor.
	 */
	protected function __construct() {
		parent::__construct();

		add_action( 'wp_enqueue_scripts', array( $this, 'dequeue_scripts' ), 20 );
		add_action( 'admin_enqueue_scripts', array( $this, 'dequeue_scripts' ), 20 );
		add_action( 'wp_ajax_sidebar_state', array( $this, 'ajax_sidebar_state' ) );
		add_action( 'wp_ajax_jitm_dismiss', array( $this, 'wp_ajax_jitm_dismiss' ) );
		add_action( 'wp_ajax_upsell_nudge_jitm', array( $this, 'wp_ajax_upsell_nudge_jitm' ) );

		if ( ! $this->is_api_request ) {
			add_filter( 'submenu_file', array( $this, 'override_the_theme_installer' ), 10, 2 );
		}

		add_action(
			'admin_menu',
			function () {
				remove_action( 'admin_menu', 'gutenberg_menu', 9 );
			},
			0
		);

		// Add notices to the settings pages when there is a Calypso page available.
		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			add_action( 'current_screen', array( $this, 'add_settings_page_notice' ) );
		}
	}

	/**
	 * Dequeues unnecessary scripts.
	 */
	public function dequeue_scripts() {
		wp_dequeue_script( 'a8c_wpcom_masterbar_overrides' ); // Initially loaded in modules/masterbar/masterbar/class-masterbar.php.
	}

	/**
	 * Determines whether the current locale is right-to-left (RTL).
	 *
	 * Performs the check against the current locale set on the WordPress.com's account settings.
	 * See `Masterbar::__construct` in `modules/masterbar/masterbar/class-masterbar.php`.
	 */
	public function is_rtl() {
		return get_user_option( 'jetpack_wpcom_is_rtl' );
	}

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		parent::reregister_menu_items();

		$this->add_my_home_menu();
		$this->remove_gutenberg_menu();

		// We don't need the `My Mailboxes` when the interface is set to wp-admin or the site is a staging site,
		if ( get_option( 'wpcom_admin_interface' ) !== 'wp-admin' && ! get_option( 'wpcom_is_staging_site' ) ) {
			$this->add_my_mailboxes_menu();
		}

		// Not needed outside of wp-admin.
		if ( ! $this->is_api_request ) {
			$this->add_browse_sites_link();
			$this->add_site_card_menu();
			$this->add_new_site_link();
		}

		$this->add_woocommerce_installation_menu();
		ksort( $GLOBALS['menu'] );
	}

	/**
	 * Get the preferred view for the given screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param bool   $fallback_global_preference (Optional) Whether the global preference for all screens should be used
	 *                                           as fallback if there is no specific preference for the given screen.
	 *                                           Default: true.
	 * @return string
	 */
	public function get_preferred_view( $screen, $fallback_global_preference = true ) {

		// Export on Atomic sites are always managed on WP Admin.
		if ( in_array( $screen, array( 'export.php' ), true ) ) {
			return self::CLASSIC_VIEW;
		}

		/**
		 * When Jetpack SSO is disabled, we need to force Calypso because it might create confusion to be redirected to WP-Admin.
		 * Furthermore, because we don't display the quick switcher, users having an WP-Admin interface by default won't be able to go back to the Calyso version.
		 */
		if ( ! \Jetpack::is_module_active( 'sso' ) ) {
			return self::DEFAULT_VIEW;
		}

		return parent::get_preferred_view( $screen, $fallback_global_preference );
	}

	/**
	 * Adds Users menu.
	 */
	public function add_users_menu() {
		$slug = current_user_can( 'list_users' ) ? 'users.php' : 'profile.php';
		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'users.php' ) ) {
			$submenus_to_update = array(
				'users.php' => 'https://wordpress.com/people/team/' . $this->domain,
			);
			$this->update_submenus( $slug, $submenus_to_update );
		}

		add_submenu_page( 'users.php', esc_attr__( 'Subscribers', 'jetpack' ), __( 'Subscribers', 'jetpack' ), 'list_users', 'https://wordpress.com/subscribers/' . $this->domain, null );

		// When the interface is not set to wp-admin, we replace the Profile submenu.
		if ( ! $this->use_wp_admin_interface() ) {
			remove_submenu_page( 'users.php', 'profile.php' );
			add_submenu_page( 'users.php', esc_attr__( 'My Profile', 'jetpack' ), __( 'My Profile', 'jetpack' ), 'read', 'https://wordpress.com/me/', null );
		}

		// Users who can't 'list_users' will see "Profile" menu & "Profile > Account Settings" as submenu.
		add_submenu_page( $slug, esc_attr__( 'Account Settings', 'jetpack' ), __( 'Account Settings', 'jetpack' ), 'read', 'https://wordpress.com/me/account' );
	}

	/**
	 * Adds Plugins menu.
	 */
	public function add_plugins_menu() {

		global $submenu;

		// Calypso plugins screens link.
		$plugins_slug = 'https://wordpress.com/plugins/' . $this->domain;

		// Link to the Marketplace from Plugins > Add New on Atomic sites where the wpcom_admin_interface option is set to wp-admin.
		if ( self::CLASSIC_VIEW === $this->get_preferred_view( 'plugins.php' ) ) {
			$submenus_to_update = array( 'plugin-install.php' => $plugins_slug );
			$this->update_submenus( 'plugins.php', $submenus_to_update );
			return;
		}

		// Link to the Marketplace on sites that can't manage plugins.
		if (
			function_exists( 'wpcom_site_has_feature' ) &&
			! wpcom_site_has_feature( \WPCOM_Features::MANAGE_PLUGINS )
		) {
			add_menu_page( __( 'Plugins', 'jetpack' ), __( 'Plugins', 'jetpack' ), 'manage_options', $plugins_slug, null, 'dashicons-admin-plugins', '65' );
			return;
		}

		if ( ! isset( $submenu['plugins.php'] ) ) {
			return;
		}

		$plugins_submenu = $submenu['plugins.php'];

		// Move "Add New" plugin submenu to the top position.
		foreach ( $plugins_submenu as $submenu_key => $submenu_keys ) {
			if ( 'plugin-install.php' === $submenu_keys[2] ) {
				// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
				$submenu['plugins.php'] = array( $submenu_key => $plugins_submenu[ $submenu_key ] ) + $plugins_submenu;
			}
		}

		$submenus_to_update = array( 'plugin-install.php' => $plugins_slug );

		$this->update_submenus( 'plugins.php', $submenus_to_update );
	}

	/**
	 * Adds the site switcher link if user has more than one site.
	 */
	public function add_browse_sites_link() {
		$site_count = get_user_option( 'wpcom_site_count' );
		if ( ! $site_count || $site_count < 2 ) {
			return;
		}

		// Unnecessary because "My Sites" always links to the Sites page.
		if ( 'wp-admin' === get_option( 'wpcom_admin_interface' ) ) {
			return;
		}

		// Add the menu item.
		add_menu_page( __( 'site-switcher', 'jetpack' ), __( 'Browse sites', 'jetpack' ), 'read', 'https://wordpress.com/sites', null, 'dashicons-arrow-left-alt2', 0 );
		add_filter( 'add_menu_classes', array( $this, 'set_browse_sites_link_class' ) );
	}

	/**
	 * Adds a custom element class for Site Switcher menu item.
	 *
	 * @param array $menu Associative array of administration menu items.
	 *
	 * @return array
	 */
	public function set_browse_sites_link_class( array $menu ) {
		foreach ( $menu as $key => $menu_item ) {
			if ( 'site-switcher' !== $menu_item[3] ) {
				continue;
			}

			$menu[ $key ][4] = add_cssclass( 'site-switcher', $menu_item[4] );
			break;
		}

		return $menu;
	}

	/**
	 * Adds a link to the menu to create a new site.
	 */
	public function add_new_site_link() {
		$site_count = get_user_option( 'wpcom_site_count' );
		if ( $site_count && $site_count > 1 ) {
			return;
		}

		add_menu_page( __( 'Add New Site', 'jetpack' ), __( 'Add New Site', 'jetpack' ), 'read', 'https://wordpress.com/start?ref=calypso-sidebar', null, 'dashicons-plus-alt' );
	}

	/**
	 * Adds site card component.
	 */
	public function add_site_card_menu() {
		$default        = plugins_url( 'globe-icon.svg', __FILE__ );
		$icon           = get_site_icon_url( 32, $default );
		$blog_name      = get_option( 'blogname' ) !== '' ? get_option( 'blogname' ) : $this->domain;
		$is_coming_soon = ( new Status() )->is_coming_soon();

		$badge = '';

		if ( get_option( 'wpcom_is_staging_site' ) ) {
			$badge .= '<span class="site__badge site__badge-staging">' . esc_html__( 'Staging', 'jetpack' ) . '</span>';
		}

		if ( ( function_exists( 'site_is_private' ) && site_is_private() ) || $is_coming_soon ) {
			$badge .= sprintf(
				'<span class="site__badge site__badge-private">%s</span>',
				$is_coming_soon ? esc_html__( 'Coming Soon', 'jetpack' ) : esc_html__( 'Private', 'jetpack' )
			);
		}

		$site_card = '
<div class="site__info">
	<div class="site__title">%1$s</div>
	<div class="site__domain">%2$s</div>
	%3$s
</div>';

		$site_card = sprintf(
			$site_card,
			$blog_name,
			$this->domain,
			$badge
		);

		add_menu_page( 'site-card', $site_card, 'read', get_home_url(), null, $icon, 1 );
		add_filter( 'add_menu_classes', array( $this, 'set_site_card_menu_class' ) );
	}

	/**
	 * Adds a custom element class and id for Site Card's menu item.
	 *
	 * @param array $menu Associative array of administration menu items.
	 *
	 * @return array
	 */
	public function set_site_card_menu_class( array $menu ) {
		foreach ( $menu as $key => $menu_item ) {
			if ( 'site-card' !== $menu_item[3] ) {
				continue;
			}

			$classes = ' toplevel_page_site-card';

			// webclip.png is the default on WoA sites. Anything other than that means we have a custom site icon.
			if ( has_site_icon() && 'https://s0.wp.com/i/webclip.png' !== get_site_icon_url( 512 ) ) {
				$classes .= ' has-site-icon';
			}

			$menu[ $key ][4] = $menu_item[4] . $classes;
			$menu[ $key ][5] = 'toplevel_page_site_card';
			break;
		}

		return $menu;
	}

	/**
	 * Returns the first available upsell nudge.
	 *
	 * @return array
	 */
	public function get_upsell_nudge() {
		$jitm         = \Automattic\Jetpack\JITMS\JITM::get_instance();
		$message_path = 'calypso:sites:sidebar_notice';
		$message      = $jitm->get_messages( $message_path, wp_json_encode( array( 'message_path' => $message_path ) ), false );

		if ( isset( $message[0] ) ) {
			$message = $message[0];
			return array(
				'content'                      => $message->content->message,
				'cta'                          => $message->CTA->message, // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				'link'                         => $message->CTA->link, // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				'tracks_impression_event_name' => $message->tracks->display->name,
				'tracks_impression_cta_name'   => $message->tracks->display->props->cta_name,
				'tracks_click_event_name'      => $message->tracks->click->name,
				'tracks_click_cta_name'        => $message->tracks->click->props->cta_name,
				'dismissible'                  => $message->is_dismissible,
				'feature_class'                => $message->feature_class,
				'id'                           => $message->id,
			);
		}
	}

	/**
	 * Adds Jetpack menu.
	 */
	public function add_jetpack_menu() {
		// This is supposed to be the same as class-admin-menu but with a different position specified for the Jetpack menu.
		if ( 'wp-admin' === get_option( 'wpcom_admin_interface' ) ) {
			parent::create_jetpack_menu( 2, false );
		} else {
			parent::add_jetpack_menu();
		}

		/**
		 * Prevent duplicate menu items that link to Jetpack Backup.
		 * Hide the one that's shown when the standalone backup plugin is not installed, since Jetpack Backup is already included in Atomic sites.
		 *
		 * @see https://github.com/Automattic/jetpack/pull/33955
		 */
		$this->hide_submenu_page( 'jetpack', esc_url( Redirect::get_url( 'calypso-backups' ) ) );
	}

	/**
	 * Adds Stats menu.
	 */
	public function add_stats_menu() {
		$menu_title = __( 'Stats', 'jetpack' );
		if (
			! $this->is_api_request &&
			\Jetpack::is_module_active( 'stats' ) &&
			function_exists( 'stats_get_image_chart_src' )
		) {
			$img_src = esc_attr(
				stats_get_image_chart_src( 'admin-bar-hours-scale-2x', array( 'masterbar' => '' ) )
			);
			$alt     = esc_attr__( 'Hourly views', 'jetpack' );

			$menu_title .= "<img class='sidebar-unified__sparkline' src='$img_src' width='80' height='20' alt='$alt'>";
		}

		add_menu_page( __( 'Stats', 'jetpack' ), $menu_title, 'view_stats', 'https://wordpress.com/stats/day/' . $this->domain, null, 'dashicons-chart-bar', 3 );
	}

	/**
	 * Adds Upgrades menu.
	 *
	 * @param string $plan The current WPCOM plan of the blog.
	 */
	public function add_upgrades_menu( $plan = null ) {

		if ( get_option( 'wpcom_is_staging_site' ) ) {
			return;
		}
		$products = Jetpack_Plan::get();
		if ( array_key_exists( 'product_name_short', $products ) ) {
			$plan = $products['product_name_short'];
		}
		parent::add_upgrades_menu( $plan );

		$last_upgrade_submenu_position = $this->get_submenu_item_count( 'paid-upgrades.php' );

		add_submenu_page( 'paid-upgrades.php', __( 'Domains', 'jetpack' ), __( 'Domains', 'jetpack' ), 'manage_options', 'https://wordpress.com/domains/manage/' . $this->domain, null, $last_upgrade_submenu_position - 1 );

		/**
		 * Whether to show the WordPress.com Emails submenu under the main Upgrades menu.
		 *
		 * @use add_filter( 'jetpack_show_wpcom_upgrades_email_menu', '__return_true' );
		 * @module masterbar
		 *
		 * @since 9.7.0
		 *
		 * @param bool $show_wpcom_upgrades_email_menu Load the WordPress.com Emails submenu item. Default to false.
		 */
		if ( apply_filters( 'jetpack_show_wpcom_upgrades_email_menu', false ) ) {
			add_submenu_page( 'paid-upgrades.php', __( 'Emails', 'jetpack' ), __( 'Emails', 'jetpack' ), 'manage_options', 'https://wordpress.com/email/' . $this->domain, null, $last_upgrade_submenu_position );
		}
	}

	/**
	 * Adds Settings menu.
	 */
	public function add_options_menu() {
		parent::add_options_menu();

		if ( Jetpack_Plan::supports( 'security-settings' ) ) {
			add_submenu_page(
				'options-general.php',
				esc_attr__( 'Security', 'jetpack' ),
				__( 'Security', 'jetpack' ),
				'manage_options',
				'https://wordpress.com/settings/security/' . $this->domain,
				null,
				2
			);
		}

		add_submenu_page( 'options-general.php', esc_attr__( 'Hosting Configuration', 'jetpack' ), __( 'Hosting Configuration', 'jetpack' ), 'manage_options', 'https://wordpress.com/hosting-config/' . $this->domain, null, 11 );

		// Page Optimize is active by default on all Atomic sites and registers a Settings > Performance submenu which
		// would conflict with our own Settings > Performance that links to Calypso, so we hide it it since the Calypso
		// performance settings already have a link to Page Optimize settings page.
		$this->hide_submenu_page( 'options-general.php', 'page-optimize' );

		// Hide Settings > Performance when the interface is set to wp-admin.
		// This is due to these settings are mostly also available in Jetpack > Settings, in the Performance tab.
		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			$this->hide_submenu_page( 'options-general.php', 'https://wordpress.com/settings/performance/' . $this->domain );
		}
	}

	/**
	 * Adds Tools menu entries.
	 */
	public function add_tools_menu() {
		parent::add_tools_menu();

		// Link the Tools menu to Available Tools when the interface is set to wp-admin.
		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			add_submenu_page( 'tools.php', esc_attr__( 'Available Tools', 'jetpack' ), __( 'Available Tools', 'jetpack' ), 'edit_posts', 'tools.php', null, 0 );
		}

		/**
		 * Adds the WordPress.com Site Monitoring submenu under the main Tools menu.
		 */
		add_submenu_page( 'tools.php', esc_attr__( 'Site Monitoring', 'jetpack' ), __( 'Site Monitoring', 'jetpack' ), 'manage_options', 'https://wordpress.com/site-monitoring/' . $this->domain, null, 7 );

		/**
		 * Adds the WordPress.com GitHub Deployments submenu under the main Tools menu.
		 */
		if ( apply_filters( 'jetpack_show_wpcom_github_deployments_menu', false ) ) {
			add_submenu_page( 'tools.php', esc_attr__( 'GitHub Deployments', 'jetpack' ), __( 'GitHub Deployments', 'jetpack' ), 'manage_options', 'https://wordpress.com/github-deployments/' . $this->domain, null, 7 );
		}
	}

	/**
	 * Override the global submenu_file for theme-install.php page so the WP Admin menu item gets highlighted correctly.
	 *
	 * @param string $submenu_file The current pages $submenu_file global variable value.
	 * @return string | null
	 */
	public function override_the_theme_installer( $submenu_file ) {
		global $pagenow;

		if ( 'themes.php' === $submenu_file && 'theme-install.php' === $pagenow ) {
			return null;
		}
		return $submenu_file;
	}

	/**
	 * Also remove the Gutenberg plugin menu.
	 */
	public function remove_gutenberg_menu() {
		// Always remove the Gutenberg menu.
		remove_menu_page( 'gutenberg' );
	}

	/**
	 * Saves the sidebar state ( expanded / collapsed ) via an ajax request.
	 */
	public function ajax_sidebar_state() {
		$expanded = isset( $_REQUEST['expanded'] ) ? filter_var( wp_unslash( $_REQUEST['expanded'] ), FILTER_VALIDATE_BOOLEAN ) : false; // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		Client::wpcom_json_api_request_as_user(
			'/me/preferences',
			'2',
			array(
				'method' => 'POST',
			),
			(object) array( 'calypso_preferences' => (object) array( 'sidebarCollapsed' => ! $expanded ) ),
			'wpcom'
		);

		wp_die();
	}

	/**
	 * Handle ajax requests to dismiss a just-in-time-message
	 */
	public function wp_ajax_jitm_dismiss() {
		check_ajax_referer( 'jitm_dismiss' );
		$jitm = \Automattic\Jetpack\JITMS\JITM::get_instance();
		if ( isset( $_REQUEST['id'] ) && isset( $_REQUEST['feature_class'] ) ) {
			$jitm->dismiss( sanitize_text_field( wp_unslash( $_REQUEST['id'] ) ), sanitize_text_field( wp_unslash( $_REQUEST['feature_class'] ) ) );
		}
		wp_die();
	}

	/**
	 * Adds a notice above each settings page while using the Classic view to indicate
	 * that the Default view offers more features. Links to the default view.
	 *
	 * @return void
	 */
	public function add_settings_page_notice() {
		if ( ! is_admin() ) {
			return;
		}

		$current_screen = get_current_screen();

		if ( ! $current_screen instanceof \WP_Screen ) {
			return;
		}

		// Show the notice for the following screens and map them to the Calypso page.
		$screen_map = array(
			'options-general' => 'general',
			'options-reading' => 'reading',
		);

		$mapped_screen = isset( $screen_map[ $current_screen->id ] )
			? $screen_map[ $current_screen->id ]
			: false;

		if ( ! $mapped_screen ) {
			return;
		}

		$switch_url = sprintf( 'https://wordpress.com/settings/%s/%s', $mapped_screen, $this->domain );

		// Close over the $switch_url variable.
		$admin_notices = function () use ( $switch_url ) {
			// translators: %s is a link to the Calypso settings page.
			$notice = __( 'You are currently using the Classic view, which doesn\'t offer the same set of features as the Default view. To access additional settings and features, <a href="%s">switch to the Default view</a>. ', 'jetpack' );
			?>
			<div class="notice notice-warning">
				<p><?php echo wp_kses( sprintf( $notice, esc_url( $switch_url ) ), array( 'a' => array( 'href' => array() ) ) ); ?></p>
			</div>
			<?php
		};

		add_action( 'admin_notices', $admin_notices );
	}

	/**
	 * Adds Appearance menu.
	 */
	public function add_appearance_menu() {
		// When the interface is set to wp-admin, we need to add a link to the Marketplace and rest of the menu keeps like core.
		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			add_submenu_page( 'themes.php', esc_attr__( 'Theme Showcase', 'jetpack' ), __( 'Theme Showcase', 'jetpack' ), 'read', 'https://wordpress.com/themes/' . $this->domain );
		} else {
			parent::add_appearance_menu();
		}
	}
}
class-base-admin-menu.php                                                                                                                                                                                                                                      25054         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Base Admin Menu file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Status;

/**
 * Class Base_Admin_Menu
 */
abstract class Base_Admin_Menu {
	/**
	 * Holds class instances.
	 *
	 * @var array
	 */
	protected static $instances;

	/**
	 * Whether the current request is a REST API request.
	 *
	 * @var bool
	 */
	protected $is_api_request = false;

	/**
	 * Domain of the current site.
	 *
	 * @var string
	 */
	protected $domain;

	/**
	 * The CSS classes used to hide the submenu items in navigation.
	 *
	 * @var string
	 */
	const HIDE_CSS_CLASS = 'hide-if-js';

	/**
	 * Identifier denoting that the default WordPress.com view should be used for a certain screen.
	 *
	 * @var string
	 */
	const DEFAULT_VIEW = 'default';

	/**
	 * Identifier denoting that the classic WP Admin view should be used for a certain screen.
	 *
	 * @var string
	 */
	const CLASSIC_VIEW = 'classic';

	/**
	 * Identifier denoting no preferred view has been set for a certain screen.
	 *
	 * @var string
	 */
	const UNKNOWN_VIEW = 'unknown';

	/**
	 * Base_Admin_Menu constructor.
	 */
	protected function __construct() {
		$this->is_api_request = defined( 'REST_REQUEST' ) && REST_REQUEST || isset( $_SERVER['REQUEST_URI'] ) && str_starts_with( filter_var( wp_unslash( $_SERVER['REQUEST_URI'] ) ), '/?rest_route=%2Fwpcom%2Fv2%2Fadmin-menu' );
		$this->domain         = ( new Status() )->get_site_suffix();

		add_action( 'admin_menu', array( $this, 'reregister_menu_items' ), 99998 );
		add_action( 'admin_menu', array( $this, 'hide_parent_of_hidden_submenus' ), 99999 );

		if ( ! $this->is_api_request ) {
			add_filter( 'admin_menu', array( $this, 'override_svg_icons' ), 99999 );
			add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_scripts' ), 11 );
			add_action( 'admin_head', array( $this, 'set_site_icon_inline_styles' ) );
			add_action( 'in_admin_header', array( $this, 'add_dashboard_switcher' ) );
			add_action( 'admin_footer', array( $this, 'dashboard_switcher_scripts' ) );
			add_action( 'admin_menu', array( $this, 'handle_preferred_view' ), 99997 );
			add_filter( 'admin_body_class', array( $this, 'admin_body_class' ) );

			// Do not inject core mobile toggle when the user wants to use the WP Admin interface.
			if ( ! $this->use_wp_admin_interface() ) {
				add_action( 'adminmenu', array( $this, 'inject_core_mobile_toggle' ) );
			}
		}
	}

	/**
	 * Returns class instance.
	 *
	 * @return Admin_Menu
	 */
	public static function get_instance() {
		$class = static::class;

		if ( empty( static::$instances[ $class ] ) ) {
			static::$instances[ $class ] = new $class();
		}

		return static::$instances[ $class ];
	}

	/**
	 * Updates the menu data of the given menu slug.
	 *
	 * @param string $slug Slug of the menu to update.
	 * @param string $url New menu URL.
	 * @param string $title New menu title.
	 * @param string $cap New menu capability.
	 * @param string $icon New menu icon.
	 * @param int    $position New menu position.
	 * @return bool Whether the menu has been updated.
	 */
	public function update_menu( $slug, $url = null, $title = null, $cap = null, $icon = null, $position = null ) {
		global $menu, $submenu;

		$menu_item     = null;
		$menu_position = null;

		foreach ( $menu as $i => $item ) {
			if ( $slug === $item[2] ) {
				$menu_item     = $item;
				$menu_position = $i;
				break;
			}
		}

		if ( ! $menu_item ) {
			return false;
		}

		if ( $title ) {
			$menu_item[0] = $title;
			$menu_item[3] = esc_attr( $title );
		}

		if ( $cap ) {
			$menu_item[1] = $cap;
		}

		// Change parent slug only if there are no submenus (the slug of the 1st submenu will be used if there are submenus).
		if ( $url ) {
			$this->hide_submenu_page( $slug, $slug );

			if ( ! isset( $submenu[ $slug ] ) || ! $this->has_visible_items( $submenu[ $slug ] ) ) {
				$menu_item[2] = $url;
			}
		}

		if ( $icon ) {
			$menu_item[4] = 'menu-top';
			$menu_item[6] = $icon;
		}

		// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		unset( $menu[ $menu_position ] );
		if ( $position ) {
			$menu_position = $position;
		}
		$this->set_menu_item( $menu_item, $menu_position );

		// Only add submenu when there are other submenu items.
		if ( $url && isset( $submenu[ $slug ] ) && $this->has_visible_items( $submenu[ $slug ] ) ) {
			add_submenu_page( $slug, $menu_item[3], $menu_item[0], $menu_item[1], $url, null, 0 );
		}

		return true;
	}

	/**
	 * Updates the submenus of the given menu slug.
	 *
	 * It hides the menu by adding the `hide-if-js` css class and duplicates the submenu with the new slug.
	 *
	 * @param string $slug Menu slug.
	 * @param array  $submenus_to_update Array of new submenu slugs.
	 */
	public function update_submenus( $slug, $submenus_to_update ) {
		global $submenu;

		if ( ! isset( $submenu[ $slug ] ) ) {
			return;
		}

		// This is needed for cases when the submenus to update have the same new slug.
		$submenus_to_update = array_filter(
			$submenus_to_update,
			static function ( $item, $old_slug ) {
				return $item !== $old_slug;
			},
			ARRAY_FILTER_USE_BOTH
		);

		/**
		 * Iterate over all submenu items and add the hide the submenus with CSS classes.
		 * This is done separately of the second foreach because the position of the submenu might change.
		 */
		foreach ( $submenu[ $slug ] as $index => $item ) {
			if ( ! array_key_exists( $item[2], $submenus_to_update ) ) {
				continue;
			}

			$this->hide_submenu_element( $index, $slug, $item );
		}

		$submenu_items = array_values( $submenu[ $slug ] );

		/**
		 * Iterate again over the submenu array. We need a copy of the array because add_submenu_page will add new elements
		 * to submenu array that might cause an infinite loop.
		 */
		foreach ( $submenu_items as $i => $submenu_item ) {
			if ( ! array_key_exists( $submenu_item[2], $submenus_to_update ) ) {
				continue;
			}

			add_submenu_page(
				$slug,
				isset( $submenu_item[3] ) ? $submenu_item[3] : '',
				isset( $submenu_item[0] ) ? $submenu_item[0] : '',
				isset( $submenu_item[1] ) ? $submenu_item[1] : 'read',
				$submenus_to_update[ $submenu_item[2] ],
				'',
				0 === $i ? 0 : $i + 1
			);
		}
	}

	/**
	 * Adds a menu separator.
	 *
	 * @param int    $position The position in the menu order this item should appear.
	 * @param string $cap Optional. The capability required for this menu to be displayed to the user.
	 *                         Default: 'read'.
	 */
	public function add_admin_menu_separator( $position = null, $cap = 'read' ) {
		$menu_item = array(
			'',                                  // Menu title (ignored).
			$cap,                                // Required capability.
			wp_unique_id( 'separator-custom-' ), // URL or file (ignored, but must be unique).
			'',                                  // Page title (ignored).
			'wp-menu-separator',                 // CSS class. Identifies this item as a separator.
		);

		$this->set_menu_item( $menu_item, $position );
	}

	/**
	 * Enqueues scripts and styles.
	 */
	public function enqueue_scripts() {
		if ( $this->is_rtl() ) {
			$css_path = 'admin-menu-rtl.css';
		} else {
			$css_path = 'admin-menu.css';
		}

		wp_enqueue_style(
			'jetpack-admin-menu',
			plugins_url( $css_path, __FILE__ ),
			array(),
			JETPACK__VERSION
		);

		wp_style_add_data( 'jetpack-admin-menu', 'rtl', $this->is_rtl() );

		// Load nav unification styles when the user isn't using wp-admin interface style.
		if ( ! $this->use_wp_admin_interface() ) {
			wp_enqueue_style(
				'jetpack-admin-nav-unification',
				plugins_url( 'admin-menu-nav-unification.css', __FILE__ ),
				array(),
				JETPACK__VERSION
			);

			wp_style_add_data( 'jetpack-admin-nav-unification', 'rtl', $this->is_rtl() );
		}

		$this->configure_colors_for_rtl_stylesheets();

		wp_enqueue_script(
			'jetpack-admin-menu',
			plugins_url( 'admin-menu.js', __FILE__ ),
			array(),
			JETPACK__VERSION,
			true
		);

		wp_localize_script(
			'jetpack-admin-menu',
			'jetpackAdminMenu',
			array(
				'upsellNudgeJitm'  => wp_create_nonce( 'upsell_nudge_jitm' ),
				'jitmDismissNonce' => wp_create_nonce( 'jitm_dismiss' ),
			)
		);
	}

	/**
	 * Mark the core colors stylesheets as RTL depending on the value from the environment.
	 * This fixes a core issue where the extra RTL data is not added to the colors stylesheet.
	 * https://core.trac.wordpress.org/ticket/53090
	 */
	public function configure_colors_for_rtl_stylesheets() {
		wp_style_add_data( 'colors', 'rtl', $this->is_rtl() );
	}

	/**
	 * Injects inline-styles for site icon for when third-party plugins remove enqueued stylesheets.
	 * Unable to use wp_add_inline_style as plugins remove styles from all non-standard handles
	 */
	public function set_site_icon_inline_styles() {
		echo '<style>
			#adminmenu .toplevel_page_site-card .wp-menu-image,
			#adminmenu .toplevel_page_site-card .wp-menu-image img {
				height: 32px;
				width: 32px;
			}
		</style>';
	}

	/**
	 * Hide the submenu page based on slug and return the item that was hidden.
	 *
	 * Instead of actually removing the submenu item, a safer approach is to hide it and filter it in the API response.
	 * In this manner we'll avoid breaking third-party plugins depending on items that no longer exist.
	 *
	 * A false|array value is returned to be consistent with remove_submenu_page() function
	 *
	 * @param string $menu_slug The parent menu slug.
	 * @param string $submenu_slug The submenu slug that should be hidden.
	 * @return false|array
	 */
	public function hide_submenu_page( $menu_slug, $submenu_slug ) {
		global $submenu;

		if ( ! isset( $submenu[ $menu_slug ] ) ) {
			return false;
		}

		foreach ( $submenu[ $menu_slug ] as $i => $item ) {
			if ( $submenu_slug !== $item[2] ) {
				continue;
			}

			$this->hide_submenu_element( $i, $menu_slug, $item );

			return $item;
		}

		return false;
	}

	/**
	 * Apply the hide-if-js CSS class to a submenu item.
	 *
	 * @param int    $index The position of a submenu item in the submenu array.
	 * @param string $parent_slug The parent slug.
	 * @param array  $item The submenu item.
	 */
	public function hide_submenu_element( $index, $parent_slug, $item ) {
		global $submenu;

		$css_classes = empty( $item[4] ) ? self::HIDE_CSS_CLASS : $item[4] . ' ' . self::HIDE_CSS_CLASS;

		// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		$submenu [ $parent_slug ][ $index ][4] = $css_classes;
	}

	/**
	 * Check if the menu has submenu items visible
	 *
	 * @param array $submenu_items The submenu items.
	 * @return bool
	 */
	public function has_visible_items( $submenu_items ) {
		$visible_items = array_filter(
			$submenu_items,
			array( $this, 'is_item_visible' )
		);

		return array() !== $visible_items;
	}

	/**
	 * Return the number of existing submenu items under the supplied parent slug.
	 *
	 * @param string $parent_slug The slug of the parent menu.
	 * @return int The number of submenu items under $parent_slug.
	 */
	public function get_submenu_item_count( $parent_slug ) {
		global $submenu;

		if ( empty( $parent_slug ) || empty( $submenu[ $parent_slug ] ) || ! is_array( $submenu[ $parent_slug ] ) ) {
			return 0;
		}

		return count( $submenu[ $parent_slug ] );
	}

	/**
	 * Adds the given menu item in the specified position.
	 *
	 * @param array $item The menu item to add.
	 * @param int   $position The position in the menu order this item should appear.
	 */
	public function set_menu_item( $item, $position = null ) {
		global $menu;

		// Handle position (avoids overwriting menu items already populated in the given position).
		// Inspired by https://core.trac.wordpress.org/browser/trunk/src/wp-admin/menu.php?rev=49837#L160.
		if ( null === $position ) {
			$menu[] = $item; // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		} elseif ( isset( $menu[ "$position" ] ) ) {
			$position            = $position + substr( base_convert( md5( $item[2] . $item[0] ), 16, 10 ), -5 ) * 0.00001;
			$menu[ "$position" ] = $item; // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		} else {
			$menu[ $position ] = $item; // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		}
	}

	/**
	 * Determines whether the current locale is right-to-left (RTL).
	 */
	public function is_rtl() {
		return is_rtl();
	}

	/**
	 * Checks for any SVG icons in the menu, and overrides things so that
	 * we can display the icon in the correct colour for the theme.
	 */
	public function override_svg_icons() {
		global $menu;

		$svg_items = array();
		foreach ( $menu as $idx => $menu_item ) {
			// Menu items that don't have icons, for example separators, have less than 7
			// elements, partly because the 7th is the icon. So, if we have less than 7,
			// let's skip it.
			if ( ! is_countable( $menu_item ) || ( count( $menu_item ) < 7 ) ) {
				continue;
			}

			// If the hookname contain a URL than sanitize it by replacing invalid characters.
			if ( str_contains( $menu_item[5], '://' ) ) {
				$menu_item[5] = preg_replace( '![:/.]+!', '_', $menu_item[5] );
			}

			if ( str_starts_with( $menu_item[6], 'data:image/svg+xml' ) && 'site-card' !== $menu_item[3] ) {
				$svg_items[]   = array(
					'icon' => $menu_item[6],
					'id'   => $menu_item[5],
				);
				$menu_item[4] .= ' menu-svg-icon';
				$menu_item[6]  = 'none';
			}
			// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
			$menu[ $idx ] = $menu_item;
		}
		if ( $svg_items !== array() ) {
			$styles = '.menu-svg-icon .wp-menu-image { background-repeat: no-repeat; background-position: center center } ';
			foreach ( $svg_items as $svg_item ) {
				$styles .= sprintf( '#%s .wp-menu-image { background-image: url( "%s" ) }', $svg_item['id'], $svg_item['icon'] );
			}
			$styles .= '@supports ( mask-image: none ) or ( -webkit-mask-image: none ) { ';
			$styles .= '.menu-svg-icon .wp-menu-image { background-image: none; } ';
			$styles .= '.menu-svg-icon .wp-menu-image::before { background-color: currentColor; ';
			$styles .= 'mask-size: contain; mask-position: center center; mask-repeat: no-repeat; ';
			$styles .= '-webkit-mask-size: contain; -webkit-mask-position: center center; -webkit-mask-repeat: no-repeat; content:"" } ';
			foreach ( $svg_items as $svg_item ) {
				$styles .= sprintf(
					'#%s .wp-menu-image { background-image: none; } #%s .wp-menu-image::before{ mask-image: url( "%s" ); -webkit-mask-image: url( "%s" ) }',
					$svg_item['id'],
					$svg_item['id'],
					$svg_item['icon'],
					$svg_item['icon']
				);
			}
			$styles .= '}';

			wp_register_style( 'svg-menu-overrides', false, array(), '20210331' );
			wp_enqueue_style( 'svg-menu-overrides' );
			wp_add_inline_style( 'svg-menu-overrides', $styles );
		}
	}

	/**
	 * Hide menus that are unauthorized and don't have visible submenus and cases when the menu has the same slug
	 * as the first submenu item.
	 *
	 * This must be done at the end of menu and submenu manipulation in order to avoid performing this check each time
	 * the submenus are altered.
	 */
	public function hide_parent_of_hidden_submenus() {
		global $menu, $submenu;

		$this->sort_hidden_submenus();

		foreach ( $menu as $menu_index => $menu_item ) {
			$has_submenus = isset( $submenu[ $menu_item[2] ] );

			// Skip if the menu doesn't have submenus.
			if ( ! $has_submenus ) {
				continue;
			}

			// If the first submenu item is hidden then we should also hide the parent.
			// Since the submenus are ordered by self::HIDE_CSS_CLASS (hidden submenus should be at the end of the array),
			// we can say that if the first submenu is hidden then we should also hide the menu.
			$first_submenu_item       = array_values( $submenu[ $menu_item[2] ] )[0];
			$is_first_submenu_visible = $this->is_item_visible( $first_submenu_item );

			// if the user does not have access to the menu and the first submenu is hidden, then hide the menu.
			if ( ! current_user_can( $menu_item[1] ) && ! $is_first_submenu_visible ) {
				// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
				$menu[ $menu_index ][4] = self::HIDE_CSS_CLASS;
			}

			// if the menu has the same slug as the first submenu then hide the submenu.
			if ( $menu_item[2] === $first_submenu_item[2] && ! $is_first_submenu_visible ) {
				// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
				$menu[ $menu_index ][4] = self::HIDE_CSS_CLASS;
			}
		}
	}

	/**
	 * Sort the hidden submenus by moving them at the end of the array in order to avoid WP using them as default URLs.
	 *
	 * This operation has to be done at the end of submenu manipulation in order to guarantee that the hidden submenus
	 * are at the end of the array.
	 */
	public function sort_hidden_submenus() {
		global $submenu;

		foreach ( $submenu as $menu_slug => $submenu_items ) {
			foreach ( $submenu_items as $submenu_index => $submenu_item ) {
				if ( $this->is_item_visible( $submenu_item ) ) {
					continue;
				}

				unset( $submenu[ $menu_slug ][ $submenu_index ] );
				// phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
				$submenu[ $menu_slug ][] = $submenu_item;
			}
		}
	}

	/**
	 * Check if the given item is visible or not in the admin menu.
	 *
	 * @param array $item A menu or submenu array.
	 */
	public function is_item_visible( $item ) {
		return ! isset( $item[4] ) || ! str_contains( $item[4], self::HIDE_CSS_CLASS );
	}

	/**
	 * Adds a dashboard switcher to the list of screen meta links of the current page.
	 */
	public function add_dashboard_switcher() {
		$menu_mappings = require __DIR__ . '/menu-mappings.php';
		$screen        = $this->get_current_screen();

		// Let's show the switcher only in screens that we have a Calypso mapping to switch to.
		if ( empty( $menu_mappings[ $screen ] ) ) {
			return;
		}
		?>
		<div id="view-link-wrap" class="hide-if-no-js screen-meta-toggle">
			<button type="button" id="view-link" class="button show-settings" aria-expanded="false"><?php echo esc_html_x( 'View', 'View options to switch between', 'jetpack' ); ?></button>
		</div>
		<div id="view-wrap" class="screen-options-tab__wrapper hide-if-no-js hidden" tabindex="-1">
			<div class="screen-options-tab__dropdown" data-testid="screen-options-dropdown">
				<div class="screen-switcher">
					<a class="screen-switcher__button" href="<?php echo esc_url( add_query_arg( 'preferred-view', 'default' ) ); ?>" data-view="default">
						<strong><?php esc_html_e( 'Default view', 'jetpack' ); ?></strong>
						<?php esc_html_e( 'Our WordPress.com redesign for a better experience.', 'jetpack' ); ?>
					</a>
					<button class="screen-switcher__button"  data-view="classic">
						<strong><?php esc_html_e( 'Classic view', 'jetpack' ); ?></strong>
						<?php esc_html_e( 'The classic WP-Admin WordPress interface.', 'jetpack' ); ?>
					</button>
				</div>
			</div>
		</div>
		<?php
	}

	/**
	 * Adds a script to append the dashboard switcher to screen meta
	 */
	public function dashboard_switcher_scripts() {
		wp_add_inline_script(
			'common',
			"(function( $ ) {
				$( '#view-link-wrap' ).appendTo( '#screen-meta-links' );

				var viewLink = $( '#view-link' );
				var viewWrap = $( '#view-wrap' );

				viewLink.on( 'click', function() {
					viewWrap.toggle();
					viewLink.toggleClass( 'screen-meta-active' );
				} );

				$( document ).on( 'mouseup', function( event ) {
					if ( ! viewLink.is( event.target ) && ! viewWrap.is( event.target ) && viewWrap.has( event.target ).length === 0 ) {
						viewWrap.hide();
						viewLink.removeClass( 'screen-meta-active' );
					}
				});
			})( jQuery );"
		);
	}

	/**
	 * Sets the given view as preferred for the givens screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param string $view Preferred view.
	 */
	public function set_preferred_view( $screen, $view ) {
		$preferred_views            = $this->get_preferred_views();
		$screen                     = str_replace( '?post_type=post', '', $screen );
		$preferred_views[ $screen ] = $view;
		update_user_option( get_current_user_id(), 'jetpack_admin_menu_preferred_views', $preferred_views );
	}

	/**
	 * Get the preferred views for all screens.
	 *
	 * @return array
	 */
	public function get_preferred_views() {
		$preferred_views = get_user_option( 'jetpack_admin_menu_preferred_views' );

		if ( ! $preferred_views ) {
			return array();
		}

		return $preferred_views;
	}

	/**
	 * Get the preferred view for the given screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param bool   $fallback_global_preference (Optional) Whether the global preference for all screens should be used
	 *                                           as fallback if there is no specific preference for the given screen.
	 *                                           Default: true.
	 * @return string
	 */
	public function get_preferred_view( $screen, $fallback_global_preference = true ) {
		$preferred_views = $this->get_preferred_views();

		if ( ! isset( $preferred_views[ $screen ] ) ) {
			if ( ! $fallback_global_preference ) {
				return self::UNKNOWN_VIEW;
			}

			$should_link_to_wp_admin = $this->should_link_to_wp_admin( $screen ) || $this->use_wp_admin_interface();
			return $should_link_to_wp_admin ? self::CLASSIC_VIEW : self::DEFAULT_VIEW;
		}

		return $preferred_views[ $screen ];
	}

	/**
	 * Gets the identifier of the current screen.
	 *
	 * @return string
	 */
	public function get_current_screen() {
		// phpcs:disable WordPress.Security.NonceVerification
		global $pagenow;
		$screen = isset( $_REQUEST['screen'] ) ? sanitize_text_field( wp_unslash( $_REQUEST['screen'] ) ) : $pagenow;
		if ( isset( $_GET['post_type'] ) ) {
			$screen = add_query_arg( 'post_type', sanitize_text_field( wp_unslash( $_GET['post_type'] ) ), $screen );
		}
		if ( isset( $_GET['taxonomy'] ) ) {
			$screen = add_query_arg( 'taxonomy', sanitize_text_field( wp_unslash( $_GET['taxonomy'] ) ), $screen );
		}
		if ( isset( $_GET['page'] ) ) {
			$screen = add_query_arg( 'page', sanitize_text_field( wp_unslash( $_GET['page'] ) ), $screen );
		}
		return $screen;
		// phpcs:enable WordPress.Security.NonceVerification
	}

	/**
	 * Stores the preferred view for the current screen.
	 */
	public function handle_preferred_view() {
		// phpcs:disable WordPress.Security.NonceVerification
		if ( ! isset( $_GET['preferred-view'] ) ) {
			return;
		}

		// phpcs:disable WordPress.Security.NonceVerification
		$preferred_view = sanitize_key( $_GET['preferred-view'] );

		if ( ! in_array( $preferred_view, array( self::DEFAULT_VIEW, self::CLASSIC_VIEW ), true ) ) {
			return;
		}

		$current_screen = $this->get_current_screen();

		$this->set_preferred_view( $current_screen, $preferred_view );

		/**
		 * Dashboard Quick switcher action triggered when a user switches to a different view.
		 *
		 * @module masterbar
		 *
		 * @since 9.9.1
		 *
		 * @param string The current screen of the user.
		 * @param string The preferred view the user selected.
		 */
		\do_action( 'jetpack_dashboard_switcher_changed_view', $current_screen, $preferred_view );

		if ( self::DEFAULT_VIEW === $preferred_view ) {
			// Redirect to default view if that's the newly preferred view.
			$menu_mappings = require __DIR__ . '/menu-mappings.php';
			if ( isset( $menu_mappings[ $current_screen ] ) ) {
				// Using `wp_redirect` intentionally because we're redirecting to Calypso.
				wp_redirect( $menu_mappings[ $current_screen ] . $this->domain ); // phpcs:ignore WordPress.Security.SafeRedirect
				exit;
			}
		} elseif ( self::CLASSIC_VIEW === $preferred_view ) {
			// Removes the `preferred-view` param from the URL to avoid issues with
			// screens that don't expect this param to be present in the URL.
			wp_safe_redirect( remove_query_arg( 'preferred-view' ) );
			exit;
		}
		// phpcs:enable WordPress.Security.NonceVerification
	}

	/**
	 * Adds the necessary CSS class to the admin body class.
	 *
	 * @param string $admin_body_classes Contains all the admin body classes.
	 *
	 * @return string
	 */
	public function admin_body_class( $admin_body_classes ) {
		return " is-nav-unification $admin_body_classes ";
	}

	/**
	 * Whether to use wp-admin pages rather than Calypso.
	 *
	 * Options:
	 * false - Calypso (Default).
	 * true  - wp-admin.
	 *
	 * @return bool
	 */
	public function should_link_to_wp_admin() {
		return get_user_option( 'jetpack_admin_menu_link_destination' );
	}

	/**
	 * Injects the core's mobile toggle for proper positioning of the submenus.
	 *
	 * @see https://core.trac.wordpress.org/ticket/32747
	 *
	 * @return void
	 */
	public function inject_core_mobile_toggle() {
		echo '<span id="wp-admin-bar-menu-toggle" style="display: none!important">';
	}

	/**
	 * Whether the current user has indicated they want to use the wp-admin interface for the given screen.
	 *
	 * @return bool
	 */
	public function use_wp_admin_interface() {
		return 'wp-admin' === get_option( 'wpcom_admin_interface' );
	}

	/**
	 * Create the desired menu output.
	 */
	abstract public function reregister_menu_items();
}
class-dashboard-switcher-tracking.php                                                                                                                                                                                                                          5058          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Quick switcher tracking file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Current_Plan as Jetpack_Plan;
use Automattic\Jetpack\Status\Host;
use Automattic\Jetpack\Terms_Of_Service;
use Automattic\Jetpack\Tracking;

/**
 * Class Dashboard_Switcher_Tracking
 */
class Dashboard_Switcher_Tracking {

	/**
	 * Jetpack Tracking library will prefix the event name with "jetpack_*" automatically.
	 */
	const JETPACK_EVENT_NAME = 'dashboard_quick_switch_link_clicked';

	const WPCOM_EVENT_NAME = 'wpcom_dashboard_quick_switch_link_clicked';
	/**
	 * Jetpack tracking object.
	 *
	 * @var Tracking
	 */
	private $tracking;

	/**
	 * Current site plan.
	 *
	 * @var string
	 */
	private $plan;

	/**
	 * The wpcom_tracks wrapper function.
	 *
	 * @var callable
	 */
	private $wpcom_tracking;

	/**
	 * Dashboard_Switcher_Tracking constructor.
	 *
	 * @param Tracking $tracking       Jetpack tracking object.
	 * @param callable $wpcom_tracking A wrapper over wpcom event record.
	 * @param string   $plan           The current site plan.
	 */
	public function __construct( Tracking $tracking, callable $wpcom_tracking, $plan ) {
		$this->tracking       = $tracking;
		$this->plan           = $plan;
		$this->wpcom_tracking = $wpcom_tracking;
	}

	/**
	 * Create an event for the Quick switcher when the user changes it's preferred view.
	 *
	 * @param string $screen The screen page.
	 * @param string $view   The new preferred view.
	 */
	public function record_switch_event( $screen, $view ) {
		$event_props = array(
			'current_page' => $screen,
			'destination'  => $view,
			'plan'         => $this->plan,
		);

		if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
			$event_props['blog_id'] = get_current_blog_id();

			/**
			 * Callable injected in the constructor with the static::wpcom_tracks_record_event() static method.
			 *
			 * @see wpcom_tracks_record_event A static method from this class that executes the actual WPCOM event record.
			 */
			$wpcom_tracking = $this->wpcom_tracking;
			$wpcom_tracking( $event_props );
		} else {
			$this->record_jetpack_event( $event_props );
		}
	}

	/**
	 * Get the current site plan or 'N/A' when we cannot determine site's plan.
	 *
	 * @todo: This method can be reused as a wrapper over WPCOM and Atomic as way to get site's current plan (display name).
	 *
	 * @return string
	 */
	public static function get_plan() {
		if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
			if ( class_exists( '\WPCOM_Store_API' ) ) {
				// @todo: Maybe introduce a wrapper for this since we are duplicating it from WPCOM_Admin_Menu:253
				$products = \WPCOM_Store_API::get_current_plan( \get_current_blog_id() );
				if ( ! empty( $products['product_slug'] ) ) {
					return $products['product_slug'];
				}
			}

			return 'N/A'; // maybe we should return free or null? At the moment it's safe to return 'N/A' since we use it only for passing it to the event.
		}

		// @todo: Maybe introduce a helper for this since we are duplicating it from Atomic_Admin_Menu:240
		$products = Jetpack_Plan::get();
		if ( ! empty( $products['product_slug'] ) ) {
			return $products['product_slug'];
		}

		return 'N/A'; // maybe we should return free or null? At the moment we use it for passing it to the event.
	}

	/**
	 * Record the event with Jetpack implementation.
	 *
	 * For Atomic sites we mark the Jetpack ToS option temporary as read.
	 *
	 * @todo Remove the jetpack_options_tos_agreed filter for Atomic sites after the Tracking is properly working for AT sites.
	 *
	 * @param array $event_properties The event properties.
	 */
	private function record_jetpack_event( $event_properties ) {
		$woa = ( new Host() )->is_woa_site();
		if ( $woa ) {
			add_filter( 'jetpack_options', array( __CLASS__, 'mark_jetpack_tos_as_read' ), 10, 2 );
		}

		$this->tracking->record_user_event( self::JETPACK_EVENT_NAME, $event_properties );

		if ( $woa ) {
			\remove_filter( 'jetpack_options', array( __CLASS__, 'mark_jetpack_tos_as_read' ) );
		}
	}

	/**
	 * Trigger the WPCOM tracks_record_event.
	 *
	 * @param array $event_props Event props.
	 */
	public static function wpcom_tracks_record_event( $event_props ) {
		require_lib( 'tracks/client' );
		\tracks_record_event( \wp_get_current_user(), self::WPCOM_EVENT_NAME, $event_props );
	}

	/**
	 * Get the tracking product name for the Tracking library.
	 *
	 * The tracking product name is used by the Tracking as a prefix for the event name.
	 *
	 * @return string
	 */
	public static function get_jetpack_tracking_product() {
		return ( new Host() )->is_woa_site() ? 'atomic' : 'jetpack';
	}

	/**
	 * Mark the Jetpack ToS as read for Atomic Sites.
	 *
	 * @param mixed  $option_value The value of the Jetpack option.
	 * @param string $option_name The name of the Jetpack option.
	 *
	 * @return bool
	 */
	public static function mark_jetpack_tos_as_read( $option_value, $option_name ) {
		if ( Terms_Of_Service::OPTION_NAME === $option_name ) {
			return true;
		}

		return $option_value;
	}
}
class-domain-only-admin-menu.php                                                                                                                                                                                                                               2697          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Domain-only sites Admin Menu file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

require_once __DIR__ . '/class-base-admin-menu.php';
require_once __DIR__ . '/class-wpcom-email-subscription-checker.php';

/**
 * Class Domain_Only_Admin_Menu.
 */
class Domain_Only_Admin_Menu extends Base_Admin_Menu {
	/**
	 * The `WPCOM_Email_Subscription_Checker` instance used to verify if a site has an email subscription.
	 *
	 * @var \WPCOM_Email_Subscription_Checker
	 */
	private $email_subscriptions_checker;

	/**
	 * Constructor that lets us pass in a WPCOM_Email_Subscription_Checker dependency.
	 *
	 * @param \WPCOM_Email_Subscription_Checker $email_subscriptions_checker The WPCOM_Email_Subscription_Checker instance.
	 */
	protected function __construct( $email_subscriptions_checker = null ) {
		parent::__construct();

		$this->email_subscriptions_checker = $email_subscriptions_checker;

		if ( empty( $this->email_subscriptions_checker ) ) {
			$this->set_email_subscription_checker( new \WPCOM_Email_Subscription_Checker() );
		}
	}

	/**
	 * This setter lets us inject an WPCOM_Email_Subscription_Checker instance.
	 *
	 * @param \WPCOM_Email_Subscription_Checker $email_subscriptions_checker An WPCOM_Email_Subscription_Checker instance.
	 *
	 * @return void
	 */
	public function set_email_subscription_checker( $email_subscriptions_checker ) {
		$this->email_subscriptions_checker = $email_subscriptions_checker;
	}

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		global $menu, $submenu;

		$menu    = array(); // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		$submenu = array(); // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited

		add_menu_page( esc_attr__( 'Manage Domain', 'jetpack' ), __( 'Manage Domain', 'jetpack' ), 'manage_options', 'https://wordpress.com/domains/manage/' . $this->domain . '/edit/' . $this->domain, null, 'dashicons-admin-settings' );

		if ( $this->email_subscriptions_checker->has_email() ) {
			add_menu_page( esc_attr__( 'Manage Email', 'jetpack' ), __( 'Manage Email', 'jetpack' ), 'manage_options', 'https://wordpress.com/email/' . $this->domain . '/manage/' . $this->domain, null, 'dashicons-admin-settings' );
		}

		add_menu_page( esc_attr__( 'Manage Purchases', 'jetpack' ), __( 'Manage Purchases', 'jetpack' ), 'manage_options', 'https://wordpress.com/purchases/subscriptions/' . $this->domain, null, 'dashicons-cart' );
		add_menu_page( esc_attr__( 'My Mailboxes', 'jetpack' ), __( 'My Mailboxes', 'jetpack' ), 'manage_options', 'https://wordpress.com/mailboxes/' . $this->domain, null, 'dashicons-email' );
	}
}
class-jetpack-admin-menu.php                                                                                                                                                                                                                                   12494         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Jetpack Admin Menu file.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Blaze;
use Automattic\Jetpack\Current_Plan as Jetpack_Plan;

require_once __DIR__ . '/class-admin-menu.php';

/**
 * Class Jetpack_Admin_Menu.
 */
class Jetpack_Admin_Menu extends Admin_Menu {

	/**
	 * Determines whether the current locale is right-to-left (RTL).
	 *
	 * Performs the check against the current locale set on the WordPress.com's account settings.
	 * See `Masterbar::__construct` in `modules/masterbar/masterbar/class-masterbar.php`.
	 */
	public function is_rtl() {
		return get_user_option( 'jetpack_wpcom_is_rtl' );
	}

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		global $menu, $submenu;

		// Reset menus so there are no third-party plugin items.
		$menu    = array(); // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited
		$submenu = array(); // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited

		parent::reregister_menu_items();

		$this->add_feedback_menu();
		$this->add_cpt_menus();
		$this->add_wp_admin_menu();

		ksort( $GLOBALS['menu'] );
	}

	/**
	 * Get the preferred view for the given screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param bool   $fallback_global_preference (Optional) Whether the global preference for all screens should be used
	 *                                           as fallback if there is no specific preference for the given screen.
	 *                                           Default: true.
	 * @return string
	 */
	public function get_preferred_view( $screen, $fallback_global_preference = true ) { // phpcs:ignore VariableAnalysis.CodeAnalysis.VariableAnalysis.UnusedVariable
		// Force default views (Calypso) on Jetpack sites since Nav Unification is disabled on WP Admin.
		return self::DEFAULT_VIEW;
	}

	/**
	 * Get the Calypso or wp-admin link to CPT page.
	 *
	 * @param object $ptype_obj The post type object.
	 * @return string The link to Calypso if SSO is enabled and the post_type
	 * supports rest or to WP Admin if SSO is disabled.
	 */
	public function get_cpt_menu_link( $ptype_obj ) {

		$post_type = $ptype_obj->name;

		if ( \Jetpack::is_module_active( 'sso' ) && $ptype_obj->show_in_rest ) {
			return 'https://wordpress.com/types/' . $post_type . '/' . $this->domain;
		} else {
			return 'edit.php?post_type=' . $post_type;
		}
	}

	/**
	 * Adds Posts menu.
	 */
	public function add_posts_menu() {
		$post = get_post_type_object( 'post' );
		add_menu_page( esc_attr( $post->labels->menu_name ), $post->labels->menu_name, $post->cap->edit_posts, 'https://wordpress.com/posts/' . $this->domain, null, 'dashicons-admin-post' );
	}

	/**
	 * Adds Media menu.
	 */
	public function add_media_menu() {
		add_menu_page( __( 'Media', 'jetpack' ), __( 'Media', 'jetpack' ), 'upload_files', 'https://wordpress.com/media/' . $this->domain, null, 'dashicons-admin-media' );
	}

	/**
	 * Adds Page menu.
	 */
	public function add_page_menu() {
		$page = get_post_type_object( 'page' );
		add_menu_page( esc_attr( $page->labels->menu_name ), $page->labels->menu_name, $page->cap->edit_posts, 'https://wordpress.com/pages/' . $this->domain, null, 'dashicons-admin-page' );
	}

	/**
	 * Adds a custom post type menu.
	 *
	 * @param string   $post_type Custom post type.
	 * @param int|null $position Optional. Position where to display the menu item. Default null.
	 */
	public function add_custom_post_type_menu( $post_type, $position = null ) {
		$ptype_obj = get_post_type_object( $post_type );
		if ( empty( $ptype_obj ) ) {
			return;
		}

		$menu_slug = $this->get_cpt_menu_link( $ptype_obj );

		// Menu icon.
		$menu_icon = 'dashicons-admin-post';
		if ( is_string( $ptype_obj->menu_icon ) ) {
			// Special handling for data:image/svg+xml and Dashicons.
			if ( str_starts_with( $ptype_obj->menu_icon, 'data:image/svg+xml;base64,' ) || str_starts_with( $ptype_obj->menu_icon, 'dashicons-' ) ) {
				$menu_icon = $ptype_obj->menu_icon;
			} else {
				$menu_icon = esc_url( $ptype_obj->menu_icon );
			}
		}

		add_menu_page( esc_attr( $ptype_obj->labels->menu_name ), $ptype_obj->labels->menu_name, $ptype_obj->cap->edit_posts, $menu_slug, null, $menu_icon, $position );
	}

	/**
	 * Adds Comments menu.
	 */
	public function add_comments_menu() {
		add_menu_page( esc_attr__( 'Comments', 'jetpack' ), __( 'Comments', 'jetpack' ), 'edit_posts', 'https://wordpress.com/comments/all/' . $this->domain, null, 'dashicons-admin-comments' );
	}

	/**
	 * Adds Feedback menu.
	 */
	public function add_feedback_menu() {
		$post_type = 'feedback';

		$ptype_obj = get_post_type_object( $post_type );
		if ( empty( $ptype_obj ) ) {
			return;
		}

		$slug       = 'edit.php?post_type=' . $post_type;
		$name       = __( 'Feedback', 'jetpack' );
		$capability = $ptype_obj->cap->edit_posts;
		$icon       = $ptype_obj->menu_icon;
		$position   = 45; // Before Jetpack.

		add_menu_page( esc_attr( $name ), $name, $capability, $slug, null, $icon, $position );
	}

	/**
	 * Adds CPT menu items
	 */
	public function add_cpt_menus() {

		$post_type_list = get_post_types(
			array(
				'show_in_menu' => true,
				'_builtin'     => false,
			)
		);

		foreach ( $post_type_list as $post_type ) {
			$position = 46; // After Feedback.
			$this->add_custom_post_type_menu( $post_type, $position );
		}
	}

	/**
	 * Adds Jetpack menu.
	 */
	public function add_jetpack_menu() {
		parent::add_jetpack_menu();

		/* translators: Jetpack sidebar menu item. */
		add_submenu_page( 'jetpack', esc_attr__( 'Search', 'jetpack' ), __( 'Search', 'jetpack' ), 'manage_options', 'jetpack-search', admin_url( 'admin.php?page=jetpack-search' ), 4 );

		// Place "Scan" submenu after Backup.
		$position = 0;
		global $submenu;
		foreach ( $submenu['jetpack'] as $submenu_item ) {
			++$position;
			if ( __( 'Backup', 'jetpack' ) === $submenu_item[3] ) {
				break;
			}
		}
		add_submenu_page( 'jetpack', esc_attr__( 'Scan', 'jetpack' ), __( 'Scan', 'jetpack' ), 'manage_options', 'https://wordpress.com/scan/' . $this->domain, null, $position );
	}

	/**
	 * Adds Appearance menu.
	 *
	 * @return string The Customizer URL.
	 */
	public function add_appearance_menu() {
		$themes_url = 'https://wordpress.com/themes/' . $this->domain;
		// Customize on Jetpack sites is always done on WP Admin (unsupported by Calypso).
		$customize_url = 'customize.php';

		add_menu_page( esc_attr__( 'Appearance', 'jetpack' ), __( 'Appearance', 'jetpack' ), 'switch_themes', $themes_url, null, 'dashicons-admin-appearance', 60 );
		add_submenu_page( $themes_url, esc_attr__( 'Themes', 'jetpack' ), __( 'Themes', 'jetpack' ), 'switch_themes', 'https://wordpress.com/themes/' . $this->domain );

		if ( ! has_action( 'customize_register' ) && wp_is_block_theme() ) {
			return $customize_url;
		}

		add_submenu_page( $themes_url, esc_attr__( 'Customize', 'jetpack' ), __( 'Customize', 'jetpack' ), 'customize', $customize_url );

		return $customize_url;
	}

	/**
	 * Adds Plugins menu.
	 */
	public function add_plugins_menu() {
		add_menu_page( esc_attr__( 'Plugins', 'jetpack' ), __( 'Plugins', 'jetpack' ), 'activate_plugins', 'https://wordpress.com/plugins/' . $this->domain, null, 'dashicons-admin-plugins', 65 );
	}

	/**
	 * Adds Users menu.
	 */
	public function add_users_menu() {
		if ( current_user_can( 'list_users' ) ) {
			$users_url = 'https://wordpress.com/people/team/' . $this->domain;
			add_menu_page( esc_attr__( 'Users', 'jetpack' ), __( 'Users', 'jetpack' ), 'list_users', $users_url, null, 'dashicons-admin-users', 70 );
			add_submenu_page( $users_url, esc_attr__( 'All Users', 'jetpack' ), __( 'All Users', 'jetpack' ), 'list_users', $users_url, null, 10 );
			add_submenu_page( $users_url, esc_attr__( 'Add New User', 'jetpack' ), __( 'Add New User', 'jetpack' ), 'promote_users', 'https://wordpress.com/people/new/' . $this->domain, null, 20 );
			add_submenu_page( $users_url, esc_attr__( 'Subscribers', 'jetpack' ), __( 'Subscribers', 'jetpack' ), 'list_users', 'https://wordpress.com/subscribers/' . $this->domain, null, 30 );
			add_submenu_page( $users_url, esc_attr__( 'My Profile', 'jetpack' ), __( 'My Profile', 'jetpack' ), 'read', 'https://wordpress.com/me', null, 40 );
			add_submenu_page( $users_url, esc_attr__( 'Account Settings', 'jetpack' ), __( 'Account Settings', 'jetpack' ), 'read', 'https://wordpress.com/me/account', null, 50 );
		} else {
			add_menu_page( esc_attr__( 'My Profile', 'jetpack' ), __( 'Profile', 'jetpack' ), 'read', 'https://wordpress.com/me', null, 'dashicons-admin-users', 70 );
		}
	}

	/**
	 * Adds Tools menu.
	 */
	public function add_tools_menu() {
		add_menu_page( esc_attr__( 'Tools', 'jetpack' ), __( 'Tools', 'jetpack' ), 'publish_posts', 'tools.php', null, 'dashicons-admin-tools', 75 );

		add_submenu_page( 'tools.php', esc_attr__( 'Marketing', 'jetpack' ), __( 'Marketing', 'jetpack' ), 'publish_posts', 'https://wordpress.com/marketing/tools/' . $this->domain );

		if ( Blaze::should_initialize() ) {
			add_submenu_page( 'tools.php', esc_attr__( 'Advertising', 'jetpack' ), __( 'Advertising', 'jetpack' ), 'manage_options', 'https://wordpress.com/advertising/' . $this->domain, null, 1 );
		}

		add_submenu_page( 'tools.php', esc_attr__( 'Monetize', 'jetpack' ), __( 'Monetize', 'jetpack' ), 'manage_options', 'https://wordpress.com/earn/' . $this->domain );

		// Import/Export on Jetpack sites is always handled on WP Admin.
		add_submenu_page( 'tools.php', esc_attr__( 'Import', 'jetpack' ), __( 'Import', 'jetpack' ), 'import', 'import.php' );
		add_submenu_page( 'tools.php', esc_attr__( 'Export', 'jetpack' ), __( 'Export', 'jetpack' ), 'export', 'export.php' );

		// Remove the submenu auto-created by Core.
		$this->hide_submenu_page( 'tools.php', 'tools.php' );
	}

	/**
	 * Adds Settings menu.
	 */
	public function add_options_menu() {
		$slug = 'https://wordpress.com/settings/general/' . $this->domain;
		add_menu_page( esc_attr__( 'Settings', 'jetpack' ), __( 'Settings', 'jetpack' ), 'manage_options', $slug, null, 'dashicons-admin-settings', 80 );
		add_submenu_page( $slug, esc_attr__( 'General', 'jetpack' ), __( 'General', 'jetpack' ), 'manage_options', $slug );
		add_submenu_page( $slug, esc_attr__( 'Security', 'jetpack' ), __( 'Security', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/security/' . $this->domain );
		add_submenu_page( $slug, esc_attr__( 'Performance', 'jetpack' ), __( 'Performance', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/performance/' . $this->domain );
		add_submenu_page( $slug, esc_attr__( 'Writing', 'jetpack' ), __( 'Writing', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/writing/' . $this->domain );
		add_submenu_page( $slug, esc_attr__( 'Reading', 'jetpack' ), __( 'Reading', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/reading/' . $this->domain );
		add_submenu_page( $slug, esc_attr__( 'Discussion', 'jetpack' ), __( 'Discussion', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/discussion/' . $this->domain );
		add_submenu_page( $slug, esc_attr__( 'Newsletter', 'jetpack' ), __( 'Newsletter', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/newsletter/' . $this->domain );

		$plan_supports_scan = Jetpack_Plan::supports( 'scan' );
		$products           = Jetpack_Plan::get_products();
		$has_scan_product   = false;

		if ( is_array( $products ) ) {
			foreach ( $products as $product ) {
				if ( strpos( $product['product_slug'], 'jetpack_scan' ) === 0 ) {
					$has_scan_product = true;
					break;
				}
			}
		}

		$has_scan     = $plan_supports_scan || $has_scan_product;
		$rewind_state = get_transient( 'jetpack_rewind_state' );
		$has_backup   = $rewind_state && in_array( $rewind_state->state, array( 'awaiting_credentials', 'provisioning', 'active' ), true );
		if ( $has_scan || $has_backup ) {
			add_submenu_page( $slug, esc_attr__( 'Jetpack', 'jetpack' ), __( 'Jetpack', 'jetpack' ), 'manage_options', 'https://wordpress.com/settings/jetpack/' . $this->domain );
		}
	}

	/**
	 * Adds WP Admin menu.
	 */
	public function add_wp_admin_menu() {
		global $menu;

		// Attempt to get last position.
		ksort( $menu );
		end( $menu );
		$position = key( $menu );

		$this->add_admin_menu_separator( ++$position );
		add_menu_page( __( 'WP Admin', 'jetpack' ), __( 'WP Admin', 'jetpack' ), 'read', 'index.php', null, 'dashicons-wordpress-alt', $position );
	}
}
class-p2-admin-menu.php                                                                                                                                                                                                                                        6504          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * P2 Admin Menu file.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

require_once __DIR__ . '/class-wpcom-admin-menu.php';

/**
 * Class P2_Admin_Menu.
 */
class P2_Admin_Menu extends WPcom_Admin_Menu {

	/**
	 * Slug for the "Appearance" menu item.
	 *
	 * @var string
	 */
	private $appearance_slug = 'themes.php';

	/**
	 * Slug for the "Jetpack" menu item.
	 *
	 * @var string
	 */
	private $jetpack_slug = 'jetpack';

	/**
	 * Slug for the "Upgrades" menu item.
	 *
	 * @var string
	 */
	private $upgrades_slug = 'paid-upgrades.php';

	/**
	 * Slug for the "Plugins" menu item.
	 *
	 * @var string
	 */
	private $plugins_slug = 'plugins.php';

	/**
	 * Slug for the "Tools" menu item.
	 *
	 * @var string
	 */
	private $tools_slug = 'tools.php';

	/**
	 * Whether or not the P2 is a hub.
	 *
	 * @var bool
	 */
	private $is_hub = false;

	/**
	 * Whether or not the P2 has a paid plan.
	 *
	 * @var bool
	 */
	private $is_paid = false;

	/**
	 * P2_Admin_Menu constructor.
	 */
	protected function __construct() {
		parent::__construct();

		if (
			defined( 'IS_WPCOM' ) && IS_WPCOM &&
			function_exists( 'require_lib' )
		) {
			require_lib( 'wpforteams' );

			$current_blog_id = get_current_blog_id();
			$this->is_hub    = \WPForTeams\Workspace\is_workspace_hub( $current_blog_id );
			$this->is_paid   = \WPForTeams\has_p2_plus_plan( \WPForTeams\Workspace\get_hub_blog_id_from_blog_id( $current_blog_id ) );
		}
		// Appearance -> AMP. This needs to be called here in the constructor.
		// Running it from reregister_menu_items is not early enough.
		remove_action( 'admin_menu', 'amp_add_customizer_link' );
	}

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		parent::reregister_menu_items();

		if ( ! $this->is_hub ) {
			$this->remove_menus_for_p2_space();
		} else {
			$this->remove_menus_for_hub();
		}

		$this->remove_menus_for_all_p2s();
	}

	/**
	 * Remove menu items that are not applicable for P2 workspace sites.
	 */
	private function remove_menus_for_p2_space() {
		// Non-hub P2s can't have plans at all.
		remove_menu_page( $this->upgrades_slug );
		// Jetpack -> Backup.
		remove_submenu_page( $this->jetpack_slug, 'https://wordpress.com/backup/' . $this->domain );
		// Appearance -> Themes.
		remove_submenu_page( $this->appearance_slug, 'https://wordpress.com/themes/' . $this->domain );
		// Appearance -> Additional CSS.
		$customize_custom_css_url = add_query_arg(
			array( 'autofocus' => array( 'section' => 'css_nudge' ) ),
			'https://wordpress.com/customize/' . $this->domain
		);
		remove_submenu_page( $this->appearance_slug, $customize_custom_css_url );

		// Tools
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/marketing/tools/' . $this->domain );
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/earn/' . $this->domain );
	}

	/**
	 * Remove menu items that are not applicable for P2 hubs.
	 */
	private function remove_menus_for_hub() {
		// Hubs can have plans, but not domain and email products.
		remove_submenu_page( $this->upgrades_slug, 'https://wordpress.com/domains/manage/' . $this->domain );
		remove_submenu_page( $this->upgrades_slug, 'https://wordpress.com/email/' . $this->domain );
		// Stats.
		remove_menu_page( 'https://wordpress.com/stats/day/' . $this->domain );
		// Hide posts.
		remove_menu_page( 'edit.php' );
		// Hide pages.
		remove_menu_page( 'edit.php?post_type=page' );
		// Hide media.
		remove_menu_page( 'https://wordpress.com/media/' . $this->domain );
		// Hide comments.
		remove_menu_page( 'https://wordpress.com/comments/all/' . $this->domain );
		// Hide appearance.
		remove_menu_page( $this->appearance_slug );
		// Tools.
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/marketing/tools/' . $this->domain );
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/earn/' . $this->domain );
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/import/' . $this->domain );
		remove_submenu_page( $this->tools_slug, 'https://wordpress.com/export/' . $this->domain );
		add_submenu_page( $this->tools_slug, __( 'Integrations', 'jetpack' ), __( 'Integrations', 'jetpack' ), 'manage_options', 'https://wordpress.com/marketing/connections/' . $this->domain, null, 0 );
		// Hide settings.
		remove_submenu_page( 'options-general.php', 'options-reading.php' );
		remove_submenu_page( 'options-general.php', 'options-writing.php' );
		remove_submenu_page( 'options-general.php', 'options-discussion.php' );
	}

	/**
	 * Remove menu items that are not applicable for all P2s.
	 */
	private function remove_menus_for_all_p2s() {
		// Remove Jetpack menu item.
		remove_menu_page( $this->jetpack_slug );

		// The following menu items are hidden for both hubs and P2 sites.
		remove_menu_page( 'link-manager.php' );
		remove_menu_page( 'feedback' );
		remove_menu_page( $this->plugins_slug );
		remove_menu_page( 'https://wordpress.com/plugins/' . $this->domain );
		remove_menu_page( 'https://wordpress.com/inbox/' . $this->domain );

		remove_submenu_page( 'https://wordpress.com/settings/general/' . $this->domain, 'sharing' );
		remove_submenu_page( 'https://wordpress.com/settings/general/' . $this->domain, 'polls&action=options' );
		remove_submenu_page( 'https://wordpress.com/settings/general/' . $this->domain, 'ratings&action=options' );
		remove_submenu_page(
			'options-general.php',
			'https://wordpress.com/hosting-config/' . $this->domain
		);
		remove_submenu_page(
			'https://wordpress.com/settings/general/' . $this->domain,
			'https://wordpress.com/marketing/sharing-buttons/' . $this->domain
		);

		/** This action is documented in `wp-content/plugins/p2-editor/classes/p2-editor-admin.php` */
		if ( apply_filters( 'p2tenberg_admin_patterns', apply_filters( 'p2editor_admin_patterns', true ) ) !== true ) {
			remove_menu_page( 'edit.php?post_type=p2_pattern' );
		}
		remove_submenu_page(
			'edit.php?post_type=p2_pattern',
			'edit-tags.php?taxonomy=post_tag&amp;post_type=p2_pattern'
		);

		// Hide performance settings.
		remove_submenu_page( 'options-general.php', 'https://wordpress.com/settings/performance/' . $this->domain );
	}

	/**
	 * Override, don't add the woocommerce installation menu on any p2s.
	 *
	 * @param array|null $current_plan The site's plan.
	 */
	public function add_woocommerce_installation_menu( $current_plan = null ) {} // phpcs:ignore VariableAnalysis.CodeAnalysis.VariableAnalysis.UnusedVariable
}
class-wpcom-admin-menu.php                                                                                                                                                                                                                                     17538         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * WP.com Admin Menu file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Status;
use Jetpack_Custom_CSS;
use JITM;

require_once __DIR__ . '/class-admin-menu.php';

/**
 * Class WPcom_Admin_Menu.
 */
class WPcom_Admin_Menu extends Admin_Menu {
	/**
	 * Holds the current plan, set by get_current_plan().
	 *
	 * @var array
	 */
	private $current_plan = array();

	/**
	 * WPcom_Admin_Menu constructor.
	 */
	protected function __construct() {
		parent::__construct();

		add_action( 'wp_ajax_sidebar_state', array( $this, 'ajax_sidebar_state' ) );
		add_action( 'wp_ajax_jitm_dismiss', array( $this, 'wp_ajax_jitm_dismiss' ) );
		add_action( 'wp_ajax_upsell_nudge_jitm', array( $this, 'wp_ajax_upsell_nudge_jitm' ) );
		add_action( 'admin_init', array( $this, 'sync_sidebar_collapsed_state' ) );
		add_action( 'admin_menu', array( $this, 'remove_submenus' ), 140 ); // After hookpress hook at 130.
	}

	/**
	 * Create the desired menu output.
	 */
	public function reregister_menu_items() {
		parent::reregister_menu_items();

		$this->add_my_home_menu();
		$this->add_my_mailboxes_menu();
		$this->remove_gutenberg_menu();

		// Not needed outside of wp-admin.
		if ( ! $this->is_api_request ) {
			$this->add_browse_sites_link();
			$this->add_site_card_menu();
			$this->add_new_site_link();
		}

		$this->add_woocommerce_installation_menu( $this->get_current_plan() );

		ksort( $GLOBALS['menu'] );
	}

	/**
	 * Get the preferred view for the given screen.
	 *
	 * @param string $screen Screen identifier.
	 * @param bool   $fallback_global_preference (Optional) Whether the global preference for all screens should be used
	 *                                           as fallback if there is no specific preference for the given screen.
	 *                                           Default: true.
	 * @return string
	 */
	public function get_preferred_view( $screen, $fallback_global_preference = true ) {
		// When no preferred view has been set for Themes, keep the previous behavior that forced the default view
		// regardless of the global preference.
		if ( $fallback_global_preference && 'themes.php' === $screen ) {
			$preferred_view = parent::get_preferred_view( $screen, false );
			if ( self::UNKNOWN_VIEW === $preferred_view ) {
				return self::DEFAULT_VIEW;
			}
			return $preferred_view;
		}

		// Plugins on Simple sites are always managed on Calypso.
		if ( 'plugins.php' === $screen ) {
			return self::DEFAULT_VIEW;
		}

		return parent::get_preferred_view( $screen, $fallback_global_preference );
	}

	/**
	 * Retrieve the number of blogs that the current user has.
	 *
	 * @return int
	 */
	public function get_current_user_blog_count() {
		if ( function_exists( '\get_blog_count_for_user' ) ) {
			return \get_blog_count_for_user( get_current_user_id() );
		}

		$blogs = get_blogs_of_user( get_current_user_id() );
		return is_countable( $blogs ) ? count( $blogs ) : 0;
	}

	/**
	 * Adds the site switcher link if user has more than one site.
	 */
	public function add_browse_sites_link() {
		if ( $this->get_current_user_blog_count() < 2 ) {
			return;
		}

		// Add the menu item.
		add_menu_page( __( 'site-switcher', 'jetpack' ), __( 'Browse sites', 'jetpack' ), 'read', 'https://wordpress.com/sites', null, 'dashicons-arrow-left-alt2', 0 );
		add_filter( 'add_menu_classes', array( $this, 'set_browse_sites_link_class' ) );
	}

	/**
	 * Adds a custom element class for Site Switcher menu item.
	 *
	 * @param array $menu Associative array of administration menu items.
	 * @return array
	 */
	public function set_browse_sites_link_class( array $menu ) {
		foreach ( $menu as $key => $menu_item ) {
			if ( 'site-switcher' !== $menu_item[3] ) {
				continue;
			}

			$menu[ $key ][4] = add_cssclass( 'site-switcher', $menu_item[4] );
			break;
		}

		return $menu;
	}

	/**
	 * Adds a link to the menu to create a new site.
	 */
	public function add_new_site_link() {
		if ( $this->get_current_user_blog_count() > 1 ) {
			return;
		}

		$this->add_admin_menu_separator();
		add_menu_page( __( 'Add New Site', 'jetpack' ), __( 'Add New Site', 'jetpack' ), 'read', 'https://wordpress.com/start?ref=calypso-sidebar', null, 'dashicons-plus-alt' );
	}

	/**
	 * Adds site card component.
	 */
	public function add_site_card_menu() {
		$default         = plugins_url( 'globe-icon.svg', __FILE__ );
		$icon            = get_site_icon_url( 32, $default );
		$blog_name       = get_option( 'blogname' ) !== '' ? get_option( 'blogname' ) : $this->domain;
		$status          = new Status();
		$is_private_site = $status->is_private_site();
		$is_coming_soon  = $status->is_coming_soon();

		if ( $default === $icon && blavatar_exists( $this->domain ) ) {
			$icon = blavatar_url( $this->domain, 'img', 32 );
		}

		$badge = '';
		if ( $is_private_site || $is_coming_soon ) {
			$badge .= sprintf(
				'<span class="site__badge site__badge-private">%s</span>',
				$is_coming_soon ? esc_html__( 'Coming Soon', 'jetpack' ) : esc_html__( 'Private', 'jetpack' )
			);
		}

		if ( function_exists( 'is_simple_site_redirect' ) && is_simple_site_redirect( $this->domain ) ) {
			$badge .= '<span class="site__badge site__badge-redirect">' . esc_html__( 'Redirect', 'jetpack' ) . '</span>';
		}

		if ( ! empty( get_option( 'options' )['is_domain_only'] ) ) {
			$badge .= '<span class="site__badge site__badge-domain-only">' . esc_html__( 'Domain', 'jetpack' ) . '</span>';
		}

		$site_card = '
<div class="site__info">
	<div class="site__title">%1$s</div>
	<div class="site__domain">%2$s</div>
	%3$s
</div>';

		$site_card = sprintf(
			$site_card,
			$blog_name,
			$this->domain,
			$badge
		);

		add_menu_page( 'site-card', $site_card, 'read', get_home_url(), null, $icon, 1 );
		add_filter( 'add_menu_classes', array( $this, 'set_site_card_menu_class' ) );
	}

	/**
	 * Adds a custom element class and id for Site Card's menu item.
	 *
	 * @param array $menu Associative array of administration menu items.
	 * @return array
	 */
	public function set_site_card_menu_class( array $menu ) {
		foreach ( $menu as $key => $menu_item ) {
			if ( 'site-card' !== $menu_item[3] ) {
				continue;
			}

			$classes = ' toplevel_page_site-card';
			if ( blavatar_exists( $this->domain ) ) {
				$classes .= ' has-site-icon';
			}

			$menu[ $key ][4] = $menu_item[4] . $classes;
			$menu[ $key ][5] = 'toplevel_page_site_card';
			break;
		}

		return $menu;
	}

	/**
	 * Returns the first available upsell nudge.
	 *
	 * @return array
	 */
	public function get_upsell_nudge() {
		require_lib( 'jetpack-jitm/jitm-engine' );
		$jitm_engine = new JITM\Engine();

		$message_path = 'calypso:sites:sidebar_notice';
		$current_user = wp_get_current_user();
		$user_id      = $current_user->ID;
		$user_roles   = implode( ',', $current_user->roles );
		$query_string = array(
			'message_path' => $message_path,
		);

		// Get the top message only.
		$message = $jitm_engine->get_top_messages( $message_path, $user_id, $user_roles, $query_string );

		if ( isset( $message[0] ) ) {
			$message = $message[0];
			return array(
				'content'                      => $message->content['message'],
				'cta'                          => $message->CTA['message'], // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				'link'                         => $message->CTA['link'], // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
				'tracks_impression_event_name' => $message->tracks['display']['name'] ?? null,
				'tracks_impression_cta_name'   => $message->tracks['display']['props']['cta_name'] ?? null,
				'tracks_click_event_name'      => $message->tracks['click']['name'] ?? null,
				'tracks_click_cta_name'        => $message->tracks['click']['props']['cta_name'] ?? null,
				'dismissible'                  => $message->is_dismissible,
				'feature_class'                => $message->feature_class,
				'id'                           => $message->id,
			);
		}
	}

	/**
	 * Adds Stats menu.
	 */
	public function add_stats_menu() {
		$menu_title = __( 'Stats', 'jetpack' );

		if ( ! $this->is_api_request ) {
			$menu_title .= sprintf(
				'<img class="sidebar-unified__sparkline" width="80" height="20" src="%1$s" alt="%2$s">',
				esc_url( site_url( 'wp-includes/charts/admin-bar-hours-scale-2x.php?masterbar=1&s=' . get_current_blog_id() ) ),
				esc_attr__( 'Hourly views', 'jetpack' )
			);
		}

		add_menu_page( __( 'Stats', 'jetpack' ), $menu_title, 'read', 'https://wordpress.com/stats/day/' . $this->domain, null, 'dashicons-chart-bar', 3 );
	}

	/**
	 * Gets the current plan and stores it in $this->current_plan so the database is only called once per request.
	 *
	 * @return array
	 */
	private function get_current_plan() {
		if ( empty( $this->current_plan ) && class_exists( 'WPCOM_Store_API' ) ) {
			$this->current_plan = \WPCOM_Store_API::get_current_plan( get_current_blog_id() );
		}
		return $this->current_plan;
	}

	/**
	 * Adds Upgrades menu.
	 *
	 * @param string $plan The current WPCOM plan of the blog.
	 */
	public function add_upgrades_menu( $plan = null ) {
		$current_plan = $this->get_current_plan();
		if ( ! empty( $current_plan['product_name_short'] ) ) {
			$plan = $current_plan['product_name_short'];
		}

		parent::add_upgrades_menu( $plan );

		$last_upgrade_submenu_position = $this->get_submenu_item_count( 'paid-upgrades.php' );

		add_submenu_page( 'paid-upgrades.php', __( 'Domains', 'jetpack' ), __( 'Domains', 'jetpack' ), 'manage_options', 'https://wordpress.com/domains/manage/' . $this->domain, null, $last_upgrade_submenu_position - 1 );

		/** This filter is already documented in modules/masterbar/admin-menu/class-atomic-admin-menu.php */
		if ( apply_filters( 'jetpack_show_wpcom_upgrades_email_menu', false ) ) {
			add_submenu_page( 'paid-upgrades.php', __( 'Emails', 'jetpack' ), __( 'Emails', 'jetpack' ), 'manage_options', 'https://wordpress.com/email/' . $this->domain, null, $last_upgrade_submenu_position );
		}

		if ( defined( 'WPCOM_ENABLE_ADD_ONS_MENU_ITEM' ) && WPCOM_ENABLE_ADD_ONS_MENU_ITEM ) {
			add_submenu_page( 'paid-upgrades.php', __( 'Add-Ons', 'jetpack' ), __( 'Add-Ons', 'jetpack' ), 'manage_options', 'https://wordpress.com/add-ons/' . $this->domain, null, 1 );
		}
	}

	/**
	 * Adds Appearance menu.
	 */
	public function add_appearance_menu() {
		$customize_url = parent::add_appearance_menu();

		$this->hide_submenu_page( 'themes.php', 'theme-editor.php' );

		$user_can_customize = current_user_can( 'customize' );

		if ( wp_is_block_theme() ) {
			add_filter( 'safecss_is_freetrial', '__return_false', PHP_INT_MAX );
			if ( class_exists( 'Jetpack_Custom_CSS' ) && empty( Jetpack_Custom_CSS::get_css() ) ) {
				$user_can_customize = false;
			}
			remove_filter( 'safecss_is_freetrial', '__return_false', PHP_INT_MAX );
		}

		if ( $user_can_customize ) {
			$customize_custom_css_url = add_query_arg( array( 'autofocus' => array( 'section' => 'jetpack_custom_css' ) ), $customize_url );
			add_submenu_page( 'themes.php', esc_attr__( 'Additional CSS', 'jetpack' ), __( 'Additional CSS', 'jetpack' ), 'customize', esc_url( $customize_custom_css_url ), null, 20 );
		}
	}

	/**
	 * Adds Users menu.
	 */
	public function add_users_menu() {
		$submenus_to_update = array(
			'grofiles-editor'        => 'https://wordpress.com/me',
			'grofiles-user-settings' => 'https://wordpress.com/me/account',
		);

		if ( self::DEFAULT_VIEW === $this->get_preferred_view( 'users.php' ) ) {
			$submenus_to_update['users.php'] = 'https://wordpress.com/people/team/' . $this->domain;
		}

		$slug = current_user_can( 'list_users' ) ? 'users.php' : 'profile.php';
		$this->update_submenus( $slug, $submenus_to_update );
		add_submenu_page( 'users.php', esc_attr__( 'Add New User', 'jetpack' ), __( 'Add New User', 'jetpack' ), 'promote_users', 'https://wordpress.com/people/new/' . $this->domain, null, 1 );
		add_submenu_page( 'users.php', esc_attr__( 'Subscribers', 'jetpack' ), __( 'Subscribers', 'jetpack' ), 'list_users', 'https://wordpress.com/subscribers/' . $this->domain, null, 3 );
	}

	/**
	 * Adds Settings menu.
	 */
	public function add_options_menu() {
		parent::add_options_menu();

		add_submenu_page( 'options-general.php', esc_attr__( 'Hosting Configuration', 'jetpack' ), __( 'Hosting Configuration', 'jetpack' ), 'manage_options', 'https://wordpress.com/hosting-config/' . $this->domain, null, 10 );
	}

	/**
	 * Adds My Home menu.
	 */
	public function add_my_home_menu() {
		$this->update_menu( 'index.php', 'https://wordpress.com/home/' . $this->domain, __( 'My Home', 'jetpack' ), 'read', 'dashicons-admin-home' );
	}

	/**
	 * Also remove the Gutenberg plugin menu.
	 */
	public function remove_gutenberg_menu() {
		// Always remove the Gutenberg menu.
		remove_menu_page( 'gutenberg' );
	}

	/**
	 * Whether to use wp-admin pages rather than Calypso.
	 *
	 * @return bool
	 */
	public function should_link_to_wp_admin() {
		$result = false; // Calypso.

		$user_attribute = get_user_attribute( get_current_user_id(), 'calypso_preferences' );
		if ( ! empty( $user_attribute['linkDestination'] ) ) {
			$result = $user_attribute['linkDestination'];
		}

		return $result;
	}

	/**
	 * Adds Plugins menu.
	 */
	public function add_plugins_menu() {
		// TODO: Remove wpcom_menu (/wp-content/admin-plugins/wpcom-misc.php).
		$count = '';
		if ( ! is_multisite() && current_user_can( 'update_plugins' ) ) {
			$update_data = wp_get_update_data();
			$count       = sprintf(
				'<span class="update-plugins count-%s"><span class="plugin-count">%s</span></span>',
				$update_data['counts']['plugins'],
				number_format_i18n( $update_data['counts']['plugins'] )
			);
		}
		/* translators: %s: Number of pending plugin updates. */
		add_menu_page( esc_attr__( 'Plugins', 'jetpack' ), sprintf( __( 'Plugins %s', 'jetpack' ), $count ), 'activate_plugins', 'plugins.php', null, 'dashicons-admin-plugins', 65 );

		parent::add_plugins_menu();
	}

	/**
	 * Saves the sidebar state ( expanded / collapsed ) via an ajax request.
	 */
	public function ajax_sidebar_state() {
		$expanded    = isset( $_REQUEST['expanded'] ) ? filter_var( wp_unslash( $_REQUEST['expanded'] ), FILTER_VALIDATE_BOOLEAN ) : false; // phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$user_id     = get_current_user_id();
		$preferences = get_user_attribute( $user_id, 'calypso_preferences' );
		if ( empty( $preferences ) ) {
			$preferences = array();
		}

		$value = array_merge( (array) $preferences, array( 'sidebarCollapsed' => ! $expanded ) );
		$value = array_filter(
			$value,
			function ( $preference ) {
				return null !== $preference;
			}
		);

		update_user_attribute( $user_id, 'calypso_preferences', $value );

		die();
	}

	/**
	 * Handle ajax requests to dismiss a just-in-time-message
	 */
	public function wp_ajax_jitm_dismiss() {
		check_ajax_referer( 'jitm_dismiss' );
		require_lib( 'jetpack-jitm/jitm-engine' );
		if ( isset( $_REQUEST['id'] ) && isset( $_REQUEST['feature_class'] ) ) {
			JITM\Engine::dismiss( sanitize_text_field( wp_unslash( $_REQUEST['id'] ) ), sanitize_text_field( wp_unslash( $_REQUEST['feature_class'] ) ) );
		}
		wp_die();
	}

	/**
	 * Syncs the sidebar collapsed state from Calypso Preferences.
	 */
	public function sync_sidebar_collapsed_state() {
		$calypso_preferences = get_user_attribute( get_current_user_id(), 'calypso_preferences' );

		$sidebar_collapsed = isset( $calypso_preferences['sidebarCollapsed'] ) ? $calypso_preferences['sidebarCollapsed'] : false;

		// Read the current stored setting and convert it to boolean in order to be able to compare the values later.
		$current_sidebar_collapsed_setting = ( 'f' === get_user_setting( 'mfold' ) ) ? true : false;

		// Only set the setting if the value differs, as `set_user_setting` always updates at least the timestamp
		// which leads to unnecessary user meta cache purging on all wp-admin screen requests.
		if ( $current_sidebar_collapsed_setting !== $sidebar_collapsed ) {
			set_user_setting( 'mfold', $sidebar_collapsed ? 'f' : 'o' );
		}
	}

	/**
	 * Removes unwanted submenu items.
	 *
	 * These submenus are added across wp-content and should be removed together with these function calls.
	 */
	public function remove_submenus() {
		global $_registered_pages;

		remove_submenu_page( 'index.php', 'akismet-stats' );
		remove_submenu_page( 'index.php', 'my-comments' );
		remove_submenu_page( 'index.php', 'stats' );
		remove_submenu_page( 'index.php', 'subscriptions' );

		/* @see https://github.com/Automattic/wp-calypso/issues/49210 */
		remove_submenu_page( 'index.php', 'my-blogs' );
		$_registered_pages['admin_page_my-blogs'] = true; // phpcs:ignore

		remove_submenu_page( 'paid-upgrades.php', 'premium-themes' );
		remove_submenu_page( 'paid-upgrades.php', 'domains' );
		remove_submenu_page( 'paid-upgrades.php', 'my-upgrades' );
		remove_submenu_page( 'paid-upgrades.php', 'billing-history' );

		remove_submenu_page( 'themes.php', 'customize.php?autofocus[panel]=amp_panel&return=' . rawurlencode( admin_url() ) );

		remove_submenu_page( 'users.php', 'wpcom-invite-users' ); // Wpcom_Invite_Users::action_admin_menu.

		remove_submenu_page( 'options-general.php', 'adcontrol' );

		// Remove menu item but continue allowing access.
		foreach ( array( 'openidserver', 'webhooks' ) as $page_slug ) {
			remove_submenu_page( 'options-general.php', $page_slug );
			$_registered_pages[ 'admin_page_' . $page_slug ] = true; // phpcs:ignore
		}
	}
}
class-wpcom-email-subscription-checker.php                                                                                                                                                                                                                     483           1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * A class that checks for the existence of email subscriptions for a user.
 *
 * @package automattic/jetpack
 */

/**
 * WPCOM_Email_Subscription_Checker
 */
class WPCOM_Email_Subscription_Checker {

	/**
	 * Checks if a user's site has an email subscription
	 *
	 * @return bool
	 */
	public function has_email() {
		if ( ! function_exists( 'wpcom_site_has_feature' ) ) {
			return false;
		}

		return wpcom_site_has_feature( \WPCOM_Features::EMAIL_SUBSCRIPTION );
	}
}
dashicon-set.php                                                                                                                                                                                                                                               16865         1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Array that contains all the core dashicons.
 *
 * @package automattic/jetpack
 */

return array(
	'dashicons-admin-appearance'          => true,
	'dashicons-admin-collapse'            => true,
	'dashicons-admin-comments'            => true,
	'dashicons-admin-customizer'          => true,
	'dashicons-admin-generic'             => true,
	'dashicons-admin-home'                => true,
	'dashicons-admin-links'               => true,
	'dashicons-admin-media'               => true,
	'dashicons-admin-multisite'           => true,
	'dashicons-admin-network'             => true,
	'dashicons-admin-page'                => true,
	'dashicons-admin-plugins'             => true,
	'dashicons-admin-post'                => true,
	'dashicons-admin-settings'            => true,
	'dashicons-admin-site-alt'            => true,
	'dashicons-admin-site-alt2'           => true,
	'dashicons-admin-site-alt3'           => true,
	'dashicons-admin-site'                => true,
	'dashicons-admin-tools'               => true,
	'dashicons-admin-users'               => true,
	'dashicons-airplane'                  => true,
	'dashicons-album'                     => true,
	'dashicons-align-center'              => true,
	'dashicons-align-full-width'          => true,
	'dashicons-align-left'                => true,
	'dashicons-align-none'                => true,
	'dashicons-align-pull-left'           => true,
	'dashicons-align-pull-right'          => true,
	'dashicons-align-right'               => true,
	'dashicons-align-wide'                => true,
	'dashicons-amazon'                    => true,
	'dashicons-analytics'                 => true,
	'dashicons-archive'                   => true,
	'dashicons-arrow-down-alt'            => true,
	'dashicons-arrow-down-alt2'           => true,
	'dashicons-arrow-down'                => true,
	'dashicons-arrow-left-alt'            => true,
	'dashicons-arrow-left-alt2'           => true,
	'dashicons-arrow-left'                => true,
	'dashicons-arrow-right-alt'           => true,
	'dashicons-arrow-right-alt2'          => true,
	'dashicons-arrow-right'               => true,
	'dashicons-arrow-up-alt'              => true,
	'dashicons-arrow-up-alt2'             => true,
	'dashicons-arrow-up-duplicate'        => true,
	'dashicons-arrow-up'                  => true,
	'dashicons-art'                       => true,
	'dashicons-awards'                    => true,
	'dashicons-backup'                    => true,
	'dashicons-bank'                      => true,
	'dashicons-beer'                      => true,
	'dashicons-bell'                      => true,
	'dashicons-block-default'             => true,
	'dashicons-book-alt'                  => true,
	'dashicons-book'                      => true,
	'dashicons-buddicons-activity'        => true,
	'dashicons-buddicons-bbpress-logo'    => true,
	'dashicons-buddicons-buddypress-logo' => true,
	'dashicons-buddicons-community'       => true,
	'dashicons-buddicons-forums'          => true,
	'dashicons-buddicons-friends'         => true,
	'dashicons-buddicons-groups'          => true,
	'dashicons-buddicons-pm'              => true,
	'dashicons-buddicons-replies'         => true,
	'dashicons-buddicons-topics'          => true,
	'dashicons-buddicons-tracking'        => true,
	'dashicons-building'                  => true,
	'dashicons-businessman'               => true,
	'dashicons-businessperson'            => true,
	'dashicons-businesswoman'             => true,
	'dashicons-button'                    => true,
	'dashicons-calculator'                => true,
	'dashicons-calendar-alt'              => true,
	'dashicons-calendar'                  => true,
	'dashicons-camera-alt'                => true,
	'dashicons-camera'                    => true,
	'dashicons-car'                       => true,
	'dashicons-carrot'                    => true,
	'dashicons-cart'                      => true,
	'dashicons-category'                  => true,
	'dashicons-chart-area'                => true,
	'dashicons-chart-bar'                 => true,
	'dashicons-chart-line'                => true,
	'dashicons-chart-pie'                 => true,
	'dashicons-clipboard'                 => true,
	'dashicons-clock'                     => true,
	'dashicons-cloud-saved'               => true,
	'dashicons-cloud-upload'              => true,
	'dashicons-cloud'                     => true,
	'dashicons-code-standards'            => true,
	'dashicons-coffee'                    => true,
	'dashicons-color-picker'              => true,
	'dashicons-columns'                   => true,
	'dashicons-controls-back'             => true,
	'dashicons-controls-forward'          => true,
	'dashicons-controls-pause'            => true,
	'dashicons-controls-play'             => true,
	'dashicons-controls-repeat'           => true,
	'dashicons-controls-skipback'         => true,
	'dashicons-controls-skipforward'      => true,
	'dashicons-controls-volumeoff'        => true,
	'dashicons-controls-volumeon'         => true,
	'dashicons-cover-image'               => true,
	'dashicons-dashboard'                 => true,
	'dashicons-database-add'              => true,
	'dashicons-database-export'           => true,
	'dashicons-database-import'           => true,
	'dashicons-database-remove'           => true,
	'dashicons-database-view'             => true,
	'dashicons-database'                  => true,
	'dashicons-desktop'                   => true,
	'dashicons-dismiss'                   => true,
	'dashicons-download'                  => true,
	'dashicons-drumstick'                 => true,
	'dashicons-edit-large'                => true,
	'dashicons-edit-page'                 => true,
	'dashicons-edit'                      => true,
	'dashicons-editor-aligncenter'        => true,
	'dashicons-editor-alignleft'          => true,
	'dashicons-editor-alignright'         => true,
	'dashicons-editor-bold'               => true,
	'dashicons-editor-break'              => true,
	'dashicons-editor-code-duplicate'     => true,
	'dashicons-editor-code'               => true,
	'dashicons-editor-contract'           => true,
	'dashicons-editor-customchar'         => true,
	'dashicons-editor-expand'             => true,
	'dashicons-editor-help'               => true,
	'dashicons-editor-indent'             => true,
	'dashicons-editor-insertmore'         => true,
	'dashicons-editor-italic'             => true,
	'dashicons-editor-justify'            => true,
	'dashicons-editor-kitchensink'        => true,
	'dashicons-editor-ltr'                => true,
	'dashicons-editor-ol-rtl'             => true,
	'dashicons-editor-ol'                 => true,
	'dashicons-editor-outdent'            => true,
	'dashicons-editor-paragraph'          => true,
	'dashicons-editor-paste-text'         => true,
	'dashicons-editor-paste-word'         => true,
	'dashicons-editor-quote'              => true,
	'dashicons-editor-removeformatting'   => true,
	'dashicons-editor-rtl'                => true,
	'dashicons-editor-spellcheck'         => true,
	'dashicons-editor-strikethrough'      => true,
	'dashicons-editor-table'              => true,
	'dashicons-editor-textcolor'          => true,
	'dashicons-editor-ul'                 => true,
	'dashicons-editor-underline'          => true,
	'dashicons-editor-unlink'             => true,
	'dashicons-editor-video'              => true,
	'dashicons-ellipsis'                  => true,
	'dashicons-email-alt'                 => true,
	'dashicons-email-alt2'                => true,
	'dashicons-email'                     => true,
	'dashicons-embed-audio'               => true,
	'dashicons-embed-generic'             => true,
	'dashicons-embed-photo'               => true,
	'dashicons-embed-post'                => true,
	'dashicons-embed-video'               => true,
	'dashicons-excerpt-view'              => true,
	'dashicons-exit'                      => true,
	'dashicons-external'                  => true,
	'dashicons-facebook-alt'              => true,
	'dashicons-facebook'                  => true,
	'dashicons-feedback'                  => true,
	'dashicons-filter'                    => true,
	'dashicons-flag'                      => true,
	'dashicons-food'                      => true,
	'dashicons-format-aside'              => true,
	'dashicons-format-audio'              => true,
	'dashicons-format-chat'               => true,
	'dashicons-format-gallery'            => true,
	'dashicons-format-image'              => true,
	'dashicons-format-quote'              => true,
	'dashicons-format-status'             => true,
	'dashicons-format-video'              => true,
	'dashicons-forms'                     => true,
	'dashicons-fullscreen-alt'            => true,
	'dashicons-fullscreen-exit-alt'       => true,
	'dashicons-games'                     => true,
	'dashicons-google'                    => true,
	'dashicons-googleplus'                => true,
	'dashicons-grid-view'                 => true,
	'dashicons-groups'                    => true,
	'dashicons-hammer'                    => true,
	'dashicons-heading'                   => true,
	'dashicons-heart'                     => true,
	'dashicons-hidden'                    => true,
	'dashicons-hourglass'                 => true,
	'dashicons-html'                      => true,
	'dashicons-id-alt'                    => true,
	'dashicons-id'                        => true,
	'dashicons-image-crop'                => true,
	'dashicons-image-filter'              => true,
	'dashicons-image-flip-horizontal'     => true,
	'dashicons-image-flip-vertical'       => true,
	'dashicons-image-rotate-left'         => true,
	'dashicons-image-rotate-right'        => true,
	'dashicons-image-rotate'              => true,
	'dashicons-images-alt'                => true,
	'dashicons-images-alt2'               => true,
	'dashicons-index-card'                => true,
	'dashicons-info-outline'              => true,
	'dashicons-info'                      => true,
	'dashicons-insert-after'              => true,
	'dashicons-insert-before'             => true,
	'dashicons-insert'                    => true,
	'dashicons-instagram'                 => true,
	'dashicons-laptop'                    => true,
	'dashicons-layout'                    => true,
	'dashicons-leftright'                 => true,
	'dashicons-lightbulb'                 => true,
	'dashicons-linkedin'                  => true,
	'dashicons-list-view'                 => true,
	'dashicons-location-alt'              => true,
	'dashicons-location'                  => true,
	'dashicons-lock-duplicate'            => true,
	'dashicons-lock'                      => true,
	'dashicons-marker'                    => true,
	'dashicons-media-archive'             => true,
	'dashicons-media-audio'               => true,
	'dashicons-media-code'                => true,
	'dashicons-media-default'             => true,
	'dashicons-media-document'            => true,
	'dashicons-media-interactive'         => true,
	'dashicons-media-spreadsheet'         => true,
	'dashicons-media-text'                => true,
	'dashicons-media-video'               => true,
	'dashicons-megaphone'                 => true,
	'dashicons-menu-alt'                  => true,
	'dashicons-menu-alt2'                 => true,
	'dashicons-menu-alt3'                 => true,
	'dashicons-menu'                      => true,
	'dashicons-microphone'                => true,
	'dashicons-migrate'                   => true,
	'dashicons-minus'                     => true,
	'dashicons-money-alt'                 => true,
	'dashicons-money'                     => true,
	'dashicons-move'                      => true,
	'dashicons-nametag'                   => true,
	'dashicons-networking'                => true,
	'dashicons-no-alt'                    => true,
	'dashicons-no'                        => true,
	'dashicons-open-folder'               => true,
	'dashicons-palmtree'                  => true,
	'dashicons-paperclip'                 => true,
	'dashicons-pdf'                       => true,
	'dashicons-performance'               => true,
	'dashicons-pets'                      => true,
	'dashicons-phone'                     => true,
	'dashicons-pinterest'                 => true,
	'dashicons-playlist-audio'            => true,
	'dashicons-playlist-video'            => true,
	'dashicons-plugins-checked'           => true,
	'dashicons-plus-alt'                  => true,
	'dashicons-plus-alt2'                 => true,
	'dashicons-plus'                      => true,
	'dashicons-podio'                     => true,
	'dashicons-portfolio'                 => true,
	'dashicons-post-status'               => true,
	'dashicons-pressthis'                 => true,
	'dashicons-printer'                   => true,
	'dashicons-privacy'                   => true,
	'dashicons-products'                  => true,
	'dashicons-randomize'                 => true,
	'dashicons-reddit'                    => true,
	'dashicons-redo'                      => true,
	'dashicons-remove'                    => true,
	'dashicons-rest-api'                  => true,
	'dashicons-rss'                       => true,
	'dashicons-saved'                     => true,
	'dashicons-schedule'                  => true,
	'dashicons-screenoptions'             => true,
	'dashicons-search'                    => true,
	'dashicons-share-alt'                 => true,
	'dashicons-share-alt2'                => true,
	'dashicons-share'                     => true,
	'dashicons-shield-alt'                => true,
	'dashicons-shield'                    => true,
	'dashicons-shortcode'                 => true,
	'dashicons-slides'                    => true,
	'dashicons-smartphone'                => true,
	'dashicons-smiley'                    => true,
	'dashicons-sort'                      => true,
	'dashicons-sos'                       => true,
	'dashicons-spotify'                   => true,
	'dashicons-star-empty'                => true,
	'dashicons-star-filled'               => true,
	'dashicons-star-half'                 => true,
	'dashicons-sticky'                    => true,
	'dashicons-store'                     => true,
	'dashicons-superhero-alt'             => true,
	'dashicons-superhero'                 => true,
	'dashicons-table-col-after'           => true,
	'dashicons-table-col-before'          => true,
	'dashicons-table-col-delete'          => true,
	'dashicons-table-row-after'           => true,
	'dashicons-table-row-before'          => true,
	'dashicons-table-row-delete'          => true,
	'dashicons-tablet'                    => true,
	'dashicons-tag'                       => true,
	'dashicons-tagcloud'                  => true,
	'dashicons-testimonial'               => true,
	'dashicons-text-page'                 => true,
	'dashicons-text'                      => true,
	'dashicons-thumbs-down'               => true,
	'dashicons-thumbs-up'                 => true,
	'dashicons-tickets-alt'               => true,
	'dashicons-tickets'                   => true,
	'dashicons-tide'                      => true,
	'dashicons-translation'               => true,
	'dashicons-trash'                     => true,
	'dashicons-twitch'                    => true,
	'dashicons-twitter-alt'               => true,
	'dashicons-twitter'                   => true,
	'dashicons-undo'                      => true,
	'dashicons-universal-access-alt'      => true,
	'dashicons-universal-access'          => true,
	'dashicons-unlock'                    => true,
	'dashicons-update-alt'                => true,
	'dashicons-update'                    => true,
	'dashicons-upload'                    => true,
	'dashicons-vault'                     => true,
	'dashicons-video-alt'                 => true,
	'dashicons-video-alt2'                => true,
	'dashicons-video-alt3'                => true,
	'dashicons-visibility'                => true,
	'dashicons-warning'                   => true,
	'dashicons-welcome-add-page'          => true,
	'dashicons-welcome-comments'          => true,
	'dashicons-welcome-learn-more'        => true,
	'dashicons-welcome-view-site'         => true,
	'dashicons-welcome-widgets-menus'     => true,
	'dashicons-welcome-write-blog'        => true,
	'dashicons-whatsapp'                  => true,
	'dashicons-wordpress-alt'             => true,
	'dashicons-wordpress'                 => true,
	'dashicons-xing'                      => true,
	'dashicons-yes-alt'                   => true,
	'dashicons-yes'                       => true,
	'dashicons-youtube'                   => true,
	'dashicons-editor-distractionfree'    => true,
	'dashicons-exerpt-view'               => true,
	'dashicons-format-links'              => true,
	'dashicons-format-standard'           => true,
	'dashicons-post-trash'                => true,
	'dashicons-share1'                    => true,
	'dashicons-welcome-edit-page'         => true,
);
globe-icon.svg                                                                                                                                                                                                                                                 501           1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <svg class="gridicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Globe</title><rect fill-opacity="0" x="0" width="24" height="24"/><g><path fill="#fff" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18l2-2 1-1v-2h-2v-1l-1-1H9v3l2 2v1.93c-3.94-.494-7-3.858-7-7.93l1 1h2v-2h2l3-3V6h-2L9 5v-.41C9.927 4.21 10.94 4 12 4s2.073.212 3 .59V6l-1 1v2l1 1 3.13-3.13c.752.897 1.304 1.964 1.606 3.13H18l-2 2v2l1 1h2l.286.286C18.03 18.06 15.24 20 12 20z"/></g></svg>load.php                                                                                                                                                                                                                                                       5931          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Admin Menu loader.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Status\Host;
use Automattic\Jetpack\Tracking;

/**
 * Checks whether the navigation customizations should be performed for the given class.
 *
 * @param string $admin_menu_class Class name.
 *
 * @return bool
 */
function should_customize_nav( $admin_menu_class ) {
	// Make sure the class extends the base admin menu class.
	if ( ! is_subclass_of( $admin_menu_class, Base_Admin_Menu::class ) ) {
		return false;
	}

	$is_api_request = defined( 'REST_REQUEST' ) && REST_REQUEST || isset( $_SERVER['REQUEST_URI'] ) && str_starts_with( filter_var( wp_unslash( $_SERVER['REQUEST_URI'] ) ), '/?rest_route=%2Fwpcom%2Fv2%2Fadmin-menu' );

	// No nav customizations on WP Admin of Atomic sites when SSO is disabled.
	if ( is_a( $admin_menu_class, Atomic_Admin_Menu::class, true ) && ! $is_api_request && ! \Jetpack::is_module_active( 'sso' ) ) {
		return false;
	}

	// No nav customizations on WP Admin of Jetpack sites.
	if ( is_a( $admin_menu_class, Jetpack_Admin_Menu::class, true ) && ! $is_api_request ) {
		return false;
	}

	return true;
}

/**
 * Hides the Customizer menu items when the block theme is active by removing the dotcom-specific actions.
 * They are not needed for block themes.
 *
 * @see https://github.com/Automattic/jetpack/pull/36017
 */
function hide_customizer_menu_on_block_theme() {
	add_action(
		'init',
		function () {
			if ( wp_is_block_theme() && ! is_customize_preview() ) {
				remove_action( 'customize_register', 'add_logotool_button', 20 );
				remove_action( 'customize_register', 'footercredits_register', 99 );
				remove_action( 'customize_register', 'wpcom_disable_customizer_site_icon', 20 );

				if ( class_exists( '\Jetpack_Fonts' ) ) {
					$jetpack_fonts_instance = \Jetpack_Fonts::get_instance();
					remove_action( 'customize_register', array( $jetpack_fonts_instance, 'register_controls' ) );
					remove_action( 'customize_register', array( $jetpack_fonts_instance, 'maybe_prepopulate_option' ), 0 );
				}

				remove_action( 'customize_register', array( 'Jetpack_Fonts_Typekit', 'maybe_override_for_advanced_mode' ), 20 );

				remove_action( 'customize_register', 'Automattic\Jetpack\Dashboard_Customizations\register_css_nudge_control' );

				remove_action( 'customize_register', array( 'Jetpack_Custom_CSS_Enhancements', 'customize_register' ) );
			}
		}
	);
}

/**
 * Gets the name of the class that customizes the admin menu.
 *
 * @return string Class name.
 */
function get_admin_menu_class() {
	hide_customizer_menu_on_block_theme();

	// WordPress.com Atomic sites.
	if ( ( new Host() )->is_woa_site() ) {

		// DIFM Lite In Progress Atomic Sites. Uses the same menu used for domain-only sites.
		// Ignore this check if we are in a support session.
		$is_difm_lite_in_progress = wpcomsh_is_site_sticker_active( 'difm-lite-in-progress' );
		$is_support_session       = defined( 'WPCOM_SUPPORT_SESSION' ) && WPCOM_SUPPORT_SESSION;
		if ( $is_difm_lite_in_progress && ! $is_support_session ) {
			require_once __DIR__ . '/class-domain-only-admin-menu.php';
			return Domain_Only_Admin_Menu::class;
		}

		require_once __DIR__ . '/class-atomic-admin-menu.php';
		return Atomic_Admin_Menu::class;
	}

	// WordPress.com Simple sites.
	if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
		$blog_id = get_current_blog_id();

		// Domain-only sites.
		$blog_options   = get_blog_option( $blog_id, 'options' );
		$is_domain_only = ! empty( $blog_options['is_domain_only'] );
		if ( $is_domain_only ) {
			require_once __DIR__ . '/class-domain-only-admin-menu.php';
			return Domain_Only_Admin_Menu::class;
		}

		// DIFM Lite In Progress Sites. Uses the same menu used for domain-only sites.
		// Ignore this check if we are in a support session.
		$is_difm_lite_in_progress = has_blog_sticker( 'difm-lite-in-progress' );
		$is_support_session       = defined( 'WPCOM_SUPPORT_SESSION' ) && WPCOM_SUPPORT_SESSION;
		if ( $is_difm_lite_in_progress && ! $is_support_session ) {
			require_once __DIR__ . '/class-domain-only-admin-menu.php';
			return Domain_Only_Admin_Menu::class;
		}

		// P2 sites.
		require_once WP_CONTENT_DIR . '/lib/wpforteams/functions.php';
		if ( \WPForTeams\is_wpforteams_site( $blog_id ) ) {
			require_once __DIR__ . '/class-p2-admin-menu.php';
			return P2_Admin_Menu::class;
		}

		// Rest of simple sites.
		require_once __DIR__ . '/class-wpcom-admin-menu.php';
		return WPcom_Admin_Menu::class;
	}

	// Jetpack sites.
	require_once __DIR__ . '/class-jetpack-admin-menu.php';
	return Jetpack_Admin_Menu::class;
}

/**
 * Filters the name of the class that customizes the admin menu. It should extends the `Base_Admin_Menu` class.
 *
 * @module masterbar
 *
 * @since 9.6.0
 *
 * @param string $admin_menu_class Class name.
 */
$admin_menu_class = apply_filters( 'jetpack_admin_menu_class', get_admin_menu_class() );
if ( should_customize_nav( $admin_menu_class ) ) {
	/** The admin menu singleton instance. @var Base_Admin_Menu $instance */
	$admin_menu_class::get_instance();

	/**
	 * Trigger an event when the user uses the dashboard quick switcher.
	 *
	 * @param string $screen The current screen.
	 * @param string $view The view the user choosed to go to.
	 */
	function dashboard_quick_switcher_record_usage( $screen, $view ) {
		require_once __DIR__ . '/class-dashboard-switcher-tracking.php';

		$tracking = new Dashboard_Switcher_Tracking(
			new Tracking( Dashboard_Switcher_Tracking::get_jetpack_tracking_product() ),
			array( Dashboard_Switcher_Tracking::class, 'wpcom_tracks_record_event' ),
			Dashboard_Switcher_Tracking::get_plan()
		);

		$tracking->record_switch_event( $screen, $view );
	}

	\add_action( 'jetpack_dashboard_switcher_changed_view', __NAMESPACE__ . '\dashboard_quick_switcher_record_usage', 10, 2 );
} else {
	\add_filter( 'jetpack_load_admin_menu_class', '__return_false' );
}
menu-mappings.php                                                                                                                                                                                                                                              1679          1711191384  plugins/jetpack/modules/masterbar/admin-menu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Helper mapping between WP Admin pages and WordPress.com
 *
 * @package automattic/jetpack
 */

$common_mappings = array(
	'upload.php'                             => 'https://wordpress.com/media/',
	'edit.php'                               => 'https://wordpress.com/posts/',
	'edit-comments.php'                      => 'https://wordpress.com/comments/',
	'import.php'                             => 'https://wordpress.com/import/',
	'edit.php?post_type=page'                => 'https://wordpress.com/pages/',
	'edit.php?post_type=post'                => 'https://wordpress.com/posts/',
	'users.php'                              => 'https://wordpress.com/people/team/',
	'options-general.php'                    => 'https://wordpress.com/settings/general/',
	'options-discussion.php'                 => 'https://wordpress.com/settings/discussion/',
	'options-reading.php'                    => 'https://wordpress.com/settings/reading/',
	'options-writing.php'                    => 'https://wordpress.com/settings/writing/',
	'themes.php'                             => 'https://wordpress.com/themes/',
	'edit-tags.php?taxonomy=category'        => 'https://wordpress.com/settings/taxonomies/category/',
	'edit-tags.php?taxonomy=post_tag'        => 'https://wordpress.com/settings/taxonomies/post_tag/',
	'edit.php?post_type=jetpack-portfolio'   => 'https://wordpress.com/types/jetpack-portfolio/',
	'edit.php?post_type=jetpack-testimonial' => 'https://wordpress.com/types/jetpack-testimonial/',
);

if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
	// WPCOM Specific mappings.
	$common_mappings['export.php'] = 'https://wordpress.com/export/';
}

return $common_mappings;
class-inline-help.php                                                                                                                                                                                                                                          3056          1711191384  plugins/jetpack/modules/masterbar/inline-help                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Inline Help.
 *
 * Handles providing a LiveChat icon within WPAdmin until such time
 * as the full live chat experience can be run in a non-Calypso environment.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Class Inline_Help.
 */
class Inline_Help {

	/**
	 * Inline_Help constructor.
	 */
	public function __construct() {
		add_action( 'current_screen', array( $this, 'register_actions' ) );
	}

	/**
	 * Registers actions.
	 *
	 * @param object $current_screen Current screen object.
	 * @return void
	 */
	public function register_actions( $current_screen ) {
		// phpcs:disable WordPress.Security.NonceVerification.Recommended
		// Do not inject the FAB icon on embedded screens since the parent window may already contain a FAB icon.
		$is_framed = ! empty( $_GET['frame-nonce'] );

		// Do not inject the FAB icon on Yoast screens to avoid overlap with the Yoast help icon.
		$is_yoast = ! empty( $current_screen->base ) && str_contains( $current_screen->base, '_page_wpseo_' );

		if ( $is_framed || $is_yoast ) {
			return;
		}
		// phpcs:enable WordPress.Security.NonceVerification.Recommended

		add_action( 'admin_footer', array( $this, 'add_fab_icon' ) );

		add_action( 'admin_enqueue_scripts', array( $this, 'add_fab_styles' ) );
	}

	/**
	 * Outputs "FAB" icon markup and SVG.
	 *
	 * @return void|string the HTML markup for the FAB or early exit.
	 */
	public function add_fab_icon() {

		if ( wp_doing_ajax() ) {
			return;
		}

		$svg_allowed = array(
			'svg'   => array(
				'id'              => true,
				'class'           => true,
				'aria-hidden'     => true,
				'aria-labelledby' => true,
				'role'            => true,
				'xmlns'           => true,
				'width'           => true,
				'height'          => true,
				'viewbox'         => true, // <= Must be lower case!
			),
			'g'     => array( 'fill' => true ),
			'title' => array( 'title' => true ),
			'path'  => array(
				'd'    => true,
				'fill' => true,
			),
		);

		$gridicon_help = file_get_contents( __DIR__ . '/gridicon-help.svg', true );

		// Add tracking data to link to be picked up by Calypso for GA and Tracks usage.
		$tracking_href = add_query_arg(
			array(
				'utm_source'  => 'wp_admin',
				'utm_medium'  => 'other',
				'utm_content' => 'jetpack_masterbar_inline_help_click',
				'flags'       => 'a8c-analytics.on',
			),
			'https://wordpress.com/help'
		);

		// phpcs:disable WordPress.Security.EscapeOutput.OutputNotEscaped
		// We trust that output in the template has been escaped.
		echo load_template(
			__DIR__ . '/inline-help-template.php',
			true,
			array(
				'href'        => $tracking_href,
				'icon'        => $gridicon_help,
				'svg_allowed' => $svg_allowed,
			)
		);
		// phpcs:enable WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * Enqueues FAB CSS styles.
	 *
	 * @return void
	 */
	public function add_fab_styles() {
		wp_enqueue_style( 'a8c-faux-inline-help', plugins_url( 'inline-help.css', __FILE__ ), array(), JETPACK__VERSION );
	}
}
gridicon-help.svg                                                                                                                                                                                                                                              418           1711191384  plugins/jetpack/modules/masterbar/inline-help                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="gridicon gridicons-help" height="48" width="48"><svg viewBox="0 0 24 24" id="gridicons-help"><g><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 16h-2v-2h2v2zm0-4.14V15h-2v-2c0-.552.448-1 1-1 1.103 0 2-.897 2-2s-.897-2-2-2-2 .897-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.862-1.278 3.413-3 3.86z"></path></g></svg></svg>inline-help-template.php                                                                                                                                                                                                                                       467           1711191384  plugins/jetpack/modules/masterbar/inline-help                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Inline Help FAB icon template.
 *
 * @package automattic/jetpack
 */

// phpcs:disable VariableAnalysis.CodeAnalysis.VariableAnalysis.UndefinedVariable
?>

<div class="a8c-faux-inline-help">
	<a class="a8c-faux-inline-help__button" href="<?php echo esc_url( $args['href'] ); ?>" target="_blank" rel="noopener noreferrer" title="<?php echo esc_attr__( 'Help', 'jetpack' ); ?>">
		<?php echo wp_kses( $args['icon'], $args['svg_allowed'] ); ?>
	</a>
</div>
inline-help.css                                                                                                                                                                                                                                                2325          1711191384  plugins/jetpack/modules/masterbar/inline-help                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   .a8c-faux-inline-help {
	position: fixed;
	right: 24px;
	bottom: 24px;
	z-index: 9999;
}

.a8c-faux-inline-help .a8c-faux-inline-help__button {
	position: absolute;
	right: 0;
	bottom: 10px; /* push away from WordPress Core footer */
	line-height: 0;
	padding: 1px;
	border-radius: 100%;
	background-color: #1d2327; /* IE11 fallback - Classic Dark */
	background-color: var( --color-primary );
	border: 1px solid #3c434a; /* IE11 fallback - Classic Dark */
	border: 1px solid var( --color-primary-dark );
	transition: all 0.2s ease-in-out;
	overflow: visible;
	width: 40px;
	height: 40px;
	box-sizing: border-box; /* .button component */

	/* elevation() mixin styles */
	box-shadow: 0 4px 5px 0 rgba( 16, 21, 23, 0.14 ),
										0 1px 10px 0 rgba( 16, 21, 23, 0.12 ),
										0 2px 4px -1px rgba( 16, 21, 23, 0.2 ); /* IE11 fallback - Classic Dark */
	box-shadow: 0 4px 5px 0 rgba( var( --color-neutral-100-rgb ), 0.14 ),
										0 1px 10px 0 rgba( var( --color-neutral-100-rgb ), 0.12 ),
										0 2px 4px -1px rgba( var( --color-neutral-100-rgb ), 0.2 );
}

.a8c-faux-inline-help .a8c-faux-inline-help__button::before {
	width: 28px;
	height: 28px;
	display: block;
	position: absolute;
	top: 5px;
	left: 5px;
	content: '';
	background: #ffffff; /* IE11 fallback - Classic Dark */
	background: var( --color-surface );
	border-radius: 100%;
}

.a8c-faux-inline-help .a8c-faux-inline-help__button:focus {
	background-color: #1d2327; /* IE11 fallback - Classic Dark */
	background-color: var( --color-primary );
	box-shadow: 0 0 0 2px #8c8f94; /* IE11 fallback - Classic Dark */
	box-shadow: 0 0 0 2px var( --color-primary-light );
}

.a8c-faux-inline-help .a8c-faux-inline-help__button .gridicon {
	pointer-events: none; /* ensure SVG does not capture click on anchor */
	position: relative;
	fill: #1d2327; /* IE11 fallback - Classic Dark */
	fill: var( --color-primary );
	margin: -3px 0 0 -3px;
	top: 0;
	height: 42px;
	width: 42px;
}

.a8c-faux-inline-help .a8c-faux-inline-help__button .gridicon>use:first-child,
.a8c-faux-inline-help .a8c-faux-inline-help__button .gridicon>g:first-child {
	transform: none;
}

.a8c-faux-inline-help .a8c-faux-inline-help__button:hover:not(.is-active) {
	background: #1d2327; /* IE11 fallback - Classic Dark */
	background: var( --color-primary );
	transform: scale( 1.15 );
}
class-masterbar.php                                                                                                                                                                                                                                            44489         1711191384  plugins/jetpack/modules/masterbar/masterbar                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Masterbar file.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Assets;
use Automattic\Jetpack\Connection\Manager as Connection_Manager;
use Automattic\Jetpack\Current_Plan as Jetpack_Plan;
use Automattic\Jetpack\Device_Detection\User_Agent_Info;
use Automattic\Jetpack\Redirect;
use Automattic\Jetpack\Scan\Admin_Bar_Notice;
use Automattic\Jetpack\Status;
use Automattic\Jetpack\Status\Host;
use GP_Locale;
use GP_Locales;
use Jetpack;
use Jetpack_AMP_Support;
use WP_Admin_Bar;

/**
 * Provides custom admin bar instead of the default WordPress admin bar.
 */
class Masterbar {
	/**
	 * Use for testing changes made to remotely enqueued scripts and styles on your sandbox.
	 * If not set it will default to loading the ones from WordPress.com.
	 *
	 * @var string $sandbox_url
	 */
	private $sandbox_url = '';

	/**
	 * Current locale.
	 *
	 * @var string
	 */
	private $locale;

	/**
	 * WordPress.com user locale of the connected user.
	 *
	 * @var string
	 */
	private $user_locale;

	/**
	 * Current User ID.
	 *
	 * @var int
	 */
	private $user_id;
	/**
	 * WordPress.com user data of the connected user.
	 *
	 * @var array
	 */
	private $user_data;
	/**
	 * WordPress.com username for the connected user.
	 *
	 * @var string
	 */
	private $user_login;
	/**
	 * WordPress.com email address for the connected user.
	 *
	 * @var string
	 */
	private $user_email;
	/**
	 * WordPress.com display name for the connected user.
	 *
	 * @var string
	 */
	private $display_name;
	/**
	 * Site URL sanitized for usage in WordPress.com slugs.
	 *
	 * @var string
	 */
	private $primary_site_slug;
	/**
	 * Site URL displayed in the UI.
	 *
	 * @var string
	 */
	private $primary_site_url;
	/**
	 * Whether the text direction is RTL (based on connected WordPress.com user's interface settings).
	 *
	 * @var boolean
	 */
	private $is_rtl;
	/**
	 * Number of sites owned by connected WordPress.com user.
	 *
	 * @var int
	 */
	private $user_site_count;
	/**
	 * If the site is hosted on WordPress.com on Atomic
	 *
	 * @var bool
	 */
	private $site_woa;

	/**
	 * Constructor
	 */
	public function __construct() {
		$this->user_id      = get_current_user_id();
		$connection_manager = new Connection_Manager( 'jetpack' );

		if ( ! $connection_manager->is_user_connected( $this->user_id ) ) {
			return;
		}

		$this->user_data       = $connection_manager->get_connected_user_data( $this->user_id );
		$this->user_login      = isset( $this->user_data['login'] ) ? $this->user_data['login'] : '';
		$this->user_email      = isset( $this->user_data['email'] ) ? $this->user_data['email'] : '';
		$this->display_name    = isset( $this->user_data['display_name'] ) ? $this->user_data['display_name'] : '';
		$this->user_site_count = isset( $this->user_data['site_count'] ) ? $this->user_data['site_count'] : '';
		$this->is_rtl          = isset( $this->user_data['text_direction'] ) && 'rtl' === $this->user_data['text_direction'];
		$this->user_locale     = isset( $this->user_data['user_locale'] ) ? $this->user_data['user_locale'] : '';
		$this->site_woa        = ( new Host() )->is_woa_site();

		// Store part of the connected user data as user options so it can be used
		// by other files of the masterbar module without making another XMLRPC
		// request. Although `get_connected_user_data` tries to save the data for
		// future uses on a transient, the data is not guaranteed to be cached.
		update_user_option( $this->user_id, 'jetpack_wpcom_is_rtl', $this->is_rtl ? '1' : '0' );
		if ( isset( $this->user_data['use_wp_admin_links'] ) ) {
			update_user_option( $this->user_id, 'jetpack_admin_menu_link_destination', $this->user_data['use_wp_admin_links'] ? '1' : '0' );
		}
		// If Atomic, store and install user locale.
		if ( $this->site_woa && 'wp-admin' !== get_option( 'wpcom_admin_interface' ) ) {
			$this->user_locale = $this->get_jetpack_locale( $this->user_locale );
			$this->install_locale( $this->user_locale );
			$this->unload_non_default_textdomains_on_wpcom_user_locale_switch( $this->user_locale );
			update_user_option( $this->user_id, 'locale', $this->user_locale, true );
		}

		add_action( 'admin_bar_init', array( $this, 'init' ) );

		if ( ! empty( $this->user_data['ID'] ) ) {
			// Post logout on the site, also log the user out of WordPress.com.
			add_filter( 'logout_redirect', array( $this, 'maybe_logout_user_from_wpcom' ) );
		}
	}

	/**
	 * Initialize our masterbar.
	 */
	public function init() {
		$this->locale = $this->get_locale();

		// Don't show the masterbar on WordPress mobile apps.
		if ( User_Agent_Info::is_mobile_app() ) {
			add_filter( 'show_admin_bar', '__return_false' );
			return;
		}

		// Disable the Masterbar on AMP views.
		if (
			class_exists( 'Jetpack_AMP_Support' )
			&& Jetpack_AMP_Support::is_amp_available()
			&& Jetpack_AMP_Support::is_amp_request()
		) {
			return;
		}

		Assets::add_resource_hint(
			array(
				'//s0.wp.com',
				'//0.gravatar.com',
				'//1.gravatar.com',
				'//2.gravatar.com',
			),
			'dns-prefetch'
		);

		// WordPress.com on Atomic only.
		if ( $this->site_woa ) {
			/*
			 * override user setting that hides masterbar from site's front.
			 * https://github.com/Automattic/jetpack/issues/7667
			 */
			add_filter( 'show_admin_bar', '__return_true' );
		}

		// Used to build menu links that point directly to Calypso.
		$this->primary_site_slug = ( new Status() )->get_site_suffix();

		// Used for display purposes and for building WP Admin links.
		$this->primary_site_url = str_replace( '::', '/', $this->primary_site_slug );

		add_filter( 'admin_body_class', array( $this, 'admin_body_class' ) );

		add_action( 'wp_before_admin_bar_render', array( $this, 'replace_core_masterbar' ), 99999 );

		add_action( 'wp_enqueue_scripts', array( $this, 'add_styles_and_scripts' ) );
		add_action( 'admin_enqueue_scripts', array( $this, 'add_styles_and_scripts' ) );

		add_action( 'wp_enqueue_scripts', array( $this, 'remove_core_styles' ) );
		add_action( 'admin_enqueue_scripts', array( $this, 'remove_core_styles' ) );

		if ( Jetpack::is_module_active( 'notes' ) && $this->is_rtl ) {
			// Override Notification module to include RTL styles.
			add_action( 'a8c_wpcom_masterbar_enqueue_rtl_notification_styles', '__return_true' );
		}

		// Hides and replaces the language dropdown for the current user, on WoA.
		if ( $this->site_woa &&
			'wp-admin' !== get_option( 'wpcom_admin_interface' ) &&
			defined( 'IS_PROFILE_PAGE' ) && IS_PROFILE_PAGE ) {
			add_action( 'user_edit_form_tag', array( $this, 'hide_language_dropdown' ) );
			add_action( 'personal_options', array( $this, 'replace_language_dropdown' ), 9 );
		}
	}

	/**
	 * Log out from WordPress.com when logging out of the local site.
	 *
	 * @param string $redirect_to The redirect destination URL.
	 */
	public function maybe_logout_user_from_wpcom( $redirect_to ) {
		/**
		 * Whether we should sign out from wpcom too when signing out from the masterbar.
		 *
		 * @since 5.9.0
		 *
		 * @param bool $masterbar_should_logout_from_wpcom True by default.
		 */
		$masterbar_should_logout_from_wpcom = apply_filters( 'jetpack_masterbar_should_logout_from_wpcom', true );
		if (
			// No need to check for a nonce here, it happens further up.
			isset( $_GET['context'] ) // phpcs:ignore WordPress.Security.NonceVerification.Recommended
			&& 'masterbar' === $_GET['context'] // phpcs:ignore WordPress.Security.NonceVerification.Recommended
			&& $masterbar_should_logout_from_wpcom
		) {
			/**
			 * Hook into the log out event happening from the Masterbar.
			 *
			 * @since 5.1.0
			 * @since 7.9.0 Added the $wpcom_user_id parameter to the action.
			 *
			 * @module masterbar
			 *
			 * @param int $wpcom_user_id WordPress.com User ID.
			 */
			do_action( 'wp_masterbar_logout', $this->user_data['ID'] );
		}

		return $redirect_to;
	}

	/**
	 * Adds CSS classes to admin body tag.
	 *
	 * @since 5.1
	 *
	 * @param string $admin_body_classes CSS classes that will be added.
	 *
	 * @return string
	 */
	public function admin_body_class( $admin_body_classes ) {

		$classes = array( 'jetpack-masterbar', trim( $admin_body_classes ) );

		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			$classes[] = 'wpcom-admin-interface';
		}

		return implode( ' ', $classes );
	}

	/**
	 * Remove the default Admin Bar CSS.
	 */
	public function remove_core_styles() {
		/*
		 * Notifications need the admin bar styles,
		 * so let's not remove them when the module is active.
		 * Also, don't remove the styles if the user has opted to use wp-admin.
		 */
		if ( ! Jetpack::is_module_active( 'notes' ) && get_option( 'wpcom_admin_interface' ) !== 'wp-admin' ) {
			wp_dequeue_style( 'admin-bar' );
		}
	}

	/**
	 * Enqueue our own CSS and JS to display our custom admin bar.
	 */
	public function add_styles_and_scripts() {
		// WoA sites: If wpcom_admin_interface is set to wp-admin, load the wp-admin styles.
		// These include only styles to enable the "My Sites" and "Reader" links that will be added.
		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			$css_file = $this->is_rtl ? 'masterbar-wp-admin-rtl.css' : 'masterbar-wp-admin.css';
			wp_enqueue_style( 'a8c-wpcom-masterbar-overrides', $this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/masterbar-overrides/' . $css_file ), array(), JETPACK__VERSION );
			return;
		}

		if ( $this->is_rtl ) {
			wp_enqueue_style( 'a8c-wpcom-masterbar-rtl', $this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/rtl/wpcom-admin-bar-rtl.css' ), array(), JETPACK__VERSION );
			wp_enqueue_style( 'a8c-wpcom-masterbar-overrides-rtl', $this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/masterbar-overrides/rtl/masterbar-rtl.css' ), array(), JETPACK__VERSION );
		} else {
			wp_enqueue_style( 'a8c-wpcom-masterbar', $this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/wpcom-admin-bar.css' ), array(), JETPACK__VERSION );
			wp_enqueue_style( 'a8c-wpcom-masterbar-overrides', $this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/masterbar-overrides/masterbar.css' ), array(), JETPACK__VERSION );
		}

		// Local overrides.
		wp_enqueue_style( 'a8c_wpcom_css_override', plugins_url( 'overrides.css', __FILE__ ), array(), JETPACK__VERSION );

		if ( ! Jetpack::is_module_active( 'notes ' ) ) {
			// Masterbar is relying on some icons from noticons.css.
			wp_enqueue_style( 'noticons', $this->wpcom_static_url( '/i/noticons/noticons.css' ), array(), JETPACK__VERSION . '-' . gmdate( 'oW' ) );
		}

		wp_enqueue_script(
			'jetpack-accessible-focus',
			Assets::get_file_url_for_environment( '_inc/build/accessible-focus.min.js', '_inc/accessible-focus.js' ),
			array(),
			JETPACK__VERSION,
			false
		);
		wp_enqueue_script(
			'a8c_wpcom_masterbar_tracks_events',
			Assets::get_file_url_for_environment(
				'_inc/build/masterbar/masterbar/tracks-events.min.js',
				'modules/masterbar/masterbar/tracks-events.js'
			),
			array(),
			JETPACK__VERSION,
			false
		);

		wp_enqueue_script(
			'a8c_wpcom_masterbar_overrides',
			$this->wpcom_static_url( '/wp-content/mu-plugins/admin-bar/masterbar-overrides/masterbar.js' ),
			array( 'jquery' ),
			JETPACK__VERSION,
			false
		);
	}

	/**
	 * Get base URL where our CSS and JS will come from.
	 *
	 * @param string $file File path for a static resource.
	 */
	private function wpcom_static_url( $file ) {
		if ( ! empty( $this->sandbox_url ) ) {
			// For testing undeployed changes to remotely enqueued scripts and styles.
			return set_url_scheme( $this->sandbox_url . $file, 'https' );
		}

		$url = 'https://s0.wp.com' . $file;

		return set_url_scheme( $url, 'https' );
	}

	/**
	 * Remove the default admin bar items and replace it with our own admin bar.
	 */
	public function replace_core_masterbar() {
		global $wp_admin_bar;

		if ( ! is_object( $wp_admin_bar ) ) {
			return false;
		}

		if ( get_option( 'wpcom_admin_interface' ) === 'wp-admin' ) {
			$this->build_wp_admin_interface_bar( $wp_admin_bar );
			return;
		}

		$this->clear_core_masterbar( $wp_admin_bar );
		$this->build_wpcom_masterbar( $wp_admin_bar );
	}

	/**
	 * This reorganizes the original wp admin bar for when an atomic site
	 * has the wpcom_admin_interface set to wp-admin.
	 *
	 * The wpcom_admin_interface = wp-admin setting indicates that the users wishes
	 * to NOT use the wpcom master bar. We do need to adjust a couple of things
	 * though.
	 *
	 * @param WP_Admin_Bar $bar The admin bar object.
	 *
	 * @return void
	 */
	protected function build_wp_admin_interface_bar( $bar ) {

		$nodes = array();

		// First, lets gather all nodes and remove them.
		foreach ( $bar->get_nodes() as $node ) {
			$nodes[ $node->id ] = $node;
			$bar->remove_node( $node->id );
		}

		// This disables a submenu from being placed under the My Sites button.
		add_filter( 'jetpack_load_admin_menu_class', '__return_true' );

		// Here we add the My sites and Reader buttons
		$this->wpcom_adminbar_add_secondary_groups( $bar );
		$this->add_my_sites_submenu( $bar );
		$this->add_reader_submenu( $bar );

		foreach ( $nodes as $id => $node ) {

			$bar->add_node( $node );
			// Add our custom node and change the title of the edit profile node.
			if ( 'edit-profile' === $id ) {
				$this->add_wpcom_profile_link( $bar );
				$bar->add_node(
					array(
						'id'    => 'edit-profile',
						'title' => __( 'Site Profile', 'jetpack' ),
					)
				);
			}
		}

		// Add a menu item to the user menu
		// Add a custom link to the user menu.
		$this->add_wpcom_profile_link( $bar );

		// Remove some things
		$bar->remove_node( 'wp-logo' );
	}

	/**
	 * Add a link to the user` profile on WordPress.com
	 *
	 * @param WP_Admin_Bar $bar The admin bar object.
	 *
	 * @return void
	 */
	protected function add_wpcom_profile_link( $bar ) {
		$custom_node = array(
			'parent' => 'user-actions',
			'id'     => 'wpcom-profile-link',
			'title'  => __( 'WordPress.com Profile', 'jetpack' ),
			'href'   => 'https://wordpress.com/me',
			'meta'   => array(
				'title' => __( 'Go to your profile page on WordPress.com', 'jetpack' ), // Optional, tooltip text.
			),
		);

		$bar->add_node( $custom_node );
	}

	/**
	 * Remove all existing toolbar entries from core Masterbar
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function clear_core_masterbar( $wp_admin_bar ) {
		foreach ( $wp_admin_bar->get_nodes() as $node ) {
			$wp_admin_bar->remove_node( $node->id );
		}
	}

	/**
	 * Add entries corresponding to WordPress.com Masterbar
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function build_wpcom_masterbar( $wp_admin_bar ) {
		// Menu groups.
		$this->wpcom_adminbar_add_secondary_groups( $wp_admin_bar );

		// Left part.
		$this->add_my_sites_submenu( $wp_admin_bar );
		$this->add_reader_submenu( $wp_admin_bar );

		// Right part.
		if ( Jetpack::is_module_active( 'notes' ) && ! \Jetpack_Notifications::is_block_editor() ) {
			$this->add_notifications( $wp_admin_bar );
		}

		$this->add_me_submenu( $wp_admin_bar );
		$this->add_write_button( $wp_admin_bar );

		// Recovery mode exit.
		wp_admin_bar_recovery_mode_menu( $wp_admin_bar );

		if ( class_exists( 'Automattic\Jetpack\Scan\Admin_Bar_Notice' ) ) {
			$scan_admin_bar_notice = Admin_Bar_Notice::instance();
			$scan_admin_bar_notice->add_threats_to_toolbar( $wp_admin_bar );
		}
	}

	/**
	 * Get WordPress.com current locale name.
	 */
	public function get_locale() {
		$wpcom_locale = get_locale();

		if ( ! class_exists( 'GP_Locales' ) ) {
			if ( defined( 'JETPACK__GLOTPRESS_LOCALES_PATH' ) && file_exists( JETPACK__GLOTPRESS_LOCALES_PATH ) ) {
				require JETPACK__GLOTPRESS_LOCALES_PATH;
			}
		}

		if ( class_exists( 'GP_Locales' ) ) {
			$wpcom_locale_object = GP_Locales::by_field( 'wp_locale', get_locale() );
			if ( $wpcom_locale_object instanceof GP_Locale ) {
				$wpcom_locale = $wpcom_locale_object->slug;
			}
		}

		return $wpcom_locale;
	}

	/**
	 * Get Jetpack locale name.
	 *
	 * @param  string $slug Locale slug.
	 * @return string Jetpack locale.
	 */
	public function get_jetpack_locale( $slug = '' ) {
		if ( ! class_exists( 'GP_Locales' ) ) {
			if ( defined( 'JETPACK__GLOTPRESS_LOCALES_PATH' ) && file_exists( JETPACK__GLOTPRESS_LOCALES_PATH ) ) {
				require JETPACK__GLOTPRESS_LOCALES_PATH;
			}
		}

		if ( class_exists( 'GP_Locales' ) ) {
			$jetpack_locale_object = GP_Locales::by_field( 'slug', $slug );
			if ( $jetpack_locale_object instanceof GP_Locale ) {
				$jetpack_locale = $jetpack_locale_object->wp_locale ? $jetpack_locale_object->wp_locale : 'en_US';
			}
		}

		if ( isset( $jetpack_locale ) ) {
			return $jetpack_locale;
		}

		return 'en_US';
	}

	/**
	 * Install locale if not yet available.
	 *
	 * @param string $locale The new locale slug.
	 */
	public function install_locale( $locale = '' ) {
		if ( ! in_array( $locale, get_available_languages(), true )
			&& ! empty( $locale ) && current_user_can( 'install_languages' ) ) {

			if ( ! function_exists( 'wp_download_language_pack' ) ) {
				require_once ABSPATH . 'wp-admin/includes/translation-install.php';
			}

			if ( ! function_exists( 'request_filesystem_credentials' ) ) {
				require_once ABSPATH . 'wp-admin/includes/file.php';
			}

			if ( wp_can_install_language_pack() ) {
				wp_download_language_pack( $locale );
				load_default_textdomain( $locale );
			}
		}
	}

	/**
	 * Trigger reloading of all non-default textdomains if the user just changed
	 * their locale on WordPress.com.
	 *
	 * User locale changes on WordPress.com are detected and acted upon in the
	 * constructor of this class. However, at that point, some plugins and their
	 * translations have already been loaded (including Jetpack's). If we don't
	 * reload the translations, the user will see a mix of the old and new locale's
	 * translations until the next page load.
	 *
	 * The default textdomain is not affected by this because it's always reloaded
	 * after all plugins have been loaded, in wp-settings.php.
	 *
	 * @param string $wpcom_locale The user's detected WordPress.com locale.
	 */
	public function unload_non_default_textdomains_on_wpcom_user_locale_switch( $wpcom_locale ) {
		$user_switched_locale = get_user_locale() !== $wpcom_locale;
		if ( ! $user_switched_locale ) {
			return;
		}

		global $l10n;
		$loaded_textdomains      = array_keys( $l10n );
		$non_default_textdomains = array_diff( $loaded_textdomains, array( 'default' ) );
		foreach ( $non_default_textdomains as $textdomain ) {
			// Using $reloadable = true makes sure the correct locale's
			// translations are loaded just-in-time.
			unload_textdomain( $textdomain, true );
		}
	}

	/**
	 * Hide language dropdown on user edit form.
	 */
	public function hide_language_dropdown() {
		add_filter( 'get_available_languages', '__return_empty_array' );
	}

	/**
	 * Replace language dropdown with link to WordPress.com.
	 */
	public function replace_language_dropdown() {
		$language_row  = printf( '<tr class="user-language-wrap"><th scope="row">' );
		$language_row .= printf(
			'<label for="locale">%1$s<span class="dashicons dashicons-translation" aria-hidden="true"></span></label>',
			esc_html__( 'Language', 'jetpack' )
		);
		$language_row .= printf( '</th><td>' );
		$language_row .= printf(
			'<a target="_blank" href="%1$s">%2$s</a>',
			esc_url( 'https://wordpress.com/me/account' ),
			esc_html__( 'Set your profile language on WordPress.com.', 'jetpack' )
		);
		$language_row .= printf( '</td></tr>' );
		return $language_row;
	}

	/**
	 * Add the Notifications menu item.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function add_notifications( $wp_admin_bar ) {
		$wp_admin_bar->add_node(
			array(
				'id'     => 'notes',
				'title'  => '<span id="wpnt-notes-unread-count" class="wpnt-loading wpn-read"></span>
						 <span class="screen-reader-text">' . esc_html__( 'Notifications', 'jetpack' ) . '</span>
						 <span class="noticon noticon-bell"></span>',
				'meta'   => array(
					'html'  => '<div id="wpnt-notes-panel2" style="display:none" lang="' . esc_attr( $this->locale ) . '" dir="' . ( $this->is_rtl ? 'rtl' : 'ltr' ) . '">' .
								'<div class="wpnt-notes-panel-header">' .
								'<span class="wpnt-notes-header">' .
								esc_html__( 'Notifications', 'jetpack' ) .
								'</span>' .
								'<span class="wpnt-notes-panel-link">' .
								'</span>' .
								'</div>' .
								'</div>',
					'class' => 'menupop mb-trackable',
				),
				'parent' => 'top-secondary',
				'href'   => 'https://wordpress.com/notifications',
			)
		);
	}

	/**
	 * Add the "Reader" menu item in the root default group.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function add_reader_submenu( $wp_admin_bar ) {
		$wp_admin_bar->add_menu(
			array(
				'parent' => 'root-default',
				'id'     => 'newdash',
				'title'  => esc_html__( 'Reader', 'jetpack' ),
				'href'   => 'https://wordpress.com/read',
				'meta'   => array(
					'class' => 'mb-trackable',
				),
			)
		);
	}

	/**
	 * Merge 2 menu items together into 2 link tags.
	 *
	 * @param array $primary   Array of menu information.
	 * @param array $secondary Array of menu information.
	 */
	public function create_menu_item_pair( $primary, $secondary ) {
		$primary_class   = 'ab-item ab-primary mb-icon';
		$secondary_class = 'ab-secondary';

		$primary_anchor   = $this->create_menu_item_anchor( $primary_class, $primary['url'], $primary['label'], $primary['id'] );
		$secondary_anchor = $this->create_menu_item_anchor( $secondary_class, $secondary['url'], $secondary['label'], $secondary['id'] );

		return $primary_anchor . $secondary_anchor;
	}

	/**
	 * Create a link tag based on information about a menu item.
	 *
	 * @param string $class Menu item CSS class.
	 * @param string $url   URL you go to when clicking on the menu item.
	 * @param string $label Menu item title.
	 * @param string $id    Menu item slug.
	 */
	public function create_menu_item_anchor( $class, $url, $label, $id ) {
		return '<a href="' . $url . '" class="' . $class . '" id="' . $id . '">' . $label . '</a>';
	}

	/**
	 * Add Secondary groups for submenu items.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function wpcom_adminbar_add_secondary_groups( $wp_admin_bar ) {
		$wp_admin_bar->add_group(
			array(
				'id'   => 'root-default',
				'meta' => array(
					'class' => 'ab-top-menu',
				),
			)
		);

		$wp_admin_bar->add_group(
			array(
				'parent' => 'blog',
				'id'     => 'blog-secondary',
				'meta'   => array(
					'class' => 'ab-sub-secondary',
				),
			)
		);

		$wp_admin_bar->add_group(
			array(
				'id'   => 'top-secondary',
				'meta' => array(
					'class' => 'ab-top-secondary',
				),
			)
		);
	}

	/**
	 * Add User info menu item.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function add_me_submenu( $wp_admin_bar ) {
		$user_id = get_current_user_id();
		if ( empty( $user_id ) ) {
			return;
		}

		$avatar = get_avatar( $this->user_email, 32, 'mm', '', array( 'force_display' => true ) );
		$class  = empty( $avatar ) ? 'mb-trackable' : 'with-avatar mb-trackable';

		// Add the 'Me' menu.
		$wp_admin_bar->add_menu(
			array(
				'id'     => 'my-account',
				'parent' => 'top-secondary',
				'title'  => $avatar . '<span class="ab-text">' . esc_html__( 'Me', 'jetpack' ) . '</span>',
				'href'   => 'https://wordpress.com/me',
				'meta'   => array(
					'class' => $class,
				),
			)
		);

		/** This filter is documented in modules/masterbar.php */
		if ( apply_filters( 'jetpack_load_admin_menu_class', false ) ) {
			return;
		}

		$id = 'user-actions';
		$wp_admin_bar->add_group(
			array(
				'parent' => 'my-account',
				'id'     => $id,
			)
		);

		$logout_url = wp_logout_url();
		$logout_url = add_query_arg( 'context', 'masterbar', $logout_url );

		$user_info  = get_avatar( $this->user_email, 128, 'mm', '', array( 'force_display' => true ) );
		$user_info .= '<span class="display-name">' . $this->display_name . '</span>';
		$user_info .= '<a class="username" href="https://gravatar.com/' . $this->user_login . '">@' . $this->user_login . '</a>';

		$user_info .= sprintf(
			'<div><a href="%s" class="ab-sign-out">%s</a></div>',
			$logout_url,
			esc_html__( 'Sign Out', 'jetpack' )
		);

		$blog_id = Connection_Manager::get_site_id( true );

		$args = array();
		if ( $blog_id ) {
			$args['site'] = $blog_id;
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'user-info',
				'title'  => $user_info,
				'meta'   => array(
					'class'    => 'user-info user-info-item',
					'tabindex' => -1,
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'profile-header',
				'title'  => esc_html__( 'Profile', 'jetpack' ),
				'meta'   => array(
					'class' => 'ab-submenu-header',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'my-profile',
				'title'  => esc_html__( 'My Profile', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me', $args ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'account-settings',
				'title'  => esc_html__( 'Account Settings', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me-account', $args ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'billing',
				'title'  => esc_html__( 'Manage Purchases', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me-purchases', $args ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'security',
				'title'  => esc_html__( 'Security', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me-security', $args ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'notifications',
				'title'  => esc_html__( 'Notifications', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me-notifications', $args ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'special-header',
				'title'  => esc_html_x(
					'Special',
					'Title for Me sub-menu that contains Get Apps, Next Steps, and Help options',
					'jetpack'
				),
				'meta'   => array(
					'class' => 'ab-submenu-header',
				),
			)
		);

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'get-apps',
				'title'  => esc_html__( 'Get Apps', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-me-get-apps', $args ),
				'meta'   => array(
					'class' => 'mb-icon user-info-item',
				),
			)
		);

		$help_link = Redirect::get_url( 'jetpack-support', $args );

		if ( $this->site_woa ) {
			$help_link = Redirect::get_url( 'calypso-help', $args );
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => $id,
				'id'     => 'help',
				'title'  => esc_html__( 'Help', 'jetpack' ),
				'href'   => $help_link,
				'meta'   => array(
					'class' => 'mb-icon user-info-item',
				),
			)
		);
	}

	/**
	 * Add Write Menu item.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function add_write_button( $wp_admin_bar ) {
		$current_user = wp_get_current_user();

		$posting_blog_id = get_current_blog_id();
		if ( ! is_user_member_of_blog( get_current_user_id(), get_current_blog_id() ) ) {
			$posting_blog_id = $current_user->primary_blog;
		}

		$user_can_post = current_user_can_for_blog( $posting_blog_id, 'publish_posts' );

		if ( ! $posting_blog_id || ! $user_can_post ) {
			return;
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => 'top-secondary',
				'id'     => 'ab-new-post',
				'href'   => admin_url( 'post-new.php' ),
				'title'  => '<span>' . esc_html__( 'Write', 'jetpack' ) . '</span>',
				'meta'   => array(
					'class' => 'mb-trackable',
				),
			)
		);
	}

	/**
	 * Add the "My Site" menu item in the root default group.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 */
	public function add_my_sites_submenu( $wp_admin_bar ) {
		$current_user = wp_get_current_user();

		$blog_name = get_bloginfo( 'name' );
		if ( empty( $blog_name ) ) {
			$blog_name = $this->primary_site_slug;
		}

		if ( mb_strlen( $blog_name ) > 20 ) {
			$blog_name = mb_substr( html_entity_decode( $blog_name, ENT_QUOTES ), 0, 20 ) . '&hellip;';
		}

		$my_site_url   = 'https://wordpress.com/sites/' . $this->primary_site_url;
		$my_site_title = _n( 'My Site', 'My Sites', $this->user_site_count, 'jetpack' );
		if ( 'wp-admin' === get_option( 'wpcom_admin_interface' ) ) {
			$my_site_url   = 'https://wordpress.com/sites';
			$my_site_title = esc_html__( 'My Sites', 'jetpack' );
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => 'root-default',
				'id'     => 'blog',
				'title'  => $my_site_title,
				'href'   => $my_site_url,
				'meta'   => array(
					'class' => 'my-sites mb-trackable',
				),
			)
		);

		/** This filter is documented in modules/masterbar.php */
		if ( apply_filters( 'jetpack_load_admin_menu_class', false ) ) {
			return;
		}

		$blog_id = Connection_Manager::get_site_id( true );

		$args = array();
		if ( $blog_id ) {
			$args['site'] = $blog_id;
		}

		if ( $this->user_site_count > 1 ) {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'switch-site',
					'title'  => esc_html__( 'Switch Site', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-sites', $args ),
				)
			);
		} else {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'new-site',
					'title'  => esc_html__( '+ Add New WordPress', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-start', array_merge( $args, array( 'query' => 'ref=admin-bar-logged-in' ) ) ),
				)
			);
		}

		if ( is_user_member_of_blog( $current_user->ID ) ) {
			$blavatar = '';
			$class    = 'current-site';

			if ( has_site_icon() ) {
				$src      = get_site_icon_url();
				$blavatar = '<img class="avatar" src="' . esc_attr( $src ) . '" alt="Current site avatar">';
				$class    = 'has-blavatar';
			}

			$blog_info  = '<div class="ab-site-icon">' . $blavatar . '</div>';
			$blog_info .= '<span class="ab-site-title">' . esc_html( $blog_name ) . '</span>';
			$blog_info .= '<span class="ab-site-description">' . esc_html( $this->primary_site_url ) . '</span>';

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'blog-info',
					'title'  => $blog_info,
					'href'   => esc_url( trailingslashit( $this->primary_site_url ) ),
					'meta'   => array(
						'class' => $class,
					),
				)
			);
		}

		// Site Preview.
		if ( is_admin() ) {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'site-view',
					'title'  => __( 'View Site', 'jetpack' ),
					'href'   => home_url(),
					'meta'   => array(
						'class'  => 'mb-icon',
						'target' => '_blank',
					),
				)
			);
		}

		$this->add_my_home_submenu_item( $wp_admin_bar );

		// Stats.
		if ( Jetpack::is_module_active( 'stats' ) && current_user_can( 'view_stats' ) ) {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'blog-stats',
					'title'  => esc_html__( 'Stats', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-stats', $args ),
					'meta'   => array(
						'class' => 'mb-icon',
					),
				)
			);
		}

		if ( current_user_can( 'manage_options' ) ) {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'activity',
					'title'  => esc_html__( 'Activity', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-activity-log', $args ),
					'meta'   => array(
						'class' => 'mb-icon',
					),
				)
			);
		}

		// Add Calypso plans link and plan type indicator.
		if ( is_user_member_of_blog( $current_user->ID ) && current_user_can( 'manage_options' ) ) {
			$plans_url = Redirect::get_url( 'calypso-plans', $args );
			$label     = esc_html__( 'Plan', 'jetpack' );
			$plan      = Jetpack_Plan::get();

			$plan_title = $this->create_menu_item_pair(
				array(
					'url'   => $plans_url,
					'id'    => 'wp-admin-bar-plan',
					'label' => $label,
				),
				array(
					'url'   => $plans_url,
					'id'    => 'wp-admin-bar-plan-badge',
					'label' => ! empty( $plan['product_name_short'] ) ? $plan['product_name_short'] : esc_html__( 'Free', 'jetpack' ),
				)
			);

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'blog',
					'id'     => 'plan',
					'title'  => $plan_title,
					'meta'   => array(
						'class' => 'inline-action',
					),
				)
			);
		}

		// Publish group.
		$wp_admin_bar->add_group(
			array(
				'parent' => 'blog',
				'id'     => 'publish',
			)
		);

		// Publish header.
		$wp_admin_bar->add_menu(
			array(
				'parent' => 'publish',
				'id'     => 'publish-header',
				'title'  => esc_html_x( 'Manage', 'admin bar menu group label', 'jetpack' ),
				'meta'   => array(
					'class' => 'ab-submenu-header',
				),
			)
		);

		// Pages.
		$pages_title = $this->create_menu_item_pair(
			array(
				'url'   => Redirect::get_url( 'calypso-edit-pages', $args ),
				'id'    => 'wp-admin-bar-edit-page',
				'label' => esc_html__( 'Site Pages', 'jetpack' ),
			),
			array(
				'url'   => Redirect::get_url( 'calypso-edit-page', $args ),
				'id'    => 'wp-admin-bar-new-page-badge',
				'label' => esc_html_x( 'Add', 'admin bar menu new item label', 'jetpack' ),
			)
		);

		if ( ! current_user_can( 'edit_pages' ) ) {
			$pages_title = $this->create_menu_item_anchor(
				'ab-item ab-primary mb-icon',
				Redirect::get_url( 'calypso-edit-pages', $args ),
				esc_html__( 'Site Pages', 'jetpack' ),
				'wp-admin-bar-edit-page'
			);
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => 'publish',
				'id'     => 'new-page',
				'title'  => $pages_title,
				'meta'   => array(
					'class' => 'inline-action',
				),
			)
		);

		// Blog Posts.
		$posts_title = $this->create_menu_item_pair(
			array(
				'url'   => Redirect::get_url( 'calypso-edit-posts', $args ),
				'id'    => 'wp-admin-bar-edit-post',
				'label' => esc_html__( 'Blog Posts', 'jetpack' ),
			),
			array(
				'url'   => Redirect::get_url( 'calypso-edit-post', $args ),
				'id'    => 'wp-admin-bar-new-post-badge',
				'label' => esc_html_x( 'Add', 'admin bar menu new item label', 'jetpack' ),
			)
		);

		if ( ! current_user_can( 'edit_posts' ) ) {
			$posts_title = $this->create_menu_item_anchor(
				'ab-item ab-primary mb-icon',
				Redirect::get_url( 'calypso-edit-posts', $args ),
				esc_html__( 'Blog Posts', 'jetpack' ),
				'wp-admin-bar-edit-post'
			);
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => 'publish',
				'id'     => 'new-post',
				'title'  => $posts_title,
				'meta'   => array(
					'class' => 'inline-action mb-trackable',
				),
			)
		);

		// Comments.
		if ( current_user_can( 'moderate_comments' ) ) {
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'publish',
					'id'     => 'comments',
					'title'  => __( 'Comments', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-comments', $args ),
					'meta'   => array(
						'class' => 'mb-icon',
					),
				)
			);
		}

		// Testimonials.
		if ( Jetpack::is_module_active( 'custom-content-types' ) && get_option( 'jetpack_testimonial' ) ) {
			$testimonials_title = $this->create_menu_item_pair(
				array(
					'url'   => Redirect::get_url( 'calypso-list-jetpack-testimonial', $args ),
					'id'    => 'wp-admin-bar-edit-testimonial',
					'label' => esc_html__( 'Testimonials', 'jetpack' ),
				),
				array(
					'url'   => Redirect::get_url( 'calypso-edit-jetpack-testimonial', $args ),
					'id'    => 'wp-admin-bar-new-testimonial',
					'label' => esc_html_x( 'Add', 'Button label for adding a new item via the toolbar menu', 'jetpack' ),
				)
			);

			if ( ! current_user_can( 'edit_pages' ) ) {
				$testimonials_title = $this->create_menu_item_anchor(
					'ab-item ab-primary mb-icon',
					Redirect::get_url( 'calypso-list-jetpack-testimonial', $args ),
					esc_html__( 'Testimonials', 'jetpack' ),
					'wp-admin-bar-edit-testimonial'
				);
			}

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'publish',
					'id'     => 'new-jetpack-testimonial',
					'title'  => $testimonials_title,
					'meta'   => array(
						'class' => 'inline-action',
					),
				)
			);
		}

		// Portfolio.
		if ( Jetpack::is_module_active( 'custom-content-types' ) && get_option( 'jetpack_portfolio' ) ) {
			$portfolios_title = $this->create_menu_item_pair(
				array(
					'url'   => Redirect::get_url( 'calypso-list-jetpack-portfolio', $args ),
					'id'    => 'wp-admin-bar-edit-portfolio',
					'label' => esc_html__( 'Portfolio', 'jetpack' ),
				),
				array(
					'url'   => Redirect::get_url( 'calypso-edit-jetpack-portfolio', $args ),
					'id'    => 'wp-admin-bar-new-portfolio',
					'label' => esc_html_x( 'Add', 'Button label for adding a new item via the toolbar menu', 'jetpack' ),
				)
			);

			if ( ! current_user_can( 'edit_pages' ) ) {
				$portfolios_title = $this->create_menu_item_anchor(
					'ab-item ab-primary mb-icon',
					Redirect::get_url( 'calypso-list-jetpack-portfolio', $args ),
					esc_html__( 'Portfolio', 'jetpack' ),
					'wp-admin-bar-edit-portfolio'
				);
			}

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'publish',
					'id'     => 'new-jetpack-portfolio',
					'title'  => $portfolios_title,
					'meta'   => array(
						'class' => 'inline-action',
					),
				)
			);
		}

		if ( current_user_can( 'edit_theme_options' ) ) {
			// Look and Feel group.
			$wp_admin_bar->add_group(
				array(
					'parent' => 'blog',
					'id'     => 'look-and-feel',
				)
			);

			// Look and Feel header.
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'look-and-feel',
					'id'     => 'look-and-feel-header',
					'title'  => esc_html_x( 'Personalize', 'admin bar menu group label', 'jetpack' ),
					'meta'   => array(
						'class' => 'ab-submenu-header',
					),
				)
			);

			$request_uri = isset( $_SERVER['REQUEST_URI'] ) ? filter_var( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
			if ( is_admin() ) {
				// In wp-admin the `return` query arg will return to that page after closing the Customizer.
				$customizer_url = add_query_arg(
					array(
						'return' => rawurlencode( site_url( $request_uri ) ),
					),
					wp_customize_url()
				);
			} else {
				/*
				 * On the frontend the `url` query arg will load that page in the Customizer
				 * and also return to it after closing
				 * non-home URLs won't work unless we undo domain mapping
				 * since the Customizer preview is unmapped to always have HTTPS.
				 */
				$current_page   = '//' . $this->primary_site_slug . $request_uri;
				$customizer_url = add_query_arg( array( 'url' => rawurlencode( $current_page ) ), wp_customize_url() );
			}

			$theme_title = $this->create_menu_item_pair(
				array(
					'url'   => $customizer_url,
					'id'    => 'wp-admin-bar-cmz',
					'label' => esc_html_x( 'Customize', 'admin bar customize item label', 'jetpack' ),
				),
				array(
					'url'   => Redirect::get_url( 'calypso-themes', $args ),
					'id'    => 'wp-admin-bar-themes',
					'label' => esc_html__( 'Themes', 'jetpack' ),
				)
			);
			$meta        = array(
				'class' => 'mb-icon inline-action',
			);
			$href        = false;

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'look-and-feel',
					'id'     => 'themes',
					'title'  => $theme_title,
					'href'   => $href,
					'meta'   => $meta,
				)
			);
		}

		if ( current_user_can( 'manage_options' ) ) {
			// Configuration group.
			$wp_admin_bar->add_group(
				array(
					'parent' => 'blog',
					'id'     => 'configuration',
				)
			);

			// Configuration header.
			$wp_admin_bar->add_menu(
				array(
					'parent' => 'configuration',
					'id'     => 'configuration-header',
					'title'  => esc_html_x( 'Configure', 'admin bar menu group label', 'jetpack' ),
					'meta'   => array(
						'class' => 'ab-submenu-header',
					),
				)
			);

			if ( Jetpack::is_module_active( 'publicize' ) || Jetpack::is_module_active( 'sharedaddy' ) ) {
				$wp_admin_bar->add_menu(
					array(
						'parent' => 'configuration',
						'id'     => 'sharing',
						'title'  => esc_html__( 'Sharing', 'jetpack' ),
						'href'   => Redirect::get_url( 'calypso-sharing', $args ),
						'meta'   => array(
							'class' => 'mb-icon',
						),
					)
				);
			}

			$people_title = $this->create_menu_item_pair(
				array(
					'url'   => Redirect::get_url( 'calypso-people-team', $args ),
					'id'    => 'wp-admin-bar-people',
					'label' => esc_html__( 'People', 'jetpack' ),
				),
				array(
					'url'   => admin_url( 'user-new.php' ),
					'id'    => 'wp-admin-bar-people-add',
					'label' => esc_html_x( 'Add', 'admin bar people item label', 'jetpack' ),
				)
			);

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'configuration',
					'id'     => 'users-toolbar',
					'title'  => $people_title,
					'href'   => false,
					'meta'   => array(
						'class' => 'inline-action',
					),
				)
			);

			$plugins_title = $this->create_menu_item_pair(
				array(
					'url'   => Redirect::get_url( 'calypso-plugins', $args ),
					'id'    => 'wp-admin-bar-plugins',
					'label' => esc_html__( 'Plugins', 'jetpack' ),
				),
				array(
					'url'   => Redirect::get_url( 'calypso-plugins-manage', $args ),
					'id'    => 'wp-admin-bar-plugins-add',
					'label' => esc_html_x( 'Manage', 'Label for the button on the Masterbar to manage plugins', 'jetpack' ),
				)
			);

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'configuration',
					'id'     => 'plugins',
					'title'  => $plugins_title,
					'href'   => false,
					'meta'   => array(
						'class' => 'inline-action',
					),
				)
			);

			if ( $this->site_woa ) {
				$domain_title = $this->create_menu_item_pair(
					array(
						'url'   => Redirect::get_url( 'calypso-domains', $args ),
						'id'    => 'wp-admin-bar-domains',
						'label' => esc_html__( 'Domains', 'jetpack' ),
					),
					array(
						'url'   => Redirect::get_url( 'calypso-domains-add', $args ),
						'id'    => 'wp-admin-bar-domains-add',
						'label' => esc_html_x( 'Add', 'Label for the button on the Masterbar to add a new domain', 'jetpack' ),
					)
				);
				$wp_admin_bar->add_menu(
					array(
						'parent' => 'configuration',
						'id'     => 'domains',
						'title'  => $domain_title,
						'href'   => false,
						'meta'   => array(
							'class' => 'inline-action',
						),
					)
				);
			}

			$wp_admin_bar->add_menu(
				array(
					'parent' => 'configuration',
					'id'     => 'blog-settings',
					'title'  => esc_html__( 'Settings', 'jetpack' ),
					'href'   => Redirect::get_url( 'calypso-settings-general', $args ),
					'meta'   => array(
						'class' => 'mb-icon',
					),
				)
			);

			if ( ! is_admin() ) {
				$wp_admin_bar->add_menu(
					array(
						'parent' => 'configuration',
						'id'     => 'legacy-dashboard',
						'title'  => esc_html__( 'Dashboard', 'jetpack' ),
						'href'   => admin_url(),
						'meta'   => array(
							'class' => 'mb-icon',
						),
					)
				);
			}

			// Restore dashboard menu toggle that is needed on mobile views.
			if ( is_admin() ) {
				$wp_admin_bar->add_menu(
					array(
						'id'    => 'menu-toggle',
						'title' => '<span class="ab-icon"></span><span class="screen-reader-text">' . esc_html__( 'Menu', 'jetpack' ) . '</span>',
						'href'  => '#',
					)
				);
			}

			/**
			 * Fires when menu items are added to the masterbar "My Sites" menu.
			 *
			 * @since 5.4.0
			 */
			do_action( 'jetpack_masterbar' );
		}
	}

	/**
	 * Adds "My Home" submenu item to sites that are eligible.
	 *
	 * @param WP_Admin_Bar $wp_admin_bar Admin Bar instance.
	 * @return void
	 */
	private function add_my_home_submenu_item( &$wp_admin_bar ) {
		if ( ! current_user_can( 'manage_options' ) || ! $this->site_woa ) {
			return;
		}

		$wp_admin_bar->add_menu(
			array(
				'parent' => 'blog',
				'id'     => 'my-home',
				'title'  => __( 'My Home', 'jetpack' ),
				'href'   => Redirect::get_url( 'calypso-home' ),
				'meta'   => array(
					'class' => 'mb-icon',
				),
			)
		);
	}
}
overrides.css                                                                                                                                                                                                                                                  5854          1711191384  plugins/jetpack/modules/masterbar/masterbar                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /* Remove min-height from menu elements that was causing them to render incorrectly */
.my-sites li {
    min-height: unset !important;
}

/* Overwrite a core style which breaks the overflow for .my-sites in Safari */
#wpadminbar li.menupop.my-sites {
	overflow: visible;
}

/* Add a focus style for menu items */
.accessible-focus #wpadminbar li.menupop a.ab-item:focus,
.accessible-focus #wpadminbar li#wp-admin-bar-notes.menupop .ab-item:focus,
.accessible-focus #wpadminbar ul li#wp-admin-bar-ab-new-post a:focus {
	-webkit-box-shadow: inset  2px  2px 0 #668eaa,
	                    inset -2px -2px 0 #668eaa;
	box-shadow: inset  2px  2px 0 #668eaa,
	            inset -2px -2px 0 #668eaa;
}

/* Menu items in panels are inside `ab-empty-item` */
.accessible-focus #wpadminbar li.menupop .ab-empty-item a.ab-item:focus,
.accessible-focus #wpadminbar li.menupop .ab-empty-item a.ab-secondary:focus,
.accessible-focus #wpadminbar li.menupop .ab-empty-item a.username:focus {
	-webkit-box-shadow: inset  2px  2px 0 #2e4354,
						inset -2px -2px 0 #2e4354;
	box-shadow: inset  2px  2px 0 #2e4354,
				inset -2px -2px 0 #2e4354;
}

.accessible-focus #wpadminbar .quicklinks li#wp-admin-bar-my-account #wp-admin-bar-user-info .ab-sign-out:focus {
	-webkit-box-shadow: inset  2px  2px 0 #2e4354,
						inset -2px -2px 0 #2e4354 !important;
	box-shadow: inset  2px  2px 0 #2e4354,
				inset -2px -2px 0 #2e4354 !important;
}

.accessible-focus #wpadminbar:not(.mobile) .ab-top-menu > li > .ab-item:focus {
	background: transparent;
}

/* Hide the panels initially */
#wpadminbar li#wp-admin-bar-blog.menupop > .ab-sub-wrapper, /* My Sites */
#wpadminbar li#wp-admin-bar-newdash.menupop > .ab-sub-wrapper, /* Reader */
#wpadminbar li#wp-admin-bar-my-account.menupop > .ab-sub-wrapper, /* Me */
#wpadminbar li#wp-admin-bar-notes.menupop > #wpnt-notes-panel2 { /* Notifications */
	display: block !important;
}

/* Change notification icon the match the one on WP.com */
#wp-admin-bar-notes .noticon-bell:before {
    content: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cmVjdCB4PSIwIiBmaWxsPSJub25lIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiLz48Zz48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNNi4xNCAxNC45N2wyLjgyOCAyLjgyN2MtLjM2Mi4zNjItLjg2Mi41ODYtMS40MTQuNTg2LTEuMTA1IDAtMi0uODk1LTItMiAwLS41NTIuMjI0LTEuMDUyLjU4Ni0xLjQxNHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRjMi4zNC0yLjM0IDYuMTM1LTIuMzQgOC40NzUgMHMyLjM0IDYuMTM1IDAgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N2wuMTU3IDEuMXoiLz48L2c+PC9zdmc+") !important;
}
#wp-admin-bar-notes.active .noticon-bell:before {
    content: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cmVjdCB4PSIwIiBmaWxsPSJub25lIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiLz48Zz48cGF0aCBmaWxsPSIjMjMyODJkIiBkPSJNNi4xNCAxNC45N2wyLjgyOCAyLjgyN2MtLjM2Mi4zNjItLjg2Mi41ODYtMS40MTQuNTg2LTEuMTA1IDAtMi0uODk1LTItMiAwLS41NTIuMjI0LTEuMDUyLjU4Ni0xLjQxNHptOC44NjcgNS4zMjRMMTQuMyAyMSAzIDkuN2wuNzA2LS43MDcgMS4xMDIuMTU3Yy43NTQuMTA4IDEuNjktLjEyMiAyLjA3Ny0uNTFsMy44ODUtMy44ODRjMi4zNC0yLjM0IDYuMTM1LTIuMzQgOC40NzUgMHMyLjM0IDYuMTM1IDAgOC40NzVsLTMuODg1IDMuODg2Yy0uMzg4LjM4OC0uNjE4IDEuMzIzLS41MSAyLjA3N2wuMTU3IDEuMXoiLz48L2c+PC9zdmc+") !important;
}

/* Fit width of sign out button to content */
#wpadminbar .quicklinks li#wp-admin-bar-my-account #wp-admin-bar-user-info .ab-sign-out {
	display: inline-block;
}

/* Move the admin menu toggle in Gutenberg - https://github.com/Automattic/jetpack/issues/12320 */
.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar #wp-admin-bar-ab-new-post {
	display: none;
}

.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar #wp-admin-bar-menu-toggle {
	top: -4px;
	position: relative;
}

.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar #wp-admin-bar-menu-toggle .ab-icon:before {
	color: #fff !important;
	font-size: 28px;
}

.jetpack-masterbar #wpadminbar #wp-admin-bar-recovery-mode {
	background-color: #d63638;
	color: #fff;
	margin-right: 1em;
}
#wpadminbar #wp-admin-bar-jetpack-scan-notice {
	margin-right: 1em;
}
@media screen and (max-width: 959px ) {
	#wpadminbar #wp-admin-bar-jetpack-scan-notice {
		width:32px;
	}
	#wpadminbar #wp-admin-bar-jetpack-scan-notice a { color: transparent!important;}
}

@media screen and (max-width: 480px) {
	.jetpack-masterbar.post-new-php.block-editor-page #wp-toolbar ul li {
		flex: 1;
		width: auto !important;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar ul#wp-admin-bar-root-default {
		width: 60%;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar ul#wp-admin-bar-top-secondary {
		width: 40%;
	}

	.wp-admin.jetpack-masterbar.post-new-php.block-editor-page .wp-responsive-open #wpadminbar #wp-admin-bar-menu-toggle {
		left: 0;
	}
}

@media screen and (max-width: 782px) {
	.wp-admin.jetpack-masterbar.post-new-php.block-editor-page .wp-responsive-open #wpadminbar #wp-admin-bar-menu-toggle {
		left: 0 !important;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wp-toolbar,
	.jetpack-masterbar.post-new-php.block-editor-page #wp-toolbar ul {
		display: flex;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar ul#wp-admin-bar-root-default {
		flex-grow: 1;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar li#wp-admin-bar-menu-toggle {
		order: 1;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar li#wp-admin-bar-blog {
		order: 2;
	}

	.jetpack-masterbar.post-new-php.block-editor-page #wpadminbar li#wp-admin-bar-newdash {
		order: 3;
	}

	#wpadminbar #wp-admin-bar-jetpack-scan-notice,
	.jetpack-masterbar #wpadminbar #wp-admin-bar-recovery-mode {
		display: none;
	}
}
tracks-events.js                                                                                                                                                                                                                                               6687          1711191384  plugins/jetpack/modules/masterbar/masterbar                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( function () {
	'use strict';

	var eventName = 'masterbar_click';

	var linksTracksEvents = {
		//top level items
		'wp-admin-bar-blog': 'my_sites',
		'wp-admin-bar-newdash': 'reader',
		'wp-admin-bar-ab-new-post': 'write_button',
		'wp-admin-bar-my-account': 'my_account',
		'wp-admin-bar-notes': 'notifications',
		//my sites - top items
		'wp-admin-bar-switch-site': 'my_sites_switch_site',
		'wp-admin-bar-blog-info': 'my_sites_blog_info',
		'wp-admin-bar-site-view': 'my_sites_view_site',
		'wp-admin-bar-my-home': 'my_sites_my_home',
		'wp-admin-bar-blog-stats': 'my_sites_blog_stats',
		'wp-admin-bar-activity': 'my_sites_activity',
		'wp-admin-bar-plan': 'my_sites_plan',
		'wp-admin-bar-plan-badge': 'my_sites_plan_badge',
		//my sites - manage
		'wp-admin-bar-edit-page': 'my_sites_manage_site_pages',
		'wp-admin-bar-new-page-badge': 'my_sites_manage_add_page',
		'wp-admin-bar-edit-post': 'my_sites_manage_blog_posts',
		'wp-admin-bar-new-post-badge': 'my_sites_manage_add_new_post',
		'wp-admin-bar-edit-attachment': 'my_sites_manage_media',
		'wp-admin-bar-new-attachment-badge': 'my_sites_manage_add_media',
		'wp-admin-bar-comments': 'my_sites_manage_comments',
		'wp-admin-bar-edit-testimonial': 'my_sites_manage_testimonials',
		'wp-admin-bar-new-testimonial': 'my_sites_manage_add_testimonial',
		'wp-admin-bar-edit-portfolio': 'my_sites_manage_portfolio',
		'wp-admin-bar-new-portfolio': 'my_sites_manage_add_portfolio',
		//my sites - personalize
		'wp-admin-bar-themes': 'my_sites_personalize_themes',
		'wp-admin-bar-cmz': 'my_sites_personalize_themes_customize',
		//my sites - configure
		'wp-admin-bar-sharing': 'my_sites_configure_sharing',
		'wp-admin-bar-people': 'my_sites_configure_people',
		'wp-admin-bar-people-add': 'my_sites_configure_people_add_button',
		'wp-admin-bar-plugins': 'my_sites_configure_plugins',
		'wp-admin-bar-plugins-add': 'my_sites_configure_manage_plugins',
		'wp-admin-bar-blog-settings': 'my_sites_configure_settings',
		//reader
		'wp-admin-bar-followed-sites': 'reader_followed_sites',
		'wp-admin-bar-reader-followed-sites-manage': 'reader_manage_followed_sites',
		'wp-admin-bar-discover-discover': 'reader_discover',
		'wp-admin-bar-discover-search': 'reader_search',
		'wp-admin-bar-my-activity-my-likes': 'reader_my_likes',
		//account
		'wp-admin-bar-user-info': 'my_account_user_name',
		// account - profile
		'wp-admin-bar-my-profile': 'my_account_profile_my_profile',
		'wp-admin-bar-account-settings': 'my_account_profile_account_settings',
		'wp-admin-bar-billing': 'my_account_profile_manage_purchases',
		'wp-admin-bar-security': 'my_account_profile_security',
		'wp-admin-bar-notifications': 'my_account_profile_notifications',
		//account - special
		'wp-admin-bar-get-apps': 'my_account_special_get_apps',
		'wp-admin-bar-next-steps': 'my_account_special_next_steps',
		'wp-admin-bar-help': 'my_account_special_help',
	};

	var notesTracksEvents = {
		openSite: function ( data ) {
			return {
				clicked: 'masterbar_notifications_panel_site',
				site_id: data.siteId,
			};
		},
		openPost: function ( data ) {
			return {
				clicked: 'masterbar_notifications_panel_post',
				site_id: data.siteId,
				post_id: data.postId,
			};
		},
		openComment: function ( data ) {
			return {
				clicked: 'masterbar_notifications_panel_comment',
				site_id: data.siteId,
				post_id: data.postId,
				comment_id: data.commentId,
			};
		},
	};

	function parseJson( s, defaultValue ) {
		try {
			return JSON.parse( s );
		} catch ( e ) {
			return defaultValue;
		}
	}

	// Element.prototype.matches as a standalone function, with old browser fallback
	function matches( node, selector ) {
		if ( ! node ) {
			return undefined;
		}

		if ( ! Element.prototype.matches && ! Element.prototype.msMatchesSelector ) {
			throw new Error( 'Unsupported browser' );
		}

		return Element.prototype.matches
			? node.matches( selector )
			: node.msMatchesSelector( selector );
	}

	// Element.prototype.closest as a standalone function, with old browser fallback
	function closest( node, selector ) {
		if ( ! node ) {
			return undefined;
		}

		if ( Element.prototype.closest ) {
			return node.closest( selector );
		}

		do {
			if ( matches( node, selector ) ) {
				return node;
			}

			node = node.parentElement || node.parentNode;
		} while ( node !== null && node.nodeType === 1 );

		return null;
	}

	function createTrackableLinkEventHandler() {
		return function ( e ) {
			if ( ! window.jpTracksAJAX || typeof window.jpTracksAJAX.record_ajax_event !== 'function' ) {
				return;
			}

			var target = e.target;
			var parent = closest( target, 'li' );

			if ( ! matches( target, 'a' ) ) {
				target = closest( target, 'a' );
			}

			if ( ! parent || ! target ) {
				return;
			}

			var trackingId = target.getAttribute( 'ID' ) || parent.getAttribute( 'ID' );

			if ( ! Object.prototype.hasOwnProperty.call( linksTracksEvents, trackingId ) ) {
				return;
			}
			var eventProps = { clicked: linksTracksEvents[ trackingId ] };

			if ( parent.classList.contains( 'menupop' ) ) {
				window.jpTracksAJAX.record_ajax_event( eventName, 'click', eventProps );
			} else {
				e.preventDefault();
				window.jpTracksAJAX
					.record_ajax_event( eventName, 'click', eventProps )
					.always( function () {
						window.location = target.getAttribute( 'href' );
					} );
			}
		};
	}

	function init() {
		var trackableLinkSelector =
			'.mb-trackable .ab-item:not(div),' +
			'#wp-admin-bar-notes .ab-item,' +
			'#wp-admin-bar-user-info .ab-item,' +
			'.mb-trackable .ab-secondary';

		var trackableLinks = document.querySelectorAll( trackableLinkSelector );
		for ( var i = 0; i < trackableLinks.length; i++ ) {
			var link = trackableLinks[ i ];
			var handler = createTrackableLinkEventHandler();

			link.addEventListener( 'click', handler );
			link.addEventListener( 'touchstart', handler );
		}
	}

	if ( document.readyState === 'loading' ) {
		document.addEventListener( 'DOMContentLoaded', init );
	} else {
		init();
	}

	// listen for postMessage events from the notifications iframe
	window.addEventListener(
		'message',
		function ( event ) {
			if ( ! window.jpTracksAJAX || typeof window.jpTracksAJAX.record_ajax_event !== 'function' ) {
				return;
			}

			if ( event.origin !== 'https://widgets.wp.com' ) {
				return;
			}

			var data = typeof event.data === 'string' ? parseJson( event.data, {} ) : event.data;
			if ( data.type !== 'notesIframeMessage' ) {
				return;
			}

			var eventData = notesTracksEvents[ data.action ];
			if ( ! eventData ) {
				return;
			}

			window.jpTracksAJAX.record_ajax_event( eventName, 'click', eventData( data ) );
		},
		false
	);
} )();
class-atomic-additional-css-manager.php                                                                                                                                                                                                                        1415          1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * WPORG_Additional_CSS_Manager file
 *
 * Responsible with replacing the Core Additional CSS section with an upgrade nudge on Atomic.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Class Atomic_Additional_CSS_Manager
 *
 * @package Automattic\Jetpack\Dashboard_Customizations
 */
class Atomic_Additional_CSS_Manager {

	/**
	 * The site domain.
	 *
	 * @var string
	 */
	private $domain;

	/**
	 * Atomic_Additional_CSS_Manager constructor.
	 *
	 * @param string $domain the Site domain.
	 */
	public function __construct( $domain ) {
		$this->domain = $domain;
	}

	/**
	 * Replace the Additional CSS section from Customiz¡er with an upgrade nudge.
	 *
	 * @param \WP_Customize_Manager $wp_customize_manager Core customize manager.
	 */
	public function register_nudge( \WP_Customize_Manager $wp_customize_manager ) {
		$nudge_url  = $this->get_nudge_url();
		$nudge_text = __( 'Purchase the Creator plan to<br> activate CSS customization', 'jetpack' );

		$nudge = new CSS_Customizer_Nudge(
			$nudge_url,
			$nudge_text
		);

		$wp_customize_manager->remove_control( 'custom_css' );
		$wp_customize_manager->remove_section( 'custom_css' );

		$nudge->customize_register_nudge( $wp_customize_manager );
	}

	/**
	 * Get the Nudge URL.
	 *
	 * @return string
	 */
	private function get_nudge_url() {
		return '/checkout/' . $this->domain . '/business';
	}
}
class-css-customizer-nudge.php                                                                                                                                                                                                                                 3172          1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * CSS_Customizer_Nudge file.
 * CSS Nudge implementation for Atomic and WPCOM.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Class WPCOM_CSS_Customizer
 *
 * @package Automattic\Jetpack\Dashboard_Customizations
 */
class CSS_Customizer_Nudge {
	/**
	 * Call to Action URL.
	 *
	 * @var string
	 */
	private $cta_url;

	/**
	 * The nudge message.
	 *
	 * @var string
	 */
	private $nudge_copy;

	/**
	 * The name of the control in Customizer.
	 *
	 * @var string
	 */
	private $control_name;

	/**
	 * CSS_Customizer_Nudge constructor.
	 *
	 * @param string $cta_url      The URL to the plans.
	 * @param string $nudge_copy   The nudge text.
	 * @param string $control_name The slug prefix of the nudge.
	 */
	public function __construct( $cta_url, $nudge_copy, $control_name = 'custom_css' ) {
		$this->cta_url      = $cta_url;
		$this->nudge_copy   = $nudge_copy;
		$this->control_name = $control_name;
	}

	/**
	 * Register the assets required for the CSS nudge page from the Customizer.
	 */
	public function customize_controls_enqueue_scripts_nudge() {
		\wp_enqueue_script(
			'additional-css-js',
			plugins_url( 'js/additional-css.js', __FILE__ ),
			array(),
			JETPACK__VERSION,
			true
		);
		\wp_enqueue_style(
			'additional-css',
			plugins_url( 'css/additional-css.css', __FILE__ ),
			array(),
			JETPACK__VERSION
		);
	}

	/**
	 * Register the CSS nudge in the Customizer.
	 *
	 * @param \WP_Customize_Manager $wp_customize The customize manager.
	 */
	public function customize_register_nudge( \WP_Customize_Manager $wp_customize ) {
		// Show a nudge in place of the normal CSS section.
		\add_action( 'customize_controls_enqueue_scripts', array( $this, 'customize_controls_enqueue_scripts_nudge' ) );

		$wp_customize->add_setting(
			$this->control_name . '[dummy_setting]',
			array(
				'type'      => $this->control_name . '_dummy_setting',
				'default'   => '',
				'transport' => 'refresh',
			)
		);

		$wp_customize->add_section( $this->create_css_nudge_section( $wp_customize ) );

		$wp_customize->add_control( $this->create_css_nudge_control( $wp_customize ) );
	}

	/**
	 * Create a nudge control object.
	 *
	 * @param \WP_Customize_Manager $wp_customize The Core Customize Manager.
	 *
	 * @return CSS_Nudge_Customize_Control
	 */
	public function create_css_nudge_control( \WP_Customize_Manager $wp_customize ) {
		return new CSS_Nudge_Customize_Control(
			$wp_customize,
			$this->control_name . '_control',
			array(
				'cta_url'    => $this->cta_url,
				'nudge_copy' => $this->nudge_copy,
				'label'      => __( 'Custom CSS', 'jetpack' ),
				'section'    => $this->control_name,
				'settings'   => $this->control_name . '[dummy_setting]',
			)
		);
	}

	/**
	 * Create the nudge section.
	 *
	 * @param \WP_Customize_Manager $wp_customize The core Customize Manager.
	 *
	 * @return \WP_Customize_Section
	 */
	public function create_css_nudge_section( \WP_Customize_Manager $wp_customize ) {
		return new \WP_Customize_Section(
			$wp_customize,
			$this->control_name,
			array(
				'title'    => __( 'Additional CSS', 'jetpack' ),
				'priority' => 200,
			)
		);
	}
}
class-css-nudge-customize-control.php                                                                                                                                                                                                                          1156          1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * CSS_Nudge_Customize_Control file.
 * CSS Nudge implementation for Atomic and WPCOM.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Class CSS_Nudge_Customize_Control
 *
 * @package Automattic\Jetpack\Dashboard_Customizations
 */
class CSS_Nudge_Customize_Control extends \WP_Customize_Control {

	/**
	 * The type of the nudge.
	 *
	 * @var string
	 */
	public $type = 'cssNudge';

	/**
	 * The Call to Action URL.
	 *
	 * @var string
	 */
	public $cta_url;

	/**
	 * The nudge text displayed.
	 *
	 * @var string
	 */
	public $nudge_copy;

	/**
	 * Render the nudge on the page.
	 */
	public function render_content() {
		$cta_url           = $this->cta_url;
		$nudge_copy        = $this->nudge_copy;
		$nudge_button_copy = __( 'Upgrade now', 'jetpack' );

		echo '<div class="nudge-container">
				<p>
					' . wp_kses( $nudge_copy, array( 'br' => array() ) ) . '
				</p>
				<div class="button-container">
					<button type="button" class="button-primary navigate-to" data-navigate-to-page="' . esc_url( $cta_url ) . '">' . esc_html( $nudge_button_copy ) . '</button>
				</div>
			</div>';
	}
}
class-wpcom-additional-css-manager.php                                                                                                                                                                                                                         1271          1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * WPCOM_Additional_CSS_Manager file
 *
 * Is responsible with registering the Additional CSS section in WPCOM.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

/**
 * Class WPCOM_Disable_Additional_CSS
 *
 * @package Automattic\Jetpack\Dashboard_Customizations
 */
class WPCOM_Additional_CSS_Manager {

	/**
	 * The site domain.
	 *
	 * @var string
	 */
	private $domain;

	/**
	 * WPCOM_Additional_CSS_Manager constructor.
	 *
	 * @param string $domain the Site domain.
	 */
	public function __construct( $domain ) {
		$this->domain = $domain;
	}

	/**
	 * Register the Additional CSS nudge.
	 *
	 * @param \WP_Customize_Manager $wp_customize_manager The core customize manager.
	 */
	public function register_nudge( \WP_Customize_Manager $wp_customize_manager ) {
		$nudge_url  = $this->get_nudge_url();
		$nudge_text = __( 'Purchase the Explorer plan to<br> activate CSS customization', 'jetpack' );

		$nudge = new CSS_Customizer_Nudge(
			$nudge_url,
			$nudge_text,
			'jetpack_custom_css'
		);

		$nudge->customize_register_nudge( $wp_customize_manager );
	}

	/**
	 * Get the nudge URL in WPCOM.
	 *
	 * @return string
	 */
	private function get_nudge_url() {
		return '/checkout/' . $this->domain . '/premium';
	}
}
additional-css.css                                                                                                                                                                                                                                             262           1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css/css                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     .customize-control-cssNudge .nudge-container {
	width: 100%;
	padding: 50px 0;
}

.customize-control-cssNudge .nudge-container p {
	text-align: center;
}

.customize-control-cssNudge .nudge-container .button-container {
	margin-top: 20px;
	text-align: center;
}
additional-css.js                                                                                                                                                                                                                                              1207          1711191384  plugins/jetpack/modules/masterbar/nudges/additional-css/js                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( function ( $ ) {
	'use strict';

	var cssNudge = {
		init: function () {
			this.clickifyNavigateToButtons();
		},

		clickifyNavigateToButtons: function () {
			var navButton = document.querySelector( '.navigate-to' );
			if ( ! navButton ) {
				return;
			}

			navButton.addEventListener( 'click', function () {
				// Get destination.
				var destination = this.getAttribute( 'data-navigate-to-page' );

				if ( ! destination ) {
					return;
				}

				// Fire Tracks click event.
				window._tkq = window._tkq || [];
				window._tkq.push( [
					'recordEvent',
					'calypso_upgrade_nudge_cta_click',
					{
						cta_name: 'customizer_css',
					},
				] );

				// Navigate to a different page.
				if (
					window.location.search.match( /calypso=true/ ) &&
					window.parent.location !== window.location
				) {
					// Calypso.
					window.top.postMessage(
						JSON.stringify( {
							calypso: true,
							command: 'navigateTo',
							destination: destination,
						} ),
						'*'
					);
				} else {
					// Non-Calypso.
					window.location = 'https://wordpress.com' + destination;
				}
			} );
		},
	};

	$( document ).ready( function () {
		cssNudge.init();
	} );
} )( jQuery );
bootstrap.php                                                                                                                                                                                                                                                  1751          1711191384  plugins/jetpack/modules/masterbar/nudges                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Bootstrap file for the nudges.
 *
 * @package Jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Status;
use Automattic\Jetpack\Status\Host;

/**
 * The WP_Customize_Control core class is loaded only on customize_register.
 *
 * @param \WP_Customize_Manager $customize_manager Core customize manager.
 */
function register_css_nudge_control( \WP_Customize_Manager $customize_manager ) {
	require_once __DIR__ . '/additional-css/class-css-nudge-customize-control.php';
	require_once __DIR__ . '/additional-css/class-css-customizer-nudge.php';

	$domain = ( new Status() )->get_site_suffix();

	if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {
		require_once __DIR__ . '/additional-css/class-wpcom-additional-css-manager.php';
		$manager = new WPCOM_Additional_CSS_Manager( $domain );
	} elseif ( ( new Host() )->is_woa_site() ) {
		require_once __DIR__ . '/additional-css/class-atomic-additional-css-manager.php';
		$manager = new Atomic_Additional_CSS_Manager( $domain );
	}

	if ( ! isset( $manager ) ) {
		return;
	}

	$manager->register_nudge( $customize_manager );
}

/**
 * Load the bootstrap on init action.
 *
 * We need to load on init because otherwise the filter will not be set to true in WPCOM (since the add_filter is set on init).
 */
function load_bootstrap_on_init() {

	/**
	 * Disable Additional CSS section from Customizer in WPCOM and Atomic and replace it with a nudge.
	 *
	 * @module masterbar
	 *
	 * @since 9.9.0
	 *
	 * @param bool
	 */
	if ( \apply_filters( 'jetpack_customize_enable_additional_css_nudge', false ) ) {
		\add_action( 'customize_register', __NAMESPACE__ . '\register_css_nudge_control' );
	}
}

add_action( 'init', __NAMESPACE__ . '\load_bootstrap_on_init' );
bootstrap.php                                                                                                                                                                                                                                                  761           1711191384  plugins/jetpack/modules/masterbar/profile-edit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Bootstrap the WP.com User profile edit restriction.
 *
 * @package automattic\jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Connection\Manager as Connection_Manager;

require_once __DIR__ . '/profile-edit.php';
require_once __DIR__ . '/class-wpcom-user-profile-fields-revert.php';

/**
 * Prevent WP.com user profile fields (first_name, last_name, display_name, description) to be updated.
 */
function load_the_user_profile_info_revert() {
	new WPCOM_User_Profile_Fields_Revert( new Connection_Manager( 'jetpack' ) );
}

\add_action( 'load-profile.php', __NAMESPACE__ . '\load_the_user_profile_info_revert' );
\add_action( 'load-user-edit.php', __NAMESPACE__ . '\load_the_user_profile_info_revert' );
class-wpcom-user-profile-fields-revert.php                                                                                                                                                                                                                     6451          1711191384  plugins/jetpack/modules/masterbar/profile-edit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Manage User profile fields.
 *
 * @package automattic/jetpack
 */

namespace Automattic\Jetpack\Dashboard_Customizations;

use Automattic\Jetpack\Connection\Manager as Connection_Manager;

/**
 * Responsible with preventing the back-end default implementation to save the fields that are managed on WP.com profiles.
 *
 * Class Profile_Edit_Filter_Fields
 */
class WPCOM_User_Profile_Fields_Revert {

	/**
	 * Jetpack connection manager object.
	 *
	 * @var Connection_Manager
	 */
	private $connection_manager;

	/**
	 * Profile_Edit_Filter_Fields constructor.
	 *
	 * @param Connection_Manager $connection_manager The connection manager.
	 */
	public function __construct( Connection_Manager $connection_manager ) {
		$this->connection_manager = $connection_manager;

		\add_filter( 'wp_pre_insert_user_data', array( $this, 'revert_user_data_on_wp_admin_profile_update' ), 10, 3 );
		\add_filter( 'insert_user_meta', array( $this, 'revert_user_meta_on_wp_admin_profile_change' ), 10, 3 );

		/**
		 * Core sends two E-mail notifications that have to be disabled:
		 * - To the existing e-mail address
		 * - To the new email address
		 */
		\add_filter( 'send_email_change_email', array( $this, 'disable_send_email_change_email' ), 10, 3 );
		\add_action( 'personal_options_update', array( $this, 'disable_email_notification' ), 1, 1 );
	}

	/**
	 * Filter the built-in user profile fields.
	 *
	 * @param array    $data            {
	 *                                  Values and keys for the user.
	 *
	 * @type string    $user_login      The user's login. Only included if $update == false
	 * @type string    $user_pass       The user's password.
	 * @type string    $user_email      The user's email.
	 * @type string    $user_url        The user's url.
	 * @type string    $user_nicename   The user's nice name. Defaults to a URL-safe version of user's login
	 * @type string    $display_name    The user's display name.
	 * @type string    $user_registered MySQL timestamp describing the moment when the user registered. Defaults to
	 *                                   the current UTC timestamp.
	 * }
	 *
	 * @param bool     $update          Whether the user is being updated rather than created.
	 * @param int|null $id              ID of the user to be updated, or NULL if the user is being created.
	 *
	 * @return array
	 */
	public function revert_user_data_on_wp_admin_profile_update( $data, $update, $id ) {

		// bail if the id is null, meaning that this was triggered in the context of user create.
		// bail if the user is not connected (e.g. non-WP.com users or disconnected users).
		if ( ! $update || null === $id || ! $this->connection_manager->is_user_connected( $id ) ) {
			return $data;
		}

		/**
		 * Revert the data in the form submission with the data from the database.
		 */
		$user = \get_userdata( $id );

		/**
		 * E-mail has a different flow for changing it's value. It stores it in an option until the user confirms it via e-mail