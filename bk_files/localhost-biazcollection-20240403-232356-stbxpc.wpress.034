desk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:54
msgid "Shipping Manifests not found"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:54
msgid "Shipping Manifests not found in trash"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:54
msgid "Shipping Manifests."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:100
msgid "Date"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:102
msgid "Number"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:103
msgid "Shipments count"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:104
msgid "Actions"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:159
#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/CustomPostType.php:183
msgid "Invalid nonce!"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/views/column-actions.php:11
msgid "Download"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/views/filter-form.php:11
msgid "All manifests"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/views/manifest-metabox.php:20
#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Manifest/views/manifest-metabox.php:79
msgid "Order"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:15
msgid "Unknown error!"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:18
msgid "Nonce verification error! Invalid request."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:22
msgid "Insufficient user permissions!"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:26
msgid "No shipment id!"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:30
msgid "No data!"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Metabox/Ajax.php:47
msgid "Saved"
msgstr ""

#. Translators: order id and integration.
#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Order/AddShippingMetabox.php:45
msgid "Shipment for order %1$s, %2$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Order/AddShippingMetabox.php:83
msgid "Select integration"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Order/AddShippingMetabox.php:85
msgid "Add shipping"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-shipment/src/WPDesk/FS/Shipment/Order/views/html-order-add_shipping-metabox.php:18
msgid "Add"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/CalculationMethodOptions.php:20
msgid "Sum"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:71
msgid "shipping method configuration"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:78
msgid "input data"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:85
msgid "rules (%1$s)"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:85
msgid "triggered"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:85
msgid "not triggered"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/ShippingMethodLogger.php:92
msgid "the result of shipping method's usage"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/view/display-notice-content-single-value.php:12
msgid "Show %1$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/view/display-notice-content-single-value.php:15
msgid "Hide %1$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/view/display-notice-content-single-value.php:18
msgid "Copy %1$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/view/display-notice-footer.php:9
msgid "Copy all data"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Logger/view/display-notice-header.php:9
msgid "FS Debug mode for %1$s%2$s%3$s shipping method."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Settings/CartCalculationOptions.php:23
msgid "Cart value"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Settings/CartCalculationOptions.php:23
msgid "Package value"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Settings/IntegrationSettingsImplementation.php:41
msgid "Integration: %1$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-fs-table-rate/src/Settings/MethodSettingsImplementation.php:272
msgid "Method settings:%1$s Enabled: %2$s Method Title: %3$s Method Description: %4$s Tax status: %5$s Costs includes tax: %6$s Free Shipping: %7$s Free Shipping Label: %8$s 'Left to free shipping' notice: %9$s Rules Calculation: %10$s Cart Calculation: %11$s Visibility (Show only for logged in users): %12$s Default: %13$s Debug mode: %14$s"
msgstr ""

#. Translators: plugin name.
#: vendor_prefixed/wpdesk/wp-wpdesk-rating-petition/src/RatingPetitionNotice.php:151
msgid "Awesome, you've been using %s for more than 2 weeks. Could you please do me a BIG favor and give it a 5-star rating on WordPress? ~ Peter"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-rating-petition/src/views/html-text-petition.php:15
msgid "Created with %1$s by %2$s - If you like %3$s you can %4$srate us %5$s in plugins repository &rarr;%6$s"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker-deactivation/src/WPDesk/Tracker/Deactivation/views/scripts.php:55
msgid "Plugin deactivation"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker-deactivation/src/WPDesk/Tracker/Deactivation/views/thickbox.php:31
msgid "Before you proceed, please take 30 seconds to let us know what brought you to this decision. Your answers are anonymous."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker-deactivation/src/WPDesk/Tracker/Deactivation/views/thickbox.php:99
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-deactivate.php:126
msgid "Submit &amp; Deactivate"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker-user-feedback/src/WPDesk/Tracker/UserFeedback/UserFeedbackContent.php:31
msgid "Proceed"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker-user-feedback/src/WPDesk/Tracker/UserFeedback/views/thickbox.php:103
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:40
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:32
msgid "Skip"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/OptOut.php:41
msgid "You successfully opted out of collecting usage data by %1$s. If you change your mind, you can always opt in later in the plugin's quick links."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/PluginActionLinks.php:50
msgid "Opt-in"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/PluginActionLinks.php:53
msgid "Opt-out"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:26
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:18
msgid "Please help us improve our plugins! If you opt-in, we will collect some non-sensitive data and usage information anonymously. If you skip this, that's okay! All plugins will work just fine."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:35
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:27
msgid "Allow & Continue &rarr;"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:47
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:39
msgid "What permissions are being granted?"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:56
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:48
msgid "Your Site Overview"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:59
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:51
msgid "WP version, PHP info"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:67
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:59
msgid "Plugin Usage"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:70
msgid "Current settings and usage information of %1$s plugins"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:78
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:70
msgid "Your Store Overview"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:81
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:73
msgid "Anonymized and non-sensitive store usage information"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/PSR/WPDesk/Tracker/views/tracker-connect.php:91
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:83
#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-notice.php:27
msgid "Find out more &raquo;"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-connect.php:62
msgid "Current settings and usage information of WP Desk plugins"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-deactivate.php:19
msgid " If you have a moment, please let us know why you are deactivating plugin (anonymous feedback):"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-deactivate.php:48
msgid "I found a better plugin"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-deactivate.php:98
msgid "Kindly tell us the reason so we can improve"
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-notice.php:22
msgid "We need your help to improve <strong>WP Desk plugins</strong>, so they are more useful for you and the rest of <strong>30,000+ users</strong>. By collecting data on how you use our plugins, you will help us a lot. We will not collect any sensitive data, so you can feel safe."
msgstr ""

#: vendor_prefixed/wpdesk/wp-wpdesk-tracker/src/views/tracker-opt-out-notice.php:11
msgid "You successfully opted out of collecting usage data by WP Desk. If you change your mind, you can always opt in later in the plugin's quick links."
msgstr ""

#: assets-src/blocks/free-shipping-notice/edit.js:10
#: assets/blocks/free-shipping-notice/index.js:1
msgid "Flexible Shipping Free Shipping Notice"
msgstr ""

#: assets-src/rules-settings/js/components/html-woo-select.js:37
#: assets-src/rules-settings/js/components/html-woo-select.js:233
#: assets/js/rules-settings.js:1
msgid "Enter 3 or more characters"
msgstr ""

#: assets-src/rules-settings/js/components/html-woo-select.js:237
#: assets/js/rules-settings.js:1
msgid "searching..."
msgstr ""

#: assets-src/rules-settings/js/components/html-woo-select.js:246
#: assets-src/rules-settings/js/components/html-woo-select.js:253
#: assets/js/rules-settings.js:1
msgid "Value not found"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:11
#: assets/js/rules-settings.js:1
msgid "All scenarios"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:181
#: assets/js/rules-settings.js:1
msgid "Rules count in scenario: %1$s"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:182
#: assets/js/rules-settings.js:1
msgid "Read full description →"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:183
#: assets/js/rules-settings.js:1
msgid "Use scenario"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:219
#: assets/js/rules-settings.js:1
msgid "Select a ready-made scenario"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:220
#: assets/js/rules-settings.js:1
msgid "Select one of the pre-made and ready to use Flexible Shipping scenarios from our library. Pick the one which fits your needs, adjust it freely and have it all configured in no time!"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:221
#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:244
#: assets/js/rules-settings.js:1
msgid "Please mind that saving the changes after using a ready-made scenario will overwrite the previously configured rules for this shipping method. However, not until the changes are saved, the prior setup is still in use."
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:243
#: assets/js/rules-settings.js:1
msgid "Use rules from scenario?"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:279
#: assets/js/rules-settings.js:1
msgid "Looking for different scenario? %1$sCheck our documentation →%2$s"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:284
#: assets/js/rules-settings.js:1
msgid "Select other scenario"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-modal.js:285
#: assets/js/rules-settings.js:1
msgid "Use selected scenario"
msgstr ""

#: assets-src/rules-settings/js/components/preconfigured-scenarios-unavailable-modal.js:65
#: assets/js/rules-settings.js:1
msgid "Close"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:290
#: assets/js/rules-settings.js:1
msgid "Conditions"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:291
#: assets/js/rules-settings.js:1
msgid "Costs"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:293
#: assets/js/rules-settings.js:1
msgid "Special action"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:317
#: assets/js/rules-settings.js:1
msgid "Add the first rule or use one of the ready-made scenarios"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:325
#: assets/js/rules-settings.js:1
msgid "Add rule"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:327
#: assets/js/rules-settings.js:1
msgid "Duplicate selected rules"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:329
#: assets/js/rules-settings.js:1
msgid "Delete selected rules"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:331
#: assets/js/rules-settings.js:1
msgid "Use ready-made scenarios"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:356
#: assets-src/rules-settings/js/components/rules-settings.js:363
#: assets/js/rules-settings.js:1
msgid "PRO Features"
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:358
#: assets/js/rules-settings.js:1
msgid "Tick this checkbox to display the features and shipping cost calculation conditions coming with the plugin's PRO version."
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:368
#: assets/js/rules-settings.js:1
msgid "Show the options available in the PRO version."
msgstr ""

#: assets-src/rules-settings/js/components/rules-settings.js:372
#: assets/js/rules-settings.js:1
msgid "Learn more about PRO version →"
msgstr ""

#: assets-src/rules-settings/js/components/single-condition.js:244
#: assets/js/rules-settings.js:1
msgid "and"
msgstr ""

#: assets-src/rules-settings/js/components/single-condition.js:246
#: assets/js/rules-settings.js:1
msgid "When"
msgstr ""

#: assets-src/blocks/free-shipping-notice-block-integration/block.json
#: assets/blocks/free-shipping-notice-block-integration/block.json
msgctxt "block title"
msgid "Free Shipping Notice Block Integration"
msgstr ""

#: assets-src/blocks/free-shipping-notice-block-integration/block.json
#: assets/blocks/free-shipping-notice-block-integration/block.json
msgctxt "block description"
msgid "Adds a notice to the checkout and cart when free shipping is available."
msgstr ""

#: assets-src/blocks/free-shipping-notice/block.json
#: assets/blocks/free-shipping-notice/block.json
msgctxt "block title"
msgid "Free Shipping Notice"
msgstr ""

#: assets-src/blocks/free-shipping-notice/block.json
#: assets/blocks/free-shipping-notice/block.json
msgctxt "block description"
msgid "Displays free shipping notice."
msgstr ""
readme.txt                                                                                                                                                                                                                                                     39994         1711369794  plugins/flexible-shipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       === Table Rate Shipping Method for WooCommerce by Flexible Shipping ===
Contributors: octolize,grola,sebastianpisula
Donate link: https://octol.io/fs-repo-up
Tags: table rate, table rate shipping, conditional shipping, free shipping, woocommerce shipping, woocommerce table rate shipping, cart based shipping, weight based shipping, totals based shipping, order based shipping, advanced shipping
Requires at least: 5.8
Tested up to: 6.4
Stable tag: 4.24.17
Requires PHP: 7.4
License: GPLv3 or later
License URI: http://www.gnu.org/licenses/gpl-3.0.html

The best and the most powerful Table Rate shipping plugin for WooCommerce. Define the shipping rules based on numerous conditions and configure even the most complex shipping scenarios based on totals, weight, quantity and more.

== Description ==

= Table Rate Shipping Killer =

Flexible Shipping is the most advanced shipping plugin for WooCommerce stores, allowing you to calculate the shipping costs based on weight and/or cart total. Combine it with the PRO version and it will become the only WooCommerce shipping plugin you'll ever need.

[youtube https://www.youtube.com/watch?v=C7dQ2jQ-iVc]

> **Upgrade to Flexible Shipping PRO**<br />
> Upgrade to [Flexible Shipping PRO now](https://octol.io/fs-repo-up) to get the priority e-mail support and gain an access to all the PRO features!

= Possible Shipping Scenarios =

* Shipping costs based on cart weight
* Shipping costs based on cart total
* Adding handling fee or an insurance cost after reaching a certain order value
* Creating COD (Cash On Delivery) shipping method with additional costs
* Different shipping costs for different shipping classes, products or product categories (PRO)
* Disabling/hiding the shipping method if the configured rule has been matched in the cart (PRO)
* Additional cost added to whole order and/or per each one product in the cart (PRO)
* Enabling/disabling the shipping method based on the Time of the Day and Day of the week (PRO)
* Hiding the shipping method for certain products

These are only a few examples of the Flexible Shipping usage, however, sky is the limit. We have described the most popular use cases in the comprehensive and detailed plugin documentation and [Ready to use scenarios &rarr;](https://octol.io/fs-repo-docs).

= Features =

* Unlimited shipping methods and costs calculation rules
* Possibility of adding the titles and **descriptions** to your shipping methods
* Shipping cost based on cart total and/or weight
* Minimum and maximum values for cart total and/or weight
* Summing up the costs of e.g. two different rules at the same time e.g. one based on cart total and the second based on weight
* Free shipping over amount threshold
* Option to display the selected shipping methods only for logged-in users
* Further shipping companies integrations (see the info below for more details)
* WPML and Polylang compatibility
* Built-in ready to use scenarios
* Automatic notification about shipping zone configuration conflict
* Cart calculation settings (cart or package value)
* Built-in tutorial with step-by-step guide

= PRO Features =

* All free features
* **Shipping classes support**
* Shipping costs based on products' quantity and/or cart line item count
* Shipping cost based on the product’s length, width, height and/or maximal dimension
* Shipping cost based on the volume of the products in the cart
* Shipping cost based on dimensional weight (with custom DIM Factor)
* Shipping cost based on products (products, product categories, product tags)
* Shipping cost based on user role
* Enabling/disabling the shipping method based on the Time of the Day and Day of the week
* Additional costs based on price, weight, dimensional weight, item quantity, cart line item, volume
* Stopping a rule (if the rule is matched the following rules will not be calculated)
* Hiding a shipping method (if the rule is matched, the related shipping method will remain hidden and will not be displayed in the cart and checkout)
* Conditional logic for conditions with selection (e.g. shipping class) - matches any/all/none
* Conditional logic for conditions with ranges (e.g. weight) - is/is not
* Additional calculation methods (sum, lowest cost, highest cost)
* Maximum shipping cost per shipping method
* Free shipping coupons support

[Upgrade to PRO Now &rarr;](https://octol.io/fs-repo-up)

= Flexible Shipping Box Packing WooCommerce =

Flexible Shipping Box Packing WooCommerce introduces the advanced box packing algorithm allowing to automatically fit the ordered products into your shipping boxes the most optimal way. Give it a try and configure the shipping cost calculation rules based on the type and number of the used shipping boxes. It works with both the free and PRO versions, so you can buy it separately if you don't need the PRO features.

[Buy Flexible Shipping Box Packing WooCommerce now &rarr;](https://octol.io/fs-repo-cross-bp)

= Distance Based Shipping Rates for WooCommerce =

Distance Based Shipping Rates for WooCommerce extends the Flexible Shipping plugin functionalities by adding the rules based on distance and delivery duration. It works with both the free and PRO versions, so you can buy it separately if you don't need the PRO features.

[Buy Distance Based Shipping Rates for WooCommerce now &rarr;](https://octol.io/fs-repo-cross-dbsr)

= WooCommerce Delivery Date Picker =

WooCommerce Delivery Date Picker extends the default features of Flexible Shipping plugin, allows you to choose a convenient delivery date for your ordered products and makes the shipping cost dependent on the selected date. It works with both the free and PRO versions, so you can buy it separately if you don't need the PRO features.

[Buy WooCommerce Delivery Date Picker now &rarr;](https://octol.io/fs-repo-cross-ddp)

= Flexible Shipping Locations Add-On =

Flexible Shipping Locations Add-On extends the default Flexible Shipping for WooCommerce functionalities and adds the possiblity to create the additional rules based on locations (WooCommerce and custom ones). It works with both, free and PRO versions, so you can buy it separately if you do not need the PRO features.

[Buy Flexible Shipping Locations Add-On now &rarr;](https://octol.io/fs-repo-cross-locations)

= Flexible Shipping Import Export Add-On =

Flexible Shipping Import Export Add-On allows you to easily import and export Flexible Shipping methods. This way you can easily move and update shipping methods. Plugin supports CSV format. It works with both, free and PRO versions, so you can buy it separately if you do not need the PRO features.

[Buy Flexible Shipping Import Export Add-On now &rarr;](https://octol.io/fs-repo-cross-fsie)

= Multi Vendor Shipping for WooCommerce Add-On =

Multi Vendor Shipping for WooCommerce Add-on extends the Flexible Shipping plugin by adding rules based on Product Author (Vendor). This allows you to assign shipping methods to vendors or set additional shipping costs to them. It works with both, free and PRO versions so you can buy it separately if you do not need the PRO features.

[Buy Multi Vendor Shipping for WooCommerce Add-On now &rarr;](https://octol.io/fs-repo-cross-mvs)

You might also be interested in other...

= Useful free WooCommerce shipping plugins from Octolize =

* [Flexible Shipping for UPS and WooCommerce](https://octol.io/ups-repo) - the most powerful UPS WooCommerce integration
* [Flexible Shipping for FedEx and WooCommerce](https://octol.io/fedex-repo) - first free plugin to display FedEx Live Rates
* [Live rates for USPS and WooCommerce](https://octol.io/usps-repo) - the best free plugin to display the USPS Live Rates
* [Live rates for DHL Express and WooCommerce](https://octol.io/dhlexpress-repo) - automatic international shipping costs calculation and displaying DHL Express live rates
* [Shipping Live Rates for Australia Post for WooCommerce](https://octol.io/ap-repo) – Australia Post WooCommerce shipping methods with real-time calculated shipping rates
* [Shipping Live Rates for Canada Post for WooCommerce](https://octol.io/cp-repo) - Canada Post WooCommerce shipping methods with real-time calculated shipping rates
* [Shipping Live Rates for Royal Mail for WooCommerce](https://octol.io/rm-repo) - Royal Mail WooCommerce shipping methods with real-time calculated shipping rates
* [Shipping Notices](https://octol.io/notices-repo) - your own custom WooCommerce shipping notices instead of the default "No shipping options were found" info
* [Shipping Cost on Product Page](https://octol.io/scopp-repo) - displaying the shipping cost calculator to your customers directly on the product page, before reaching the cart or checkout

= Docs =

View the dedicated [Flexible Shipping Documentation &rarr;](https://octol.io/fs-repo-docs)

= Support Policy =

We provide a limited support for the free version of our Flexible Shipping plugin on the [dedicated plugin Support Forum](https://wordpress.org/support/plugin/flexible-shipping/). Please upgrade to PRO version to get the priority e-mail support as well as all PRO features. [Upgrade Now &rarr;](https://octol.io/fs-repo-up)

= Further Integrations =

**United Kingdom**

We have released a DPD UK & Local WooCommerce integrations for Flexible Shipping covering the whole UK territory. Check our plugins - [offer your customers the DPD UK services in your shop](https://octol.io/fs-repo-cross-dpd-uk) and [show them the DPD UK Pickup Points map](https://octol.io/fs-repo-cross-dpd-uk-pp) to choose their preferred one to collect their orders from.

**Poland**

There have also develop more further Flexible Shipping integrations for Polish carriers and shipping companies:

* DPD - WooCommerce
* DHL - WooCommerce
* Paczkomaty InPost - WooCommerce
* UPS - WooCommerce
* eNadawca Poczta Polska - WooCommerce
* Orlen Paczka - WooCommerce

= Compatible WooCommerce Plugins =

We have verified and tested the Flexible Shipping compatibility with the following popular WooCommerce plugins:

* [WPML](https://wpml.org/)
* [Germanized](https://wordpress.org/plugins/woocommerce-germanized/)

= Supported Currency Switchers =

* [Aelia Currency Switcher](https://aelia.co/shop/currency-switcher-woocommerce/)
* [WooCommerce Currency Switcher](https://wordpress.org/plugins/woocommerce-currency-switcher/)
* [Currency Switcher for WooCommerce](https://wordpress.org/plugins/currency-switcher-woocommerce/)
* [Multi Currency for WooCommerce](https://wordpress.org/plugins/woo-multi-currency/)
* [WPML](https://wpml.org/)

= Translations =

* English - default
* Polish
* German by [jensratzel](https://profiles.wordpress.org/jensratzel/)
* Spanish by [Jose Luis](https://profiles.wordpress.org/jose64/), [Javier Esteban](https://profiles.wordpress.org/nobnob/), [lacasitadecadera](https://profiles.wordpress.org/lacasitadecera/)
* Dutch by [Vernum](https://profiles.wordpress.org/vernum/), [Peter Smits](https://profiles.wordpress.org/psmits1567/), [Pjeterjan Deneys](https://profiles.wordpress.org/nekojonez/)

= Interested in plugin translations? =

We are actively looking for contributors to translate this and [other Octolize plugins](https://profiles.wordpress.org/octolize/#content-plugins). Each supported language tremendously help store owners to conveniently manage shipping operations.

Your translations contribute to the WordPress community at large. Moreover, we're glad to offer you discounts for our PRO plugins and establish long-term collaboration. If you have any translation related questions, please email us at [translations@octolize.com](mailto:translations@octolize.com).

Head over here and help us to translate this plugin:
[https://translate.wordpress.org/projects/wp-plugins/flexible-shipping](https://translate.wordpress.org/projects/wp-plugins/flexible-shipping)

= Flexible Shipping in a nutshell =

Key features:

* improved shipping-related user experience,
* custom shipping rules,
* free shipping based on the price or products' in the cart quantity,
* cost based shipping cost
* weight based shipping cost
* total order based shipping cost,
* item count based shipping cost,
* shipping class based shipping cost,
* WooCommerce shipping cost rules,
* WooCommerce shipping plugin,
* WooCommerce table rate shipping.

Give it a try and see for yourself that our Flexible Shipping is the only one Table Rate Shipping plugin you need!

== Installation	 ==

This integration can be easily installed like any other WordPress plugin by following the steps below:

1. Download and unzip the latest zip file release.
2. Upload the entire plugin directory to your **/wp-content/plugins/** path.
3. Activate the plugin using the **Plugins** menu in WordPress sidebar menu.

Optionally you can also try to upload the plugin zip file using **Plugins &rarr; Add New &rarr; Upload Plugin** option from the WordPress sidebar menu. Then go directly to point 3.

== Frequently Asked Questions ==

= How to configure the plugin? =

To make it clear and as easy as possible we have prepared the detailed step-by-step guides in our [Flexible Shipping Docs here](https://octol.io/fs-repo-docs). You can also use the built-in tutorial that will guide you throught the whole process.

= Do you offer support? =

We provide a limited support for the free version of our Flexible Shipping plugin on the [dedicated plugin Support Forum](https://wordpress.org/support/plugin/flexible-shipping/). Please upgrade to PRO version to get the priority e-mail support as well as all PRO features. [Upgrade Now &rarr;](https://octol.io/fs-repo-up)

== Screenshots ==

1. Flexible Shipping shipping method configuration screen
2. Adding a new Flexible Shipping shipping method
3. Flexible Shipping shipping methods added within a shipping zone
4. Flexible Shipping cost calculation rules table
5. Flexible Shipping shipping methods in the cart


== Upgrade Notice ==

If you are upgrading from the old Flexible Shipping version (1.3.2, woo-flexible-shipping) make sure to completely delete the old version first. If you install the new version without deleting the old one it may break your WordPress installation.

== Changelog ==

= 4.24.17 - 2024-03-13 =
* Updated libraries
* Added AJAX permissions check in onboarding form
* Logger moved to WooCommerce logs

= 4.24.16 - 2024-03-10 =
* Fixed AJAX nonce check in op-in form

= 4.24.15 - 2024-03-07 =
* Fixed missing opt-in permission check

= 4.24.14 - 2024-03-07 =
* Fixed fatal error WC_Shipping_Method on some installations
* Removed empty stylesheets

= 4.24.13 - 2024-02-29 =
* Changed deactivation popup
* Added support for WooCommerce 8.7

= 4.24.12 - 2024-02-21 =
* Fixed free shipping block notices on Firefox

= 4.24.11 - 2024-02-09 =
* Fixed compatibility currency switchers

= 4.24.10 - 2024-02-05 =
* Added support for WooCommerce 8.6

= 4.24.9 - 2024-01-31 =
* Fixed compatibility with CURCY currency switcher
* Removed files reporting by security plugins as potentially dangerous

= 4.24.8 - 2024-01-15 =
* Fixed fatal error on automated emails
* Fixed warnings in PHP 8.2

= 4.24.7 - 2024-01-04 =
* Added support for WooCommerce 8.5
* Fixed block checkout incompatibility with WooCommerce 8.4

= 4.24.6 - 2023-12-21 =
* Fixed conflict with plugins triggering checkout_update action in checkout form by removing free shipping notice from AJAX response

= 4.24.5 - 2023-12-20 =
* Fixed infinite checkout update

= 4.24.4 - 2023-12-19 =
* Fixed infinite checkout update

= 4.24.3 - 2023-12-15 =
* Fixed Save settings button on Flexible Shipping Info page

= 4.24.2 - 2023-12-15 =
* Fixed an error message in block cart

= 4.24.1 - 2023-12-13 =
* Fixed an error when placing an order at the checkout block

= 4.24.0 - 2023-12-12 =
* Added support for WooCommerce 8.4
* Added Left to free shipping notice for WooCommerce Blocks

= 4.23.3 - 2023-11-23 =
* Fixed nonce verification in HPOS bulk actions

= 4.23.2 - 2023-11-22 =
* Fixed HPOS bulk actions for FLexible Shipping integrations (InPost/eNadawca/DPD/DHL/Orlen Paczka/DPD UK)

= 4.23.1 - 2023-11-07 =
* Added support for WooCommerce 8.3

= 4.23.0 - 2023-10-26 =
* Added compatibility with WooCommerce Cart and Checkout Blocks
* Added support for WordPress 6.4

= 4.22.1 - 2023-10-04 =
* Added support for WooCommerce 8.2

= 4.22.0 - 2023-09-06 =
* Changed Baecon script
* Added support for WooCommerce 8.1

= 4.21.7 - 2023-08-07 =
* Added support for WordPress 6.3

= 4.21.6 - 2023-08-03 =
* Added support for WooCommerce 8.0

= 4.21.5 - 2023-07-10 =
* Fixed compatibility with plugins and themes that use newer Psr libraries
* Changed link label on plugins page (Upgrade -> Buy PRO)

= 4.21.4 - 2023-07-03 =
* Added support for WooCommerce 7.9
* Updated Shipping Extensions tab

= 4.21.3 - 2023-06-12 =
* Added support for WooCommerce 7.8

= 4.21.2 - 2023-05-09 =
* Fixed throw exceptions

= 4.21.1 - 2023-04-18 =
* Fixed weight rounding for additional costs

= 4.21.0 - 2023-04-11 =
* Added rating petition in shipping method settings

= 4.20.3 - 2023-04-05 =
* Fixed shipping method settings on WooCommerce 7.5 for RTL languages
* Fixed free shipping assets path

= 4.20.2 - 2023-04-03 =
* Fixed WCML integration

= 4.20.1 - 2023-03-31 =
* Fixed currency switchers integration

= 4.20.0 - 2023-03-29 =
* Added support for WordPress 6.2
* Added support for WooCommerce 7.5
* Added free shipping notice text settings
* Added free shipping progress bar
* Removed NPS
* Fixed PHP 8.1 deprecation messages
* Fixed unhandled exception in additional costs

= 4.19.1 - 2023-02-27 =
* Fixed occasionally fatal error on checkout (shipping item meta)

= 4.19.0 - 2023-02-09 =
* Improved calculated for packages

= 4.18.6 - 2023-01-26 =
* Added support for WooCommerce 7.4
* Fixed fatal error when loading Shipping Zones

= 4.18.5 - 2023-01-25 =
* Added `flexible-shipping/cart/cart-contents` filter
* Rules settings removed from order metadata by default, can be changed by filter `flexible-shipping/order-meta-data/keep-method-rules`
* Added `flexible-shipping/order-meta-data/keep-method-rules` filter

= 4.18.4 - 2023-01-19 =
* Improved calculated for cart value

= 4.18.3 - 2023-01-03 =
* Fixed shipping edit for RTL

= 4.18.2 - 2022-12-27 =
* Fixed exception handling on bulk labels

= 4.18.1 - 2022-12-21 =
* Added support for WooCommerce 7.3
* Fixed bulk labels when multiple integrations in selected orders

= 4.18.0 - 2022-12-13 =
* Added the Shipping Extensions tab
* Improved shipping manifests actions (when availiable for shipping integrations: DPD and InPost)

= 4.17.0 - 2022-11-23 =
* Added the WooCommerce High-Performance Order Storage (HPOS) compatibility declaration
* Added support for WooCommerce 7.2
* Fixed WooCommerce Subscription integration

= 4.16.2 - 2022-11-15 =
* Added extended debug information

= 4.16.1 - 2022-10-27 =
* Fixed Flexible Shipping Info page

= 4.16.0 - 2022-10-20 =
* Added support for WooCommerce 7.1
* Updated Octolize tracker
* Fixed fatal error when handle bulk action

= 4.15.0 - 2022-10-18 =
* Added compatibility with WooCommerce High-Performance Order Storage (HPOS)
* Added support for WordPress 6.1

= 4.14.2 - 2022-10-03 =
* Added support for WooCommerce 7.0

= 4.14.1 - 2022-09-19 =
Fixed group methods in WooCommerce 6.9.2

= 4.14.0 - 2022-08-29 =
Added free shipping notice filters: flexible_shipping_free_shipping_notice_text_message and flexible_shipping_free_shipping_notice_text_button_label

= 4.13.3 - 2022-08-02 =
* Added extended data (matched items) in debug mode

= 4.13.2 - 2022-07-25 =
* Added support for WooCommerce 6.8
* Changed texts in meta boxes

= 4.13.1 - 2022-07-14 =
* Fixed translations

= 4.13.0 - 2022-07-12 =
* Added PRO features list

= 4.12.0 - 2022-07-06 =
* Added support for WooCommerce 6.7
* Changed onboarding
* Fixed php 8.1 error: Return type of FeedbackOption::jsonSerialize() should either be compatible with JsonSerializable::jsonSerialize(): mixed

= 4.11.9 - 2022-06-02 =
* Fixed notice on bulk labels, when no labels available
* Fixed escaping in group Shipping Methods

= 4.11.8 - 2022-05-25 =
* Added support for WooCommerce 6.6
* Fixed PRO Upgrade Box

= 4.11.7 - 2022-05-12 =
* Added support for WordPress 6.0

= 4.11.6 - 2022-04-21 =
* Fixed composer PSR-4 autoload
* Fixed notice: "Undefined index: method_integration"

= 4.11.5 - 2022-04-13 =
* Added outdated PRO version checker

= 4.11.4 - 2022-04-05 =
* Added support for WooCommerce 6.4
* Fixed predefined scenarios modal window

= 4.11.3 - 2022-03-01 =
* Added support for WooCommerce 6.3
* Fixed method title in REST API

= 4.11.2 - 2022-01-20 =
* Added support for WooCommerce 6.2
* Fixed fatal with WOOCS – Currency Switcher for WooCommerce

= 4.11.1 - 2022-01-04 =
* Added support for WordPress 5.9
* Added support for WooCommerce 6.1
* Added contextual info for USPS
* Removed global log file capture

= 4.11.0 - 2021-12-06 =
* Added FS methods duplication

= 4.10.1 - 2021-11-18 =
* Removed unnecessary tax calculation when free shipping

= 4.10.0 - 2021-11-08 =
* Removed "Default" settings - default shipping can be set by changing methods order in shipping zone
* Fixed assets: notices assets enqueued only for administrators

= 4.9.0 - 2021-10-12 =
* Added default rule for new shipping method
* Added support for Onboarding in FS PRO

= 4.8.5 - 2021-10-12 =
* Fixed integration metabox CSS
* Fixed fatal error on fs-shipment library

= 4.8.4 - 2021-10-04 =
* Fixed Left to free shipping notice in the cart

= 4.8.3 - 2021-09-23 =
* Added support for predefined scenarios in PRO version

= 4.8.2 - 2021-09-08 =
* Fixed contextual info for Orlen Paczka

= 4.8.1 - 2021-08-31 =
* Improved NPS

= 4.8.0 - 2021-08-23 =
* Added ability to choose a shipping cost with or without tax

= 4.7.2 - 2021-08-10 =
* Fixed fatal error on subscription renewal in InPost integration
* Changed text above table rule

= 4.7.1 - 2021-07-22 =
* Fixed fatal error on subscription renewal

= 4.7.0 - 2021-07-20 =
* Changed functionality for shipping integrations: DPD UK, InPost and others
* Fixed free shipping label when negative cost calculated and set as 0 (zero)

= 4.6.1 - 2021-06-21 =
* Changed notice type for Left Free Shipping message
* Fixed fatal error with CoCart plugin: added parameters types verification in Free Shipping Notice

= 4.6.0 - 2021-06-07 =
* Added NPS

= 4.5.1 - 2021-06-02 =
* Added additional costs methods to tracking
* Fixed calculation additional costs
* Fixed initial checkout validation when free shipping notice displayed

= 4.5.0 - 2021-05-11 =
* Added support for shipping method settings in condition
* Added support for logical operators in conditions
* Changed condition list - added groups
* Fixed free shipping message translation with Loco Translate
* Fixed free shipping message after changing State on checkout
* Fixed default shipping method for multiple packages
* Fixed weight rounding on cart contents
* Removed strong typing in action

= 4.4.1 - 2021-04-28 =
* Fixed Germanized Plugin compatibility with single shipping method

= 4.4.0 - 2021-04-27 =
* Added support WooCommerce Subscription with Integrations, ie. WP Desk Inpost Plugin
* Added support for Currency Switcher for WooCommerce plugin
* Fixed notice about free shipping when using WPML
* Fixed integration with Paczka w Ruchu plugin
* Fixed support for html tags in shipping method description in order details

= 4.3.1 - 2021-04-20 =
* Added support for html tags in shipping method description
* Fixed invalid default label for autocomplete fields
* Fixed visibility Flexible Shipping Info as Shipping method during edit order

= 4.3.0 - 2021-04-15 =
* Fixed broken table rate for FS Locations plugin
* Changed notice free shipping if store use any additional plugins to split the shipment into packages
* Fixed notice about free shipping on thank you page
* Added Cart Calculation setting

= 4.2.0 - 2021-03-31 =
* Added notice when the configuration of shipping zones may cause problems
* Added support for `woocommerce_shipping_instance_form_fields_flexible_shipping_single` filter
* Fixed input select multiple fields when fast typing
* Fixed duplicate notices with free shipping message

= 4.1.4 - 2021-03-24 =
* Fixed missing JavaScript function

= 4.1.3 - 2021-03-23 =
* Fixed FS Pro Box position
* Changed FS Pro Box styling
* Changed FS Info tab
* Added redirection to FS Info Tab after first plugin activation

= 4.1.2 - 2021-03-05 =
* Fixed duplicated shipping methods on old installations

= 4.1.1 - 2021-03-04 =
* Added conditions input data filters: flexible-shipping/condition/contents_value and flexible-shipping/condition/contents_weight
* Added selling box on Flexible Shipping Method
* Added write protection if the rules table wasn’t loaded
* Fixed polylang integration
* Changed default table rules

= 4.1.0 - 2021-03-01 =
* Added Ready-made shipping scenarios library
* Added Flexible Shipping Import / Export new plugin compatibility
* Added Flexible Shipping single method instead of previously used and deprecated group one
* Fixed an issue with not triggering unclosed rules ranges for specific conditions
* Fixed an issue with downloading the shipping labels if cache plugins enabled
* Fixed an issue with rules table dissappearing after deleting the shipping class

= 4.0.10 - 2021-02-11 =
* Added support for WooCommerce 5.0

= 4.0.9 - 2021-02-03 =
* Fixed debug input data for None rule
* Added support for RTL in Table Rate interface

= 4.0.8 - 2021-01-21 =
* Fixed free shipping calculation when shipping classes used
* Fixed scripts for hebrew installations
* Added input data for additional costs in debug messages

= 4.0.7 - 2020-12-30 =
* Fixed links on Flexible Shipping Info page

= 4.0.6 - 2020-12-28 =
* Fixed calculation for rules with multiple conditions

= 4.0.5 - 2020-12-23 =
* Fixed Invalid argument supplied for foreach() shipping-method.php

= 4.0.4 - 2020-12-22 =
* Fixed free shipping notice functionality
* Tracker opt-in notice shows once
* Fixed duplicate notices with free shipping message

= 4.0.3 - 2020-12-21 =
* Removed rounding on cost per order value

= 4.0.2 - 2020-12-17 =
* Fixed conflict with "WC - APG Free Shipping" plugin

= 4.0.1 - 2020-12-16 =
* Updated compatibility library

= 4.0.0 – 2020-12-15
* Major Update!
* Added new shipping cost calculation rules' table interface
* Dropped support and backward compatibility for Flexible Shipping PRO 1.13.3 and Flexible Shipping Locations 1.2.2.

= 3.16.5 - 2020-12-07 =
* Added support for WordPress 5.6

= 3.16.4 - 2020-11-30 =
* Fixed Active Payments integration

= 3.16.3 - 2020-11-30 =
* Fixed contextual info for DPD UK
* Changed Author URI
* Fixed scroll to notice with free shipping message
* Fixed "Invalid argument supplied for foreach() shipping-method.php on line 210" error

= 3.16.2 - 2020-11-18 =
* Added support for WooCommerce 4.7

= 3.16.1 - 2020-11-05 =
* Fixed broken JavaScript in checkout
* Fixed conflict with "WC - APG Free Shipping" plugin

= 3.16.0 - 2020-10-28 =
* Added new rules table popup
* Added flexible_shipping_checkout_shipment_created filter
* Fixed handling query parameters on some themes, ie. Avada
* Updated tracker library

= 3.15.0 - 2020-10-22 =
* Added documentation Beacon
* Added Cart Calculation field for export

= 3.14.4 - 2020-10-08 =
* Fixed Java Script path

= 3.14.3 - 2020-10-05 =
* Fixed new rules table CSS

= 3.14.2 - 2020-10-01 =
* Fixed missing jQuery for free shipping notice

= 3.14.1 - 2020-09-30 =
* Fixed free shipping notice when no minimum order amount present

= 3.14.0 - 2020-09-28 =
* Added debug mode
* Fixed admin assets loading
* Fixed COD Enable for shipping methods

= 3.13.1 - 2020-09-14 =
* Removed AB test variants on plugin deactivation
* Removed test on rating notice

= 3.13.0 - 2020-09-09 =
* Removed tax calculation method notice
* Removed redundant shipments data
* Fixed negative rate costs
* Added weight rounding on cart contents

= 3.12.0 - 2020-09-03 =
* Added free shipping notice
* Removed Integrations settings when no integrations available

= 3.11.4 - 2020-08-26 =
* Fixed 404 for bulk actions on some servers

= 3.11.3 - 2020-08-20 =
* Fixed deprecated jQuery methods

= 3.11.2 - 2020-08-13 =
* Fixed PHP sessions issues

= 3.11.1 - 2020-08-11 =
* Modified New Table Interface test
* Added support for WordPress 5.5

= 3.11.0 - 2020-07-30 =
* Added ability to open shipment label in new tab - works with some integrations

= 3.10.0 - 2020-07-15 =
* Added ability to test New Table Interface

= 3.9.21 - 2020-06-23 =
* Fixed Aelia Currency Switcher integration

= 3.9.20 - 2020-06-01 =
* Added support for WooCommerce 4.2

= 3.9.19 - 2020-05-05 =
* Added package items on shipping in admin order page
* Fixed infinite loop with third party shipping methods

= 3.9.18 - 2020-04-28 =
* Added integration with WooCommerce Multi-Currency plugin

= 3.9.17 - 2020-04-24 =
* Added Beacon functionality for Flexible Shipping PRO
* Changed PRO advertising

= 3.9.16 - 2020-04-14 =
* Fixed warning in cart and checkout when no shipping methods selected

= 3.9.15 - 2020-04-07 =
* Added JavaScript trigger after AJAX call for WP Desk shipping integrations

= 3.9.14 - 2020-03-27 =
* Added contextual info for DHL Express

= 3.9.13 - 2020-03-18 =
* Fixed icon for shipments with manifest created status

= 3.9.12 - 2020-03-17 =
* Added support for WooCommerce 4.0

= 3.9.11 - 2020-03-09 =
* Added additional security hardenings
* Fixed integrations link

= 3.9.10 - 2020-03-02 =
* Added bulk labels functionality - ability to print multiple labels in one file

= 3.9.9 - 2020-02-17 =
* Added log messages in WPDesk_Flexible_Shipping_Shipment class.
* Fixed fatal error in checkout: strongly typed array in woocommerce_shipping_chosen_method filter

= 3.9.7 - 2020-02-04 =
* Fixed import method with existing title

= 3.9.6 - 2020-01-03 =
* Added flexible_shipping_is_free_shipping filter

= 3.9.5 - 2020-01-03 =
* Added support for WooCommerce 3.9

= 3.9.4 - 2019-12-11 =
* Fixed WPML string translations compatibility

= 3.9.3 - 2019-10-07 =
* Added shipment data to WooCommerce REST API Order response
* Added A/B Tests on deactivation form
* Changed deactivation form to popup window
* Removed A/B Tests for pointer messages

= 3.9.2 - 2019-10-04 =
* Added support for WooCommerce 3.8 and Wordpress 5.3

= 3.9.1 - 2019-10-21 =
* Fixed tracker loader

= 3.9.0 - 2019-10-07 =
* Added prefixed libraries
* Fixed js problem with select2

= 3.7.0 - 2019-07-28 =
* Flexible Shipping Connect has been removed

= 3.6.4 - 2019-08-21 =
* Remove connect shutdown notice
* Removed Connect Sign up ability in shipping method settings
* Changed label for Calculation Method to Rules Calculation on shipping method settings

= 3.6.3 - 2019-08-12 =
* Added support for WooCommerce 3.7

= 3.6.2 - 2019-08-05 =
* Fixed Fatal error: boolean given in mutex

= 3.6.1 - 2019-07-30 =
* Connect shutdown notice
* Removed connect for new users

= 3.6.0 - 2019-07-24 =
* Added filter flexible_shipping_csv_delimiter to CSV delimiter
* Fixed support for &#44; in exported csv file
* Fixed import speed for more complex shipment methods

= 3.5.1 - 2019-07-11 =
* Fixed rare change for fatal error when activating plugin

= 3.5.0 - 2019-07-10 =
* Most code moved to shared libraries

= 3.4.0 - 2019-05-22 =
* Added new filter wpdesk_is_wp_log_capture_permitted

= 3.3.14 - 2019-05-20 =
* Fixed logs hijack even when log is disabled

= 3.3.13 - 2019-05-13 =
* Fixed fatal when can't unserialize the token from persistence container
* Added option of hiding the FS Connect box
* Added plugin rate notice
* Fixed CSS select height

= 3.3.12 - 2019-05-08 =
* Fixed export/import for shipping classes with comma in name

= 3.3.11 - 2019-05-06 =
* Fixed chance for exception when using woocommerce logger

= 3.3.10 - 2019-05-06 =
* Changed logs library to the newest version

= 3.3.9 - 2019-04-25 =
* Fixed tag version

= 3.3.8 - 2019-04-25 =
* Fixed conflict with wp-notice/wp-logs library

= 3.3.7 - 2019-04-23 =
* Changed priority for shipping creation hook for shipping integrations

= 3.3.6 - 2019-04-16 =
* Fixed export - to many methods in export file

= 3.3.5 - 2019-04-10 =
* Fixed polish translations

= 3.3.4 - 2019-04-10 =
* Removed Flexible Shipping menu

= 3.3.3 - 2019-04-04 =
* Fixed notices in order meta box
* Fixed changelog entries

= 3.3.2 - 2019-04-02 =
* Fixed weight calculation for float weight values
* Conditional logic on fields in order meta box

= 3.3.1 - 2019-04-01 =
* Fixed CSV import with multiple shipping classes

= 3.3.0 - 2019-03-19 =
* Added support for EDT (Electronic Trade Documents)

= 3.2.0 - 2019-03-11 =
* Added support for UPS Access Points for FS Connect
* Removed argument types for WooCommerce types (ie. WC_Order)

= 3.1.12 - 2019-03-05 =
* Fixed inifinite method call on WooCommerce 3.1

= 3.1.11 - 2019-02-27 =
* Fixed empty description in commodities (customs values)

= 3.1.10 - 2019-02-27 =
* Fixed price calculation in customs values

= 3.1.9 - 2019-02-21 =
* Fixed fatal error on wp-notice library

= 3.1.8 - 2019-02-19 =
* Fixed error handling on bulk labels generation
* Fixed polish translation for Create

= 3.1.7 - 2019-02-12 =
* Fixed warnings in cart or checkout when shipment default method is not valid for current package

= 3.1.6 - 2019-02-07 =
* Added filter for deactivation data in tracker

= 3.1.5 - 2019-02-04 =
* Fixed parameters order in notice constructor
* Fixed default shipment method in cart/checkout

= 3.1.4 - 2019-01-28 =
* Fixed fatal when free shipment
* Fixed issue for shipment with no costs

= 3.1.3 - 2019-01-23 =
* Tweaked pl translation
* Fixed issues on shipment creating by FS Connect

= 3.1.2 - 2019-01-16 =
* Fixed adding slashes to title and description
* Fixed error on saving integration settings when no service settings are saved
* Fixed configuration of shipping method integration form when multiple integrations enabled

= 3.1.1 - 2018-12-20 =
* Fixed label file extension

= 3.1 - 2018-12-13 =
* Added Cache settings in FS Connect Advanced settings
* Added info and link to planned integrations
* Added support for not allowed demo domain
* Fixed missing tracker message
* Fixed typo in Connect notices
* Fixed COD Enable for shipping methods functionality
* Fixed UK counties
* Fixed for free shipping zero value in settings

= 3.0.7 - 2018-12-07 =
* Added define to change shop saas domain using SAAS_FLEXIBLESHIPPING_URL_SHOP_DOMAIN
* Added filter to change shop saas domain flexible_shipping_saas_domain
* Fixed required PHP version
* Fixed missing manifests functions
* Fixed typo in connect notice
* Fixed translations in integration settings

= 3.0.6 - 2018-11-29 =
* Added Flexible Shipping Connect to create packages and generate shipping labels automatically from WooCommerce Orders list and manually from each order
* Added integration with UPS (Worldwide). Now you can connect your shop with your UPS account. No extra software is needed. You can cover the whole shipping process directly from your UPS WooCommerce environment.

= 3.0.5 - 2018-11-28 =
* Fixed residential address and send-as field from saas
* Fixed empty services handler

= 3.0.4 - 2018-11-22 =
* Fixed live rates on non supported service should not to initialize
* Fixed negotiated rates in live rates

= 3.0.4 - 2018-11-09 =
* Fixed negotiated rates

= 3.0.3 - 2018-11-09 =
* Fixed urls

= 3.0.0 - 2018-11-07 =
* First release of flexibleshipping.com platform integration
* Fixed multiple shipments in some cases

= 2.1.10 - 2018-10-17 =
Fixed error 500 after update to 2.1.8/2.1.9 version

= 2.1.9 - 2018-10-17 =
Fixed error 500 after update to 2.1.8 version

= 2.1.8 - 2018-10-16 =
* Added support for WooCommerce 3.5
* Dropped support for WooCommerce below 3.0 (the plugin may still work with older versions but we do not declare official support)
* Fixed multiple shipments in some cases

= 2.1.7 - 2018-09-05 =
* Fixed issue with the generation of many shipments for one order

= 2.1.6 - 2018-06-26 =
* Fixed error with conflict static tracker

= 2.1.5 - 2018-06-25 =
* Tweaked tracker data anonymization
* Fixed tracker notice

= 2.1.4 - 2018-06-11 =
* Fixed missing metabox Add Shipment in WooCommerce 3.4

= 2.1.3 - 2018-05-29 =
* Fixed opt-in/opt-out links

= 2.1.2 - 2018-05-23 =
* Added support for WooCommerce 3.4

= 2.1.1 - 2018-05-10 =
* Fixed calculation method message when taxes disabled
* Fixed session starting - do not start session in AJAX calls

= 2.1 - 2018-05-07 =
* Added Flexible Shipping tab on WooCommerce Shipping
* Tweaked calculation method for shipping rules - based on WooCommerce tax display
* Fixed display printer name on order edit
* Fixed notice after all rules delete

= 2.0.1 - 2018-03-01 =
* Fixed problems with deactivation plugin on multisite
* Fixed WP Desk Tracker warning after enabling the plugin

= 2.0 - 2018-01-24 =
* Added support for WooCommerce 3.3
* Fixed installing the plugin by wp-cli
* Fixed error on cart page for WooCommerce below 3.2

= 1.9.12 - 2017-12-22 =
* Fixed generating empty zip file for labels with no shipment
* Fixed some minor notices with WooCommerce 3.2.x

= 1.9.11 - 2017-11-20 =
* Fixed shipment filtering for shipping integrations
* Fixed saving decimal values for free shipping

= 1.9.10 - 2017-10-10 =
* Added support for WooCommerce 3.2

= 1.9.9 - 2017-09-25 =
* Fixed parse error on PHP 5.3 after update to version 1.9.8

= 1.9.8 - 2017-09-11 =
* Added compatibility with WooCommerce DPD UK 1.0

= 1.9.7 - 2017-08-09 =
* Added compatibility with Flexible Shipping PRO 1.5

= 1.9.6 - 2017-07-27 =
* Fixed a problem with WPML when using multiple currencies
* Fixed an error when product weight is not set
* Tweaked message in WP Desk Tracker class

= 1.9.5 - 2017-07-14 =
* Added support for WooCommerce 3.1
* Fixed display shipping methods after adding Flexible Shipping to COD payment method

= 1.9.4 - 2017-06-22 =
* Added support for WordPress below 4.7 in the WP Desk Tracker class
* Fixed shipping methods export in Flexible Shipping PRO

= 1.9.3 - 2017-06-13 =
* Added compatibility with WooCommerce DPD 1.0
* Integrated WP Desk Tracker class to help us understand how you use the plugin (you need to opt in to enable it)

= 1.9.2 - 2017-06-07 =
* Added compatibility with WooCommerce InPost 3.4

= 1.9.1 - 2017-06-02 =
* Added compatibility with WooCommerce InPost 3.3

= 1.9 - 2017-03-30 =
* Added support for upcoming WooCommerce 3.0
* Added support for bulk shipping available in our shipping integrations

= 1.8 - 2017-01-24 =
* Added CSV import for shipping methods including rules
* Added WooCommerce Currency Switcher support
* Added shipping classes support in WPML
* Changed cart weight calculting to WC()->cart->cart_contents_weight
* Dropped support for WooCommerce 2.4 and lower
* Removed Enable checkbox in general settings

= 1.7 - 2016-12-14 =
* Added WPML and Polylang support
* Added custom "free shipping" label
* Removed decrecated enable/disable for main shipping method
* Fixed choosing default shipping method in the checkout

= 1.6.2 - 2016-10-26 =
* Tweaked support for the default "Rest of the world" shipping zone
* Added support for "Network activated" WooCommerce on Multisite installations

= 1.6.1 - 2016-10-14 =
* Added information about DHL WooCommerce integration

= 1.6 - 2016-09-29 =
* Added support for Flexible Shipping Locations Add-On
* Fixed WooCommerce 2.3.x compatibility

= 1.5 - 2016-09-12 =
* Added support for currency switching: WPML, Aelia Currency Switcher, Multi Currency Store
* Added optional shipping method description

= 1.4.1 - 2016-06-17 =
* Fixed default shipping method in the checkout

= 1.4 - 2016-06-14 =
* Converted to English
* Added Polish (pl_PL) translation
* Added FREE and PRO versions

= 1.3.2 - 2016-04-12 =
* Fixed a few notices

= 1.3.1 - 2016-03-14 =
* Fixed default shipping method in the checkout

= 1.3 - 2016-03-07 =
* Added enabling shipping method only for logged in users
* Fixed a notice in generate_shipping_methods_html

= 1.2 - 2016-01-26 =
* Automatic updates

= 1.1.1 - 2015-12-01 =
* Added WooCommerce 2.3 compatibility

= 1.0 - 2015-11-03 =
* First release!
FreeShippingBlock.php                                                                                                                                                                                                                                          2856          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Blocks/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\Blocks\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\TableRate\FreeShipping\FreeShippingNoticeData;

class FreeShippingBlock implements Hookable {

	const BLOCK_NAME = 'flexible-shipping/free-shipping-notice';

	/**
	 * @var string[]
	 */
	private $session_variable_names;

	/**
	 * FreeShippingBlock constructor.
	 *
	 * @param string[] $session_variable_names .
	 */
	public function __construct( $session_variable_names ) {
		if ( ! is_array( $session_variable_names ) ) {
			$session_variable_names = [];
		}
		$this->session_variable_names = $session_variable_names;
	}

	public function hooks() {
		add_action( 'init', [ $this, 'create_free_shipping_notice_block' ] );
		add_action( 'rest_api_init', [ $this, 'add_free_shipping_notice_endpoint' ] );
	}

	public function add_free_shipping_notice_endpoint() {
		register_rest_route(
			'flexible-shipping/v1',
			'/free-shipping-notice',
			[
				'methods'             => 'GET',
				'callback'            => [ $this, 'get_free_shipping_notices' ],
				'permission_callback' => '__return_true',
			]
		);
	}

	public function get_free_shipping_notices() {
		$free_shipping_notices = [];
		foreach ($this->get_free_shipping_notices_data() as $free_shipping_notice_data) {
			$free_shipping_notices[] = [
				'content' => apply_filters( 'flexible-shipping/free-shipping/render-notice', $free_shipping_notice_data ),
				'blocks'  => apply_filters( 'flexible-shipping/free-shipping-block/allowed-blocks', [
					'checkout',
					'cart'
				], $free_shipping_notice_data ),
			];
		}

		return $free_shipping_notices;
	}

	public function create_free_shipping_notice_block() {
		register_block_type(
			__DIR__ . '/../../../../../assets/blocks/free-shipping-notice',
			[
				'render_callback' => [ $this, 'render' ],
			]
		);
	}

	public function render() {
		return '<div class="flexible-shipping-free-shipping-root"></div>';
	}

	/**
	 * @return FreeShippingNoticeData[]
	 */
	private function get_free_shipping_notices_data() {
		$free_shipping_notice_data = [];
		$session_variable_names = apply_filters( 'flexible-shipping/free-shipping-block/session-variables', $this->session_variable_names );
		if ( ! is_array( $session_variable_names) ) {
			return [];
		}
		foreach ( $session_variable_names as $session_variable_name ) {
			$session_data = $this->get_session()->get( $session_variable_name, '' );
			if ( $session_data instanceof FreeShippingNoticeData ) {
				$free_shipping_notice_data[] = $session_data;
			}
			if ( is_array( $session_data ) ) {
				$free_shipping_notice_data[] = FreeShippingNoticeData::create_from_array( $session_data );
			}
		}

		return $free_shipping_notice_data;
	}

	protected function get_session() {
		if ( WC()->session === null ) {
			WC()->initialize_session();
		}
		return WC()->session;
	}

}
FreeShippingStoreEndpointData.php                                                                                                                                                                                                                              1090          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Blocks/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\Blocks\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

class FreeShippingStoreEndpointData implements Hookable {

	/**
	 * @var string
	 */
	private $integration_name;

	public function __construct( string $integration_name ) {
		$this->integration_name = $integration_name;
	}

	public function hooks() {
		add_filter( 'octolize-checkout-block-integration-' . $this->integration_name .  '-data', [ $this, 'integration_data' ] );
		add_filter( 'octolize-checkout-block-integration-' . $this->integration_name .  '-schema', [ $this, 'integration_schema' ] );
	}

	/**
	 * @param array $data
	 *
	 * @return array <string, array<string, bool>>
	 */
	public function integration_data( $data ) {
		return [
			'page_type' => $this->get_page_type(),
		];
	}

	private function get_page_type() {
		return is_checkout() ? 'checkout' : ( is_cart() ? 'cart' : 'other' );
	}

	/**
	 * @param array $schema
	 *
	 * @return array
	 */
	public function integration_schema( $schema ) {
		$schema['page_type']['type'] = [ 'string' ];

		return $schema;
	}

}
FlexibleShippingMethodsChecker.php                                                                                                                                                                                                                             785           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Helpers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
/**
 * Class FlexibleShippingMethodsChecker
 *
 * @package WPDesk\FS\Helpers
 */

namespace WPDesk\FS\Helpers;

use WPDesk\FS\TableRate\DefaultRulesSettings;

/**
 * Checker for FS Methods.
 */
class FlexibleShippingMethodsChecker {
	/**
	 * @return bool
	 */
	public function is_new_shipping_method(): bool {
		$shipping_methods = flexible_shipping_get_all_shipping_methods();

		if ( ! isset( $shipping_methods['flexible_shipping'] ) ) {
			return false;
		}

		$flexible_shipping_rates = array_values( $shipping_methods['flexible_shipping']->get_all_rates() );

		if ( empty( $flexible_shipping_rates ) || count( $flexible_shipping_rates ) > 1 ) {
			return false;
		}

		return isset( $flexible_shipping_rates[0]['method_rules'][0][ DefaultRulesSettings::NEW_FIELD ] );
	}
}
ShippingMethod.php                                                                                                                                                                                                                                             1631          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Helpers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
/**
 * Helpers for Shipping method.
 *
 * @package WPDesk\FS\TableRate\NewRulesTablePointer
 */

namespace WPDesk\FS\Helpers;

/**
 * Collection of helpers for Shipping method.
 */
class ShippingMethod {

	/**
	 * Pattern of option with Flexible Shipping methods.
	 *
	 * @var string
	 */
	const FS_METHODS_OPTION_PREFIX = 'flexible_shipping_methods_%d';

	/**
	 * Checks if there are Flexible Shipping methods in the Shipping Zones.
	 *
	 * @param string $method_name Name of Shipping method.
	 *
	 * @return bool Status.
	 */
	public static function check_if_method_exists_in_zones( $method_name ) {
		$zones = \WC_Shipping_Zones::get_zones();
		foreach ( $zones as $zone ) {
			$zone_instance = \WC_Shipping_Zones::get_zone( $zone['zone_id'] );

			if ( self::check_if_method_exists_in_zone( $method_name, $zone_instance ) === true ) {
				return true;
			}
		}

		return false;
	}

	/**
	 * Checks if there are Flexible Shipping methods in the Shipping Zone.
	 *
	 * @param string            $method_name Name of Shipping method.
	 * @param \WC_Shipping_Zone $zone_instance Instance of Shipping Zone.
	 *
	 * @return bool Status.
	 */
	private static function check_if_method_exists_in_zone( $method_name, $zone_instance ) {
		$zone_methods = $zone_instance->get_shipping_methods();
		foreach ( $zone_methods as $zone_method ) {
			if ( $zone_method->id !== $method_name ) {
				continue;
			}

			$option_key       = sprintf( self::FS_METHODS_OPTION_PREFIX, $zone_method->instance_id );
			$shipping_methods = get_option( $option_key, [] );
			if ( $shipping_methods ) {
				return true;
			}
		}

		return false;
	}

}
WooSettingsPageChecker.php                                                                                                                                                                                                                                     1430          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Helpers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
/**
 * Class WooSettingsPageChecker
 *
 * @package WPDesk\FS\Helpers
 */

namespace WPDesk\FS\Helpers;

use WC_Shipping_Method;
use WC_Shipping_Zones;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Helper for WooCommerce Settings Page.
 */
class WooSettingsPageChecker {
	/**
	 * @return bool
	 */
	public function is_fs_instance_method_edit(): bool {
		$tab  = $this->filter_input( INPUT_GET, 'tab' );
		$page = $this->filter_input( INPUT_GET, 'page' );

		if ( 'wc-settings' !== $page || 'shipping' !== $tab ) {
			return false;
		}

		$instance_id = absint( wp_unslash( $this->filter_input( INPUT_GET, 'instance_id' ) ) );

		if ( ! $instance_id ) {
			return false;
		}

		$shipping_method = $this->get_shipping_method( $instance_id );

		if ( ! $shipping_method ) {
			return false;
		}

		return is_a( $shipping_method, WPDesk_Flexible_Shipping::class ) || is_a( $shipping_method, ShippingMethodSingle::class );
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return bool|WC_Shipping_Method
	 * @codeCoverageIgnore
	 */
	protected function get_shipping_method( int $instance_id ) {
		return WC_Shipping_Zones::get_shipping_method( $instance_id );
	}

	/**
	 * @param int    $type     .
	 * @param string $var_name .
	 *
	 * @return mixed
	 * @codeCoverageIgnore
	 */
	protected function filter_input( int $type, string $var_name ) {
		return filter_input( $type, $var_name );
	}
}
FSIE.php                                                                                                                                                                                                                                                       922           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Class FSIE.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

/**
 * FSIE metabox.
 */
class FSIE extends Metabox {
	/**
	 * WooCommerceABC constructor.
	 */
	public function __construct() {
		$title = __( 'Extend the Flexible Shipping capabilities with functional add-ons', 'flexible-shipping' );

		parent::__construct( 'fsie', $title, $this->get_body_content(), $this->get_footer_content() );
	}

	/**
	 * @return string
	 */
	private function get_body_content() {
		ob_start();

		include 'views/fsie.php';

		return ob_get_clean();
	}

	/**
	 * @return string
	 */
	private function get_footer_content() {
		$url = get_locale() === 'pl_PL' ? 'https://octol.io/fs-info-addons-pl' : 'https://octol.io/fs-info-addons';

		return '<a class="button button-primary" href="' . esc_url( $url ) . '" target="_blank">' . __( 'Buy Flexible Shipping Add-ons &rarr;', 'flexible-shipping' ) . '</a>';
	}
}
FSPro.php                                                                                                                                                                                                                                                      887           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Class FSPro.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

/**
 * FS Pro metabox.
 */
class FSPro extends Metabox {
	/**
	 * WooCommerceABC constructor.
	 */
	public function __construct() {
		$title = __( 'Get Flexible Shipping PRO!', 'flexible-shipping' );

		parent::__construct( 'fs-pro', $title, $this->get_body_content(), $this->get_footer_content() );
	}

	/**
	 * @return string
	 */
	private function get_body_content() {
		ob_start();

		include 'views/fs-pro.php';

		return ob_get_clean();
	}

	/**
	 * @return string
	 */
	private function get_footer_content() {
		$url = get_user_locale() === 'pl_PL' ? 'https://octol.io/fs-info-pro-pl' : 'https://octol.io/fs-info-pro';

		return '<a class="button button-primary" href="' . esc_url( $url ) . '" target="_blank">' . __( 'Upgrade now to PRO version &rarr;', 'flexible-shipping' ) . '</a>';
	}
}
FSWalkthrough.php                                                                                                                                                                                                                                              1513          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Class FSWalkthrough.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

use WPDesk\FS\Info\Metabox\Links;

/**
 * Metabox Flexible Shipping walkthrough.
 */
class FSWalkthrough extends Links {
	/**
	 * FSWalkthrough constructor.
	 */
	public function __construct() {
		$title        = __( 'Flexible Shipping walkthrough', 'flexible-shipping' );
		$footer_label = __( 'Learn more about Flexible Shipping &rarr;', 'flexible-shipping' );
		$footer_url   = 'https://octol.io/fs-info-docs';

		parent::__construct( 'fs-walkthrough', $title, $this->generate_footer( $footer_url, $footer_label ) );
	}

	/**
	 * @return array[]
	 */
	protected function get_links() {
		return array(
			array(
				'label' => __( 'How to add a new shipping method handled by Flexible Shipping?', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-fs-new-method',
			),
			array(
				'label' => __( 'A complete guide to shipping methods', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-complete-guide',
			),
			array(
				'label' => __( 'Disable or hide the shipping method', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-disable-method',
			),
			array(
				'label' => __( 'Advanced options and customization', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-advanced-options',
			),
			array(
				'label' => __( 'Combine shipping classes in Flexible Shipping', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-combine-shipping-classes',
			),
		);
	}
}
FSWalkthroughPL.php                                                                                                                                                                                                                                            1519          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Class FSWalkthroughPL.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

use WPDesk\FS\Info\Metabox\Links;

/**
 * Metabox Flexible Shipping walkthrough.
 */
class FSWalkthroughPL extends Links {
	/**
	 * FSWalkthrough constructor.
	 */
	public function __construct() {
		$title        = __( 'Flexible Shipping walkthrough', 'flexible-shipping' );
		$footer_label = __( 'Learn more about Flexible Shipping &rarr;', 'flexible-shipping' );
		$footer_url   = 'https://octol.io/fs-info-docs-pl';

		parent::__construct( 'fs-walkthrough', $title, $this->generate_footer( $footer_url, $footer_label ) );
	}

	/**
	 * @return array[]
	 */
	protected function get_links() {
		return array(
			array(
				'label' => __( 'How to add a new shipping method handled by Flexible Shipping?', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-konfiguracja',
			),
			array(
				'label' => __( 'A complete guide to shipping methods', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-konfiguracja-metody',
			),
			array(
				'label' => __( 'Disable or hide the shipping method', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-wylaczanie-metody',
			),
			array(
				'label' => __( 'Advanced options and customization', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-zaawansowane',
			),
			array(
				'label' => __( 'Combine shipping classes in Flexible Shipping', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-laczenie-klas-wysylkowych',
			),
		);
	}
}
Links.php                                                                                                                                                                                                                                                      1144          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info/Metabox                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class Links
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info\Metabox;

use WPDesk\FS\Info\Metabox;

/**
 * Metabox with links.
 */
abstract class Links extends Metabox {
	/**
	 * Links constructor.
	 *
	 * @param string $id     .
	 * @param string $title  .
	 * @param string $footer .
	 */
	public function __construct( $id, $title, $footer = '' ) {
		$body = $this->generate_body();

		parent::__construct( $id, $title, $body, $footer );
	}

	/**
	 * @return string
	 */
	private function generate_body() {
		$body = '';

		foreach ( $this->get_links() as $link ) {
			$body .= sprintf( '<li><span class="link-arrow">&#9654;</span>&nbsp;&nbsp;<a href="%s" target="_blank">%s</a></li>', esc_url( $link['href'] ), $link['label'] );
		}

		return sprintf( '<ul class="links">%s</ul>', $body );
	}

	/**
	 * @param string $url   .
	 * @param string $label .
	 *
	 * @return string
	 */
	protected function generate_footer( $url, $label ) {
		return sprintf( '<a href="%s" class="read-more" target="_blank">%s</a>', $url, $label );
	}

	/**
	 * @return array[]
	 */
	protected function get_links() {
		return array();
	}
}
Metabox.php                                                                                                                                                                                                                                                    1551          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Info Metabox.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

/**
 * Metabox in FS Info.
 */
class Metabox {

	/**
	 * @var string
	 */
	private $id;

	/**
	 * @var string
	 */
	private $title;

	/**
	 * @var string
	 */
	private $body;

	/**
	 * @var string
	 */
	private $footer;

	/**
	 * Metabox constructor.
	 *
	 * @param string $id     .
	 * @param string $title  .
	 * @param string $body   .
	 * @param string $footer .
	 */
	public function __construct( $id, $title, $body = '', $footer = '' ) {
		$this->id     = $id;
		$this->title  = $title;
		$this->body   = $body;
		$this->footer = $footer;
	}

	/**
	 * @return string
	 */
	public function get_id() {
		return $this->id;
	}

	/**
	 * @return string
	 */
	public function get_title() {
		return $this->title;
	}

	/**
	 * @return string
	 */
	public function get_body() {
		return $this->body;
	}

	/**
	 * @return string
	 */
	public function get_footer() {
		return $this->footer;
	}

	/**
	 * @return bool
	 */
	public function has_title() {
		return strlen( $this->title ) > 0;
	}

	/**
	 * @return bool
	 */
	public function has_body() {
		return strlen( $this->body ) > 0;
	}

	/**
	 * @return bool
	 */
	public function has_footer() {
		return strlen( $this->footer ) > 0;
	}

	/**
	 * @return string
	 */
	public function get_classes() {
		$classes = array( 'fs-info-metabox' );

		if ( $this->has_title() ) {
			$classes[] = 'has-title';
		}

		if ( $this->has_footer() ) {
			$classes[] = 'has-footer';
		}

		return implode( ' ', $classes );
	}
}
Video.php                                                                                                                                                                                                                                                      638           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Class Video.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

/**
 * Video metabox.
 */
class Video extends Metabox {
	/**
	 * WooCommerceABC constructor.
	 */
	public function __construct() {
		parent::__construct( 'video', '', $this->get_body_content() );
	}

	/**
	 * @return string
	 */
	private function get_body_content() {
		$youtube_url = 'https://www.youtube.com/embed/ov1Ff-_A268';

		return '<p style="text-align:center;"><iframe width="688" height="387" src="' . esc_url( $youtube_url ) . '?rel=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></p>';
	}
}
fs-pro.php                                                                                                                                                                                                                                                     625           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * @package WPDesk\FS\Info
 */

?>
<ul class="fs-pro-features">
	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Shipping Classes support', 'flexible-shipping' ); ?>
	</li>

	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Product count based costs', 'flexible-shipping' ); ?>
	</li>

	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Stopping, Cancelling a rule', 'flexible-shipping' ); ?>
	</li>

	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Additional calculation methods', 'flexible-shipping' ); ?>
	</li>
</ul>
fsie.php                                                                                                                                                                                                                                                       652           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * @package WPDesk\FS\Info
 */

?>
<ul class="fsie-features">
	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Calculate the shipping cost based on your custom locations or the WooCommerce defaults', 'flexible-shipping' ); ?>
	</li>

	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Define shipping cost for each Vendor / Product Author in your marketplace', 'flexible-shipping' ); ?>
	</li>

	<li>
		<span class="dashicons dashicons-yes"></span> <?php esc_html_e( 'Move, replace, update or backup multiple shipping methods with Import / Export feature', 'flexible-shipping' ); ?>
	</li>
</ul>
WooCommerceABC.php                                                                                                                                                                                                                                             1329          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Info WooCommerceABC.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

use WPDesk\FS\Info\Metabox\Links;

/**
 * WooCommerceABC in FS Info.
 */
class WooCommerceABC extends Links {
	/**
	 * WooCommerceABC constructor.
	 */
	public function __construct() {
		$title        = __( 'WooCommerce ABCs', 'flexible-shipping' );
		$footer_label = __( 'Want to know more about WooCommerce? &rarr;', 'flexible-shipping' );
		$footer_url   = 'https://octol.io/fs-info-blog';

		parent::__construct( 'woocommerce-abc', $title, $this->generate_footer( $footer_url, $footer_label ) );
	}

	/**
	 * @return array[]
	 */
	protected function get_links() {
		return array(
			array(
				'label' => __( 'Shipping Zones', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-zones',
			),
			array(
				'label' => __( 'Shipping Tax', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-tax',
			),
			array(
				'label' => __( 'Shipping Methods', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-methods',
			),
			array(
				'label' => __( 'Shipping Classes', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-classes',
			),
			array(
				'label' => __( 'Table Rate Shipping', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-table-rate',
			),
		);
	}
}
WooCommerceABCPL.php                                                                                                                                                                                                                                           1219          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Info WooCommerceABCPL.
 *
 * @package WPDesk\FS\Info
 */

namespace WPDesk\FS\Info;

use WPDesk\FS\Info\Metabox\Links;

/**
 * WooCommerceABC in FS Info.
 */
class WooCommerceABCPL extends Links {
	/**
	 * WooCommerceABC constructor.
	 */
	public function __construct() {
		$title        = __( 'WooCommerce ABCs', 'flexible-shipping' );
		$footer_label = __( 'Want to know more about WooCommerce? &rarr;', 'flexible-shipping' );
		$footer_url   = 'https://octol.io/fs-info-blog-pl';

		parent::__construct( 'woocommerce-abc', $title, $this->generate_footer( $footer_url, $footer_label ) );
	}

	/**
	 * @return array[]
	 */
	protected function get_links() {
		return array(
			array(
				'label' => __( 'Shipping configuration', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-wysylka',
			),
			array(
				'label' => __( 'Shipping Zones', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-strefy',
			),
			array(
				'label' => __( 'Shipping Classes', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-klasy',
			),
			array(
				'label' => __( 'Free Shipping', 'flexible-shipping' ),
				'href'  => 'https://octol.io/fs-info-darmowa-wysylka',
			),
		);
	}
}
ExternalPluginAccess.php                                                                                                                                                                                                                                       828           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Integration                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php
/**
 * Class ExternalPluginAccess
 *
 * @package WPDesk\FS\Integration
 */

namespace WPDesk\FS\Integration;

use Psr\Log\LoggerInterface;

/**
 * Provides plugin data for integrations.
 */
class ExternalPluginAccess {

	/**
	 * @var string
	 */
	private $plugin_version;
	/**
	 * @var LoggerInterface
	 */
	private $logger;

	/**
	 * ExternalPluginAccess constructor.
	 *
	 * @param string          $plugin_version .
	 * @param LoggerInterface $logger .
	 */
	public function __construct( $plugin_version, LoggerInterface $logger ) {
		$this->plugin_version = $plugin_version;
		$this->logger         = $logger;
	}

	/**
	 * @return string
	 */
	public function get_plugin_version() {
		return $this->plugin_version;
	}

	/**
	 * @return LoggerInterface
	 */
	public function get_logger() {
		return $this->logger;
	}

}
FinishOption.php                                                                                                                                                                                                                                               1539          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Onboarding clicked option.
 *
 * @package WPDesk\FS\Onboarding
 */

namespace WPDesk\FS\Onboarding\TableRate;

/**
 * Can update option when onboarding is finish.
 */
class FinishOption {
	const OPTION_NAME = 'flexible_shipping_onboarding_table_rate';

	/**
	 * Get option value.
	 *
	 * @param string $key     .
	 * @param mixed  $default .
	 *
	 * @return mixed
	 */
	public function get_option_value( string $key = '', $default = false ) {
		$options = $this->get_options();

		if ( $key ) {
			return $options[ $key ] ?? $default;
		}

		return $options;
	}

	/**
	 * Checks if option is set.
	 *
	 * @return bool Option status.
	 */
	public function is_option_set(): bool {
		return false !== get_option( self::OPTION_NAME, false );
	}

	/**
	 * @param string $option_key   .
	 * @param mixed  $option_value .
	 *
	 * @return bool
	 */
	public function update_option( string $option_key, $option_value ): bool {
		$options = $this->get_options();

		$options[ $option_key ] = $option_value;

		return update_option( self::OPTION_NAME, $options );
	}

	/**
	 * @return array
	 */
	private function get_options(): array {
		$options = get_option( self::OPTION_NAME, [] );

		if ( ! is_array( $options ) ) {
			$options = [];
		}

		return wp_parse_args( $options, $this->get_default_option_values() );
	}

	/**
	 * @return array
	 */
	private function get_default_option_values(): array {
		return [
			'clicks'          => 0,
			'event'           => 'none',
			'auto_show_popup' => 0,
			'step'            => 0,
		];
	}
}
Onboarding.php                                                                                                                                                                                                                                                 3297          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Assets.
 *
 * @package WPDesk\FS\Onboarding
 */

namespace WPDesk\FS\Onboarding\TableRate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\Helpers\FlexibleShippingMethodsChecker;
use WPDesk\FS\Helpers\WooSettingsPageChecker;

/**
 * Onboarding hooks.
 */
class Onboarding implements Hookable {

	/**
	 * @var FinishOption .
	 */
	private $finish_option;

	/**
	 * @var string .
	 */
	private $scripts_version;

	/**
	 * @var string .
	 */
	private $plugin_assets_url;

	/**
	 * @var WooSettingsPageChecker
	 */
	private $setting_page_checker;

	/**
	 * @var FlexibleShippingMethodsChecker
	 */
	private $fs_methods_checker;

	/**
	 * @var array
	 */
	private $popups;

	/**
	 * @param FinishOption           $finish_option        .
	 * @param string                 $scripts_version      .
	 * @param string                 $plugin_assets_url    .
	 * @param WooSettingsPageChecker $setting_page_checker .
	 */
	public function __construct(
		FinishOption $finish_option,
		string $scripts_version,
		string $plugin_assets_url,
		WooSettingsPageChecker $setting_page_checker,
		FlexibleShippingMethodsChecker $fs_methods_checker,
		array $popups
	) {
		$this->finish_option        = $finish_option;
		$this->scripts_version      = $scripts_version;
		$this->plugin_assets_url    = $plugin_assets_url;
		$this->setting_page_checker = $setting_page_checker;
		$this->fs_methods_checker   = $fs_methods_checker;
		$this->popups               = $popups;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'flexible-shipping/admin/enqueue_scripts', [ $this, 'register_scripts' ] );
		add_action( 'flexible-shipping/method-rules-settings/table/before', [ $this, 'add_onboarding_container' ] );
	}

	/**
	 * Add onboarding container.
	 */
	public function add_onboarding_container() {
		include wp_normalize_path( __DIR__ . '/views/before-table-method-rules-settings.php' );
	}

	public function register_scripts() {
		if ( ! $this->setting_page_checker->is_fs_instance_method_edit() ) {
			return;
		}

		wp_enqueue_style( 'wpdesk_onboarding', sprintf( '%scss/onboarding.css', $this->plugin_assets_url ), [], $this->scripts_version );

		wp_enqueue_script(
			'wpdesk_onboarding',
			sprintf( '%sjs/onboarding.js', $this->plugin_assets_url ),
			[ 'jquery' ],
			$this->scripts_version,
			true
		);

		wp_localize_script(
			'wpdesk_onboarding',
			'fs_onboarding_details',
			[
				'ajax'       => [
					'url'    => admin_url( 'admin-ajax.php' ),
					'nonce'  => wp_create_nonce( OptionAjaxUpdater::NONCE_ACTION ),
					'action' => [
						'event'           => OptionAjaxUpdater::AJAX_ACTION_EVENT,
						'click'           => OptionAjaxUpdater::AJAX_ACTION_CLICK,
						'auto_show_popup' => OptionAjaxUpdater::AJAX_ACTION_AUTO_SHOP_POPUP,
					],
				],
				'assets_url' => untrailingslashit( $this->plugin_assets_url ),
				'label_step' => __( 'Step #', 'flexible-shipping' ),
				'logo_img'   => 'logo-fs.svg',
				'steps'      => 4,
				'locale'     => get_user_locale(),
				'open_auto'  => $this->should_auto_load(),
				'popups'     => $this->popups,
			]
		);
	}

	/**
	 * @return bool
	 */
	private function should_auto_load(): bool {
		return ! $this->finish_option->is_option_set() && $this->fs_methods_checker->is_new_shipping_method();
	}
}
OptionAjaxUpdater.php                                                                                                                                                                                                                                          2737          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Onboarding option AJAX updater.
 *
 * @package WPDesk\FS\TableRate\NewRulesTableBanner
 */

namespace WPDesk\FS\Onboarding\TableRate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can update option when onboarding is clicked.
 */
class OptionAjaxUpdater implements Hookable {
	const AJAX_ACTION_CLICK = 'flexible_shipping_onboarding_table_rate_click';
	const AJAX_ACTION_EVENT = 'flexible_shipping_onboarding_table_rate_event';
	const AJAX_ACTION_AUTO_SHOP_POPUP = 'flexible_shipping_onboarding_table_rate_auto_show_popup';

	const NONCE_ACTION = 'flexible_shipping_onboarding_table_rate';

	/**
	 * @var FinishOption
	 */
	private $option;

	/**
	 * OptionAjaxUpdater constructor.
	 *
	 * @param FinishOption $option .
	 */
	public function __construct( FinishOption $option ) {
		$this->option = $option;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'wp_ajax_' . self::AJAX_ACTION_CLICK, [ $this, 'handle_ajax_action_click' ] );
		add_action( 'wp_ajax_' . self::AJAX_ACTION_EVENT, [ $this, 'handle_ajax_action_event' ] );
		add_action( 'wp_ajax_' . self::AJAX_ACTION_AUTO_SHOP_POPUP, [ $this, 'handle_ajax_action_auto_show_popup' ] );
	}

	/**
	 * Handle AJAX action OK.
	 *
	 * @internal
	 */
	public function handle_ajax_action_event() {
		check_ajax_referer( self::NONCE_ACTION );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$event = $this->filter_input( INPUT_POST, 'event' );
		$step  = (int) $this->filter_input( INPUT_POST, 'step' );

		if ( $event ) {
			$this->option->update_option( 'event', sanitize_text_field( $event ) );
			$this->option->update_option( 'step', $step );

			wp_send_json_success();
		} else {
			wp_send_json_error();
		}
	}

	/**
	 * Handle AJAX action Click.
	 *
	 * @internal
	 */
	public function handle_ajax_action_click() {
		check_ajax_referer( self::NONCE_ACTION );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$clicks = (int) $this->option->get_option_value( 'clicks' );

		$this->option->update_option( 'clicks', $clicks + 1 );
		$this->option->update_option( 'step', 0 );

		wp_send_json_success();
	}

	/**
	 * Handle AJAX action Click.
	 *
	 * @internal
	 */
	public function handle_ajax_action_auto_show_popup() {
		check_ajax_referer( self::NONCE_ACTION );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$this->option->update_option( 'auto_show_popup', 1 );

		wp_send_json_success();
	}

	/**
	 * @param int    $type     .
	 * @param string $var_name .
	 *
	 * @return mixed
	 * @codeCoverageIgnore
	 */
	protected function filter_input( int $type, string $var_name ) {
		return filter_input( $type, $var_name );
	}
}
PopupData.php                                                                                                                                                                                                                                                  6436          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Popup Data.
 *
 * @package WPDesk\FS\Onboarding
 */

namespace WPDesk\FS\Onboarding\TableRate;

/**
 * Class PopupData
 *
 * @package WPDesk\FS\Onboarding
 */
class PopupData {
	/**
	 * @return array[]
	 */
	public function get_popups(): array {
		return [
			$this->get_popup_data_step_1(),
			$this->get_popup_data_step_2(),
			$this->get_popup_data_step_3(),
			$this->get_popup_data_step_4(),
		];
	}

	/**
	 * @return array
	 */
	private function get_popup_data_step_1(): array {
		return [
			'id'      => 'step_1',
			'logo'    => false,
			'title'   => null,
			'step'    => 1,
			'show'    => false,
			'image'   => 'steps/' . $this->get_locale() . '/step-1.gif',
			'heading' => __( 'Choose what the rule should be based on', 'flexible-shipping' ),
			'text'    => [
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sIn the \'When\' column select the condition which the rule you are about to add will be based on and calculated.%2$s', 'flexible-shipping' ),
					'<strong>',
					'</strong>'
				),
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sExample 1:%2$s If the shipping cost should be calculated based on the weight of the products added to the cart — select %3$sWeight%4$s, if&nbsp;based on price — similarly select %5$sPrice%6$s.', 'flexible-shipping' ),
					'<strong class="highlight">',
					'</strong>',
					'<strong>',
					'</strong>',
					'<strong>',
					'</strong>'
				),
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sExample 2:%2$s If the shipping cost should be fixed for good — select %3$sAlways%4$s.', 'flexible-shipping' ),
					'<strong class="highlight">',
					'</strong>',
					'<strong>',
					'</strong>'
				),
			],
			'buttons' => [
				[
					'label'   => __( 'Next step', 'flexible-shipping' ),
					'popup'   => 'step_2',
					'classes' => 'btn-success',
				],
			],
		];
	}

	/**
	 * @return array
	 */
	private function get_popup_data_step_2(): array {
		return [
			'id'      => 'step_2',
			'logo'    => false,
			'title'   => null,
			'step'    => 2,
			'show'    => false,
			'image'   => 'steps/' . $this->get_locale() . '/step-2.gif',
			'heading' => __( 'Define the rule’s range', 'flexible-shipping' ),
			'text'    => [
				__( 'Enter the minimum and maximum value for the selected condition to define the range when the rule will be applied.', 'flexible-shipping' ),
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sExample 1:%2$s If you want a particular shipping cost to be charged when the order’s total weight is between 1 kg and 5 kg - select %3$sWhen:%4$s Weight %5$sis from:%6$s 1 kg %7$sto:%8$s 5 kg.', 'flexible-shipping' ),
					'<strong class="highlight">',
					'</strong>',
					'<strong>',
					'</strong>',
					'<strong>',
					'</strong>',
					'<strong>',
					'</strong>'
				),
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sExample 2:%2$s If you want a particular shipping cost to be charged only when the order’s price exceeds $100, select %3$sWhen:%4$s Price %5$sis from:%6$s $100.', 'flexible-shipping' ),
					'<strong class="highlight">',
					'</strong>',
					'<strong>',
					'</strong>',
					'<strong>',
					'</strong>'
				),
			],
			'buttons' => [
				[
					'label'   => __( 'Previous step', 'flexible-shipping' ),
					'popup'   => 'step_1',
					'classes' => 'btn-link',
				],
				[
					'label'   => __( 'Next step', 'flexible-shipping' ),
					'popup'   => 'step_3',
					'classes' => 'btn-success',
				],
			],
		];
	}

	/**
	 * @return array
	 */
	private function get_popup_data_step_3(): array {
		return [
			'id'      => 'step_3',
			'logo'    => false,
			'title'   => null,
			'step'    => 3,
			'show'    => false,
			'image'   => 'steps/' . $this->get_locale() . '/step-3.gif',
			'heading' => __( 'Determine the shipping cost', 'flexible-shipping' ),
			'text'    => [
				__( 'Enter the shipping cost, which will be added to the order’s price when the condition you’ve set in the previous step is met.', 'flexible-shipping' ),
				sprintf(
				// Translators: open and close strong tag.
					__( '%1$sExample 1:%2$s If the cost of the shipping method you are currently configuring should be $12, enter %3$sCost is:%4$s 12.', 'flexible-shipping' ),
					'<strong class="highlight">',
					'</strong>',
					'<strong>',
					'</strong>'
				),
			],
			'buttons' => [
				[
					'label'   => __( 'Previous step', 'flexible-shipping' ),
					'popup'   => 'step_2',
					'classes' => 'btn-link',
				],
				[
					'label'   => __( 'Next step', 'flexible-shipping' ),
					'popup'   => 'step_4',
					'classes' => 'btn-success',
				],
			],
		];
	}

	/**
	 * @return array
	 */
	private function get_popup_data_step_4(): array {
		return [
			'id'      => 'step_4',
			'logo'    => false,
			'title'   => null,
			'step'    => 4,
			'show'    => false,
			'image'   => 'steps/' . $this->get_locale() . '/step-4.gif',
			'heading' => __( 'Add more and combine the rules!', 'flexible-shipping' ),
			'text'    => [
				sprintf(
				// Translators: open and close strong tag.
					__( 'Configure even the most advanced shipping scenarios by adding and combining the shipping cost calculation rules. Precisely define how the shipping cost should be calculated or import and adapt one of our %1$sready-to-use scenarios%2$s to your needs. Read the %3$sFlexible Shipping plugin documentation%4$s and discover its endless possibilities!', 'flexible-shipping' ),
					sprintf(
						'<a href="%s" target="_blank">',
						// Translators: open and close strong tag.
						esc_url( __( 'https://octol.io/onboarding-sc', 'flexible-shipping' ) )
					),
					'</a>',
					sprintf(
						'<a href="%s" target="_blank">',
						// Translators: open and close strong tag.
						esc_url( __( 'https://octol.io/onboarding-docs', 'flexible-shipping' ) )
					),
					'</a>'
				),
			],
			'buttons' => [
				[
					'label'   => __( 'Previous step', 'flexible-shipping' ),
					'popup'   => 'step_3',
					'classes' => 'btn-link',
				],
				[
					'label'   => __( 'Proceed to adding the rules', 'flexible-shipping' ),
					'action'  => 'finish',
					'classes' => 'btn-success',
				],
			],
		];
	}

	/**
	 * @return string
	 */
	private function get_locale(): string {
		$locale = get_user_locale();

		if ( 'pl_PL' === $locale ) {
			return $locale;
		}

		return 'en_US';
	}
}
Tracker.php                                                                                                                                                                                                                                                    823           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php
/**
 * Tracker.
 *
 * @package WPDesk\FS\Onboarding
 */

namespace WPDesk\FS\Onboarding\TableRate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Class Tracker
 */
class Tracker implements Hookable {

	/**
	 * @var FinishOption
	 */
	private $option;

	/**
	 * Tracker constructor.
	 *
	 * @param FinishOption $option .
	 */
	public function __construct( FinishOption $option ) {
		$this->option = $option;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_data', [ $this, 'add_tracking_data' ], 12 );
	}

	/**
	 * Add onboarding data to tracker.
	 *
	 * @param array $data .
	 *
	 * @return array
	 */
	public function add_tracking_data( $data ): array {
		$data['flexible_shipping']['onboarding']['table_rate'] = $this->option->get_option_value();

		return $data;
	}
}
before-table-method-rules-settings.php                                                                                                                                                                                                                         37            1711369794  plugins/flexible-shipping/src/WPDesk/FS/Onboarding/TableRate/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div id="onboarding-container"></div>PluginActivation.php                                                                                                                                                                                                                                           1152          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Plugin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Class PluginActivation
 *
 * @package WPDesk\FS\Plugin
 */

namespace WPDesk\FS\Plugin;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can redirect to FS Info tab on first plugin activation.
 */
class PluginActivation implements Hookable {

	const OPTION_NAME        = 'flexible-shipping-activation-redirected';
	const SHIPPING_METHOD_ID = 'flexible_shipping_info';

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'admin_init', array( $this, 'redirect_on_first_activation_or_do_nothing' ) );
	}

	/**
	 * .
	 */
	public function redirect_on_first_activation_or_do_nothing() {
		if ( 0 === (int) get_option( self::OPTION_NAME, 1 ) ) {
			if ( wp_safe_redirect( admin_url( 'admin.php?page=wc-settings&tab=shipping&section=' . self::SHIPPING_METHOD_ID ) ) ) {
				update_option( self::OPTION_NAME, 1 );
				$this->terminate();
			}
		}
	}

	/**
	 * .
	 *
	 * @codeCoverageIgnore
	 */
	protected function terminate() {
		die();
	}

	/**
	 * .
	 */
	public function add_activation_option_if_not_present() {
		if ( false === get_option( self::OPTION_NAME, false ) ) {
			add_option( self::OPTION_NAME, 0 );
		}
	}

}
AjaxTracker.php                                                                                                                                                                                                                                                1096          1711369794  plugins/flexible-shipping/src/WPDesk/FS/ProFeatures/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class AjaxTracker
 */

namespace WPDesk\FS\ProFeatures\Tracker;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can handle Ajax requests for pro features.
 */
class AjaxTracker implements Hookable {

	const AJAX_ACTION = 'flexible_shipping_pro_features_tracking';

	/**
	 * @var TrackingData
	 */
	private $tracking_data;

	/**
	 * @param TrackingData $tracking_data .
	 */
	public function __construct( TrackingData $tracking_data ) {
		$this->tracking_data = $tracking_data;
	}

	/**
	 * @return void
	 */
	public function hooks() {
		add_action( 'wp_ajax_' . self::AJAX_ACTION, [ $this, 'handle_ajax' ] );
	}

	/**
	 * @return void
	 */
	public function handle_ajax(): void {
		check_ajax_referer( self::AJAX_ACTION );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$status = wc_string_to_bool( sanitize_text_field( wp_unslash( $_REQUEST['status'] ?? 'false' ) ) );

		if ( $status ) {
			$this->tracking_data->increase_show_count();
		} else {
			$this->tracking_data->increase_hide_count();
		}

		wp_send_json_success();
	}
}
Tracker.php                                                                                                                                                                                                                                                    980           1711369794  plugins/flexible-shipping/src/WPDesk/FS/ProFeatures/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class Tracker
 */

namespace WPDesk\FS\ProFeatures\Tracker;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk_Flexible_Shipping_Tracker;

/**
 * Class Tracker
 */
class Tracker implements Hookable {

	const TRACKER_DATA_FILTER_PRIORITY = WPDesk_Flexible_Shipping_Tracker::TRACKER_DATA_FILTER_PRIORITY + 1;

	/**
	 * @var TrackingData
	 */
	private $tracking_data;

	/**
	 * @param TrackingData $tracking_data .
	 */
	public function __construct( TrackingData $tracking_data ) {
		$this->tracking_data = $tracking_data;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_data', [ $this, 'add_tracking_data' ], self::TRACKER_DATA_FILTER_PRIORITY );
	}

	/**
	 * Add pro features data to tracker.
	 *
	 * @param mixed $data .
	 *
	 * @return array
	 */
	public function add_tracking_data( $data ): array {
		$data['flexible_shipping']['pro_features_visible'] = $this->tracking_data->get_tracking_data();

		return $data;
	}
}
TrackingData.php                                                                                                                                                                                                                                               1290          1711369794  plugins/flexible-shipping/src/WPDesk/FS/ProFeatures/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class TrackingData
 */

namespace WPDesk\FS\ProFeatures\Tracker;

/**
 * Can provide pro features tracking data.
 */
class TrackingData {

	const OPTION_NAME = 'fs-pro-features-tracking-data';
	const SHOW_COUNT  = 'show_count';
	const HIDE_COUNT  = 'hide_count';

	/**
	 * @return void
	 */
	public function increase_show_count(): void {
		$this->increase_value( self::SHOW_COUNT );
	}

	/**
	 * @return void
	 */
	public function increase_hide_count(): void {
		$this->increase_value( self::HIDE_COUNT );
	}

	/**
	 * @return int[]
	 */
	public function get_tracking_data(): array {
		$tracking_data = get_option( self::OPTION_NAME, [] );

		$tracking_data[ self::SHOW_COUNT ] = (int) ( $tracking_data[ self::SHOW_COUNT ] ?? 0 );
		$tracking_data[ self::HIDE_COUNT ] = (int) ( $tracking_data[ self::HIDE_COUNT ] ?? 0 );

		return $tracking_data;
	}

	/**
	 * @param string $option .
	 *
	 * @return void
	 */
	private function increase_value( string $option ): void {
		$tracking_data = $this->get_tracking_data();
		$tracking_data[ $option ]++;
		$this->save_tracking_data( $tracking_data );
	}

	/**
	 * @param int[] $tracking_data .
	 */
	private function save_tracking_data( array $tracking_data ): void {
		update_option( self::OPTION_NAME, $tracking_data, false );
	}
}
ProVersionUpdateReminder.php                                                                                                                                                                                                                                   2387          1711369794  plugins/flexible-shipping/src/WPDesk/FS/ProVersion                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php

namespace WPDesk\FS\ProVersion;

use FSVendor\WPDesk\Notice\Notice;
use FSVendor\WPDesk\Notice\PermanentDismissibleNotice;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can display PRO version compatibility reminder.
 */
class ProVersionUpdateReminder implements Hookable {

	/**
	 * @var bool
	 */
	private $is_pl;

	/**
	 * @param bool $is_pl
	 */
	public function __construct( bool $is_pl ) {
		$this->is_pl = $is_pl;
	}


	public function hooks() {
		add_action( 'admin_notices', [ $this, 'add_notice_when_old_pro_version_detected' ] );
	}

	/**
	 * @return void
	 */
	public function add_notice_when_old_pro_version_detected() {
		if ( defined( 'FLEXIBLE_SHIPPING_PRO_VERSION' ) && version_compare( FLEXIBLE_SHIPPING_PRO_VERSION, '2.5', '<' ) ) {
			$notice_name = 'fs-pro-version-warning-' . date( 'YW' );
			new PermanentDismissibleNotice(
				$this->prepare_notice_content(),
				$notice_name,
				Notice::NOTICE_TYPE_WARNING
			);
		}
	}

	/**
	 * @return string
	 */
	private function prepare_notice_content() {
		$my_account_link = $this->is_pl ? 'https://www.wpdesk.pl/moje-konto/api-keys/?utm_source=api-keys&utm_medium=plugin-list&utm_campaign=subscriptions' : 'https://octolize.com/my-account/api-keys/?utm_source=api-keys&utm_medium=plugin-list&utm_campaign=subscriptions';
		$renew_link      = $this->is_pl ? 'https://www.wpdesk.pl/moje-konto/subscriptions/?utm_source=fs-update&utm_medium=plugin-list&utm_campaign=subscriptions' : 'https://octolize.com/my-account/subscriptions/?utm_source=fs-update&utm_medium=plugin-list&utm_campaign=subscriptions';
		return sprintf(
			// Translators: strong, version, /strong, strong, /strong, link, link.
			__(
				'The %1$sFlexible Shipping PRO %2$s%3$s version you are currently using is severely %4$soutdated%5$s. Its further use may result in onward %4$scompatibility issues%5$s. In order to perform the update, please copy your plugin API key from %6$sMy Account / API keys%7$s tab and activate it in your store. If your subscription expired and you don’t own an active one at the moment, please %8$srenew the subscription →%9$s',
				'flexible-shipping'
			),
			'<strong>',
			FLEXIBLE_SHIPPING_PRO_VERSION,
			'</strong>',
			'<strong>',
			'</strong>',
			'<a href="' . $my_account_link . '" target="_blank">',
			'</a>',
			'<a href="' . $renew_link . '" target="_blank">',
			'</a>'
		);
	}

}
AdminNotices.php                                                                                                                                                                                                                                               3216          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class AdminNotices
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\Notice\Notice;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use FSVendor\WPDesk\Session\SessionFactory;

/**
 * Display admin notices.
 */
class AdminNotices implements Hookable {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @return void
	 */
	public function hooks() {
		add_action( 'admin_notices', [ $this, 'admin_notices' ] );
	}

	/**
	 * .
	 */
	public function admin_notices() {
		if ( ! empty( $_REQUEST['bulk_flexible_shipping_send'] ) ) {
			$bulk_flexible_shipping_send_count = (int) sanitize_text_field( wp_unslash( $_REQUEST['bulk_flexible_shipping_send'] ) );

			new Notice(
				sprintf( __( 'Bulk send shipment - processed orders: %d', 'flexible-shipping' ), $bulk_flexible_shipping_send_count ) // phpcs:ignore
			);
		}

		if ( ! empty( $_REQUEST['bulk_flexible_shipping_labels'] ) ) {
			$bulk_flexible_shipping_labels_count = (int) sanitize_text_field( wp_unslash( $_REQUEST['bulk_flexible_shipping_labels'] ) );

			if ( ! empty( $_REQUEST['bulk_flexible_shipping_no_labels_created'] ) ) {
				new Notice(
					sprintf( __( 'Bulk labels - processed orders: %d. No labels for processed orders.', 'flexible-shipping' ), $bulk_flexible_shipping_labels_count ) // phpcs:ignore
				);
			} else {
				$labels = $this->session_factory->get_woocommerce_session_adapter()->get( 'flexible_shipping_bulk_labels' );
				if ( is_array( $labels ) ) {
					if ( isset( $labels['error'] ) ) {
						new Notice( $labels['error'], Notice::NOTICE_TYPE_ERROR, true, 20 );
					} else {
						$nonce = wp_create_nonce( 'flexible_shipping_labels' );
						new Notice(
							sprintf(
								__( 'Bulk labels - processed orders: %d. If download not start automatically click %shere%s.', 'flexible-shipping' ), // phpcs:ignore
								$bulk_flexible_shipping_labels_count,
								'<a id="flexible_shipping_labels_url" target="_blank" href=' . esc_url( admin_url( 'admin.php?flexible_shipping_labels=' . basename( $labels['client_file'] ) . '&tmp_file=' . basename( $labels['tmp_file'] ) . '&nonce=' . $nonce ) ) . '>',
								'</a>'
							)
						);
					}
				}
			}
		}

		if ( ! empty( $_REQUEST['bulk_flexible_shipping_manifests'] ) ) {
			$bulk_flexible_shipping_manifest_count = (int) sanitize_text_field( wp_unslash( $_REQUEST['bulk_flexible_shipping_manifests'] ) );
			new Notice(
				sprintf( __( 'Bulk shipping manifest - processed orders: %d', 'flexible-shipping' ), $bulk_flexible_shipping_manifest_count ) // phpcs:ignore
			);

			if ( $this->session_factory->get_woocommerce_session_adapter()->get( 'flexible_shipping_bulk_manifests' ) ) {
				$messages = $this->session_factory->get_woocommerce_session_adapter()->get( 'flexible_shipping_bulk_manifests' );

				foreach ( $messages as $message ) {
					new Notice(
						$message['message'],
						$message['type']
					);
				}

				$this->session_factory->get_woocommerce_session_adapter()->set( 'flexible_shipping_bulk_manifests', null );
			}
		}
	}
}
HandleAction.php                                                                                                                                                                                                                                               639           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class HandleAction
 */

namespace WPDesk\FS\Shipment\BulkAction;

/**
 * .
 */
class HandleAction {

	/**
	 * @var HandleActionStrategyInterface
	 */
	private $strategy;

	/**
	 * @param HandleActionStrategyInterface $strategy
	 *
	 * @return $this
	 */
	public function set_strategy( HandleActionStrategyInterface $strategy ): self {
		$this->strategy = $strategy;

		return $this;
	}

	/**
	 * @param string $redirect_to .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle( string $redirect_to, array $post_ids ): string {
		return $this->strategy->handle( $redirect_to, $post_ids );
	}
}
HandleActionLabels.php                                                                                                                                                                                                                                         2513          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class HandleActionLabels
 */

namespace WPDesk\FS\Shipment\BulkAction;

use Exception;
use FSVendor\WPDesk\FS\Shipment\Exception\UnableToCreateTmpFileException;
use FSVendor\WPDesk\FS\Shipment\Exception\UnableToCreateTmpZipFileException;
use FSVendor\WPDesk\FS\Shipment\Label\LabelsBulkActionHandler;
use FSVendor\WPDesk\FS\Shipment\Label\LabelsFileCreator;
use FSVendor\WPDesk\Session\SessionFactory;

/**
 * .
 */
class HandleActionLabels implements HandleActionStrategyInterface {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @param string $redirect_to .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle( string $redirect_to, array $post_ids ): string {
		$labels_bulk_actions_handler = LabelsBulkActionHandler::get_labels_bulk_actions_handler();
		$labels_bulk_actions_handler->bulk_process_orders( $post_ids );

		try {
			$labels = $labels_bulk_actions_handler->get_labels_for_shipments();
			if ( 0 === count( $labels ) ) {
				$redirect_to = add_query_arg( 'bulk_flexible_shipping_labels', count( $post_ids ), $redirect_to );

				return add_query_arg( 'bulk_flexible_shipping_no_labels_created', 1, $redirect_to );
			}

			$labels_file_creator = new LabelsFileCreator( $labels );
			$labels_file_creator->create_labels_file();
			$labels['tmp_file']    = $labels_file_creator->get_tmp_file_name();
			$labels['client_file'] = $labels_file_creator->get_file_name();

			foreach ( $labels as $key => $label ) {
				if ( is_array( $labels[ $key ] ) && isset( $labels[ $key ]['content'] ) ) {
					unset( $labels[ $key ]['content'] );
				}
			}
		} catch ( UnableToCreateTmpZipFileException $zip_file_exception ) {
			$labels['error'] = __( 'Unable to create temporary zip archive for labels. Check temporary folder configuration on server.', 'flexible-shipping' );
		} catch ( UnableToCreateTmpFileException $tmp_file_exception ) {
			$labels['error'] = __( 'Unable to create temporary file for labels. Check temporary folder configuration on server.', 'flexible-shipping' );
		} catch ( Exception $e ) {
			$labels['error'] = $e->getMessage();
		}

		$this->session_factory->get_woocommerce_session_adapter()->set( 'flexible_shipping_bulk_labels', $labels );

		return add_query_arg( 'bulk_flexible_shipping_labels', count( $post_ids ), $redirect_to );
	}
}
HandleActionManifest.php                                                                                                                                                                                                                                       3514          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class HandleActionManifest
 */

namespace WPDesk\FS\Shipment\BulkAction;

use Exception;
use FSVendor\WPDesk\Session\SessionFactory;
use WPDesk_Flexible_Shipping_Shipment;
use WPDesk_Flexible_Shipping_Shipment_Interface;

/**
 * .
 */
class HandleActionManifest implements HandleActionStrategyInterface {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @param string $redirect_to .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle( string $redirect_to, array $post_ids ): string {
		$manifests = [];
		foreach ( $post_ids as $post_id ) {
			$shipments = fs_get_order_shipments( $post_id );
			foreach ( $shipments as $shipment ) {
				/* @var $shipment WPDesk_Flexible_Shipping_Shipment|WPDesk_Flexible_Shipping_Shipment_Interface */
				if ( $shipment->get_status() !== 'fs-confirmed' || $shipment->get_meta( '_manifest', '' ) !== '' ) {
					continue;
				}
				try {
					$integration   = $shipment->get_integration();
					$manifest_name = $integration;
					if ( method_exists( $shipment, 'get_manifest_name' ) ) {
						$manifest_name = $shipment->get_manifest_name();
					}
					$manifest = null;
					if ( empty( $manifests[ $manifest_name ] ) ) {
						if ( fs_manifest_integration_exists( $integration ) ) {
							$manifest = fs_create_manifest( $integration );
						}
					} else {
						$manifest = $manifests[ $manifest_name ];
					}
					if ( null !== $manifest ) {
						$manifest->add_shipments( $shipment );
						$manifest->save();
						$shipment->update_status( 'fs-manifest' );
						$shipment->save();
						$manifests[ $manifest_name ] = $manifest;
					}
				} catch ( Exception $e ) { // phpcs:ignore
					// Do nothing.
				}
			}
		}
		$messages     = [];
		$integrations = apply_filters( 'flexible_shipping_integration_options', [] );

		foreach ( $manifests as $manifest ) {
			try {
				$manifest->generate();
				$manifest->save();
				$download_manifest_url = admin_url( 'edit.php?post_type=shipping_manifest&flexible_shipping_download_manifest=' . $manifest->get_id() . '&nonce=' . wp_create_nonce( 'flexible_shipping_download_manifest' ) );
				$messages[]            = [
					'type'    => 'updated',
					'message' => sprintf(
					// Translators: manifests count and integration.
						__( 'Created manifest: %s (%s). If download not start automatically click %shere%s.', 'flexible-shipping' ), // phpcs:ignore
						$manifest->get_number(),
						$integrations[ $manifest->get_integration() ],
						'<a class="shipping_manifest_download" target="_blank" href="' . $download_manifest_url . '">',
						'</a>'
					),
				];
			} catch ( Exception $e ) {
				$messages[] = [
					'type'    => 'error',
					'message' => sprintf(
						__( 'Manifest creation error: %s (%s).', 'flexible-shipping' ), // phpcs:ignore
						$e->getMessage(),
						$integrations[ $manifest->get_integration() ]
					),
				];
				fs_delete_manifest( $manifest );
			}
		}
		if ( count( $messages ) === 0 ) {
			$messages[] = [
				'type'    => 'updated',
				'message' => __( 'No manifests created.', 'flexible-shipping' ),
			];
		}
		$this->session_factory->get_woocommerce_session_adapter()->set( 'flexible_shipping_bulk_manifests', $messages );

		return add_query_arg( 'bulk_flexible_shipping_manifests', count( $post_ids ), $redirect_to );
	}
}
HandleActionSend.php                                                                                                                                                                                                                                           1834          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class HandleActionSend
 */

namespace WPDesk\FS\Shipment\BulkAction;

use Exception;
use FSVendor\WPDesk\Session\SessionFactory;
use WPDesk_Flexible_Shipping_Shipment;
use WPDesk_Flexible_Shipping_Shipment_Interface;

/**
 * .
 */
class HandleActionSend implements HandleActionStrategyInterface {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @param string $redirect_to .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle( string $redirect_to, array $post_ids ): string {
		$messages = [];
		foreach ( $post_ids as $post_id ) {
			$shipments            = fs_get_order_shipments( $post_id );
			$messages[ $post_id ] = [];

			foreach ( $shipments as $shipment ) {
				/* @var $shipment WPDesk_Flexible_Shipping_Shipment|WPDesk_Flexible_Shipping_Shipment_Interface */
				try {
					$shipment->set_sent_via_bulk();
					$shipment->api_create();
					$messages[ $post_id ][ $shipment->get_id() ] = [
						'status'  => 'created',
						'message' => __( 'Shipment created.', 'flexible-shipping' ),
					];
				} catch ( Exception $e ) {
					$messages[ $post_id ][ $shipment->get_id() ] = [
						'status'  => 'error',
						'message' => $e->getMessage(),
					];
				}
			}
			$messages[ $post_id ][] = apply_filters(
				'flexible_shipping_bulk_send',
				[
					'status'  => 'none',
					'message' => __( 'No action performed.', 'flexible-shipping' ),
				],
				$post_id
			);
		}

		$this->session_factory->get_woocommerce_session_adapter()->set( 'flexible_shipping_bulk_send', $messages );

		return add_query_arg( 'bulk_flexible_shipping_send', count( $post_ids ), $redirect_to );
	}
}
HandleActionStrategy.php                                                                                                                                                                                                                                       884           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class HandleActionStrategy
 */

namespace WPDesk\FS\Shipment\BulkAction;

use Exception;
use FSVendor\WPDesk\Session\SessionFactory;

/**
 * .
 */
class HandleActionStrategy {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	public function get( string $action ) {
		switch ( $action ) {
			case 'flexible_shipping_send':
				return new HandleActionSend( $this->session_factory );
			case 'flexible_shipping_labels':
				return new HandleActionLabels( $this->session_factory );
			case 'flexible_shipping_manifest':
				return new HandleActionManifest( $this->session_factory );
			default:
				throw new Exception( __( 'Bulk Handle action not found', 'flexible-shipping' ) );
		}
	}
}
HandleActionStrategyInterface.php                                                                                                                                                                                                                              329           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/BulkAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Interface HandleActionStrategyInterface
 */

namespace WPDesk\FS\Shipment\BulkAction;

/**
 * .
 */
interface HandleActionStrategyInterface {
	/**
	 * @param string $redirect_to .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle( string $redirect_to, array $post_ids ): string;
}
BulkAction.php                                                                                                                                                                                                                                                 3928          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class BulkAction
 */

namespace WPDesk\FS\Shipment;

use Exception;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use FSVendor\WPDesk\Session\SessionFactory;
use WPDesk\FS\Shipment\BulkAction\HandleAction;
use WPDesk\FS\Shipment\BulkAction\HandleActionStrategy;
use WPDesk\FS\Shipment\BulkAction\HandleActionStrategyInterface;

/**
 * Bulk actions on order screen.
 */
class BulkAction implements Hookable {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @return void
	 */
	public function hooks() {
		// Old Screen.
		add_filter( 'bulk_actions-edit-shop_order', [ $this, 'add_bulk_action_options' ] );
		add_filter( 'handle_bulk_actions-edit-shop_order', [ $this, 'handle_bulk_action' ], 10, 3 );

		// New Screen.
		add_filter( 'bulk_actions-woocommerce_page_wc-orders', [ $this, 'add_bulk_action_options' ] );
		add_action( 'admin_init', [ $this, 'handle_bulk_action_new_screen' ] );
	}

	public function handle_bulk_action_new_screen() {
		if ( ! isset( $_GET['page'], $_GET['action'], $_GET['id'] ) || empty( $_GET['id'] ) || 'wc-orders' !== wp_unslash( $_GET['page'] ) ) { //phpcs:ignore
			return;
		}

		$action = wp_unslash( $_GET['action'] ); //phpcs:ignore
		$orders = wp_parse_id_list( wp_unslash( $_GET['id'] ) );

		try {
			$this->get_handle_action_strategy( $action );
		} catch ( Exception $e ) {
			return;
		}

		check_admin_referer( 'bulk-orders' );
		wp_safe_redirect( $this->handle_action( wp_get_referer(), $action, $orders ) );
		die();
	}

	/**
	 * @param array $bulk_actions .
	 *
	 * @return mixed
	 */
	public function add_bulk_action_options( $bulk_actions ) {
		$integrations = apply_filters( 'flexible_shipping_integration_options', [] );

		if ( count( $integrations ) ) {
			$bulk_actions['flexible_shipping_send']   = __( 'Send shipment', 'flexible-shipping' );
			$bulk_actions['flexible_shipping_labels'] = __( 'Get labels', 'flexible-shipping' );

			if ( apply_filters( 'flexible_shipping_has_manifests', false ) ) {
				$bulk_actions['flexible_shipping_manifest'] = __( 'Create shipping manifest', 'flexible-shipping' );
			}
		}

		return $bulk_actions;
	}

	/**
	 * @param string $redirect_to .
	 * @param string $action      .
	 * @param array  $post_ids    .
	 *
	 * @return string
	 */
	public function handle_bulk_action( $redirect_to, $action, $post_ids ): string {
		$redirect_to = is_string( $redirect_to ) ? $redirect_to : add_query_arg( 'post_type', 'shop_order', admin_url( 'edit.php' ) );

		return $this->handle_action( $redirect_to, $action, $post_ids );
	}

	/**
	 * @param string $redirect_to .
	 * @param string $action      .
	 * @param array  $ids         .
	 *
	 * @return string
	 */
	private function handle_action( string $redirect_to, string $action, array $ids ): string {
		$redirect_to = remove_query_arg( 'bulk_flexible_shipping_send', $redirect_to );
		$redirect_to = remove_query_arg( 'bulk_flexible_shipping_labels', $redirect_to );
		$redirect_to = remove_query_arg( 'bulk_flexible_shipping_manifests', $redirect_to );

		try {
			$handle_action = $this->get_handle_action();

			$handle_action->set_strategy( $this->get_handle_action_strategy( $action ) );

			return $handle_action->handle( $redirect_to, wp_parse_id_list( $ids ) );
		} catch ( Exception $e ) { // phpcs:ignore
			// Do nothing.
		}

		return $redirect_to;
	}

	/**
	 * @return HandleAction
	 */
	protected function get_handle_action(): HandleAction {
		return new HandleAction();
	}

	/**
	 * @param string $action
	 *
	 * @return HandleActionStrategyInterface
	 * @throws Exception
	 */
	protected function get_handle_action_strategy( string $action ): HandleActionStrategyInterface {
		return ( new HandleActionStrategy( $this->session_factory ) )->get( $action );
	}

}
DispatchLabelFile.php                                                                                                                                                                                                                                          1262          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class DispatchLabelFile
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\FS\Shipment\Label\LabelsFileDispatcher;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * .
 */
class DispatchLabelFile implements Hookable {

	/**
	 * @return void
	 */
	public function hooks() {
		add_action( 'admin_init', [ $this, 'dispatch_labels_file_if_expected' ], 1 );
	}

	/**
	 * Dispatch labels file if requested.
	 */
	public function dispatch_labels_file_if_expected() {
		if ( ! isset( $_GET['flexible_shipping_labels'], $_GET['tmp_file'], $_GET['nonce'] ) ) {
			return;
		}

		if ( ! wp_verify_nonce( sanitize_text_field( wp_unslash( $_GET['nonce'] ) ), 'flexible_shipping_labels' ) ) {
			return;
		}

		$file     = trailingslashit( sys_get_temp_dir() ) . sanitize_text_field( wp_unslash( $_GET['flexible_shipping_labels'] ) );
		$tmp_file = trailingslashit( sys_get_temp_dir() ) . sanitize_text_field( wp_unslash( $_GET['tmp_file'] ) );

		if ( ! file_exists( $tmp_file ) ) {
			wp_die( esc_html__( 'This file was already downloaded! Please retry bulk action!', 'flexible-shipping' ) );
		}

		$labels_file_dispatcher = new LabelsFileDispatcher();
		$labels_file_dispatcher->dispatch_and_delete_labels_file( $file, $tmp_file );
		die();
	}
}
FilterOrders.php                                                                                                                                                                                                                                               4102          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class FilterOrders
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * .
 */
class FilterOrders implements Hookable {

	/**
	 * @return void
	 */
	public function hooks() {
		add_filter( 'posts_where', [ $this, 'posts_where' ], 999 );

		add_action( 'restrict_manage_posts', [ $this, 'restrict_manage_posts' ], 9999 );
	}

	/**
	 * @param string $where .
	 *
	 * @return string
	 */
	public function posts_where( $where = '' ) {
		global $pagenow, $wp_query, $wpdb;

		$should_modify_query = 'edit.php' === $pagenow && is_admin() && isset( $wp_query->query_vars['post_type'] ) && 'shop_order' === $wp_query->query_vars['post_type'];

		if ( ! $should_modify_query ) {
			return $where;
		}

		$integration = sanitize_key( $_GET['flexible_shipping_integration_filter'] ?? '' );
		$status      = sanitize_key( $_GET['flexible_shipping_status_filter'] ?? '' );

		if ( empty( $integration ) && empty( $status ) ) {
			return $where;
		}

		$add_where_meta_integration     = '';
		$add_where_meta_status          = '';
		$add_where_shipment_integration = '';
		$add_where_shipment_status      = '';
		$add_where                      = '';

		if ( '' !== $integration ) {
			$add_where_meta_integration     = " EXISTS ( SELECT 1 FROM {$wpdb->postmeta} fs_postmeta WHERE {$wpdb->posts}.ID = fs_postmeta.post_id AND fs_postmeta.meta_key = '_flexible_shipping_integration' AND  fs_postmeta.meta_value = '$integration' ) ";
			$add_where_shipment_integration = " EXISTS ( SELECT 1 FROM {$wpdb->posts} fs_posts, {$wpdb->postmeta} fs_postmeta WHERE {$wpdb->posts}.ID = fs_posts.post_parent AND fs_posts.ID = fs_postmeta.post_id AND fs_postmeta.meta_key = '_integration' AND  fs_postmeta.meta_value = '$integration' ) ";
		}

		if ( '' !== $status ) {
			$add_where_meta_status     = " EXISTS ( SELECT 1 FROM {$wpdb->postmeta} fs_postmeta WHERE {$wpdb->posts}.ID = fs_postmeta.post_id AND fs_postmeta.meta_key = '_flexible_shipping_status' AND  fs_postmeta.meta_value = '$status' ) ";
			$add_where_shipment_status = " EXISTS ( SELECT 1 FROM {$wpdb->posts} fs_posts WHERE {$wpdb->posts}.ID = fs_posts.post_parent AND fs_posts.post_status = 'fs-{$status}' ) ";
		}

		$add_where_meta = '';

		if ( '' !== $add_where_meta_integration ) {
			$add_where_meta .= $add_where_meta_integration;
		}

		if ( '' !== $add_where_meta_status ) {
			if ( '' !== $add_where_meta ) {
				$add_where_meta .= ' AND ';
			}
			$add_where_meta .= $add_where_meta_status;
		}

		$add_where_shipment = '';
		if ( '' !== $add_where_shipment_integration ) {
			$add_where_shipment .= $add_where_shipment_integration;
		}

		if ( '' !== $add_where_shipment_status ) {
			if ( '' !== $add_where_shipment ) {
				$add_where_shipment .= ' AND ';
			}
			$add_where_shipment .= $add_where_shipment_status;
		}

		$add_where_meta     = ' ( ' . $add_where_meta . ' ) ';
		$add_where_shipment = ' ( ' . $add_where_shipment . ' ) ';
		$add_where          = ' AND ( ' . $add_where_meta . ' OR ' . $add_where_shipment . ' ) ';
		$where              .= $add_where;

		return $where;
	}

	/**
	 * .
	 */
	public function restrict_manage_posts() {
		$screen = get_current_screen();

		if ( ! $screen ) {
			return;
		}

		if ( apply_filters( 'flexible_shipping_disable_order_filters', false ) ) {
			return;
		}

		$integrations = apply_filters( 'flexible_shipping_integration_options', [] );

		if ( ! count( $integrations ) ) {
			return;
		}

		if ( ! in_array( $screen->id, [ 'woocommerce_page_wc-orders', 'edit-shop_order' ], true ) ) {
			return;
		}

		$integrations = apply_filters( 'flexible_shipping_integration_options', [] );
		$statuses     = apply_filters( 'flexible_shipping_status', [] );
		$integration  = '';

		if ( isset( $_GET['flexible_shipping_integration_filter'] ) ) {
			$integration = sanitize_key( $_GET['flexible_shipping_integration_filter'] );
		}

		$status = '';
		if ( isset( $_GET['flexible_shipping_status_filter'] ) ) {
			$status = sanitize_key( $_GET['flexible_shipping_status_filter'] );
		}

		include __DIR__ . '/views/html-orders-filter-form.php';
	}
}
ModifyOrderTable.php                                                                                                                                                                                                                                           4714          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class ModifyOrderTable
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use FSVendor\WPDesk\Session\SessionFactory;
use WC_Order;
use WPDesk_Flexible_Shipping_Shipment;
use WPDesk_Flexible_Shipping_Shipment_Interface;

/**
 * .
 */
class ModifyOrderTable implements Hookable {

	/**
	 * @var SessionFactory
	 */
	private $session_factory;

	/**
	 * @param SessionFactory $session_factory .
	 */
	public function __construct( SessionFactory $session_factory ) {
		$this->session_factory = $session_factory;
	}

	/**
	 * @return void
	 */
	public function hooks() {
		// Old Screen.
		add_filter( 'manage_edit-shop_order_columns', [ $this, 'manage_edit_shop_order_columns' ], 11 );
		add_action( 'manage_shop_order_posts_custom_column', [ $this, 'manage_shop_order_posts_custom_column' ], 11, 2 );

		// New Screen.
		add_filter( 'manage_woocommerce_page_wc-orders_columns', [ $this, 'manage_edit_shop_order_columns' ], 11 );
		add_action( 'manage_woocommerce_page_wc-orders_custom_column', [ $this, 'manage_shop_order_posts_custom_column' ], 11, 2 );
	}

	/**
	 * @param array $columns .
	 *
	 * @return array
	 */
	public function manage_edit_shop_order_columns( $columns ) {
		if ( isset( $columns['flexible_shipping'] ) ) {
			return $columns;
		}

		$integrations = apply_filters( 'flexible_shipping_integration_options', [] );

		if ( ! count( $integrations ) ) {
			return $columns;
		}

		$ret = [];

		$col_added = false;

		foreach ( $columns as $key => $column ) {
			if ( ! $col_added && in_array( $key, [ 'order_actions', 'wc_actions' ], true ) ) {
				$ret['flexible_shipping'] = __( 'Shipping', 'flexible-shipping' );
				$col_added                = true;
			}
			$ret[ $key ] = $column;
		}

		if ( ! $col_added ) {
			$ret['flexible_shipping'] = __( 'Shipping', 'flexible-shipping' );
		}

		return $ret;
	}

	/**
	 * @param string                $column .
	 * @param int|\WP_Post|WC_Order $post   .
	 *
	 * @return void
	 */
	public function manage_shop_order_posts_custom_column( string $column, $post_id ) {
		if ( 'flexible_shipping' !== $column ) {
			return;
		}

		$order = wc_get_order( $post_id );

		$classes   = $this->get_classess();
		$statuses  = $this->get_statuses();
		$shippings = $this->get_shippings( $order );

		foreach ( $shippings as $shipping ) {
			if ( 'error' === $shipping['status'] ) {
				$statuses['error'] = $shipping['error'];
			} else {
				$statuses['error'] = __( 'Error', 'flexible-shipping' );
			}

			include __DIR__ . '/views/html-column-shipping-shipping.php';
		}

		$messages = $this->session_factory->get_woocommerce_session_adapter()->get( 'flexible_shipping_bulk_send', [] );

		if ( isset( $messages[ $order->get_id() ] ) ) {
			unset( $messages[ $order->get_id() ] );
		}

		$this->session_factory->get_woocommerce_session_adapter()->set( 'flexible_shipping_bulk_send', $messages );
	}

	/**
	 * @param WC_Order $order .
	 *
	 * @return array
	 */
	private function get_shippings( WC_Order $order ): array {
		$shippings = [];
		/** @var WPDesk_Flexible_Shipping_Shipment[]|WPDesk_Flexible_Shipping_Shipment_Interface[] $shipments */
		$shipments = fs_get_order_shipments( $order->get_id() );

		foreach ( $shipments as $shipment ) {
			$shipping                    = [];
			$shipping['order_id']        = $order->get_id();
			$shipping['integration']     = $shipment->get_integration();
			$shipping['url']             = $shipment->get_order_metabox_url();
			$shipping['error']           = $shipment->get_error_message();
			$shipping['status']          = $shipment->get_status_for_shipping_column();
			$shipping['tracking_number'] = $shipment->get_tracking_number();
			$shipping['label_url']       = $shipment->get_label_url();
			$shipping['tracking_url']    = $shipment->get_tracking_url();
			$shipping['shipment']        = $shipment;
			$shippings[]                 = $shipping;
		}

		$shippings = apply_filters( 'flexible_shipping_shipping_data', $shippings, $order );

		return is_array( $shippings ) ? $shippings : [];
	}

	/**
	 * @return string[]
	 */
	private function get_classess(): array {
		return [
			'error'     => 'failed',
			'new'       => 'on-hold',
			'created'   => 'processing created',
			'confirmed' => 'processing confirmed',
			'manifest'  => 'processing manifest',
		];
	}

	/**
	 * @return string[]
	 */
	private function get_statuses(): array {
		return [
			'error'     => __( 'Error', 'flexible-shipping' ),
			'new'       => __( 'New shipment', 'flexible-shipping' ),
			'created'   => __( 'Created', 'flexible-shipping' ),
			'confirmed' => __( 'Confirmed', 'flexible-shipping' ),
			'manifest'  => __( 'Manifest created', 'flexible-shipping' ),
		];
	}
}
ModifyStatuses.php                                                                                                                                                                                                                                             849           1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class ModifyStatuses
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * .
 */
class ModifyStatuses implements Hookable {

	/**
	 * @return void
	 */
	public function hooks() {
		add_filter( 'flexible_shipping_status', [ $this, 'flexible_shipping_status' ] );
	}

	/**
	 * @param mixed $statuses .
	 *
	 * @return array
	 */
	public function flexible_shipping_status( $statuses ): array {
		$statuses = is_array( $statuses ) ? $statuses : [];

		$statuses['new']       = __( 'New', 'flexible-shipping' );
		$statuses['created']   = __( 'Created', 'flexible-shipping' );
		$statuses['confirmed'] = __( 'Confirmed', 'flexible-shipping' );
		$statuses['manifest']  = __( 'Manifest', 'flexible-shipping' );
		$statuses['failed']    = __( 'Failed', 'flexible-shipping' );

		return $statuses;
	}
}
SubscriptionsIntegration.php                                                                                                                                                                                                                                   3277          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class SubscriptionsIntegration
 *
 * @package WPDesk\FS\Shipment
 */

namespace WPDesk\FS\Shipment;

use FSVendor\WPDesk\FS\Shipment\CustomPostType;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Integrates Shipments with WooCommerce Subscriptions plugin.
 */
class SubscriptionsIntegration implements Hookable {

	/**
	 * @var CustomPostType
	 */
	private $shipment_cpt;

	/**
	 * SubscriptionsIntegration constructor.
	 *
	 * @param CustomPostType $shipment_cpt .
	 */
	public function __construct( CustomPostType $shipment_cpt ) {
		$this->shipment_cpt = $shipment_cpt;
	}

	/**
	 * .
	 */
	public function hooks() {
		$last_priority = PHP_INT_MAX;
		add_action( 'woocommerce_checkout_subscription_created', [ $this, 'create_shipping_for_subscription' ], $last_priority, 3 );
		add_filter( 'wcs_renewal_order_created', [ $this, 'create_shipping_for_order_from_subscription' ], 10, 2 );
	}

	/**
	 * @param \WC_Subscription $subscription .
	 * @param \WC_Order        $order .
	 * @param \WC_Cart         $recurring_cart .
	 */
	public function create_shipping_for_subscription( $subscription, $order, $recurring_cart ) {
		$this->shipment_cpt->create_shipping_for_order_and_cart( $subscription, $recurring_cart );
	}

	/**
	 * @param \WC_Order        $order .
	 * @param \WC_Subscription $subscription .
	 */
	public function create_shipping_for_order_from_subscription( $order, $subscription ) {
		$subscription_shipments = fs_get_order_shipments( $subscription->get_id() );
		foreach ( $subscription_shipments as $shipment ) {
			$this->create_single_shipment( $shipment, $order );
		}

		return $order;
	}

	/**
	 * @param \WPDesk_Flexible_Shipping_Shipment $shipment .
	 * @param \WC_Order                          $order .
	 */
	private function create_single_shipment( \WPDesk_Flexible_Shipping_Shipment $shipment, \WC_Order $order ) {
		$meta_data      = $shipment->get_meta_data();
		$fs_method      = $shipment->get_meta( '_fs_method', [ 'method_integration' => $shipment->get_integration() ] );
		$order_shipment = fs_create_shipment( $order, $fs_method );
		$integration    = $order_shipment->get_integration();
		$this->setup_shipment_meta_data( $meta_data, $integration, $shipment, $order_shipment );
		$order_shipment->save();

		/**
		 * New shipment created from subscription.
		 *
		 * @param \WPDesk_Flexible_Shipping_Shipment $order_shipment Created shipment.
		 */
		do_action( 'flexible-shipping/shipment-from-subscription/created/' . $integration, $order_shipment );
	}

	/**
	 * @param array                              $meta_data .
	 * @param string                             $integration .
	 * @param \WPDesk_Flexible_Shipping_Shipment $shipment .
	 * @param \WPDesk_Flexible_Shipping_Shipment $order_shipment .
	 */
	private function setup_shipment_meta_data( array $meta_data, $integration, \WPDesk_Flexible_Shipping_Shipment $shipment, \WPDesk_Flexible_Shipping_Shipment $order_shipment ) {
		foreach ( $meta_data as $meta_key => $meta_value ) {
			$order_shipment_meta_value =
				apply_filters( 'flexible-shipping/shipment-from-subscription/meta-value/' . $integration, $shipment->get_meta( $meta_key ), $meta_key, $order_shipment );
			$order_shipment->set_meta( $meta_key, $order_shipment_meta_value );
		}
	}


}
html-column-shipping-shipping.php                                                                                                                                                                                                                              1671          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * @var array    $shipping .
 * @var string[] $statuses .
 */

defined( 'ABSPATH' ) || exit;
?>
<div class="shipping">
	<div class="shipping-status">
		<a class="icon-status icon-status-<?php echo esc_attr( $shipping['status'] ); ?> tips" href="<?php echo esc_url( $shipping['url'] ); ?>" data-tip="<?php echo esc_attr( $statuses[ $shipping['status'] ] ); ?>">
			<?php echo esc_html( $statuses[ $shipping['status'] ] ); ?>
		</a>

		<?php do_action( 'flexible_shipping_shipping_status_html', $shipping ); ?>
	</div>
	<div class="shipping-actions order_actions">
		<?php if ( ! empty( $shipping['label_url'] ) ) : ?>
			<a class="button tips get-label" target="_blank" href="<?php echo esc_url( $shipping['label_url'] ); ?>" data-tip="<?php esc_attr_e( 'Get label for: ', 'flexible-shipping' ); ?><?php echo esc_attr( $shipping['tracking_number'] ); ?>">
				<?php esc_html_e( 'Get label for: ', 'flexible-shipping' ); ?><?php echo wp_kses_post( $shipping['tracking_number'] ); ?>
			</a>
		<?php endif; ?>

		<?php if ( ! empty( $shipping['tracking_url'] ) ) : ?>
			<a class="button tips track" target="_blank" href="<?php echo esc_url( $shipping['tracking_url'] ); ?>" data-tip="<?php esc_attr_e( 'Track shipment for: ', 'flexible-shipping' ); ?><?php echo esc_attr( $shipping['tracking_number'] ); ?>">
				<?php esc_html_e( 'Track shipment for: ', 'flexible-shipping' ); ?><?php echo wp_kses_post( $shipping['tracking_number'] ); ?>
			</a>
		<?php endif; ?>

		<?php do_action( 'flexible_shipping_shipping_actions_html', $shipping ); ?>
	</div>
	<div style="clear: both;"></div>
	<?php do_action( 'flexible_shipping_shipping_html', $shipping ); ?>
</div>
html-orders-filter-form.php                                                                                                                                                                                                                                    1115          1711369794  plugins/flexible-shipping/src/WPDesk/FS/Shipment/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * @var string[] $integrations .
 * @var string[] $statuses     .
 * @var string   $integration  .
 */

defined( 'ABSPATH' ) || exit;
?>
<div class="alignleft actions">
	<select name="flexible_shipping_integration_filter">
		<option value=""><?php esc_html_e( 'All shippings', 'flexible-shipping' ); ?></option>
		<optgroup label="<?php esc_attr_e( 'Integration', 'flexible-shipping' ); ?>">

			<?php foreach ( $integrations as $key => $val ) : ?>
				<option value="<?php echo esc_attr( $key ); ?>" <?php selected( $key, $integration ); ?>><?php echo wp_kses_post( $val ); ?></option>
			<?php endforeach; ?>
		</optgroup>
	</select>

	<select name="flexible_shipping_status_filter">
		<option value=""><?php esc_html_e( 'All shippings', 'flexible-shipping' ); ?></option>
		<optgroup label="<?php esc_attr_e( 'Shipment status', 'flexible-shipping' ); ?>">
			<?php foreach ( $statuses as $key => $val ) : ?>
				<option value="<?php echo esc_attr( $key ); ?>" <?php selected( $key, $integration ); ?>><?php echo wp_kses_post( $val ); ?></option>
			<?php endforeach; ?>
		</optgroup>
	</select>
</div>
Beacon.php                                                                                                                                                                                                                                                     7340          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Beacon                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class Beacon
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Beacon;

use FSVendor\Octolize\BetterDocs\Beacon\BeaconOptions;

/**
 * Can display Help Scout beacon.
 */
class Beacon extends \FSVendor\Octolize\BetterDocs\Beacon\Beacon {

	const FS_DOCS_CATEGORY = 14;

	/**
	 * Beacon constructor.
	 *
	 * @param BeaconDisplayStrategy $strategy   .
	 * @param string                $assets_url .
	 */
	public function __construct( BeaconDisplayStrategy $strategy, $assets_url ) {
		parent::__construct(
			( new BeaconOptions( [ self::FS_DOCS_CATEGORY ] ) ),
			$strategy,
			$assets_url,
			'search-input',
			'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAAA4CAYAAABdVHLrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyVpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RERGQzJFRkUwQkRBMTFFQkE4RkRGNkZGMzFCRjkwNDYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RERGQzJFRkQwQkRBMTFFQkE4RkRGNkZGMzFCRjkwNDYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpEREZDMkVGOTBCREExMUVCQThGREY2RkYzMUJGOTA0NiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpEREZDMkVGQTBCREExMUVCQThGREY2RkYzMUJGOTA0NiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsSYqBcAAA/0SURBVHja7J0JeBRFFsdf90zuTDgTIAkJV1BBUFAEJYuggqLiuosniIouhyewKMui67F+KroerOwuiq64rpwq7ApyKSungNz3lRASCLnvY3LMpLf+NV1Dz2RmMplE4MP6f1+ne6arq3u6f/XqvarqilJSUkLepGka+ZJxv9jOKrfRhBU592eX2V41mxRbnaZ1UIjy2dLdavOdn9SloTCzQrY6Ivb8KZxtV9TWUUSwSgWVdmXPhE48jaIozvTGbU/ytV/xBrA3eN2hxYXuz6miTRlVI747WfFNZmmtfIJSXhUTaaaoEJVSCmqUXeM7kar4B7PX7z0B3BC8WGNrxfFyemtzoYYSJiXVWMVZzPRkv1bK8KQIUgyQNgZiF4D9ARfakF5JMzcXaNnldvkUpJqspNZB9Gz/1kpyQpgLqP6A7ATYH3irmQ/7yoaCsatTyj+Vt12quRUfZaYzpbYgtmnbO7GzXxCbvcHrbnXPltXSmGXZWqFVWl2pn0cMXmJxX61dI8WdSXeQsR/fqQ3Bi2VThpVGL82S8Er97GLwUstQVfsps8rJny8jqxQXF/uE96PdJTR3Z7EmG8CkzqeYJaZJA1orD/WycEvrzS9WfcE7l8H7kYRX6gJZ4ve2Fmpg0JclVr3B+/3JSvqQwStvpdSFFBhcm1rpFWLVE7zHCmroTz/kSXilLgq9vD5PO5pf4xFiFwuMpajKTlPW5GrVMl6TukgEFn+/NlcDm0aIIbP4QixvbymaLTsopC42gck7F2Zq1lothH2sEWMqzEYLnFpUS2tSK55uzhNHhZpoaFILuj7BQsPYGp+NKmWlau2JEtqaUUbfsTU+S0l5EoMXqxrjd0phYSGHt66ujp5dkz/rx9PWSc0F7mPXRrMlph60Zbp/YgmpD/OnO3PZkidBlvKoYJNCNXYN4NTBCisFBQUcYAYuPbM68MANkL50czzd06s1Hc6xUnyLYCe4mSU19P7mLDrD1odzrU44sb9HTBj1aBdOjzPY49gxAuRSBjny2JZRTuOXnpRAS7kYXvzZPT6RlPz8fLLXaTRqWfb8lMLaUYHCu+jBJAZimMv3RxisAHft8RK/8hnWvQVNSe5AV8S45oMC8cDCExJiKaMVVnaNS3C0QmSU2ihQeKG5v+3C4QWwvWftp68PFPLv46KCudX1V0iLYyDkgbyQJ/J+mVl3KSnuBNsN7cBwHzakW5uU4YCESL6+f4HDSk79Np0D6M0yexLSIC2OwbHIA3khT2gkc02kpIwCuxzg9acqZzUlo0zdyr5ksJKNgdgTvEIiz8xGWHKpS18RQap27SenSc2vtNPB3JqAWx4AnWhNQAD3zh2JPiHGdn9msbHwIM4HvMjrHt3yavq5pKSgSv0tIPPGjKohTekzFs1k8FXRaiCAe04HUQAJF2Dl2Mu95uMNXjS5wTdGYIdzzWJBodT5kZlFSCnT+lBeRS31m33w4nIf2BLOrLD5uzTr+KZYX7T1QqKZbPGopHoQa15cDtFs5p7GCC98YBQMBIo4F9qJ/WmNiGK1wv4pvZ2f0dJSaLXRrjMVNPenXNqdWXHJA/j6rR3psuhQuueLE36lj44w009PX0ljFqfS5lNlxG4Z/e3HbKqouThbfzDy3ZxSWHNHoBmInjUAKZrKAJwRYuFaQLM2Z7sA6CgAMTQ5uX299AJeNKFhwTkAPM75ld7K4Y9s7CmsOlZMISaFktqG0m2XteQ9gyhcyw4VXdIA39wtqlGtQLd0a+Ey3hYAv7Px4q3x4i1mUq58d69WVhPYW8XvMksJ1wAwGKGCXwuIjT1tt887ykH0FsQZ3QsjvE5XpV8MC+ji6rkaDVngSmY9ery33/n9WGbFX74lnsrZOQbOOUQlrDAh7YybYjnYuOb0omr6mFnpJfvP/aarOoTTCzfF8TUK4IqjRfTW+rNUZdNYjZHACl0bevyrVFqXUsrTrxt3BXVtE0p9/3qAFyJcy/6sSprHCvAMlg/aMlGgt2WU0awRnXjzIQra9FUZJFqJRl/dhsb3b0exvDmymt7blE3LjzgK3cqxl/EOoBGfHaXXhsHShtG+rAqasjydv7u4e1IvV5g/PkwnC6ppEjMW97JrbRNupjT2O/Eb1p8spT8PjaeHr4l2psd5piw/Vc+FgBF4YUgc9esYQSYG+z72m/6y8SztPFPR4HVllTXvlAvtI02kWkLUgDPAA4fcSznAE81fwvJ6g1ekRxohd3gdaSpdzhmo5u3MYze7nCIZqIM6R/HvPrirEz1wVVvacbqC3t+URWFBKr19eyK39lBLVlP8+/6u1Lt9OM3ZlsN7B8eymuPVoR39OmeVzWEg4Ard3bM1LdiTzwvNH4fE8jy+ZAWlmBWKe3u3cf6+W5j1fP22BEovZtB9c4rf4w/uSqQ+seF6ng7K32Rpvj1aTLsyy2lAgoWmD47lVf7MHzL5/rTCKm5g8spt9AgDdHJyBx6vzFiTQW0ZxHN+05m7DssOFTrdqo+259B8do3uAisLHuxGyZ0ttGhfAS/kKNCf39eV2kUGNXhdza0iax2pBZWB+zeiVQAP1F1GqOE2NCRjGk/VHrqgqZlaImAJocRWwfwBDO4aRUdZ/hOXpTFAc2nqigy+f0L/GL5+8Oq27LxmDj8KGmqAL/cX8H2q0vD56vThf60ZMNNWZrB4IZtbrmCTyq3uJztyuWWGerUPd9Y40MwfztK61BJ6/X+ZvHq/j0FuzPPz3XkcpD+sdFzzNfERVM1M+GrdpSuotPHaEV3zx/OtHOYX156mpQeL6PuUEl5Ye7N7sOdsJWWwwgJtSivz+ExHsfsQHRFEX+zOp9fWZdK7rLCjQIcHm+jhvm0bvK7mDzIVMlfbmzZuvczLwOEeencwfFd/gi6kEX4ujnW/gc3ZjWzWqUMQ0J1VidA+HWrooG7tu+n7urVxrI/kOQoReoKe1x9MY1TMgsicckc1KtZH9YKZo1evkbrb1aV1iKNKfsy15SZJvyahA9mOaz1bWsvhiQrxXsAB8xMD2nFXiEXwzvsQHuSfUejeNky/VxVe71Ug1xWoMKGOGfNYNWXOsoZemGtMzufrFZA+cRF69VpNLcNM+rk1D5bTsTbpXlZDxlY1BEAh5vqpa+u0ennb9A3xWXG7r499mcqqSpvzOKvbLEiiW1VzHuP9Kv9xd2ful09bmc7chUoePN95RSu/75v4ecY7pbj9nkCuK1CFsnustotoWsnwVqWLKt84Kq2hfOL1ZjVxrD/naXy7dTSvpgHFhrRSOpZXpQdp56q4q/XtY7rFTS1wpBGDjPAoPh7ZhZaMTuKgitpBXD/m/2pvCW7SdSLAEv4zqveTrLBFsqq6vJEBt0mnLjJY5fCixkRwmsJ+U0LLEBcwzx3jOS9xP+B2nQtuXe/V+VRkMHMhajXCnQoJ1H1A1I6xEO5VfryhjdefDgikMR57uMrq0SUpa+S7TsFmlWb/2jGJXBJ7gN1ZVAyrB98M0Tpchw0sCr+xSxTNZsEcqsRH9Wj8gy2OwBIBy0RW9eJ79AB1ahXCg61vDhfyPPbq7gd8Zjx7NNUVsuo6hgU2SoCG5zPmb9+QaOGRPPzJ4SxPBEPP/DfNr6YxUajQwvPEgBh2rUW80LYKM/NCnMh+Q6QewCNY3cUC2xL9GPjfcGXWHHedcmHh3gIad10MjekbzWsCWNbfsc9wjf61K++8A1xSrZFaVauVB5qBaPtFs4l7sxi6h4VQVTU0FgJphDyNnRDn8HdoptHfHcGqyTsub0XRDKh1LHC5b/4J/haI0LMsyl/CgrKBnSw0dVAH3iLw1H/S6Md0x63Jq7DRo0tSefT+1PXtaDCD/XP2wKavOs33f3ukiEft8CXxQL9g2yfyHVY72BQYwbi+l1iwhePhsyLKn7E6g5YfKfbr+EIdKlTto3gQauKFFvA/x34jrPkDC07QcWY5URhxfxfty+eBXJ/YCF546hUKZjxGL0ph96WMF2aAvoOBP2phCisc57+zAwVIGTP/yFcbM6wjA8lAjH3ATUmec8gFXjG2ARrp7MjIcnnbQvTkoWkHMqZHGowBFs1pm5/oyS2ze5uz1C9XKNzmYV1CFwYKMKxEmf7mBAajA2RvA3MAJUDFIqpAo5vhKT3yAsRIhwXnMlpOqV+2ULeZX1xf9LUSYAsArOQ/d+Tx6n/ywA7OgM0dRve8jeB6SmMcAASIBfA4l3wrQ0rAW23XFCUzM5MmrC7KOJBb0zGQjADsFla9i25jX6PK0MMGGEVAdlgfwSa6neEaPGc4VnRVi/bk4fOOSoCluMKDFBZQawoPQwclhCYEmhGAEtFrQ/DCn0V6tFhgwbbodkYab+OJhYWW8EoJAV6sVXRPJsc3rc1SuASvrjvjE15v8gWxyNOT2yElxS1wgkWlWIs54Ey2623AIoBrDLy+IBZvchjPISUVFexov976SHuHBYae728JuK9v3NKTzreH90/u7Rzbe7r43FvG/ghpcQyEPJCXeNsZ55CS4m5rTR1nlc8bnJ2dTXa7nc/MM2ld6cZdWdW/CjSYw6vvCLrc37hA4Pbpjlw6xEA84jaxCbpne+J1oX4xTjfBeDx8YLgR0v+VgtB1X21z+L/bx8Y6AAa8gPhgvp0mri5stjE1sKKYqCTOT/9VzOAjOyqkfEhxug+qSmYxfTs+9Gyj0eDEsFXr063Dm+NMABELxkqgH78n3koOcbyVLPxadE8eYv4v3kzYJv1cKR/CsAAxek9wq+Tk5Dgn94MVzq2soyfXFsv/ASd1UQmjJnMq7C7WV19UJ9HYjg5T6M0bo5QQOQWD1MXi9zIWBbyCVacVzsvL49bXaIWx3pRppxc2yP+RIXXh9caNLZTkODM3sCaTia8BL98WltfoC2NJjlXp4V6Rirx9UhdS4/pYlIGxJieXRk4h1ekMG3aI9eNXBtPEvhZFUix1IZoawN5Dlwe5MOnOq8sM7UZXwrhszbLTK5tLtSqb9Cikfn7hVaEXb4hSru9gMgZrLiA7t71ZXyPtA9qr9PehLZSmdDdLSfmjOMbYh7e2VMCcu1vryQqrxsjO/V96Gsnv1lKls2W2iIQoc5pZlTdaqnmFN6/ahqmUWWZTOkYq9ayuJ0Yhs7FZgjvFunMM10FsQ/r/5qrMKLV1wUaoWZEuhVSzKMjxL+qVfGudk0FPlteTD6x6otv9QNF0YVSVoz9awfxUUlKBSJ/WTAG8xu/dm8s8wev0HMR/q3f/d7PGYE5YZGOQN2hBgTMT5h/T9mw7LT5SoVVLqyzlQ1EM2tLqOq8NW1vGxDiBFTB7gte5FgD7gtgT1O7/4RPLkMWOvKZeZ5n2/o7yN5ivjAlaMP0Wf727xi7h/iUIsz2FsIeP2Y74+5b6s7faNI/gbhrd1qul9QUv39a05oOq08w9xo/92YLROZgdBK8Sw5TXnZreRz7hS1wGDjBhGqatxBsNNmOa5uLg/wIMAArjANNZ26qLAAAAAElFTkSuQmCC'
		);
	}

}
BeaconClickedAjax.php                                                                                                                                                                                                                                          2205          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Beacon                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class BeaconAjax
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Beacon;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can register Beacon click vi AJAX.
 */
class BeaconClickedAjax implements Hookable {

	const OPTION_NAME  = 'flexible_shipping_beacon_clicked';
	const NONCE_ACTION = 'flexible_shipping_beacon_clicked';
	const AJAX_ACTION  = 'flexible_shipping_beacon_clicked';

	/**
	 * @var BeaconDisplayStrategy
	 */
	private $strategy;

	/**
	 * @var string
	 */
	private $assets_url;

	/**
	 * @var string
	 */
	private $scripts_version;

	/**
	 * BeaconAjax constructor.
	 *
	 * @param BeaconDisplayStrategy $strategy        .
	 * @param string                $assets_url      .
	 * @param string                $scripts_version .
	 */
	public function __construct( BeaconDisplayStrategy $strategy, $assets_url, $scripts_version ) {
		$this->strategy        = $strategy;
		$this->assets_url      = $assets_url;
		$this->scripts_version = $scripts_version;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		if ( 0 === (int) get_option( self::OPTION_NAME, 0 ) ) {
			if ( $this->strategy->shouldDisplay() ) {
				add_action( 'admin_enqueue_scripts', [ $this, 'add_script' ] );
			}
			add_action( 'wp_ajax_' . self::AJAX_ACTION, [ $this, 'handle_ajax_action' ] );
		}
	}

	/**
	 * @internal
	 */
	public function add_script() {
		$suffix = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ? '' : '.min';
		$handle = 'fs_beacon_clicked';

		wp_register_script(
			$handle,
			trailingslashit( $this->assets_url ) . 'js/beacon-clicked' . $suffix . '.js',
			[ 'jquery' ],
			$this->scripts_version
		);

		wp_localize_script(
			$handle,
			'fs_beacon_clicked',
			[
				'ajax_url' => admin_url( 'admin-ajax.php' ),
				'action'   => self::AJAX_ACTION,
				'nonce'    => wp_create_nonce( self::NONCE_ACTION ),
			]
		);

		wp_enqueue_script( $handle );
	}

	/**
	 * Handle AJAX action.
	 *
	 * @internal
	 */
	public function handle_ajax_action() {
		check_ajax_referer( self::AJAX_ACTION, 'nonce' );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}
		update_option( self::OPTION_NAME, 1 );
		wp_send_json_success();
	}
}
BeaconDeactivationTracker.php                                                                                                                                                                                                                                  997           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Beacon                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Deactivation tracker data.
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Beacon;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can add beacon data to deactivation tracker data.
 */
class BeaconDeactivationTracker implements Hookable {

	const ADDITIONAL_DATA = 'additional_data';

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_deactivation_data', [ $this, 'append_beacon_data_to_deactivation_tracker' ] );
	}

	/**
	 * Set new rules table data to data array.
	 *
	 * @param array $data Data.
	 *
	 * @return array
	 * @internal
	 */
	public function append_beacon_data_to_deactivation_tracker( array $data ) {
		if ( empty( $data[ self::ADDITIONAL_DATA ] ) || ! is_array( $data[ self::ADDITIONAL_DATA ] ) ) {
			$data[ self::ADDITIONAL_DATA ] = [];
		}

		$data[ self::ADDITIONAL_DATA ]['beacon'] = [ 'clicked' => 1 === (int) get_option( BeaconClickedAjax::OPTION_NAME, 0 ) ? 'yes' : 'no' ];

		return $data;
	}
}
BeaconDisplayStrategy.php                                                                                                                                                                                                                                      1456          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Beacon                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class BeaconDisplayStrategy
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Beacon;

use Exception;
use FSVendor\WPDesk\Beacon\BeaconGetShouldShowStrategy;
use WC_Shipping_Zones;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Beacon display strategy.
 */
class BeaconDisplayStrategy extends BeaconGetShouldShowStrategy {

	/**
	 * BeaconDisplayStrategy constructor.
	 */
	public function __construct() {
		$conditions = [
			[
				'page' => 'wc-settings',
				'tab'  => 'shipping',
			],
		];
		parent::__construct( $conditions );
	}

	/**
	 * Should Beacon be visible?
	 *
	 * @return bool
	 */
	public function shouldDisplay() {
		if ( parent::shouldDisplay() && ! wpdesk_is_plugin_active( 'flexible-shipping-pro/flexible-shipping-pro.php' ) ) {
			if ( isset( $_GET['instance_id'] ) ) { // phpcs:ignore
				$instance_id = sanitize_text_field( $_GET['instance_id'] );  // phpcs:ignore
				try {
					$shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );
					if ( $shipping_method && ( ( $shipping_method instanceof WPDesk_Flexible_Shipping ) || ( $shipping_method instanceof ShippingMethodSingle ) ) ) {

						return true;
					}
				} catch ( Exception $e ) {

					return false;
				}
			}
			if ( isset( $_GET['section'] ) && sanitize_key( $_GET['section'] ) === 'flexible_shipping_info' ) { // phpcs:ignore
				return true;
			}
		}

		return false;
	}
}
Beacon.php                                                                                                                                                                                                                                                     7277          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php
/**
 * Class Beacon
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate;

use WPDesk\FS\TableRate\Beacon\BeaconDisplayStrategy;

/**
 * Can display Help Scout beacon.
 */
class Beacon extends \FSVendor\WPDesk\Beacon\Beacon {

	/**
	 * Beacon constructor.
	 *
	 * @param BeaconDisplayStrategy $strategy .
	 * @param string                $assets_url .
	 */
	public function __construct( BeaconDisplayStrategy $strategy, $assets_url ) {
		parent::__construct(
			'2321116f-e474-45a7-b04d-0950420ff894',
			$strategy,
			$assets_url,
			'hs-beacon-search',
			'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAAA4CAYAAABdVHLrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyVpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RERGQzJFRkUwQkRBMTFFQkE4RkRGNkZGMzFCRjkwNDYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RERGQzJFRkQwQkRBMTFFQkE4RkRGNkZGMzFCRjkwNDYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpEREZDMkVGOTBCREExMUVCQThGREY2RkYzMUJGOTA0NiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpEREZDMkVGQTBCREExMUVCQThGREY2RkYzMUJGOTA0NiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsSYqBcAAA/0SURBVHja7J0JeBRFFsdf90zuTDgTIAkJV1BBUFAEJYuggqLiuosniIouhyewKMui67F+KroerOwuiq64rpwq7ApyKSungNz3lRASCLnvY3LMpLf+NV1Dz2RmMplE4MP6f1+ne6arq3u6f/XqvarqilJSUkLepGka+ZJxv9jOKrfRhBU592eX2V41mxRbnaZ1UIjy2dLdavOdn9SloTCzQrY6Ivb8KZxtV9TWUUSwSgWVdmXPhE48jaIozvTGbU/ytV/xBrA3eN2hxYXuz6miTRlVI747WfFNZmmtfIJSXhUTaaaoEJVSCmqUXeM7kar4B7PX7z0B3BC8WGNrxfFyemtzoYYSJiXVWMVZzPRkv1bK8KQIUgyQNgZiF4D9ARfakF5JMzcXaNnldvkUpJqspNZB9Gz/1kpyQpgLqP6A7ATYH3irmQ/7yoaCsatTyj+Vt12quRUfZaYzpbYgtmnbO7GzXxCbvcHrbnXPltXSmGXZWqFVWl2pn0cMXmJxX61dI8WdSXeQsR/fqQ3Bi2VThpVGL82S8Er97GLwUstQVfsps8rJny8jqxQXF/uE96PdJTR3Z7EmG8CkzqeYJaZJA1orD/WycEvrzS9WfcE7l8H7kYRX6gJZ4ve2Fmpg0JclVr3B+/3JSvqQwStvpdSFFBhcm1rpFWLVE7zHCmroTz/kSXilLgq9vD5PO5pf4xFiFwuMpajKTlPW5GrVMl6TukgEFn+/NlcDm0aIIbP4QixvbymaLTsopC42gck7F2Zq1lothH2sEWMqzEYLnFpUS2tSK55uzhNHhZpoaFILuj7BQsPYGp+NKmWlau2JEtqaUUbfsTU+S0l5EoMXqxrjd0phYSGHt66ujp5dkz/rx9PWSc0F7mPXRrMlph60Zbp/YgmpD/OnO3PZkidBlvKoYJNCNXYN4NTBCisFBQUcYAYuPbM68MANkL50czzd06s1Hc6xUnyLYCe4mSU19P7mLDrD1odzrU44sb9HTBj1aBdOjzPY49gxAuRSBjny2JZRTuOXnpRAS7kYXvzZPT6RlPz8fLLXaTRqWfb8lMLaUYHCu+jBJAZimMv3RxisAHft8RK/8hnWvQVNSe5AV8S45oMC8cDCExJiKaMVVnaNS3C0QmSU2ihQeKG5v+3C4QWwvWftp68PFPLv46KCudX1V0iLYyDkgbyQJ/J+mVl3KSnuBNsN7cBwHzakW5uU4YCESL6+f4HDSk79Np0D6M0yexLSIC2OwbHIA3khT2gkc02kpIwCuxzg9acqZzUlo0zdyr5ksJKNgdgTvEIiz8xGWHKpS18RQap27SenSc2vtNPB3JqAWx4AnWhNQAD3zh2JPiHGdn9msbHwIM4HvMjrHt3yavq5pKSgSv0tIPPGjKohTekzFs1k8FXRaiCAe04HUQAJF2Dl2Mu95uMNXjS5wTdGYIdzzWJBodT5kZlFSCnT+lBeRS31m33w4nIf2BLOrLD5uzTr+KZYX7T1QqKZbPGopHoQa15cDtFs5p7GCC98YBQMBIo4F9qJ/WmNiGK1wv4pvZ2f0dJSaLXRrjMVNPenXNqdWXHJA/j6rR3psuhQuueLE36lj44w009PX0ljFqfS5lNlxG4Z/e3HbKqouThbfzDy3ZxSWHNHoBmInjUAKZrKAJwRYuFaQLM2Z7sA6CgAMTQ5uX299AJeNKFhwTkAPM75ld7K4Y9s7CmsOlZMISaFktqG0m2XteQ9gyhcyw4VXdIA39wtqlGtQLd0a+Ey3hYAv7Px4q3x4i1mUq58d69WVhPYW8XvMksJ1wAwGKGCXwuIjT1tt887ykH0FsQZ3QsjvE5XpV8MC+ji6rkaDVngSmY9ery33/n9WGbFX74lnsrZOQbOOUQlrDAh7YybYjnYuOb0omr6mFnpJfvP/aarOoTTCzfF8TUK4IqjRfTW+rNUZdNYjZHACl0bevyrVFqXUsrTrxt3BXVtE0p9/3qAFyJcy/6sSprHCvAMlg/aMlGgt2WU0awRnXjzIQra9FUZJFqJRl/dhsb3b0exvDmymt7blE3LjzgK3cqxl/EOoBGfHaXXhsHShtG+rAqasjydv7u4e1IvV5g/PkwnC6ppEjMW97JrbRNupjT2O/Eb1p8spT8PjaeHr4l2psd5piw/Vc+FgBF4YUgc9esYQSYG+z72m/6y8SztPFPR4HVllTXvlAvtI02kWkLUgDPAA4fcSznAE81fwvJ6g1ekRxohd3gdaSpdzhmo5u3MYze7nCIZqIM6R/HvPrirEz1wVVvacbqC3t+URWFBKr19eyK39lBLVlP8+/6u1Lt9OM3ZlsN7B8eymuPVoR39OmeVzWEg4Ard3bM1LdiTzwvNH4fE8jy+ZAWlmBWKe3u3cf6+W5j1fP22BEovZtB9c4rf4w/uSqQ+seF6ng7K32Rpvj1aTLsyy2lAgoWmD47lVf7MHzL5/rTCKm5g8spt9AgDdHJyBx6vzFiTQW0ZxHN+05m7DssOFTrdqo+259B8do3uAisLHuxGyZ0ttGhfAS/kKNCf39eV2kUGNXhdza0iax2pBZWB+zeiVQAP1F1GqOE2NCRjGk/VHrqgqZlaImAJocRWwfwBDO4aRUdZ/hOXpTFAc2nqigy+f0L/GL5+8Oq27LxmDj8KGmqAL/cX8H2q0vD56vThf60ZMNNWZrB4IZtbrmCTyq3uJztyuWWGerUPd9Y40MwfztK61BJ6/X+ZvHq/j0FuzPPz3XkcpD+sdFzzNfERVM1M+GrdpSuotPHaEV3zx/OtHOYX156mpQeL6PuUEl5Ye7N7sOdsJWWwwgJtSivz+ExHsfsQHRFEX+zOp9fWZdK7rLCjQIcHm+jhvm0bvK7mDzIVMlfbmzZuvczLwOEeencwfFd/gi6kEX4ujnW/gc3ZjWzWqUMQ0J1VidA+HWrooG7tu+n7urVxrI/kOQoReoKe1x9MY1TMgsicckc1KtZH9YKZo1evkbrb1aV1iKNKfsy15SZJvyahA9mOaz1bWsvhiQrxXsAB8xMD2nFXiEXwzvsQHuSfUejeNky/VxVe71Ug1xWoMKGOGfNYNWXOsoZemGtMzufrFZA+cRF69VpNLcNM+rk1D5bTsTbpXlZDxlY1BEAh5vqpa+u0ennb9A3xWXG7r499mcqqSpvzOKvbLEiiW1VzHuP9Kv9xd2ful09bmc7chUoePN95RSu/75v4ecY7pbj9nkCuK1CFsnustotoWsnwVqWLKt84Kq2hfOL1ZjVxrD/naXy7dTSvpgHFhrRSOpZXpQdp56q4q/XtY7rFTS1wpBGDjPAoPh7ZhZaMTuKgitpBXD/m/2pvCW7SdSLAEv4zqveTrLBFsqq6vJEBt0mnLjJY5fCixkRwmsJ+U0LLEBcwzx3jOS9xP+B2nQtuXe/V+VRkMHMhajXCnQoJ1H1A1I6xEO5VfryhjdefDgikMR57uMrq0SUpa+S7TsFmlWb/2jGJXBJ7gN1ZVAyrB98M0Tpchw0sCr+xSxTNZsEcqsRH9Wj8gy2OwBIBy0RW9eJ79AB1ahXCg61vDhfyPPbq7gd8Zjx7NNUVsuo6hgU2SoCG5zPmb9+QaOGRPPzJ4SxPBEPP/DfNr6YxUajQwvPEgBh2rUW80LYKM/NCnMh+Q6QewCNY3cUC2xL9GPjfcGXWHHedcmHh3gIad10MjekbzWsCWNbfsc9wjf61K++8A1xSrZFaVauVB5qBaPtFs4l7sxi6h4VQVTU0FgJphDyNnRDn8HdoptHfHcGqyTsub0XRDKh1LHC5b/4J/haI0LMsyl/CgrKBnSw0dVAH3iLw1H/S6Md0x63Jq7DRo0tSefT+1PXtaDCD/XP2wKavOs33f3ukiEft8CXxQL9g2yfyHVY72BQYwbi+l1iwhePhsyLKn7E6g5YfKfbr+EIdKlTto3gQauKFFvA/x34jrPkDC07QcWY5URhxfxfty+eBXJ/YCF546hUKZjxGL0ph96WMF2aAvoOBP2phCisc57+zAwVIGTP/yFcbM6wjA8lAjH3ATUmec8gFXjG2ARrp7MjIcnnbQvTkoWkHMqZHGowBFs1pm5/oyS2ze5uz1C9XKNzmYV1CFwYKMKxEmf7mBAajA2RvA3MAJUDFIqpAo5vhKT3yAsRIhwXnMlpOqV+2ULeZX1xf9LUSYAsArOQ/d+Tx6n/ywA7OgM0dRve8jeB6SmMcAASIBfA4l3wrQ0rAW23XFCUzM5MmrC7KOJBb0zGQjADsFla9i25jX6PK0MMGGEVAdlgfwSa6neEaPGc4VnRVi/bk4fOOSoCluMKDFBZQawoPQwclhCYEmhGAEtFrQ/DCn0V6tFhgwbbodkYab+OJhYWW8EoJAV6sVXRPJsc3rc1SuASvrjvjE15v8gWxyNOT2yElxS1wgkWlWIs54Ey2623AIoBrDLy+IBZvchjPISUVFexov976SHuHBYae728JuK9v3NKTzreH90/u7Rzbe7r43FvG/ghpcQyEPJCXeNsZ55CS4m5rTR1nlc8bnJ2dTXa7nc/MM2ld6cZdWdW/CjSYw6vvCLrc37hA4Pbpjlw6xEA84jaxCbpne+J1oX4xTjfBeDx8YLgR0v+VgtB1X21z+L/bx8Y6AAa8gPhgvp0mri5stjE1sKKYqCTOT/9VzOAjOyqkfEhxug+qSmYxfTs+9Gyj0eDEsFXr063Dm+NMABELxkqgH78n3koOcbyVLPxadE8eYv4v3kzYJv1cKR/CsAAxek9wq+Tk5Dgn94MVzq2soyfXFsv/ASd1UQmjJnMq7C7WV19UJ9HYjg5T6M0bo5QQOQWD1MXi9zIWBbyCVacVzsvL49bXaIWx3pRppxc2yP+RIXXh9caNLZTkODM3sCaTia8BL98WltfoC2NJjlXp4V6Rirx9UhdS4/pYlIGxJieXRk4h1ekMG3aI9eNXBtPEvhZFUix1IZoawN5Dlwe5MOnOq8sM7UZXwrhszbLTK5tLtSqb9Cikfn7hVaEXb4hSru9gMgZrLiA7t71ZXyPtA9qr9PehLZSmdDdLSfmjOMbYh7e2VMCcu1vryQqrxsjO/V96Gsnv1lKls2W2iIQoc5pZlTdaqnmFN6/ahqmUWWZTOkYq9ayuJ0Yhs7FZgjvFunMM10FsQ/r/5qrMKLV1wUaoWZEuhVSzKMjxL+qVfGudk0FPlteTD6x6otv9QNF0YVSVoz9awfxUUlKBSJ/WTAG8xu/dm8s8wev0HMR/q3f/d7PGYE5YZGOQN2hBgTMT5h/T9mw7LT5SoVVLqyzlQ1EM2tLqOq8NW1vGxDiBFTB7gte5FgD7gtgT1O7/4RPLkMWOvKZeZ5n2/o7yN5ivjAlaMP0Wf727xi7h/iUIsz2FsIeP2Y74+5b6s7faNI/gbhrd1qul9QUv39a05oOq08w9xo/92YLROZgdBK8Sw5TXnZreRz7hS1wGDjBhGqatxBsNNmOa5uLg/wIMAArjANNZ26qLAAAAAElFTkSuQmCC'
		);
	}

}
Creator.php                                                                                                                                                                                                                                                    12952         1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ContextualInfo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Contextual info creator.
 *
 * @package Contextual Info
 */

namespace WPDesk\FS\TableRate\ContextualInfo;

use Flexible_Shipping_Contextual_Info;
use FSVendor\WPDesk\PluginBuilder\Plugin\HookableCollection;
use FSVendor\WPDesk\PluginBuilder\Plugin\HookableParent;

/**
 * Can create contextual info.
 */
class Creator implements HookableCollection {

	use HookableParent;

	const METHOD_TITLE_ELEMENT                         = 'woocommerce_flexible_shipping_method_title';
	const METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS = 'woocommerce_flexible_shipping_method_title,woocommerce_flexible_shipping_method_description';

	/**
	 * @var string
	 */
	private $base_location_country;

	/**
	 * Flexible_Shipping_Contextual_Info_Creator constructor.
	 *
	 * @param string $base_location_country .
	 */
	public function __construct( $base_location_country ) {
		$this->base_location_country = $base_location_country;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		$this->hooks_on_hookable_objects();
	}

	/**
	 * Create contextual info.
	 */
	public function create_contextual_info() {
		$other_phrases_not_in = [];

		$phrases_in = $this->get_dhl_express_phrases();
		$this->create_dhl_express_contextual_info( $phrases_in );
		$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

		$phrases_in = [ 'fedex' ];
		$this->create_fedex_contextual_info( $phrases_in );
		$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

		$phrases_in = [ 'ups' ];
		$this->create_ups_contextual_info( $phrases_in );
		$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

		if ( $this->is_base_location_country_pl() ) {
			$phrases_in = [ 'dpd' ];
			$this->create_dpd_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

			$phrases_in = [ 'List', 'poczta polska', 'pocztex', 'polecony', 'poczt', 'enadawca' ];
			$this->create_enadawca_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

			$phrases_in = [ 'dhl', 'parcel' ];
			$this->create_dhl_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

			$phrases_in = [ 'ruch', 'kiosk', 'orlen' ];
			$this->create_pwr_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );

			$phrases_in = [ 'paczkomat', 'paczka w weekend', 'inpost' ];
			$this->create_inpost_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );
		} elseif ( $this->is_base_location_country_gb() ) {
			$phrases_in = [ 'air', 'dpd' ];
			$this->create_dpd_uk_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );
		} elseif ( $this->is_base_location_country_us() ) {
			$phrases_in = [ 'usps' ];
			$this->create_usps_contextual_info( $phrases_in );
			$other_phrases_not_in = $this->merge_phrases( $other_phrases_not_in, $phrases_in );
		}

		$this->create_default_contextual_info( $other_phrases_not_in );
	}

	/**
	 * @return array
	 */
	private function get_dhl_express_phrases() {
		if ( $this->is_base_location_country_pl() ) {
			return [ 'dhl express' ];
		} else {
			return [ 'dhl', 'dhl express' ];
		}
	}

	/**
	 * @return bool
	 */
	private function is_base_location_country_pl() {
		return 'PL' === $this->base_location_country;
	}

	/**
	 * @return bool
	 */
	private function is_base_location_country_us() {
		return stripos( $this->base_location_country, 'US' ) !== false;
	}

	/**
	 * @return bool
	 */
	private function is_base_location_country_gb() {
		return 'GB' === $this->base_location_country;
	}

	/**
	 * @param array $phrases1 .
	 * @param array $phrases2 .
	 *
	 * @return array
	 */
	private function merge_phrases( array $phrases1, array $phrases2 ) {
		return array_merge( $phrases1, $phrases2 );
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_dhl_express_contextual_info( array $phrases_in ) {
		if ( ! defined( 'FLEXIBLE_SHIPPING_DHL_EXPRESS_VERSION' ) && ! defined( 'FLEXIBLE_SHIPPING_DHL_EXPRESS_PRO_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'dhl_express',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Want to show your customers the DHL Express live rates? %1$sCheck our DHL Express plugin →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-cross-dhl-express" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_fedex_contextual_info( array $phrases_in ) {
		if ( ! defined( 'FLEXIBLE_SHIPPING_FEDEX_VERSION' ) && ! defined( 'FLEXIBLE_SHIPPING_FEDEX_PRO_VERSION' ) ) {
			$target_url = $this->is_base_location_country_pl()
				? 'https://octol.io/fs-cross-fedex-pl'
				: 'https://octol.io/fs-cross-fedex';
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'fedex',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Want to show your customers the FedEx live rates? %1$sCheck our FedEx plugin →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="' . $target_url . '" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_ups_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_UPS_LABELS_VERSION' ) ) {
			$target_url = get_user_locale() === 'pl_PL'
				? 'https://octol.io/fs-cross-ups-labels-pl'
				: 'https://octol.io/fs-cross-ups-labels';
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'ups',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products with UPS? Create the shipments and generate shipping labels directly from your shop using our %1$sUPS Labels →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="' . $target_url . '" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_usps_contextual_info( array $phrases_in ) {
		if ( ! defined( 'FLEXIBLE_SHIPPING_USPS_PRO_VERSION' ) ) {
			$target_url = 'https://octol.io/fs-cross-usps';

			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'usps',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Want to show your customers the USPS live rates? %1$sCheck our USPS plugin →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="' . esc_url( $target_url ) . '" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_dpd_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_DPD_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'dpd',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via DPD? Create the shipments and generate shipping labels directly from your shop using our %1$sDPD integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-context-cross-dpd-pl" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_enadawca_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_ENADAWCA_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'enadawca',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via Poczta Polska? Create the shipments and generate shipping labels directly from your shop using our %1$sPoczta Polska eNadawca integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-context-cross-enadawca-pl" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_dhl_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_DHL_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'dhl',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via DHL? Create the shipments and generate shipping labels directly from your shop using our %1$sDHL integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-context-cross-dhl-pl" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_pwr_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_PACZKA_W_RUCHU_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'pwr',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via Orlen Paczka? Create the shipments and generate shipping labels directly from your shop using our %1$sOrlen Paczka integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-context-cross-op-pl" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_inpost_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_PACZKOMATY_INPOST_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'inpost',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via InPost? Create the shipments and generate shipping labels directly from your shop using our %1$sInPost integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-context-cross-inpost-pl" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * @param array $phrases_in .
	 */
	private function create_dpd_uk_contextual_info( array $phrases_in ) {
		if ( ! defined( 'WOOCOMMERCE_DPD_UK_VERSION' ) ) {
			$this->add_hookable(
				new Flexible_Shipping_Contextual_Info(
					self::METHOD_TITLE_AND_METHOD_DESCRIPTION_ELEMENTS,
					'dpd_uk',
					$phrases_in,
					sprintf(
					// Translators: link.
						__( 'Sending your products via DPD UK? Create the shipments and generate shipping labels directly from your shop using our %1$sDPD UK integration →%2$s', 'flexible-shipping' ),
						'<a class="button button-primary" href="https://octol.io/fs-cross-dpd-uk" target="_blank">',
						'</a>'
					)
				)
			);
		}
	}

	/**
	 * Crate default contextual info.
	 *
	 * @param array $phrases_not_in .
	 */
	private function create_default_contextual_info( array $phrases_not_in ) {
		$this->add_hookable(
			new Flexible_Shipping_Contextual_Info(
				self::METHOD_TITLE_ELEMENT,
				'other',
				[],
				$this->create_html_for_default_contextual_info(),
				$phrases_not_in
			)
		);
	}

	/**
	 * @return string
	 */
	private function create_html_for_default_contextual_info() {
		if ( $this->is_base_location_country_pl() ) {
			return __( 'Check our further shipping integrations with DPD, DHL, InPost, eNadawca and Orlen Paczka.', 'flexible-shipping' ) . '&nbsp;&nbsp;' .
				sprintf(
					// Translators: link.
					__( '%1$sAdd integrations%2$s', 'flexible-shipping' ),
					'<a class="button button-primary" href="https://octol.io/fs-context-cross-shipping-integrations-pl" target="_blank">',
					' &rarr;</a>'
				);
		} elseif ( $this->is_base_location_country_gb() ) {
			return __( 'Check our further shipping integration with DPD UK and FedEx / UPS live rates plugins.', 'flexible-shipping' ) . '&nbsp;&nbsp;' .
				sprintf(
					// Translators: link.
					__( '%1$sAdd integration%2$s', 'flexible-shipping' ),
					'<a class="button button-primary" href="https://octol.io/fs-integrations" target="_blank">',
					' &rarr;</a>'
				);
		} else {
			return __( 'Check our further shipping integration with FedEx / UPS / USPS live rates plugins.', 'flexible-shipping' ) . '&nbsp;&nbsp;' .
				sprintf(
					// Translators: link.
					__( '%1$sAdd integration%2$s', 'flexible-shipping' ),
					'<a class="button button-primary" href="https://octol.io/fs-integrations" target="_blank">',
					' &rarr;</a>'
				);
		}
	}
}
DebugTracker.php                                                                                                                                                                                                                                               3240          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Debug                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class Tracker
 *
 * @package WPDesk\FS\TableRate\Debug
 */

namespace WPDesk\FS\TableRate\Debug;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can handle tracker data related to debug mode.
 */
class DebugTracker implements Hookable {

	const NOTICE_OPTION_NAME  = 'flexible_shipping_debug_notice_added';
	const NOTICE_OPTION_VALUE = 1;

	const SETTINGS_OPTION_NAME  = 'flexible_shipping_debug_was_enabled';
	const SETTINGS_OPTION_VALUE = 1;

	const PRIORITY_AFTER_FS_TRACKER = 12;

	const ADDITIONAL_DATA = 'additional_data';

	const METHOD_DEBUG_MODE = 'method_debug_mode';

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'flexible_shipping_process_admin_options', array( $this, 'update_settings_option_if_not_set_and_debug_enabled' ) );

		add_action( 'flexible_shipping_debug_notice_added', array( $this, 'update_notice_option_if_not_set' ) );

		add_filter( 'wpdesk_tracker_data', array( $this, 'append_debug_notice_data_to_tracker' ), self::PRIORITY_AFTER_FS_TRACKER );
		add_filter( 'wpdesk_tracker_deactivation_data', array( $this, 'append_debug_notice_data_to_deactivation_tracker' ) );
	}

	/**
	 * Update option when debug is enabled and option not set.
	 *
	 * @param array $shipping_method_settings .
	 *
	 * @return array
	 */
	public function update_settings_option_if_not_set_and_debug_enabled( $shipping_method_settings ) {
		if ( isset( $shipping_method_settings[ self::METHOD_DEBUG_MODE ] ) && 'yes' === $shipping_method_settings[ self::METHOD_DEBUG_MODE ]
			&& self::SETTINGS_OPTION_VALUE !== (int) get_option( self::SETTINGS_OPTION_NAME, 0 )
		) {
			update_option( self::SETTINGS_OPTION_NAME, self::SETTINGS_OPTION_VALUE );
		}
		return $shipping_method_settings;
	}

	/**
	 * Update option when notice is added.
	 *
	 * @internal
	 */
	public function update_notice_option_if_not_set() {
		if ( self::NOTICE_OPTION_VALUE !== (int) get_option( self::NOTICE_OPTION_NAME, 0 ) ) {
			update_option( self::NOTICE_OPTION_NAME, self::NOTICE_OPTION_VALUE );
		}
	}

	/**
	 * Append debug notice dara to tracker.
	 *
	 * @param array $data .
	 *
	 * @return array
	 *
	 * @internal
	 */
	public function append_debug_notice_data_to_tracker( $data ) {
		$data['flexible_shipping']['debug_notice_was_enabled'] = self::SETTINGS_OPTION_VALUE === (int) get_option( self::SETTINGS_OPTION_NAME, 0 ) ? 'yes' : 'no';
		$data['flexible_shipping']['debug_notice_displayed'] = self::NOTICE_OPTION_VALUE === (int) get_option( self::NOTICE_OPTION_NAME, 0 ) ? 'yes' : 'no';

		return $data;
	}

	/**
	 * Set new rules table data to data array.
	 *
	 * @param array $data Data.
	 *
	 * @return array
	 *
	 * @internal
	 */
	public function append_debug_notice_data_to_deactivation_tracker( array $data ) {
		if ( empty( $data[ self::ADDITIONAL_DATA ] ) || ! is_array( $data[ self::ADDITIONAL_DATA ] ) ) {
			$data[ self::ADDITIONAL_DATA ] = array();
		}
		$data[ self::ADDITIONAL_DATA ]['fs_debug_notice_was_enabled'] = self::SETTINGS_OPTION_VALUE === (int) get_option( self::SETTINGS_OPTION_NAME, 0 ) ? 'yes' : 'no';
		$data[ self::ADDITIONAL_DATA ]['fs_debug_notice_displayed'] = self::NOTICE_OPTION_VALUE === (int) get_option( self::NOTICE_OPTION_NAME, 0 ) ? 'yes' : 'no';

		return $data;
	}

}
MultipleShippingZonesMatchedSameTerritoryNotice.php                                                                                                                                                                                                            7129          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Debug                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class MatchedShippingZonesNotice
 *
 * @package WPDesk\FS\TableRate\Debug
 */

namespace WPDesk\FS\TableRate\Debug;

use FSVendor\WPDesk\Notice\Notice;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can display notice if multiple shipping zones covers same territory.
 */
class MultipleShippingZonesMatchedSameTerritoryNotice implements Hookable {

	/**
	 * @var \WC_Countries
	 */
	private $countries;

	/**
	 * @var \WC_Shipping_Zones
	 */
	private $shipping_zones;

	/**
	 * MatchedShippingZonesNotice constructor.
	 *
	 * @param \WC_Countries      $countries .
	 * @param \WC_Shipping_Zones $shipping_zones .
	 */
	public function __construct( \WC_Countries $countries, \WC_Shipping_Zones $shipping_zones ) {
		$this->countries      = $countries;
		$this->shipping_zones = $shipping_zones;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'admin_notices', array( $this, 'add_notice_when_multiple_zones_matches_same_territory' ) );
	}

	/**
	 * .
	 *
	 * @return bool|Notice
	 * @internal
	 */
	public function add_notice_when_multiple_zones_matches_same_territory() {
		if ( $this->should_display_notice() ) {
			$shipping_zones_dependencies = $this->prepare_shipping_zones_dependencies();
			if ( count( $shipping_zones_dependencies ) ) {
				$zones_message = $this->prepare_zone_messages( $shipping_zones_dependencies );
				$notice_text = sprintf(
					// Translators: zones.
					__( '%1$sFlexible Shipping hints%2$sA potential shipping zone configuration conflict has been detected: %3$s In order to fix it, change the shipping zones order starting from the narrowest at the very top of the list to the widest at the bottom and refresh the page.', 'flexible-shipping' ),
					'<h4>',
					'</h4>',
					$zones_message
				);
				$notice = new Notice(
					$notice_text,
					Notice::NOTICE_TYPE_ERROR,
					false,
					10,
					array( 'class' => 'flexible-shipping-hint' )
				);

				$matched_shipping_zones_notice = $this;
				/**
				 * Do action after multiple zones matches same territory notice created.
				 *
				 * @param MultipleShippingZonesMatchedSameTerritoryNotice $matched_shipping_zones_notice .
				 */
				do_action( 'flexible-shipping/notice/multiple-zone-matches-same-territory', $matched_shipping_zones_notice );

				return $notice;
			}
		}

		return false;
	}

	/**
	 * .
	 *
	 * @return bool
	 */
	private function should_display_notice() {
		return isset( $_GET['page'] ) && sanitize_key( $_GET['page'] ) === 'wc-settings'
			&& isset( $_GET['tab'] ) && sanitize_key( $_GET['tab'] ) === 'shipping'
			&& empty( $_GET['section'] ) && empty( $_GET['zone_id'] );
	}

	/**
	 * @param array $dependencies .
	 *
	 * @return string
	 */
	private function prepare_zone_messages( $dependencies ) {
		$messages = '';
		foreach ( $dependencies as $dependency ) {
			if ( '' === $messages ) {
				$messages .= '<ul style="list-style-type: disc;">';
			}
			$zones = '';
			/** @var \WC_Shipping_Zone $zone */
			foreach ( $dependency['covered'] as $zone ) {
				$zones .= $zone->get_zone_name() . ', ';
			}
			$zones = trim( $zones, ', ' );
			$messages .= sprintf(
				// Translators: zone messages.
				__( '%1$sWider %2$s shipping zone covers the range of the narrower one placed below: %3$s.%4$s', 'flexible-shipping' ),
				'<li style="margin-left: 30px;">',
				'<strong>' . $dependency['zone']->get_zone_name() . '</strong>',
				'<strong>' . $zones . '</strong>',
				'</li>'
			);
		}
		if ( '' !== $messages ) {
			$messages .= '</ul>';
		}

		return $messages;
	}

	/**
	 * .
	 *
	 * @return array
	 */
	private function prepare_shipping_zones_dependencies() {
		$dependencies = array();
		$zones = $this->get_zones();
		foreach ( $zones as $zone_id => $zone_data ) {
			unset( $zones[ $zone_id ] );
			$zone = $this->get_zone( $zone_id );
			if ( ! $this->zone_contains_postcodes( $zone ) ) {
				$zone_dependencies = $this->prepare_covered_zones( $zone, $zones );
				if ( $zone_dependencies ) {
					$dependencies[ $zone_id ] = array(
						'zone' => $zone,
						'covered' => $zone_dependencies,
					);
				}
			}
		}

		return $dependencies;
	}

	/**
	 * @return array
	 *
	 * @codeCoverageIgnore
	 */
	protected function get_zones() {
		return $this->shipping_zones::get_zones();
	}

	/**
	 * @param int $zone_id .
	 *
	 * @return bool|\WC_Shipping_Zone
	 *
	 * @codeCoverageIgnore
	 */
	protected function get_zone( $zone_id ) {
		return $this->shipping_zones::get_zone( $zone_id );
	}

	/**
	 * @param \WC_Shipping_Zone $zone .
	 * @param array             $zones .
	 *
	 * @return array
	 */
	private function prepare_covered_zones( \WC_Shipping_Zone $zone, array $zones ) {
		$zone_dependencies = array();
		$locations = $zone->get_zone_locations();
		foreach ( $locations as $location ) {
			foreach ( $zones as $zone_id => $zone_data ) {
				$zone = $this->get_zone( $zone_id );
				if ( $this->location_covers_zone( $location, $zone ) ) {
					$zone_dependencies[] = $zone;
				}
			}
		}

		return $zone_dependencies;
	}

	/**
	 * @param \WC_Shipping_Zone $zone .
	 *
	 * @return bool
	 */
	private function zone_contains_postcodes( \WC_Shipping_Zone $zone ) {
		foreach ( $zone->get_zone_locations() as $location ) {
			if ( 'postcode' === $location->type ) {
				return true;
			}
		}

		return false;
	}

	/**
	 * @param \stdClass         $location .
	 * @param \WC_Shipping_Zone $zone .
	 *
	 * @return bool
	 */
	private function location_covers_zone( \stdClass $location, \WC_Shipping_Zone $zone ) {
		$covers = false;
		foreach ( $zone->get_zone_locations() as $zone_location ) {
			$covers = $covers || $this->location_covers_location( $location, $zone_location );
		}

		return $covers;
	}

	/**
	 * @param \stdClass $location .
	 * @param \stdClass $zone_location .
	 *
	 * @return bool
	 */
	private function location_covers_location( \stdClass $location, \stdClass $zone_location ) {
		$zone_continent = '';
		$zone_country   = '';
		$zone_state     = '';
		if ( 'continent' === $zone_location->type ) {
			$zone_continent = $zone_location->code;
		}
		if ( 'country' === $zone_location->type ) {
			$zone_country   = $zone_location->code;
			$zone_continent = $this->get_continent_code_for_country( $zone_country );
		}
		if ( 'state' === $zone_location->type ) {
			$country_state          = $zone_location->code;
			$country_state_exploded = explode( ':', $country_state );
			$zone_country           = $country_state_exploded[0];
			$zone_state             = $country_state_exploded[1];
			$zone_continent         = $this->get_continent_code_for_country( $zone_country );
		}
		if ( 'continent' === $location->type && $location->code === $zone_continent ) {
			return true;
		}
		if ( 'country' === $location->type && $location->code === $zone_country ) {
			return true;
		}
		if ( 'state' === $location->type && $location->code === $zone_state ) {
			return true;
		}
	}

	/**
	 * @param string $country_code .
	 *
	 * @return string
	 *
	 * @codeCoverageIgnore
	 */
	protected function get_continent_code_for_country( $country_code ) {
		return $this->countries->get_continent_code_for_country( $country_code );
	}

}
MultipleShippingZonesMatchedSameTerritoryTracker.php                                                                                                                                                                                                           1462          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Debug                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class MultipleShippingZonesMatchedSameTerritoryTracker
 *
 * @package WPDesk\FS\TableRate\Debug
 */

namespace WPDesk\FS\TableRate\Debug;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can append multiple shipping zones matched data to tracker.
 */
class MultipleShippingZonesMatchedSameTerritoryTracker implements Hookable {

	const OPTION_NAME                              = 'fs-multiple-zones-matched-notice-count';
	const TRACKER_DATA_NAME                        = 'multiple_zones_matched_notice_count';
	const PRIORITY_AFTER_FLEXIBLE_SHIPPING_TRACKER = \WPDesk_Flexible_Shipping_Tracker::TRACKER_DATA_FILTER_PRIORITY + 1;

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'flexible-shipping/notice/multiple-zone-matches-same-territory', array( $this, 'update_counter_option' ) );
		add_filter( 'wpdesk_tracker_data', array( $this, 'append_tracker_data' ), self::PRIORITY_AFTER_FLEXIBLE_SHIPPING_TRACKER );
	}

	/**
	 * @return bool
	 */
	public function update_counter_option() {
		return update_option( self::OPTION_NAME, (int) get_option( self::OPTION_NAME, 0 ) + 1 );
	}

	/**
	 * @param array $data .
	 *
	 * @return array
	 */
	public function append_tracker_data( $data ) {
		if ( is_array( $data ) && isset( $data['flexible_shipping'] ) && is_array( $data['flexible_shipping'] ) ) {
			$data['flexible_shipping'][ self::TRACKER_DATA_NAME ] = (int) get_option( self::OPTION_NAME, 0 );
		}

		return $data;
	}

}
NoShippingMethodsNotice.php                                                                                                                                                                                                                                    3366          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Debug                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class NoShippingMethodNotice
 *
 * @package WPDesk\FS\TableRate\Debug
 */

namespace WPDesk\FS\TableRate\Debug;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\TableRate\ShippingMethodSingle;

/**
 * Can display notice when no shipping methods are defined in shipping zone.
 */
class NoShippingMethodsNotice implements Hookable {

	/**
	 * @var bool
	 */
	private $debug_mode_enabled;

	/**
	 * NoShippingMethodsNotice constructor.
	 *
	 * @param bool $debug_mode_enabled .
	 */
	public function __construct( $debug_mode_enabled ) {
		$this->debug_mode_enabled = $debug_mode_enabled;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'woocommerce_load_shipping_methods', array( $this, 'display_notice_if_needed_for_package' ) );
	}

	/**
	 * .
	 *
	 * @param array $package .
	 */
	public function display_notice_if_needed_for_package( $package ) {
		if ( ! empty( $package ) && $this->debug_mode_enabled ) {
			$shipping_zone    = \WC_Shipping_Zones::get_zone_matching_package( $package );
			$shipping_methods = $shipping_zone->get_shipping_methods( true );
			if ( ! $this->zone_has_flexible_shipping( $shipping_methods ) ) {
				$this->add_notice(
					$shipping_zone->get_zone_name(),
					admin_url( 'admin.php?page=wc-settings&tab=shipping&zone_id=' . $shipping_zone->get_id() )
				);
			} elseif ( $this->are_not_flexible_shipping_methods_defined( $shipping_methods ) ) {
				$this->add_notice(
					$shipping_zone->get_zone_name(),
					admin_url( 'admin.php?page=wc-settings&tab=shipping&instance_id=' . $this->get_flexible_shipping_instance_id( $shipping_methods ) )
				);
			}
		}
	}

	/**
	 * .
	 *
	 * @param string $zone_name .
	 * @param string $link_url .
	 */
	private function add_notice( $zone_name, $link_url ) {
		wc_add_notice(
			sprintf(
				// Translators: shipping zone name and shipping method settings url.
				__( 'No shipping method handled by Flexible Shipping found in the %1$s shipping zone. %2$sAdd shipping method →%3$s', 'flexible-shipping' ),
				$zone_name,
				'<a target="_blank" href="' . $link_url . '">',
				'</a>'
			),
			'notice'
		);
	}

	/**
	 * @param array $shipping_methods .
	 *
	 * @return bool
	 */
	private function zone_has_flexible_shipping( $shipping_methods ) {
		foreach ( $shipping_methods as $shipping_method ) {
			if ( $shipping_method instanceof \WPDesk_Flexible_Shipping || ( class_exists( 'WPDesk\FS\TableRate\ShippingMethodSingle' ) && $shipping_method instanceof ShippingMethodSingle ) ) {
				return true;
			}
		}

		return false;
	}

	/**
	 * @param array $shipping_methods .
	 *
	 * @return bool
	 */
	private function are_not_flexible_shipping_methods_defined( $shipping_methods ) {
		foreach ( $shipping_methods as $shipping_method ) {
			if ( $shipping_method instanceof \WPDesk_Flexible_Shipping ) {
				$flexible_shipping_methods = $shipping_method->get_shipping_methods();
				if ( 0 === count( $shipping_method->get_shipping_methods() ) ) {
					return true;
				}
			}
		}

		return false;
	}

	/**
	 * @param array $shipping_methods .
	 *
	 * @return int
	 */
	private function get_flexible_shipping_instance_id( $shipping_methods ) {
		foreach ( $shipping_methods as $shipping_method ) {
			if ( $shipping_method instanceof \WPDesk_Flexible_Shipping ) {
				return $shipping_method->get_instance_id();
			}
		}

		return 0;
	}

}
DefaultRulesSettings.php                                                                                                                                                                                                                                       727           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php
/**
 * Class DefaultRulesSettings
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate;

use WPDesk\FS\TableRate\Rule\Condition\None;

/**
 * Can provide default settings for rules.
 */
class DefaultRulesSettings {
	const NEW_FIELD = 'new';

	/**
	 * @return array
	 */
	public function get_normalized_settings(): array {
		return apply_filters( 'flexible-shipping/shipping-method/default-rules-settings', $this->get_default_settings() );
	}

	/**
	 * @return array
	 */
	private function get_default_settings(): array {
		return [
			[
				'conditions'     => [
					[
						'condition_id' => None::CONDITION_ID,
					],
				],
				'cost_per_order' => '0',
				self::NEW_FIELD  => true,
			],
		];
	}
}
ConditionInvalidNumberValue.php                                                                                                                                                                                                                                135           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\TableRate\Exception;

use RuntimeException;

class ConditionInvalidNumberValue extends RuntimeException {

}ConditionNotDefined.php                                                                                                                                                                                                                                        127           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\TableRate\Exception;

use RuntimeException;

class ConditionNotDefined extends RuntimeException {

}ConditionRequiredField.php                                                                                                                                                                                                                                     130           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\TableRate\Exception;

use RuntimeException;

class ConditionRequiredField extends RuntimeException {

}RuleRequired.php                                                                                                                                                                                                                                               120           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php

namespace WPDesk\FS\TableRate\Exception;

use RuntimeException;

class RuleRequired extends RuntimeException {

}Assets.php                                                                                                                                                                                                                                                     1072          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\Blocks\FreeShipping\FreeShippingBlock;

/**
 * Can enqueue assets.
 */
class Assets implements Hookable {

	/**
	 * @var string
	 */
	private $assets_url;

	/**
	 * @var string
	 */
	private $scripts_version;

	/**
	 * @param string $assets_url
	 * @param        $scripts_version
	 */
	public function __construct( string $assets_url, $scripts_version ) {
		$this->assets_url      = $assets_url;
		$this->scripts_version = $scripts_version;
	}

	public function hooks() {
		add_action( 'wp_enqueue_scripts', [ $this, 'enqueue_scripts' ] );
	}

	public function enqueue_scripts() {
		if ( apply_filters( 'flexible-shipping/free-shipping/enqueue_css', is_page() || is_checkout() || is_cart() || is_product() || is_shop() || has_block( FreeShippingBlock::BLOCK_NAME ) ) ) {
			wp_enqueue_style(
				'flexible-shipping-free-shipping',
				trailingslashit( $this->assets_url ) . 'dist/css/free-shipping.css',
				[],
				$this->scripts_version
			);
		}
	}

}
FreeShippingNotice.php                                                                                                                                                                                                                                         5962          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Free Shipping Notice.
 *
 * @package WPDesk\FS\TableRate\FreeShipping
 */

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Cart;
use WC_Session;
use WPDesk\FS\Blocks\FreeShipping\FreeShippingBlock;

/**
 * Can display free shipping notice.
 */
class FreeShippingNotice implements Hookable {

	const FLEXIBLE_SHIPPING_FREE_SHIPPING_NOTICE = 'flexible_shipping_free_shipping_notice';
	const NOTICE_TYPE                            = 'notice';
	const NOTICE_CONTAINER_CLASS                 = 'flexible-shipping-notice-container';

	/**
	 * @var WC_Cart
	 */
	private $cart;

	/**
	 * @var WC_Session
	 */
	private $session;

	/**
	 * @var string
	 */
	private $session_variable_name;

	/**
	 * FreeShippingNotice constructor.
	 *
	 * @param WC_Cart    $cart    .
	 * @param WC_Session $session .
	 */
	public function __construct( WC_Cart $cart, WC_Session $session, string $session_variable_name ) {
		$this->cart                  = $cart;
		$this->session               = $session;
		$this->session_variable_name = $session_variable_name;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'woocommerce_after_calculate_totals', [ $this, 'add_notice_if_should' ] );
		add_action( 'wp_head', [ $this, 'add_notice_if_should_via_wp_head' ] );
	}

	public function add_notice_if_should_via_wp_head() {
		remove_action( 'woocommerce_after_calculate_totals', [ $this, 'add_notice_if_should' ] );
		$this->add_notice_if_should();
	}

	/**
	 * @return void
	 */
	public function add_checkout_notice_container() {
		echo wp_kses_post( $this->get_left_free_shipping_notice_container() );
	}

	public function add_notice_if_should(): void {
		if ( ! $this->cart->needs_shipping() ) {
			return;
		}

		$notice = '';
		$free_shipping_notice_data = $this->get_free_shipping_notice_data();
		if ( $free_shipping_notice_data instanceof FreeShippingNoticeData ) {
			$notice_message = $this->get_notice_message( $free_shipping_notice_data );
			if ( $notice_message ) {
				ob_start();
				$this->print_notice( $notice_message );
				$notice = ob_get_clean();
			}
			if ( ! is_string( $notice ) ) {
				$notice = '';
			}
		}
		if ( $notice && $this->should_add_notice_on_current_page( $free_shipping_notice_data ) && ! wc_has_notice( $notice_message, self::NOTICE_TYPE ) ) {
			wc_add_notice( $notice_message, self::NOTICE_TYPE );
		}
	}

	private function should_add_notice_on_current_page( FreeShippingNoticeData $free_shipping_notice_data ): bool {
		if ( is_ajax() ) {
			return false;
		}
		if (
			( ! is_checkout() && ! is_cart() && has_block( FreeShippingBlock::BLOCK_NAME ) )
			|| has_block( 'woocommerce/checkout' )
			|| has_block( 'woocommerce/cart' )
		) {
			return false;
		}

		return apply_filters( 'flexible-shipping/free-shipping/show-notice', is_checkout() || is_cart(), $free_shipping_notice_data );
	}

	/**
	 * @param array $fragments .
	 *
	 * @return array
	 */
	public function add_checkout_notice_to_fragments( $fragments ): array {
		$notice = '';
		if ( $this->cart->needs_shipping() ) {
			$free_shipping_notice_data = $this->get_free_shipping_notice_data();
			if ( $free_shipping_notice_data instanceof FreeShippingNoticeData ) {
				$notice_message = $this->get_notice_message( $free_shipping_notice_data );
				if ( $notice_message ) {
					ob_start();
					$this->print_notice( $notice_message );
					$notice = ob_get_clean();
				}
				if ( ! is_string( $notice ) ) {
					$notice = '';
				}
			}
		}

		$fragments[ $this->get_fragments_id() ] = ( $fragments[ '.' . self::NOTICE_CONTAINER_CLASS ] ?? '' ) . $this->get_left_free_shipping_notice_container( $notice );

		return $fragments;
	}

	/**
	 * @return FreeShippingNoticeData|null
	 */
	private function get_free_shipping_notice_data() {
		$session_data = $this->session->get( $this->session_variable_name, '' );
		if ( $session_data instanceof FreeShippingNoticeData ) {
			return $session_data;
		}
		if ( ! is_array( $session_data ) ) {
			return null;
		}

		return FreeShippingNoticeData::create_from_array( $session_data );
	}

	/**
	 * @param string $notice_message
	 *
	 * @return void
	 */
	private function print_notice( string $notice_message ) {
		if ( function_exists( 'wc_print_notice' ) ) {
			wc_print_notice( $notice_message, self::NOTICE_TYPE, [ self::FLEXIBLE_SHIPPING_FREE_SHIPPING_NOTICE => 'yes' ] );
		} else {
			echo wp_kses_post( $notice_message );
		}
	}

	/**
	 * @param string $content .
	 *
	 * @return string
	 */
	private function get_left_free_shipping_notice_container( $content = '' ): string {
		return sprintf( '<div class="%s">%s</div>', $this->get_container_class(), $content );
	}

	private function get_container_class(): string {
		return self::NOTICE_CONTAINER_CLASS . ' ' . $this->session_variable_name;
	}

	private function get_fragments_id(): string {
		return 'div.' . str_replace( ' ', '.', $this->get_container_class() );
	}

	/**
	 * @return string
	 */
	private function get_notice_message( FreeShippingNoticeData $free_shipping_notice_data ): string {
		$amount = $free_shipping_notice_data->get_missing_amount();

		if ( $amount === 0.0 ) {
			return '';
		}

		return $this->prepare_notice_text( $free_shipping_notice_data );
	}

	/**
	 * @param FreeShippingNoticeData $free_shipping_notice_data .
	 *
	 * @return string
	 */
	private function prepare_notice_text( FreeShippingNoticeData $free_shipping_notice_data ): string {
		$notice_text = apply_filters( 'flexible-shipping/free-shipping/render-notice', $free_shipping_notice_data );

		/**
		 * Notice text for Free Shipping.
		 *
		 * @param string $notice_text Notice text.
		 * @param float  $amount      Amount left to free shipping.
		 *
		 * @return string Message text.
		 */
		$notice_text = apply_filters( 'flexible_shipping_free_shipping_notice_text', $notice_text, $free_shipping_notice_data->get_missing_amount() );

		return is_string( $notice_text ) ? $notice_text : '';
	}

}
FreeShippingNoticeData.php                                                                                                                                                                                                                                     4859          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

/**
 * Can provide free shipping data.
 */
class FreeShippingNoticeData implements \JsonSerializable {

	const SHOW_PROGRESS_BAR       = 'show_progress_bar';
	const PERCENTAGE              = 'percentage';
	const THRESHOLD               = 'threshold';
	const THRESHOLD_DISPLAY_VALUE = 'threshold_display_value';
	const ZERO_DISPLAY_VALUE      = 'zero_display_value';
	const MISSING_AMOUNT          = 'missing_amount';
	const NOTICE_TEXT             = 'notice_text';
	const BUTTON_URL              = 'button_url';
	const BUTTON_LABEL            = 'button_label';
	const META_DATA               = 'meta_data';

	/**
	 * @var bool
	 */
	private $show_progress_bar;

	/**
	 * @var float
	 */
	private $percentage;

	/**
	 * @var float
	 */
	private $threshold;

	/**
	 * @var string
	 */
	private $threshold_display_value;

	/**
	 * @var string
	 */
	private $zero_display_value;

	/**
	 * @var float
	 */
	private $missing_amount;

	/**
	 * @var string
	 */
	private $notice_text;

	/**
	 * @var string
	 */
	private $button_url;

	/**
	 * @var string
	 */
	private $button_label;

	/**
	 * @var array
	 */
	private $meta_data;

	/**
	 * @param bool   $show_progress_bar
	 * @param float  $percentage
	 * @param float  $threshold
	 * @param string $threshold_display_value
	 * @param string $zero_display_value
	 * @param float  $missing_amount
	 * @param string $notice_text
	 * @param string $button_url
	 * @param string $button_label
	 * @param array  $meta_data
	 */
	public function __construct(
		bool $show_progress_bar = false,
		float $percentage = 0.0,
		float $threshold = 0.0,
		string $threshold_display_value = '',
		string $zero_display_value = '',
		float $missing_amount = 0.0,
		string $notice_text = '',
		string $button_url = '',
		string $button_label = '',
		array $meta_data = []
	) {
		$this->show_progress_bar       = $show_progress_bar;
		$this->percentage              = $percentage;
		$this->threshold               = $threshold;
		$this->threshold_display_value = $threshold_display_value;
		$this->zero_display_value      = $zero_display_value;
		$this->missing_amount          = $missing_amount;
		$this->notice_text             = $notice_text;
		$this->button_url              = $button_url;
		$this->button_label            = $button_label;
		$this->meta_data               = $meta_data;
	}

	/**
	 * @return bool
	 */
	public function is_show_progress_bar(): bool {
		return $this->show_progress_bar;
	}

	/**
	 * @return float
	 */
	public function get_percentage(): float {
		return $this->percentage;
	}

	/**
	 * @return float
	 */
	public function get_threshold(): float {
		return $this->threshold;
	}

	/**
	 * @return float
	 */
	public function get_missing_amount(): float {
		return $this->missing_amount;
	}

	/**
	 * @return string
	 */
	public function get_notice_text(): string {
		return $this->notice_text;
	}

	/**
	 * @return string
	 */
	public function get_threshold_display_value(): string {
		return $this->threshold_display_value;
	}

	/**
	 * @return string
	 */
	public function get_zero_display_value(): string {
		return $this->zero_display_value;
	}

	/**
	 * @return string
	 */
	public function get_button_url(): string {
		return $this->button_url;
	}

	/**
	 * @return string
	 */
	public function get_button_label(): string {
		return $this->button_label;
	}

	/**
	 * @return array
	 */
	public function get_meta_data(): array {
		return $this->meta_data;
	}


	#[\ReturnTypeWillChange]
	public function jsonSerialize(): array {
		return [
			self::SHOW_PROGRESS_BAR       => $this->is_show_progress_bar(),
			self::PERCENTAGE              => $this->get_percentage(),
			self::THRESHOLD               => $this->get_threshold(),
			self::THRESHOLD_DISPLAY_VALUE => $this->get_threshold_display_value(),
			self::ZERO_DISPLAY_VALUE      => $this->get_zero_display_value(),
			self::MISSING_AMOUNT          => $this->get_missing_amount(),
			self::NOTICE_TEXT             => $this->get_notice_text(),
			self::BUTTON_URL              => $this->get_button_url(),
			self::BUTTON_LABEL            => $this->get_button_label(),
			self::META_DATA               => $this->get_meta_data(),
		];
	}

	/**
	 * Static factory. Creates notice data from array.
	 *
	 * @param array $data
	 *
	 * @return self
	 */
	public static function create_from_array( array $data ): self {
		return new self(
			$data[ self::SHOW_PROGRESS_BAR ] ?? false,
			$data[ self::PERCENTAGE ] ?? 0.0,
			$data[ self::THRESHOLD ] ?? 0.0,
			$data[ self::THRESHOLD_DISPLAY_VALUE ] ?? '',
			$data[ self::ZERO_DISPLAY_VALUE ] ?? '',
			$data[ self::MISSING_AMOUNT ] ?? '0.0',
			$data[ self::NOTICE_TEXT ] ?? '',
			$data[ self::BUTTON_URL ] ?? '',
			$data[ self::BUTTON_LABEL ] ?? '',
			is_array( $data[ self::META_DATA ] ?? null ) ? $data[ self::META_DATA ] : []
		);
	}

}
FreeShippingNoticeGenerator.php                                                                                                                                                                                                                                9892          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 * Free Shipping Notice Generator.
 *
 * @package WPDesk\FS\TableRate\FreeShipping
 */

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Cart;
use WC_Session;
use WC_Shipping_Rate;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Can generate free shipping notice and save it on session.
 */
class FreeShippingNoticeGenerator implements Hookable {

	const SETTING_METHOD_FREE_SHIPPING = 'method_free_shipping';
	const META_DATA_FS_METHOD = '_fs_method';
	const PRIORITY = 10;

	/**
	 * @var WC_Cart|null
	 */
	protected $cart;

	/**
	 * @var WC_Session|null
	 */
	private $session;

	/**
	 * @var string
	 */
	private $session_variable_name;

	/**
	 * FreeShippingNotice constructor.
	 *
	 * @param WC_Cart|null    $cart    .
	 * @param WC_Session|null $session .
	 * @param string          $session_variable_name .
	 */
	public function __construct( $cart, $session, string $session_variable_name ) {
		$this->cart                  = $cart;
		$this->session               = $session;
		$this->session_variable_name = $session_variable_name;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'woocommerce_package_rates', [ $this, 'add_free_shipping_notice_if_should' ], self::PRIORITY );
		add_action( 'woocommerce_after_calculate_totals', [ $this, 'clear_notices_if_cart_not_needs_shipping' ], self::PRIORITY );
	}

	/**
	 * @param WC_Cart $cart
	 *
	 * @return void
	 */
	public function clear_notices_if_cart_not_needs_shipping( $cart ) {
		if ( ! $cart->needs_shipping() ) {
			$this->get_session()->set( $this->session_variable_name, null );
		}
	}

	/**
	 * Triggered by filter. Must return $package_rates.
	 *
	 * @param array $package_rates .
	 * @param array $package       .
	 *
	 * @return array
	 */
	public function add_free_shipping_notice_if_should( $package_rates ) {
		$this->cart = WC()->cart;
		if ( $this->cart->needs_shipping() && $this->has_shipping_rate_with_free_shipping( $package_rates ) && ! $this->has_free_shipping_rate( $package_rates ) && $this->get_shipping_packages_count() === 1 ) {
			$this->add_free_shipping_amount_to_session( $package_rates );
		} else {
			$this->get_session()->set( $this->session_variable_name, null );
		}

		return $package_rates;
	}

	protected function get_session() {
		return WC()->session;
	}

	/**
	 * @return int
	 */
	private function get_shipping_packages_count() {
		return count( $this->cart->get_shipping_packages() );
	}

	/**
	 * Add free shipping notice.
	 *
	 * @param array $package_rates .
	 */
	private function add_free_shipping_amount_to_session( $package_rates ) {
		$shipping_method_with_lowest_free_shipping_limit = $this->get_shipping_method_with_lowest_free_shipping_limit( $package_rates );
		$lowest_free_shipping_limit                      = floatval( $shipping_method_with_lowest_free_shipping_limit[ self::SETTING_METHOD_FREE_SHIPPING ] );
		$lowest_free_shipping_limit                      = round(
			(float) apply_filters( 'flexible_shipping_value_in_currency', $lowest_free_shipping_limit, $lowest_free_shipping_limit ),
			wc_get_rounding_precision()
		);
		$amount                                          = $lowest_free_shipping_limit - $this->get_cart_value();
		$free_shipping_notice_text                       = $shipping_method_with_lowest_free_shipping_limit[ NoticeTextSettings::FIELD_NAME ] ?? '';
		$meta_data                                       = apply_filters( 'flexible-shipping/free-shipping/metadata', [ 'method_settings' => $shipping_method_with_lowest_free_shipping_limit ], $shipping_method_with_lowest_free_shipping_limit );

		$free_shipping_notice_data = $this->prepare_free_shipping_notice_data(
			( $shipping_method_with_lowest_free_shipping_limit[ ProgressBarSettings::FIELD_NAME ] ?? 'no' ) === 'yes',
			round( $this->get_cart_value() / $lowest_free_shipping_limit * 100 ),
			$lowest_free_shipping_limit,
			$amount,
			$free_shipping_notice_text,
			$this->get_notice_text_button_url(),
			$this->get_notice_text_button_label(),
			$meta_data
		);

		$this->get_session()->set( $this->session_variable_name, $free_shipping_notice_data->jsonSerialize() );
	}

	/**
	 * @param bool   $show_progress_bar
	 * @param float  $percentage
	 * @param float  $lowest_free_shipping_limit
	 * @param float  $amount
	 * @param string $free_shipping_notice_text
	 * @param string $button_url
	 * @param string $button_label
	 * @param array  $meta_data
	 *
	 * @return FreeShippingNoticeData
	 */
	protected function prepare_free_shipping_notice_data(
		bool $show_progress_bar,
		float $percentage,
		float $lowest_free_shipping_limit,
		float $amount,
		string $free_shipping_notice_text,
		string $button_url,
		string $button_label,
		array $meta_data
	): FreeShippingNoticeData {
		return new FreeShippingNoticeData(
			$show_progress_bar,
			$percentage,
			$lowest_free_shipping_limit,
			wc_price( $lowest_free_shipping_limit ),
			wc_price( 0 ),
			$amount,
			$this->get_notice_text_message( wc_price( $amount ), $free_shipping_notice_text ),
			$button_url,
			$button_label,
			$meta_data
		);
	}

	/**
	 * @return string
	 */
	protected function get_notice_text_message( string $amount, string $message ): string {
		// Translators: amount with currency or number of items.
		$message = sprintf(
			empty( $message ) ? __( 'You only need %1$s more to get free shipping!', 'flexible-shipping' ) : wpdesk__( $message, 'flexible-shipping' ),
			$amount
		);

		$text_message = apply_filters( 'flexible_shipping_free_shipping_notice_text_message', $message, $amount );

		return is_string( $text_message ) ? $text_message : '';
	}

	/**
	 * @return string
	 */
	private function get_notice_text_button_url(): string {
		return apply_filters( 'woocommerce_return_to_shop_redirect', wc_get_page_permalink( 'shop' ) );
	}

	/**
	 * @return string
	 */
	private function get_notice_text_button_label(): string {
		return apply_filters( 'flexible_shipping_free_shipping_notice_text_button_label', __( 'Continue shopping', 'flexible-shipping' ) );
	}

	/**
	 * Has package free shipping rate?
	 *
	 * @param array $package_rates .
	 *
	 * @return bool
	 */
	private function has_free_shipping_rate( $package_rates ): bool {
		/** @var WC_Shipping_Rate $package_rate */
		foreach ( $package_rates as $package_rate ) {
			if ( floatval( $package_rate->get_cost() ) === 0.0 && ! $this->is_excluded_shipping_method( $package_rate->get_method_id() ) ) {
				return true;
			}
		}

		return false;
	}

	/**
	 * Is shipping method excluded from free shipping?
	 *
	 * @param string $method_id .
	 *
	 * @return bool
	 */
	private function is_excluded_shipping_method( $method_id ): bool {
		/**
		 * Exclude methods from free shipping.
		 *
		 * @param array $excluded_methods
		 *
		 * @return array
		 */
		$excluded_methods = apply_filters( 'flexible_shipping_free_shipping_notice_excluded_methods', [ 'local_pickup' ] );

		$excluded_methods = is_array( $excluded_methods ) ? $excluded_methods : [];

		return in_array( $method_id, $excluded_methods, true );
	}

	/**
	 * Has package rate with free shipping?
	 *
	 * @param array $package_rates .
	 *
	 * @return bool
	 */
	private function has_shipping_rate_with_free_shipping( $package_rates ) {
		/** @var WC_Shipping_Rate $package_rate */
		foreach ( $package_rates as $package_rate ) {
			if ( $this->is_package_rate_from_flexible_shipping( $package_rate ) ) {
				$meta_data = $package_rate->get_meta_data();
				if ( isset( $meta_data[ self::META_DATA_FS_METHOD ] ) ) {
					if ( $this->has_shipping_method_free_shipping_notice_enabled( $meta_data[ self::META_DATA_FS_METHOD ] ) ) {
						return true;
					}
				}
			}
		}

		return false;
	}

	/**
	 * @param array $fs_method .
	 *
	 * @return bool
	 */
	protected function has_shipping_method_free_shipping_notice_enabled( array $fs_method ): bool {
		return ! empty( $fs_method[ self::SETTING_METHOD_FREE_SHIPPING ] )
			&& isset( $fs_method[ WPDesk_Flexible_Shipping::SETTING_METHOD_FREE_SHIPPING_NOTICE ] )
			&& 'yes' === $fs_method[ WPDesk_Flexible_Shipping::SETTING_METHOD_FREE_SHIPPING_NOTICE ]
			&& apply_filters( 'flexible-shipping/shipping-method/free-shipping-notice-allowed', true, $fs_method );
	}

	/**
	 * Returns current cart value.
	 *
	 * @return float
	 */
	protected function get_cart_value(): float {
		return $this->cart->display_prices_including_tax() ? $this->cart->get_cart_contents_total() + $this->cart->get_cart_contents_tax() : $this->cart->get_cart_contents_total();
	}

	/**
	 * @param $package_rates
	 *
	 * @return array
	 */
	protected function get_shipping_method_with_lowest_free_shipping_limit( $package_rates ): array {
		$lowest_free_shipping_limit = null;
		$shipping_method = [];
		/** @var WC_Shipping_Rate $package_rate */
		foreach ( $package_rates as $package_rate ) {
			if ( $this->is_package_rate_from_flexible_shipping( $package_rate ) ) {
				$meta_data = $package_rate->get_meta_data();
				$fs_method = $meta_data[ self::META_DATA_FS_METHOD ] ?? [];
				if ( $this->has_shipping_method_free_shipping_notice_enabled( $fs_method ) ) {
					$method_free_shipping_limit = round( floatval( $fs_method[ self::SETTING_METHOD_FREE_SHIPPING ] ), wc_get_rounding_precision() );
					if ( $lowest_free_shipping_limit === null || $method_free_shipping_limit < $lowest_free_shipping_limit ) {
						$lowest_free_shipping_limit = $method_free_shipping_limit;
						$shipping_method = $fs_method;
					}
				}
			}
		}

		return $shipping_method;
	}

	/**
	 * @param WC_Shipping_Rate $package_rate .
	 *
	 * @return bool
	 */
	protected function is_package_rate_from_flexible_shipping( WC_Shipping_Rate $package_rate ): bool {
		$shipping_methods = [ WPDesk_Flexible_Shipping::METHOD_ID, ShippingMethodSingle::SHIPPING_METHOD_ID ];

		return in_array( $package_rate->get_method_id(), $shipping_methods, true );
	}
}
FreeShippingNoticeRenderer.php                                                                                                                                                                                                                                 1944          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use FSVendor\WPDesk\View\Renderer\Renderer;
use FSVendor\WPDesk\View\Renderer\SimplePhpRenderer;

/**
 * Can render free shipping notice.
 */
class FreeShippingNoticeRenderer implements Hookable {

	/**
	 * @var SimplePhpRenderer
	 */
	private $renderer;

	/**
	 * @param Renderer $renderer
	 */
	public function __construct( Renderer $renderer ) {
		$this->renderer = $renderer;
	}

	public function hooks() {
		add_filter( 'flexible-shipping/free-shipping/render-notice', [ $this, 'render_notice' ] );
	}

	/**
	 * @param FreeShippingNoticeData $free_shipping_notice_data
	 *
	 * @return string
	 */
	public function render_notice( $free_shipping_notice_data ): string {
		if ( ! $free_shipping_notice_data instanceof FreeShippingNoticeData ) {
			return '';
		}

		$notice_text = $this->renderer->render(
			'free-shipping/notice',
			[
				'notice_text'             => $free_shipping_notice_data->get_notice_text(),
				'zero_value'              => $free_shipping_notice_data->get_zero_display_value(),
				'show_progress_bar'       => $free_shipping_notice_data->is_show_progress_bar(),
				'percentage'              => $free_shipping_notice_data->get_percentage(),
				'free_shipping_threshold' => $free_shipping_notice_data->get_threshold_display_value(),
				'button_url'              => $free_shipping_notice_data->get_button_url(),
				'button_label'            => $free_shipping_notice_data->get_button_label(),
			]
		);

		/**
		 * Notice text for Free Shipping.
		 *
		 * @param string $notice_text Notice text.
		 * @param float  $amount      Amount left to free shipping.
		 *
		 * @return string Message text.
		 */
		$notice_text = apply_filters( 'flexible_shipping_free_shipping_notice_text', $notice_text, $free_shipping_notice_data->get_missing_amount() );

		return is_string( $notice_text ) ? $notice_text : '';
	}

}
NoticeTextSettings.php                                                                                                                                                                                                                                         1834          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can add settings field.
 */
class NoticeTextSettings implements Hookable {

	const FIELD_NAME = 'method_free_shipping_notice_text';

	public function hooks() {
		add_filter( 'flexible-shipping/settings/common-method-settings', [ $this, 'add_field_to_settings' ] );
	}

	/**
	 * @param array $settings
	 *
	 * @return array
	 */
	public function add_field_to_settings( $settings ) {
		if ( ! is_array( $settings ) ) {
			return $settings;
		}

		$new_settings = [];
		foreach ( $settings as $field_name => $field ) {
			$new_settings[ $field_name ] = $field;
			if ( $field_name === \WPDesk_Flexible_Shipping::SETTING_METHOD_FREE_SHIPPING_NOTICE ) {
				$new_settings[ self::FIELD_NAME ] = $this->get_settings_field();
			}
		}

		return $new_settings;
	}

	private function get_settings_field() {
		return [
			'title'       => __( 'LFFS notice text', 'flexible-shipping' ),
			'type'        => 'textarea',
			// Translators: amount with currency.
			'placeholder' => __( 'You only need %1$s more to get free shipping!', 'flexible-shipping' ),
			'label'       => __( 'Display the notice with the amount left for free shipping', 'flexible-shipping' ),
			'desc_tip'    => sprintf(
			// Translators: bold.
				__( 'Enter your own custom text to be used for \'Left for free shipping\' notice in your shop. Please mind that inserting the %1$s%%1$s%2$s placeholder in the notice content is required to display the numeric value of the amount left for free shipping.', 'flexible-shipping' ),
				'<b>',
				'</b>'
			),
			// Translators: bold.
			'description' => sprintf( __( 'The %1$s%%1$s%2$s placeholder displays the numeric value of the amount left for free shipping.', 'flexible-shipping' ), '<b>', '</b>' ),
		];
	}

}
ProgressBarSettings.php                                                                                                                                                                                                                                        1322          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can add settings field.
 */
class ProgressBarSettings implements Hookable {

	const FIELD_NAME = 'method_free_shipping_progress_bar';

	public function hooks() {
		add_filter( 'flexible-shipping/settings/common-method-settings', [ $this, 'add_field_to_settings' ] );
	}

	/**
	 * @param array $settings
	 *
	 * @return array
	 */
	public function add_field_to_settings( $settings ) {
		if ( ! is_array( $settings ) ) {
			return $settings;
		}

		$new_settings = [];
		foreach ( $settings as $field_name => $field ) {
			$new_settings[ $field_name ] = $field;
			if ( $field_name === NoticeTextSettings::FIELD_NAME ) {
				$new_settings[ self::FIELD_NAME ] = $this->get_settings_field();
			}
		}

		return $new_settings;
	}

	private function get_settings_field() {
		return [
			'title'       => __( 'LFFS progress bar', 'flexible-shipping' ),
			'type'        => 'checkbox',
			'label'       => __( 'Display the \'Left for free shipping\' progress bar', 'flexible-shipping' ),
			'desc_tip'    => sprintf(
				__( 'Tick this checkbox to display an additional progress bar to your customers showing the amount left to qualify for free shipping.', 'flexible-shipping' ),
				'<b>',
				'</b>'
			),
		];
	}

}
Tracker.php                                                                                                                                                                                                                                                    1301          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/FreeShipping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php

namespace WPDesk\FS\TableRate\FreeShipping;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can append free shipping data to tracker.
 */
class Tracker implements Hookable {

	const PROGRESS_BAR_COUNT = 'method_free_shipping_progress_bar_count';
	const NOTICE_TEXT_COUNT = 'method_free_shipping_notice_text_count';

	public function hooks() {
		add_filter( 'flexible-shipping/tracker/method-settings', [ $this, 'append_free_shipping_data_to_tracker_data' ], 10, 2 );
	}

	public function append_free_shipping_data_to_tracker_data( $data, $shipping_method_settings ) {
		if ( ! is_array( $data ) || ! is_array( $shipping_method_settings ) ) {
			return $data;
		}

		if ( ! isset( $data[ self::PROGRESS_BAR_COUNT ] ) ) {
			$data[ self::PROGRESS_BAR_COUNT ] = 0;
		}
		if ( isset( $shipping_method_settings[ ProgressBarSettings::FIELD_NAME ] ) && $shipping_method_settings[ ProgressBarSettings::FIELD_NAME ] === 'yes' ) {
			$data[ self::PROGRESS_BAR_COUNT ]++;
		}

		if ( ! isset( $data[ self::NOTICE_TEXT_COUNT ] ) ) {
			$data[ self::NOTICE_TEXT_COUNT ] = 0;
		}
		if ( isset( $shipping_method_settings[ NoticeTextSettings::FIELD_NAME ] ) && $shipping_method_settings[ NoticeTextSettings::FIELD_NAME ] !== '' ) {
			$data[ self::NOTICE_TEXT_COUNT ]++;
		}

		return $data;
	}

}
JSON.php                                                                                                                                                                                                                                                       5017          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Exporter                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * JSON Exporter.
 *
 * @package WPDesk\FS\TableRate\Exporter
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Exporter;

use WPDesk\FS\TableRate\ImporterExporter\ShippingClassTrait;
use WPDesk_Flexible_Shipping;

/**
 * Class JSON
 */
class JSON {
	use ShippingClassTrait;

	/**
	 * @var string
	 */
	private $instance_id;

	/**
	 * @var int[]
	 */
	private $methods;

	/**
	 * JSON constructor.
	 *
	 * @param string $instance_id Instance ID.
	 * @param int[]  $methods     Method IDs.
	 */
	public function __construct( $instance_id, $methods ) {
		$this->instance_id = $instance_id;
		$this->methods     = $methods;

		$this->init_shipping_class();
	}

	/**
	 * @return array
	 */
	public function get_exported_data() {
		$all_shipping_methods = flexible_shipping_get_all_shipping_methods();

		/** @var WPDesk_Flexible_Shipping $flexible_shipping */
		$flexible_shipping       = $all_shipping_methods['flexible_shipping'];
		$flexible_shipping_rates = $flexible_shipping->get_all_rates();

		$this->filter_by_instance_id( $flexible_shipping_rates, $this->instance_id );
		$this->filter_by_methods( $flexible_shipping_rates, $this->methods );

		$flexible_shipping_rates = $this->get_prepared_shipping_rates( $flexible_shipping_rates );

		/**
		 * Filters whether shipping rates for export.
		 *
		 * @param array  $flexible_shipping_rates .
		 * @param string $instance_id             .
		 * @param array  $methods                 .
		 * @param JSON   $exporter                .
		 *
		 * @since 3.17.0
		 */
		$flexible_shipping_rates = apply_filters( 'flexible-shipping/exporter/data', $flexible_shipping_rates, $this->instance_id, $this->methods, $this );

		return array_values( $flexible_shipping_rates );
	}

	/**
	 * Preparing fields to export.
	 *
	 * @param array $flexible_shipping_rates .
	 *
	 * @return array
	 */
	private function get_prepared_shipping_rates( $flexible_shipping_rates ) {
		$allowed_fields = array(
			'id',
			'method_title',
			'method_description',
			'method_free_shipping_requires',
			'method_free_shipping',
			'method_free_shipping_ignore_discounts',
			'method_free_shipping_cart_notice',
			'method_max_cost',
			'method_calculation_method',
			'cart_calculation',
			'method_visibility',
			'method_default',
			'method_debug_mode',
			'method_integration',
			'method_rules',
		);

		/**
		 * Filters whether allowed fields for export.
		 *
		 * @param array $allowed_fields .
		 *
		 * @since 3.17.0
		 */
		$allowed_fields = apply_filters( 'flexible-shipping/exporter/allowed_fields', $allowed_fields );

		foreach ( $flexible_shipping_rates as $id => $flexible_shipping_rate ) {
			$row = array();

			foreach ( $allowed_fields as $field ) {
				$row[ $field ] = isset( $flexible_shipping_rate[ $field ] ) ? $flexible_shipping_rate[ $field ] : '';
			}

			if ( isset( $flexible_shipping_rate['method_free_shipping_label'] ) ) {
				$row['method_free_shipping_label'] = $flexible_shipping_rate['method_free_shipping_label'];
			}

			/**
			 * Filters whether fields for export.
			 *
			 * @param array  $row                    .
			 * @param array  $flexible_shipping_rate .
			 * @param string $id                     .
			 *
			 * @since 3.17.0
			 */
			$row = apply_filters( 'flexible-shipping/exporter/rate/data', $row, $flexible_shipping_rate, $id );

			$flexible_shipping_rates[ $id ] = $row;
		}

		return $flexible_shipping_rates;
	}

	/**
	 * @param array  $flexible_shipping_rates Shipping Rates.
	 * @param string $instance_id             Instance ID.
	 */
	private function filter_by_instance_id( &$flexible_shipping_rates, $instance_id ) {
		$flexible_shipping_rates = array_filter(
			$flexible_shipping_rates,
			function ( $shipping_rate ) use ( $instance_id ) {
				return isset( $shipping_rate['instance_id'] ) && (int) $shipping_rate['instance_id'] === (int) $instance_id;
			}
		);
	}

	/**
	 * @param array $flexible_shipping_rates Shipping Rates.
	 * @param int[] $methods                 Method IDs.
	 */
	private function filter_by_methods( &$flexible_shipping_rates, $methods ) {
		$flexible_shipping_rates = array_filter(
			$flexible_shipping_rates,
			function ( $shipping_rate ) use ( $methods ) {
				return in_array( (int) $shipping_rate['id'], wp_parse_id_list( $methods ), true );
			}
		);
	}

	/**
	 * @param string $filename Name of exported file.
	 * @param array  $data     Data to export.
	 */
	public function download_file( $filename, $data ) {
		header( 'Content-Type: application/json; charset=utf-8' );
		header( 'Content-Disposition: attachment; filename=' . sanitize_file_name( $filename ) );

		echo wp_json_encode( $data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE );
		die();
	}

	/**
	 * @param array $data .
	 *
	 * @return string
	 */
	public function get_filename( $data ) {
		$host = wp_parse_url( site_url(), PHP_URL_HOST );

		$filename = 'fs_' . $host . '_fs-' . $this->instance_id . '-' . join( '_', wp_list_pluck( $data, 'id' ) );

		return sanitize_file_name( $filename . '.json' );
	}
}
Exporter.php                                                                                                                                                                                                                                                   1058          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * Exporter.
 *
 * @package WPDesk\FS\TableRate\ImporterExporter
 */

namespace WPDesk\FS\TableRate\ImporterExporter;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\TableRate\ImporterExporter\Exporter\JSON;

/**
 * Class Hooks
 */
class Exporter implements Hookable {
	/**
	 * @return void|null
	 */
	public function hooks() {
		add_action( 'wp_ajax_flexible_shipping_export', array( $this, 'flexible_shipping_export' ) );
	}

	/**
	 * Preparing data to export.
	 */
	public function flexible_shipping_export() {
		check_ajax_referer( 'flexible_shipping', 'flexible_shipping_nonce' );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$instance_id = filter_input( INPUT_GET, 'instance_id' );
		$methods     = array_filter( wp_parse_id_list( filter_input( INPUT_GET, 'methods' ) ) );

		$exporter    = new JSON( sanitize_key( $instance_id ), $methods );
		$export_data = $exporter->get_exported_data();

		$exporter->download_file( $exporter->get_filename( $export_data ), $export_data );
	}
}
ExporterData.php                                                                                                                                                                                                                                               1600          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * ExporterData.
 *
 * @package WPDesk\FS\TableRate\ImporterExporter
 */

namespace WPDesk\FS\TableRate\ImporterExporter;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Class Hooks
 */
class ExporterData implements Hookable {
	/**
	 * @return void|null
	 */
	public function hooks() {
		add_filter( 'flexible-shipping/exporter/data', array( $this, 'prepare_export_data' ), 10, 4 );
	}

	/**
	 * @param array         $flexible_shipping_rates .
	 * @param string        $instance_id             .
	 * @param array         $methods                 .
	 * @param Exporter\JSON $exporter                .
	 *
	 * @return array
	 */
	public function prepare_export_data( $flexible_shipping_rates, $instance_id, $methods, $exporter ) {
		$shipping_classes = array_flip( $exporter->wc_shipping_classes_hashmap );

		foreach ( $flexible_shipping_rates as $id => $flexible_shipping_rate ) {
			foreach ( $flexible_shipping_rate['method_rules'] as $method_rule_id => $method_rule ) {
				foreach ( $method_rule['conditions'] as $condition_id => $condition ) {
					if ( 'shipping_class' !== $condition['condition_id'] ) {
						continue;
					}

					foreach ( $condition['shipping_class'] as $shipping_class_id => $shipping_class ) {

						if ( in_array( $shipping_class, array( 'all', 'any', 'none' ), true ) ) {
							continue;
						}

						$flexible_shipping_rates[ $id ]['method_rules'][ $method_rule_id ]['conditions'][ $condition_id ]['shipping_class'][ $shipping_class_id ] = $shipping_classes[ $shipping_class ];
					}
				}
			}
		}

		return $flexible_shipping_rates;
	}
}
AbstractImporter.php                                                                                                                                                                                                                                           1965          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Abstract Importer
 *
 * @package WPDesk\FS\TableRate\Importer
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer;

use WPDesk\FS\TableRate\ImporterExporter\ShippingClassTrait;
use WPDesk_Flexible_Shipping;

/**
 * Class AbstractImporter
 *
 * @package WPDesk\FS\TableRate\Importer
 */
abstract class AbstractImporter implements Importer {
	use ShippingClassTrait;

	/**
	 * @var array .
	 */
	protected $file;

	/**
	 * @var WPDesk_Flexible_Shipping .
	 */
	protected $flexible_shipping_method;

	/**
	 * @var array .
	 */
	protected $shipping_methods;

	/**
	 * WPDesk_Flexible_Shipping_Csv_Importer constructor.
	 *
	 * @param array                    $file                     .
	 * @param WPDesk_Flexible_Shipping $flexible_shipping_method Flexible shipping method.
	 * @param array                    $shipping_methods         .
	 */
	public function __construct( array $file, WPDesk_Flexible_Shipping $flexible_shipping_method, array $shipping_methods ) {
		$this->file                     = $file;
		$this->shipping_methods         = $shipping_methods;
		$this->flexible_shipping_method = $flexible_shipping_method;

		$this->init_shipping_class();
	}

	/**
	 * Process import data.
	 */
	abstract public function import();

	/**
	 * @return array
	 */
	public function get_shipping_methods() {
		return $this->shipping_methods;
	}

	/**
	 * @param string $method_title .
	 *
	 * @return string
	 */
	protected function get_new_method_title( $method_title ) {
		$count = 0;

		$new_method_title = $method_title;

		while ( $this->flexible_shipping_method->shipping_method_title_used( $new_method_title, $this->shipping_methods ) ) {
			if ( 0 === $count ) {
				$new_method_title = sprintf( '%s (%s)', $method_title, __( 'import', 'flexible-shipping' ) );
			} else {
				$new_method_title = sprintf( '%s (%s %d)', $method_title, __( 'import', 'flexible-shipping' ), $count );
			}

			$count ++;
		}

		return $new_method_title;
	}
}
CSV.php                                                                                                                                                                                                                                                        10263         1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Import shipping methods and rules from CSV.
 *
 * @package WPDesk\FS\TableRate\Importer
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer;

use WC_Admin_Settings;
use WPDesk\FS\TableRate\ImporterExporter\Importer\Exception\ImportCSVException;
use WPDesk\FS\TableRate\Rule\Condition\ConditionsFactory;
use WPDesk_Flexible_Shipping;

/**
 * Class CSV
 *
 * @package WPDesk\FS\TableRate\Importer
 */
class CSV extends AbstractImporter {
	const CSV_DELIMITER = ';';

	/**
	 * Delimiter used in CSV file.
	 *
	 * @return string
	 */
	public static function get_csv_delimiter() {
		return apply_filters( 'flexible_shipping_csv_delimiter', self::CSV_DELIMITER );
	}

	/**
	 * Load CSV from file.
	 *
	 * @param string $tmp_name File name.
	 *
	 * @return array
	 */
	private function load_csv_from_file( $tmp_name ) {
		return array_map(
			function ( $v ) {
				return str_getcsv( $v, self::get_csv_delimiter() );
			},
			file( $tmp_name )
		);
	}

	/**
	 * Add columns to row.
	 *
	 * @param array $row     Row.
	 * @param array $columns Columns.
	 *
	 * @return array
	 */
	private function add_columns_to_row( array $row, array $columns ) {
		foreach ( $columns as $col_key => $col ) {
			$row[ $col ] = $row[ $col_key ];
		}

		return $row;
	}

	/**
	 * Convert rows to named values.
	 *
	 * @param array $csv_array CSV.
	 *
	 * @return array
	 */
	private function convert_rows_to_named_values( array $csv_array ) {
		$first   = true;
		$columns = array();
		foreach ( $csv_array as $row_key => $csv_row ) {
			if ( $first ) {
				$columns = $csv_row;
			} else {
				$csv_array[ $row_key ] = $this->add_columns_to_row( $csv_array[ $row_key ], $columns );
			}
			$first = false;
		}

		return $csv_array;
	}


	/**
	 * Create new shipping method.
	 *
	 * @param array $csv_row          CSV row.
	 * @param int   $import_row_count Rows count.
	 *
	 * @return array
	 * @throws ImportCSVException Exception.
	 */
	private function new_shipping_method( array $csv_row, $import_row_count ) {
		$new_shipping_method = array( 'method_enabled' => 'no' );
		if ( ! isset( $csv_row['Method Title'] ) || '' === trim( $csv_row['Method Title'] ) ) {
			throw new ImportCSVException(
				__(
					'Sorry, there has been an error. The CSV is invalid or incorrect file type.',
					'flexible-shipping'
				)
			);
		}

		$new_shipping_method['id']                 = $this->flexible_shipping_method->shipping_method_next_id( $this->shipping_methods );
		$new_shipping_method['id_for_shipping']    = $this->flexible_shipping_method->id . '_' . $this->flexible_shipping_method->instance_id . '_' . $new_shipping_method['id'];
		$new_shipping_method['method_title']       = $this->get_new_method_title( $csv_row['Method Title'] );
		$new_shipping_method['instance_id']        = $this->flexible_shipping_method->instance_id;
		$new_shipping_method['method_description'] = $csv_row['Method Description'];

		if ( '' !== trim( $csv_row['Free Shipping'] ) && ! is_numeric( str_replace( ',', '.', $csv_row['Free Shipping'] ) ) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: free shipping value and row number.
					__( 'Free Shipping value %1$s is not valid number. Row number %2$d.', 'flexible-shipping' ),
					$csv_row['Free Shipping'],
					$import_row_count
				)
			);
		}
		$new_shipping_method[ WPDesk_Flexible_Shipping::FIELD_METHOD_FREE_SHIPPING ] = str_replace( ',', '.', $csv_row['Free Shipping'] );
		if ( trim( $csv_row['Maximum Cost'] ) !== '' && ! is_numeric( str_replace( ',', '.', $csv_row['Maximum Cost'] ) ) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: maximum cost value and row number.
					__( 'Maximum Cost value %1$s is not valid number. Row number %2$d.', 'flexible-shipping' ),
					$csv_row['Maximum Cost'],
					$import_row_count
				)
			);
		}
		$new_shipping_method['method_max_cost']           = str_replace( ',', '.', $csv_row['Maximum Cost'] );
		$new_shipping_method['method_calculation_method'] = $csv_row['Calculation Method'];
		$new_shipping_method['cart_calculation']          = isset( $csv_row['Cart Calculation'] ) ? $csv_row['Cart Calculation'] : '';
		if ( ! in_array(
			$new_shipping_method['method_calculation_method'],
			array( 'sum', 'lowest', 'highest' ),
			true
		) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: row number.
					__( 'Invalid value for Calculation Method in row number %d.', 'flexible-shipping' ),
					$import_row_count
				)
			);
		}
		$new_shipping_method['method_visibility'] = $csv_row['Visibility'];
		if ( 'yes' !== $new_shipping_method['method_visibility'] ) {
			$new_shipping_method['method_visibility'] = 'no';
		}
		$new_shipping_method['method_default'] = $csv_row['Default'];
		if ( 'yes' !== $new_shipping_method['method_default'] ) {
			$new_shipping_method['method_default'] = 'no';
		}
		$new_shipping_method['method_rules'] = array();

		return $new_shipping_method;
	}

	/**
	 * Get numeric value from row.
	 *
	 * @param array  $csv_row          CSV row.
	 * @param string $column           Column.
	 * @param int    $import_row_count Row count.
	 *
	 * @return string
	 * @throws ImportCSVException Exception.
	 */
	private function get_numeric_value_from_row( array $csv_row, $column, $import_row_count ) {
		if ( '' !== trim( $csv_row[ $column ] ) && ! is_numeric( str_replace( ',', '.', $csv_row[ $column ] ) ) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: column name, value and row number.
					__( '%1$s value %2$s is not valid number. Row number %3$d.', 'flexible-shipping' ),
					$column,
					$csv_row['Min'],
					$import_row_count
				)
			);
		}

		return str_replace( ',', '.', $csv_row[ $column ] );
	}

	/**
	 * Maybe populate and create shipping classes.
	 *
	 * @param string $shipping_classes Shipping Classes.
	 *
	 * @return array
	 * @throws ImportCSVException Exception.
	 */
	private function maybe_populate_and_create_shipping_classes( $shipping_classes ) {
		$data = array();

		$rule_shipping_classes = explode( ',', trim( $shipping_classes ) );

		foreach ( $rule_shipping_classes as $rule_shipping_class ) {
			if ( ! in_array( $rule_shipping_class, array( 'all', 'any', 'none' ), true ) ) {
				$term_id = $this->find_shipping_class_by_name( $rule_shipping_class );
				if ( null === $term_id ) {
					$term_id = $this->create_shipping_class( $rule_shipping_class, $rule_shipping_class );
				}
				$data[] = $term_id;
			} else {
				$data[] = $rule_shipping_class;
			}
		}

		return $data;
	}

	/**
	 * New shipping method rule.
	 *
	 * @param array $csv_row          CSV row.
	 * @param int   $import_row_count Row count.
	 *
	 * @return array
	 * @throws ImportCSVException Exception.
	 */
	private function new_rule( array $csv_row, $import_row_count ) {
		$rule             = array();
		$rule['based_on'] = $csv_row['Based on'];

		$conditions = array_keys( ( new ConditionsFactory() )->get_conditions() );

		if ( ! in_array( $rule['based_on'], $conditions, true ) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: row number.
					__( 'Invalid value for Based On in row number %d.', 'flexible-shipping' ),
					$import_row_count
				)
			);
		}

		$rule['cost_per_order'] = $this->get_numeric_value_from_row( $csv_row, 'Cost per order', $import_row_count );

		// Conditions.
		$rule['conditions'] = array();

		$condition = array(
			'condition_id' => $csv_row['Based on'],
			'min'          => $this->get_numeric_value_from_row( $csv_row, 'Min', $import_row_count ),
			'max'          => $this->get_numeric_value_from_row( $csv_row, 'Max', $import_row_count ),
		);

		if ( ! empty( $condition['min'] ) || ! empty( $condition['max'] ) ) {
			$rule['conditions'][] = $condition;
		}

		// Shipping Classes.
		$rule['shipping_class'] = trim( $csv_row['Shipping Class'] );

		if ( ! empty( $rule['shipping_class'] ) && 'all' !== $rule['shipping_class'] ) {
			$rule['conditions'][] = array(
				'condition_id'   => 'shipping_class',
				'shipping_class' => $this->maybe_populate_and_create_shipping_classes( $rule['shipping_class'] ),
			);
		}

		// Special Actions.
		if ( 'yes' === $csv_row['Cancel'] ) {
			$rule['special_action'] = 'cancel';
		} elseif ( 'yes' === $csv_row['Stop'] ) {
			$rule['special_action'] = 'stop';
		} else {
			$rule['special_action'] = 'none';
		}

		// Additional Costs.
		$cost_additional = $this->get_numeric_value_from_row( $csv_row, 'Additional cost', $import_row_count );

		if ( ! empty( $cost_additional ) ) {
			$rule['additional_costs'][] = array(
				'additional_cost' => $cost_additional,
				'per_value'       => $this->get_numeric_value_from_row( $csv_row, 'Value', $import_row_count ),
				'based_on'        => $rule['based_on'],
			);
		}

		return $rule;
	}

	/**
	 * Import file.
	 *
	 * @throws ImportCSVException Exception.
	 */
	public function import() {
		$csv_array = $this->load_csv_from_file( $this->file['tmp_name'] );
		$csv_array = $this->convert_rows_to_named_values( $csv_array );

		$first                    = true;
		$current_method_title     = '';
		$method_title             = '';
		$imported_shipping_method = array();
		$import_row_count         = 0;
		foreach ( $csv_array as $row_key => $csv_row ) {
			$import_row_count ++;
			$new_method = false;
			if ( ! $first ) {
				if ( ! isset( $csv_row['Method Title'] ) || $current_method_title !== $csv_row['Method Title'] || ! isset( $csv_row['Based on'] ) || '' === $csv_row['Based on'] ) {
					$new_method = true;

					$imported_shipping_method = $this->new_shipping_method( $csv_row, $import_row_count );

					$current_method_title = $csv_row['Method Title'];
					$method_title         = $imported_shipping_method['method_title'];

				} else {
					$imported_shipping_method['method_rules'][] = $this->new_rule( $csv_row, $import_row_count );
				}
			}
			if ( ! $first ) {
				$this->shipping_methods[ $imported_shipping_method['id'] ] = $imported_shipping_method;
				if ( $new_method ) {
					WC_Admin_Settings::add_message(
						sprintf(
						// Translators: imported method title and method title.
							__( 'Shipping method %1$s imported as %2$s.', 'flexible-shipping' ),
							$current_method_title,
							$method_title
						)
					);
				}
			}
			$first = false;
		}
	}
}
FileNotExists.php                                                                                                                                                                                                                                              317           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class FileNotExists
 *
 * @package WPDesk\FS\TableRate\Importer\Exception
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer\Exception;

use RuntimeException;

/**
 * Class FileNotExists
 *
 * @package WPDesk\FS\TableRate\Importer\Exception
 */
class FileNotExists extends RuntimeException {
}
ImportCSVException.php                                                                                                                                                                                                                                         321           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class ImportCSVException
 *
 * @package WPDesk\FS\TableRate\Importer\Exception
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer\Exception;

use RuntimeException;

/**
 * Class ImporterException
 *
 * @package WPDesk\FS\TableRate\Importer
 */
class ImportCSVException extends RuntimeException {
}
InvalidFile.php                                                                                                                                                                                                                                                317           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer/Exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class InvalidFile
 *
 * @package WPDesk\FS\TableRate\Importer\Exception
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer\Exception;

use RuntimeException;

/**
 * Class InvalidJsonFormat
 *
 * @package WPDesk\FS\TableRate\Importer\Exception
 */
class InvalidFile extends RuntimeException {
}
Importer.php                                                                                                                                                                                                                                                   312           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Interface Importer
 *
 * @package WPDesk\FS\TableRate\Importer
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer;

/**
 * Interface Importer
 *
 * @package WPDesk\FS\TableRate\ImporterExporter\Importer
 */
interface Importer {
	/**
	 * Process Importer.
	 */
	public function import();
}
ImporterFactory.php                                                                                                                                                                                                                                            1349          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class ImporterFactory
 *
 * @package WPDesk\FS\TableRate\Importer
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer;

use WPDesk_Flexible_Shipping;

/**
 * Class ImporterFactory
 *
 * @package WPDesk\FS\TableRate\Importer
 */
class ImporterFactory {
	/**
	 * @var array
	 */
	private $file;

	/**
	 * @var WPDesk_Flexible_Shipping
	 */
	private $flexible_shipping_method;

	/**
	 * @var array
	 */
	private $shipping_methods;

	/**
	 * ImporterFactory constructor.
	 *
	 * @param array                    $file                     .
	 * @param WPDesk_Flexible_Shipping $flexible_shipping_method Flexible shipping method.
	 * @param array                    $shipping_methods         .
	 */
	public function __construct( $file, $flexible_shipping_method, $shipping_methods ) {
		$this->file                     = $file;
		$this->shipping_methods         = $shipping_methods;
		$this->flexible_shipping_method = $flexible_shipping_method;
	}

	/**
	 * @return AbstractImporter
	 *
	 * @throws UnsupportedFileFormat .
	 */
	public function get_importer() {
		switch ( $this->file['type'] ) {
			case 'application/json':
				return new JSON( $this->file, $this->flexible_shipping_method, $this->shipping_methods );
			default:
				return new CSV( $this->file, $this->flexible_shipping_method, $this->shipping_methods );
		}
	}
}
JSON.php                                                                                                                                                                                                                                                       5788          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter/Importer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * JSON Importer
 *
 * @package WPDesk\FS\TableRate\Importer
 */

namespace WPDesk\FS\TableRate\ImporterExporter\Importer;

use WC_Admin_Settings;
use WPDesk\FS\TableRate\ImporterExporter\Importer\Exception\FileNotExists;
use WPDesk\FS\TableRate\ImporterExporter\Importer\Exception\InvalidFile;

/**
 * Class JSON
 *
 * @package WPDesk\FS\TableRate\Importer
 */
class JSON extends AbstractImporter {
	/**
	 * @return array|void
	 * @throws FileNotExists .
	 * @throws InvalidFile .
	 */
	public function import() {
		if ( ! file_exists( $this->file['tmp_name'] ) ) {
			throw new FileNotExists( 'Uploaded file not exist.' );
		}

		$imported_data = file_get_contents( $this->file['tmp_name'] );

		if ( ! $imported_data ) {
			throw new FileNotExists( __( 'Uploaded file not exist.', 'flexible-shipping' ) );
		}

		$imported_shipping_methods = json_decode( $imported_data, true );

		if ( empty( $imported_shipping_methods ) ) {
			throw new InvalidFile( __( 'Sorry, there has been an error. The JSON file is invalid or incorrect file type.', 'flexible-shipping' ) );
		}

		foreach ( $imported_shipping_methods as $data ) {
			if ( ! is_array( $data ) || ! isset( $data['id'] ) ) {
				throw new InvalidFile( __( 'Sorry, there has been an error. The JSON file is invalid or incorrect file type.', 'flexible-shipping' ) );
			}

			$imported_shipping_method = $this->get_new_shipping_method_params( $data );

			$this->shipping_methods[ $imported_shipping_method['id'] ] = map_deep( $imported_shipping_method, 'sanitize_text_field' );

			WC_Admin_Settings::add_message(
				sprintf(
				// Translators: imported method title and method title.
					__( 'Shipping method %1$s imported as %2$s.', 'flexible-shipping' ),
					esc_html( $data['method_title'] ),
					esc_html( $imported_shipping_method['method_title'] )
				)
			);
		}

		return $this->shipping_methods;
	}

	/**
	 * Create new shipping method.
	 *
	 * @param array $shipping_method CSV row.
	 *
	 * @return array
	 */
	private function get_new_shipping_method_params( array $shipping_method ) {
		$new_shipping_method = array();

		$new_shipping_method['method_enabled'] = 'no';

		$method_title                        = $this->get_field_value( $shipping_method, 'method_title', __( '(no title)', 'flexible-shipping' ) );
		$new_shipping_method['method_title'] = $this->get_new_method_title( $method_title );

		$new_shipping_method['id']                                    = $this->flexible_shipping_method->shipping_method_next_id( $this->shipping_methods );
		$new_shipping_method['id_for_shipping']                       = $this->flexible_shipping_method->id . '_' . $this->flexible_shipping_method->instance_id . '_' . $new_shipping_method['id'];
		$new_shipping_method['instance_id']                           = $this->flexible_shipping_method->instance_id;
		$new_shipping_method['woocommerce_method_instance_id']        = $this->flexible_shipping_method->instance_id;
		$new_shipping_method['method_description']                    = $this->get_field_value( $shipping_method, 'method_description' );
		$new_shipping_method['method_free_shipping_requires']         = $this->get_field_value( $shipping_method, 'method_free_shipping_requires' );
		$new_shipping_method['method_free_shipping']                  = $this->get_field_price( $shipping_method, 'method_free_shipping' );
		$new_shipping_method['method_free_shipping_ignore_discounts'] = $this->get_field_value( $shipping_method, 'method_free_shipping_ignore_discounts' );
		$new_shipping_method['method_free_shipping_cart_notice']      = $this->get_field_value( $shipping_method, 'method_free_shipping_cart_notice' );
		$new_shipping_method['method_max_cost']                       = $this->get_field_price( $shipping_method, 'method_max_cost' );
		$new_shipping_method['method_calculation_method']             = $this->get_field_value( $shipping_method, 'method_calculation_method' );
		$new_shipping_method['cart_calculation']                      = $this->get_field_value( $shipping_method, 'cart_calculation' );
		$new_shipping_method['method_visibility']                     = $this->get_field_value( $shipping_method, 'method_visibility', 'no' );
		$new_shipping_method['method_default']                        = $this->get_field_value( $shipping_method, 'method_default', 'no' );
		$new_shipping_method['method_debug_mode']                     = $this->get_field_value( $shipping_method, 'method_debug_mode', 'no' );
		$new_shipping_method['method_integration']                    = $this->get_field_value( $shipping_method, 'method_integration', 'no' );
		$new_shipping_method['method_rules']                          = $this->get_field_value( $shipping_method, 'method_rules', array() );

		$method_free_shipping_label = $this->get_field_value( $shipping_method, 'method_free_shipping_label', null );

		if ( null !== $method_free_shipping_label ) {
			$new_shipping_method['method_free_shipping_label'] = $method_free_shipping_label;
		}

		/**
		 * Filters whether shipping rates for export.
		 *
		 * @param array  $new_shipping_method .
		 * @param string $shipping_method     .
		 * @param JSON   $this                .
		 *
		 * @since 3.17.0
		 */
		return apply_filters( 'flexible-shipping/importer/json/data', $new_shipping_method, $shipping_method, $this );
	}

	/**
	 * @param array  $data    .
	 * @param string $key     .
	 * @param mixed  $default .
	 *
	 * @return mixed
	 */
	private function get_field_value( $data, $key, $default = '' ) {
		return isset( $data[ $key ] ) ? $data[ $key ] : $default;
	}

	/**
	 * @param array  $data .
	 * @param string $key  .
	 *
	 * @return string
	 */
	private function get_field_price( $data, $key ) {
		return str_replace( ',', '.', $this->get_field_value( $data, $key, '' ) );
	}
}
ImporterData.php                                                                                                                                                                                                                                               1741          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * ImporterData.
 *
 *  @package WPDesk\FS\TableRate\ImporterExporter
 */

namespace WPDesk\FS\TableRate\ImporterExporter;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\TableRate\ImporterExporter\Importer\JSON;

/**
 * Class Hooks
 */
class ImporterData implements Hookable {
	/**
	 * @return void|null
	 */
	public function hooks() {
		add_filter( 'flexible-shipping/importer/json/data', array( $this, 'prepare_import_data' ), 10, 3 );
	}

	/**
	 * @param array $new_shipping_method .
	 * @param array $shipping_method     .
	 * @param JSON  $importer            .
	 *
	 * @return array
	 */
	public function prepare_import_data( $new_shipping_method, $shipping_method, $importer ) {
		foreach ( $new_shipping_method['method_rules'] as $method_rule_id => $method_rule ) {
			if ( ! isset( $method_rule['conditions'] ) ) {
				continue;
			}

			foreach ( $method_rule['conditions'] as $condition_id => $condition ) {
				if ( 'shipping_class' !== $condition['condition_id'] ) {
					continue;
				}

				foreach ( $condition['shipping_class'] as $shipping_class_id => $shipping_class ) {
					if ( in_array( $shipping_class, array( 'all', 'any', 'none' ), true ) ) {
						continue;
					}

					if ( isset( $importer->wc_shipping_classes_hashmap[ $shipping_class ] ) ) {
						$imported_shipping_class_id = $importer->wc_shipping_classes_hashmap[ $shipping_class ];
					} else {
						$imported_shipping_class_id = $importer->create_shipping_class( $shipping_class, $shipping_class );
					}

					$new_shipping_method['method_rules'][ $method_rule_id ]['conditions'][ $condition_id ]['shipping_class'][ $shipping_class_id ] = $imported_shipping_class_id;
				}
			}
		}

		return $new_shipping_method;
	}
}
ShippingClassTrait.php                                                                                                                                                                                                                                         2306          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ImporterExporter                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
/**
 * Trait ImporterExporter
 *
 * @package WPDesk\FS\TableRate\ImporterExporter
 */

namespace WPDesk\FS\TableRate\ImporterExporter;

use stdClass;
use WPDesk\FS\TableRate\ImporterExporter\Importer\Exception\ImportCSVException;

/**
 * Trait ShippingClassTrait
 *
 * @package WPDesk\FS\TableRate\ImporterExporter
 */
trait ShippingClassTrait {
	/**
	 * Hashmap for shipping classes with name->term_id data.
	 *
	 * @var stdClass[]
	 */
	public $wc_shipping_classes_hashmap;

	/**
	 * Init action.
	 */
	public function init_shipping_class() {
		$this->wc_shipping_classes_hashmap = $this->prepare_shipping_class_hashmap();
	}

	/**
	 * Prepares hashmap for fast checking the term_id of given shipment class.
	 *
	 * @return array
	 */
	public function prepare_shipping_class_hashmap() {
		$shipping_classes = array();

		foreach ( WC()->shipping()->get_shipping_classes() as $class ) {
			$shipping_classes[ html_entity_decode( $class->name ) ] = (int) $class->term_id;
		}

		return $shipping_classes;
	}

	/**
	 * Find and returns shipping class term id
	 *
	 * @param string $name Shipping class name to search.
	 *
	 * @return int|null Term id
	 */
	public function find_shipping_class_by_name( $name ) {
		$name = html_entity_decode( $name );
		if ( isset( $this->wc_shipping_classes_hashmap[ $name ] ) ) {
			return (int) $this->wc_shipping_classes_hashmap[ $name ];
		}

		return null;
	}

	/**
	 * Creates a shipping class
	 *
	 * @param string $name        Shipping class name.
	 * @param string $description Shipping class description.
	 *
	 * @return int Term id
	 * @throws ImportCSVException When can't create the class.
	 */
	public function create_shipping_class( $name, $description ) {
		$term_id = wp_insert_term( $name, 'product_shipping_class', array( 'description' => $description ) );
		if ( is_wp_error( $term_id ) ) {
			throw new ImportCSVException(
				sprintf(
				// Translators: rule shipping class and wp_error message.
					__( 'Error while creating shipping class: %1$s, %2$s', 'flexible-shipping' ),
					$name,
					$term_id->get_error_message()
				)
			);
		}
		$term_id                                                          = (int) $term_id['term_id'];
		$this->wc_shipping_classes_hashmap[ html_entity_decode( $name ) ] = $term_id;

		return $term_id;
	}
}
MultiCurrency.php                                                                                                                                                                                                                                              1063          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php

namespace WPDesk\FS\TableRate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use Psr\Log\LoggerInterface;

/**
 * Can convert from shop currency to current currency.
 */
class MultiCurrency implements Hookable {

	/**
	 * @var LoggerInterface
	 */
	private $logger;

	/**
	 * @var string
	 */
	private $filter_prefix;

	/**
	 * @param LoggerInterface $logger
	 * @param string          $filter_prefix
	 */
	public function __construct( LoggerInterface $logger, string $filter_prefix ) {
		$this->logger        = $logger;
		$this->filter_prefix = $filter_prefix;
	}

	public function hooks() {
		add_filter( 'flexible_shipping_value_in_currency', [ $this, 'flexible_shipping_value_in_currency' ], PHP_INT_MAX, 2 );
	}

	public function flexible_shipping_value_in_currency( $amount, $base_currency_amount = null ) {
		if ( $base_currency_amount && $amount !== $base_currency_amount ) {
			// Already converted.
			return $amount;
		}

		return (float) apply_filters( $this->filter_prefix . '/currency-switchers/amount', $amount, $this->logger );
	}

}
ItemMeta.php                                                                                                                                                                                                                                                   2497          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Order                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class ItemMeta
 *
 * @package WPDesk\FS\TableRate\Order
 */

namespace WPDesk\FS\TableRate\Order;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Order_Item;
use WC_Order_Item_Shipping;
use WPDesk\FS\TableRate\ShippingMethod\RateCalculator;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Can display order meta.
 */
class ItemMeta implements Hookable {

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'woocommerce_checkout_order_created', [ $this, 'update_order_shipping_meta' ] );
		add_action( 'woocommerce_before_order_itemmeta', [ $this, 'filter_meta_if_flexible_shipping_method' ], 10, 2 );
		add_action( 'woocommerce_after_order_itemmeta', [ $this, 'remove_filter_meta_if_flexible_shipping_method' ] );
	}

	/**
	 * @param \WC_Order $order .
	 */
	public function update_order_shipping_meta( $order ) {
		if ( $order ) {
			foreach ( $order->get_shipping_methods() as $shipping_method ) {
				$shipping_method->delete_meta_data( RateCalculator::DESCRIPTION_BASE64ENCODED );
				$shipping_method->save_meta_data();
			}
		}
	}

	/**
	 * @param int           $item_id .
	 * @param WC_Order_Item $item .
	 */
	public function filter_meta_if_flexible_shipping_method( $item_id, WC_Order_Item $item ) {
		if ( $item instanceof WC_Order_Item_Shipping ) {
			if ( in_array( $item->get_method_id(), [ WPDesk_Flexible_Shipping::METHOD_ID, ShippingMethodSingle::SHIPPING_METHOD_ID ], true ) ) {
				add_filter( 'woocommerce_hidden_order_itemmeta', [ $this, 'hide_flexible_shipping_item_meta' ] );
				add_filter( 'woocommerce_order_item_display_meta_key', [ $this, 'format_display_key' ] );
			}
		}
	}

	/**
	 * @param string $key .
	 *
	 * @return string
	 */
	public function format_display_key( $key ) {
		return RateCalculator::DESCRIPTION === $key ? __( 'Description', 'flexible-shipping' ) : $key;
	}

	/**
	 * @param array $hidden_order_item_meta .
	 *
	 * @return array
	 */
	public function hide_flexible_shipping_item_meta( $hidden_order_item_meta ) {
		$hidden_order_item_meta[] = RateCalculator::FS_INTEGRATION;
		$hidden_order_item_meta[] = RateCalculator::DESCRIPTION_BASE64ENCODED;

		return $hidden_order_item_meta;
	}

	/**
	 * .
	 */
	public function remove_filter_meta_if_flexible_shipping_method() {
		remove_filter( 'woocommerce_hidden_order_itemmeta', [ $this, 'hide_flexible_shipping_item_meta' ] );
		remove_filter( 'woocommerce_order_item_display_meta_key', [ $this, 'format_display_key' ] );
	}

}
FlexibleShippingRates.php                                                                                                                                                                                                                                      3348          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rates                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class FlexibleShippingRates
 *
 * @package WPDesk\FS\TableRate\Rates
 */

namespace WPDesk\FS\TableRate\Rates;

use WC_Shipping_Zone;
use WC_Shipping_Zones;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Can get all Flexible Shipping rates.
 */
class FlexibleShippingRates {

	/**
	 * @var array
	 */
	private static $flexible_shipping_rates;

	/**
	 * @return array
	 */
	public static function get_flexible_shipping_rates() {
		if ( null === self::$flexible_shipping_rates ) {
			self::$flexible_shipping_rates = self::get_flexible_shipping_rates_from_configuration();
		}

		return self::$flexible_shipping_rates;
	}

	/**
	 * @return array
	 */
	private static function get_flexible_shipping_rates_from_configuration() {
		$rates = [];
		foreach ( self::get_shipping_zones() as $zone ) {
			foreach ( $zone['shipping_methods'] as $instance_id => $woo_shipping_method ) {
				if ( WPDesk_Flexible_Shipping::METHOD_ID === $woo_shipping_method->id ) {
					$rates = self::append_flexible_shipping_group_rates( $rates, $woo_shipping_method );
				}
				if ( ShippingMethodSingle::SHIPPING_METHOD_ID === $woo_shipping_method->id ) {
					$rates = self::append_flexible_shipping_single_rate( $rates, $woo_shipping_method );
				}
			}
		}

		return $rates;
	}

	/**
	 * @return WC_Shipping_Zone[]
	 */
	private static function get_shipping_zones() {
		if ( WC()->countries === null ) {
			return [];
		}
		$zones                               = WC_Shipping_Zones::get_zones();
		$zone0                               = WC_Shipping_Zones::get_zone( 0 );
		$zones[0]                            = $zone0->get_data();
		$zones[0]['formatted_zone_location'] = $zone0->get_formatted_location();
		$zones[0]['shipping_methods']        = $zone0->get_shipping_methods();

		return $zones;
	}

	/**
	 * @param array                    $rates               .
	 * @param WPDesk_Flexible_Shipping $woo_shipping_method .
	 *
	 * @return array
	 */
	private static function append_flexible_shipping_group_rates( array $rates, WPDesk_Flexible_Shipping $woo_shipping_method ) {
		$shipping_methods = $woo_shipping_method->get_shipping_methods();
		foreach ( $shipping_methods as $shipping_method ) {
			$id                             = $woo_shipping_method->prepare_rate_id( $shipping_method );
			$shipping_method['instance_id'] = $woo_shipping_method->instance_id;
			$rates[ $id ]                   = $shipping_method;
			$rates[ $id ]['method_id']      = WPDesk_Flexible_Shipping::METHOD_ID;
		}

		return $rates;
	}

	/**
	 * @param array                $rates               .
	 * @param ShippingMethodSingle $woo_shipping_method .
	 *
	 * @return array
	 */
	private static function append_flexible_shipping_single_rate( array $rates, ShippingMethodSingle $woo_shipping_method ) {
		$shipping_method                                                = $woo_shipping_method->instance_settings;
		$shipping_method['instance_id']                                 = $woo_shipping_method->instance_id;
		$rates[ $woo_shipping_method->get_rate_id() ]                   = $shipping_method;
		$rates[ $woo_shipping_method->get_rate_id() ]['method_id']      = ShippingMethodSingle::SHIPPING_METHOD_ID;
		$rates[ $woo_shipping_method->get_rate_id() ]['method_enabled'] = $woo_shipping_method->enabled;

		return $rates;
	}
}
AbstractCondition.php                                                                                                                                                                                                                                          4759          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class AbstractCondition
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\Forms\FieldProvider;
use FSVendor\WPDesk\Forms\Renderer\JsonNormalizedRenderer;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use JsonSerializable;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\Rule;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;

/**
 * Abstract condition.
 */
abstract class AbstractCondition implements Condition, FieldProvider, JsonSerializable {

	/**
	 * @var string
	 */
	protected $condition_id;

	/**
	 * @var string
	 */
	protected $name;

	/**
	 * @var string
	 */
	protected $description = '';

	/**
	 * @var string
	 */
	protected $group;

	/**
	 * @var int
	 */
	protected $priority = 10;

	/**
	 * @var bool
	 */
	protected $is_disabled = false;

	/**
	 * @var Rule
	 */
	protected $rule;

	/**
	 * @return string
	 */
	public function get_condition_id() {
		return $this->condition_id;
	}

	/**
	 * @return string
	 */
	public function get_name() {
		return $this->name;
	}

	/**
	 * @return string
	 */
	public function get_description() {
		return $this->description;
	}

	/**
	 * @return int
	 */
	public function get_priority() {
		return $this->priority;
	}

	/**
	 * @return string
	 */
	public function get_group() {
		return $this->group ?: _x( 'General', 'Default Condition Group', 'flexible-shipping' );
	}

	/**
	 * @param Rule $rule .
	 *
	 * @return self
	 */
	public function set_rule( Rule $rule ): self {
		$this->rule = $rule;

		return $this;
	}

	/**
	 * @param ShippingContents $shipping_contents  .
	 * @param array            $condition_settings .
	 *
	 * @return ShippingContents
	 */
	public function process_shipping_contents( ShippingContents $shipping_contents, array $condition_settings ) {
		return $shipping_contents;
	}

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 *
	 * @return bool
	 */
	public function is_condition_matched( array $condition_settings, ShippingContents $contents, LoggerInterface $logger ) {
		return false;
	}

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 * @param MethodSettings   $method_settings    .
	 *
	 * @return bool
	 */
	public function is_condition_matched_with_method_settings( array $condition_settings, ShippingContents $contents, LoggerInterface $logger, MethodSettings $method_settings ) {
		return $this->is_condition_matched( $condition_settings, $contents, $logger );
	}

	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return [];
	}

	/**
	 * @param array  $condition_settings .
	 * @param bool   $condition_matched  .
	 * @param string $input_data         .
	 *
	 * @return string
	 */
	protected function format_for_log( array $condition_settings, $condition_matched, $input_data ) {
		// Translators: condition name.
		$formatted_for_log = '   ' . sprintf( __( 'Condition: %1$s;', 'flexible-shipping' ), $this->get_name() );

		foreach ( $this->get_fields() as $field ) {
			$value = $condition_settings[ $field->get_name() ] ?? '';

			if ( $field instanceof Field\SelectField ) {
				$options = $field->get_meta_value( 'possible_values' );
				foreach ( $options as $option ) {
					if ( $option['value'] === $value ) {
						$value = $option['label'];
					}
				}
			}

			$formatted_for_log .= sprintf( ' %1$s: %2$s;', $field->get_name(), is_array( $value ) ? implode( ', ', $value ) : $value );
		}

		// Translators: input data.
		$formatted_for_log .= sprintf( __( ' input data: %1$s;', 'flexible-shipping' ), $input_data );

		// Translators: matched condition.
		$formatted_for_log .= sprintf( __( ' matched: %1$s', 'flexible-shipping' ), $condition_matched ? __( 'yes', 'flexible-shipping' ) : __( 'no', 'flexible-shipping' ) );

		return $formatted_for_log;
	}

	/**
	 * @param array $condition_settings .
	 *
	 * @return array
	 */
	public function prepare_settings( $condition_settings ) {
		return $condition_settings;
	}

	/**
	 * @return bool
	 */
	public function is_disabled(): bool {
		return $this->is_disabled;
	}

	/**
	 * @return array
	 */
	#[\ReturnTypeWillChange]
	public function jsonSerialize(): array {
		$renderer = new JsonNormalizedRenderer();

		return [
			'condition_id' => $this->get_condition_id(),
			'label'        => $this->get_name(),
			'group'        => $this->get_group(),
			'description'  => $this->get_description(),
			'parameters'   => $renderer->render_fields( $this, [] ),
			'is_disabled'  => $this->is_disabled(),
		];
	}
}
Condition.php                                                                                                                                                                                                                                                  1834          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Interface Condition
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;

/**
 * Condition
 */
interface Condition {

	/**
	 * @return string
	 */
	public function get_condition_id();

	/**
	 * @return string
	 */
	public function get_name();

	/**
	 * @return string
	 */
	public function get_description();

	/**
	 * @return string
	 */
	public function get_group();

	/**
	 * @return int
	 */
	public function get_priority();

	/**
	 * @param ShippingContents $shipping_contents  .
	 * @param array            $condition_settings .
	 *
	 * @return ShippingContents
	 */
	public function process_shipping_contents( ShippingContents $shipping_contents, array $condition_settings );

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 *
	 * @return bool
	 */
	public function is_condition_matched( array $condition_settings, ShippingContents $contents, LoggerInterface $logger );

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 * @param MethodSettings   $method_settings    .
	 *
	 * @return bool
	 */
	public function is_condition_matched_with_method_settings( array $condition_settings, ShippingContents $contents, LoggerInterface $logger, MethodSettings $method_settings );

	/**
	 * @return Field[]
	 */
	public function get_fields();

	/**
	 * @param array $condition_settings .
	 *
	 * @return array
	 */
	public function prepare_settings( $condition_settings );

}
ConditionsFactory.php                                                                                                                                                                                                                                          4322          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class ConditionsFactory
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use WPDesk\FS\TableRate\Rule\Condition\Pro\CartLineItem;
use WPDesk\FS\TableRate\Rule\Condition\Pro\DayOfTheWeek;
use WPDesk\FS\TableRate\Rule\Condition\Pro\DimensionalWeight;
use WPDesk\FS\TableRate\Rule\Condition\Pro\Item;
use WPDesk\FS\TableRate\Rule\Condition\Pro\MaxDimension;
use WPDesk\FS\TableRate\Rule\Condition\Pro\Product;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ProductCategory;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ProductDimensionHeight;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ProductDimensionLength;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ProductDimensionWidth;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ProductTag;
use WPDesk\FS\TableRate\Rule\Condition\Pro\ShippingClass;
use WPDesk\FS\TableRate\Rule\Condition\Pro\TimeOfTheDay;
use WPDesk\FS\TableRate\Rule\Condition\Pro\TotalOverallDimensions;
use WPDesk\FS\TableRate\Rule\Condition\Pro\UserRole;
use WPDesk\FS\TableRate\Rule\Condition\Pro\Volume;

/**
 * Can provide rules conditions.
 */
class ConditionsFactory {

	/**
	 * @return Condition[]
	 */
	public function get_conditions(): array {
		$none   = new None( 0 );
		$price  = new Price( 10 );
		$weight = new Weight( 25 );

		// Pro conditions.
		$item                     = new Item( 15 );
		$volume                   = new Volume( 35 );
		$product                  = new Product( 30 );
		$product_tag              = new ProductTag( 45 );
		$product_category         = new ProductCategory( 50 );
		$time_of_the_day          = new TimeOfTheDay( 70 );
		$max_dimension            = new MaxDimension( 40 );
		$product_length           = new ProductDimensionLength( 41 );
		$product_width            = new ProductDimensionWidth( 42 );
		$product_height           = new ProductDimensionHeight( 43 );
		$cart_line_item           = new CartLineItem( 20 );
		$shipping_class           = new ShippingClass( 60 );
		$day_of_the_week          = new DayOfTheWeek( 75 );
		$total_overall_dimensions = new TotalOverallDimensions( 40 );
		$user_role                = new UserRole( 40 );
		$dimensional_weight       = new DimensionalWeight( 30 );

		$conditions = [
			$none->get_condition_id()                     => $none,
			$price->get_condition_id()                    => $price,
			$weight->get_condition_id()                   => $weight,
			$item->get_condition_id()                     => $item,
			$volume->get_condition_id()                   => $volume,
			$product->get_condition_id()                  => $product,
			$product_tag->get_condition_id()              => $product_tag,
			$product_category->get_condition_id()         => $product_category,
			$time_of_the_day->get_condition_id()          => $time_of_the_day,
			$max_dimension->get_condition_id()            => $max_dimension,
			$product_length->get_condition_id()           => $product_length,
			$product_width->get_condition_id()            => $product_width,
			$product_height->get_condition_id()           => $product_height,
			$cart_line_item->get_condition_id()           => $cart_line_item,
			$shipping_class->get_condition_id()           => $shipping_class,
			$day_of_the_week->get_condition_id()          => $day_of_the_week,
			$total_overall_dimensions->get_condition_id() => $total_overall_dimensions,
			$user_role->get_condition_id()                => $user_role,
			$dimensional_weight->get_condition_id()       => $dimensional_weight,
		];

		$conditions = apply_filters( 'flexible_shipping_rule_conditions', $conditions );
		$conditions = $this->filter_conditions( $conditions );

		return $this->sort_conditions( $conditions );
	}

	/**
	 * @param Condition[] $conditions .
	 *
	 * @return Condition[]
	 */
	private function filter_conditions( array $conditions ): array {
		return array_filter(
			$conditions,
			function ( $condition ) {
				return $condition instanceof Condition;
			}
		);
	}

	/**
	 * @param Condition[] $conditions .
	 *
	 * @return Condition[]
	 */
	private function sort_conditions( array $conditions ): array {
		uasort(
			$conditions,
			function ( Condition $condition1, Condition $condition2 ) {
				return $condition1->get_priority() <=> $condition2->get_priority(); // phpcs:ignore.
			}
		);

		return $conditions;
	}
}
None.php                                                                                                                                                                                                                                                       1794          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class None
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use FSVendor\WPDesk\Forms\Field;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;

/**
 * None Condition.
 */
class None extends AbstractCondition {

	const CONDITION_ID = 'none';

	/**
	 * None constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Always', 'flexible-shipping' );
		$this->description  = __( 'Fixed shipping cost', 'flexible-shipping' );
		$this->priority     = $priority;
	}

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 *
	 * @return bool
	 */
	public function is_condition_matched( array $condition_settings, ShippingContents $contents, LoggerInterface $logger ) {
		$logger->debug( $this->format_for_log( $condition_settings, true, '' ) );

		return true;
	}

	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return [];
	}

	/**
	 * @param array  $condition_settings .
	 * @param bool   $condition_matched  .
	 * @param string $input_data         .
	 *
	 * @return string
	 */
	protected function format_for_log( array $condition_settings, $condition_matched, $input_data ) {
		// Translators: condition name.
		$formatted_for_log = '   ' . sprintf( __( 'Condition: %1$s;', 'flexible-shipping' ), $this->get_name() );
		// Translators: matched condition.
		$formatted_for_log .= sprintf( __( ' matched: %1$s', 'flexible-shipping' ), $condition_matched ? __( 'yes', 'flexible-shipping' ) : __( 'no', 'flexible-shipping' ) );

		return $formatted_for_log;
	}
}
Price.php                                                                                                                                                                                                                                                      3233          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class Price
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use FSVendor\WPDesk\Forms\Field;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;

/**
 * Price condition.
 */
class Price extends AbstractCondition {

	const MIN = 'min';
	const MAX = 'max';

	const CONDITION_ID = 'value';

	/**
	 * Price constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Price', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the cart total or package value', 'flexible-shipping' );
		$this->group        = __( 'Cart', 'flexible-shipping' );
		$this->priority     = $priority;
	}

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 *
	 * @return bool
	 */
	public function is_condition_matched( array $condition_settings, ShippingContents $contents, LoggerInterface $logger ) {
		$min = (float) ( isset( $condition_settings[ self::MIN ] ) && 0 !== strlen( $condition_settings[ self::MIN ] ) ? $condition_settings[ self::MIN ] : 0 );
		$max = (float) ( isset( $condition_settings[ self::MAX ] ) && 0 !== strlen( $condition_settings[ self::MAX ] ) ? $condition_settings[ self::MAX ] : INF );
		$min = (float) apply_filters( 'flexible_shipping_value_in_currency', $min, $min );
		if ( $max !== INF ) {
			$max = (float) apply_filters( 'flexible_shipping_value_in_currency', $max, $max );
		}

		$contents_cost = $this->get_contents_cost( $contents );

		$condition_matched = $contents_cost >= $min && $contents_cost <= $max;

		$logger->debug( $this->format_for_log( $condition_settings, $condition_matched, $contents_cost ) );

		return $condition_matched;
	}

	/**
	 * @param ShippingContents $contents .
	 *
	 * @return float
	 */
	protected function get_contents_cost( ShippingContents $contents ) {
		$contents_cost =
			/**
			 * Can modify contents cost passed to Price (value) condition.
			 *
			 * @param float $contents_cost Contents cost.
			 *
			 * @since 4.1.1
			 */
			apply_filters( 'flexible-shipping/condition/contents_value', $contents->get_contents_cost() );

		return (float) $contents_cost;
	}

	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return [
			( new Field\InputNumberField() )
				->set_name( self::MIN )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'parameter_min' )
				->add_data( 'beacon_search', __( 'price is from', 'flexible-shipping' ) )
				->set_placeholder( __( 'min', 'flexible-shipping' ) )
				->set_label( __( 'is from', 'flexible-shipping' ) ),
			( new Field\InputNumberField() )
				->set_name( self::MAX )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'parameter_max' )
				->add_data( 'beacon_search', __( 'price to', 'flexible-shipping' ) )
				->set_placeholder( __( 'max', 'flexible-shipping' ) )
				->set_label( __( 'to', 'flexible-shipping' ) )
				->add_data( 'suffix', get_woocommerce_currency_symbol() ),
		];
	}

}
CartLineItem.php                                                                                                                                                                                                                                               742           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class CartLineItem
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Cart line item.
 */
class CartLineItem extends AbstractCondition {

	const CONDITION_ID = 'cart_line_item';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Cart line item', 'flexible-shipping' );
		$this->group        = __( 'Cart', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
DayOfTheWeek.php                                                                                                                                                                                                                                               719           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class DayOfTheWeek
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Day Of The Week condition.
 */
class DayOfTheWeek extends AbstractCondition {

	const CONDITION_ID = 'day_of_the_week';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Day of the week', 'flexible-shipping' );
		$this->group        = __( 'Destination & Time', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
DimensionalWeight.php                                                                                                                                                                                                                                          727           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class DimensionalWeight
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Dimensional Weight condition.
 */
class DimensionalWeight extends AbstractCondition {

	const CONDITION_ID = 'dimensional_weight';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Dimensional weight', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
Item.php                                                                                                                                                                                                                                                       656           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class Item
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Item condition.
 */
class Item extends AbstractCondition {

	const CONDITION_ID = 'item';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Item', 'flexible-shipping' );
		$this->group        = __( 'Cart', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
MaxDimension.php                                                                                                                                                                                                                                               812           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class MaxDimension
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Max Dimension condition.
 */
class MaxDimension extends AbstractCondition {

	const CONDITION_ID = 'max_dimension';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Max dimension', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the product\'s maximum dimension', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
Product.php                                                                                                                                                                                                                                                    720           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class Price
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Price condition.
 */
class Product extends AbstractCondition {

	const CONDITION_ID = 'product';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Product', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ProductCategory.php                                                                                                                                                                                                                                            767           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class ProductCategory
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Product Category condition.
 */
class ProductCategory extends AbstractCondition {

	const CONDITION_ID = 'product_category';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Product category', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ProductDimensionHeight.php                                                                                                                                                                                                                                     776           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Product height condition.
 */
class ProductDimensionHeight extends AbstractCondition {

	const CONDITION_ID = 'product_height';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Height', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the product\'s height', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ProductDimensionLength.php                                                                                                                                                                                                                                     776           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Product length condition.
 */
class ProductDimensionLength extends AbstractCondition {

	const CONDITION_ID = 'product_length';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Length', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the product\'s length', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ProductDimensionWidth.php                                                                                                                                                                                                                                      771           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Product width condition.
 */
class ProductDimensionWidth extends AbstractCondition {

	const CONDITION_ID = 'product_width';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Width', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the product\'s width', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ProductTag.php                                                                                                                                                                                                                                                 742           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class ProductTag
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Product Tag condition.
 */
class ProductTag extends AbstractCondition {

	const CONDITION_ID = 'product_tag';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Product tag', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
ShippingClass.php                                                                                                                                                                                                                                              706           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class ShippingClass
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Max Dimension condition.
 */
class ShippingClass extends AbstractCondition {

	const CONDITION_ID = 'shipping_class';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Shipping class', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
TimeOfTheDay.php                                                                                                                                                                                                                                               719           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class TimeOfTheDay
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Time Of The Day condition.
 */
class TimeOfTheDay extends AbstractCondition {

	const CONDITION_ID = 'time_of_the_day';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Time of the day', 'flexible-shipping' );
		$this->group        = __( 'Destination & Time', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
TotalOverallDimensions.php                                                                                                                                                                                                                                     805           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class TotalOverallDimensions
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Total Overall Dimensions condition.
 */
class TotalOverallDimensions extends AbstractCondition {

	const CONDITION_ID = 'total_overall_dimensions';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Total overall dimensions', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
UserRole.php                                                                                                                                                                                                                                                   679           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class UserRole
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * User Role condition.
 */
class UserRole extends AbstractCondition {

	const CONDITION_ID = 'user_role';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'User Role', 'flexible-shipping' );
		$this->group        = __( 'User', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
Volume.php                                                                                                                                                                                                                                                     669           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition/Pro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class Volume
 */

namespace WPDesk\FS\TableRate\Rule\Condition\Pro;

use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;

/**
 * Volume condition.
 */
class Volume extends AbstractCondition {

	const CONDITION_ID = 'volume';

	/**
	 * Product constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( int $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Volume', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
		$this->is_disabled  = true;

		$this->name .= ' ' . __( '(PRO feature)', 'flexible-shipping' );
	}
}
Weight.php                                                                                                                                                                                                                                                     2876          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class Weight
 *
 * @package WPDesk\FS\TableRate\Rule\Condition
 */

namespace WPDesk\FS\TableRate\Rule\Condition;

use FSVendor\WPDesk\Forms\Field;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;

/**
 * Weight condition.
 */
class Weight extends AbstractCondition {

	const MIN = 'min';
	const MAX = 'max';

	const CONDITION_ID = 'weight';

	/**
	 * Weight constructor.
	 *
	 * @param int $priority .
	 */
	public function __construct( $priority = 10 ) {
		$this->condition_id = self::CONDITION_ID;
		$this->name         = __( 'Weight', 'flexible-shipping' );
		$this->description  = __( 'Shipping cost based on the weight of the cart or package', 'flexible-shipping' );
		$this->group        = __( 'Product', 'flexible-shipping' );
		$this->priority     = $priority;
	}

	/**
	 * @param array            $condition_settings .
	 * @param ShippingContents $contents           .
	 * @param LoggerInterface  $logger             .
	 *
	 * @return bool
	 */
	public function is_condition_matched( array $condition_settings, ShippingContents $contents, LoggerInterface $logger ) {
		$min = (float) ( isset( $condition_settings[ self::MIN ] ) && 0 !== strlen( $condition_settings[ self::MIN ] ) ? $condition_settings[ self::MIN ] : 0 );
		$max = (float) ( isset( $condition_settings[ self::MAX ] ) && 0 !== strlen( $condition_settings[ self::MAX ] ) ? $condition_settings[ self::MAX ] : INF );

		$contents_weight =
			/**
			 * Can modify contents weight passed to Weight condition.
			 *
			 * @param float $contents_weight Contents weight.
			 *
			 * @since 4.1.1
			 */
			apply_filters( 'flexible-shipping/condition/contents_weight', $contents->get_contents_weight() );

		$contents_weight = (float) $contents_weight;

		$condition_matched = $contents_weight >= $min && $contents_weight <= $max;

		$logger->debug( $this->format_for_log( $condition_settings, $condition_matched, $contents_weight ) );

		return $condition_matched;
	}

	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return [
			( new Field\InputNumberField() )
				->set_name( self::MIN )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'parameter_min' )
				->add_data( 'beacon_search', __( 'weight is from', 'flexible-shipping' ) )
				->set_placeholder( __( 'is from', 'flexible-shipping' ) )
				->set_label( __( 'is from', 'flexible-shipping' ) ),
			( new Field\InputNumberField() )
				->set_name( self::MAX )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'parameter_max' )
				->add_data( 'beacon_search', __( 'weight to', 'flexible-shipping' ) )
				->set_placeholder( __( 'to', 'flexible-shipping' ) )
				->set_label( __( 'to', 'flexible-shipping' ) )
				->add_data( 'suffix', get_option( 'woocommerce_weight_unit' ) ),
		];
	}

}
ContentsFilter.php                                                                                                                                                                                                                                             344           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * Interface ContentsFilter
 *
 * @package WPDesk\FS\TableRate\Rule
 */

namespace WPDesk\FS\TableRate\Rule;

/**
 * Contents filter interface.
 */
interface ContentsFilter {

	/**
	 * Returns filtered contents.
	 *
	 * @param array $contents .
	 *
	 * @return array
	 */
	public function get_filtered_contents( array $contents );

}
AbstractAdditionalCost.php                                                                                                                                                                                                                                     4834          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Cost                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class AbstractAdditionalCost
 *
 * @package WPDesk\FS\TableRate\Rule\Cost
 */

namespace WPDesk\FS\TableRate\Rule\Cost;

use FSVendor\WPDesk\Forms\Renderer\JsonNormalizedRenderer;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use JsonSerializable;
use Psr\Log\LoggerInterface;
use Throwable;
use WPDesk\FS\TableRate\Rule\Rule;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;
use function Patchwork\Config\locate;

/**
 * Abstract Additional Cost.
 */
abstract class AbstractAdditionalCost implements AdditionalCost, JsonSerializable {

	/**
	 * @var string
	 */
	protected $based_on;

	/**
	 * @var string
	 */
	protected $name;

	/**
	 * @var MethodSettings
	 */
	protected $method_settings;

	/**
	 * @var Rule
	 */
	protected $rule;

	/**
	 * @return string
	 */
	public function get_based_on() {
		return $this->based_on;
	}

	/**
	 * @return string
	 */
	public function get_name() {
		return $this->name;
	}

	/**
	 * @param array $additional_cost_settings .
	 *
	 * @return float|null
	 */
	public function get_per_value( array $additional_cost_settings ) {
		$setting_value = $this->get_settings_value( RuleAdditionalCostFieldsFactory::PER_VALUE, $additional_cost_settings );

		return isset( $setting_value ) ? (float) $setting_value : null;
	}

	/**
	 * @param array $additional_cost_settings .
	 *
	 * @return float|null
	 */
	public function get_additional_cost( array $additional_cost_settings ) {
		$setting_value = $this->get_settings_value( RuleAdditionalCostFieldsFactory::ADDITIONAL_COST, $additional_cost_settings );

		return isset( $setting_value ) ? (float) $setting_value : null;
	}

	/**
	 * @param string $name     .
	 * @param array  $settings .
	 */
	private function get_settings_value( $name, array $settings ) {
		return isset( $settings[ $name ] ) ? $settings[ $name ] : null;
	}

	/**
	 * @param ShippingContents $shipping_contents        .
	 * @param array            $additional_cost_settings .
	 * @param LoggerInterface  $logger                   .
	 *
	 * @return float
	 */
	public function calculate_cost( ShippingContents $shipping_contents, array $additional_cost_settings, LoggerInterface $logger ) {
		try {
			$per_value               = $this->get_per_value( $additional_cost_settings );
			$additional_cost         = $this->get_additional_cost( $additional_cost_settings );
			// Tricky fix (float->string->float) for bug in rounding (#OCT-2684).
			$shipment_contents_value = (float) (string) $this->get_value_from_shipment_contents( $shipping_contents );
			if ( isset( $per_value, $additional_cost ) && 0.0 !== $per_value ) {
				$calculated_additional_cost = ceil( $shipment_contents_value / $per_value ) * $additional_cost;
			} else {
				$calculated_additional_cost = 0;
			}
			$logger->debug(
				sprintf(
					'    %1$s %2$s; %3$s; %4$s; %5$s',
					__( 'additional cost:', 'flexible-shipping' ),
					// Translators: cost per.
					sprintf( __( '%1$s per %2$s', 'flexible-shipping' ), $additional_cost, $per_value ),
					// Translators: based on.
					sprintf( __( 'based on: %1$s', 'flexible-shipping' ), $this->get_name() ),
					// Translators: input data.
					sprintf( __( 'input data: %1$s', 'flexible-shipping' ), $shipment_contents_value ),
					// Translators: calculated.
					sprintf( __( 'calculated: %1$s', 'flexible-shipping' ), $calculated_additional_cost )
				)
			);
		} catch ( Throwable $e ) {
			$logger->debug( $e->getMessage() );
			$calculated_additional_cost = 0;
		}

		return $calculated_additional_cost;
	}

	/**
	 * @param ShippingContents $shipping_contents        .
	 * @param array            $additional_cost_settings .
	 * @param LoggerInterface  $logger                   .
	 * @param MethodSettings   $method_settings          .
	 *
	 * @return float
	 */
	public function calculate_cost_with_method_settings( ShippingContents $shipping_contents, array $additional_cost_settings, LoggerInterface $logger, MethodSettings $method_settings ) {
		$this->method_settings = $method_settings;

		return $this->calculate_cost( $shipping_contents, $additional_cost_settings, $logger );
	}

	/**
	 * @param Rule $rule
	 *
	 * @return $this
	 */
	public function set_rule( Rule $rule ): AbstractAdditionalCost {
		$this->rule = $rule;

		return $this;
	}

	/**
	 * Returns value from shipment contents to calculate cost.
	 *
	 * @param ShippingContents $shipping_contents .
	 *
	 * @return float
	 */
	abstract protected function get_value_from_shipment_contents( $shipping_contents );

	/**
	 * @return array
	 */
	#[\ReturnTypeWillChange]
	public function jsonSerialize(): array {
		$renderer = new JsonNormalizedRenderer();

		return [
			'additional_cost_id' => $this->get_based_on(),
			'label'              => $this->get_name(),
			'parameters'         => $renderer->render_fields( $this, [] ),
		];
	}
}
AdditionalCost.php                                                                                                                                                                                                                                             1318          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Cost                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Interface AdditionalCost
 *
 * @package WPDesk\FS\TableRate\Rule\Cost
 */

namespace WPDesk\FS\TableRate\Rule\Cost;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\Forms\FieldProvider;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;

/**
 * Additional Costs Interface.
 */
interface AdditionalCost {

	/**
	 * @return string
	 */
	public function get_based_on();

	/**
	 * @return string
	 */
	public function get_name();

	/**
	 * @param ShippingContents $shipping_contents        .
	 * @param array            $additional_cost_settings .
	 * @param LoggerInterface  $logger                   .
	 *
	 * @return float
	 */
	public function calculate_cost( ShippingContents $shipping_contents, array $additional_cost_settings, LoggerInterface $logger );

	/**
	 * @param ShippingContents $shipping_contents        .
	 * @param array            $additional_cost_settings .
	 * @param LoggerInterface  $logger                   .
	 * @param MethodSettings   $method_settings          .
	 *
	 * @return float
	 */
	public function calculate_cost_with_method_settings( ShippingContents $shipping_contents, array $additional_cost_settings, LoggerInterface $logger, MethodSettings $method_settings );
}
RuleAdditionalCostFactory.php                                                                                                                                                                                                                                  526           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Cost                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class RuleAdditionalCostFactory
 *
 * @package WPDesk\FS\TableRate\Rule\Cost
 */

namespace WPDesk\FS\TableRate\Rule\Cost;

/**
 * Can provide rule additional costs.
 */
class RuleAdditionalCostFactory {

	/**
	 * @return array
	 */
	public function get_additional_costs() {
		return apply_filters( 'flexible_shipping_rule_additional_cost', $this->get_built_in_rule_additional_cost_fields() );
	}

	/**
	 * @return array
	 */
	private function get_built_in_rule_additional_cost_fields() {
		return array();
	}

}
RuleAdditionalCostFieldsFactory.php                                                                                                                                                                                                                            2921          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Cost                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class RuleCostFactory
 *
 * @package WPDesk\FS\TableRate\Rule\Cost
 */

namespace WPDesk\FS\TableRate\Rule\Cost;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\Forms\Field\InputTextField;
use FSVendor\WPDesk\Forms\FieldProvider;
use FSVendor\WPDesk\Forms\Renderer\JsonNormalizedRenderer;


/**
 * Can create additional costs fields.
 */
class RuleAdditionalCostFieldsFactory implements FieldProvider {

	const ADDITIONAL_COST = 'additional_cost';
	const PER_VALUE       = 'per_value';
	const BASED_ON        = 'based_on';

	/**
	 * @var AdditionalCost[]
	 */
	private $available_additional_costs;

	/**
	 * RuleAdditionalCostFieldsFactory constructor.
	 *
	 * @param AdditionalCost[] $available_additional_costs .
	 */
	public function __construct( array $available_additional_costs ) {
		$this->available_additional_costs = $available_additional_costs;
	}


	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return apply_filters( 'flexible_shipping_rule_additional_cost_fields', $this->get_built_in_rule_additional_cost_fields() );
	}

	/**
	 * .
	 *
	 * @return array
	 */
	public function get_normalized_cost_fields() {
		$normalized_cost_fields = array();
		$renderer               = new JsonNormalizedRenderer();

		return $renderer->render_fields( $this, array() );
	}

	/**
	 * @return Field[]
	 */
	public function get_built_in_rule_additional_cost_fields() {
		return array(
			( new Field\InputNumberField() )
				->set_name( self::ADDITIONAL_COST )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'additional-cost-cost' )
				->add_data( 'beacon_search', __( 'additional cost', 'flexible-shipping' ) )
				->set_placeholder( __( 'additional cost', 'flexible-shipping' ) )
				->set_label( __( 'additional cost is', 'flexible-shipping' ) )
				->add_data( 'suffix', get_woocommerce_currency_symbol() ),
			( new Field\InputNumberField() )
				->set_name( self::PER_VALUE )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'additional-cost-per' )
				->add_data( 'beacon_search', __( 'additional cost per', 'flexible-shipping' ) )
				->set_placeholder( __( 'per', 'flexible-shipping' ) )
				->set_label( __( 'per', 'flexible-shipping' ) ),
			( new Field\SelectField() )
				->set_name( self::BASED_ON )
				->set_options( $this->get_based_on_options() )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'additional-cost-based-on' )
				->add_data( 'beacon_search', __( 'additional cost per', 'flexible-shipping' ) ),
		);
	}

	/**
	 * @return array
	 */
	private function get_based_on_options() {
		$options = array();
		foreach ( $this->available_additional_costs as $additional_cost ) {
			$options[] = array(
				'value' => $additional_cost->get_based_on(),
				'label' => $additional_cost->get_name(),
			);
		}

		return $options;
	}

}
RuleCostFieldsFactory.php                                                                                                                                                                                                                                      1396          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Cost                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class RuleCostFactory
 *
 * @package WPDesk\FS\TableRate\Rule\Cost
 */

namespace WPDesk\FS\TableRate\Rule\Cost;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\Forms\FieldProvider;
use FSVendor\WPDesk\Forms\Renderer\JsonNormalizedRenderer;

/**
 * Can create costs fields.
 */
class RuleCostFieldsFactory implements FieldProvider {

	const COST_PER_ORDER = 'cost_per_order';

	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return apply_filters( 'flexible_shipping_rule_cost_fields', $this->get_built_in_rule_cost_fields() );
	}

	/**
	 * .
	 *
	 * @return array
	 */
	public function get_normalized_cost_fields() {
		$normalized_cost_fields = array();
		$renderer               = new JsonNormalizedRenderer();

		return $renderer->render_fields( $this, array() );
	}

	/**
	 * @return Field[]
	 */
	public function get_built_in_rule_cost_fields() {
		return array(
			( new Field\InputNumberField() )
				->set_name( self::COST_PER_ORDER )
				->add_class( 'wc_input_decimal' )
				->add_class( 'hs-beacon-search' )
				->add_class( 'cost_per_order' )
				->add_data( 'beacon_search', __( 'Cost per order', 'flexible-shipping' ) )
				->set_label( __( 'rule cost is', 'flexible-shipping' ) )
				->set_description_tip( __( 'Enter shipment cost for this rule.', 'flexible-shipping' ) )
				->add_data( 'suffix', get_woocommerce_currency_symbol() ),
		);
	}

}
CostsCalculator.php                                                                                                                                                                                                                                            7105          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * Class CostsCalculator
 *
 * @package WPDesk\FS\TableRate\Rule
 */

namespace WPDesk\FS\TableRate\Rule;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\FS\TableRate\Logger\ArrayLogger;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use Psr\Log\LoggerInterface;
use WC_Cart;
use WPDesk\FS\TableRate\Rule;
use WPDesk\FS\TableRate\Rule\Condition\Weight;
use WPDesk\FS\TableRate\Rule\Condition\ConditionsFactory;
use WPDesk\FS\TableRate\Rule\Cost\AdditionalCost;
use WPDesk\FS\TableRate\Rule\RoundingPrecision;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialAction;
use WPDesk\FS\TableRate\RulesSettingsFactory;

/**
 * Can calculate shipping costs.
 */
class CostsCalculator {

	/**
	 * @var MethodSettings
	 */
	private $method_settings;

	/**
	 * @var Rule\Rule[]
	 */
	private $prepared_rules = [];

	/**
	 * @var float
	 */
	private $calculated_cost = 0.0;

	/**
	 * @var bool
	 */
	private $is_triggered = false;

	/**
	 * @var Rule\Condition\Condition[]
	 */
	private $available_conditions;

	/**
	 * @var Field[]
	 */
	private $cost_fields;

	/**
	 * @var AdditionalCost[]
	 */
	private $available_additional_costs;

	/**
	 * @var SpecialAction[]
	 */
	private $available_special_actions;

	/**
	 * @var int
	 */
	private $cost_rounding_precision;

	/**
	 * @var ShippingContents
	 */
	private $shipping_contents;

	/**
	 * @var LoggerInterface
	 */
	private $logger;

	/**
	 * @var string
	 */
	private $shop_currency;

	/**
	 * CostsCalculator constructor.
	 *
	 * @param MethodSettings             $method_settings .
	 * @param ShippingContents           $shipping_contents .
	 * @param Rule\Condition\Condition[] $available_conditions .
	 * @param Field[]                    $cost_fields .
	 * @param AdditionalCost[]           $available_additional_costs .
	 * @param SpecialAction[]            $available_special_actions .
	 * @param int                        $cost_rounding_precision .
	 * @param string                     $shop_currency .
	 * @param LoggerInterface            $logger .
	 */
	public function __construct(
		MethodSettings $method_settings,
		ShippingContents $shipping_contents,
		array $available_conditions,
		$cost_fields,
		$available_additional_costs,
		$available_special_actions,
		$cost_rounding_precision,
		$shop_currency,
		$logger
	) {
		$this->method_settings            = $method_settings;
		$this->shipping_contents          = $shipping_contents;
		$this->available_conditions       = $available_conditions;
		$this->cost_fields                = $cost_fields;
		$this->available_additional_costs = $available_additional_costs;
		$this->available_special_actions  = $available_special_actions;
		$this->cost_rounding_precision    = $cost_rounding_precision;
		$this->shop_currency              = $shop_currency;
		$this->logger                     = $logger;
		$this->prepared_rules             = $this->prepare_rules();
	}

	/**
	 * .
	 */
	public function process_rules() {
		$this->shipping_contents->set_weight_rounding_precision( $this->calculate_weight_rounding_precision( $this->prepared_rules ) );
		$this->calculated_cost = $this->calculate_cost();
	}

	/**
	 * @return Rule\Rule[]
	 */
	private function prepare_rules() {
		$prepared_rules = [];
		foreach ( $this->get_rules_settings() as $rule_settings ) {
			$prepared_rules[] = new Rule\Rule(
				$rule_settings,
				$this->available_conditions,
				$this->cost_fields,
				$this->available_additional_costs,
				$this->available_special_actions,
				$this->cost_rounding_precision,
				$this->method_settings
			);
		}

		return $prepared_rules;
	}

	/**
	 * @return array
	 */
	private function get_rules_settings() {
		$rules_settings = $this->method_settings->get_rules_settings();
		$settings = RulesSettingsFactory::create_from_array( $rules_settings );
		return $settings->get_normalized_settings();
	}

	/**
	 * @param float $calculated_cost .
	 * @param float $rule_cost .
	 *
	 * @return float
	 *
	 * @internal
	 */
	public function sum_calculation( $calculated_cost, $rule_cost ) {
		if ( null === $calculated_cost ) {
			$calculated_cost = 0.0;
		}

		return $calculated_cost + $rule_cost;
	}

	/**
	 * @return float
	 */
	private function calculate_cost() {
		$calculated_cost = null;

		/**
		 * Rules calculation function.
		 * Default rules calculation is sum.
		 *
		 * @param callback $callbac Callback function.
		 * @param string   $callback_setting Callback setting.
		 */
		$calculation_method_callback = apply_filters(
			'flexible-shipping/shipping-method/rules-calculation-function',
			[ $this, 'sum_calculation' ],
			$this->method_settings->get_calculation_method()
		);

		$this->shipping_contents->reset_contents();
		foreach ( $this->prepared_rules as $rule_index => $calculated_rule ) {
			$this->shipping_contents = $calculated_rule->process_shipping_contents( $this->shipping_contents );

			$rule_cost = 0.0;
			$rule_logger = new ArrayLogger();
			$is_rule_triggered = false;
			if ( $calculated_rule->is_rule_triggered( $this->shipping_contents, $rule_logger ) ) {
				$is_rule_triggered = true;
				$this->is_triggered = true;
				$rule_cost = $calculated_rule->get_rule_cost( $this->shipping_contents, $rule_logger );
				$calculated_cost = $calculation_method_callback( $calculated_cost, $rule_cost );
			}

			$this->logger->debug( $calculated_rule->format_for_log( $rule_index + 1 ), $this->logger->get_rule_context( $is_rule_triggered ) );

			$this->logger->log_from_array_logger( $rule_logger, $this->logger->get_rule_context( $is_rule_triggered ) );

			if ( $is_rule_triggered ) {
				$this->logger->debug(
					// Translators: rule cost.
					sprintf( '   ' . __( 'Calculated rule cost: %1$s %2$s', 'flexible-shipping' ), $rule_cost, $this->shop_currency ),
					$this->logger->get_rule_context( $is_rule_triggered )
				);

				$special_action = $calculated_rule->get_special_action();
				if ( $special_action->is_stop() ) {
					break;
				}
				if ( $special_action->is_cancel() ) {
					$this->is_triggered = false;
					break;
				}
			}

			$this->shipping_contents->reset_contents();
		}

		if ( null === $calculated_cost ) {
			$calculated_cost = 0.0;
		}

		/**
		 * Calculated shipping method cost.
		 *
		 * @param float $calculated_cost          Calculated cost.
		 * @param array $shipping_method_settings Current shipping method settings.
		 */
		return apply_filters( 'flexible-shipping/shipping-method/calculated-cost', $calculated_cost, $this->method_settings->get_raw_settings() );
	}

	/**
	 * @param Rule\Rule[] $prepared_rules .
	 *
	 * @return int
	 */
	private function calculate_weight_rounding_precision( array $prepared_rules ) {
		$rounding_precision = new RoundingPrecision( $prepared_rules, $this->available_conditions );
		return $rounding_precision->calculate_max_precision_for_condition( Weight::CONDITION_ID );
	}

	/**
	 * @return float
	 */
	public function get_calculated_cost() {
		return $this->calculated_cost;
	}

	/**
	 * @return bool
	 */
	public function is_triggered() {
		return $this->is_triggered;
	}

}
PreconfiguredScenariosFactory.php                                                                                                                                                                                                                              2746          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/PreconfiguredScenarios                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Class PreconfiguredScenarios
 *
 * @package WPDesk\FS\TableRate\Rule\PreconfiguredScenarios
 */

namespace WPDesk\FS\TableRate\Rule\PreconfiguredScenarios;

/**
 * Can provide preconfigured scenarios.
 */
class PreconfiguredScenariosFactory {

	/**
	 * @return array
	 */
	public function get_scenarios() {
		$scenarios = array();

		$scenarios = $this->add_weight_scenarios( $scenarios );
		$scenarios = $this->add_value_scenarios( $scenarios );

		return apply_filters( 'flexible-shipping/method-rules/predefined-scenarios', $scenarios );
	}

	/**
	 * @param array $scenarios .
	 *
	 * @return PredefinedScenario[]
	 */
	private function add_weight_scenarios( array $scenarios ) {
		$pl = get_locale() === 'pl_PL';
		$url = $pl ? 'https://octol.io/fs-weight-pl' : 'https://octol.io/fs-weight';
		$scenarios['simple_weight'] = new PredefinedScenario(
			__( 'Weight', 'flexible-shipping' ),
			__( 'Weight-based shipping', 'flexible-shipping' ),
			__( 'Shipping cost increases in line with the cart total weight.', 'flexible-shipping' ),
			$url,
			'[{"conditions":[{"condition_id":"weight","min":"","max":"0.999"}],"cost_per_order":"10","additional_costs":[],"special_action":""},{"conditions":[{"condition_id":"weight","min":"1","max":"3.999"}],"cost_per_order":"11","additional_costs":[],"special_action":""},{"conditions":[{"condition_id":"weight","min":"4","max":"6.999"}],"cost_per_order":"12","additional_costs":[],"special_action":""},{"conditions":[{"condition_id":"weight","min":"7","max":"10"}],"cost_per_order":"13","additional_costs":[],"special_action":""}]'
		);

		return $scenarios;
	}

	/**
	 * @param array $scenarios .
	 *
	 * @return PredefinedScenario[]
	 */
	private function add_value_scenarios( array $scenarios ) {
		$pl = get_locale() === 'pl_PL';
		$url = $pl ? 'https://octol.io/fs-price-based-pl' : 'https://octol.io/fs-price-based';
		$scenarios['simple_value'] = new PredefinedScenario(
			__( 'Price', 'flexible-shipping' ),
			__( 'Price-based shipping', 'flexible-shipping' ),
			__( 'Shipping cost decreases in line with the cart total. Free shipping once $300 threshold is reached.', 'flexible-shipping' ),
			$url,
			'[{"conditions":[{"condition_id":"value","min":"","max":"99.99"}],"cost_per_order":"20","additional_costs":[],"special_action":"none"},{"conditions":[{"condition_id":"value","min":"100","max":"199.99"}],"cost_per_order":"15","additional_costs":[],"special_action":"none"},{"conditions":[{"condition_id":"value","min":"200","max":"299.99"}],"cost_per_order":"10","additional_costs":[],"special_action":"none"},{"conditions":[{"condition_id":"value","min":"300","max":""}],"cost_per_order":"0","additional_costs":[],"special_action":"none"}]'
		);

		return $scenarios;
	}

}
PredefinedScenario.php                                                                                                                                                                                                                                         3140          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/PreconfiguredScenarios                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Class PredefinedScenario
 *
 * @package WPDesk\FS\TableRate\Rule\PreconfiguredScenarios
 */

namespace WPDesk\FS\TableRate\Rule\PreconfiguredScenarios;

/**
 * Predefined scenario.ś
 */
class PredefinedScenario implements \JsonSerializable {

	/**
	 * @var string
	 */
	private $category;

	/**
	 * @var string
	 */
	private $name;

	/**
	 * @var string
	 */
	private $description;

	/**
	 * @var string
	 */
	private $documentation_url;

	/**
	 * @var string
	 */
	private $rules_json;

	/**
	 * @var bool
	 */
	private $available;

	/**
	 * @var string
	 */
	private $reason_for_unavailability;

	/**
	 * @var string
	 */
	private $requirements;

	/**
	 * PredefinedScenario constructor.
	 *
	 * @param string $category .
	 * @param string $name .
	 * @param string $description .
	 * @param string $documentation_url .
	 * @param string $rules_json .
	 * @param bool   $available .
	 * @param string $reason_for_unavailability .
	 * @param string $requirements .
	 */
	public function __construct( $category, $name, $description, $documentation_url, $rules_json, $available = true, $reason_for_unavailability = '', $requirements = '' ) {
		$this->category                  = $category;
		$this->name                      = $name;
		$this->description               = $description;
		$this->documentation_url         = $documentation_url;
		$this->rules_json                = $rules_json;
		$this->available                 = $available;
		$this->reason_for_unavailability = $reason_for_unavailability;
		$this->requirements              = $requirements;
	}

	/**
	 * @return string
	 */
	public function get_category() {
		return $this->category;
	}

	/**
	 * @return string
	 */
	public function get_name() {
		return $this->name;
	}

	/**
	 * @return string
	 */
	public function get_description() {
		return $this->description;
	}

	/**
	 * @return string
	 */
	public function get_documentation_url() {
		return $this->documentation_url;
	}

	/**
	 * @return string
	 */
	public function get_rules_json() {
		return $this->rules_json;
	}

	/**
	 * @return bool
	 */
	public function is_available(): bool {
		return $this->available;
	}

	/**
	 * @return string
	 */
	public function get_reason_for_unavailability(): string {
		return $this->reason_for_unavailability;
	}

	/**
	 * @return string
	 */
	public function get_requirements(): string {
		return $this->requirements;
	}

	/**
	 * @return array
	 */
	public function jsonSerialize(): array {
		return [
			'category'                  => $this->category,
			'name'                      => $this->name,
			'description'               => $this->description,
			'documentation_url'         => $this->documentation_url,
			'rules_json'                => $this->rules_json,
			'available'                 => $this->available,
			'reason_for_unavailability' => $this->reason_for_unavailability,
			'requirements'              => $this->requirements,
			'rules_count'               => $this->get_rules_count(),
		];
	}

	/**
	 * @return int
	 */
	private function get_rules_count() {
		$rules = json_decode( $this->rules_json, true );

		return count( $rules );
	}

}
AjaxTracker.php                                                                                                                                                                                                                                                1378          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/PreconfiguredScenarios/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class AjaxTracker
 *
 * @package WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker
 */

namespace WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can handle Ajax requests for predefined scenarios tracking.
 */
class AjaxTracker implements Hookable {

	const AJAX_ACTION = 'flexible_shipping_predefined_scenario_tracking';

	/**
	 * .
	 */
	public function hooks() {
		add_action( 'wp_ajax_' . self::AJAX_ACTION, [ $this, 'handle_ajax' ] );
	}

	/**
	 * @internal
	 */
	public function handle_ajax() {
		check_ajax_referer( self::AJAX_ACTION, 'security' );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$tracking_data = new TrackingData();
		$action        = isset( $_REQUEST['tracking_action'] ) ? sanitize_key( wp_unslash( $_REQUEST['tracking_action'] ) ) : '';
		$scenario      = isset( $_REQUEST['scenario'] ) ? sanitize_key( wp_unslash( $_REQUEST['scenario'] ) ) : '';

		if ( 'count_scenario' === $action ) {
			if ( $scenario ) {
				$tracking_data->increase_scenario_use_count( $scenario );
			}
		}
		if ( 'save_scenario' === $action ) {
			$tracking_data->increase_saved_scenarios();
		}
		if ( 'scenario_unavailable' === $action ) {
			$tracking_data->increase_scenario_unavailable_count( $scenario );
		}

		wp_send_json_success();
	}


}
Tracker.php                                                                                                                                                                                                                                                    830           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/PreconfiguredScenarios/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class Tracker
 *
 * @package WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker
 */

namespace WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can append data to tracker.
 */
class Tracker implements Hookable {

	const TRACKER_DATA_FILTER_PRIORITY = \WPDesk_Flexible_Shipping_Tracker::TRACKER_DATA_FILTER_PRIORITY + 1;

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_data', array( $this, 'append_data' ), self::TRACKER_DATA_FILTER_PRIORITY );
	}

	/**
	 * .
	 *
	 * @param array $data .
	 *
	 * @retrun array
	 */
	public function append_data( $data ) {
		$tracking_data = new TrackingData();

		$data['flexible_shipping']['preconfigured_scenarios'] = $tracking_data->get_tracking_data();

		return $data;
	}

}
TrackingData.php                                                                                                                                                                                                                                               2685          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/PreconfiguredScenarios/Tracker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <?php
/**
 * Class TrackingData
 *
 * @package WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker
 */

namespace WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\Tracker;

/**
 * Can provide preconfigured scenarios tracking data.
 */
class TrackingData {

	const OPTION_NAME = 'fs-predefined-scenarios-tracking-data';
	const SCENARIO_USED = 'scenario_used';
	const SCENARIO_COUNT = 'scenario_count';
	const SAVED_SCENARIOS = 'saved_scenarios';
	const UNAVAILABLE_SCENARIOS = 'unavailable_scenarios';

	/**
	 * .
	 */
	public function increase_saved_scenarios() {
		$tracking_data = $this->get_tracking_data();
		$tracking_data[ self::SAVED_SCENARIOS ]++;
		$this->save_tracking_data( $tracking_data );
	}

	/**
	 * @param string $scenario .
	 */
	public function increase_scenario_use_count( $scenario ) {
		$tracking_data = $this->get_tracking_data();
		$tracking_data[ self::SCENARIO_COUNT ][ $scenario ] = isset( $tracking_data[ self::SCENARIO_COUNT ][ $scenario ] ) ? (int) $tracking_data[ self::SCENARIO_COUNT ][ $scenario ] + 1 : 1;
		$this->save_tracking_data( $tracking_data );
		$this->set_scenario_used_if_not_set();
	}

	/**
	 * @param string $scenario .
	 */
	public function increase_scenario_unavailable_count( $scenario ) {
		$tracking_data = $this->get_tracking_data();
		$tracking_data[ self::UNAVAILABLE_SCENARIOS ][ $scenario ] = isset( $tracking_data[ self::UNAVAILABLE_SCENARIOS ][ $scenario ] ) ? (int) $tracking_data[ self::UNAVAILABLE_SCENARIOS ][ $scenario ] + 1 : 1;
		$this->save_tracking_data( $tracking_data );
	}

	/**
	 * .
	 */
	public function set_scenario_used_if_not_set() {
		$tracking_data = $this->get_tracking_data();
		if ( 'yes' !== $tracking_data[ self::SCENARIO_USED ] ) {
			$tracking_data[ self::SCENARIO_USED ] = 'yes';
			$this->save_tracking_data( $tracking_data );
		}
	}

	/**
	 * @return array
	 */
	public function get_tracking_data() {
		$tracking_data = get_option( self::OPTION_NAME );

		$tracking_data = is_array( $tracking_data ) ? $tracking_data : [
			self::SCENARIO_USED  => 'no',
			self::SCENARIO_COUNT => [],
		];

		if ( ! isset( $tracking_data[ self::SCENARIO_USED ] ) ) {
			$tracking_data[ self::SCENARIO_USED ] = 'no';
		}

		if ( ! isset( $tracking_data[ self::SAVED_SCENARIOS ] ) ) {
			$tracking_data[ self::SAVED_SCENARIOS ] = 0;
		}

		if ( ! isset( $tracking_data[ self::SCENARIO_COUNT ] ) || ! is_array( $tracking_data[ self::SCENARIO_COUNT ] ) ) {
			$tracking_data[ self::SCENARIO_COUNT ] = [];
		}

		return $tracking_data;
	}

	/**
	 * @param array $tracking_data .
	 */
	private function save_tracking_data( array $tracking_data ) {
		update_option( self::OPTION_NAME, $tracking_data, false );
	}

}
RoundingPrecision.php                                                                                                                                                                                                                                          2771          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * Class RoundingPrecision
 *
 * @package WPDesk\FS\TableRate\Rule
 */

namespace WPDesk\FS\TableRate\Rule;

use WPDesk\FS\TableRate\Rule\Condition\Condition;
use WPDesk\FS\TableRate\Rule\Condition\Weight;

/**
 * Can calculate rounding precision from conditions settings.
 */
class RoundingPrecision {
	const CONDITION_ID = 'condition_id';

	/**
	 * @var Rule[]
	 */
	private $rules;

	/**
	 * @var Condition[]
	 */
	private $available_conditions;

	/**
	 * @param Rule[]      $rules .
	 * @param Condition[] $available_conditions .
	 */
	public function __construct( array $rules, array $available_conditions ) {
		$this->rules = $rules;
		$this->available_conditions = $available_conditions;
	}

	/**
	 * @param string $condition_id .
	 */
	public function calculate_max_precision_for_condition( $condition_id ) {
		$max_precision = 0;
		foreach ( $this->rules as $prepared_rule ) {
			$max_precision = max( $max_precision, $this->get_max_precision_for_conditions( $prepared_rule, $condition_id ) );
		}

		return $max_precision;
	}

	/**
	 * @param Rule   $prepared_rule .
	 * @param string $condition_id .
	 *
	 * @return int
	 */
	private function get_max_precision_for_conditions( $prepared_rule, $condition_id ) {
		$max_precision = 0;
		if ( $prepared_rule->has_rule_conditions() ) {
			$rule_settings = $prepared_rule->get_rules_settings();
			foreach ( $rule_settings['conditions'] as $condition_settings ) {
				$max_precision = max( $max_precision, $this->get_max_precision_for_single_condition( $condition_settings, $condition_id ) );
			}
		}

		return $max_precision;
	}

	/**
	 * @param array  $condition_settings .
	 * @param string $condition_id .
	 *
	 * @return int mixed
	 */
	private function get_max_precision_for_single_condition( $condition_settings, $condition_id ) {
		$max_precision = 0;
		if ( isset( $condition_settings[ self::CONDITION_ID ], $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ] )
			&& $condition_id === $condition_settings[ self::CONDITION_ID ]
		) {
			foreach ( $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ]->get_fields() as $field ) {
				$max_precision = max( $max_precision, $this->get_precision_for_field( $condition_settings, $field->get_name() ) );
			}
		}

		return $max_precision;
	}

	/**
	 * @param array  $condition_settings .
	 * @param string $field_name .
	 *
	 * @return int
	 */
	private function get_precision_for_field( $condition_settings, $field_name ) {
		$field_precision = 0;
		if ( isset( $condition_settings[ $field_name ] ) ) {
			$parts = explode( '.', $condition_settings[ $field_name ] );
			$field_precision = 0;
			if ( isset( $parts[1] ) ) {
				$field_precision = strlen( $parts[1] );
			}
		}

		return $field_precision;
	}

}
Rule.php                                                                                                                                                                                                                                                       7595          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * Class Rule
 *
 * @package WPDesk\FS\TableRate\Calculate
 */

namespace WPDesk\FS\TableRate\Rule;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use Psr\Log\LoggerInterface;
use WPDesk\FS\TableRate\Rule\Condition\AbstractCondition;
use WPDesk\FS\TableRate\Rule\Condition\Condition;
use WPDesk\FS\TableRate\Rule\Cost\AbstractAdditionalCost;
use WPDesk\FS\TableRate\Rule\Cost\AdditionalCost;
use WPDesk\FS\TableRate\Rule\ShippingContents\ShippingContents;
use WPDesk\FS\TableRate\Rule\SpecialAction\None;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialAction;

/**
 * Single rule.
 */
class Rule {

	const CONDITION_ID     = 'condition_id';
	const CONDITIONS       = 'conditions';
	const ADDITIONAL_COSTS = 'additional_costs';
	const SPECIAL_ACTION   = 'special_action';

	/**
	 * @var array
	 */
	private $rule_settings;

	/**
	 * @var Condition[]
	 */
	private $available_conditions;

	/**
	 * @var Field[]
	 */
	private $cost_fields;

	/**
	 * @var AdditionalCost[]
	 */
	private $available_additional_costs;

	/**
	 * @var SpecialAction[]
	 */
	private $available_special_actions;

	/**
	 * @var int
	 */
	private $cost_rounding_precision;

	/**
	 * @var MethodSettings
	 */
	private $method_settings;

	/**
	 * Rule constructor.
	 *
	 * @param array            $rule_settings              .
	 * @param Condition[]      $available_conditions       .
	 * @param Field[]          $cost_fields                .
	 * @param AdditionalCost[] $available_additional_costs .
	 * @param SpecialAction[]  $available_special_actions  .
	 * @param int              $cost_rounding_precision    .
	 * @param MethodSettings   $method_settings            .
	 */
	public function __construct(
		$rule_settings,
		array $available_conditions,
		array $cost_fields,
		array $available_additional_costs,
		array $available_special_actions,
		$cost_rounding_precision,
		MethodSettings $method_settings
	) {
		$this->rule_settings              = $rule_settings;
		$this->available_conditions       = $available_conditions;
		$this->cost_fields                = $cost_fields;
		$this->available_additional_costs = $available_additional_costs;
		$this->available_special_actions  = $available_special_actions;
		$this->cost_rounding_precision    = $cost_rounding_precision;
		$this->method_settings            = $method_settings;
	}

	/**
	 * @param ShippingContents $shipping_contents .
	 *
	 * @return ShippingContents
	 */
	public function process_shipping_contents( ShippingContents $shipping_contents ): ShippingContents {
		if ( $this->has_rule_conditions() ) {
			foreach ( $this->rule_settings[ self::CONDITIONS ] as $condition_settings_key => $condition_settings ) {
				if ( isset( $condition_settings[ self::CONDITION_ID ], $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ] ) ) {
					$condition         = $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ];
					$shipping_contents = $condition->process_shipping_contents( $shipping_contents, $condition_settings );
				}
			}
		}

		return $shipping_contents;
	}

	/**
	 * @param ShippingContents $shipping_contents .
	 * @param LoggerInterface  $logger            .
	 *
	 * @return bool
	 */
	public function is_rule_triggered( ShippingContents $shipping_contents, LoggerInterface $logger ): bool {
		$triggered = true;

		if ( $this->has_rule_conditions() ) {
			foreach ( $this->rule_settings[ self::CONDITIONS ] as $condition_settings_key => $condition_settings ) {
				if ( isset( $condition_settings[ self::CONDITION_ID ], $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ] ) ) {

					/** @var AbstractCondition $condition */
					$condition = $this->available_conditions[ $condition_settings[ self::CONDITION_ID ] ];

					$condition->set_rule( $this );

					$condition_triggered = $condition->is_condition_matched_with_method_settings( $condition_settings, $shipping_contents, $logger, $this->method_settings );
					$triggered           = $triggered && $condition_triggered;
				}

				if ( ! $triggered ) {
					break;
				}
			}
		}

		return $triggered;
	}

	/**
	 * @return bool
	 */
	public function has_rule_conditions(): bool {
		return isset( $this->rule_settings[ self::CONDITIONS ] );
	}

	/**
	 * @param ShippingContents $shipping_contents .
	 * @param LoggerInterface  $logger            .
	 *
	 * @return float
	 */
	public function get_rule_cost( ShippingContents $shipping_contents, LoggerInterface $logger ): float {
		// Translators: items.
		$logger->debug( sprintf( __( '   Matched items: %1$s', 'flexible-shipping' ), $this->format_contents_for_log( $shipping_contents ) ) );

		// Translators: items costs.
		$logger->debug( sprintf( __( '   Matched items cost: %1$d %2$s', 'flexible-shipping' ), $shipping_contents->get_contents_cost(), $shipping_contents->get_currency() ) );

		// Translators: items weight.
		$logger->debug( sprintf( __( '   Matched items weight: %1$s', 'flexible-shipping' ), wc_format_weight( $shipping_contents->get_contents_weight() ) ) );
		$logger->debug( sprintf( '   %1$s', __( 'Rule costs:', 'flexible-shipping' ) ) );

		$cost = 0.0;

		foreach ( $this->cost_fields as $cost_field ) {
			if ( isset( $this->rule_settings[ $cost_field->get_name() ] ) ) {
				$field_cost = (float) $this->rule_settings[ $cost_field->get_name() ];
				$logger->debug( sprintf( '    %1$s: %2$s', $cost_field->get_label(), $field_cost ) );
				$cost += $field_cost;
			}
		}

		$cost += $this->get_additional_costs( $shipping_contents, $logger );

		return $cost;
	}

	/**
	 * @param ShippingContents $shipping_contents
	 *
	 * @return string
	 */
	private function format_contents_for_log( ShippingContents $shipping_contents ): string {
		$formatted_contents = [];
		foreach ( $shipping_contents->get_contents() as $item ) {
			$formatted_contents[] = sprintf( '%1$s (qty: %2$d)', $item['data']->get_name(), $item['quantity'] );
		}

		return implode( ', ', $formatted_contents );
	}

	/**
	 * @return SpecialAction
	 */
	public function get_special_action() {
		if ( isset( $this->rule_settings[ self::SPECIAL_ACTION ], $this->available_special_actions[ $this->rule_settings[ self::SPECIAL_ACTION ] ] ) ) {
			return $this->available_special_actions[ $this->rule_settings[ self::SPECIAL_ACTION ] ];
		}

		return new None();
	}

	/**
	 * @param ShippingContents $shipping_contents .
	 * @param LoggerInterface  $logger            .
	 *
	 * @return float
	 */
	private function get_additional_costs( ShippingContents $shipping_contents, LoggerInterface $logger ): float {
		$additional_costs = 0.0;

		$additional_costs_settings = $this->rule_settings[ self::ADDITIONAL_COSTS ] ?? [];
		foreach ( $additional_costs_settings as $additional_cost_setting ) {
			if ( isset( $this->available_additional_costs[ $additional_cost_setting['based_on'] ] ) ) {
				/** @var AbstractAdditionalCost $additional_cost */
				$additional_cost = $this->available_additional_costs[ $additional_cost_setting['based_on'] ];
				$additional_cost->set_rule( $this );

				$additional_costs += $additional_cost->calculate_cost_with_method_settings( $shipping_contents, $additional_cost_setting, $logger, $this->method_settings );
			}
		}

		return $additional_costs;
	}

	/**
	 * @return array
	 */
	public function get_rules_settings(): array {
		return $this->rule_settings;
	}

	/**
	 * @param int $rule_number .
	 *
	 * @return string
	 */
	public function format_for_log( $rule_number ) {
		// Translators: rule number.
		return sprintf( __( 'Rule %1$s:', 'flexible-shipping' ), $rule_number );
	}
}
SettingsProcessor.php                                                                                                                                                                                                                                          5928          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/Settings                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
/**
 * Class SettingsProcessor
 *
 * @package WPDesk\FS\TableRate\Rule\Settings
 */

namespace WPDesk\FS\TableRate\Rule\Settings;

use FSVendor\WPDesk\Forms\Field;
use WPDesk\Forms\Field\InputNumberField;
use WPDesk\FS\TableRate\Rule\Condition\Condition;
use WPDesk\FS\TableRate\Rule\Condition\ConditionsFactory;
use WPDesk\FS\TableRate\Rule\Cost\Additional;
use WPDesk\FS\TableRate\Rule\Cost\AdditionalCost;
use WPDesk\FS\TableRate\Rule\Cost\Cost;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialAction;

/**
 * Can process rules settings.
 */
class SettingsProcessor {

	/**
	 * @var array
	 */
	private $posted_settings;

	/**
	 * @var Condition[]
	 */
	private $conditions;

	/**
	 * @var Field[]
	 */
	private $costs_fields;

	/**
	 * @var Field[]
	 */
	private $additional_costs_fields;

	/**
	 * @var Field[]
	 */
	private $special_action_fields;

	/**
	 * SettingsProcessor constructor.
	 *
	 * @param array       $posted_settings .
	 * @param Condition[] $conditions .
	 * @param Field[]     $costs_fields .
	 * @param Field[]     $additional_costs_fields .
	 * @param Field[]     $special_action_fields .
	 */
	public function __construct(
		array $posted_settings,
		array $conditions,
		array $costs_fields,
		array $additional_costs_fields,
		array $special_action_fields
	) {
		$this->posted_settings         = $posted_settings;
		$this->conditions              = $conditions;
		$this->costs_fields            = $costs_fields;
		$this->additional_costs_fields = $additional_costs_fields;
		$this->special_action_fields   = $special_action_fields;
	}

	/**
	 * @return array
	 */
	public function prepare_settings() {
		$settings = [];

		foreach ( $this->posted_settings as $rule_id => $rule_posted_settings ) {
			$rule_settings = [
				'conditions' => $this->prepare_conditions( $rule_posted_settings['conditions'] ?? [] ),
			];
			$rule_settings = $this->prepare_costs( $rule_settings, $rule_posted_settings );
			$rule_settings = $this->prepare_costs_additional( $rule_settings, $rule_posted_settings );
			$rule_settings = $this->prepare_special_action( $rule_settings, $rule_posted_settings );
			$settings[] = $rule_settings;
		}

		return $settings;
	}

	/**
	 * @param array $rule_settings .
	 * @param array $rule_posted_settings .
	 *
	 * @return array
	 */
	private function prepare_costs( array $rule_settings, array $rule_posted_settings ) {
		foreach ( $this->costs_fields as $field ) {
			$rule_settings_value = isset( $rule_posted_settings[ $field->get_name() ] ) ? $rule_posted_settings[ $field->get_name() ] : '';
			$rule_settings[ $field->get_name() ] = $this->sanitize_and_format_field( $rule_settings_value, $field );
		}
		return $rule_settings;
	}

	/**
	 * @param array $rule_settings .
	 * @param array $rule_posted_settings .
	 *
	 * @return array
	 */
	private function prepare_costs_additional( array $rule_settings, array $rule_posted_settings ) {
		$rule_settings['additional_costs'] = [];
		if ( isset( $rule_posted_settings['additional_costs'] ) && is_array( $rule_posted_settings['additional_costs'] ) ) {
			foreach ( $rule_posted_settings['additional_costs'] as $posted_additional_cost ) {
				$additional_cost = [];
				foreach ( $this->additional_costs_fields as $field ) {
					$additional_cost_value = isset( $posted_additional_cost[ $field->get_name() ] ) ? $posted_additional_cost[ $field->get_name() ] : '';
					$additional_cost[ $field->get_name() ] = $this->sanitize_and_format_field( $additional_cost_value, $field );
				}
				$rule_settings['additional_costs'][] = $additional_cost;
			}
		}

		return $rule_settings;
	}

	/**
	 * @param array $rule_settings .
	 * @param array $rule_posted_settings .
	 *
	 * @return array
	 */
	private function prepare_special_action( array $rule_settings, array $rule_posted_settings ) {
		foreach ( $this->special_action_fields as $field ) {
			$rule_settings[ $field->get_name() ] = isset( $rule_posted_settings[ $field->get_name() ] ) ? sanitize_text_field( $rule_posted_settings[ $field->get_name() ] ) : '';
		}

		return $rule_settings;
	}

	/**
	 * @param array $rule_conditions .
	 *
	 * @return array
	 */
	private function prepare_conditions( array $rule_conditions ) {
		$conditions = [];
		foreach ( $rule_conditions as $rule_condition ) {
			$sanitized_condition = sanitize_key( $rule_condition['condition_id'] ?? [] );
			$condition_normalized = [ 'condition_id' => $sanitized_condition ];
			if ( isset( $this->conditions[ $sanitized_condition ] ) ) {
				list( $rule_condition, $condition_normalized ) = $this->prepare_condition_fields( $sanitized_condition, $rule_condition, $condition_normalized );
				$conditions[] = $condition_normalized;
			}
		}

		return $conditions;
	}

	/**
	 * @param string $sanitized_condition .
	 * @param array  $rule_condition .
	 * @param array  $condition_normalized .
	 *
	 * @return array
	 */
	private function prepare_condition_fields( $sanitized_condition, $rule_condition, array $condition_normalized ) {
		foreach ( $this->conditions[ $sanitized_condition ]->get_fields() as $field ) {
			$rule_condition_value = isset( $rule_condition[ $field->get_name() ] ) ? $rule_condition[ $field->get_name() ] : '';
			$condition_normalized[ $field->get_name() ] = $this->sanitize_and_format_field( $rule_condition_value, $field );
		}

		return [ $rule_condition, $condition_normalized ];
	}

	/**
	 * @param string|array $value .
	 * @param Field        $field .
	 */
	private function sanitize_and_format_field( $value, $field ) {
		if ( $field instanceof Field\InputNumberField ) {
			return $this->format_number_field( sanitize_text_field( $value ) );
		} else {
			return $field->is_multiple() ? array_map( 'sanitize_text_field', is_array( $value ) ? $value : [] ) : sanitize_text_field( $value );
		}
	}

	/**
	 * @param string $value .
	 *
	 * @return string
	 */
	private function format_number_field( $value ) {
		return str_replace( ',', '.', $value );
	}

}
DestinationAddress.php                                                                                                                                                                                                                                         2092          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/ShippingContents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class DestinationAddress
 *
 * @package WPDesk\FS\TableRate\Rule\ShippingContents
 */

namespace WPDesk\FS\TableRate\Rule\ShippingContents;

/**
 * Destination address.
 */
class DestinationAddress {

	/**
	 * @var string
	 */
	private $country;

	/**
	 * @var string
	 */
	private $state;

	/**
	 * @var string
	 */
	private $postcode;

	/**
	 * @var string
	 */
	private $city;

	/**
	 * @var string
	 */
	private $address;

	/**
	 * @var string
	 */
	private $address_1;

	/**
	 * @var string
	 */
	private $address_2;

	/**
	 * DestinationAddress constructor.
	 *
	 * @param string $country .
	 * @param string $state .
	 * @param string $postcode .
	 * @param string $city .
	 * @param string $address .
	 * @param string $address_1 .
	 * @param string $address_2 .
	 */
	public function __construct( $country, $state, $postcode, $city, $address, $address_1, $address_2 ) {
		$this->country   = $country;
		$this->state     = $state;
		$this->postcode  = $postcode;
		$this->city      = $city;
		$this->address   = $address;
		$this->address_1 = $address_1;
		$this->address_2 = $address_2;
	}

	/**
	 * @return string
	 */
	public function get_country() {
		return $this->country;
	}

	/**
	 * @return string
	 */
	public function get_state() {
		return $this->state;
	}

	/**
	 * @return string
	 */
	public function get_postcode() {
		return $this->postcode;
	}

	/**
	 * @return string
	 */
	public function get_city() {
		return $this->city;
	}

	/**
	 * @return string
	 */
	public function get_address() {
		return $this->address;
	}

	/**
	 * @return string
	 */
	public function get_address_1() {
		return $this->address_1;
	}

	/**
	 * @return string
	 */
	public function get_address_2() {
		return $this->address_2;
	}

	/**
	 * @return string
	 */
	public function prepare_data_for_log() {
		return sprintf(
			'country: %1$s, state: %2$s, postcode: %3$s, city: %4$s, address: %5$s, address_1: %6$s, address_2: %7$s',
			$this->country,
			$this->state,
			$this->postcode,
			$this->city,
			$this->address,
			$this->address_1,
			$this->address_2
		);
	}

}
DestinationAddressFactory.php                                                                                                                                                                                                                                  915           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/ShippingContents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class DestinationAddressFactory
 *
 * @package WPDesk\FS\TableRate\Rule\ShippingContents
 */

namespace WPDesk\FS\TableRate\Rule\ShippingContents;

/**
 * Can create destination address.
 */
class DestinationAddressFactory {

	/**
	 * @param array $destination .
	 *
	 * @return DestinationAddress
	 */
	public static function create_from_package_destination( array $destination ) {
		return new DestinationAddress(
			isset( $destination['country'] ) ? $destination['country'] : '',
			isset( $destination['state'] ) ? $destination['state'] : '',
			isset( $destination['postcode'] ) ? $destination['postcode'] : '',
			isset( $destination['city'] ) ? $destination['city'] : '',
			isset( $destination['address'] ) ? $destination['address'] : '',
			isset( $destination['address_1'] ) ? $destination['address_1'] : '',
			isset( $destination['address_2'] ) ? $destination['address_2'] : ''
		);
	}

}
ShippingContents.php                                                                                                                                                                                                                                           1316          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/ShippingContents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Interface ShippingContents
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Rule\ShippingContents;

use WPDesk\FS\TableRate\Rule\ContentsFilter;

/**
 * Can provide shipping contents.
 */
interface ShippingContents {

	/**
	 * @param int $weight_rounding_precision .
	 */
	public function set_weight_rounding_precision( $weight_rounding_precision );

	/**
	 * @return array
	 */
	public function get_contents();

	/**
	 * @return float
	 */
	public function get_contents_cost();

	/**
	 * @param bool $round .
	 *
	 * @return float
	 */
	public function get_contents_weight( $round = true );

	/**
	 * @return int
	 */
	public function get_contents_items_count();

	/**
	 * @param ContentsFilter $contents_filter .
	 */
	public function filter_contents( ContentsFilter $contents_filter );

	/**
	 * Returns non filtered contents.
	 *
	 * @return array
	 */
	public function get_non_filtered_contents();

	/**
	 * Reset contents to non filtered.
	 *
	 * @return array
	 */
	public function reset_contents();

	/**
	 * @return DestinationAddress
	 */
	public function get_destination_address();

	/**
	 * @return string
	 */
	public function get_currency();

	public function set_meta( ShippingContentsMeta $meta );

	public function get_meta( string $key ): ?ShippingContentsMeta;
}
ShippingContentsImplementation.php                                                                                                                                                                                                                             5269          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/ShippingContents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class ShippingContentsImplementation
 *
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate\Rule\ShippingContents;

use WPDesk\FS\TableRate\Rule\ContentsFilter;

/**
 * Can provide shipping contents.
 */
class ShippingContentsImplementation implements ShippingContents {

	/**
	 * @var array
	 */
	private $non_filtered_contents;

	/**
	 * @var array
	 */
	private $contents;

	/**
	 * @var bool
	 */
	private $prices_includes_tax;

	/**
	 * @var float
	 */
	private $contents_cost;

	/**
	 * @var float
	 */
	private $contents_weight;

	/**
	 * @var int
	 */
	private $cost_rounding_precision;

	/**
	 * @var DestinationAddress
	 */
	private $destination_address;

	/**
	 * @var string
	 */
	private $currency;

	/**
	 * @var int
	 */
	private $weight_rounding_precision = 6;

	/**
	 * @var ShippingContentsMeta[]
	 */
	private $meta = [];

	/**
	 * ShippingContents constructor.
	 *
	 * @param array              $contents                .
	 * @param bool               $prices_includes_tax     .
	 * @param int                $cost_rounding_precision .
	 * @param DestinationAddress $destination_address     .
	 * @param string             $currency                .
	 */
	public function __construct( $contents, $prices_includes_tax, $cost_rounding_precision, $destination_address, $currency ) {
		$this->contents                = $contents;
		$this->non_filtered_contents   = $contents;
		$this->prices_includes_tax     = $prices_includes_tax;
		$this->cost_rounding_precision = $cost_rounding_precision;
		$this->destination_address     = $destination_address;
		$this->currency                = $currency;
	}

	/**
	 * @param int $weight_rounding_precision .
	 */
	public function set_weight_rounding_precision( $weight_rounding_precision ) {
		$this->weight_rounding_precision = $weight_rounding_precision;
	}

	/**
	 * @return array
	 */
	public function get_contents() {
		return $this->contents;
	}

	/**
	 * @return float
	 */
	public function get_contents_cost() {
		if ( ! isset( $this->contents_cost ) ) {
			$this->contents_cost = $this->calculate_contents_cost();
		}

		return round( $this->contents_cost, $this->cost_rounding_precision );
	}

	/**
	 * @param bool $round .
	 *
	 * @return float
	 */
	public function get_contents_weight( $round = true ) {
		if ( ! isset( $this->contents_weight ) ) {
			$this->contents_weight = $this->calculate_contents_weight();
		}

		if ( $round ) {
			return round( $this->contents_weight, $this->weight_rounding_precision );
		}

		return $this->contents_weight;
	}

	/**
	 * @return float
	 */
	private function calculate_contents_weight() {
		$weight = 0.0;

		foreach ( $this->contents as $item ) {
			$weight += $this->get_item_weight( $item );
		}

		return $weight;
	}

	/**
	 * @param array $item .
	 *
	 * @return float
	 */
	private function get_item_weight( $item ) {
		return (float) $item['data']->get_weight() * (float) $item['quantity'];
	}

	/**
	 * @return float
	 */
	private function calculate_contents_cost() {
		$cost = 0.0;
		foreach ( $this->contents as $item ) {
			$cost += $this->get_item_cost( $item );
		}

		return $cost;
	}

	/**
	 * @param array $item .
	 *
	 * @return float
	 */
	private function get_item_cost( $item ) {
		$line_total = 0.0;
		if ( $this->prices_includes_tax ) {
			if ( isset( $item['line_total'] ) ) {
				$line_total = (float) $item['line_total'];
			}
			if ( isset( $item['line_tax'] ) ) {
				$line_total += (float) $item['line_tax'];
			}
		} else {
			if ( isset( $item['line_total'] ) ) {
				$line_total = (float) $item['line_total'];
			}
		}

		return $line_total;
	}

	/**
	 * @return int
	 */
	public function get_contents_items_count() {
		$items_count = 0;
		foreach ( $this->contents as $item ) {
			$items_count += $item['quantity'];
		}

		return $items_count;
	}

	/**
	 * @param ContentsFilter $contents_filter .
	 */
	public function filter_contents( ContentsFilter $contents_filter ) {
		$this->contents        = $contents_filter->get_filtered_contents( $this->contents );
		$this->contents_cost   = null;
		$this->contents_weight = null;

		do_action( 'flexible-shipping/shipping-contents/filter/after', $this );
	}

	/**
	 * Returns non filtered contents.
	 *
	 * @return array
	 */
	public function get_non_filtered_contents() {
		return $this->non_filtered_contents;
	}

	/**
	 * Reset contents to non filtered.
	 *
	 * @return void
	 */
	public function reset_contents() {
		$this->contents        = $this->non_filtered_contents;
		$this->contents_cost   = null;
		$this->contents_weight = null;

		do_action( 'flexible-shipping/shipping-contents/reset/after', $this );
	}

	/**
	 * @return DestinationAddress
	 */
	public function get_destination_address() {
		return $this->destination_address;
	}

	/**
	 * @return string
	 */
	public function get_currency() {
		return $this->currency;
	}

	/**
	 * @param ShippingContentsMeta $meta .
	 *
	 * @return $this
	 */
	public function set_meta( ShippingContentsMeta $meta ): ShippingContentsImplementation {
		$this->meta[ $meta->get_key() ] = $meta;

		return $this;
	}

	/**
	 * @param string $key
	 *
	 * @return ShippingContentsMeta|null
	 */
	public function get_meta( string $key ): ?ShippingContentsMeta {
		return $this->meta[ $key ] ?? null;
	}
}
ShippingContentsMeta.php                                                                                                                                                                                                                                       597           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/ShippingContents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
/**
 * Class ShippingContentsMeta
 */

namespace WPDesk\FS\TableRate\Rule\ShippingContents;

/**
 * Shipping Contents Meta.
 */
class ShippingContentsMeta {

	/**
	 * @var string
	 */
	private $key;

	/**
	 * @var mixed
	 */
	private $value;

	/**
	 * @param string $key   .
	 * @param mixed  $value .
	 */
	public function __construct( string $key, $value ) {
		$this->key   = $key;
		$this->value = $value;
	}

	/**
	 * @return string
	 */
	public function get_key(): string {
		return $this->key;
	}

	/**
	 * @return mixed
	 */
	public function get_value() {
		return $this->value;
	}
}
AbstractSpecialAction.php                                                                                                                                                                                                                                      1192          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/SpecialAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class AbstractSpecialAction
 *
 * @package WPDesk\FS\TableRate\Rule\SpecialAction
 */

namespace WPDesk\FS\TableRate\Rule\SpecialAction;

/**
 * Abstract special action.
 */
abstract class AbstractSpecialAction implements SpecialAction {

	/**
	 * @var string
	 */
	private $special_action_id;

	/**
	 * @var string
	 */
	private $name;

	/**
	 * @var string
	 */
	private $description;

	/**
	 * AbstractSpecialAction constructor.
	 *
	 * @param string $special_action_id .
	 * @param string $name .
	 * @param string $description .
	 */
	public function __construct( $special_action_id, $name, $description = '' ) {
		$this->special_action_id = $special_action_id;
		$this->name              = $name;
		$this->description       = $description;
	}

	/**
	 * @return string
	 */
	public function get_special_action_id() {
		return $this->special_action_id;
	}

	/**
	 * @return string
	 */
	public function get_name() {
		return $this->name;
	}

	/**
	 * @return string
	 */
	public function get_description() {
		return $this->description;
	}

	/**
	 * @return bool
	 */
	abstract public function is_cancel();

	/**
	 * @return bool
	 */
	abstract public function is_stop();

}
None.php                                                                                                                                                                                                                                                       500           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/SpecialAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class None
 *
 * @package WPDesk\FS\TableRate\Rule\SpecialAction
 */

namespace WPDesk\FS\TableRate\Rule\SpecialAction;

/**
 * None special action.
 */
class None extends AbstractSpecialAction {

	/**
	 * None constructor.
	 */
	public function __construct() {
		parent::__construct( 'none', __( 'None', 'flexible-shipping' ) );
	}

	/**
	 * @inheritDoc
	 */
	public function is_cancel() {
		return false;
	}

	/**
	 * @inheritDoc
	 */
	public function is_stop() {
		return false;
	}
}
SpecialAction.php                                                                                                                                                                                                                                              524           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/SpecialAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Interface SpecialAction
 *
 * @package WPDesk\FS\TableRate\Rule\SpecialAction
 */

namespace WPDesk\FS\TableRate\Rule\SpecialAction;

/**
 * Special action interface.
 */
interface SpecialAction {

	/**
	 * @return string
	 */
	public function get_special_action_id();

	/**
	 * @return string
	 */
	public function get_name();

	/**
	 * @return string
	 */
	public function get_description();

	/**
	 * @return bool
	 */
	public function is_cancel();

	/**
	 * @return bool
	 */
	public function is_stop();

}
SpecialActionFactory.php                                                                                                                                                                                                                                       640           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/SpecialAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class SpecialActionFactory
 *
 * @package WPDesk\FS\TableRate\Rule\SpecialAction
 */

namespace WPDesk\FS\TableRate\Rule\SpecialAction;

/**
 * Can provide special actions.
 */
class SpecialActionFactory {

	/**
	 * @return SpecialAction[]
	 */
	public function get_special_actions() {
		$none = new None();
		$special_actions = array(
			$none->get_special_action_id() => $none,
		);

		$special_actions = apply_filters( 'flexible_shipping_special_actions', $special_actions );

		return array_filter(
			$special_actions,
			function ( $special_action ) {
				return $special_action instanceof SpecialAction;
			}
		);
	}

}
SpecialActionFieldsFactory.php                                                                                                                                                                                                                                 2054          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule/SpecialAction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php
/**
 * Class RuleSpecialActionFieldsFactory
 *
 * @package WPDesk\FS\TableRate\Rule\SpecialAction
 */

namespace WPDesk\FS\TableRate\Rule\SpecialAction;

use FSVendor\WPDesk\Forms\Field;
use FSVendor\WPDesk\Forms\Field\InputTextField;
use FSVendor\WPDesk\Forms\FieldProvider;
use FSVendor\WPDesk\Forms\Renderer\JsonNormalizedRenderer;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialAction;

/**
 * Can create special action fields.
 */
class SpecialActionFieldsFactory implements FieldProvider {

	/**
	 * @var SpecialAction[]
	 */
	private $available_special_actions;

	/**
	 * RuleSpecialActionFieldsFactory constructor.
	 *
	 * @param SpecialAction[] $available_special_actions .
	 */
	public function __construct( array $available_special_actions ) {
		$this->available_special_actions = $available_special_actions;
	}


	/**
	 * @return Field[]
	 */
	public function get_fields() {
		return apply_filters( 'flexible_shipping_rule_special_action_fields', $this->get_built_in_rule_special_actions_fields() );
	}

	/**
	 * .
	 *
	 * @return array
	 */
	public function get_normalized_cost_fields() {
		$normalized_cost_fields = array();
		$renderer               = new JsonNormalizedRenderer();

		return $renderer->render_fields( $this, array() );
	}

	/**
	 * @return Field[]
	 */
	public function get_built_in_rule_special_actions_fields() {
		return array(
			( new Field\SelectField() )
				->set_name( 'special_action' )
				->set_options( $this->get_special_action_options() )
				->add_class( 'hs-beacon-search' )
				->add_class( 'special-action' )
				->add_data( 'beacon_search', __( 'special action', 'flexible-shipping' ) ),
		);
	}

	/**
	 * @return array
	 */
	private function get_special_action_options() {
		$options = array();
		foreach ( $this->available_special_actions as $special_action ) {
			$options[] = array(
				'value'       => $special_action->get_special_action_id(),
				'label'       => $special_action->get_name(),
				'description' => $special_action->get_description(),
			);
		}

		return $options;
	}

}
TrackerData.php                                                                                                                                                                                                                                                6108          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/Rule                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php
/**
 * Class TrackerData
 *
 * @package WPDesk\FS\TableRate\Rule
 */

namespace WPDesk\FS\TableRate\Rule;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Can append rule data to tracker data.
 */
class TrackerData implements Hookable {

	const FIELD_OPERATOR                 = 'operator';
	const FIELD_OPERATOR_COUNT           = 'operator_count';
	const FIELD_CONDITION_OPERATOR_COUNT = 'condition_operator_count';

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'flexible-shipping/tracker/method-rule-data', array( $this, 'append_method_rule_data' ), 10, 2 );
	}

	/**
	 * @param array $tracker_data .
	 * @param array $rule_configuration .
	 *
	 * @return array
	 */
	public function append_method_rule_data( $tracker_data, $rule_configuration ) {

		$conditions = isset( $rule_configuration['conditions'] ) ? $rule_configuration['conditions'] : array( array( 'condition_id' => 'none' ) );
		$tracker_data = $this->append_conditions_data( $tracker_data, $conditions );

		$additional_costs = isset( $rule_configuration['additional_costs'] ) ? $rule_configuration['additional_costs'] : array();
		$tracker_data = $this->append_additional_costs_data( $tracker_data, $additional_costs );

		$special_action = ! empty( $rule_configuration['special_action'] ) ? $rule_configuration['special_action'] : 'none';
		$tracker_data = $this->append_special_action_data( $tracker_data, $special_action );

		if ( ! empty( $rule_configuration['cost_per_order'] ) ) {
			$tracker_data['cost_per_order_count'] ++;
		}

		return $tracker_data;
	}

	/**
	 * @param array $tracker_data .
	 * @param array $conditions .
	 */
	private function append_conditions_data( $tracker_data, $conditions ) {
		$conditions_count = count( $conditions );
		if ( empty( $tracker_data['conditions_per_rule'] ) ) {
			$tracker_data['conditions_per_rule'] = array();
		}
		if ( empty( $tracker_data['conditions_per_rule'][ $conditions_count ] ) ) {
			$tracker_data['conditions_per_rule'][ $conditions_count ] = 0;
		}
		$tracker_data['conditions_per_rule'][ $conditions_count ]++;

		foreach ( $conditions as $condition ) {
			$condition_id = isset( $condition['condition_id'] ) ? $condition['condition_id'] : false;
			if ( $condition_id ) {
				if ( empty( $tracker_data['based_on'][ $condition_id ] ) ) {
					$tracker_data['based_on'][ $condition_id ] = 0;
				}
				$tracker_data['based_on'][ $condition_id ] ++;

				if ( ! empty( $condition['min'] ) ) {
					$tracker_data['min_count']++;
				}

				if ( ! empty( $condition['max'] ) ) {
					$tracker_data['max_count']++;
				}

				if ( ! empty( $condition['shipping_class'] ) ) {
					$shipping_class = $condition['shipping_class'];
					if ( ! in_array( $shipping_class, array( 'all', 'any', 'none' ), true ) ) {
						$shipping_class = 'shipping_class';
					}
					if ( empty( $tracker_data['shipping_class_option'][ $shipping_class ] ) ) {
						$tracker_data['shipping_class_option'][ $shipping_class ] = 0;
					}
					$tracker_data['shipping_class_option'][ $shipping_class ] ++;
				}

				$tracker_data = $this->append_operator_data( $condition, $tracker_data, $condition_id );
			}
		}

		return $tracker_data;
	}

	/**
	 * @param array $tracker_data .
	 * @param array $additional_costs .
	 *
	 * @return array
	 */
	private function append_additional_costs_data( $tracker_data, $additional_costs ) {
		$additional_costs_count = count( $additional_costs );
		if ( empty( $tracker_data['additional_costs_per_rule'] ) ) {
			$tracker_data['additional_costs_per_rule'] = array();
		}
		if ( empty( $tracker_data['additional_costs_per_rule'][ $additional_costs_count ] ) ) {
			$tracker_data['additional_costs_per_rule'][ $additional_costs_count ] = 0;
		}
		$tracker_data['additional_costs_per_rule'][ $additional_costs_count ]++;

		$tracker_data['additional_cost_count'] += $additional_costs_count;

		if ( ! isset( $tracker_data['additional_costs'] ) ) {
			$tracker_data['additional_costs'] = array();
		}

		foreach ( wp_list_pluck( $additional_costs, 'based_on' ) as $based_on ) {
			if ( ! isset( $tracker_data['additional_costs'][ $based_on ] ) ) {
				$tracker_data['additional_costs'][ $based_on ] = 0;
			}

			$tracker_data['additional_costs'][ $based_on ] ++;
		}

		return $tracker_data;
	}

	/**
	 * @param array  $tracker_data .
	 * @param string $special_action .
	 *
	 * @return array
	 */
	private function append_special_action_data( $tracker_data, $special_action ) {
		if ( ! isset( $tracker_data['special_actions'] ) ) {
			$tracker_data['special_actions'] = array();
		}
		if ( ! isset( $tracker_data['special_actions'][ $special_action ] ) ) {
			$tracker_data['special_actions'][ $special_action ] = 0;
		}
		$tracker_data['special_actions'][ $special_action ]++;
		if ( in_array( $special_action, array( 'stop', 'cancel' ), true ) ) {
			$tracker_data[ $special_action . '_count' ]++;
		}

		return $tracker_data;
	}

	/**
	 * @param array  $condition .
	 * @param array  $tracker_data .
	 * @param string $condition_id .
	 *
	 * @return array
	 */
	private function append_operator_data( $condition, array $tracker_data, $condition_id ) {
		if ( ! empty( $condition[ self::FIELD_OPERATOR ] ) ) {
			$operator = $condition[ self::FIELD_OPERATOR ];
			if ( ! isset( $tracker_data[ self::FIELD_OPERATOR_COUNT ] ) ) {
				$tracker_data[ self::FIELD_OPERATOR_COUNT ] = array();
			}
			if ( ! isset( $tracker_data[ self::FIELD_OPERATOR_COUNT ][ $operator ] ) ) {
				$tracker_data[ self::FIELD_OPERATOR_COUNT ][ $operator ] = 0;
			}
			$tracker_data[ self::FIELD_OPERATOR_COUNT ][ $operator ] ++;

			if ( ! isset( $tracker_data[ self::FIELD_CONDITION_OPERATOR_COUNT ] ) ) {
				$tracker_data[ self::FIELD_CONDITION_OPERATOR_COUNT ] = array();
			}
			$condition_operator = $condition_id . '-' . $operator;
			if ( ! isset( $tracker_data[ self::FIELD_CONDITION_OPERATOR_COUNT ][ $condition_operator ] ) ) {
				$tracker_data[ self::FIELD_CONDITION_OPERATOR_COUNT ][ $condition_operator ] = 0;
			}
			$tracker_data[ self::FIELD_CONDITION_OPERATOR_COUNT ][ $condition_operator ] ++;
		}

		return $tracker_data;
	}

}
RulesSettingsFactory.php                                                                                                                                                                                                                                       1016          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php

namespace WPDesk\FS\TableRate;

/**
 * Class RulesSettingsFactory
 *
 * @package WPDesk\FS\TableRate
 */
class RulesSettingsFactory {
	/**
	 * @var SingleRuleSettings[]
	 */
	private $rules = array();

	/**
	 * @param $settings_array
	 *
	 * @return RulesSettingsFactory
	 */
	public static function create_from_array( $settings_array ) {
		$rules_settings = new self();

		foreach ( $settings_array as $single_rule_settings_row ) {
			$rules_settings->add_single_rule_settings( new SingleRuleSettings( $single_rule_settings_row ) );
		}

		return $rules_settings;
	}

	/**
	 * @return array
	 */
	public function get_normalized_settings() {
		$normalized_settings = [];

		foreach ( $this->rules as $rule ) {
			$normalized_settings[] = $rule->get_normalized_settings();
		}

		return $normalized_settings;
	}

	/**
	 * @param SingleRuleSettings $single_rule_settings
	 */
	private function add_single_rule_settings( SingleRuleSettings $single_rule_settings ) {
		$this->rules[] = $single_rule_settings;
	}
}RulesSettingsField.php                                                                                                                                                                                                                                         6332          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php
/**
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate;

use WPDesk\FS\TableRate\Rule\Condition\ConditionsFactory;
use WPDesk\FS\TableRate\Rule\Cost\RuleAdditionalCostFieldsFactory;
use WPDesk\FS\TableRate\Rule\Cost\RuleAdditionalCostFactory;
use WPDesk\FS\TableRate\Rule\Cost\RuleCostFieldsFactory;
use WPDesk\FS\TableRate\Rule\PreconfiguredScenarios\PreconfiguredScenariosFactory;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialActionFieldsFactory;
use WPDesk\FS\TableRate\Rule\SpecialAction\SpecialActionFactory;
use WPDesk\FS\ProFeatures;
use WPDesk\FS\TableRate\Rule\PreconfiguredScenarios;

/**
 * Class RulesSettings
 */
class RulesSettingsField {

	const FIELD_TYPE = 'shipping_rules';

	/**
	 * @var string
	 */
	protected static $assets_url;

	/**
	 * @var string
	 */
	private $settings_field_id;

	/**
	 * @var string
	 */
	private $settings_field_name;

	/**
	 * @var string
	 */
	private $settings_field_title;

	/**
	 * @var array
	 */
	private $settings;

	/**
	 * @var array
	 */
	private $value;

	/**
	 * RulesSettings constructor.
	 *
	 * @param string $settings_field_id    .
	 * @param string $settings_field_name  .
	 * @param string $settings_field_title .
	 * @param array  $settings             .
	 * @param array  $value                .
	 */
	public function __construct( $settings_field_id, $settings_field_name, $settings_field_title, $settings, $value = null ) {
		$this->settings_field_id    = $settings_field_id;
		$this->settings_field_name  = $settings_field_name;
		$this->settings_field_title = $settings_field_title;
		$this->settings             = $settings;
		$this->value                = $value;
	}

	/**
	 * @param string $assets_url .
	 */
	public static function set_assets_url( $assets_url ) {
		self::$assets_url = $assets_url;
	}

	/**
	 * Render settings.
	 *
	 * @return string
	 */
	public function render() {
		ob_start();
		$settings_field_id    = $this->settings_field_id;
		$settings_field_name  = $this->settings_field_name;
		$settings_field_title = $this->settings_field_title;
		$available_conditions = $this->get_available_conditions();
		$rules_settings       = $this->get_normalized_settings( $available_conditions );
		$available_conditions = array_values( $available_conditions );
		$translations         = $this->get_translations();
		$pro_features_data    = $this->get_pro_features_data();
		$rules_table_settings = $this->get_table_settings();

		$cost_settings_fields    = $this->get_available_cost_settings();
		$additional_cost_fields  = $this->get_additional_cost_fields();
		$special_action_fields   = $this->get_special_actions_fields();
		$preconfigured_scenarios = $this->get_preconfigured_scenarios();

		$is_pro_activated = defined( 'FLEXIBLE_SHIPPING_PRO_VERSION' );

		include __DIR__ . '/views/shipping-method-settings-rules.php';

		return ob_get_clean();
	}

	/**
	 * @return array
	 */
	private function get_pro_features_data(): array {
		return [
			'ajax_url'    => admin_url( 'admin-ajax.php' ),
			'ajax_action' => ProFeatures\Tracker\AjaxTracker::AJAX_ACTION,
			'ajax_nonce'  => wp_create_nonce( ProFeatures\Tracker\AjaxTracker::AJAX_ACTION ),
			'fs_pro_link' => 'pl_PL' === get_user_locale()
				? 'https://octol.io/fs-pro-features-pl'
				: 'https://octol.io/fs-pro-features',
		];
	}

	/**
	 * @return array
	 */
	private function get_translations() {
		return [
			'assets_url'                  => self::$assets_url,
			'ajax_url_scenarios_tracking' => admin_url( 'admin-ajax.php?action=' . PreconfiguredScenarios\Tracker\AjaxTracker::AJAX_ACTION ),
			'scenarios_tracking_nonce'    => wp_create_nonce( PreconfiguredScenarios\Tracker\AjaxTracker::AJAX_ACTION ),
			'scenarios_docs_link'         =>
				'pl_PL' === get_locale()
					? 'https://octol.io/fs-scenarios-pl'
					: 'https://octol.io/fs-scenarios',
		];
	}

	/**
	 * @return array
	 */
	private function get_available_cost_settings() {
		$rule_costs_fields_factory = new RuleCostFieldsFactory();

		return $rule_costs_fields_factory->get_normalized_cost_fields();
	}

	/**
	 * @return array
	 */
	private function get_additional_cost_fields() {
		$rule_additional_costs_fields_factory = new RuleAdditionalCostFieldsFactory( ( new RuleAdditionalCostFactory() )->get_additional_costs() );

		return $rule_additional_costs_fields_factory->get_normalized_cost_fields();
	}

	/**
	 * @return array
	 */
	private function get_special_actions_fields() {
		$special_actions_fields_factory = new SpecialActionFieldsFactory( ( new SpecialActionFactory() )->get_special_actions() );

		return $special_actions_fields_factory->get_normalized_cost_fields();
	}

	/**
	 * @retrun array
	 */
	private function get_preconfigured_scenarios() {
		return ( new PreconfiguredScenariosFactory() )->get_scenarios();
	}

	/**
	 * @return array
	 */
	private function get_table_settings() {
		return ( new RulesTableSettings() )->get_table_settings();
	}

	/**
	 * @return Rule\Condition\Condition[]
	 */
	private function get_available_conditions() {
		return ( new ConditionsFactory() )->get_conditions();
	}

	/**
	 * @param Rule\Condition\Condition[] $available_conditions .
	 *
	 * @return array
	 */
	private function get_normalized_settings( $available_conditions ) {
		$rules_settings = RulesSettingsFactory::create_from_array( $this->get_field_value() );

		return $this->process_select_options_for_conditions( $rules_settings->get_normalized_settings(), $available_conditions );
	}

	/**
	 * @return array
	 */
	private function get_field_value() {
		return ! isset( $this->value ) ? $this->settings['default'] : $this->value;
	}

	/**
	 * @param array                      $settings             .
	 * @param Rule\Condition\Condition[] $available_conditions .
	 *
	 * @return array
	 */
	private function process_select_options_for_conditions( array $settings, $available_conditions ) {
		foreach ( $settings as $rule_key => $rule ) {
			$conditions = isset( $rule['conditions'] ) && is_array( $rule['conditions'] ) ? $rule['conditions'] : [];
			foreach ( $conditions as $condition_key => $condition ) {
				if ( isset( $available_conditions[ $condition['condition_id'] ] ) ) {
					$settings[ $rule_key ]['conditions'][ $condition_key ] = $available_conditions[ $condition['condition_id'] ]->prepare_settings( $condition );
				}
			}
		}

		return $settings;
	}
}
RulesTableSettings.php                                                                                                                                                                                                                                         1711          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <?php
/**
 * @package WPDesk\FS\TableRate
 */

namespace WPDesk\FS\TableRate;

/**
 * Rules table settings
 */
class RulesTableSettings {

	const MULTIPLE_CONDITIONS_AVAILABLE       = 'multiple_conditions_available';
	const MULTIPLE_ADDITIONAL_COSTS_AVAILABLE = 'multiple_additional_costs_available';
	const SPECIAL_ACTIONS_AVAILABLE           = 'special_actions_available';

	/**
	 * @return array
	 */
	public function get_table_settings() {
		/**
		 * Rules table settings.
		 *
		 * @param array $settings Table settings.
		 *
		 * @return array Table settings.
		 *
		 * Available settings:
		 *     multiple_conditions_available
		 *     multiple_additional_costs_available
		 *     special_actions_available
		 */
		return apply_filters(
			'flexible_shipping_rules_table_settings',
			array(
				self::MULTIPLE_CONDITIONS_AVAILABLE       => false,
				self::MULTIPLE_ADDITIONAL_COSTS_AVAILABLE => false,
				self::SPECIAL_ACTIONS_AVAILABLE           => false,
			)
		);
	}

	/**
	 * @return bool
	 */
	public function is_multiple_conditions_available() {
		return $this->is( self::MULTIPLE_CONDITIONS_AVAILABLE );
	}

	/**
	 * @return bool
	 */
	public function is_multiple_additional_costs_available() {
		return $this->is( self::MULTIPLE_ADDITIONAL_COSTS_AVAILABLE );
	}

	/**
	 * @return bool
	 */
	public function is_special_actions_available() {
		return $this->is( self::SPECIAL_ACTIONS_AVAILABLE );
	}

	/**
	 * @param string $field_name .
	 *
	 * @return bool
	 */
	private function is( $field_name ) {
		$table_settings = $this->get_table_settings();

		return isset( $table_settings[ $field_name ] ) && is_bool( $table_settings[ $field_name ] ) ? $table_settings[ $field_name ] : false;
	}

}
BlockEditing.php                                                                                                                                                                                                                                               830           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/BlockEditing                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php
/**
 * Class BlockEditing
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\BlockEditing
 */

namespace WPDesk\FS\TableRate\ShippingMethod\BlockEditing;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Block edit settings of FS Group.
 */
class BlockEditing implements Hookable {
	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'flexible_shipping_method_script', array( $this, 'block_shipping_method_script' ), 10, 2 );
	}

	/**
	 * @param string $method_id   .
	 * @param int    $instance_id .
	 */
	public function block_shipping_method_script( $method_id, $instance_id ) {
		if ( 'flexible_shipping' !== $method_id ) {
			return;
		}

		if ( apply_filters( 'flexible-shipping/group-method/supports/edit', false ) === true ) {
			return;
		}

		include __DIR__ . '/views/block-settings.php';
	}
}
block-settings.php                                                                                                                                                                                                                                             256           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/BlockEditing/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php
/**
 * @var string $method_id   .
 * @var int    $instance_id .
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\BlockEditing
 */

?>

<style>
    #flexible_shipping_import, #flexible_shipping_export_selected {
        display: none;
    }
</style>
CommonMethodSettings.php                                                                                                                                                                                                                                       13270         1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class CommonMethodSettings
 *
 * @package WPDesk\FS\TableRate\ShippingMethod
 */

namespace WPDesk\FS\TableRate\ShippingMethod;

use FSVendor\WPDesk\FS\TableRate\CalculationMethodOptions;
use FSVendor\WPDesk\FS\TableRate\Settings\CartCalculationOptions;
use WPDesk\FS\TableRate\DefaultRulesSettings;
use WPDesk\FS\TableRate\RulesSettingsField;
use WPDesk_Flexible_Shipping;

/**
 * Common shipping method settings.
 */
class CommonMethodSettings implements MethodSettings {

	const METHOD_TITLE       = 'method_title';
	const METHOD_DESCRIPTION = 'method_description';
	const METHOD_RULES       = 'method_rules';
	const CART_CALCULATION   = 'cart_calculation';

	const SETTING_METHOD_CALCULATION_METHOD = 'method_calculation_method';
	const METHOD_DEFAULT                    = 'method_default';

	const METHOD_FREE_SHIPPING_REQUIRES_UPSELLING = 'method_free_shipping_requires_upselling';

	/**
	 * @param array $method_settings           .
	 * @param bool  $with_integration_settings Append integration settings.
	 *
	 * @return array
	 */
	public function get_settings_fields( array $method_settings, $with_integration_settings ) {
		if ( ! isset( $method_settings['method_free_shipping_label'] ) ) {
			$method_settings['method_free_shipping_label'] = __( 'Free', 'flexible-shipping' );
		}

		if ( empty( $method_settings['method_integration'] ) ) {
			$method_settings['method_integration'] = '';
		}

		$method_free_shipping = '';
		if ( isset( $method_settings['method_free_shipping'] ) && '' !== $method_settings['method_free_shipping'] ) {
			$method_free_shipping = floatval( $method_settings['method_free_shipping'] );
		}

		$settings = [];

		$settings['method_enabled'] = [
			'title'   => __( 'Enable/Disable', 'flexible-shipping' ),
			'type'    => 'checkbox',
			'default' => $this->get_value_from_settings( $method_settings, 'method_enabled', 'yes' ),
			'label'   => __( 'Enable this shipment method', 'flexible-shipping' ),
		];

		$settings[ self::METHOD_TITLE ] = [
			'title'             => __( 'Method Title', 'flexible-shipping' ),
			'type'              => 'text',
			'description'       => __( 'This controls the title which the user sees during checkout.', 'flexible-shipping' ),
			'desc_tip'          => true,
			'default'           => $this->get_value_from_settings( $method_settings, self::METHOD_TITLE, 'Flexible Shipping' ),
			'custom_attributes' => [ 'required' => true ],
		];

		$settings[ self::METHOD_DESCRIPTION ] = [
			'title'       => __( 'Method Description', 'flexible-shipping' ),
			'type'        => 'text',
			'description' => __( 'This controls method description which the user sees during checkout.', 'flexible-shipping' ),
			'desc_tip'    => true,
			'default'     => $this->get_value_from_settings( $method_settings, self::METHOD_DESCRIPTION, '' ),
		];

		$settings['method_free_shipping'] = [
			'title'       => __( 'Free shipping threshold', 'flexible-shipping' ),
			'type'        => 'price',
			'default'     => $method_free_shipping,
			'description' => sprintf(
				// Translators: bolds.
				__( 'Enter a minimum threshold value which once reached will result in granting your customers the free shipping. It will be applied, as long as this shipping method will be available and its configured shipping cost calculation conditions are met. Example: If the %1$sFree shipping threshold%2$s is set to $200, and your price-based shipping cost calculation rules end at $199.99, you need to configure one more rule - %1$sWhen: Price - is from $200 - cost is $0%2$s to cover the range above the %1$sFree shipping threshold%2$s value.', 'flexible-shipping' ),
				'<strong>',
				'</strong>'
			),
			'desc_tip'    => true,
		];

		$settings['method_free_shipping_label'] = [
			'title'       => __( 'Free Shipping Label', 'flexible-shipping' ),
			'type'        => 'text',
			'default'     => $this->get_value_from_settings( $method_settings, 'method_free_shipping_label', '' ),
			'description' => __( 'Enter the text for the additional shipping method\'s label which will be displayed once the free shipping is triggered or calculated.', 'flexible-shipping' ),
			'desc_tip'    => true,
		];

		$description = sprintf( //phpcs:ignore.
						__( 'Learn %1$show to customize the displayed notice &rarr;%2$s', 'flexible-shipping' ), //phpcs:ignore.
							sprintf( //phpcs:ignore.
								'<a href="%s" target="_blank">', //phpcs:ignore.
								esc_url( get_user_locale() === 'pl_PL' ? 'https://octol.io/fs-free-notice-pl' : 'https://octol.io/fs-free-notice' ) //phpcs:ignore.
						), //phpcs:ignore.
						'</a>' //phpcs:ignore.
					) . '<br /><br />' . __( 'Please mind that if you use any additional plugins to split the shipment into packages, the \'Left to free shipping notice\' will not be displayed.', 'flexible-shipping' ); //phpcs:ignore.

		$settings[ WPDesk_Flexible_Shipping::SETTING_METHOD_FREE_SHIPPING_NOTICE ] = [
			'title'       => __( '\'Left for free shipping\' notice (LFFS)', 'flexible-shipping' ),
			'type'        => 'checkbox',
			'default'     => $this->get_value_from_settings( $method_settings, WPDesk_Flexible_Shipping::SETTING_METHOD_FREE_SHIPPING_NOTICE, 'no' ),
			'label'       => __( 'Display the notice with the amount left for free shipping', 'flexible-shipping' ),
			'description' => $description,
		];

		$settings[ self::SETTING_METHOD_CALCULATION_METHOD ] = [
			'title'       => __( 'Rules Calculation', 'flexible-shipping' ),
			'type'        => 'select',
			'description' => __( 'Select how rules will be calculated. If you choose "sum" the rules order is important.', 'flexible-shipping' ),
			'default'     => $this->get_value_from_settings( $method_settings, self::SETTING_METHOD_CALCULATION_METHOD, '' ),
			'desc_tip'    => true,
			'options'     => ( new CalculationMethodOptions() )->get_options(),
		];

		$settings[ self::CART_CALCULATION ] = [
			'title'       => __( 'Cart Calculation', 'flexible-shipping' ),
			'type'        => 'select',
			'default'     => $this->get_value_from_settings( $method_settings, self::CART_CALCULATION, isset( $method_settings[ self::METHOD_DESCRIPTION ] ) ? CartCalculationOptions::CART : CartCalculationOptions::PACKAGE ),
			'options'     => ( new CartCalculationOptions() )->get_options(),
			'description' => __( 'Choose Package value to exclude virtual products from rules calculation.', 'flexible-shipping' ),
			'desc_tip'    => true,
		];

		$settings['method_visibility'] = [
			'title'   => __( 'Visibility', 'flexible-shipping' ),
			'type'    => 'checkbox',
			'default' => $this->get_value_from_settings( $method_settings, 'method_visibility', 'no' ),
			'label'   => __( 'Show only for logged in users', 'flexible-shipping' ),
		];

		$settings[ self::METHOD_DEFAULT ] = [
			'title'   => __( 'Default', 'flexible-shipping' ),
			'type'    => 'checkbox',
			'default' => $this->get_value_from_settings( $method_settings, self::METHOD_DEFAULT, 'no' ),
			'label'   => __( 'Check the box to set this option as the default selected choice on the cart page.', 'flexible-shipping' ),
		];

		$settings['method_debug_mode'] = [
			'title'       => __( 'FS Debug Mode', 'flexible-shipping' ),
			'type'        => 'checkbox',
			'default'     => $this->get_value_from_settings( $method_settings, 'method_debug_mode', 'no' ),
			'label'       => __( 'Enable FS Debug Mode', 'flexible-shipping' ),
			'description' => sprintf(
			// Translators: documentation link.
				__( 'Enable FS debug mode to verify the shipping methods\' configuration, check which one was used and how the shipping cost was calculated as well as identify any possible mistakes. %1$sLearn more how the Debug Mode works →%2$s', 'flexible-shipping' ),
				'<a href="' . ( 'pl_PL' !== get_user_locale() ? 'https://octol.io/fs-debug-mode' : 'https://octol.io/fs-debug-mode-pl' ) . '" target="_blank">',
				'</a>'
			),
		];

		if ( $with_integration_settings ) {
			$settings = $this->append_integration_settings_if_present( $settings, $method_settings );
		}

		$settings[ self::METHOD_RULES ] = [
			'title'            => __( 'Shipping Cost Calculation Rules', 'flexible-shipping' ),
			'type'             => RulesSettingsField::FIELD_TYPE,
			'default'          => $this->get_value_from_settings( $method_settings, self::METHOD_RULES, ( new DefaultRulesSettings() )->get_normalized_settings() ),
			self::METHOD_TITLE => $this->get_value_from_settings( $method_settings, self::METHOD_TITLE, __( 'Flexible Shipping', 'flexible-shipping' ) ),
		];

		$settings[] = [
			'type' => 'title',
			'id'   => 'flexible_shipping_method_settings_end',
		];

		return apply_filters( 'flexible-shipping/settings/common-method-settings', $settings );
	}

	/**
	 * @param array $settings        .
	 * @param array $method_settings .
	 *
	 * @return array
	 */
	private function append_integration_settings_if_present( array $settings, $method_settings ) {
		$integrations_options = apply_filters( 'flexible_shipping_integration_options', [ '' => __( 'None', 'flexible-shipping' ) ] );

		if ( 1 < count( $integrations_options ) ) {
			$settings['title_shipping_integration'] = [
				'title' => __( 'Shipping Integration', 'flexible-shipping' ),
				'type'  => 'title',
			];
			$settings['method_integration']         = [
				'title'    => __( 'Integration', 'flexible-shipping' ),
				'type'     => 'select',
				'desc_tip' => false,
				'options'  => $integrations_options,
				'default'  => $this->get_value_from_settings( $method_settings, 'method_integration' ),
			];
		}

		$filtered_settings = apply_filters( 'flexible_shipping_method_settings', $settings, $method_settings );

		$settings = [];

		foreach ( $filtered_settings as $settings_key => $settings_value ) {
			if ( 'method_enabled' === $settings_key ) {
				$settings['title_general_settings'] = [
					'title' => __( 'General Settings', 'flexible-shipping' ),
					'type'  => 'title',
				];
			}

			if ( 'method_free_shipping_requires' === $settings_key || ( 'method_free_shipping' === $settings_key && ! isset( $settings['method_free_shipping_requires'] ) ) ) {
				$free_shipping_docs_url          = get_user_locale() === 'pl_PL' ? 'https://octol.io/fs-free-shipping-coming-from-the-rules-pl' : 'https://octol.io/fs-free-shipping-coming-from-the-rules';
				$settings['title_free_shipping'] = [
					'title'       => __( 'Free Shipping', 'flexible-shipping' ),
					'type'        => 'title',
					'description' => sprintf(
					// Translators: strong and link.
						__( 'Specify when the free shipping should be available to your customers. You can use the %1$sFree shipping threshold%2$s option below or/and you can also set up the free shipping resulting directly from the Flexible Shipping cost calculation rules. %3$sLearn how to configure the free shipping coming from the cost calculation rules &rarr;%4$s', 'flexible-shipping' ),
						'<strong>',
						'</strong>',
						'<a href="' . $free_shipping_docs_url . '" target="_blank">',
						'</a>'
					),
				];
				if ( ! defined( 'FLEXIBLE_SHIPPING_PRO_VERSION' ) ) {
					$compare_versions_link                                     = get_user_locale() === 'pl_PL' ? 'https://octol.io/free-shipping-requires-fs-free-pro-comparison-pl' : 'https://octol.io/free-shipping-requires-fs-free-pro-comparison';
					$settings[ self::METHOD_FREE_SHIPPING_REQUIRES_UPSELLING ] = [
						'title'       => __( 'Free Shipping Requires', 'flexible-shipping' ),
						'type'        => 'select',
						'options'     => [
							'order_amount'            => __( 'Minimum order value', 'flexible-shipping' ),
							'item_quantity'           => __( 'Minimum item quantity (PRO)', 'flexible-shipping' ),
							'coupon'                  => __( 'Free shipping coupon (PRO)', 'flexible-shipping' ),
							'order_amount_or_coupon'  => __( 'Free shipping coupon or minimum order amount (PRO) ', 'flexible-shipping' ),
							'order_amount_and_coupon' => __( 'Free shipping coupon and minimum order amount (PRO)', 'flexible-shipping' ),
						],
						'description' => sprintf(
							// Translators: link.
							__( 'Compare the %1$sdifferences between Flexible Shipping FREE and PRO &rarr;%2$s', 'flexible-shipping' ),
							'<a href="' . $compare_versions_link . '" target="_blank">',
							'</a>'
						),
						'desc_tip'    => 'Define the condition which must be met for the free shipping to be granted.',
					];
				}
			}

			if ( 'method_max_cost' === $settings_key || ( self::SETTING_METHOD_CALCULATION_METHOD === $settings_key && ! isset( $settings['method_max_cost'] ) ) ) {
				$settings['title_cost_calculation'] = [
					'title' => __( 'Cost Calculation', 'flexible-shipping' ),
					'type'  => 'title',
				];
			}

			if ( 'method_visibility' === $settings_key ) {
				$settings['title_advanced_options'] = [
					'title' => __( 'Advanced Options', 'flexible-shipping' ),
					'type'  => 'title',
				];
			}

			$settings[ $settings_key ] = $settings_value;
		}

		return $settings;
	}

	/**
	 * @param array        $settings   .
	 * @param string       $field_name .
	 * @param string|array $default    .
	 *
	 * @return string
	 */
	private function get_value_from_settings( array $settings, $field_name, $default = '' ) {
		return isset( $settings[ $field_name ] ) ? $settings[ $field_name ] : $default;
	}
}
ConvertAction.php                                                                                                                                                                                                                                              4553          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Convert                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class ConvertAction
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Convert
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Convert;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Shipping_Zone;
use WC_Shipping_Zones;
use WPDesk\FS\TableRate\ShippingMethod\Management\ShippingMethodManagement;
use WPDesk\FS\TableRate\ShippingMethodSingle;
use WPDesk_Flexible_Shipping;

/**
 * Action for convert Group Shipping Method.
 */
class ConvertAction implements Hookable {
	const AJAX_ACTION = 'flexible_shipping_process_converting';
	const AJAX_NONCE  = 'flexible_shipping_process_converting';

	/**
	 * @var ShippingMethodManagement
	 */
	private $shipping_method_management;

	/**
	 * @param ShippingMethodManagement $shipping_method_management
	 */
	public function __construct( ShippingMethodManagement $shipping_method_management ) {
		$this->shipping_method_management = $shipping_method_management;
	}

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'wp_ajax_' . self::AJAX_ACTION, [ $this, 'ajax_run_convert' ] );
	}

	/**
	 * Process convert.
	 */
	public function ajax_run_convert() {
		check_ajax_referer( self::AJAX_NONCE );
		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			wp_send_json_error();
		}

		$instance_id = filter_input( INPUT_GET, 'instance_id', FILTER_VALIDATE_INT );

		if ( ! $instance_id ) {
			return;
		}

		/** @var WPDesk_Flexible_Shipping $shipping_method */
		$shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );

		if ( ! $shipping_method instanceof WPDesk_Flexible_Shipping ) {
			return;
		}

		/** @var WC_Shipping_Zone $zone */
		$zone = WC_Shipping_Zones::get_zone_by( 'instance_id', $instance_id );

		$shipping_methods = $shipping_method->get_shipping_methods();

		// Shipping method orders.
		$shipping_method_order = $this->shipping_method_management->get_shipping_method_order( $instance_id );
		$this->shipping_method_management->update_shipping_methods_order( $zone->get_id(), $shipping_method_order, count( $shipping_methods ) );

		foreach ( $shipping_methods as $single_shipping_method ) {
			$single_shipping_method_instance_id = $this->add_new_shipping_method_to_zone( $zone, $single_shipping_method, $shipping_method );

			$method_status = $shipping_method->is_enabled() ? isset( $single_shipping_method['method_enabled'] ) && 'yes' === $single_shipping_method['method_enabled'] : false;

			$this->shipping_method_management->set_shipping_method_status( $single_shipping_method_instance_id, $method_status, $zone );
			$this->shipping_method_management->update_shipping_method_field( $single_shipping_method_instance_id, 'method_order', ++$shipping_method_order );

			do_action( 'flexible-shipping/group-method/converted-single-method', $single_shipping_method_instance_id, $single_shipping_method );
		}

		// Turn off current Flexible Shipping Group Method.
		$this->shipping_method_management->set_shipping_method_status( $instance_id, false, $zone );
		$shipping_method->set_as_converted();

		do_action( 'flexible-shipping/group-method/converted-method', $shipping_method );

		wp_redirect( $this->get_redirect_url_success_convert( $zone->get_id() ) );
		die();
	}

	/**
	 * @param WC_Shipping_Zone         $zone                         .
	 * @param array                    $old_shipping_method_settings .
	 * @param WPDesk_Flexible_Shipping $old_shipping_method          .
	 *
	 * @return int
	 */
	private function add_new_shipping_method_to_zone( WC_Shipping_Zone $zone, array $old_shipping_method_settings, WPDesk_Flexible_Shipping $old_shipping_method ): int {
		$instance_id = $zone->add_shipping_method( ShippingMethodSingle::SHIPPING_METHOD_ID );

		/** @var ShippingMethodSingle $shipping_method . */
		$shipping_method     = WC_Shipping_Zones::get_shipping_method( $instance_id );
		$shipping_method_key = $shipping_method->get_instance_option_key();

		if ( ! is_array( $old_shipping_method_settings ) ) {
			$old_shipping_method_settings = [];
		}

		$old_shipping_method_settings['tax_status'] = $old_shipping_method->get_instance_option( 'tax_status' );

		// Add default options.
		update_option( $shipping_method_key, $old_shipping_method_settings );

		return $instance_id;
	}

	/**
	 * @param int $zone_id .
	 *
	 * @return string
	 */
	private function get_redirect_url_success_convert( int $zone_id ): string {
		return add_query_arg(
			[
				'page'      => 'wc-settings',
				'tab'       => 'shipping',
				'converted' => '1',
				'zone_id'   => $zone_id,
			],
			admin_url( 'admin.php' )
		);
	}
}
ConvertNotice.php                                                                                                                                                                                                                                              7054          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Convert                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class ConvertNotice
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Convert
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Convert;

use FSVendor\WPDesk\Notice\Notice;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Shipping_Method;
use WC_Shipping_Zones;
use WPDesk_Flexible_Shipping;

/**
 * Display admin notices.
 */
class ConvertNotice implements Hookable {
	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'woocommerce_settings_shipping', array( $this, 'add_admin_notice' ) );
	}

	/**
	 * Add admin notices.
	 */
	public function add_admin_notice() {
		$this->display_required_convert_message();
		$this->display_success_converted_message();
	}

	/**
	 * @return bool
	 */
	private function is_limited_notice_width() {
		return ! wpdesk_is_plugin_active( 'flexible-shipping-pro/flexible-shipping-pro.php' ) || ! wpdesk_is_plugin_active( 'flexible-shipping-import-export/flexible-shipping-import-export.php' );
	}

	/**
	 * Display notice on shipping method page.
	 */
	private function display_required_convert_message() {
		$zone_id     = filter_input( INPUT_GET, 'zone_id', FILTER_VALIDATE_INT );
		$instance_id = filter_input( INPUT_GET, 'instance_id', FILTER_VALIDATE_INT );

		if ( $zone_id && ! $instance_id ) {
			return;
		}

		/** @var WPDesk_Flexible_Shipping $shipping_method */
		$shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );

		if ( ! $shipping_method instanceof WPDesk_Flexible_Shipping ) {
			return;
		}

		$convert_url = $this->get_convert_url( $instance_id );

		$is_limited_notice_width = $this->is_limited_notice_width();

		if ( $shipping_method->is_converted() ) {
			$convert_url = add_query_arg( 'converting_again', 'true', $convert_url );

			$this->add_notice(
				sprintf(
				// Translators: URL.
					__( 'Flexible Shipping group method you are currently viewing has been converted to its new single version and deactivated for safety reasons. Once you make sure everything was converted properly, you can safely delete this group method. If you notice any discrepancies please %1$srun the conversion process once again%2$s.%3$sIf you use any custom functions or plugins targeting the specific shipping methods based on their IDs, e.g. %4$sFlexible Checkout Fields PRO%5$s, %6$sActive Payments%7$s, %8$sShopMagic%9$s or similar, please re-check their configuration in order to maintain their proper functioning after the conversion.', 'flexible-shipping' ),
					'<a href="' . esc_url( $convert_url ) . '">',
					'</a>',
					'<br/>',
					'<a href="' . esc_url( $this->get_admin_url_fsf_pro_settings() ) . '" target="_blank">',
					'</a>',
					'<a href="' . esc_url( $this->get_admin_url_ap_settings() ) . '" target="_blank">',
					'</a>',
					'<a href="' . esc_url( $this->get_admin_url_sm_settings() ) . '" target="_blank">',
					'</a>'
				),
				'error',
				$is_limited_notice_width
			);

			return;
		}

		$learn_more_url = 'pl_PL' === get_locale() ? 'https://octol.io/fs-migration-pl' : 'https://octol.io/fs-migration';

		if ( count( $shipping_method->get_shipping_methods() ) > 0 ) {
			$this->add_notice(
				sprintf(
				// Translators: URL.
					__( 'Flexible Shipping group methods are no longer supported. Despite the fact that they still remain editable, no other new features are going to be added to them. It is highly recommended to convert them to the supported single ones. %1$sStart converting%2$s or %3$slearn more about it &rarr;%4$s.%5$sPlease mind that if you use any custom functions or plugins targeting the specific shipping methods based on their IDs, e.g. %6$sFlexible Checkout Fields PRO%7$s, %8$sActive Payments%9$s, %10$sShopMagic%11$s or similar, you may need to reconfigure them after the conversion to remain their proper functioning.', 'flexible-shipping' ),
					'<a href="' . esc_url( $convert_url ) . '">',
					'</a>',
					'<a href="' . esc_url( $learn_more_url ) . '" target="_blank">',
					'</a>',
					'<br/>',
					'<a href="' . esc_url( $this->get_admin_url_fsf_pro_settings() ) . '" target="_blank">',
					'</a>',
					'<a href="' . esc_url( $this->get_admin_url_ap_settings() ) . '" target="_blank">',
					'</a>',
					'<a href="' . esc_url( $this->get_admin_url_sm_settings() ) . '" target="_blank">',
					'</a>'
				),
				'error',
				$is_limited_notice_width
			);
		} else {
			$this->add_notice(
				sprintf(
				// Translators: URL.
					__( 'Flexible Shipping group method is no longer supported. %1$sLearn more about it &rarr;%2$s.', 'flexible-shipping' ),
					'<a href="' . esc_url( $learn_more_url ) . '" target="_blank">',
					'</a>'
				),
				'error',
				$is_limited_notice_width
			);
		}
	}

	/**
	 * @param string $message                 .
	 * @param string $type                    .
	 * @param bool   $is_limited_notice_width .
	 */
	private function add_notice( $message, $type = 'error', $is_limited_notice_width = false ) {
		$classes = array( 'fs-notice js--move-notice inline' );

		if ( $is_limited_notice_width ) {
			$classes[] = 'is-limited-width';
		}

		new Notice( $message, $type, false, 10, array( 'class' => implode( ' ', $classes ) ) );

		if ( ! has_action( 'admin_footer', array( $this, 'move_notice_script' ) ) ) {
			add_action( 'admin_footer', array( $this, 'move_notice_script' ) );
		}
	}

	/**
	 * Script to move notices.
	 */
	public function move_notice_script() {
		include __DIR__ . '/views/move-notices.php';
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return string
	 */
	private function get_convert_url( $instance_id ) {
		$convert_url = admin_url( 'admin-ajax.php' );
		$convert_url = add_query_arg( 'instance_id', $instance_id, $convert_url );
		$convert_url = add_query_arg( 'action', ConvertAction::AJAX_ACTION, $convert_url );

		return wp_nonce_url( $convert_url, ConvertAction::AJAX_NONCE );
	}

	/**
	 * Display notice when shipping method has been converted.
	 */
	private function display_success_converted_message() {
		$converted = filter_input( INPUT_GET, 'converted' );

		if ( $converted ) {
			new Notice( __( 'Flexible Shipping group method has been converted to its new single version and deactivated for safety reasons. Once you make sure everything was converted properly, you can safely delete the previous group method.', 'flexible-shipping' ), 'success' );
		}
	}

	/**
	 * @return string
	 */
	private function get_admin_url_fsf_pro_settings() {
		return $this->get_admin_url( 'admin.php', 'page', 'inspire_checkout_fields_settings' );
	}

	/**
	 * @return string
	 */
	private function get_admin_url_ap_settings() {
		return $this->get_admin_url( 'admin.php', 'page', 'woocommerce_activepayments' );
	}

	/**
	 * @return string
	 */
	private function get_admin_url_sm_settings() {
		return $this->get_admin_url( 'edit.php', 'post_type', 'shopmagic_automation' );
	}

	/**
	 * @param string $page  .
	 * @param string $key   .
	 * @param string $value .
	 *
	 * @return string
	 */
	private function get_admin_url( $page, $key, $value ) {
		return add_query_arg( $key, $value, admin_url( $page ) );
	}
}
ConvertTracker.php                                                                                                                                                                                                                                             3282          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Convert                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
/**
 * Class ConvertTracker
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Convert
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Convert;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WC_Shipping_Zones;
use WPDesk_Flexible_Shipping;

/**
 * Tracking of convert usages.
 */
class ConvertTracker implements Hookable {
	const OPTION_FIRST = 'flexible_shipping_convert_first';
	const OPTION_AGAIN = 'flexible_shipping_convert_again';
	const OPTION_DELETED = 'flexible_shipping_convert_deleted';

	const PRIORYTY_AFTER_FS_TRACKER = 12;

	/**
	 * @var array .
	 */
	private $to_delete_methods = array();

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_data', array( $this, 'add_tracking_data' ), self::PRIORYTY_AFTER_FS_TRACKER );

		// Trackers.
		add_action( 'woocommerce_shipping_zone_method_deleted', array( $this, 'track_deleted_method' ) );
		add_action( 'flexible-shipping/group-method/converted-method', array( $this, 'track_convert_method' ) );

		// Prepare before tracking.
		add_action(
			'wp_ajax_woocommerce_shipping_zone_methods_save_changes',
			array(
				$this,
				'check_deleted_methods',
			),
			5
		);
	}

	/**
	 * Track running of converting.
	 */
	public function track_convert_method() {
		$converting_again = filter_input( INPUT_GET, 'converting_again' );

		$this->update_count( $converting_again ? self::OPTION_AGAIN : self::OPTION_FIRST );
	}

	/**
	 * Check if FS Group has been deleted.
	 */
	public function check_deleted_methods() {
		if ( ! isset( $_POST['wc_shipping_zones_nonce'], $_POST['zone_id'], $_POST['changes'] ) ) {
			return;
		}

		if ( ! wp_verify_nonce( wp_unslash( $_POST['wc_shipping_zones_nonce'] ), 'wc_shipping_zones_nonce' ) ) { // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			return;
		}

		if ( ! current_user_can( 'manage_woocommerce' ) ) {
			return;
		}

		$changes = wp_unslash( $_POST['changes'] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized

		if ( ! isset( $changes['methods'] ) ) {
			return;
		}

		foreach ( $changes['methods'] as $instance_id => $data ) {
			if ( ! isset( $data['deleted'] ) ) {
				continue;
			}

			$shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );

			if ( ! $shipping_method instanceof WPDesk_Flexible_Shipping ) {
				continue;
			}

			$this->to_delete_methods[] = $instance_id;
		}
	}

	/**
	 * @param int $instance_id .
	 */
	public function track_deleted_method( $instance_id ) {
		if ( ! in_array( $instance_id, $this->to_delete_methods ) ) {
			return;
		}

		$this->update_count( self::OPTION_DELETED );
	}

	/**
	 * @param array $data .
	 *
	 * @return array
	 */
	public function add_tracking_data( $data ) {
		$data['flexible_shipping']['convert'] = $this->prepare_data();

		return $data;
	}

	/**
	 * @return array
	 */
	private function prepare_data() {
		return array(
			'first'   => (int) get_option( self::OPTION_FIRST, 0 ),
			'again'   => (int) get_option( self::OPTION_AGAIN, 0 ),
			'deleted' => (int) get_option( self::OPTION_DELETED, 0 ),
		);
	}

	/**
	 * Update option count.
	 *
	 * @param string $option .
	 */
	private function update_count( $option ) {
		update_option( $option, (int) get_option( $option, 0 ) + 1 );
	}
}
move-notices.php                                                                                                                                                                                                                                               334           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Convert/views                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
/**
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Convert
 */

?>

<script type="text/javascript">
	jQuery( function () {
		jQuery( '.js--move-notice' ).each( function () {
			jQuery( this ).insertAfter( '#woocommerce_flexible_shipping_0 + p, #woocommerce_flexible_shipping_title_general_settings' );
		} );
	} );
</script>
DuplicateAction.php                                                                                                                                                                                                                                            3678          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Duplicate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php
/**
 * Class DuplicateAction
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Duplicate
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Duplicate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;
use WPDesk\FS\TableRate\ShippingMethod\Management\ShippingMethodManagement;
use WPDesk\FS\TableRate\ShippingMethodSingle;

/**
 * Duplicate Action.
 */
class DuplicateAction implements Hookable {
	const ACTION   = 'fs_duplicate_method';
	const OPTION   = 'fs_duplicate_method';
	const PARAM_ID = 'instance_id';

	/**
	 * @var ShippingMethodManagement
	 */
	private $shipping_method_management;

	/**
	 * @var DuplicatorChecker
	 */
	private $duplicator_checker;

	/**
	 * @param DuplicatorChecker        $duplicator_checker         .
	 * @param ShippingMethodManagement $shipping_method_management .
	 */
	public function __construct( DuplicatorChecker $duplicator_checker, ShippingMethodManagement $shipping_method_management ) {
		$this->duplicator_checker         = $duplicator_checker;
		$this->shipping_method_management = $shipping_method_management;
	}

	/**
	 * Init hooks (actions and filters).
	 *
	 * @return void
	 */
	public function hooks() {
		add_action( 'admin_post_' . self::ACTION, [ $this, 'action_duplicate' ] );
	}

	public function action_duplicate() {
		check_admin_referer( self::ACTION );

		$instance_id = (int) ( sanitize_text_field( wp_unslash( $_GET[ self::PARAM_ID ] ?? 0 ) ) );

		if ( ! $instance_id ) {
			wp_die( __( 'Shipping method duplication error. Please try again later.', 'flexible-shipping' ) ); // phpcs:ignore

			return;
		}

		$title = $this->shipping_method_management->get_shipping_method( $instance_id )->get_title();

		if ( ! $this->duplicator_checker->should_duplicate( $instance_id ) ) {
			wp_redirect( $this->get_redirect_url( 'error', $title ) );
			$this->end_request();

			return;
		}

		$zone            = $this->shipping_method_management->get_shipping_zone( $instance_id );
		$new_instance_id = $zone->add_shipping_method( ShippingMethodSingle::SHIPPING_METHOD_ID );

		$options = $this->get_instance_settings( $instance_id );

		if ( empty( $options['method_title'] ?? '' ) ) {
			$options['method_title'] = __( 'Flexible Shipping', 'flexible-shipping' );
		}

		$options['method_title'] .= ' ' . __( '(Copy)', 'flexible-shipping' );

		add_option( $this->get_option_settings_field( $new_instance_id ), $options );

		$this->shipping_method_management->set_shipping_method_status( $new_instance_id, false, $zone );

		$this->update_usage_functionality();

		wp_redirect( $this->get_redirect_url( 'success', $title ) );
		$this->end_request();
	}

	/**
	 * @codeCoverageIgnore
	 */
	protected function end_request() {
		die();
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return array
	 */
	private function get_instance_settings( int $instance_id ): array {
		return (array) get_option( $this->get_option_settings_field( $instance_id ), [] );
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return string
	 */
	private function get_option_settings_field( int $instance_id ): string {
		return sprintf( 'woocommerce_%s_%d_settings', ShippingMethodSingle::SHIPPING_METHOD_ID, $instance_id );
	}

	private function update_usage_functionality() {
		$current = (int) get_option( self::OPTION, 0 );

		update_option( self::OPTION, ++$current );
	}

	/**
	 * @param string $status       .
	 * @param string $method_title .
	 *
	 * @return string
	 */
	private function get_redirect_url( string $status, string $method_title ): string {
		return add_query_arg(
			[
				self::ACTION   => true,
				'status'       => $status,
				'method_title' => urlencode( $method_title ),
			],
			wp_get_referer()
		);
	}
}
DuplicateNotice.php                                                                                                                                                                                                                                            1432          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Duplicate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php
/**
 * Class DuplicateNotice
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Duplicate
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Duplicate;

use FSVendor\WPDesk\Notice\Notice;
use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Display admin notices.
 */
class DuplicateNotice implements Hookable {
	/**
	 * Hooks.
	 */
	public function hooks() {
		add_action( 'woocommerce_settings_shipping', [ $this, 'add_admin_notice' ] );
	}

	/**
	 * Add admin notices.
	 */
	public function add_admin_notice() {
		if ( ! isset( $_GET['status'], $_GET[ DuplicateAction::ACTION ], $_GET['method_title'] ) ) {
			return;
		}

		$status = in_array( $_GET['status'], [ 'success', 'error' ] ) ? $_GET['status'] : 'warning'; // phpcs:ignore
		$title  = sanitize_text_field( urldecode( wp_unslash( $_GET['method_title'] ) ) ); // phpcs:ignore

		if ( $status === 'success' ) {
			$message = __( '%1$s%2$s%3$s successfully duplicated.', 'flexible-shipping' ); // phpcs:ignore
		} else {
			$message = __( '%1$s%2$s%3$s shipping method duplication error. Please try again later.', 'flexible-shipping' ); // phpcs:ignore
		}

		$this->display_notice( sprintf( $message, '<strong>', $title, '</strong>' ), $status );
	}

	/**
	 * @param string $content .
	 * @param string $type    .
	 *
	 * @codeCoverageIgnore
	 */
	protected function display_notice( string $content, string $type ) {
		new Notice( $content, $type, true );
	}
}
DuplicateScript.php                                                                                                                                                                                                                                            1655          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Duplicate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php
/**
 * Class DuplicateScript
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Duplicate
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Duplicate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 * Duplicate Script.
 */
class DuplicateScript implements Hookable {

	/**
	 * @var string
	 */
	private $assets_url;

	/**
	 * @var string
	 */
	private $scripts_version;

	/**
	 * DuplicateScript constructor.
	 *
	 * @param string $assets_url      .
	 * @param string $scripts_version .
	 */
	public function __construct( string $assets_url, string $scripts_version ) {
		$this->assets_url      = $assets_url;
		$this->scripts_version = $scripts_version;
	}

	/**
	 * Init hooks (actions and filters).
	 *
	 * @return void
	 */
	public function hooks() {
		add_action( 'woocommerce_shipping_zone_after_methods_table', [ $this, 'add_duplicate_scripts' ] );
	}

	/**
	 * .
	 */
	public function add_duplicate_scripts() {
		$suffix = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ? '' : '.min';

		$handle = 'fs_duplicate_methods';

		wp_enqueue_script(
			$handle,
			trailingslashit( $this->assets_url ) . 'js/duplicate-methods' . $suffix . '.js',
			[ 'jquery', 'wc-shipping-zone-methods' ],
			$this->scripts_version
		);

		wp_localize_script(
			$handle,
			'fs_duplicate_methods',
			[
				'param_name'      => DuplicateAction::PARAM_ID,
				'shipping_method' => __( 'Flexible Shipping', 'flexible-shipping' ),
				'duplicate_label' => __( 'Duplicate', 'flexible-shipping' ),
				'duplicate_url'   => wp_nonce_url( add_query_arg( 'action', DuplicateAction::ACTION, admin_url( 'admin-post.php' ) ), DuplicateAction::ACTION ),
			]
		);
	}
}
DuplicateTracker.php                                                                                                                                                                                                                                           717           1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Duplicate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php
/**
 * Class DuplicateTracker
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Duplicate
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Duplicate;

use FSVendor\WPDesk\PluginBuilder\Plugin\Hookable;

/**
 *  Tracking of duplicate usages.
 */
class DuplicateTracker implements Hookable {
	const PRIORITY_AFTER_FS_TRACKER = 12;

	/**
	 * Hooks.
	 */
	public function hooks() {
		add_filter( 'wpdesk_tracker_data', [ $this, 'add_tracking_data' ], self::PRIORITY_AFTER_FS_TRACKER );
	}

	/**
	 * @param array $data .
	 *
	 * @return array
	 */
	public function add_tracking_data( $data ): array {
		$data['flexible_shipping']['duplicate'] = (int) get_option( DuplicateAction::OPTION, 0 );

		return $data;
	}
}
DuplicatorChecker.php                                                                                                                                                                                                                                          1133          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Duplicate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php
/**
 * Class DuplicatorChecker
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Duplicate
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Duplicate;

use WC_Shipping_Zone;
use WPDesk\FS\TableRate\ShippingMethod\Management\ShippingMethodManagement;
use WPDesk\FS\TableRate\ShippingMethodSingle;

/**
 * Checker duplicating.
 */
class DuplicatorChecker {

	/**
	 * @var ShippingMethodManagement
	 */
	private $shipping_method_management;

	/**
	 * @param ShippingMethodManagement $shipping_method_management
	 */
	public function __construct( ShippingMethodManagement $shipping_method_management ) {
		$this->shipping_method_management = $shipping_method_management;
	}

	/**
	 * @param int $instance_id
	 *
	 * @return bool
	 */
	public function should_duplicate( int $instance_id ): bool {
		if ( ! $instance_id ) {
			return false;
		}

		$shipping_method = $this->shipping_method_management->get_shipping_method( $instance_id );
		$zone            = $this->shipping_method_management->get_shipping_zone( $instance_id );

		return $shipping_method instanceof ShippingMethodSingle && $zone instanceof WC_Shipping_Zone;
	}
}
FreeShippingCalculator.php                                                                                                                                                                                                                                     2502          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/**
 * Class FreeShippingCalculator
 *
 * @package WPDesk\FS\TableRate\ShippingMethod
 */

namespace WPDesk\FS\TableRate\ShippingMethod;

use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettings;
use FSVendor\WPDesk\FS\TableRate\Settings\MethodSettingsFactory;
use WPDesk_Flexible_Shipping;

/**
 * Can calculate free shipping.
 */
class FreeShippingCalculator {

	/**
	 * @param MethodSettings $shipping_method .
	 * @param float          $cart_contents_cost .
	 *
	 * @return bool
	 */
	public function is_free_shipping( MethodSettings $shipping_method, $cart_contents_cost ) {
		/**
		 * Can provide free shipping callback.
		 * For internal use.
		 *
		 * @internal
		 */
		$free_shipping_calculation_callback = apply_filters(
			'flexible-shipping/shipping-method/free-shipping-callback',
			array( $this, 'is_free_shipping_callback' ),
			$shipping_method->get_raw_settings()
		);

		$is_free_shipping = $free_shipping_calculation_callback( $shipping_method->get_raw_settings(), $cart_contents_cost );

		$is_free_shipping = apply_filters_deprecated(
			'flexible_shipping_is_free_shipping',
			array( $is_free_shipping, $shipping_method->get_raw_settings(), $cart_contents_cost ),
			'4.0.0',
			'flexible-shipping/shipping-method/is-free-shipping'
		);

		/**
		 * Can modify free shipping.
		 *
		 * @param bool  $is_free_shipping Current is_free_shipping value based on method settings.
		 * @param array $shipping_method Flexible shipping method settings.
		 * @param float $cart_contents_cost Shipping contents cost.
		 *
		 * @return bool
		 */
		return apply_filters( 'flexible-shipping/shipping-method/is-free-shipping', $is_free_shipping, $shipping_method->get_raw_settings(), $cart_contents_cost );
	}

	/**
	 * Is free shipping?
	 *
	 * @param array $shipping_method_settings .
	 * @param float $cart_contents_cost .
	 *
	 * @return bool
	 */
	public function is_free_shipping_callback( $shipping_method_settings, $cart_contents_cost ) {
		$shipping_method  = MethodSettingsFactory::create_from_array( $shipping_method_settings );
		$is_free_shipping = false;
		$free_shipping    = $shipping_method->get_free_shipping();
		if ( isset( $free_shipping ) && '' !== $free_shipping ) {
			$free_shipping = (float) trim( $free_shipping );
			if ( is_numeric( $free_shipping ) ) {
				if ( (float) apply_filters( 'flexible_shipping_value_in_currency', $free_shipping ) <= (float) $cart_contents_cost ) {
					$is_free_shipping = true;
				}
			}
		}

		return $is_free_shipping;
	}

}
ShippingMethodManagement.php                                                                                                                                                                                                                                   2840          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod/Management                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
/**
 * Class ShippingMethodManagement
 *
 * @package WPDesk\FS\TableRate\ShippingMethod\Management
 */

namespace WPDesk\FS\TableRate\ShippingMethod\Management;

use WC_Shipping_Zone;
use WC_Shipping_Zones;
use wpdb;
use WPDesk\FS\TableRate\ShippingMethodSingle;

/**
 * @codeCoverageIgnore
 */
class ShippingMethodManagement {

	/**
	 * @var wpdb
	 */
	private $wpdb;

	/**
	 * @param wpdb $wpdb
	 */
	public function __construct( wpdb $wpdb ) {
		$this->wpdb = $wpdb;
	}

	/**
	 * @param int              $instance_id .
	 * @param bool             $status      .
	 * @param WC_Shipping_Zone $zone        .
	 */
	public function set_shipping_method_status( int $instance_id, bool $status, WC_Shipping_Zone $zone ) {
		$status = $status ? 1 : 0;

		if ( $this->update_shipping_method_field( $instance_id, 'is_enabled', $status ) ) {
			$shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );

			do_action( 'woocommerce_shipping_zone_method_status_toggled', $shipping_method->instance_id, $shipping_method->id, $zone->get_id(), $status );
		}
	}

	/**
	 * @param int $zone_id                    .
	 * @param int $method_order               .
	 * @param int $number_of_shipping_methods .
	 */
	public function update_shipping_methods_order( int $zone_id, int $method_order, int $number_of_shipping_methods ) {
		$this->wpdb->query( $this->wpdb->prepare( sprintf( 'UPDATE `%s` SET `method_order` = `method_order`+%%d WHERE `zone_id` = %%d AND `method_order` > %%d', $this->get_table() ), $number_of_shipping_methods, $zone_id, $method_order ) ); // phpcs:ignore
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return int
	 */
	public function get_shipping_method_order( int $instance_id ): int {
		return (int) $this->wpdb->get_var( $this->wpdb->prepare( sprintf( 'SELECT `method_order` FROM `%s` WHERE `instance_id` = %%d ORDER BY `method_order` ASC', $this->get_table() ), $instance_id ) ); // phpcs:ignore
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return bool|ShippingMethodSingle
	 */
	public function get_shipping_method( int $instance_id ) {
		return WC_Shipping_Zones::get_shipping_method( $instance_id );
	}

	/**
	 * @param int $instance_id .
	 *
	 * @return bool|WC_Shipping_Zone
	 */
	public function get_shipping_zone( int $instance_id ) {
		return WC_Shipping_Zones::get_zone_by( 'instance_id', $instance_id );
	}

	/**
	 * @param int    $instance_id .
	 * @param string $key         .
	 * @param string $value       .
	 *
	 * @return bool|int
	 */
	public function update_shipping_method_field( int $instance_id, string $key, string $value ) {
		return $this->wpdb->update( $this->get_table(), [ $key => $value ], [ 'instance_id' => $instance_id ] );
	}

	/**
	 * @return string
	 */
	private function get_table(): string {
		return $this->wpdb->prefix . 'woocommerce_shipping_zone_methods';
	}
}
MethodDescription.php                                                                                                                                                                                                                                          2291          1711369794  plugins/flexible-shipping/src/WPDesk/FS/TableRate/ShippingMethod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         